{% extends 'base.html' %}

{% block title %}{{ client.name }} | Kundebillede | Jarvis 1.0{% endblock %}

{% block content %}

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Include Leaflet for polygon-based geographic visualization -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Turf.js for polygon merging -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<!-- USP Variable System Styling -->
<style>
/* USP Variable Styling - matches Campaign Builder */
.usp-variable {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-variable:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-variable.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-variable-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 50px;
    max-width: 150px;
}
.usp-text-static {
    color: #374151;
}

/* Full-text USP variable (for USPs without variables) */
.usp-full-text {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-full-text:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-full-text.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-full-text-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 100px;
}

/* Custom USP click-to-edit */
.custom-usp-display-text {
    cursor: pointer;
}
.custom-usp-display-text:hover {
    color: #9333ea;
}

/* INLINE USP variables - looks normal by default, editable on dblclick */
.inline-usp-variable {
    background: transparent;
    padding: 0;
    border: none;
    border-radius: 0;
    cursor: text;
    display: inline;
}
.inline-usp-variable:hover {
    background: transparent;
    border: none;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: #a855f7;
}
.inline-usp-variable.editing {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    border: 2px solid #a855f7;
    display: inline-block;
}

/* USP Item - Normal state (simple, like custom USPs) */
.usp-display-item .usp-category-label {
    display: none;
}

/* USP Item Edit Mode */
.usp-display-item.usp-edit-mode {
    border-color: #a855f7 !important;
    background-color: #faf5ff !important;
    box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
}
.usp-display-item.usp-edit-mode .usp-category-label {
    display: block;
}
.usp-delete-btn {
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s;
}
.usp-display-item.usp-edit-mode .usp-delete-btn {
    opacity: 1;
    transform: scale(1);
}

/* Custom USP Item Edit Mode (same styling as predefined USPs) */
.custom-usp-item.custom-usp-edit-mode {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}
.custom-usp-item .custom-usp-delete-btn {
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s;
}
.custom-usp-item.custom-usp-edit-mode .custom-usp-delete-btn {
    opacity: 1;
    transform: scale(1);
}

/* Wizard Card Styling - matches Campaign Builder exactly */
.wizard-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #f3f4f6;
    transition: all 0.3s ease;
}

.selection-card {
    transition: all 0.2s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.selection-card:hover {
    border-color: #c084fc;
    box-shadow: 0 4px 20px rgba(192, 132, 252, 0.2);
    transform: translateY(-2px);
}

.selection-card.selected {
    border-color: #a855f7;
    background: linear-gradient(to bottom right, #faf5ff, #fdf4ff);
}
</style>

{% csrf_token %}
<div class="max-w-[2000px] mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Back Link -->
    <a href="{% url 'client_list' %}" class="inline-flex items-center text-gray-600 hover:text-gray-900 mb-6 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Tilbage til kundeliste
    </a>

    <!-- Header Section -->
    <div class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl p-8 mb-8">
        <div class="flex items-start justify-between flex-wrap gap-4">
            <div class="flex items-center space-x-6">
                <!-- Client Icon -->
                <div class="w-20 h-20 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl flex items-center justify-center shadow-xl">
                    <span class="text-4xl text-white">{{ client.name|slice:":1"|upper }}</span>
                </div>

                <!-- Client Info -->
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ client.name }}</h1>
                    {% if client.website_url %}
                    <a href="{% if 'http' in client.website_url %}{{ client.website_url }}{% else %}https://{{ client.website_url }}{% endif %}" target="_blank" class="text-blue-600 hover:text-blue-800 text-lg flex items-center space-x-2">
                        <span>{{ client.website_url }}</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    {% endif %}

                    <div class="flex flex-wrap items-center gap-3 mt-3">
                        {% if client.industry %}
                        <span class="px-3 py-1 bg-purple-200 text-purple-800 text-sm font-medium rounded-full">
                            {{ client.industry.name }}
                        </span>
                        {% endif %}
                        <span class="text-gray-500 text-sm">
                            Oprettet {{ client.created_at|date:"d. F Y" }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center space-x-3">
                <a href="/campaign-builder/?client={{ client.id }}" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                    <span>+</span>
                    <span>Ny Kampagne</span>
                </a>
                <button onclick="editClient()" class="px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 flex items-center space-x-2 border border-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span>Rediger</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-8">
        <div class="flex flex-wrap border-b border-gray-200">
            <button onclick="showSection('overview')" class="section-tab active px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="overview">
                Overblik
            </button>
            <button onclick="showSection('campaigns')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="campaigns">
                Kampagner
            </button>
            <button onclick="showSection('company')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="company">
                üè¢ Virksomhed
            </button>
            <button onclick="showSection('texts')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="texts">
                üìù Tekster
            </button>
            <button onclick="showSection('industries')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="industries">
                Brancher & Services
            </button>
            <button onclick="showSection('geo')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="geo">
                Geo-Kampagne
            </button>
            <button onclick="showSection('pages')" class="section-tab px-6 py-4 text-sm font-medium text-gray-600 hover:text-purple-600 border-b-2 border-transparent hover:border-purple-600 transition-all" data-section="pages">
                üìÑ Sider
            </button>
        </div>

        <!-- Section Content -->
        <div class="p-6">

            <!-- OVERVIEW SECTION -->
            <div id="section-overview" class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Quick Info -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </span>
                            Hurtig Info
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Branche</span>
                                <span class="font-medium text-gray-900">{{ client.industry.name|default:"Ikke angivet" }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Kampagner</span>
                                <span class="font-medium text-gray-900">{{ campaigns|length }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Sidst opdateret</span>
                                <span class="font-medium text-gray-900">{{ client.updated_at|date:"d. M Y" }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Campaigns -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </span>
                            Seneste Kampagner
                        </h3>
                        {% if campaigns %}
                        <div class="space-y-2">
                            {% for campaign in campaigns|slice:":3" %}
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                                <span class="font-medium text-gray-900">{{ campaign.name }}</span>
                                <span class="text-sm text-gray-500">{{ campaign.created_at|date:"d. M" }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-400 italic">Ingen kampagner endnu</p>
                        {% endif %}
                    </div>

                    <!-- Data Status -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </span>
                            Data Status
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Website crawlet</span>
                                {% if client.scraped_data %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Ja</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full">Nej</span>
                                {% endif %}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Services detekteret</span>
                                {% if client.detected_services %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">{{ client.detected_services|length }}</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full">Nej</span>
                                {% endif %}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">USP'er fundet</span>
                                {% if detected_usps or predefined_usps %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Ja</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full">Nej</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CAMPAIGNS SECTION -->
            <div id="section-campaigns" class="section-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Alle Kampagner</h3>
                    <a href="/campaign-builder/?client={{ client.id }}" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <span>+</span>
                        <span>Ny Kampagne</span>
                    </a>
                </div>

                {% if campaigns %}
                <div class="space-y-4">
                    {% for campaign in campaigns %}
                    <div class="bg-gray-50 rounded-xl p-6 hover:bg-gray-100 transition-colors">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-1">{{ campaign.name }}</h4>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">{{ campaign.campaign_type }}</span>
                                    <span class="text-sm text-gray-500">{{ campaign.created_at|date:"d. F Y" }}</span>
                                </div>
                            </div>
                            <a href="/campaigns/{{ campaign.id }}/" class="text-purple-600 hover:text-purple-800 font-medium">
                                Se detaljer
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 bg-gray-50 rounded-xl">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Ingen kampagner endnu</h4>
                    <p class="text-gray-500 mb-4">Opret din f&oslash;rste kampagne for denne kunde</p>
                    <a href="/campaign-builder/?client={{ client.id }}" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        + Opret Kampagne
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- VIRKSOMHED SECTION -->
            <div id="section-company" class="section-content hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">üè¢ Virksomhed</h3>

                <div class="space-y-6">
                    <!-- Company Description (consolidated - shows AI-generated or manual description) -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 text-sm">1</span>
                            Virksomhedsbeskrivelse
                        </h4>

                        <!-- View mode -->
                        <div id="description-view-mode">
                            {% if company_info.core_competencies %}
                            <div class="bg-white rounded-lg p-4 border border-gray-200 cursor-pointer hover:border-purple-300 hover:bg-purple-50 transition-colors" ondblclick="toggleDescriptionEdit()" title="Dobbeltklik for at redigere">
                                <p id="description-display" class="text-gray-700 leading-relaxed whitespace-pre-line">{{ company_info.core_competencies }}</p>
                            </div>
                            <button onclick="copyText('{{ company_info.core_competencies|escapejs }}')" class="mt-3 text-sm text-purple-600 hover:text-purple-800 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Kopier
                            </button>
                            {% elif client.description %}
                            <div class="bg-white rounded-lg p-4 border border-gray-200 cursor-pointer hover:border-purple-300 hover:bg-purple-50 transition-colors" ondblclick="toggleDescriptionEdit()" title="Dobbeltklik for at redigere">
                                <p id="description-display" class="text-gray-700 leading-relaxed whitespace-pre-line">{{ client.description }}</p>
                            </div>
                            <button onclick="copyText('{{ client.description|escapejs }}')" class="mt-3 text-sm text-purple-600 hover:text-purple-800 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Kopier
                            </button>
                            {% else %}
                            <div class="bg-white rounded-lg p-4 border border-gray-200 border-dashed cursor-pointer hover:border-purple-300 hover:bg-purple-50 transition-colors" ondblclick="toggleDescriptionEdit()" title="Dobbeltklik for at tilf√∏je beskrivelse">
                                <p id="description-display" class="text-gray-400 italic">Dobbeltklik for at tilf√∏je beskrivelse</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Edit mode -->
                        <div id="description-edit-mode" class="hidden">
                            <textarea id="description-textarea" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none overflow-hidden" style="min-height: 100px;" placeholder="Skriv virksomhedsbeskrivelse..." oninput="autoResizeTextarea(this)">{{ company_info.core_competencies|default:client.description|default:"" }}</textarea>
                            <div class="flex justify-end gap-2 mt-3">
                                <button onclick="cancelDescriptionEdit()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Annuller</button>
                                <button onclick="saveDescription()" class="px-4 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700">Gem</button>
                            </div>
                        </div>
                    </div>

                    <!-- USP'er (moved from separate tab) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <!-- Valgte USP'er -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                </span>
                                Valgte USP'er
                                <span id="predefined-usps-count" class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">{{ predefined_usps|length }}</span>
                            </h4>
                            <div id="predefined-usps-view">
                                {% if predefined_usps %}
                                <ul id="predefined-usps-list" class="space-y-3">
                                    {% for usp in predefined_usps %}
                                    <li class="bg-white rounded-lg p-3 border border-gray-200 text-gray-700 hover:border-purple-300 hover:bg-purple-50 transition-colors usp-display-item"
                                        data-usp-id="{{ usp.id }}"
                                        data-original-text="{{ usp.original_text }}"
                                        data-has-variables="{{ usp.has_variables|yesno:'true,false' }}"
                                        data-category="{{ usp.main_category|default:'' }}">
                                        <span class="usp-display-text">{{ usp.text }}</span>
                                        {% if usp.main_category %}
                                        <span class="usp-category-label text-xs text-gray-500 mt-1 block">{{ usp.main_category }}</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <div id="predefined-usps-empty" class="bg-white rounded-lg p-4 border border-gray-200 border-dashed hover:border-purple-300 hover:bg-purple-50 transition-colors cursor-pointer" onclick="openUspModal()">
                                    <p class="text-gray-400 italic">Klik for at v√¶lge USP'er</p>
                                </div>
                                {% endif %}
                            </div>
                            <!-- Bulk Update Button -->
                            <button type="button" onclick="openUspModal()" class="mt-4 w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Bulk opdater USP'er
                            </button>
                        </div>

                        <!-- Brugerdefinerede USP'er -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </span>
                                Brugerdefinerede USP'er
                                <span id="custom-usps-count" class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">{{ custom_usps|length }}</span>
                            </h4>

                            <div id="custom-usps-list" class="space-y-2">
                                {% for usp in custom_usps %}
                                <div class="bg-white rounded-lg p-3 border border-gray-200 text-gray-700 hover:border-blue-300 hover:bg-blue-50 transition-colors custom-usp-item"
                                     data-usp-index="{{ forloop.counter0 }}"
                                     data-usp-text="{{ usp }}">
                                    <span class="custom-usp-text">{{ usp }}</span>
                                </div>
                                {% empty %}
                                <div id="custom-usps-empty" class="bg-white rounded-lg p-4 border border-gray-200 border-dashed text-center">
                                    <p class="text-gray-400 italic">Ingen brugerdefinerede USP'er</p>
                                </div>
                                {% endfor %}
                            </div>
                            <!-- Add new USP button -->
                            <button onclick="addNewCustomUsp()" class="mt-3 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 flex items-center justify-center gap-2 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Tilf√∏j USP
                            </button>
                        </div>
                    </div>

                    <!-- Geografisk D√¶kning (collapsible) -->
                    {% if selected_cities %}
                    <div id="geo-coverage-section" class="mt-6">
                        <div class="flex items-center gap-2">
                            <button type="button" id="toggle-geo-coverage" class="flex-1 flex items-center justify-between px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors" onclick="toggleGeoCoverage()">
                                <span class="flex items-center text-sm font-medium text-gray-700">
                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Geografisk D√¶kning
                                    <span class="ml-2 text-xs text-gray-500">{{ selected_cities|length }} byer</span>
                                </span>
                                <svg id="geo-coverage-toggle-icon" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <button type="button" onclick="openGeoModal()" class="px-3 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all duration-200" title="Rediger geografisk d√¶kning">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="geo-coverage-content" class="mt-2 hidden">
                            <div class="bg-white rounded-lg p-4 border border-gray-200">
                                <!-- Legend -->
                                <div class="flex flex-wrap items-center gap-4 mb-3 text-xs text-gray-500 border-b border-gray-100 pb-2">
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                        Har byside
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-gray-300"></span>
                                        Ingen byside
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                        I sitemap, ikke i d√¶kning
                                    </span>
                                    <!-- Filter toggle -->
                                    <div class="inline-flex items-center gap-2 ml-auto">
                                        <span class="text-xs text-gray-500">Sekund√¶re byer</span>
                                        <label for="show-secondary-cities" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                                            <input type="checkbox" id="show-secondary-cities" style="opacity: 0; width: 0; height: 0;" onchange="filterSecondaryCities()">
                                            <span id="toggle-track" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 24px; transition: background-color 0.2s;"></span>
                                            <span id="toggle-knob" style="position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s;"></span>
                                        </label>
                                        <span id="secondary-city-count" class="text-xs text-gray-400 tabular-nums"></span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-sm text-gray-600">
                                    {% for city in selected_cities %}
                                    <span class="flex items-center gap-1 city-coverage-item" data-city="{{ city }}" data-is-primary="{% if city in primary_cities %}true{% else %}false{% endif %}">
                                        <span class="byside-indicator w-2 h-2 rounded-full bg-gray-300 flex-shrink-0"></span>
                                        <span class="city-name">{{ city }}</span>
                                        <span class="byside-count text-xs text-green-600 font-medium hidden"></span>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Suggested cities from sitemap (not in geo coverage) -->
                            <div id="suggested-cities-container" class="mt-3 hidden">
                                <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                    <div class="flex items-center gap-2 mb-3 text-sm font-medium text-yellow-800">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <span>Byer i sitemap - ikke i geografisk d√¶kning</span>
                                        <span id="suggested-cities-count" class="ml-auto px-2 py-0.5 bg-yellow-200 text-yellow-800 rounded-full text-xs font-bold">0</span>
                                    </div>
                                    <p class="text-xs text-yellow-700 mb-3">Disse byer har bysider p√• websitet, men er ikke valgt i geografisk d√¶kning. Overvej at tilf√∏je dem.</p>
                                    <div id="suggested-cities-list" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Company Profile JSON (collapsible) - moved under USPs -->
                    {% if company_info.profile %}
                    <div id="client-profile-json-section" class="mt-6">
                        <button type="button" id="toggle-client-profile-json" class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors" onclick="toggleClientProfileJson()">
                            <span class="flex items-center text-sm font-medium text-gray-700">
                                <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                Virksomhedsprofil (JSON)
                                <span class="ml-2 text-xs text-gray-500">til brug i andre AI-prompts</span>
                            </span>
                            <svg id="client-profile-toggle-icon" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="client-profile-json-content" class="mt-2 hidden">
                            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                                <pre id="client-profile-json-display" class="text-sm text-green-400 font-mono whitespace-pre-wrap">{{ company_info.profile_json|safe }}</pre>
                            </div>
                            <div class="flex justify-end mt-2">
                                <button type="button" onclick="copyClientProfileJson()" class="text-xs text-gray-500 hover:text-blue-600 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Kopi√©r JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>

            <!-- TEXTS SECTION - All crawled and generated texts -->
            <div id="section-texts" class="section-content hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">üìù Alle Tekster</h3>
                <p class="text-gray-600 mb-6">Oversigt over alle crawlede og genererede tekster for denne kunde.</p>

                <div class="space-y-6">
                    <!-- Crawled Pages from Campaign Builder -->
                    {% if scraped_pages %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #3B82F620, #3B82F610); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-2xl shadow-lg">
                                        üåê
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">Crawlede Sider</h4>
                                        <p class="text-gray-600">{{ scraped_pages|length }} sider fundet</p>
                                    </div>
                                </div>
                                <span class="px-4 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-full">{{ scraped_pages|length }} sider</span>
                            </div>
                        </div>

                        <!-- Two-column layout like SEO step -->
                        <div class="flex gap-6">
                            <!-- Left sidebar - Page navigation -->
                            <div class="w-[280px] flex-shrink-0">
                                <div class="sticky top-4">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-3">üìÑ Undersider</h3>

                                    <!-- Filter buttons -->
                                    <div class="flex gap-2 mb-4">
                                        <button type="button" onclick="filterCrawledPages('all')" id="filter-all" class="crawled-filter-btn flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all bg-blue-500 text-white">
                                            Alle <span class="ml-1 opacity-75">({{ scraped_pages|length }})</span>
                                        </button>
                                        <button type="button" onclick="filterCrawledPages('marked')" id="filter-marked" class="crawled-filter-btn flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all bg-gray-100 text-gray-600 hover:bg-gray-200">
                                            Mine <span id="marked-count" class="ml-1 opacity-75">(0)</span>
                                        </button>
                                    </div>

                                    <div id="crawled-pages-nav" class="space-y-2 max-h-[550px] overflow-y-auto">
                                        {% for path, page in scraped_pages.items %}
                                        <div class="crawled-page-nav-item selection-card cursor-pointer p-4 rounded-xl border-2 transition-all duration-200 relative {% if forloop.first %}border-blue-500 bg-blue-50{% else %}border-gray-200 hover:border-blue-300 hover:bg-gray-50{% endif %}" data-page-path="{{ path }}" data-marked="false">
                                            <!-- Mark as mine button (star) -->
                                            <button type="button" onclick="event.stopPropagation(); togglePageMarked('{{ path|escapejs }}')" class="mark-page-btn absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center text-sm transition-all hover:scale-110" title="Marker som min side">
                                                <span class="mark-icon text-gray-300 hover:text-yellow-400">‚òÜ</span>
                                            </button>
                                            <div class="pr-8" onclick="showCrawledPage('{{ path|escapejs }}')">
                                                <div class="font-medium text-gray-900 truncate">
                                                    {% if page.meta_title %}{{ page.meta_title|truncatechars:30 }}{% else %}{{ path }}{% endif %}
                                                </div>
                                                <div class="text-xs text-gray-400 truncate" title="{{ path }}">{{ path }}</div>
                                                {% if page.page_type %}
                                                <div class="text-xs text-gray-500 truncate mt-0.5">
                                                    <span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">{{ page.page_type }}</span>
                                                </div>
                                                {% endif %}
                                                {% if page.sections %}
                                                <div class="text-xs text-gray-500 truncate mt-0.5">
                                                    {{ page.sections|length }} sektioner
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Right content - Active page preview -->
                            <div class="flex-1 min-w-0">
                                <div id="crawled-page-content">
                                    {% for path, page in scraped_pages.items %}
                                    <div class="crawled-page-preview {% if not forloop.first %}hidden{% endif %}" data-page-path="{{ path }}">
                                        <!-- Page Header Preview -->
                                        <div class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-lg bg-blue-500">
                                                        üìÑ
                                                    </div>
                                                    <div>
                                                        <h3 class="text-xl font-bold text-gray-900">{% if page.meta_title %}{{ page.meta_title|truncatechars:50 }}{% else %}{{ path }}{% endif %}</h3>
                                                        <p class="text-sm text-gray-500">{{ path }}</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    {% if page.url %}
                                                    <a href="{{ page.url }}" target="_blank" class="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg text-sm font-medium hover:shadow-lg transition-all flex items-center space-x-1">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                        </svg>
                                                        <span>√Öbn side</span>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Google Preview -->
                                            <div class="bg-white rounded-lg p-4 border border-gray-100">
                                                <div class="text-sm text-gray-500 mb-1">Google Preview</div>
                                                <div class="text-blue-600 text-lg font-medium hover:underline cursor-pointer">
                                                    {{ page.meta_title|default:path }}
                                                </div>
                                                <div class="text-green-700 text-sm">{{ client.website|default:"example.com" }}{{ path }}</div>
                                                {% if page.meta_description %}
                                                <div class="text-gray-600 text-sm mt-1 line-clamp-2">
                                                    {{ page.meta_description }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Large Text Preview -->
                                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                                            <div class="relative">
                                                <div class="flex items-center justify-between mb-3">
                                                    <span class="text-sm font-medium text-gray-500">Samlet tekstindhold{% if page.sections %} ({{ page.sections|length }} sektioner){% endif %}</span>
                                                    <button type="button" onclick="copyCrawledPageText('{{ path|escapejs }}')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm transition-all flex items-center space-x-1">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                                                        </svg>
                                                        <span>Kopier tekst</span>
                                                    </button>
                                                </div>
                                                <div id="crawled-content-{{ forloop.counter }}" class="w-full p-6 bg-gray-50 border border-gray-200 rounded-xl text-sm max-h-[800px] overflow-y-auto" style="line-height: 1.6;">
                                                    {% if page.meta_title %}
                                                    <div class="mb-4">
                                                        <span class="text-xs text-gray-400 uppercase">Meta titel</span>
                                                        <h1 class="text-xl font-bold text-gray-900">{{ page.meta_title }}</h1>
                                                    </div>
                                                    {% endif %}
                                                    {% if page.meta_description %}
                                                    <div class="mb-6">
                                                        <span class="text-xs text-gray-400 uppercase">Meta beskrivelse</span>
                                                        <p class="text-gray-700">{{ page.meta_description }}</p>
                                                    </div>
                                                    <hr class="border-gray-200 my-6">
                                                    {% endif %}
                                                    {% if page.sections %}
                                                        {% for section in page.sections %}
                                                        {% if section.heading %}
                                                        <h3 class="text-base font-semibold text-gray-800 mt-4 mb-1">{{ section.heading }}</h3>
                                                        {% endif %}
                                                        {% if section.content %}
                                                        <p class="text-gray-600 mb-3">{{ section.content }}</p>
                                                        {% endif %}
                                                        {% endfor %}
                                                    {% elif page.content %}
                                                    <p class="text-gray-600">{{ page.content }}</p>
                                                    {% else %}
                                                    <p class="text-gray-400 italic">Ingen indhold tilg√¶ngeligt</p>
                                                    {% endif %}
                                                </div>
                                                <!-- Hidden textarea for copying -->
                                                <textarea id="crawled-text-{{ forloop.counter }}" class="hidden">{{ page.meta_title|default:"" }}
{{ page.meta_description|default:"" }}

{% for section in page.sections %}{% if section.heading %}{{ section.heading }}
{% endif %}{% if section.content %}{{ section.content }}
{% endif %}
{% endfor %}{% if page.content %}{{ page.content }}{% endif %}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Extracted Reviews -->
                    {% if extracted_reviews %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #F59E0B20, #F59E0B10); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-2xl shadow-lg">
                                        ‚≠ê
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">Crawlede Anmeldelser</h4>
                                        <p class="text-gray-600">{{ extracted_reviews|length }} anmeldelser fundet</p>
                                    </div>
                                </div>
                                <span class="px-4 py-2 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-full">{{ extracted_reviews|length }} anmeldelser</span>
                            </div>
                        </div>

                        <!-- Reviews list -->
                        <div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% for review in extracted_reviews %}
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-yellow-300 hover:shadow-md transition-all duration-200">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                                <span class="text-yellow-600 text-lg">üë§</span>
                                            </div>
                                            <div>
                                                {% if review.author %}
                                                <span class="font-semibold text-gray-900">{{ review.author }}</span>
                                                {% else %}
                                                <span class="font-semibold text-gray-500">Anonym</span>
                                                {% endif %}
                                                {% if review.rating %}
                                                <div class="text-yellow-500 text-sm">{% for i in "12345" %}{% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if review.source %}
                                        <span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">{{ review.source }}</span>
                                        {% endif %}
                                    </div>
                                    {% if review.text %}
                                    <p class="text-sm text-gray-600 leading-relaxed">{{ review.text }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Crawled Meta Data from Client Model -->
                    {% if client.scraped_data %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #6366F120, #6366F110); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-2xl shadow-lg">
                                        üåê
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">Website Meta Data</h4>
                                        {% if client.scraped_at %}
                                        <p class="text-gray-600">Crawlet {{ client.scraped_at|date:"d. M Y H:i" }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            {% if client.scraped_data.meta_title %}
                            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Meta Title</span>
                                    <button onclick="copyText('{{ client.scraped_data.meta_title|escapejs }}')" class="px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors">Kopier</button>
                                </div>
                                <p class="text-gray-800 font-medium">{{ client.scraped_data.meta_title }}</p>
                            </div>
                            {% endif %}

                            {% if client.scraped_data.meta_description %}
                            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Meta Description</span>
                                    <button onclick="copyText('{{ client.scraped_data.meta_description|escapejs }}')" class="px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors">Kopier</button>
                                </div>
                                <p class="text-gray-600">{{ client.scraped_data.meta_description }}</p>
                            </div>
                            {% endif %}

                            {% if client.scraped_data.h1_tags %}
                            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">H1 Tags</span>
                                    <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">{{ client.scraped_data.h1_tags|length }}</span>
                                </div>
                                <div class="space-y-2">
                                    {% for h1 in client.scraped_data.h1_tags %}
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-100 hover:border-gray-200 transition-colors">
                                        <span class="text-gray-800 font-medium">{{ h1 }}</span>
                                        <button onclick="copyText('{{ h1|escapejs }}')" class="px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors">Kopier</button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- AI Generated Headlines -->
                    {% if campaign_config.generated_headlines %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #A855F720, #A855F710); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-2xl shadow-lg">
                                        ‚ú®
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">AI-Genererede Headlines</h4>
                                        <p class="text-gray-600">{{ campaign_config.generated_headlines|length }} headlines genereret</p>
                                    </div>
                                </div>
                                <span class="px-4 py-2 bg-purple-100 text-purple-700 text-sm font-medium rounded-full">{{ campaign_config.generated_headlines|length }}</span>
                            </div>
                        </div>

                        <div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {% for headline in campaign_config.generated_headlines %}
                                <div class="flex items-center justify-between bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-purple-300 hover:shadow-md transition-all duration-200">
                                    <span class="text-gray-800 font-medium">{{ headline }}</span>
                                    <button onclick="copyText('{{ headline|escapejs }}')" class="px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors ml-2">Kopier</button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- AI Generated Descriptions -->
                    {% if campaign_config.generated_descriptions %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #10B98120, #10B98110); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-2xl shadow-lg">
                                        üìÑ
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">AI-Genererede Beskrivelser</h4>
                                        <p class="text-gray-600">{{ campaign_config.generated_descriptions|length }} beskrivelser genereret</p>
                                    </div>
                                </div>
                                <span class="px-4 py-2 bg-green-100 text-green-700 text-sm font-medium rounded-full">{{ campaign_config.generated_descriptions|length }}</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            {% for desc in campaign_config.generated_descriptions %}
                            <div class="flex items-start justify-between bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-green-300 hover:shadow-md transition-all duration-200">
                                <span class="text-gray-800">{{ desc }}</span>
                                <button onclick="copyText('{{ desc|escapejs }}')" class="px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors ml-3 whitespace-nowrap">Kopier</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Campaign Texts from Ad Groups -->
                    {% if campaigns %}
                    <div class="wizard-card p-8 mb-8">
                        <!-- Header with gradient -->
                        <div class="mb-6" style="background: linear-gradient(135deg, #F9731620, #F9731610); margin: -2rem -2rem 1.5rem -2rem; padding: 1.5rem 2rem; border-radius: 16px 16px 0 0;">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-2xl shadow-lg">
                                        üìä
                                    </div>
                                    <div>
                                        <h4 class="text-2xl font-bold text-gray-900">Kampagne Tekster</h4>
                                        <p class="text-gray-600">{{ campaigns|length }} kampagner</p>
                                    </div>
                                </div>
                                <span class="px-4 py-2 bg-orange-100 text-orange-700 text-sm font-medium rounded-full">{{ campaigns|length }} kampagner</span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            {% for campaign in campaigns %}
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200 hover:border-orange-300 hover:shadow-md transition-all duration-200">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                                        <span class="text-orange-600 text-lg">üìÅ</span>
                                    </div>
                                    <h5 class="font-semibold text-gray-900 text-lg">{{ campaign.name }}</h5>
                                </div>

                                <div class="space-y-4">
                                    {% for ad_group in campaign.ad_groups.all %}
                                    <div class="bg-white rounded-lg p-4 border border-gray-100">
                                        <h6 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                            <span class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center mr-2 text-xs">üìÇ</span>
                                            {{ ad_group.name }}
                                        </h6>
                                        {% for ad in ad_group.ads.all %}
                                        <div class="ml-8 text-sm space-y-1 bg-gray-50 rounded-lg p-3 mb-2">
                                            {% if ad.headline_1 %}<div class="flex"><span class="text-gray-400 w-8 flex-shrink-0">H1:</span><span class="text-gray-800">{{ ad.headline_1 }}</span></div>{% endif %}
                                            {% if ad.headline_2 %}<div class="flex"><span class="text-gray-400 w-8 flex-shrink-0">H2:</span><span class="text-gray-800">{{ ad.headline_2 }}</span></div>{% endif %}
                                            {% if ad.headline_3 %}<div class="flex"><span class="text-gray-400 w-8 flex-shrink-0">H3:</span><span class="text-gray-800">{{ ad.headline_3 }}</span></div>{% endif %}
                                            {% if ad.description_1 %}<div class="flex mt-2"><span class="text-gray-400 w-8 flex-shrink-0">D1:</span><span class="text-gray-600">{{ ad.description_1 }}</span></div>{% endif %}
                                            {% if ad.description_2 %}<div class="flex"><span class="text-gray-400 w-8 flex-shrink-0">D2:</span><span class="text-gray-600">{{ ad.description_2 }}</span></div>{% endif %}
                                        </div>
                                        {% empty %}
                                        <p class="ml-8 text-sm text-gray-400 italic">Ingen annoncer</p>
                                        {% endfor %}
                                    </div>
                                    {% empty %}
                                    <p class="text-sm text-gray-400 italic">Ingen annoncegrupper</p>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Empty State -->
                    {% if not scraped_pages and not extracted_reviews and not client.scraped_data and not campaign_config.generated_headlines and not campaign_config.generated_descriptions and not campaigns %}
                    <div class="wizard-card p-8 mb-8">
                        <div class="text-center py-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                <span class="text-4xl">üìù</span>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-3">Ingen tekster endnu</h4>
                            <p class="text-gray-500 max-w-md mx-auto">Brug Campaign Builder til at crawle website og generere tekster til denne kunde.</p>
                            <a href="{% url 'campaign_builder_wizard' %}?client={{ client.id }}" class="inline-flex items-center px-6 py-3 mt-6 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-medium rounded-xl hover:shadow-lg transition-all duration-200">
                                <span class="mr-2">üöÄ</span>
                                Start Campaign Builder
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- INDUSTRIES SECTION -->
            <div id="section-industries" class="section-content hidden">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">Brancher & Services</h3>

                {% if industries_with_services %}
                <div class="space-y-6">
                    {% for item in industries_with_services %}
                    <div class="bg-gray-50 rounded-xl overflow-hidden">
                        <div class="p-4 bg-gradient-to-r from-purple-100 to-blue-100 border-b border-gray-200">
                            <h4 class="text-lg font-semibold text-gray-900 flex items-center">
                                <span class="w-10 h-10 bg-white rounded-lg flex items-center justify-center mr-3 shadow-sm text-xl">
                                    {{ item.industry.icon|default:"" }}
                                </span>
                                {{ item.industry.name }}
                                <span class="ml-2 px-2 py-0.5 bg-white text-purple-700 text-xs rounded-full">{{ item.services|length }} services</span>
                            </h4>
                        </div>
                        <div class="p-4">
                            {% if item.services %}
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {% for service in item.services %}
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="font-medium text-gray-900">{{ service.name }}</div>
                                    {% if service.description %}
                                    <div class="text-sm text-gray-500 mt-1">{{ service.description|truncatewords:10 }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-gray-400 italic">Ingen services valgt for denne branche</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 bg-gray-50 rounded-xl">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Ingen brancher valgt</h4>
                    <p class="text-gray-500">Brug Campaign Builder til at v&aelig;lge brancher og services</p>
                </div>
                {% endif %}

                <!-- AI Detected Services -->
                {% if client.detected_services %}
                <div class="mt-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </span>
                        AI-Detected Services
                    </h4>
                    <div class="flex flex-wrap gap-2">
                        {% for service in client.detected_services %}
                        <span class="px-3 py-2 bg-green-50 text-green-700 rounded-lg border border-green-200">
                            {{ service.name|default:service }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- GEO SECTION -->
            <div id="section-geo" class="section-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Geo-Kampagne Overblik</h3>
                    <button onclick="openGeoModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                        <span>Se Bykort</span>
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                        <div class="text-3xl font-bold text-blue-600">{{ selected_cities|length }}</div>
                        <div class="text-sm text-blue-700">Byer valgt</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 border border-green-100">
                        <div class="text-3xl font-bold text-green-600">{{ created_bysider|length }}</div>
                        <div class="text-sm text-green-700">Bysider oprettet</div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-4 border border-orange-100">
                        <div class="text-3xl font-bold text-orange-600">{{ selected_cities|length|add:"-"|add:created_bysider|length }}</div>
                        <div class="text-sm text-orange-700">Bysider mangler</div>
                    </div>
                </div>

                <!-- Selected Regions -->
                {% if selected_region_ids %}
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Valgte Regioner</h4>
                    <div class="flex flex-wrap gap-2">
                        {% for region in geographic_regions %}
                            {% if region.id in selected_region_ids %}
                            <span class="px-3 py-2 bg-white rounded-lg border border-gray-200 flex items-center gap-2">
                                <span>{{ region.icon }}</span>
                                <span class="font-medium text-gray-900">{{ region.name }}</span>
                                <span class="text-sm text-gray-500">({{ region.cities_count }} byer)</span>
                            </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- City Comparison Table -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Bystatus Sammenligning</h4>

                    {% if byside_urls %}
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-500 border-b border-gray-200">
                                    <th class="pb-3 font-medium">By</th>
                                    <th class="pb-3 font-medium">URL</th>
                                    <th class="pb-3 font-medium text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for byside in byside_urls|slice:":20" %}
                                <tr class="hover:bg-white transition-colors">
                                    <td class="py-3 font-medium text-gray-900">{{ byside.city }}</td>
                                    <td class="py-3 text-sm text-gray-600">{{ byside.url|default:"-" }}</td>
                                    <td class="py-3 text-center">
                                        {% if byside.exists %}
                                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Oprettet</span>
                                        {% elif byside.edited %}
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">Redigeret</span>
                                        {% else %}
                                        <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">Mangler</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if byside_urls|length > 20 %}
                    <p class="text-sm text-gray-500 mt-4 text-center">Viser 20 af {{ byside_urls|length }} byer. <button onclick="openGeoModal()" class="text-purple-600 hover:text-purple-800">Se alle</button></p>
                    {% endif %}
                    {% else %}
                    <p class="text-gray-400 italic text-center py-8">Ingen bysider konfigureret endnu. Brug Campaign Builder til at ops&aelig;tte geo-kampagner.</p>
                    {% endif %}
                </div>
            </div>

            <!-- PAGES SECTION (Sider) -->
            <div id="section-pages" class="section-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">Website Sider</h3>
                        <p class="text-sm text-gray-500 mt-1">Oversigt over alle sider p√• websitet og sider oprettet af os</p>
                    </div>
                    <button onclick="syncSitemap()" id="sync-sitemap-btn" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Sync Sitemap</span>
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 rounded-xl p-4 border border-green-100">
                        <div class="text-3xl font-bold text-green-600" id="pages-live-count">0</div>
                        <div class="text-sm text-green-700">üü¢ Live (oprettet af os)</div>
                    </div>
                    <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-100">
                        <div class="text-3xl font-bold text-yellow-600" id="pages-pending-count">0</div>
                        <div class="text-sm text-yellow-700">üü° Pending (eksporteret)</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="text-3xl font-bold text-gray-600" id="pages-existing-count">0</div>
                        <div class="text-sm text-gray-700">‚ö™ Eksisterende</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 border border-purple-100">
                        <div class="text-3xl font-bold text-purple-600" id="pages-total-count">0</div>
                        <div class="text-sm text-purple-700">Total sider</div>
                    </div>
                </div>

                <!-- Segment Tabs -->
                <div class="bg-white rounded-xl border border-gray-200 mb-6">
                    <div class="flex flex-wrap border-b border-gray-200 px-4">
                        <button onclick="filterPages('all')" class="page-filter-btn active px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-purple-600 hover:border-purple-600 transition-all" data-filter="all">
                            Alle <span class="ml-1 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs" id="pages-filter-all-count">0</span>
                        </button>
                        <button onclick="filterPages('byside')" class="page-filter-btn px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-purple-600 hover:border-purple-600 transition-all" data-filter="byside">
                            Bysider <span class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs" id="pages-filter-byside-count">0</span>
                        </button>
                        <button onclick="filterPages('service')" class="page-filter-btn px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-purple-600 hover:border-purple-600 transition-all" data-filter="service">
                            Servicesider <span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full text-xs" id="pages-filter-service-count">0</span>
                        </button>
                        <button onclick="filterPages('blog')" class="page-filter-btn px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-purple-600 hover:border-purple-600 transition-all" data-filter="blog">
                            Blogindl√¶g <span class="ml-1 px-2 py-0.5 bg-green-100 text-green-600 rounded-full text-xs" id="pages-filter-blog-count">0</span>
                        </button>
                        <button onclick="filterPages('other')" class="page-filter-btn px-4 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-purple-600 hover:border-purple-600 transition-all" data-filter="other">
                            Andre <span class="ml-1 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs" id="pages-filter-other-count">0</span>
                        </button>
                    </div>

                    <!-- Status Filter & Search -->
                    <div class="p-4 border-b border-gray-100 flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">Status:</label>
                            <select id="pages-status-filter" onchange="filterPages()" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="all">Alle</option>
                                <option value="live">üü¢ Live</option>
                                <option value="pending">üü° Pending</option>
                                <option value="existing">‚ö™ Eksisterende</option>
                            </select>
                        </div>
                        <div class="flex-1 max-w-xs">
                            <input type="text" id="pages-search" placeholder="S√∏g URL..." class="w-full px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent" oninput="filterPages()">
                        </div>
                    </div>

                    <!-- Pages Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-500 border-b border-gray-200 bg-gray-50">
                                    <th class="px-4 py-3 font-medium">URL</th>
                                    <th class="px-4 py-3 font-medium">Type</th>
                                    <th class="px-4 py-3 font-medium text-center">Status</th>
                                    <th class="px-4 py-3 font-medium">Sidst tjekket</th>
                                </tr>
                            </thead>
                            <tbody id="pages-table-body" class="divide-y divide-gray-100">
                                <!-- Pages will be loaded via JS -->
                                <tr>
                                    <td colspan="4" class="px-4 py-12 text-center text-gray-400 italic">
                                        Klik "Sync Sitemap" for at hente sider fra websitet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="p-4 border-t border-gray-100 flex items-center justify-between">
                        <div class="text-sm text-gray-500">
                            Viser <span id="pages-showing">0</span> af <span id="pages-total">0</span> sider
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadPreviousPage()" id="pages-prev-btn" disabled class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Forrige</button>
                            <button onclick="loadNextPage()" id="pages-next-btn" disabled class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">N√¶ste</button>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Farvekoder</h4>
                    <div class="flex flex-wrap gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <span class="text-gray-600">üü¢ Live - oprettet af os og fundet i sitemap</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                            <span class="text-gray-600">üü° Pending - eksporteret men ikke i sitemap endnu</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                            <span class="text-gray-600">‚ö™ Eksisterende - kundens egen side</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- Geo Map Modal - Full Screen with Campaign Builder Functionality -->
<div id="geo-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300" onclick="closeGeoModal()"></div>
    <div class="absolute inset-0 bg-white shadow-2xl overflow-hidden flex flex-col">
        <!-- Modal Header -->
        <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-green-50 to-blue-50">
            <div>
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                    </span>
                    üåç Geo-Kampagne Bykort
                </h3>
                <p class="text-sm text-gray-600 ml-13">Klik p√• postnumre eller tegn cirkler for at v√¶lge omr√•der</p>
            </div>
            <button onclick="closeGeoModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Map Container (Leaflet) - 75% width -->
            <div id="geo-map" class="flex-1 bg-gray-100" style="min-width: 60%;"></div>

            <!-- Right Side Panel -->
            <div class="w-96 border-l border-gray-200 flex flex-col bg-white">
                <!-- Color Legend -->
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded mr-2" style="background-color: #22c55e;"></span>
                            <span class="text-gray-700">Byside eksisterer</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded mr-2" style="background-color: #444;"></span>
                            <span class="text-gray-700">Byside mangler</span>
                        </div>
                    </div>
                </div>

                <!-- Filter & Search -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" id="city-search" placeholder="S√∏g by..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterCities('all')" class="city-filter-btn active flex-1 px-3 py-1.5 text-xs font-medium rounded-lg border border-gray-200 hover:bg-gray-50" data-filter="all">Alle</button>
                        <button onclick="filterCities('created')" class="city-filter-btn flex-1 px-3 py-1.5 text-xs font-medium rounded-lg border border-green-200 hover:bg-green-50 text-green-600" data-filter="created">Oprettet</button>
                        <button onclick="filterCities('missing')" class="city-filter-btn flex-1 px-3 py-1.5 text-xs font-medium rounded-lg border border-orange-200 hover:bg-orange-50 text-orange-600" data-filter="missing">Mangler</button>
                    </div>
                </div>

                <!-- City List -->
                <div id="city-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <!-- Cities will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="p-4 border-t border-gray-200 flex justify-between bg-gray-50">
            <button type="button" id="clear-geo-selections-btn"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Ryd alle valg
            </button>
            <div class="flex gap-3">
                <button type="button" onclick="closeGeoModal()"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Luk
                </button>
            </div>
        </div>
    </div>
</div>

<!-- USP Selection Modal -->
<div id="usp-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300" onclick="closeUspModal()"></div>
    <div class="absolute bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col" style="top: 5%; left: 10%; right: 10%; bottom: 5%;">
        <!-- Modal Header -->
        <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50">
            <div>
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <span class="w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg flex items-center justify-center mr-3 text-white">‚≠ê</span>
                    V√¶lg USP'er
                </h3>
                <p class="text-sm text-gray-600 ml-13">V√¶lg eller tilf√∏j USP'er for {{ client.name }}</p>
            </div>
            <button onclick="closeUspModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Custom USPs Input Section -->
            <div class="mb-8 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200">
                <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                    <span class="mr-2">‚ûï</span> Tilf√∏j egne USPs
                </h4>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="modal-custom-usp-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Skriv din egen USP...">
                    <button type="button" onclick="addModalCustomUsp()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200">
                        Tilf√∏j
                    </button>
                </div>
                <div id="modal-custom-usps-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Custom USPs rendered here -->
                </div>
            </div>

            <!-- USP Categories & Templates -->
            <div>
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <span class="mr-2">‚≠ê</span> V√¶lg USPs fra listen
                </h4>
                <div class="space-y-6">
                    {% for category in usp_categories %}
                    <div class="bg-gray-50 rounded-xl p-6">
                        <!-- Category Header -->
                        <h5 class="text-base font-medium text-gray-900 mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white text-lg" style="background-color: {{ category.color|default:'#8B5CF6' }};">
                                {{ category.icon|default:'‚≠ê' }}
                            </span>
                            {{ category.name }}
                            <span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full">{{ category.usptemplate_set.count }} USPs</span>
                        </h5>

                        <!-- USP Template Cards Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% for usp in category.usptemplate_set.all %}
                            <div class="flex items-start p-3 bg-white rounded-lg border border-gray-200 hover:border-purple-300 transition-colors modal-usp-item" data-usp-id="{{ usp.id }}">
                                <input type="checkbox"
                                       class="mt-1 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded modal-usp-checkbox"
                                       data-usp-id="{{ usp.id }}"
                                       data-original-text="{{ usp.text }}"
                                       {% if usp.id in usp_ids %}checked{% endif %}>
                                <div class="flex-1 ml-3">
                                    <p class="font-medium text-gray-900 text-sm modal-usp-display-text" data-usp-id="{{ usp.id }}" data-original-text="{{ usp.text }}">{{ usp.text }}</p>
                                    {% if usp.is_cta %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">CTA</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-500 italic">Ingen USP kategorier fundet</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                <span id="modal-usp-count">0</span> USP'er valgt
            </div>
            <div class="flex gap-3">
                <button onclick="closeUspModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Annuller
                </button>
                <button onclick="saveUspSelection()" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200">
                    Gem USP'er
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
        <span id="toast-icon"></span>
        <span id="toast-message">Handling udf&oslash;rt</span>
    </div>
</div>

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const clientId = {{ client.id }};

// Crawled Pages Navigation Functions
function showCrawledPage(pagePath) {
    // Update nav items
    document.querySelectorAll('.crawled-page-nav-item').forEach(item => {
        if (item.dataset.pagePath === pagePath) {
            item.classList.remove('border-gray-200', 'hover:border-blue-300', 'hover:bg-gray-50');
            item.classList.add('border-blue-500', 'bg-blue-50');
        } else {
            item.classList.remove('border-blue-500', 'bg-blue-50');
            item.classList.add('border-gray-200', 'hover:border-blue-300', 'hover:bg-gray-50');
        }
    });

    // Update content previews
    document.querySelectorAll('.crawled-page-preview').forEach(preview => {
        if (preview.dataset.pagePath === pagePath) {
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    });
}

function copyCrawledPageText(pagePath) {
    // Find the visible preview and its textarea
    const visiblePreview = document.querySelector(`.crawled-page-preview[data-page-path="${pagePath}"]:not(.hidden)`);
    if (!visiblePreview) {
        // Try to find by path
        const allPreviews = document.querySelectorAll('.crawled-page-preview');
        allPreviews.forEach((preview, index) => {
            if (preview.dataset.pagePath === pagePath) {
                const textarea = document.getElementById(`crawled-text-${index + 1}`);
                if (textarea) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        showCopyFeedback('Tekst kopieret!');
                    });
                }
            }
        });
        return;
    }

    const textarea = visiblePreview.querySelector('textarea');
    if (textarea) {
        navigator.clipboard.writeText(textarea.value).then(() => {
            showCopyFeedback('Tekst kopieret!');
        });
    }
}

function showCopyFeedback(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

// Marked Pages System
const MARKED_PAGES_KEY = `marked_pages_client_${clientId}`;
let currentFilter = 'all';

function getMarkedPages() {
    const stored = localStorage.getItem(MARKED_PAGES_KEY);
    return stored ? JSON.parse(stored) : [];
}

function saveMarkedPages(pages) {
    localStorage.setItem(MARKED_PAGES_KEY, JSON.stringify(pages));
    updateMarkedCount();
}

function togglePageMarked(pagePath) {
    const markedPages = getMarkedPages();
    const index = markedPages.indexOf(pagePath);

    if (index > -1) {
        // Remove from marked
        markedPages.splice(index, 1);
    } else {
        // Add to marked
        markedPages.push(pagePath);
    }

    saveMarkedPages(markedPages);
    updatePageMarkedUI(pagePath, index === -1);

    // Re-apply filter if we're in "marked" mode
    if (currentFilter === 'marked') {
        filterCrawledPages('marked');
    }
}

function updatePageMarkedUI(pagePath, isMarked) {
    const navItem = document.querySelector(`.crawled-page-nav-item[data-page-path="${pagePath}"]`);
    if (!navItem) return;

    navItem.dataset.marked = isMarked ? 'true' : 'false';
    const icon = navItem.querySelector('.mark-icon');

    if (isMarked) {
        icon.textContent = '‚òÖ';
        icon.classList.remove('text-gray-300');
        icon.classList.add('text-yellow-400');
    } else {
        icon.textContent = '‚òÜ';
        icon.classList.remove('text-yellow-400');
        icon.classList.add('text-gray-300');
    }
}

function updateMarkedCount() {
    const count = getMarkedPages().length;
    const countEl = document.getElementById('marked-count');
    if (countEl) {
        countEl.textContent = `(${count})`;
    }
}

function filterCrawledPages(filter) {
    currentFilter = filter;
    const markedPages = getMarkedPages();
    const navItems = document.querySelectorAll('.crawled-page-nav-item');

    // Update filter button styles
    document.querySelectorAll('.crawled-filter-btn').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
    });

    const activeBtn = document.getElementById(`filter-${filter}`);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        activeBtn.classList.add('bg-blue-500', 'text-white');
    }

    // Filter nav items
    let visibleCount = 0;
    let firstVisible = null;

    navItems.forEach(item => {
        const pagePath = item.dataset.pagePath;
        const isMarked = markedPages.includes(pagePath);

        if (filter === 'all' || (filter === 'marked' && isMarked)) {
            item.classList.remove('hidden');
            visibleCount++;
            if (!firstVisible) firstVisible = pagePath;
        } else {
            item.classList.add('hidden');
        }
    });

    // If current active page is hidden, switch to first visible
    if (firstVisible) {
        const activePage = document.querySelector('.crawled-page-nav-item.border-blue-500:not(.hidden)');
        if (!activePage) {
            showCrawledPage(firstVisible);
        }
    }

    // Show empty state if no marked pages
    if (filter === 'marked' && visibleCount === 0) {
        showNoMarkedPagesMessage();
    } else {
        hideNoMarkedPagesMessage();
    }
}

function showNoMarkedPagesMessage() {
    let msg = document.getElementById('no-marked-pages-msg');
    if (!msg) {
        msg = document.createElement('div');
        msg.id = 'no-marked-pages-msg';
        msg.className = 'text-center py-8 text-gray-500';
        msg.innerHTML = `
            <div class="text-3xl mb-2">‚òÜ</div>
            <p class="text-sm">Ingen markerede sider</p>
            <p class="text-xs mt-1">Klik p√• stjernen for at markere en side</p>
        `;
        document.getElementById('crawled-pages-nav').appendChild(msg);
    }
    msg.classList.remove('hidden');
}

function hideNoMarkedPagesMessage() {
    const msg = document.getElementById('no-marked-pages-msg');
    if (msg) msg.classList.add('hidden');
}

function initMarkedPages() {
    const markedPages = getMarkedPages();

    // Update UI for all marked pages
    markedPages.forEach(pagePath => {
        updatePageMarkedUI(pagePath, true);
    });

    // Update count
    updateMarkedCount();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initMarkedPages);

// City data from Django
// Byside page counts per city (for clients with multiple services/branches)
const bysideCounts = {{ byside_counts|safe }};

const _rawCities = [
    {% for region in geographic_regions %}
        {% for city in region.cities.all %}
        {
            name: "{{ city.city_name|escapejs }}",
            region: "{{ region.name|escapejs }}",
            lat: {{ city.latitude|default:"55.6761" }},
            lng: {{ city.longitude|default:"12.5683" }},
            postalCode: "{{ city.postal_code }}",
            isSelected: {% if city.city_name in selected_cities %}true{% else %}false{% endif %},
            isCreated: {% if city.city_name in created_bysider %}true{% else %}false{% endif %},
            bysideCount: bysideCounts["{{ city.city_name|escapejs }}"] || 0
        },
        {% endfor %}
    {% endfor %}
];

// Deduplicate cities by name (keep first occurrence)
const allCities = _rawCities.filter((city, index, self) =>
    index === self.findIndex(c => c.name === city.name)
);

// Saved postal codes from database (for geo modal initialization)
const savedPostalCodes = {{ client.selected_postal_codes|safe|default:"[]" }};

// Initialize byside indicators in geo-coverage-section
function initBysideIndicators() {
    document.querySelectorAll('.city-coverage-item').forEach(item => {
        const cityName = item.dataset.city;
        const count = bysideCounts[cityName] || 0;
        const indicator = item.querySelector('.byside-indicator');
        const countSpan = item.querySelector('.byside-count');

        if (count > 0) {
            // Has byside pages - show green dot
            indicator.classList.remove('bg-gray-300');
            indicator.classList.add('bg-green-500');

            // Show count if more than 1
            if (count > 1) {
                countSpan.textContent = `(${count})`;
                countSpan.classList.remove('hidden');
            }
        }
    });
}

// Run on page load
document.addEventListener('DOMContentLoaded', initBysideIndicators);

// Filter secondary cities in coverage grid
function filterSecondaryCities() {
    const showSecondary = document.getElementById('show-secondary-cities');
    if (!showSecondary) return;

    const showSecondaryChecked = showSecondary.checked;

    // Update toggle visuals
    const track = document.getElementById('toggle-track');
    const knob = document.getElementById('toggle-knob');
    if (track && knob) {
        if (showSecondaryChecked) {
            track.style.background = 'linear-gradient(to right, #a855f7, #ec4899)';
            knob.style.transform = 'translateX(20px)';
        } else {
            track.style.background = '#d1d5db';
            knob.style.transform = 'translateX(0)';
        }
    }

    document.querySelectorAll('.city-coverage-item').forEach(item => {
        const isPrimary = item.dataset.isPrimary === 'true';
        const indicator = item.querySelector('.byside-indicator');
        const hasByside = indicator && indicator.classList.contains('bg-green-500');

        // Show if: primary city OR (toggle is ON) OR (secondary with green dot)
        if (isPrimary || showSecondaryChecked || hasByside) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    updateCityCount();
}

// Update displayed city count in header
function updateCityCount() {
    const total = document.querySelectorAll('.city-coverage-item').length;
    const visible = document.querySelectorAll('.city-coverage-item:not([style*="display: none"])').length;
    const secondary = document.querySelectorAll('.city-coverage-item[data-is-primary="false"]').length;

    // Update header count
    const headerCount = document.querySelector('#toggle-geo-coverage .text-xs');
    if (headerCount) {
        headerCount.textContent = `${visible} byer`;
    }

    // Update secondary count next to toggle
    const secondaryCount = document.getElementById('secondary-city-count');
    if (secondaryCount) {
        secondaryCount.textContent = `(+${secondary})`;
    }
}

// Initialize filter on page load (default: hide secondary)
document.addEventListener('DOMContentLoaded', function() {
    // Run after initBysideIndicators
    setTimeout(filterSecondaryCities, 100);
});

// Extract city slug from various URL patterns
function extractCitySlugFromUrl(urlPath) {
    const path = urlPath.toLowerCase().replace(/^\/|\/$/g, '');

    // Pattern 1: /service-i-city/ (with -i-)
    let match = path.match(/^[a-z]+-i-(.+)$/);
    if (match) return match[1];

    // Pattern 2: /service-city/ (standard)
    match = path.match(/^[a-z]+-(.+)$/);
    if (match) return match[1];

    return null;
}

// Update byside indicators from tracked pages data (called after sitemap sync)
function updateBysideIndicatorsFromPages() {
    // Check if trackedPages is available
    if (typeof trackedPages === 'undefined' || !Array.isArray(trackedPages)) {
        console.log('trackedPages not available yet');
        return;
    }

    // Get byside pages from trackedPages global variable
    const bysidePages = trackedPages.filter(p => p.page_type === 'byside');

    if (bysidePages.length === 0) return;

    // Build a set of city slugs that have byside pages
    const bysideSlugs = new Set();
    bysidePages.forEach(page => {
        const citySlug = extractCitySlugFromUrl(page.url_path);
        if (citySlug) {
            bysideSlugs.add(citySlug);
        }
    });

    // Update indicators
    document.querySelectorAll('.city-coverage-item').forEach(item => {
        const cityName = item.dataset.city;
        const indicator = item.querySelector('.byside-indicator');

        // Create slug from city name (simple Danish slug)
        const citySlug = cityName.toLowerCase()
            .replace(/√¶/g, 'ae')
            .replace(/√∏/g, 'oe')
            .replace(/√•/g, 'aa')
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '');

        // Check if this city has a byside page
        if (bysideSlugs.has(citySlug)) {
            indicator.classList.remove('bg-gray-300');
            indicator.classList.add('bg-green-500');
        }
    });
}

// Update indicators directly from sync result data (more accurate)
function updateBysideIndicatorsFromSyncResult(bysideCities) {
    if (!bysideCities || !Array.isArray(bysideCities)) return;

    // Build a set of primary city slugs that have byside pages
    // Use matched_primary_slug if available (for secondary cities), otherwise city_slug
    const matchedPrimarySlugs = new Set();
    bysideCities.forEach(c => {
        if (c.matched_primary_slug) {
            matchedPrimarySlugs.add(c.matched_primary_slug);
        } else {
            matchedPrimarySlugs.add(c.city_slug);
        }
    });

    // Update indicators
    document.querySelectorAll('.city-coverage-item').forEach(item => {
        const cityName = item.dataset.city;
        const indicator = item.querySelector('.byside-indicator');

        // Create slug from city name (this is the primary city slug)
        const citySlug = cityName.toLowerCase()
            .replace(/√¶/g, 'ae')
            .replace(/√∏/g, 'oe')
            .replace(/√•/g, 'aa')
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '');

        // Check if this primary city has a byside page (directly or via secondary city)
        if (matchedPrimarySlugs.has(citySlug)) {
            indicator.classList.remove('bg-gray-300');
            indicator.classList.add('bg-green-500');
        }
    });
}

// Show suggested cities that have pages but are not in geo coverage
function showSuggestedCities(suggestedCities) {
    const container = document.getElementById('suggested-cities-container');
    if (!container) return;

    if (!suggestedCities || suggestedCities.length === 0) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    const listElement = document.getElementById('suggested-cities-list');
    if (!listElement) return;

    listElement.innerHTML = suggestedCities.map(city => `
        <a href="${city.full_url}" target="_blank" class="flex items-center gap-2 px-2 py-1 bg-yellow-50 border border-yellow-200 rounded hover:bg-yellow-100 transition-colors text-sm">
            <span class="w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0"></span>
            <span class="text-gray-700">${city.city_name}</span>
            <svg class="w-3 h-3 text-gray-400 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
        </a>
    `).join('');

    // Update count badge
    const countBadge = document.getElementById('suggested-cities-count');
    if (countBadge) {
        countBadge.textContent = suggestedCities.length;
    }
}

// =====================================================
// LEAFLET MAP - DAWA Postal Code Polygons
// =====================================================
var geoMap = null;  // Leaflet map instance
var geoGeoJsonLayer = null;  // Layer containing all postal code polygons
var geoPostalData = {};  // { postalCode: { geometry, navn, polygon, displayName, additionalNames } }
var geoCircleMode = false;  // Toggle for circle drawing mode
var geoCircles = [];  // Array of Leaflet circles
var geoCircleDrawing = null;  // Current circle being drawn
var geoSelectedPostals = {};  // Track manually selected postals

// Color scheme for geo map (simplified: only byside status matters)
var GEO_COLORS = {
    existing: { fill: '#22c55e', stroke: '#16a34a' },  // Green - byside exists
    selected: { fill: '#444444', stroke: '#333333' },  // Gray - selected, no byside
    hover: { fill: '#6366F1', stroke: '#4F46E5' },     // Indigo - hover state
    default: { fill: '#E5E7EB', stroke: '#9CA3AF' }    // Light gray - unselected
};

// Save geo selection to server (real-time saving)
async function saveGeoSelection(action, postalCodes) {
    try {
        const response = await fetch(`/ajax/clients/${clientId}/update-geo-cities/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: action,
                postal_codes: postalCodes
            })
        });

        const data = await response.json();
        if (data.success) {
            showToast('√Ündringer gemt', 'success');
            updateGeoCoverageSection(data);
        } else {
            showToast('Fejl: ' + data.error, 'error');
        }
        return data;
    } catch (error) {
        console.error('Geo save error:', error);
        showToast('Netv√¶rksfejl', 'error');
        return { success: false };
    }
}

// Update the entire geo-coverage section with new data
function updateGeoCoverageSection(data) {
    // Update city count in header
    const countEl = document.querySelector('#toggle-geo-coverage .text-xs');
    if (countEl) {
        countEl.textContent = `${data.count} byer`;
    }

    // Rebuild city grid
    const gridContainer = document.querySelector('#geo-coverage-content .grid');
    if (gridContainer && data.cities) {
        gridContainer.innerHTML = data.cities.map(city => {
            const indicatorClass = city.hasByside ? 'bg-green-500' : 'bg-gray-300';
            const countHtml = city.bysideCount > 1
                ? `<span class="byside-count text-xs text-green-600 font-medium">(${city.bysideCount})</span>`
                : '<span class="byside-count text-xs text-green-600 font-medium hidden"></span>';

            return `
                <span class="flex items-center gap-1 city-coverage-item" data-city="${city.name}" data-is-primary="${city.isPrimary}">
                    <span class="byside-indicator w-2 h-2 rounded-full flex-shrink-0 ${indicatorClass}"></span>
                    <span class="city-name">${city.name}</span>
                    ${countHtml}
                </span>
            `;
        }).join('');

        // Update secondary city count
        const secondaryCount = data.cities.filter(c => !c.isPrimary).length;
        const secondaryCountEl = document.getElementById('secondary-city-count');
        if (secondaryCountEl) {
            secondaryCountEl.textContent = `(+${secondaryCount})`;
        }

        // Re-apply filter
        filterSecondaryCities();
    }

    // Update modal city list if open
    const geoModal = document.getElementById('geo-modal');
    if (geoModal && !geoModal.classList.contains('hidden')) {
        const activeFilter = document.querySelector('.city-filter-btn.active');
        const filter = activeFilter ? activeFilter.dataset.filter : 'all';
        populateCityList(filter);
    }
}

// Consolidate K√∏benhavn K, V and Frederiksberg C postal codes into single entries
function consolidateCopenhagenPostals(postalData) {
    var consolidations = {
        'kbh_k': {
            namePattern: 'K√∏benhavn K',
            displayName: 'K√∏benhavn',
            codes: []
        },
        'kbh_v': {
            namePatterns: ['Vesterbro', 'K√∏benhavn V'],
            displayName: 'Vesterbro',
            codes: []
        },
        'frb_c': {
            namePattern: 'Frederiksberg',
            displayName: 'Frederiksberg',
            codes: []
        }
    };

    // Find all postal codes that should be consolidated
    for (var nr in postalData) {
        var postal = postalData[nr];
        var davaName = postal.navn || '';

        for (var key in consolidations) {
            var c = consolidations[key];
            var matches = false;

            if (c.namePatterns) {
                matches = c.namePatterns.some(function(pattern) {
                    return davaName.indexOf(pattern) !== -1;
                });
            } else if (c.namePattern) {
                matches = davaName.indexOf(c.namePattern) !== -1;
            }

            if (matches) {
                c.codes.push(nr);
                break;
            }
        }
    }

    // For each consolidation: merge all polygons into one
    for (var key in consolidations) {
        var c = consolidations[key];
        if (c.codes.length > 0) {
            c.codes.sort();
            var primaryCode = c.codes[0];

            postalData[primaryCode].displayName = c.displayName;
            postalData[primaryCode].consolidatedCodes = c.codes;

            try {
                var polygonsToMerge = [];
                c.codes.forEach(function(code) {
                    var postal = postalData[code];
                    if (postal && postal.geometry) {
                        var feature = turf.feature(postal.geometry);
                        polygonsToMerge.push(feature);
                    }
                });

                if (polygonsToMerge.length > 1) {
                    var merged = polygonsToMerge[0];
                    for (var i = 1; i < polygonsToMerge.length; i++) {
                        try {
                            merged = turf.union(merged, polygonsToMerge[i]);
                        } catch (e) {
                            console.warn('Could not merge polygon', c.codes[i], e);
                        }
                    }

                    if (merged && merged.geometry) {
                        postalData[primaryCode].geometry = merged.geometry;
                    }
                }
            } catch (e) {
                console.error('Error merging polygons for', c.displayName, e);
            }

            for (var i = 1; i < c.codes.length; i++) {
                postalData[c.codes[i]].hidden = true;
            }
        }
    }

    return postalData;
}

// Load DAWA GeoJSON data for all postal codes
var dawaLoadingPromise = null;

function loadDAWAGeoJSON() {
    if (Object.keys(geoPostalData).length > 0) {
        return Promise.resolve(geoPostalData);
    }

    if (dawaLoadingPromise) {
        return dawaLoadingPromise;
    }

    console.log('Loading DAWA GeoJSON data...');

    dawaLoadingPromise = $.ajax({
        url: 'https://dawa.aws.dk/postnumre?format=geojson',
        timeout: 30000,
        dataType: 'json',
        cache: true
    }).then(function(geojson) {
        console.log('DAWA GeoJSON loaded:', geojson.features.length, 'postal codes');

        geojson.features.forEach(function(feature) {
            var nr = feature.properties.nr;

            geoPostalData[nr] = {
                nr: nr,
                navn: feature.properties.navn,
                displayName: '',
                geometry: feature.geometry,
                polygon: null,
                hidden: false,
                consolidatedCodes: null
            };
        });

        consolidateCopenhagenPostals(geoPostalData);

        dawaLoadingPromise = null;
        return geoPostalData;
    }).catch(function(error) {
        console.error('Error loading DAWA GeoJSON:', error);
        dawaLoadingPromise = null;
        throw error;
    });

    return dawaLoadingPromise;
}

// Get display name for a postal code
function getPostalDisplayName(nr) {
    var postal = geoPostalData[nr];
    if (!postal) return nr;
    return postal.displayName || postal.navn;
}

// Check if a byside exists for a city
function checkBysideExists(postalCode) {
    var city = allCities.find(c => c.postalCode === postalCode);
    return city && city.isCreated;
}

// Get polygon style based on selection and byside status
function getPolygonStyle(postalCode, isHover) {
    if (isHover) {
        return {
            fillColor: GEO_COLORS.hover.fill,
            fillOpacity: 0.7,
            color: GEO_COLORS.hover.stroke,
            weight: 3
        };
    }

    // Check if this postal code is selected (either in geoSelectedPostals or isSelected in allCities)
    var city = allCities.find(c => c.postalCode === postalCode);
    var isSelected = geoSelectedPostals[postalCode] || (city && city.isSelected);

    if (isSelected) {
        // Determine color based on byside existence, not selection source
        var hasByside = checkBysideExists(postalCode);
        var colors = hasByside ? GEO_COLORS.existing : GEO_COLORS.selected;
        return {
            fillColor: colors.fill,
            fillOpacity: 0.5,
            color: colors.stroke,
            weight: 2
        };
    }

    return {
        fillColor: GEO_COLORS.default.fill,
        fillOpacity: 0.3,
        color: GEO_COLORS.default.stroke,
        weight: 1
    };
}

// Initialize Leaflet map with Danish postal code polygons
function initGeoModal() {
    var mapContainer = document.getElementById('geo-map');
    if (!mapContainer) {
        console.error('geo-map element not found');
        return Promise.reject('Map container not found');
    }

    if (geoMap) {
        geoMap.invalidateSize();
        if (!geoGeoJsonLayer) {
            return loadDAWAGeoJSON().then(function(postalData) {
                createGeoJsonLayer(postalData);
            });
        }
        return Promise.resolve();
    }

    // Create Leaflet map centered on Denmark
    geoMap = L.map('geo-map', {
        center: [55.670523, 12.583819],
        zoom: 7,
        minZoom: 5,
        maxZoom: 18
    });

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(geoMap);

    // Load and display postal code polygons
    return loadDAWAGeoJSON().then(function(postalData) {
        createGeoJsonLayer(postalData);
    });
}

// Create GeoJSON layer from postal data
function createGeoJsonLayer(postalData) {
    if (geoGeoJsonLayer) {
        console.log('GeoJSON layer already exists');
        return;
    }

    var features = [];
    for (var nr in postalData) {
        var postal = postalData[nr];
        if (postal.hidden) continue;

        features.push({
            type: 'Feature',
            properties: {
                nr: nr,
                navn: postal.navn,
                displayName: postal.displayName
            },
            geometry: postal.geometry
        });
    }

    var geojson = {
        type: 'FeatureCollection',
        features: features
    };

    geoGeoJsonLayer = L.geoJSON(geojson, {
        style: function(feature) {
            return getPolygonStyle(feature.properties.nr, false);
        },
        onEachFeature: function(feature, layer) {
            var nr = feature.properties.nr;
            postalData[nr].polygon = layer;

            // Click handler
            layer.on('click', function(e) {
                if (geoCircleMode) return;
                togglePostalSelection(nr);
            });

            // Hover effect
            layer.on('mouseover', function(e) {
                layer.setStyle(getPolygonStyle(nr, true));
                layer.bringToFront();

                // Show tooltip with byside count
                var displayName = feature.properties.displayName || feature.properties.navn;
                var status = getCityStatus(nr);
                var city = allCities.find(c => c.postalCode === nr);
                var bysideCount = city ? city.bysideCount : 0;
                var statusText = status === 'created'
                    ? (bysideCount > 1 ? `${bysideCount} bysider` : 'Oprettet')
                    : status === 'missing' ? 'Mangler' : 'Ikke valgt';

                layer.bindTooltip(`<strong>${displayName}</strong><br>${nr}<br><span style="color: ${status === 'created' ? '#22c55e' : status === 'missing' ? '#f97316' : '#666'};">${statusText}</span>`, {
                    permanent: false,
                    direction: 'top'
                }).openTooltip();
            });

            layer.on('mouseout', function(e) {
                layer.setStyle(getPolygonStyle(nr, false));
                layer.closeTooltip();
            });
        }
    }).addTo(geoMap);

    console.log('GeoJSON layer created with', features.length, 'polygons');
    updateSelectionDisplay();
}

// Toggle postal selection
function togglePostalSelection(postalCode) {
    var isRemoving = !!geoSelectedPostals[postalCode];

    if (isRemoving) {
        delete geoSelectedPostals[postalCode];
        saveGeoSelection('remove', [postalCode]);
    } else {
        geoSelectedPostals[postalCode] = { source: 'clicked' };
        saveGeoSelection('add', [postalCode]);
    }

    // Update polygon style
    var postal = geoPostalData[postalCode];
    if (postal && postal.polygon) {
        postal.polygon.setStyle(getPolygonStyle(postalCode, false));
    }

    updateSelectionDisplay();
}

// Update selection display (no-op: textarea removed)
function updateSelectionDisplay() {
    // Previously updated the "Valgte postnumre" textarea which has been removed
}

// Add postal codes from input
function addPostalCodesFromInput() {
    var input = $('#geo-postal-input').val();
    if (!input) return;

    var codes = input.split(/[,;\s]+/).filter(function(c) {
        return c.match(/^\d{4}$/);
    });

    var newCodes = [];
    codes.forEach(function(code) {
        // Add code if not already selected (don't require geoPostalData to exist)
        if (!geoSelectedPostals[code]) {
            geoSelectedPostals[code] = { source: 'clicked' };
            newCodes.push(code);

            // Update map polygon if geoPostalData is available
            var postal = geoPostalData[code];
            if (postal && postal.polygon) {
                postal.polygon.setStyle(getPolygonStyle(code, false));
            }
        }
    });

    $('#geo-postal-input').val('');
    updateSelectionDisplay();

    if (newCodes.length > 0) {
        saveGeoSelection('add', newCodes);
    }
}

// Toggle circle drawing mode
function toggleCircleMode() {
    geoCircleMode = !geoCircleMode;
    var btn = $('#toggle-circle-mode-btn');

    if (geoCircleMode) {
        btn.addClass('bg-orange-100 border-orange-500').text('‚≠ï Cirkel-tegning (Aktiv)');

        geoMap.on('mousedown', startCircleDrawing);
        geoMap.on('mousemove', updateCircleDrawing);
        geoMap.on('mouseup', endCircleDrawing);

        geoMap.dragging.disable();

        showToast('Cirkel-tegning aktiveret. Klik og tr√¶k for at tegne.', 'info');
    } else {
        btn.removeClass('bg-orange-100 border-orange-500').html('<span>‚≠ï</span> Cirkel-tegning');

        geoMap.off('mousedown', startCircleDrawing);
        geoMap.off('mousemove', updateCircleDrawing);
        geoMap.off('mouseup', endCircleDrawing);

        geoMap.dragging.enable();

        showToast('Cirkel-tegning deaktiveret', 'info');
    }
}

// Circle drawing functions
function startCircleDrawing(e) {
    if (!geoCircleMode) return;

    geoCircleDrawing = {
        center: e.latlng,
        circle: L.circle(e.latlng, {
            radius: 0,
            color: GEO_COLORS.circle.stroke,
            fillColor: GEO_COLORS.circle.fill,
            fillOpacity: 0.3,
            weight: 2
        }).addTo(geoMap)
    };
}

function updateCircleDrawing(e) {
    if (!geoCircleDrawing) return;

    var radius = geoCircleDrawing.center.distanceTo(e.latlng);
    geoCircleDrawing.circle.setRadius(radius);
}

function endCircleDrawing(e) {
    if (!geoCircleDrawing) return;

    var circle = geoCircleDrawing.circle;
    geoCircles.push(circle);

    // Select postals within the circle
    selectPostalsInCircle(circle);

    geoCircleDrawing = null;
    updateSelectionDisplay();
}

// Select postals within a circle
function selectPostalsInCircle(circle) {
    var center = circle.getLatLng();
    var radius = circle.getRadius();
    var newlySelected = [];

    for (var nr in geoPostalData) {
        var postal = geoPostalData[nr];
        if (postal.polygon && !postal.hidden) {
            var postalCenter = postal.polygon.getBounds().getCenter();
            var distance = center.distanceTo(postalCenter);

            if (distance <= radius) {
                if (!geoSelectedPostals[nr]) {
                    geoSelectedPostals[nr] = { source: 'circle' };
                    newlySelected.push(nr);
                    postal.polygon.setStyle(getPolygonStyle(nr, false));
                }
            }
        }
    }

    // Save newly selected postal codes to server
    if (newlySelected.length > 0) {
        saveGeoSelection('add', newlySelected);
    }
}

// Clear all geo selections
function clearAllGeoSelections() {
    // Clear polygon selections
    for (var nr in geoSelectedPostals) {
        var postal = geoPostalData[nr];
        if (postal && postal.polygon) {
            postal.polygon.setStyle(getPolygonStyle(nr, false));
        }
    }
    geoSelectedPostals = {};

    // Clear circles
    geoCircles.forEach(function(circle) {
        geoMap.removeLayer(circle);
    });
    geoCircles = [];

    updateSelectionDisplay();
    saveGeoSelection('set', []);  // Clear all on server
}

// =====================================================
// GENERAL UI FUNCTIONS
// =====================================================

function showSection(sectionId) {
    document.querySelectorAll('.section-content').forEach(el => {
        el.classList.add('hidden');
    });

    document.querySelectorAll('.section-tab').forEach(el => {
        el.classList.remove('active', 'border-purple-600', 'text-purple-600');
        el.classList.add('border-transparent');
    });

    document.getElementById('section-' + sectionId).classList.remove('hidden');

    const activeTab = document.querySelector(`.section-tab[data-section="${sectionId}"]`);
    activeTab.classList.add('active', 'border-purple-600', 'text-purple-600');
    activeTab.classList.remove('border-transparent');
}

function showToast(message, type = 'success') {
    const toast = $('#toast');
    const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
    $('#toast-icon').html(icon);
    $('#toast-message').text(message);
    toast.removeClass('hidden');
    setTimeout(() => toast.addClass('hidden'), 3000);
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Kopieret til udklipsholder');
    });
}

// Toggle client profile JSON display
function toggleClientProfileJson() {
    const content = document.getElementById('client-profile-json-content');
    const icon = document.getElementById('client-profile-toggle-icon');
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}

// Toggle geo coverage display
function toggleGeoCoverage() {
    const content = document.getElementById('geo-coverage-content');
    const icon = document.getElementById('geo-coverage-toggle-icon');
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}

// Copy client profile JSON
function copyClientProfileJson() {
    const jsonDisplay = document.getElementById('client-profile-json-display');
    if (jsonDisplay) {
        navigator.clipboard.writeText(jsonDisplay.textContent).then(() => {
            showToast('JSON kopieret til udklipsholder');
        });
    }
}

// =====================================================
// TRACKED PAGES (Sider) SECTION
// =====================================================

let trackedPages = [];
let currentPageFilter = 'all';
let currentStatusFilter = 'all';
let currentSearchQuery = '';
let currentPageOffset = 0;
const pageLimit = 50;

// Sync sitemap to fetch pages from website
async function syncSitemap() {
    const btn = document.getElementById('sync-sitemap-btn');
    const originalContent = btn.innerHTML;

    btn.innerHTML = `
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span>Syncer...</span>
    `;
    btn.disabled = true;

    try {
        const response = await fetch(`/ajax/clients/${clientId}/sync-sitemap/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        const data = await response.json();

        if (data.success) {
            const bysideMsg = data.byside_count ? ` (${data.byside_count} bysider)` : '';
            showToast(`${data.message}${bysideMsg}. ${data.new_pages} nye, ${data.updated_pages} opdaterede.`);
            loadTrackedPages();

            // Update byside indicators with fresh data from sync
            if (data.byside_cities) {
                updateBysideIndicatorsFromSyncResult(data.byside_cities);
                // Re-apply filter to show secondary cities that now have green dots
                filterSecondaryCities();
            }

            // Show suggested cities (in sitemap but not in geo coverage)
            if (data.suggested_cities) {
                showSuggestedCities(data.suggested_cities);
            }
        } else {
            showToast('Fejl: ' + (data.message || 'Kunne ikke synce sitemap'), 'error');
        }
    } catch (error) {
        console.error('Error syncing sitemap:', error);
        showToast('Fejl ved sync af sitemap', 'error');
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

// Load tracked pages from API
async function loadTrackedPages() {
    try {
        const params = new URLSearchParams({
            type: currentPageFilter,
            status: currentStatusFilter,
            search: currentSearchQuery,
            offset: currentPageOffset,
            limit: pageLimit
        });

        const response = await fetch(`/ajax/clients/${clientId}/tracked-pages/?${params}`);
        const data = await response.json();

        if (data.success) {
            trackedPages = data.pages;
            updatePageStats(data.stats.by_status, data.stats.total);
            updatePageTypeCounts(data.stats.by_type, data.stats.total);
            renderPagesTable();
            updatePagination(data.stats.total, currentPageOffset);
        } else {
            showToast('Fejl ved hentning af sider', 'error');
        }
    } catch (error) {
        console.error('Error loading tracked pages:', error);
    }
}

// Update stats cards
function updatePageStats(statusCounts, total) {
    document.getElementById('pages-live-count').textContent = statusCounts.live || 0;
    document.getElementById('pages-pending-count').textContent = statusCounts.pending || 0;
    document.getElementById('pages-existing-count').textContent = statusCounts.existing || 0;
    document.getElementById('pages-total-count').textContent = total || 0;
}

// Update filter tab counts
function updatePageTypeCounts(typeCounts, total) {
    document.getElementById('pages-filter-all-count').textContent = total || 0;
    document.getElementById('pages-filter-byside-count').textContent = typeCounts.byside || 0;
    document.getElementById('pages-filter-service-count').textContent = typeCounts.service || 0;
    document.getElementById('pages-filter-blog-count').textContent = typeCounts.blog || 0;
    document.getElementById('pages-filter-other-count').textContent = typeCounts.other || 0;
}

// Render pages table
function renderPagesTable() {
    const tbody = document.getElementById('pages-table-body');

    if (trackedPages.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-12 text-center text-gray-400 italic">
                    ${currentPageFilter === 'all' && currentStatusFilter === 'all' && !currentSearchQuery
                        ? 'Klik "Sync Sitemap" for at hente sider fra websitet'
                        : 'Ingen sider matcher filteret'}
                </td>
            </tr>
        `;
        return;
    }

    const typeLabels = {
        'byside': { text: 'Byside', class: 'bg-blue-100 text-blue-700' },
        'service': { text: 'Service', class: 'bg-purple-100 text-purple-700' },
        'blog': { text: 'Blog', class: 'bg-green-100 text-green-700' },
        'other': { text: 'Andre', class: 'bg-gray-100 text-gray-700' }
    };

    const statusBadges = {
        'live': { text: 'Live', class: 'bg-green-100 text-green-700', dot: 'bg-green-500' },
        'pending': { text: 'Pending', class: 'bg-yellow-100 text-yellow-700', dot: 'bg-yellow-500' },
        'existing': { text: 'Eksisterende', class: 'bg-gray-100 text-gray-600', dot: 'bg-gray-400' }
    };

    tbody.innerHTML = trackedPages.map(page => {
        const type = typeLabels[page.page_type] || typeLabels['other'];
        const status = statusBadges[page.status] || statusBadges['existing'];
        const lastChecked = page.last_checked_at
            ? new Date(page.last_checked_at).toLocaleDateString('da-DK')
            : '-';

        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3">
                    <a href="${page.full_url || '#'}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium">
                        ${page.url_path}
                    </a>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 ${type.class} text-xs font-medium rounded-full">${type.text}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="inline-flex items-center gap-1.5 px-2 py-1 ${status.class} text-xs font-medium rounded-full">
                        <span class="w-2 h-2 rounded-full ${status.dot}"></span>
                        ${status.text}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">${lastChecked}</td>
            </tr>
        `;
    }).join('');
}

// Filter pages by type
function filterPages(pageType) {
    if (pageType && pageType !== currentPageFilter) {
        currentPageFilter = pageType;
        currentPageOffset = 0;

        // Update active filter button
        document.querySelectorAll('.page-filter-btn').forEach(btn => {
            if (btn.dataset.filter === pageType) {
                btn.classList.add('active', 'border-purple-600', 'text-purple-600');
            } else {
                btn.classList.remove('active', 'border-purple-600', 'text-purple-600');
            }
        });
    }

    // Get status filter
    currentStatusFilter = document.getElementById('pages-status-filter').value;

    // Get search query
    currentSearchQuery = document.getElementById('pages-search').value.trim();

    loadTrackedPages();
}

// Update pagination
function updatePagination(total, offset) {
    const showing = Math.min(offset + trackedPages.length, total);
    document.getElementById('pages-showing').textContent = trackedPages.length > 0 ? `${offset + 1}-${showing}` : '0';
    document.getElementById('pages-total').textContent = total;

    document.getElementById('pages-prev-btn').disabled = offset === 0;
    document.getElementById('pages-next-btn').disabled = offset + pageLimit >= total;
}

// Pagination handlers
function loadPreviousPage() {
    if (currentPageOffset >= pageLimit) {
        currentPageOffset -= pageLimit;
        loadTrackedPages();
    }
}

function loadNextPage() {
    currentPageOffset += pageLimit;
    loadTrackedPages();
}

// Load pages when switching to pages tab
document.addEventListener('DOMContentLoaded', function() {
    // Only load pages if section is shown
    const pagesSection = document.getElementById('section-pages');
    if (pagesSection && !pagesSection.classList.contains('hidden')) {
        loadTrackedPages();
    }
});

// Also load when tab is clicked
const originalShowSection = window.showSection;
window.showSection = function(sectionId) {
    originalShowSection(sectionId);
    if (sectionId === 'pages' && trackedPages.length === 0) {
        loadTrackedPages();
    }
};

// =====================================================
// EDIT FUNCTIONALITY - Virksomhed section
// =====================================================

// Store original values for cancel functionality
let originalDescription = '';
let originalCustomUsps = [];

// Auto-resize textarea to fit content
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Toggle description edit mode (activated by double-click)
function toggleDescriptionEdit() {
    const viewMode = document.getElementById('description-view-mode');
    const editMode = document.getElementById('description-edit-mode');
    const textarea = document.getElementById('description-textarea');

    if (editMode.classList.contains('hidden')) {
        // Store original value
        originalDescription = textarea.value;
        // Switch to edit mode
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        // Auto-resize textarea to fit content
        autoResizeTextarea(textarea);
        textarea.focus();
    } else {
        cancelDescriptionEdit();
    }
}

function cancelDescriptionEdit() {
    const viewMode = document.getElementById('description-view-mode');
    const editMode = document.getElementById('description-edit-mode');
    const textarea = document.getElementById('description-textarea');

    // Restore original value
    textarea.value = originalDescription;
    // Switch back to view mode
    editMode.classList.add('hidden');
    viewMode.classList.remove('hidden');
}

async function saveDescription() {
    const textarea = document.getElementById('description-textarea');
    const newDescription = textarea.value.trim();

    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                description: newDescription
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update view mode display
            const displayEl = document.getElementById('description-display');
            if (displayEl) {
                if (newDescription) {
                    displayEl.textContent = newDescription;
                    displayEl.classList.remove('text-gray-400', 'italic');
                    displayEl.classList.add('text-gray-700');
                } else {
                    displayEl.textContent = 'Ingen beskrivelse gemt';
                    displayEl.classList.add('text-gray-400', 'italic');
                    displayEl.classList.remove('text-gray-700');
                }
            }

            // Update originalDescription so next edit starts with correct value
            originalDescription = newDescription;

            // Switch back to view mode
            cancelDescriptionEdit();
            showToast('Beskrivelse gemt');
        } else {
            showToast('Fejl: ' + (data.error || 'Kunne ikke gemme'), 'error');
        }
    } catch (error) {
        console.error('Error saving description:', error);
        showToast('Fejl ved gem af beskrivelse', 'error');
    }
}

// =====================================================
// Custom USP Individual Edit Functions (like predefined USPs)
// =====================================================

// Store for custom USPs data
let customUspsData = [...{{ custom_usps|safe }}];

// Get all custom USPs from the DOM
function getCustomUspsFromDOM() {
    const items = document.querySelectorAll('#custom-usps-list .custom-usp-item');
    return Array.from(items).map(item => item.dataset.uspText || item.querySelector('.custom-usp-text')?.textContent || '').filter(v => v);
}

// Enter edit mode for custom USP item (show input + delete button)
function enterCustomUspEditMode(item) {
    const $item = $(item);
    if ($item.hasClass('custom-usp-edit-mode')) return;

    // Exit any other custom USP edit modes first
    exitAllCustomUspEditModes();

    $item.addClass('custom-usp-edit-mode');
    const currentText = $item.data('usp-text') || $item.find('.custom-usp-text').text();
    const index = $item.data('usp-index');

    // Create wrapper with flex layout
    if ($item.find('.custom-usp-edit-wrapper').length === 0) {
        const $textSpan = $item.find('.custom-usp-text');

        // Create wrapper with input and delete button
        const wrapper = $('<div class="custom-usp-edit-wrapper flex items-center gap-2"></div>');

        // Create input field
        const input = $(`<input type="text" value="${escapeHtml(currentText)}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent custom-usp-edit-input">`);

        // Add delete button
        const deleteBtn = $(`
            <button type="button" class="custom-usp-delete-btn text-red-500 hover:text-red-700 p-2 flex-shrink-0"
                    onclick="deleteCustomUsp(${index}, this)" title="Fjern USP">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `);

        // Hide text span and add wrapper
        $textSpan.hide();
        wrapper.append(input);
        wrapper.append(deleteBtn);
        $item.append(wrapper);

        // Focus input and select all
        input.focus().select();

        // Handle Enter key to save
        input.on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveCustomUspEdit($item, input.val().trim());
            } else if (e.key === 'Escape') {
                e.preventDefault();
                exitCustomUspEditMode($item[0]);
            }
        });

        // Handle blur to save
        input.on('blur', function(e) {
            // Small delay to check if delete button was clicked
            setTimeout(() => {
                if ($item.hasClass('custom-usp-edit-mode')) {
                    saveCustomUspEdit($item, input.val().trim());
                }
            }, 150);
        });
    }
}

// Exit edit mode for custom USP item
function exitCustomUspEditMode(item) {
    const $item = $(item);
    $item.removeClass('custom-usp-edit-mode');

    // Remove wrapper and show text span
    const $wrapper = $item.find('.custom-usp-edit-wrapper');
    if ($wrapper.length > 0) {
        $wrapper.remove();
    }

    const $textSpan = $item.find('.custom-usp-text');
    $textSpan.show();
}

// Exit all custom USP edit modes
function exitAllCustomUspEditModes() {
    $('.custom-usp-item.custom-usp-edit-mode').each(function() {
        exitCustomUspEditMode(this);
    });
}

// Save custom USP edit
async function saveCustomUspEdit($item, newText) {
    const index = parseInt($item.data('usp-index'));
    const originalText = $item.data('usp-text');

    // If text is empty, delete the USP
    if (!newText) {
        deleteCustomUsp(index, null);
        return;
    }

    // If text hasn't changed, just exit edit mode
    if (newText === originalText) {
        exitCustomUspEditMode($item[0]);
        return;
    }

    // Update local data
    customUspsData[index] = newText;

    // Save to server
    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                custom_usps: customUspsData
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update the item
            $item.data('usp-text', newText);
            $item.find('.custom-usp-text').text(newText);
            exitCustomUspEditMode($item[0]);
            showToast('USP gemt');
        } else {
            showToast('Fejl: ' + (data.error || 'Kunne ikke gemme'), 'error');
            // Revert local data
            customUspsData[index] = originalText;
        }
    } catch (error) {
        console.error('Error saving custom USP:', error);
        showToast('Fejl ved gem af USP', 'error');
        // Revert local data
        customUspsData[index] = originalText;
    }
}

// Delete custom USP
async function deleteCustomUsp(index, btnElement) {
    // Remove from local array
    customUspsData.splice(index, 1);

    // Save to server
    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                custom_usps: customUspsData
            })
        });

        const data = await response.json();

        if (data.success) {
            // Rebuild the list
            rebuildCustomUspsList();
            showToast('USP slettet');
        } else {
            showToast('Fejl: ' + (data.error || 'Kunne ikke slette'), 'error');
        }
    } catch (error) {
        console.error('Error deleting custom USP:', error);
        showToast('Fejl ved sletning af USP', 'error');
    }
}

// Add new custom USP
async function addNewCustomUsp() {
    // Exit any existing edit modes
    exitAllCustomUspEditModes();

    // Add empty USP to data
    const newIndex = customUspsData.length;
    customUspsData.push('');

    // Remove empty state if present
    const emptyEl = document.getElementById('custom-usps-empty');
    if (emptyEl) {
        emptyEl.remove();
    }

    // Create new item element
    const listEl = document.getElementById('custom-usps-list');
    const newItem = document.createElement('div');
    newItem.className = 'bg-white rounded-lg p-3 border border-gray-200 text-gray-700 hover:border-blue-300 hover:bg-blue-50 transition-colors custom-usp-item';
    newItem.setAttribute('data-usp-index', newIndex);
    newItem.setAttribute('data-usp-text', '');
    newItem.innerHTML = '<span class="custom-usp-text"></span>';
    listEl.appendChild(newItem);

    // Enter edit mode for the new item
    enterCustomUspEditMode(newItem);

    // Update count
    updateCustomUspsCount();
}

// Rebuild custom USPs list after delete
function rebuildCustomUspsList() {
    const listEl = document.getElementById('custom-usps-list');

    if (customUspsData.length === 0) {
        listEl.innerHTML = `
            <div id="custom-usps-empty" class="bg-white rounded-lg p-4 border border-gray-200 border-dashed text-center">
                <p class="text-gray-400 italic">Ingen brugerdefinerede USP'er</p>
            </div>
        `;
    } else {
        let html = '';
        customUspsData.forEach((usp, index) => {
            html += `
                <div class="bg-white rounded-lg p-3 border border-gray-200 text-gray-700 hover:border-blue-300 hover:bg-blue-50 transition-colors custom-usp-item"
                     data-usp-index="${index}"
                     data-usp-text="${escapeHtml(usp)}">
                    <span class="custom-usp-text">${escapeHtml(usp)}</span>
                </div>
            `;
        });
        listEl.innerHTML = html;
    }

    // Update count
    updateCustomUspsCount();
}

// Update custom USPs count badge
function updateCustomUspsCount() {
    const countEl = document.getElementById('custom-usps-count');
    if (countEl) {
        countEl.textContent = customUspsData.length;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =====================================================
// USP Variable System Functions (matches Campaign Builder)
// =====================================================

// Parse USP text and identify variables with format {VARIABEL:default}
function parseUspVariables(text) {
    const regex = /\{([A-Z√Ü√ò√Ö0-9_]+)(?::([^}]*))?\}/g;
    const variables = [];
    let match;
    while ((match = regex.exec(text)) !== null) {
        variables.push({
            fullMatch: match[0],
            name: match[1],
            defaultValue: match[2] || '',
            startIndex: match.index,
            endIndex: match.index + match[0].length
        });
    }
    return variables;
}

// Check if USP text contains variables
function uspHasVariables(text) {
    return parseUspVariables(text).length > 0;
}

// Get USP display text with default values substituted (plain text, no HTML)
function getUspDisplayText(text) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        return text;
    }
    let result = text;
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        result = result.substring(0, v.startIndex) + v.defaultValue + result.substring(v.endIndex);
    }
    return result;
}

// Render USP with clickable variable spans
function renderUspWithVariables(text, uspId) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        return escapeHtml(text);
    }

    let html = '';
    let lastIndex = 0;

    variables.forEach((v, idx) => {
        if (v.startIndex > lastIndex) {
            html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex, v.startIndex))}</span>`;
        }

        const userValues = modalUspVariableValues[uspId] || {};
        const currentValue = userValues[idx] !== undefined ? userValues[idx] : v.defaultValue;

        html += `<span class="usp-variable"
                      data-usp-id="${uspId}"
                      data-var-name="${v.name}"
                      data-var-index="${idx}"
                      data-default="${escapeHtml(v.defaultValue)}"
                      title="Klik for at redigere ${v.name}">${escapeHtml(currentValue)}</span>`;

        lastIndex = v.endIndex;
    });

    if (lastIndex < text.length) {
        html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex))}</span>`;
    }

    return html;
}

// Get final USP text with all variables substituted
function getUspFinalText(uspId, originalText) {
    const variables = parseUspVariables(originalText);
    if (variables.length === 0) {
        return modalUspCustomTexts[uspId] || originalText;
    }

    const userValues = modalUspVariableValues[uspId] || {};
    let result = originalText;
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        const value = userValues[i] !== undefined ? userValues[i] : v.defaultValue;
        result = result.substring(0, v.startIndex) + value + result.substring(v.endIndex);
    }
    return result;
}

// Start inline editing of a variable
function startVariableEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const varIndex = $el.data('var-index');
    const varName = $el.data('var-name');
    const defaultValue = $el.data('default');

    const userValues = modalUspVariableValues[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    $el.addClass('editing');
    const inputWidth = Math.max(50, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="usp-variable-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;" placeholder="${escapeHtml(varName)}">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save variable edit
function saveVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');
    const newValue = $input.val().trim();

    if (!modalUspVariableValues[uspId]) {
        modalUspVariableValues[uspId] = {};
    }

    const valueToSave = newValue || defaultValue;
    modalUspVariableValues[uspId][varIndex] = valueToSave;

    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    console.log('Variable saved:', uspId, varIndex, valueToSave);
}

// Cancel variable edit
function cancelVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');

    const userValues = modalUspVariableValues[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// Update USP display text based on checked state
function updateUspDisplayText(uspId, isChecked) {
    const displayEl = document.querySelector(`.modal-usp-display-text[data-usp-id="${uspId}"]`);
    if (!displayEl) return;

    const originalText = displayEl.dataset.originalText;
    const hasVars = uspHasVariables(originalText);

    if (isChecked && hasVars) {
        // Show with clickable variable spans
        displayEl.innerHTML = renderUspWithVariables(originalText, uspId);
        displayEl.classList.add('usp-has-variables');
    } else if (hasVars) {
        // Show plain text with defaults
        displayEl.innerHTML = escapeHtml(getUspDisplayText(originalText));
        displayEl.classList.remove('usp-has-variables');
    } else {
        // No variables, just show original text
        displayEl.innerHTML = escapeHtml(originalText);
    }
}

// =====================================================
// INLINE USP Variable Editing (on page display)
// =====================================================

// Store for inline variable values (separate from modal)
let inlineUspVariableValues = {};

// Initialize inline USP display with clickable variable spans
function initializeInlineUspVariables() {
    // Load initial values from Django
    inlineUspVariableValues = JSON.parse(JSON.stringify({{ usp_variable_values|safe }}));

    // Find all USP display items and render variable spans
    document.querySelectorAll('.usp-display-item').forEach(item => {
        const uspId = item.dataset.uspId;
        const originalText = item.dataset.originalText;
        const hasVariables = item.dataset.hasVariables === 'true';

        if (hasVariables && originalText) {
            const displayTextEl = item.querySelector('.usp-display-text');
            if (displayTextEl) {
                displayTextEl.innerHTML = renderInlineUspWithVariables(originalText, uspId);
            }
        }
    });
}

// Render USP with clickable variable spans for inline display
function renderInlineUspWithVariables(text, uspId) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        return escapeHtml(text);
    }

    let html = '';
    let lastIndex = 0;

    variables.forEach((v, idx) => {
        if (v.startIndex > lastIndex) {
            html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex, v.startIndex))}</span>`;
        }

        const userValues = inlineUspVariableValues[uspId] || {};
        const currentValue = userValues[idx] !== undefined ? userValues[idx] : v.defaultValue;

        html += `<span class="usp-variable inline-usp-variable"
                      data-usp-id="${uspId}"
                      data-var-name="${v.name}"
                      data-var-index="${idx}"
                      data-default="${escapeHtml(v.defaultValue)}"
                      title="Klik for at redigere ${v.name}">${escapeHtml(currentValue)}</span>`;

        lastIndex = v.endIndex;
    });

    if (lastIndex < text.length) {
        html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex))}</span>`;
    }

    return html;
}

// Start inline variable edit (on page, not modal)
function startInlineVariableEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const varIndex = $el.data('var-index');
    const varName = $el.data('var-name');
    const defaultValue = $el.data('default');

    const userValues = inlineUspVariableValues[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    $el.addClass('editing');
    const inputWidth = Math.max(50, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="inline-usp-variable-input usp-variable-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;" placeholder="${escapeHtml(varName)}">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save inline variable edit and persist to server
async function saveInlineVariableEdit($input) {
    const $span = $input.closest('.inline-usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');
    const newValue = $input.val().trim();

    if (!inlineUspVariableValues[uspId]) {
        inlineUspVariableValues[uspId] = {};
    }

    const valueToSave = newValue || defaultValue;
    inlineUspVariableValues[uspId][varIndex] = valueToSave;

    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    // Save to server
    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                usp_variable_values: inlineUspVariableValues
            })
        });

        const data = await response.json();
        if (data.success) {
            showToast('Variabel opdateret');
        } else {
            showToast('Fejl ved gem', 'error');
        }
    } catch (error) {
        console.error('Error saving variable:', error);
        showToast('Fejl ved gem', 'error');
    }
}

// Cancel inline variable edit
function cancelInlineVariableEdit($input) {
    const $span = $input.closest('.inline-usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');

    const userValues = inlineUspVariableValues[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// =====================================================
// USP Item Edit Mode (with delete button)
// =====================================================

// Store for inline USP IDs (mutable copy)
let inlineUspIds = [];

// Initialize inline USP IDs from Django
function initializeInlineUspIds() {
    inlineUspIds = [...{{ usp_ids|safe }}];
}

// Enter edit mode for USP item (show delete button inline like custom USPs)
function enterUspEditMode(item) {
    const $item = $(item);
    if ($item.hasClass('usp-edit-mode')) return;

    $item.addClass('usp-edit-mode');

    // Wrap content in flex container and add delete button (like custom USPs)
    if ($item.find('.usp-edit-wrapper').length === 0) {
        const uspId = $item.data('usp-id');
        const $displayText = $item.find('.usp-display-text');
        const $categoryLabel = $item.find('.usp-category-label');

        // Create wrapper with flex layout
        const wrapper = $('<div class="usp-edit-wrapper flex items-center gap-2"></div>');
        const contentDiv = $('<div class="flex-1"></div>');

        // Move content into wrapper
        $displayText.detach().appendTo(contentDiv);
        $categoryLabel.detach().appendTo(contentDiv);
        wrapper.append(contentDiv);

        // Add delete button (same style as custom USPs)
        const deleteBtn = `
            <button type="button" class="usp-delete-btn text-red-500 hover:text-red-700 p-2 flex-shrink-0"
                    onclick="deleteInlineUsp(${uspId}, this)" title="Fjern USP">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        wrapper.append(deleteBtn);

        $item.append(wrapper);
    }

    // Also trigger variable edit if there's a variable
    const $variable = $item.find('.inline-usp-variable').first();
    if ($variable.length > 0 && !$variable.hasClass('editing')) {
        startInlineVariableEdit($variable[0]);
    }
}

// Exit edit mode for USP item
function exitUspEditMode(item) {
    const $item = $(item);
    $item.removeClass('usp-edit-mode');

    // Restore original structure - move content out of wrapper
    const $wrapper = $item.find('.usp-edit-wrapper');
    if ($wrapper.length > 0) {
        const $displayText = $wrapper.find('.usp-display-text');
        const $categoryLabel = $wrapper.find('.usp-category-label');

        // Move content back to item
        $displayText.detach().prependTo($item);
        if ($categoryLabel.length > 0) {
            $categoryLabel.detach().appendTo($item);
        }

        // Remove wrapper (includes delete button)
        $wrapper.remove();
    }
}

// Exit all USP edit modes
function exitAllUspEditModes() {
    $('.usp-display-item.usp-edit-mode').each(function() {
        exitUspEditMode(this);
    });
}

// Delete USP from inline list and save to server
async function deleteInlineUsp(uspId, btnElement) {
    // Remove from local array
    inlineUspIds = inlineUspIds.filter(id => id !== uspId);

    // Remove the DOM element with animation
    const $item = $(btnElement).closest('.usp-display-item');
    $item.fadeOut(200, function() {
        $(this).remove();

        // Update count
        const countEl = document.getElementById('predefined-usps-count');
        if (countEl) {
            countEl.textContent = inlineUspIds.length;
        }

        // Show empty state if no more USPs
        if (inlineUspIds.length === 0) {
            $('#predefined-usps-list').html(`
                <div id="predefined-usps-empty" class="bg-white rounded-lg p-4 border border-gray-200 border-dashed hover:border-purple-300 hover:bg-purple-50 transition-colors cursor-pointer" onclick="openUspModal()">
                    <p class="text-gray-400 italic">Klik for at v√¶lge USP'er</p>
                </div>
            `);
        }
    });

    // Save to server
    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                usp_ids: inlineUspIds
            })
        });

        const data = await response.json();
        if (data.success) {
            showToast('USP fjernet');
            // Update initialUspIds for modal sync
            initialUspIds.length = 0;
            initialUspIds.push(...inlineUspIds);
        } else {
            showToast('Fejl ved sletning', 'error');
        }
    } catch (error) {
        console.error('Error deleting USP:', error);
        showToast('Fejl ved sletning', 'error');
    }
}

function getCsrfToken() {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

// =====================================================
// USP MODAL FUNCTIONALITY
// =====================================================

// Store modal state
let modalUspIds = [];
let modalCustomUsps = [];
let modalUspVariableValues = {};
let modalUspCustomTexts = {};

// Initialize from Django template data
const initialUspIds = {{ usp_ids|safe }};
const initialUspVariableValues = {{ usp_variable_values|safe }};
const initialUspCustomTexts = {{ usp_custom_texts|safe }};

function openUspModal() {
    // Reset modal state to current saved values
    modalUspIds = [...initialUspIds];
    modalCustomUsps = [...({{ custom_usps|safe }} || [])];
    modalUspVariableValues = JSON.parse(JSON.stringify(initialUspVariableValues));
    modalUspCustomTexts = JSON.parse(JSON.stringify(initialUspCustomTexts));

    // Update checkboxes to reflect current selection and render USP texts with variables
    document.querySelectorAll('.modal-usp-checkbox').forEach(checkbox => {
        const uspId = parseInt(checkbox.dataset.uspId);
        const isChecked = modalUspIds.includes(uspId);
        checkbox.checked = isChecked;

        // Update display text with variable spans if checked
        updateUspDisplayText(uspId, isChecked);
    });

    // Render custom USPs in modal
    renderModalCustomUsps();

    // Update count
    updateModalUspCount();

    // Show modal
    document.getElementById('usp-modal').classList.remove('hidden');
}

function closeUspModal() {
    document.getElementById('usp-modal').classList.add('hidden');
}

function renderModalCustomUsps() {
    const container = document.getElementById('modal-custom-usps-container');
    if (!container) return;

    if (modalCustomUsps.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    modalCustomUsps.forEach((usp, index) => {
        html += `
            <div class="flex items-start p-3 bg-white rounded-lg border border-purple-200 modal-custom-usp-item" data-index="${index}">
                <span class="w-5 h-5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs flex items-center justify-center mt-0.5 flex-shrink-0">‚úì</span>
                <div class="flex-1 px-2">
                    <p class="font-medium text-gray-900 text-sm custom-usp-display-text cursor-pointer hover:text-purple-600" data-index="${index}">${escapeHtml(usp)}</p>
                    <input type="text" class="custom-usp-edit-input w-full px-2 py-1 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" style="display: none;" value="${escapeHtml(usp)}" data-index="${index}">
                </div>
                <button type="button" onclick="removeModalCustomUsp(${index})" class="text-gray-400 hover:text-red-500 p-1 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
    });
    container.innerHTML = html;
}

function addModalCustomUsp() {
    const input = document.getElementById('modal-custom-usp-input');
    const value = input.value.trim();
    if (!value) return;

    modalCustomUsps.push(value);
    input.value = '';
    renderModalCustomUsps();
    updateModalUspCount();
}

function removeModalCustomUsp(index) {
    modalCustomUsps.splice(index, 1);
    renderModalCustomUsps();
    updateModalUspCount();
}

function updateModalUspCount() {
    const checkboxes = document.querySelectorAll('.modal-usp-checkbox:checked');
    const templateCount = checkboxes.length;
    const customCount = modalCustomUsps.length;
    const total = templateCount + customCount;

    const countEl = document.getElementById('modal-usp-count');
    if (countEl) {
        countEl.textContent = total;
    }
}

// Handle checkbox changes - also update USP display with/without variable spans
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('modal-usp-checkbox')) {
        const uspId = parseInt(e.target.dataset.uspId);
        const isChecked = e.target.checked;

        if (isChecked) {
            if (!modalUspIds.includes(uspId)) {
                modalUspIds.push(uspId);
            }
        } else {
            modalUspIds = modalUspIds.filter(id => id !== uspId);
        }

        // Update display text with variable spans if checked
        updateUspDisplayText(uspId, isChecked);
        updateModalUspCount();
    }
});

// Handle Enter key in custom USP input
document.addEventListener('keypress', function(e) {
    if (e.target.id === 'modal-custom-usp-input' && e.key === 'Enter') {
        e.preventDefault();
        addModalCustomUsp();
    }
});

// =====================================================
// Event Handlers for INLINE USP Variable Editing (on page)
// =====================================================

// Double-click on USP item to enter edit mode (with delete button)
$(document).on('dblclick', '.usp-display-item', function(e) {
    e.stopPropagation();
    // Exit other edit modes first
    exitAllUspEditModes();
    enterUspEditMode(this);
});

// Double-click on inline variable span to start editing (for direct variable click)
$(document).on('dblclick', '.inline-usp-variable', function(e) {
    e.stopPropagation();
    // Also enter edit mode for parent item
    const $item = $(this).closest('.usp-display-item');
    if (!$item.hasClass('usp-edit-mode')) {
        exitAllUspEditModes();
        enterUspEditMode($item[0]);
    } else {
        startInlineVariableEdit(this);
    }
});

// Double-click on custom USP item to enter edit mode
$(document).on('dblclick', '.custom-usp-item', function(e) {
    e.stopPropagation();
    enterCustomUspEditMode(this);
});

// Click outside to exit edit mode (both predefined and custom USPs)
$(document).on('click', function(e) {
    // Exit predefined USP edit modes
    if (!$(e.target).closest('.usp-display-item').length &&
        !$(e.target).closest('.usp-delete-btn').length) {
        exitAllUspEditModes();
    }
    // Exit custom USP edit modes
    if (!$(e.target).closest('.custom-usp-item').length &&
        !$(e.target).closest('.custom-usp-delete-btn').length) {
        exitAllCustomUspEditModes();
    }
});

// Blur on inline variable input to save
$(document).on('blur', '.inline-usp-variable-input', function() {
    saveInlineVariableEdit($(this));
});

// Enter/Escape on inline variable input
$(document).on('keydown', '.inline-usp-variable-input', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveInlineVariableEdit($(this));
    } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelInlineVariableEdit($(this));
    }
});

// =====================================================
// Event Handlers for MODAL USP Variable Editing (in modal)
// =====================================================

// Click on modal variable span to start editing (not inline)
$(document).on('click', '.usp-variable:not(.inline-usp-variable)', function(e) {
    e.stopPropagation();
    startVariableEdit(this);
});

// Blur on modal variable input to save
$(document).on('blur', '.usp-variable-input:not(.inline-usp-variable-input)', function() {
    saveVariableEdit($(this));
});

// Enter/Escape on modal variable input
$(document).on('keydown', '.usp-variable-input:not(.inline-usp-variable-input)', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveVariableEdit($(this));
    } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelVariableEdit($(this));
    }
});

// =====================================================
// Event Handlers for Custom USP Click-to-Edit (jQuery)
// =====================================================

// Click on custom USP text to edit
$(document).on('click', '.custom-usp-display-text', function() {
    const item = $(this).closest('.modal-custom-usp-item');
    const displayText = item.find('.custom-usp-display-text');
    const editInput = item.find('.custom-usp-edit-input');

    displayText.hide();
    editInput.show().focus().select();
});

// Blur on custom USP input to save
$(document).on('blur', '.custom-usp-edit-input', function() {
    saveCustomUspEdit($(this));
});

// Enter/Escape on custom USP input
$(document).on('keypress', '.custom-usp-edit-input', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveCustomUspEdit($(this));
    }
});

$(document).on('keydown', '.custom-usp-edit-input', function(e) {
    if (e.key === 'Escape') {
        e.preventDefault();
        cancelCustomUspEdit($(this));
    }
});

// Save custom USP edit
function saveCustomUspEdit($input) {
    const item = $input.closest('.modal-custom-usp-item');
    const displayText = item.find('.custom-usp-display-text');
    const index = parseInt($input.data('index'));
    const newValue = $input.val().trim();

    if (newValue && newValue !== modalCustomUsps[index]) {
        modalCustomUsps[index] = newValue;
        displayText.text(newValue);
    }

    $input.hide();
    displayText.show();
}

// Cancel custom USP edit
function cancelCustomUspEdit($input) {
    const item = $input.closest('.modal-custom-usp-item');
    const displayText = item.find('.custom-usp-display-text');
    const index = parseInt($input.data('index'));

    $input.val(modalCustomUsps[index]);
    $input.hide();
    displayText.show();
}

async function saveUspSelection() {
    // Get selected USP IDs from checkboxes
    const selectedIds = [];
    document.querySelectorAll('.modal-usp-checkbox:checked').forEach(checkbox => {
        selectedIds.push(parseInt(checkbox.dataset.uspId));
    });

    try {
        const response = await fetch(`/ajax/client/${clientId}/update-company-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                usp_ids: selectedIds,
                custom_usps: modalCustomUsps,
                usp_variable_values: modalUspVariableValues,
                usp_custom_texts: modalUspCustomTexts
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update the display on the page
            updatePredefinedUspsDisplay(selectedIds);
            updateCustomUspsDisplay(modalCustomUsps);

            // Update initial values for next modal open
            initialUspIds.length = 0;
            initialUspIds.push(...selectedIds);

            closeUspModal();
            showToast('USP\'er gemt');

            // Reload page to get fresh data with resolved variable values
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('Fejl: ' + (data.error || 'Kunne ikke gemme'), 'error');
        }
    } catch (error) {
        console.error('Error saving USPs:', error);
        showToast('Fejl ved gem af USP\'er', 'error');
    }
}

function updatePredefinedUspsDisplay(uspIds) {
    const listEl = document.getElementById('predefined-usps-list');
    const emptyEl = document.getElementById('predefined-usps-empty');
    const countEl = document.getElementById('predefined-usps-count');
    const viewEl = document.getElementById('predefined-usps-view');

    // Update count
    if (countEl) {
        countEl.textContent = uspIds.length;
    }

    // We'll reload the page to get fresh rendered USPs with variable substitution
    // For now just update the count
}

function updateCustomUspsDisplay(customUsps) {
    const listEl = document.getElementById('custom-usps-list');
    const emptyEl = document.getElementById('custom-usps-empty');
    const countEl = document.getElementById('custom-usps-count');
    const viewEl = document.getElementById('custom-usps-view-mode');

    // Update count
    if (countEl) {
        countEl.textContent = customUsps.length;
    }

    // Update list
    if (customUsps.length > 0) {
        let html = '';
        customUsps.forEach(usp => {
            html += `<div class="bg-white rounded-lg p-3 border border-gray-200 text-gray-700 hover:border-blue-300 hover:bg-blue-50 transition-colors">${escapeHtml(usp)}</div>`;
        });

        if (listEl) {
            listEl.innerHTML = html;
            listEl.classList.remove('hidden');
        }
        if (emptyEl) emptyEl.classList.add('hidden');
    } else {
        if (listEl) listEl.classList.add('hidden');
        if (emptyEl) emptyEl.classList.remove('hidden');
    }
}

// =====================================================

function editClient() {
    window.location.href = `/clients/?edit=${clientId}`;
}

function openGeoModal() {
    document.getElementById('geo-modal').classList.remove('hidden');

    // Initialize geoSelectedPostals from saved data (only on first open)
    if (Object.keys(geoSelectedPostals).length === 0 && savedPostalCodes.length > 0) {
        savedPostalCodes.forEach(function(code) {
            geoSelectedPostals[code] = { source: 'saved' };
        });
    }

    populateCityList('all');
    setTimeout(() => {
        initGeoModal().then(function() {
            if (geoMap) {
                geoMap.invalidateSize();
                // Update polygon styles for saved selections
                savedPostalCodes.forEach(function(code) {
                    var postal = geoPostalData[code];
                    if (postal && postal.polygon) {
                        postal.polygon.setStyle(getPolygonStyle(code, false));
                    }
                });
            }
        });
    }, 100);
}

function closeGeoModal() {
    document.getElementById('geo-modal').classList.add('hidden');
}

function populateCityList(filter) {
    const container = document.getElementById('city-list');
    const searchQuery = document.getElementById('city-search').value.toLowerCase();

    // Include cities that are either from geographic_regions (isSelected) OR manually selected (geoSelectedPostals)
    let cities = allCities.filter(c => c.isSelected || geoSelectedPostals[c.postalCode]);

    if (filter === 'created') {
        cities = cities.filter(c => c.isCreated);
    } else if (filter === 'missing') {
        cities = cities.filter(c => !c.isCreated);
    }

    if (searchQuery) {
        cities = cities.filter(c =>
            c.name.toLowerCase().includes(searchQuery) ||
            c.region.toLowerCase().includes(searchQuery) ||
            c.postalCode.includes(searchQuery)
        );
    }

    container.innerHTML = cities.map(city => {
        const showPostalCode = city.postalCode && city.postalCode !== 'MULTI';
        return `
        <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="focusCity('${city.postalCode}')">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full flex-shrink-0 ${city.isCreated ? 'bg-green-500' : 'bg-gray-300'}"></span>
                    <div class="font-medium text-gray-900">${city.name}</div>
                </div>
                ${showPostalCode ? `<span class="text-sm text-gray-500">${city.postalCode}</span>` : ''}
            </div>
        </div>
    `}).join('');

    if (cities.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Ingen byer fundet</p>';
    }
}

function filterCities(filter) {
    document.querySelectorAll('.city-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-gray-100');
    });
    document.querySelector(`.city-filter-btn[data-filter="${filter}"]`).classList.add('active', 'bg-gray-100');
    populateCityList(filter);
}

function focusCity(postalCode) {
    var postal = geoPostalData[postalCode];
    if (postal && postal.polygon && geoMap) {
        geoMap.fitBounds(postal.polygon.getBounds(), { maxZoom: 12 });

        // Highlight the polygon briefly
        postal.polygon.setStyle(getPolygonStyle(postalCode, true));
        setTimeout(function() {
            postal.polygon.setStyle(getPolygonStyle(postalCode, false));
        }, 2000);
    } else {
        // Fallback to city coordinates
        var city = allCities.find(c => c.postalCode === postalCode);
        if (city && geoMap) {
            geoMap.setView([parseFloat(city.lat), parseFloat(city.lng)], 12);
        }
    }
}

// =====================================================
// EVENT HANDLERS
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    // Initialize inline USP variable editing and IDs
    initializeInlineUspVariables();
    initializeInlineUspIds();

    const searchInput = document.getElementById('city-search');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const activeFilter = document.querySelector('.city-filter-btn.active').dataset.filter;
            populateCityList(activeFilter);
        });
    }

    // Postal code input
    $('#geo-add-postal-btn').click(function() {
        addPostalCodesFromInput();
    });

    $('#geo-postal-input').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            addPostalCodesFromInput();
        }
    });

    // Clear selections
    $('#clear-geo-selections-btn').click(function() {
        clearAllGeoSelections();
    });

    // Pre-load DAWA data in background
    setTimeout(function() {
        loadDAWAGeoJSON().then(function() {
            console.log('DAWA GeoJSON pre-loaded successfully');
        }).catch(function(err) {
            console.warn('DAWA pre-load failed:', err.message);
        });
    }, 1500);
});
</script>

<style>
.section-tab.active {
    color: #9333ea;
    border-color: #9333ea;
}
</style>

{% endblock %}
