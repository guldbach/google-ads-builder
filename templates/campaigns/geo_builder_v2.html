{% extends 'base.html' %}

{% block title %}Geografisk Kampagne Builder - Multi-Step v1.1{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto section-spacing container-padding">
    <!-- Hero Section with Asana-style gradient -->
    <div class="text-center mb-16 p-12 bg-gradient-to-br from-pink-100 via-blue-50 to-purple-100 rounded-3xl">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
        </div>
        <h1 class="text-6xl font-bold text-gray-900 mb-6 tracking-tight">
            Geografisk Kampagne Builder
        </h1>
        <p class="text-2xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
            Opret intelligente geo-kampagner der konverterer i alle danske byer
        </p>
    </div>

    <!-- Modern Progress Section -->
    <div class="bg-white rounded-3xl shadow-xl p-8 mb-12 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-6">
                <div class="step-indicator bg-gradient-to-r from-purple-600 to-pink-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center text-lg font-bold shadow-lg">1</div>
                <div class="flex flex-col">
                    <span class="text-lg font-semibold text-gray-900">Kampagne Setup</span>
                    <span class="text-sm text-gray-500">Grundl√¶ggende indstillinger</span>
                </div>
            </div>
            <div class="flex-1 h-2 mx-8 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full progress-bar transition-all duration-500" style="width: 33%"></div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="step-indicator bg-gray-200 text-gray-600 w-12 h-12 rounded-2xl flex items-center justify-center text-lg font-bold">2</div>
                <div class="flex flex-col">
                    <span class="text-lg font-semibold text-gray-900">Geografi</span>
                    <span class="text-sm text-gray-500">V√¶lg omr√•der</span>
                </div>
            </div>
            <div class="flex-1 h-2 mx-8 bg-gray-200 rounded-full"></div>
            <div class="flex items-center space-x-6">
                <div class="step-indicator bg-gray-200 text-gray-600 w-12 h-12 rounded-2xl flex items-center justify-center text-lg font-bold">3</div>
                <div class="flex flex-col">
                    <span class="text-lg font-semibold text-gray-900">USPs</span>
                    <span class="text-sm text-gray-500">V√¶lg styrker</span>
                </div>
            </div>
            <div class="flex-1 h-2 mx-8 bg-gray-200 rounded-full"></div>
            <div class="flex items-center space-x-6">
                <div class="step-indicator bg-gray-200 text-gray-600 w-12 h-12 rounded-2xl flex items-center justify-center text-lg font-bold">4</div>
                <div class="flex flex-col">
                    <span class="text-lg font-semibold text-gray-900">Annoncer</span>
                    <span class="text-sm text-gray-500">Tekst og CTAs</span>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="multiStepForm">
        {% csrf_token %}
        
        <!-- Step 1: Campaign Settings -->
        <div id="step-1" class="form-step active">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-3xl p-8 mb-6 border border-blue-100">
                <div class="flex items-center mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-2xl shadow-lg mr-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Kampagne Indstillinger</h2>
                        <p class="text-lg text-gray-600">Konfigurer din kampagne med de rigtige parametre</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Basic Campaign Settings -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <div class="flex items-center mb-6">
                            <div class="bg-gradient-to-r from-green-500 to-emerald-500 p-3 rounded-xl shadow-md mr-4">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">Grundl√¶ggende Info</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="label">Firmanavn *</label>
                                <input type="text" name="client_name" required 
                                       class="input-field"
                                       placeholder="f.eks. Hansen VVS">
                            </div>
                            
                            <div>
                                <label class="label">Service Type *</label>
                                <input type="text" name="service_name" id="service_name" required 
                                       class="input-field"
                                       placeholder="f.eks. Fugemand, Murer, VVS">
                            </div>
                            
                            <div>
                                <label class="label">Hjemmeside *</label>
                                <input type="url" name="website_url" required 
                                       class="input-field"
                                       placeholder="https://www.eksempel.dk">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dom√¶ne (til landing pages)</label>
                                <input type="text" name="domain" id="domain"
                                       class="input-field"
                                       placeholder="f.eks. lundsfugeservice.dk">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Branche</label>
                                <select name="industry" required 
                                        class="input-field">
                                    <option value="">V√¶lg branche</option>
                                    {% for industry in industries %}
                                    <option value="{{ industry.id }}">{{ industry.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Campaign Settings -->
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <div class="flex items-center mb-6">
                            <div class="bg-gradient-to-r from-purple-500 to-indigo-500 p-3 rounded-xl shadow-md mr-4">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">Avancerede Indstillinger</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Budget (DKK/dag)</label>
                                    <input type="number" name="budget_daily" value="500" min="50" max="50000"
                                           class="input-field"
                                           placeholder="500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Budget Type</label>
                                    <select name="budget_type" 
                                            class="input-field">
                                        <option value="daily">Dagligt Budget</option>
                                        <option value="total">Total Kampagne</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ad Rotation</label>
                                <select name="ad_rotation" 
                                        class="input-field">
                                    <option value="optimize">Optimize (Anbefalet)</option>
                                    <option value="rotate_evenly">Rotate Evenly</option>
                                    <option value="rotate_indefinitely">Rotate Indefinitely</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategy</label>
                                <select name="bidding_strategy" id="bidding_strategy"
                                        class="input-field">
                                    <option value="enhanced_cpc">Enhanced CPC (Anbefalet)</option>
                                    <option value="manual_cpc">Manual CPC</option>
                                    <option value="target_cpa">Target CPA</option>
                                    <option value="maximize_clicks">Maximize Clicks</option>
                                    <option value="target_roas">Target ROAS</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Bid (DKK)</label>
                                <input type="number" name="default_bid" value="15.00" min="1" max="500" step="0.50"
                                       class="input-field"
                                       placeholder="15.00">
                            </div>
                            
                            <!-- Conditional fields for specific bidding strategies -->
                            <div id="target_cpa_field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                                <input type="number" name="target_cpa" min="1" max="10000" step="1"
                                       class="input-field"
                                       placeholder="250">
                            </div>
                            
                            <div id="target_roas_field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Target ROAS (%)</label>
                                <input type="number" name="target_roas" min="100" max="2000" step="10"
                                       class="input-field"
                                       placeholder="300">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Default Match Type</label>
                                <select name="default_match_type" 
                                        class="input-field">
                                    <option value="phrase">Phrase Match (Anbefalet)</option>
                                    <option value="exact">Exact Match</option>
                                    <option value="broad">Broad Match</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Geography Selection -->
        <div id="step-2" class="form-step">
            <div class="bg-gradient-to-r from-emerald-50 to-cyan-50 rounded-3xl p-8 mb-6 border border-emerald-100">
                <div class="flex items-center mb-8">
                    <div class="bg-gradient-to-r from-emerald-600 to-cyan-600 p-4 rounded-2xl shadow-lg mr-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Geografisk Targeting</h2>
                        <p class="text-lg text-gray-600">V√¶lg de byer hvor din kampagne skal k√∏re</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                        <div class="flex items-center mb-4">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-2 rounded-lg shadow-md mr-3">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900">Interaktivt Danmarkskort</h3>
                        </div>
                        <!-- Map Container -->
                        <div id="map" style="height: 500px; width: 100%;" class="rounded-xl border-2 border-gray-200 mb-4 overflow-hidden shadow-inner"></div>
                        
                        <!-- Map Instructions -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-center mb-3">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 p-2 rounded-lg shadow-md mr-3">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                </div>
                                <h3 class="font-bold text-blue-900">S√•dan bruger du kortet</h3>
                            </div>
                            <ul class="text-sm text-blue-800 space-y-2">
                                <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span><strong>Klik</strong> p√• kortet for at oprette ny cirkel</li>
                                <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span><strong>Klik</strong> p√• cirkel for at slette den</li>
                                <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span><strong>Tr√¶k</strong> cirkler for at flytte dem</li>
                                <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span><strong>Juster</strong> radius med de sm√• h√•ndtag</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Selected Cities -->
                        <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-r from-emerald-500 to-green-500 p-2 rounded-lg shadow-md mr-3">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-gray-900">Valgte Byer</h4>
                            </div>
                            <label class="label">Aktive omr√•der <span class="text-red-500">*</span></label>
                            <textarea id="cities" readonly class="input-field h-32 bg-gray-50 text-sm font-mono"
                                      placeholder="Klik p√• kortet for at v√¶lge byer..."></textarea>
                            <p class="text-xs text-gray-500 mt-2">Automatisk opdateret n√•r du tegner p√• kortet</p>
                            <div id="cities-validation-message" class="text-sm text-red-600 mt-2 p-2 bg-red-50 rounded-lg" style="display: none;">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    V√¶lg mindst √©t omr√•de f√∏r du forts√¶tter
                                </span>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 border border-purple-100">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-2 rounded-lg shadow-md mr-3">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-gray-900">Live Statistikker</h4>
                            </div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm">
                                    <span class="text-gray-600 font-medium">Valgte Byer</span>
                                    <span id="cities-count" class="text-2xl font-bold text-purple-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm">
                                    <span class="text-gray-600 font-medium">Estimerede Keywords</span>
                                    <span id="estimated-keywords" class="text-2xl font-bold text-emerald-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-sm">
                                    <span class="text-gray-600 font-medium">Landing Pages</span>
                                    <span id="estimated-pages" class="text-2xl font-bold text-blue-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="selected_cities" id="selected_cities" required>
            </div>
        </div>

        <!-- Step 3: USP Selection -->
        <div id="step-3" class="form-step">
            <div class="card p-8 mb-6">
                <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i data-lucide="star" class="w-6 h-6 mr-2 text-yellow-600"></i>
                    Step 3: V√¶lg Dine USPs
                </h2>
                
                <div class="mb-6">
                    <p class="text-gray-600 mb-4">
                        V√¶lg 1 USP fra hver kategori for at skabe en komplet og overbevisende kampagne.
                        De er sorteret med den bedste √∏verst.
                    </p>
                    
                    <!-- USP Completion Progress -->
                    <div class="bg-gray-100 rounded-2xl p-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">USP Kategorier Fuldf√∏rt</span>
                            <span id="usp-progress-text" class="text-sm text-gray-600">0 af 5</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="usp-progress-bar" class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- USP Categories Grid -->
                <div id="usp-categories" class="space-y-6">
                    {% for category in usp_categories %}
                    <div class="usp-category-card bg-white border border-gray-200 rounded-2xl p-6 transition-all duration-200 hover:shadow-lg" 
                         data-category-id="{{ category.id }}">
                        <!-- Category Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center justify-center w-10 h-10 rounded-xl" 
                                     style="background-color: {{ category.color }}20; color: {{ category.color }};">
                                    <span class="text-2xl">{{ category.icon }}</span>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">{{ category.name }}</h3>
                                    <p class="text-sm text-gray-600">V√¶lg {{ category.max_selections }} USP{% if category.max_selections > 1 %}s{% endif %}</p>
                                </div>
                            </div>
                            <div class="category-completion hidden">
                                <span class="text-sm font-medium text-green-600">‚úì Valgt</span>
                            </div>
                        </div>
                        
                        <!-- Category Description -->
                        <p class="text-sm text-gray-600 mb-4">{{ category.description }}</p>
                        
                        <!-- USP Options -->
                        <div class="usp-options space-y-2">
                            {% for usp in usp_templates %}
                                {% if usp.main_category.id == category.id %}
                                <div class="usp-option p-3 border border-gray-100 rounded-xl cursor-pointer hover:border-gray-300 transition-all duration-200"
                                     data-usp-id="{{ usp.id }}"
                                     data-category-id="{{ category.id }}"
                                     data-priority="{{ usp.priority_rank }}">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="inline-flex items-center justify-center w-6 h-6 text-xs font-bold text-white rounded-full"
                                                      style="background-color: {{ category.color }};">
                                                    {{ usp.priority_rank }}
                                                </span>
                                                <span class="text-sm font-medium text-gray-900">{{ usp.text }}</span>
                                            </div>
                                            {% if usp.explanation %}
                                            <p class="text-xs text-gray-500 mt-1">{{ usp.explanation }}</p>
                                            {% endif %}
                                            {% if usp.ideal_for_industries.all %}
                                            <div class="flex flex-wrap gap-1 mt-2">
                                                {% for industry in usp.ideal_for_industries.all %}
                                                <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-md">
                                                    {{ industry.name }}
                                                </span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="usp-selection-indicator hidden">
                                            <span class="text-green-600">‚úì</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Hidden field to store selected USPs -->
                <input type="hidden" name="selected_usps" id="selected_usps">
            </div>
        </div>

        <!-- Step 4: Headlines & Descriptions -->
        <div id="step-4" class="form-step">
            <div class="card p-8 mb-6">
                <h2 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i data-lucide="edit-3" class="w-6 h-6 mr-2 text-blue-600"></i>
                    Step 4: Headlines og Beskrivelser
                </h2>
                
                <!-- Auto-Progressive Headlines and Descriptions -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Headlines - Auto-reveal 1-15 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                            üìù Headlines (max 30 karakterer)
                            <span id="headlines-progress" class="text-sm text-gray-500">1 af 15</span>
                        </h3>
                        <div id="headlines-container" class="space-y-4">
                            <!-- Headline 1 - Always visible -->
                            <div id="headline_1_container" class="headline-field">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Headline 1 *
                                    <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                                </label>
                                <input type="text" name="headline_1_template" id="headline_1" 
                                       value="{SERVICE} {BYNAVN}" maxlength="30" required
                                       class="input-field">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_1_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <!-- Headlines 2-15 - Auto-reveal -->
                            <div id="headline_2_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 2</label>
                                <input type="text" name="headline_2_template" id="headline_2" 
                                       placeholder="5/5 Stjerner Trustpilot" maxlength="30"
                                       class="input-field">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_2_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_3_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 3</label>
                                <input type="text" name="headline_3_template" id="headline_3" 
                                       placeholder="Ring i dag - Gratis tilbud" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_3_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_4_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 4</label>
                                <input type="text" name="headline_4_template" id="headline_4" 
                                       placeholder="Eksperter i {BYNAVN}" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_4_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_5_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 5</label>
                                <input type="text" name="headline_5_template" id="headline_5" 
                                       placeholder="Hurtig og professionel" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_5_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_6_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 6</label>
                                <input type="text" name="headline_6_template" id="headline_6" 
                                       placeholder="√Öbent 24/7" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_6_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_7_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 7</label>
                                <input type="text" name="headline_7_template" id="headline_7" 
                                       placeholder="Lokal {SERVICE} specialist" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_7_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_8_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 8</label>
                                <input type="text" name="headline_8_template" id="headline_8" 
                                       placeholder="Bedste pris i {BYNAVN}" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_8_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_9_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 9</label>
                                <input type="text" name="headline_9_template" id="headline_9" 
                                       placeholder="Garanti p√• alt arbejde" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_9_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_10_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 10</label>
                                <input type="text" name="headline_10_template" id="headline_10" 
                                       placeholder="+20 √•rs erfaring" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_10_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_11_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 11</label>
                                <input type="text" name="headline_11_template" id="headline_11" 
                                       placeholder="Gratis konsultation" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_11_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_12_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 12</label>
                                <input type="text" name="headline_12_template" id="headline_12" 
                                       placeholder="Samme dag service" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_12_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_13_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 13</label>
                                <input type="text" name="headline_13_template" id="headline_13" 
                                       placeholder="Milj√∏venlig {SERVICE}" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_13_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_14_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 14</label>
                                <input type="text" name="headline_14_template" id="headline_14" 
                                       placeholder="Certificeret specialist" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_14_count">0</span>/30 karakterer
                                </div>
                            </div>
                            
                            <div id="headline_15_container" class="headline-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Headline 15</label>
                                <input type="text" name="headline_15_template" id="headline_15" 
                                       placeholder="Kontakt os i dag!" maxlength="30"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="headline_15_count">0</span>/30 karakterer
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descriptions - Auto-reveal 1-4 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                            üìÑ Beskrivelser (max 90 karakterer)
                            <span id="descriptions-progress" class="text-sm text-gray-500">1 af 4</span>
                        </h3>
                        <div id="descriptions-container" class="space-y-4">
                            <!-- Description 1 - Always visible -->
                            <div id="description_1_container" class="description-field">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Beskrivelse 1 *
                                    <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                                </label>
                                <textarea name="description_1_template" id="description_1" rows="3" maxlength="90" required
                                          class="input-field"
                                          placeholder="Professionel {SERVICE} i {BYNAVN} - Ring i dag for gratis tilbud!"></textarea>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="description_1_count">0</span>/90 karakterer
                                </div>
                            </div>
                            
                            <!-- Descriptions 2-4 - Auto-reveal -->
                            <div id="description_2_container" class="description-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Beskrivelse 2
                                    <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                                </label>
                                <textarea name="description_2_template" id="description_2" rows="3" maxlength="90"
                                          placeholder="Erfaren {SERVICE} med 5/5 stjerner. Vi d√¶kker {BYNAVN} og omegn."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="description_2_count">0</span>/90 karakterer
                                </div>
                            </div>
                            
                            <div id="description_3_container" class="description-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Beskrivelse 3
                                    <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                                </label>
                                <textarea name="description_3_template" id="description_3" rows="3" maxlength="90"
                                          placeholder="Hurtig og p√•lidelig service i {BYNAVN}. Kontakt os for personlig betjening."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="description_3_count">0</span>/90 karakterer
                                </div>
                            </div>
                            
                            <div id="description_4_container" class="description-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Beskrivelse 4
                                    <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                                </label>
                                <textarea name="description_4_template" id="description_4" rows="3" maxlength="90"
                                          placeholder="Certificeret {SERVICE} virksomhed. Milj√∏venlig og b√¶redygtig l√∏sning til {BYNAVN}."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span id="description_4_count">0</span>/90 karakterer
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Meta Templates -->
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç SEO Meta Templates</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Meta Titel Template
                                <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                            </label>
                            <input type="text" name="meta_title_template" 
                                   value="{SERVICE} {BYNAVN} - 5/5 Stjerner p√• Trustpilot - Ring idag"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Meta Beskrivelse Template
                                <span class="text-xs text-gray-500">(Brug {SERVICE} og {BYNAVN})</span>
                            </label>
                            <textarea name="meta_description_template" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">Skal du bruge en dygtig {SERVICE} i {BYNAVN}, vi har hj√¶lpet mere end 500 kunder. Kontakt os idag, vi k√∏re dagligt i {BYNAVN}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Live Preview -->
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üëÅÔ∏è Live Preview</h3>
                    <div id="preview-section" class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm text-gray-500">Udfyld templates og v√¶lg byer for at se preview...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
            <div class="flex justify-between items-center">
                <button type="button" id="prev-btn" onclick="previousStep()" 
                        class="bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 font-semibold py-4 px-8 rounded-2xl transition-all duration-200 flex items-center space-x-3 shadow-lg"
                        style="display: none;">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    <span>Forrige Trin</span>
                </button>
                
                <div class="text-center bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-3 rounded-2xl border border-purple-100">
                    <span id="step-info" class="text-lg font-semibold text-gray-700">Trin 1 af 3</span>
                </div>
                
                <button type="button" id="next-btn" onclick="nextStep()" 
                        class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-semibold py-4 px-8 rounded-2xl transition-all duration-200 flex items-center space-x-3 shadow-lg">
                    <span>N√¶ste Trin</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 11h12.17l-5.59-5.59L12 4l8 8-8 8-1.41-1.41L16.17 13H4v-2z"/>
                    </svg>
                </button>
                
                <button type="submit" id="submit-btn" 
                        class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-semibold py-4 px-8 rounded-2xl transition-all duration-200 flex items-center space-x-3 shadow-lg"
                        style="display: none;">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                    </svg>
                    <span>Generer Kampagne</span>
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    /* Auto-reveal animations */
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .headline-field, .description-field {
        transition: all 0.3s ease-in-out;
    }
</style>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script>
    let currentStep = 1;
    const totalSteps = 4;
    
    // USP Selection Management
    let selectedUSPs = {}

    // Make currentStep globally accessible
    window.currentStep = currentStep;

    // Multi-step navigation - FORCE OVERRIDE GLOBALLY
    function showStep(stepNumber) {
        // ALWAYS LOG THIS FIRST
        console.log('üéØüéØüéØ OVERRIDE showStep called with:', stepNumber);
        
        // Update current step IMMEDIATELY
        currentStep = stepNumber;
        window.currentStep = currentStep;
        console.log('üìçüìçüìç IMMEDIATELY updated currentStep to:', currentStep);
        
        // Basic step switching
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });
        
        const targetStep = document.getElementById('step-' + stepNumber);
        if (targetStep) {
            targetStep.classList.add('active');
            console.log('‚úÖ‚úÖ‚úÖ Activated step element:', 'step-' + stepNumber);
        } else {
            console.error('‚ùå‚ùå‚ùå Step element NOT FOUND:', 'step-' + stepNumber);
        }
        
        console.log('üèÅüèÅüèÅ showStep FINISHED for step:', stepNumber, 'currentStep now:', currentStep);
    }
    
    // FORCE GLOBAL OVERRIDE
    window.showStep = showStep;
    
    // Test that our function is actually accessible
    console.log('üîß showStep function test:', typeof showStep, typeof window.showStep);

    function nextStep() {
        console.log('üöÄ nextStep called - currentStep:', currentStep);
        const isValid = validateCurrentStep();
        console.log('‚úÖ Validation result:', isValid);
        
        if (isValid && currentStep < totalSteps) {
            console.log('üëâ Moving to step:', currentStep + 1);
            try {
                showStep(currentStep + 1);
                console.log('‚úÖ showStep call completed');
            } catch (error) {
                console.error('‚ùå Error calling showStep:', error);
            }
        } else {
            console.log('‚ùå Cannot proceed - valid:', isValid, 'currentStep:', currentStep, 'totalSteps:', totalSteps);
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }

    function validateCurrentStep() {
        console.log('üîç validateCurrentStep called for step:', currentStep);
        
        const currentStepElement = document.getElementById('step-' + currentStep);
        if (!currentStepElement) {
            console.log('‚ùå Step element not found:', 'step-' + currentStep);
            return false;
        }
        
        const requiredFields = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
        console.log('üìã Found required fields:', requiredFields.length);
        
        for (let field of requiredFields) {
            console.log('üîç Checking field:', field.id, 'value:', `"${field.value}"`);
            
            if (!field.value.trim()) {
                console.log('‚ùå Field validation failed:', field.id);
                field.focus();
                field.classList.add('border-red-500');
                
                // Special message for cities selection
                if (field.id === 'selected_cities') {
                    console.log('üèôÔ∏è Cities field is empty, showing alert');
                    alert('V√¶lg venligst mindst √©n by p√• kortet f√∏r du forts√¶tter.');
                    return false;
                }
                return false;
            }
            field.classList.remove('border-red-500');
        }
        
        // Extra validation for step 2 (geography)
        if (currentStep === 2) {
            console.log('üó∫Ô∏è Performing Step 2 geography validation');
            const selectedCities = document.getElementById('selected_cities').value;
            const validationMessage = document.getElementById('cities-validation-message');
            
            console.log('üèôÔ∏è Selected cities value:', `"${selectedCities}"`);
            console.log('üìç Validation message element found:', !!validationMessage);
            
            if (!selectedCities || selectedCities.trim() === '') {
                console.log('‚ùå No cities selected - showing validation message');
                if (validationMessage) {
                    validationMessage.style.display = 'block';
                }
                document.getElementById('cities').classList.add('border-red-500');
                return false;
            } else {
                console.log('‚úÖ Cities validation passed');
                if (validationMessage) {
                    validationMessage.style.display = 'none';
                }
                document.getElementById('cities').classList.remove('border-red-500');
            }
        }
        
        console.log('‚úÖ All validation passed for step:', currentStep);
        return true;
    }

    // Character counting for headlines and descriptions
    function updateCharacterCount(inputId, countId, maxLength) {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(countId);
        
        if (input && counter) {
            const currentLength = input.value.length;
            counter.textContent = currentLength;
            
            // Color coding
            if (currentLength > maxLength) {
                counter.parentElement.classList.add('text-red-500');
                counter.parentElement.classList.remove('text-gray-500', 'text-yellow-500');
            } else if (currentLength > maxLength * 0.8) {
                counter.parentElement.classList.add('text-yellow-500');
                counter.parentElement.classList.remove('text-gray-500', 'text-red-500');
            } else {
                counter.parentElement.classList.add('text-gray-500');
                counter.parentElement.classList.remove('text-yellow-500', 'text-red-500');
            }
        }
    }

    // Auto-reveal system for headlines and descriptions
    let visibleHeadlines = 1; // Start with headline 1 visible
    let visibleDescriptions = 1; // Start with description 1 visible
    
    function setupAutoRevealHeadlines() {
        console.log('üéØ Setting up auto-reveal for headlines');
        
        // Setup input event listeners for all headlines 1-15
        for (let i = 1; i <= 15; i++) {
            const input = document.getElementById(`headline_${i}`);
            if (input) {
                input.addEventListener('input', function() {
                    revealNextHeadline(i);
                    updateHeadlineProgress();
                    updateCharacterCount(`headline_${i}`, `headline_${i}_count`, 30);
                });
            }
        }
        updateHeadlineProgress();
    }
    
    function setupAutoRevealDescriptions() {
        console.log('üìÑ Setting up auto-reveal for descriptions');
        
        // Setup input event listeners for all descriptions 1-4
        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`description_${i}`);
            if (input) {
                input.addEventListener('input', function() {
                    revealNextDescription(i);
                    updateDescriptionProgress();
                    updateCharacterCount(`description_${i}`, `description_${i}_count`, 90);
                });
            }
        }
        updateDescriptionProgress();
    }
    
    // USP Selection Functions
    function setupUSPSelection() {
        console.log('‚≠ê Setting up USP selection handlers');
        
        // Handle USP option clicks
        $(document).on('click', '.usp-option', function() {
            const $option = $(this);
            const uspId = $option.data('usp-id');
            const categoryId = $option.data('category-id');
            const priority = $option.data('priority');
            
            // Toggle selection
            if ($option.hasClass('selected')) {
                // Deselect
                delete selectedUSPs[categoryId];
                $option.removeClass('selected border-green-500 bg-green-50');
                $option.find('.usp-selection-indicator').addClass('hidden');
            } else {
                // Select this USP (and deselect others in same category)
                $(`.usp-option[data-category-id="${categoryId}"]`).each(function() {
                    $(this).removeClass('selected border-green-500 bg-green-50');
                    $(this).find('.usp-selection-indicator').addClass('hidden');
                });
                
                // Select this one
                selectedUSPs[categoryId] = uspId;
                $option.addClass('selected border-green-500 bg-green-50');
                $option.find('.usp-selection-indicator').removeClass('hidden');
            }
            
            // Update category completion indicator
            updateCategoryCompletion(categoryId);
            
            // Update overall USP progress
            updateUSPProgress();
            
            // Update hidden field
            updateSelectedUSPsField();
            
            console.log('Selected USPs:', selectedUSPs);
        });
    }
    
    function updateCategoryCompletion(categoryId) {
        const $categoryCard = $(`.usp-category-card[data-category-id="${categoryId}"]`);
        const $completion = $categoryCard.find('.category-completion');
        
        if (selectedUSPs[categoryId]) {
            $completion.removeClass('hidden');
            $categoryCard.addClass('border-green-200 bg-green-25');
        } else {
            $completion.addClass('hidden');
            $categoryCard.removeClass('border-green-200 bg-green-25');
        }
    }
    
    function updateUSPProgress() {
        const totalCategories = {{ usp_categories.count }};
        const completedCategories = Object.keys(selectedUSPs).length;
        const progressPercent = (completedCategories / totalCategories) * 100;
        
        // Update progress bar
        $('#usp-progress-bar').css('width', progressPercent + '%');
        $('#usp-progress-text').text(`${completedCategories} af ${totalCategories}`);
        
        console.log(`USP Progress: ${completedCategories}/${totalCategories} (${progressPercent}%)`);
    }
    
    function updateSelectedUSPsField() {
        const uspIds = Object.values(selectedUSPs);
        $('#selected_usps').val(uspIds.join(','));
    }
    
    function setupCharacterCounters() {
        console.log('üî¢ Setting up character counters for all fields');
        
        // Setup character counting for all headlines
        for (let i = 1; i <= 15; i++) {
            const input = document.getElementById(`headline_${i}`);
            if (input) {
                updateCharacterCount(`headline_${i}`, `headline_${i}_count`, 30);
            }
        }
        
        // Setup character counting for all descriptions
        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`description_${i}`);
            if (input) {
                updateCharacterCount(`description_${i}`, `description_${i}_count`, 90);
            }
        }
    }
    
    function revealNextHeadline(currentIndex) {
        // If user is typing in current visible headline and there are more to reveal
        const input = document.getElementById(`headline_${currentIndex}`);
        if (input && input.value.length > 0 && currentIndex >= visibleHeadlines && visibleHeadlines < 15) {
            const nextIndex = visibleHeadlines + 1;
            const nextContainer = document.getElementById(`headline_${nextIndex}_container`);
            
            if (nextContainer) {
                console.log(`üéØ Auto-revealing headline ${nextIndex}`);
                nextContainer.style.display = 'block';
                nextContainer.classList.add('animate-fade-in');
                visibleHeadlines = nextIndex;
                
                // Setup event listener for the newly revealed field
                const nextInput = document.getElementById(`headline_${nextIndex}`);
                if (nextInput) {
                    updateCharacterCount(`headline_${nextIndex}`, `headline_${nextIndex}_count`, 30);
                }
            }
        }
    }
    
    function revealNextDescription(currentIndex) {
        // If user is typing in current visible description and there are more to reveal
        const input = document.getElementById(`description_${currentIndex}`);
        if (input && input.value.length > 0 && currentIndex >= visibleDescriptions && visibleDescriptions < 4) {
            const nextIndex = visibleDescriptions + 1;
            const nextContainer = document.getElementById(`description_${nextIndex}_container`);
            
            if (nextContainer) {
                console.log(`üìÑ Auto-revealing description ${nextIndex}`);
                nextContainer.style.display = 'block';
                nextContainer.classList.add('animate-fade-in');
                visibleDescriptions = nextIndex;
                
                // Setup event listener for the newly revealed field
                const nextInput = document.getElementById(`description_${nextIndex}`);
                if (nextInput) {
                    updateCharacterCount(`description_${nextIndex}`, `description_${nextIndex}_count`, 90);
                }
            }
        }
    }
    
    function updateHeadlineProgress() {
        const progressElement = document.getElementById('headlines-progress');
        if (progressElement) {
            // Count filled headlines
            let filledCount = 0;
            for (let i = 1; i <= visibleHeadlines; i++) {
                const input = document.getElementById(`headline_${i}`);
                if (input && input.value.trim().length > 0) {
                    filledCount++;
                }
            }
            progressElement.textContent = `${filledCount} af ${visibleHeadlines} udfyldt (max 15)`;
        }
    }
    
    function updateDescriptionProgress() {
        const progressElement = document.getElementById('descriptions-progress');
        if (progressElement) {
            // Count filled descriptions
            let filledCount = 0;
            for (let i = 1; i <= visibleDescriptions; i++) {
                const input = document.getElementById(`description_${i}`);
                if (input && input.value.trim().length > 0) {
                    filledCount++;
                }
            }
            progressElement.textContent = `${filledCount} af ${visibleDescriptions} udfyldt (max 4)`;
        }
    }

    // Bidding strategy conditional fields
    function toggleBiddingFields() {
        const biddingStrategy = document.getElementById('bidding_strategy').value;
        const targetCpaField = document.getElementById('target_cpa_field');
        const targetRoasField = document.getElementById('target_roas_field');
        
        targetCpaField.style.display = biddingStrategy === 'target_cpa' ? 'block' : 'none';
        targetRoasField.style.display = biddingStrategy === 'target_roas' ? 'block' : 'none';
    }

    // Initialize when page loads
    $(document).ready(function() {
        // Initialize icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Auto-reveal Headlines and Descriptions + Character counters
        setupAutoRevealHeadlines();
        setupAutoRevealDescriptions();
        
        // Setup USP Selection
        setupUSPSelection();
        
        // Setup character counters for all potential fields
        setupCharacterCounters();
        
        // Bidding strategy change handler
        document.getElementById('bidding_strategy').addEventListener('change', toggleBiddingFields);
        toggleBiddingFields(); // Initial setup
        
        // Initialize first step
        showStep(1);
        
        // Check if Google Maps failed to load after a delay
        setTimeout(function() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || !map) {
                console.log('Google Maps not available, showing fallback');
                showMapFallback();
            }
        }, 3000);
        
        // OVERRIDE BASE TEMPLATE showStep FUNCTION AFTER DOM LOAD
        // This ensures our version runs after the base template version
        setTimeout(function() {
            console.log('üîß OVERRIDING base template showStep function...');
            
            window.showStep = function(stepNumber) {
                console.log('üéØ FINAL showStep called with:', stepNumber);
                
                // Update current step FIRST
                currentStep = stepNumber;
                window.currentStep = currentStep;
                console.log('üìç Updated currentStep to:', currentStep);
                
                // Hide all steps
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Show current step
                const targetStep = document.getElementById('step-' + stepNumber);
                if (targetStep) {
                    targetStep.classList.add('active');
                    console.log('‚úÖ Activated step:', 'step-' + stepNumber);
                } else {
                    console.error('‚ùå Step element not found:', 'step-' + stepNumber);
                }
                
                // Update progress bar (3 steps, not 4)
                const progress = (stepNumber / totalSteps) * 100;
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                // Update step indicators
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    const stepNum = index + 1;
                    if (stepNum <= stepNumber) {
                        indicator.classList.add('bg-blue-600', 'text-white');
                        indicator.classList.remove('bg-gray-200', 'text-gray-600');
                    } else {
                        indicator.classList.remove('bg-blue-600', 'text-white');
                        indicator.classList.add('bg-gray-200', 'text-gray-600');
                    }
                });
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                const submitBtn = document.getElementById('submit-btn');
                
                if (prevBtn) prevBtn.style.display = stepNumber > 1 ? 'flex' : 'none';
                if (nextBtn) nextBtn.style.display = stepNumber < totalSteps ? 'flex' : 'none';
                if (submitBtn) submitBtn.style.display = stepNumber === totalSteps ? 'flex' : 'none';
                
                // Update step info
                const stepInfo = document.getElementById('step-info');
                if (stepInfo) {
                    stepInfo.textContent = `Trin ${stepNumber} af ${totalSteps}`;
                }
                
                console.log('‚úÖ showStep completed for step:', stepNumber, 'currentStep now:', currentStep);
            };
            
            console.log('‚úÖ showStep function successfully overridden');
        }, 100);
    });

    // Google Maps functionality (adapted from existing geo_builder.html)
    var map;
    var cities;
    var selectedcities = [];
    var d2r = Math.PI / 180;
    
    function deg2rad(x) {
        return x * d2r;
    }

    // Load danske postnumre fra DAWA API
    $.ajax({
        url: 'https://dawa.aws.dk/postnumre/',
        success: function (data) {
            cities = data;
            for (var city of cities) {
                if (city.visueltcenter) {
                    city.lat_rad = deg2rad(city.visueltcenter[1]);
                    city.lng_rad = deg2rad(city.visueltcenter[0]);
                }
            }
            if (typeof map !== 'undefined') {
                select_cities();
            }
        },
        error: function () {
            alert("Fejl ved indl√¶sning af danske postnumre. Pr√∏v igen.");
        },
        timeout: 10000,
        dataType: 'json'
    });

    var circles_def = [
        { lat: 55.610, lng: 12.323, radius: 10.0 },  // vestegnen
        { lat: 55.610, lng: 12.600, radius: 6.0 },   // kastrup
        { lat: 55.670, lng: 12.583, radius: 4.3 }    // kbh
    ];
    var circles = [];
    
    function initMap() {
        try {
            // Check if Google Maps is available
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                throw new Error('Google Maps API not loaded');
            }
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 55.670523, lng: 12.583819 },
                zoom: 10
            });
            console.log('Google Maps initialized successfully');
        } catch (error) {
            console.error('Error initializing Google Maps:', error);
            showMapFallback();
            return;
        }

        // Tilf√∏j standard cirkler
        for (var c of circles_def) {
            add_circle(c.lat, c.lng, c.radius);
        }
        
        // Klik for at tilf√∏je nye cirkler
        map.addListener('click', function (e) {
            add_circle(e.latLng.lat(), e.latLng.lng(), 2);
            select_cities();
        });
        
        select_cities();
    }

    function showMapFallback() {
        console.log('Showing map fallback');
        document.getElementById('map').innerHTML = `
            <div class="flex items-center justify-center h-full bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="text-center p-6">
                    <i data-lucide="map-off" class="w-12 h-12 text-yellow-600 mx-auto mb-4"></i>
                    <h3 class="text-lg font-semibold text-yellow-800 mb-2">Kort ikke tilg√¶ngeligt</h3>
                    <p class="text-yellow-700 mb-4">Google Maps kan ikke indl√¶ses. Indtast byer manuelt nedenfor.</p>
                    <div class="text-left">
                        <label class="block text-sm font-medium text-yellow-800 mb-2">Indtast byer (adskil med komma):</label>
                        <textarea id="manual-cities-input" class="w-full h-32 p-3 border border-yellow-300 rounded-lg text-sm" 
                                  placeholder="K√∏benhavn, Aarhus, Odense, Aalborg, Esbjerg"></textarea>
                        <button type="button" onclick="updateCitiesFromManualInput()" 
                                class="mt-2 w-full btn-orange">
                            Opdater byvalg
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize lucide icons for the fallback
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function updateCitiesFromManualInput() {
        const input = document.getElementById('manual-cities-input').value;
        const cities = input.split(',').map(city => city.trim()).filter(city => city.length > 0);
        
        console.log('Manual cities input:', cities);
        
        if (cities.length === 0) {
            alert('Indtast venligst mindst √©n by');
            return;
        }
        
        // Update the cities display and hidden input
        $('#cities').html(cities.join("\\n"));
        $('#selected_cities').val(cities.join(","));
        
        // Update statistics
        $('#cities-count').text(cities.length);
        $('#estimated-keywords').text(cities.length * 3);
        $('#estimated-pages').text(cities.length);
        
        // Hide validation message if cities are selected
        const validationMessage = document.getElementById('cities-validation-message');
        if (cities.length > 0 && validationMessage) {
            validationMessage.style.display = 'none';
            document.getElementById('cities').classList.remove('border-red-500');
        }
        
        console.log('Updated cities from manual input:', cities.length, 'cities');
    }

    function add_circle(lat, lng, rad) {
        let circle = new google.maps.Circle({
            strokeColor: '#3B82F6',
            strokeOpacity: 0.5,
            strokeWeight: 2,
            fillColor: '#3B82F6',
            fillOpacity: 0.15,
            map: map,
            clickable: true,
            draggable: true,
            editable: true,
            center: { lat: lat, lng: lng },
            radius: rad * 1000
        });
        
        // Klik for at slette cirkel
        google.maps.event.addListener(circle, 'click', function (ev) {
            circle.set('strokeColor', '#EF4444');
            circle.setMap(null);
            circles = circles.filter(c => c !== circle);
            select_cities();
        });
        
        // Drag og radius change events
        google.maps.event.addListener(circle, 'dragend', function () {
            select_cities();
        });
        google.maps.event.addListener(circle, 'radius_changed', function () {
            select_cities();
        });
        
        circles.push(circle);
    }

    function within_circle(c_lat_rad, c_lng_rad, c_radius_km, p_lat_rad, p_lng_rad) {
        return Math.acos(
            Math.sin(p_lat_rad) * Math.sin(c_lat_rad) +
            Math.cos(p_lat_rad) * Math.cos(c_lat_rad) * Math.cos(c_lng_rad - p_lng_rad)
        ) * 6371 < c_radius_km
    }

    function select_cities() {
        if (!cities || cities.length === 0) return;
        
        // Opdater circle data
        for (var circle of circles) {
            if (circle.getMap()) {
                let center = circle.getCenter();
                circle.lat_rad = deg2rad(center.lat());
                circle.lng_rad = deg2rad(center.lng());
                circle.radius_km = circle.getRadius()/1000;
            }
        }
        
        // Find byer inden for cirkler
        selectedcities = jQuery.grep(
            cities,
            function (city, idx) {
                for (var circle of circles) {
                    if (
                        circle.getMap() != null && within_circle(
                            circle.lat_rad,
                            circle.lng_rad,
                            circle.radius_km,
                            city.lat_rad,
                            city.lng_rad
                        )
                    ) return true;
                }
                return false;
            }
        );
        
        // Opret unik liste af bynavne
        var names = [];
        for (var city of selectedcities) {
            names[city.navn] = 1;
        }
        var result = [];
        for (var name in names) result.push(name);
        result.sort();
        
        // Opdater UI
        $('#cities').html(result.join("\n"));
        $('#selected_cities').val(result.join(","));
        
        // Update statistics
        $('#cities-count').text(result.length);
        $('#estimated-keywords').text(result.length * 3); // Roughly 3 keywords per city
        $('#estimated-pages').text(result.length);
        
        // Debug - log the selection
        console.log('Selected cities updated:', result.length, 'cities:', result);
        
        // Hide validation message if cities are selected
        const validationMessage = document.getElementById('cities-validation-message');
        if (result.length > 0 && validationMessage) {
            validationMessage.style.display = 'none';
            document.getElementById('cities').classList.remove('border-red-500');
        }
        
        // Trigger preview update hvis der er data
        updatePreviewIfReady();
    }

    function updatePreviewIfReady() {
        if (currentStep === 3) {
            updatePreview();
        }
    }

    function updatePreview() {
        const serviceName = $('#service_name').val();
        const cities = $('#selected_cities').val();
        const headline1 = $('#headline_1').val();
        const headline2 = $('#headline_2').val();
        const description1 = $('#description_1').val();
        
        if (!serviceName || !cities || !headline1 || !description1) {
            $('#preview-section').html('<p class="text-sm text-gray-500">Udfyld alle felter for at se preview...</p>');
            return;
        }
        
        const cityList = cities.split(',');
        const sampleCity = cityList[0];
        
        if (sampleCity) {
            let previewHTML = '<div class="space-y-4">';
            previewHTML += '<h4 class="font-semibold text-gray-700 mb-2">üìù Preview for ' + sampleCity + ':</h4>';
            
            // Process templates with sample data
            const processedH1 = headline1.replace('{SERVICE}', serviceName).replace('{BYNAVN}', sampleCity);
            const processedH2 = headline2.replace('{SERVICE}', serviceName).replace('{BYNAVN}', sampleCity);
            const processedD1 = description1.replace('{SERVICE}', serviceName).replace('{BYNAVN}', sampleCity);
            
            previewHTML += '<div class="bg-white p-4 rounded border">';
            previewHTML += '<div class="text-blue-600 text-lg font-semibold">' + processedH1 + '</div>';
            previewHTML += '<div class="text-blue-600 text-sm">' + processedH2 + '</div>';
            previewHTML += '<div class="text-gray-700 text-sm mt-2">' + processedD1 + '</div>';
            previewHTML += '</div>';
            
            previewHTML += '<div class="text-sm text-gray-500">+ ' + (cityList.length - 1) + ' andre byer med lignende annoncer</div>';
            previewHTML += '</div>';
            
            $('#preview-section').html(previewHTML);
        }
    }

    // Preview update handlers
    $('#service_name, #headline_1, #headline_2, #headline_3, #description_1, #description_2').on('input', function() {
        clearTimeout(this.previewTimer);
        this.previewTimer = setTimeout(updatePreview, 500);
    });
</script>

<!-- Google Maps API -->
<script async src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>

<style>
/* Form step styling */
.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Map styling */
#map {
    border-radius: 8px;
}

/* Character count styling */
.text-red-500 {
    color: #ef4444;
}
.text-yellow-500 {
    color: #eab308;
}

/* Input validation styling */
.border-red-500 {
    border-color: #ef4444;
}
</style>
{% endblock %}