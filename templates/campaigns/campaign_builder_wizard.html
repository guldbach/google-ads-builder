{% extends 'base.html' %}
{% load json_filters %}

{% block title %}Campaign Builder Wizard | Jarvis 1.0{% endblock %}

{% block content %}

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Include Leaflet for polygon-based geographic visualization -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Turf.js for polygon merging (used for consolidated postal codes like K√∏benhavn) -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<!-- Custom CSS for Multi-Step Wizard -->
<style>

.step-content {
    min-height: 500px;
    transition: opacity 0.3s ease;
}

.wizard-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #f3f4f6;
    transition: all 0.3s ease;
}

.selection-card {
    transition: all 0.2s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.selection-card:hover {
    border-color: #c084fc;
    box-shadow: 0 4px 20px rgba(192, 132, 252, 0.2);
    transform: translateY(-2px);
}

.selection-card.selected {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #8b5cf620, #8b5cf610);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
}

.checkbox-custom {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.statistics-card {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid #e2e8f0;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.progress-bar-container {
    width: 100%;
    height: 6px;
    background-color: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #8b5cf6, #ec4899);
    transition: width 0.5s ease;
    border-radius: 3px;
}

.animate-fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* USP Variable Styling */
.usp-variable {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-variable:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-variable.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-variable-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 50px;
    max-width: 150px;
}
.usp-text-static {
    color: #374151;
}

/* Full-text USP variable (for USPs without variables) */
.usp-full-text {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-full-text:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-full-text.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-full-text-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 100px;
}

/* AI-Suggested USP Styling */
.usp-item.ai-suggested {
    position: relative;
    border-color: #8B5CF6;
    background: linear-gradient(135deg, #8B5CF620, #8B5CF610);
    animation: ai-highlight 0.5s ease-out;
}

.usp-item.ai-suggested::after {
    content: '‚ú® AI';
    position: absolute;
    top: 4px;
    right: 4px;
    background: linear-gradient(135deg, #8B5CF6, #EC4899);
    color: white;
    border-radius: 4px;
    font-size: 10px;
    padding: 2px 6px;
    font-weight: 600;
}

/* Custom USP AI-Suggested Styling */
.custom-usp-item.ai-suggested {
    position: relative;
    border-color: #8B5CF6;
    background: linear-gradient(135deg, #8B5CF620, #8B5CF610);
}

.custom-usp-item.ai-suggested::after {
    content: '‚ú® AI';
    position: absolute;
    top: 4px;
    right: 40px;
    background: linear-gradient(135deg, #8B5CF6, #EC4899);
    color: white;
    border-radius: 4px;
    font-size: 10px;
    padding: 2px 6px;
    font-weight: 600;
}

@keyframes ai-highlight {
    from {
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.4);
    }
    to {
        box-shadow: none;
    }
}

</style>

<!-- Hero Section -->
<div class="text-center mb-12 p-12 bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl">
    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
        <span class="text-4xl">üöÄ</span>
    </div>
    <h1 class="text-5xl font-bold text-gray-900 mb-4">Campaign Builder Wizard</h1>
    <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Intelligent kampagne ops√¶tning med multi-step guide. Byg professionelle Google Ads kampagner med USPs, negative keywords, budget strategier og geo-targeting.
    </p>
    
    <!-- Progress Bar -->
    <div class="mt-8 max-w-md mx-auto">
        <div class="progress-bar-container">
            <div class="progress-bar" id="wizard-progress" style="width: 20%"></div>
        </div>
        <p class="text-sm text-gray-500 mt-2">
            Step <span id="current-step">1</span> of 5 - <span id="step-description">Select Industry & Services</span>
        </p>
        <!-- Start Forfra Button -->
        <button id="reset-wizard-btn" class="mt-4 px-4 py-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Start Forfra
        </button>
    </div>
</div>



<!-- Wizard Content Container -->
<div class="wizard-card p-8 mb-8">

    <!-- STEP 0: Purpose Selection -->
    <div id="step-content-0" class="step-content animate-fade-in">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üéØ V√¶lg Form√•l</h2>
            <p class="text-gray-600">Hvad skal Campaign Builder bruges til? Du kan v√¶lge flere form√•l.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            <!-- Virksomhedsbeskrivelse Prompt -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="company_description">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-2xl shadow-lg">
                        üìù
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Virksomhedsbeskrivelse Prompt</h3>
                        <p class="text-sm text-gray-600">Generer info til ChatGPT prompt for virksomhedsbeskrivelse som kan bruges til prompting af tekst.</p>
                    </div>
                </div>
            </div>

            <!-- Google Ads Kampagner -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="google_ads">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-2xl shadow-lg">
                        üìä
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Google Ads Kampagner</h3>
                        <p class="text-sm text-gray-600">Generer Google Ads kampagne-filer med budget strategi, ad templates og geo-targeting.</p>
                    </div>
                </div>
            </div>

            <!-- SEO Analyser -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="seo">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center text-2xl shadow-lg">
                        üîç
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">SEO Analyser</h3>
                        <p class="text-sm text-gray-600">SEO analyser og metabeskrivelser til hjemmeside optimering.</p>
                    </div>
                </div>
            </div>

            <!-- Programmatic Byside -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="programmatic">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-2xl shadow-lg">
                        üåç
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Programmatic Byside</h3>
                        <p class="text-sm text-gray-600">Geo-kampagne med byside setup + WordPress upload fil til WP All Import.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected purposes summary -->
        <div id="selected-purposes-summary" class="mt-8 text-center" style="display: none;">
            <p class="text-sm text-gray-500">Valgte form√•l: <span id="purposes-count" class="font-semibold text-purple-600">0</span></p>
        </div>

        <!-- Kunde Valg -->
        <div class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200 max-w-4xl mx-auto">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <span class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl mr-3 shadow-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </span>
                Kunde
            </h3>
            <p class="text-sm text-gray-600 mb-4">V√¶lg en eksisterende kunde eller forts√¶t uden at v√¶lge (du kan gemme som ny kunde til sidst)</p>
            <div class="flex items-center gap-4">
                <select id="client-select" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all bg-white">
                    <option value="">Ny kunde (oprettes senere)</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" id="load-client-btn" onclick="loadClientData()"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Indl√¶s
                </button>
            </div>
            <div id="client-loaded-feedback" class="mt-3 hidden">
                <p class="text-sm text-green-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span id="client-loaded-name">Kunde data indl√¶st</span>
                </p>
            </div>
        </div>
    </div>

    <!-- STEP 1 (NY): Website URL Input -->
    <div id="step-content-1" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üåê Din Hjemmeside</h2>
            <p class="text-gray-600">Indtast din hjemmeside URL for at analysere eksisterende indhold</p>
        </div>

        <div class="max-w-xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                <input type="url" id="website-url-input"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                       placeholder="https://www.dinvirksomhed.dk"
                       oninput="crawlState.website_url = this.value; debouncedSaveState();">
                <p class="text-sm text-gray-500 mt-2">
                    Vi analyserer din sitemap for at finde eksisterende sider og indhold.
                </p>

                <!-- Scrape Mode Selection -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Antal sider at scrape</label>
                    <div class="space-y-2">
                        <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="radio" name="scrape-mode" value="10" checked
                                   class="w-4 h-4 text-purple-600 focus:ring-purple-500"
                                   onchange="crawlState.scrape_mode = 10; debouncedSaveState();">
                            <span class="ml-3 text-sm text-gray-700">10 sider <span class="text-gray-400">(hurtig)</span></span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="radio" name="scrape-mode" value="50"
                                   class="w-4 h-4 text-purple-600 focus:ring-purple-500"
                                   onchange="crawlState.scrape_mode = 50; debouncedSaveState();">
                            <span class="ml-3 text-sm text-gray-700">50 sider <span class="text-gray-400">(standard)</span></span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="radio" name="scrape-mode" value="100"
                                   class="w-4 h-4 text-purple-600 focus:ring-purple-500"
                                   onchange="crawlState.scrape_mode = 100; debouncedSaveState();">
                            <span class="ml-3 text-sm text-gray-700">100 sider</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="radio" name="scrape-mode" value="0"
                                   class="w-4 h-4 text-purple-600 focus:ring-purple-500"
                                   onchange="crawlState.scrape_mode = 0; debouncedSaveState();">
                            <span class="ml-3 text-sm text-gray-700">Alle sider <span class="text-gray-400">(kan tage l√¶ngere tid)</span></span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">
                        N√∏glesider (forside, om os, ydelser) scrapes altid f√∏rst.
                    </p>
                </div>

            </div>

            <!-- Optional: Skip hint -->
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-400">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Du kan skippe dette trin hvis du ikke har en hjemmeside endnu.
                </p>
            </div>
        </div>
    </div>

    <!-- STEP 2: Industry & Service Selection (var STEP 1) -->
    <div id="step-content-2" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üè¢ V√¶lg Brancher og Services</h2>
            <p class="text-gray-600">Du kan v√¶lge flere brancher og kombinere deres services</p>
        </div>
        
        <!-- Industry Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üìã V√¶lg Brancher (flere muligt)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for industry in industries %}
                <div class="selection-card p-4 rounded-lg border-2 industry-card" data-industry-id="{{ industry.id }}" data-requires-auth="{{ industry.requires_authorization|yesno:'true,false' }}">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" style="background-color: {{ industry.color }}20;">
                            {{ industry.icon }}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ industry.name }}</h4>
                            <p class="text-sm text-gray-500">{{ industry.description }}</p>
                            <div class="flex items-center mt-2 space-x-3">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    {{ industry.industry_services.count }} services
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Authorization question (hidden by default, shown when selected) -->
                    {% if industry.requires_authorization %}
                    <div class="auth-question mt-3 pt-3 border-t border-gray-200" style="display: none;">
                        <p class="text-sm font-medium text-gray-700 mb-2">Er virksomheden autoriseret?</p>
                        <div class="flex space-x-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="auth-{{ industry.id }}" value="true" class="auth-radio mr-2 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Ja, autoriseret</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="auth-{{ industry.id }}" value="false" class="auth-radio mr-2 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Nej</span>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8">
                    <p class="text-gray-500">Ingen brancher tilg√¶ngelige. Opret en branche i <a href="{% url 'industry_manager' %}" class="text-purple-600 hover:text-purple-700 font-medium">Industry Manager</a>.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Service Selection (Hidden initially) -->
        <div id="services-section" class="mb-8" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‚öôÔ∏è V√¶lg Services</h3>
            <div id="services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Services will be loaded dynamically -->
            </div>
        </div>

        <!-- AI-Suggested Section (separator + industries + services) -->
        <div id="ai-suggestions-section" class="hidden">
            <!-- Separator line -->
            <div class="border-t border-gray-200 pt-6 mt-2">
                <!-- AI-Suggested Industries -->
                <div id="suggested-industries-section" class="mb-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">‚ú®</span>
                        AI-Foresl√•ede Brancher
                        <span class="ml-2 text-sm font-normal text-gray-500">(ikke i databasen)</span>
                    </h3>
                    <div id="suggested-industries-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Suggested industry cards will be rendered here -->
                    </div>
                </div>

                <!-- AI-Suggested Services (rendered by JavaScript) -->
                <!-- The #custom-services-section will be appended here by renderCustomServices() -->
            </div>
        </div>
    </div>

    <!-- STEP 3: USP Selection (var STEP 2) -->
    <div id="step-content-3" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">‚≠ê USPs</h2>
        </div>

        <!-- USP Analysis Status (Hidden by default, shown when AI has suggestions) -->
        <div id="usp-analysis-status" class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200 hidden">
            <div class="flex items-center justify-center">
                <span class="text-purple-600 mr-2 text-lg">‚ú®</span>
                <p class="text-sm text-gray-700">
                    AI analyserede din hjemmeside og foreslog <span id="usp-suggestion-count" class="font-bold text-purple-600">0</span> USPs
                </p>
            </div>
        </div>

        <!-- Custom USPs Section -->
        <div class="mb-8 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                    <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-purple-600 to-pink-600">‚ûï</span>
                    Tilf√∏j egne USPs
                </h3>
            </div>
            <div class="flex gap-3 mb-4">
                <input type="text" id="custom-usp-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Indtast din egen USP...">
                <button type="button" id="add-custom-usp-btn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Tilf√∏j
                </button>
            </div>
            <div id="custom-usps-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Custom USPs will be added here -->
            </div>
            <p class="text-xs text-gray-500 mt-3">Tilf√∏j virksomhedens unikke salgsargumenter som ikke findes i listen nedenfor</p>
        </div>

        <!-- USP Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‚≠ê V√¶lg USPs fra listen</h3>
            <div class="space-y-6">
                {% for category in usp_categories %}
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white" style="background-color: {{ category.color }};">
                            {{ category.icon }}
                        </span>
                        {{ category.name }}
                        <span class="ml-2 category-badge bg-purple-100 text-purple-800">{{ category.usptemplate_set.count }} USPs</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for usp in category.usptemplate_set.all %}
                        <div class="flex items-start p-3 bg-white rounded-lg border usp-item" data-usp-id="{{ usp.id }}">
                            <input type="checkbox" class="checkbox-custom usp-checkbox mt-1" data-usp-id="{{ usp.id }}" data-is-cta="{{ usp.is_cta|yesno:'true,false' }}" data-original-text="{{ usp.text }}" data-example-headlines='{{ usp.example_headlines|tojson }}'>
                            <div class="flex-1" style="padding-left: 10px;">
                                <p class="font-medium text-gray-900 usp-display-text">{{ usp.text }}</p>
                                <input type="text" class="usp-edit-input w-full px-2 py-1 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" style="display: none;" value="{{ usp.text }}">
                                {% if usp.is_cta %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">
                                    CTA
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <p class="text-gray-500">Ingen USP kategorier tilg√¶ngelige.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- STEP 4: Geographic Targeting (flyttet fra STEP 5) -->
    <div id="step-content-4" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üåç Geo-Kampagne Ops√¶tning</h2>
            <p class="text-gray-600">V√¶lg geografiske regioner og konfigurer geo-kampagner</p>
        </div>

        <!-- Geographic Regions Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üó∫Ô∏è V√¶lg Geografiske Regioner</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for region in geographic_regions %}
                <div class="selection-card p-4 rounded-lg border-2 geographic-region-card"
                     data-region-id="{{ region.id }}"
                     data-region-name="{{ region.name|escapejs }}"
                     data-cities='[{% for city in region.cities.all %}{"name": "{{ city.city_name|escapejs }}", "dawa_name": "{{ city.city_synonym|default:city.city_name|escapejs }}", "postal_code": "{{ city.postal_code }}"}{% if not forloop.last %}, {% endif %}{% endfor %}]'>
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-xl">
                            üèôÔ∏è
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ region.name }}</h4>
                            <p class="text-sm text-gray-500 mb-2">{{ region.description|truncatechars:50 }}</p>
                            <div class="flex items-center space-x-2">
                                <span class="category-badge bg-blue-100 text-blue-800 region-city-count" data-original-count="{{ region.cities.count }}">{{ region.cities.count }} byer</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8">
                    <p class="text-gray-500">Ingen geografiske regioner tilg√¶ngelige. Opret regioner i <a href="{% url 'geographic_regions_manager' %}" class="text-purple-600 hover:text-purple-700 font-medium">Geographic Regions Manager</a>.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Custom Geographic Selection via Map -->
        <div class="mb-8 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-green-600 to-blue-600">üìç</span>
                V√¶lg Omr√•de p√• Kort
            </h3>
            <p class="text-sm text-gray-600 mb-4">Tegn cirkler p√• kortet for at v√¶lge specifikke omr√•der med danske byer</p>

            <div class="flex items-center gap-4">
                <input type="text" id="geo-map-selected-cities" readonly
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"
                       placeholder="Klik p√• knappen for at v√¶lge omr√•der...">
                <button type="button" id="open-geo-map-btn"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    V√¶lg p√• Kort
                </button>
            </div>

            <!-- Selected cities count -->
            <div id="geo-map-summary" class="mt-3 text-sm text-gray-500" style="display: none;">
                <span id="geo-map-city-count" class="font-semibold text-green-600">0</span> byer valgt
            </div>
        </div>

        <!-- Negative City List Generation (Hidden - auto-generates in background) -->
        <div id="negative-city-list-section" class="mb-8 bg-gradient-to-r from-red-50 to-orange-50 rounded-xl p-6 border border-red-200" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-red-600 to-orange-600">üö´</span>
                Negativ By-Liste
            </h3>
            <p class="text-sm text-gray-600 mb-4">Generer automatisk en liste med alle danske byer du IKKE betjener - til brug som negative s√∏geord</p>

            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <div id="negative-city-list-info" class="text-sm text-gray-500">
                        <span id="negative-city-count" class="font-semibold text-red-600">0</span> byer vil blive ekskluderet
                    </div>
                </div>
                <button type="button" id="generate-negative-cities-btn"
                        class="bg-gradient-to-r from-red-600 to-orange-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                    Generer Negativ By-Liste
                </button>
            </div>

            <!-- Result info (hidden by default) -->
            <div id="negative-city-list-result" class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200" style="display: none;">
                <p class="text-sm text-green-800">
                    <span class="font-medium">‚úì Liste oprettet:</span>
                    <span id="negative-city-list-name"></span> med
                    <span id="negative-city-list-count" class="font-semibold"></span> negative s√∏geord
                </p>
            </div>
        </div>
    </div>

    <!-- STEP 5: Virksomhedsbeskrivelse med AI (flyttet fra STEP 4) -->
    <div id="step-content-5" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üìù Virksomhedsbeskrivelse</h2>
            <p class="text-gray-600">AI-genereret beskrivelse baseret p√• dine valg - rediger efter behov</p>
        </div>

        <div class="max-w-2xl mx-auto space-y-6">
            <!-- AI Generation Button -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Generer med AI</h3>
                        <p class="text-sm text-gray-600">Baseret p√• website, brancher, services, USPs og geografisk m√•lretning</p>
                    </div>
                    <button type="button" id="generate-description-btn"
                            class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 flex items-center space-x-2"
                            onclick="generateCompanyDescriptionAI()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span>Generer beskrivelse</span>
                    </button>
                </div>

                <!-- Loading State - Now uses Roberto modal instead -->
            </div>

            <!-- Generated Description (editable) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Virksomhedsbeskrivelse *
                    <span id="description-source-badge" class="ml-2 text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-600 hidden">
                        AI-genereret
                    </span>
                </label>
                <textarea id="core-competencies" rows="6"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="Beskriv virksomheden, dens historie, v√¶rdier og hvad der g√∏r den unik..."
                          oninput="updateCompanyInfo()"></textarea>
                <p class="text-xs text-gray-500 mt-1">Fort√¶l om virksomhedens baggrund, v√¶rdier og s√¶rlige kendetegn</p>
            </div>

            <!-- Key Points (from AI) -->
            <div id="key-points-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Hovedpunkter fra AI</label>
                <div id="key-points-container" class="space-y-2">
                    <!-- AI-generated key points will be displayed here -->
                </div>
            </div>

            <!-- Company Profile JSON (collapsible) -->
            <div id="profile-json-section" class="hidden">
                <button type="button" id="toggle-profile-json"
                        class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors"
                        onclick="toggleProfileJson()">
                    <span class="flex items-center text-sm font-medium text-gray-700">
                        <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        Virksomhedsprofil (JSON)
                        <span class="ml-2 text-xs text-gray-500">til brug i andre AI-prompts</span>
                    </span>
                    <svg id="profile-toggle-icon" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="profile-json-content" class="hidden mt-2">
                    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                        <pre id="profile-json-display" class="text-sm text-green-400 font-mono whitespace-pre-wrap"></pre>
                    </div>
                    <div class="flex justify-end mt-2">
                        <button type="button" onclick="copyProfileJson()"
                                class="text-xs text-gray-500 hover:text-blue-600 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Kopi√©r JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 6: Kampagne & Annoncebygger (var STEP 7) -->
    <div id="step-content-6" class="step-content" style="display: none;">
        <!-- Header with Batch Actions -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Kampagne & Annoncebygger</h2>
                <p class="text-gray-600 text-sm">Gennemg√• og godkend kampagner og annoncegrupper</p>
            </div>
            <div class="flex items-center space-x-3">
                <button type="button" id="batch-approve-all-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center">
                    <span class="mr-2">‚úì</span> Godkend Alle
                </button>
            </div>
        </div>

        <!-- Sidebar + Main Content Layout -->
        <div class="step5-layout flex gap-6" style="min-height: 600px;">
            <!-- Campaign Sidebar Navigation -->
            <div class="campaign-sidebar w-72 bg-gray-50 rounded-xl border border-gray-200 p-4 flex-shrink-0 overflow-y-auto" style="max-height: 700px;">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Kampagner</h3>
                <div class="campaign-nav-list space-y-2" id="campaign-nav-list">
                    <!-- Dynamisk populated -->
                    <p class="text-gray-400 text-sm text-center py-4">Indl√¶ser...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="campaign-main-content flex-1 overflow-y-auto" style="max-height: 700px;">
                <div id="active-campaign-content">
                    <p class="text-gray-500 text-center py-8">V√¶lg en kampagne i sidebaren for at se detaljer</p>
                </div>
            </div>
        </div>

        <!-- Legacy container for compatibility - hidden -->
        <div id="campaigns-builder-container" class="hidden"></div>
    </div>

    <!-- STEP 5 CONTINUED (hidden template for campaign accordion) -->
    <template id="campaign-accordion-template">
        <div class="campaign-accordion bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" data-industry-id="">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #8B5CF620, #8B5CF610);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-purple-600 to-pink-600">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 campaign-name">Kampagne Navn</h3>
                            <p class="text-sm text-gray-600"><span class="ad-groups-count">0</span> annoncegrupper</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="maximize_clicks">Maximize Clicks</option>
                                <option value="maximize_conversions">Maximize Conversions</option>
                                <option value="target_cpa">Target CPA</option>
                                <option value="target_roas">Target ROAS</option>
                                <option value="manual_cpc">Manual CPC</option>
                            </select>
                        </div>
                        <div class="target-cpa-field" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1">
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Ad Groups Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4">Annoncegrupper</h4>
                    <div class="ad-groups-container space-y-4">
                        <!-- Ad groups will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Ad Group Template -->
    <template id="ad-group-template">
        <div class="ad-group-item bg-gray-50 rounded-xl p-4 border border-gray-200" data-service-id="">
            <!-- Ad Group Header -->
            <div class="ad-group-header flex items-center justify-between mb-4 cursor-pointer">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-blue-100 text-blue-700">
                        üîß
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 ad-group-name">Service Navn</h5>
                        <p class="text-xs text-gray-500"><span class="keywords-count">0</span> s√∏geord</p>
                    </div>
                </div>
                <span class="ad-group-toggle-icon text-xl transition-transform duration-200">‚ñº</span>
            </div>

            <!-- Ad Group Content -->
            <div class="ad-group-content">
                <!-- Keywords Section -->
                <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm flex items-center">
                            <span class="mr-2">üîë</span> S√∏geord
                        </h6>
                        <button type="button" class="add-keyword-btn text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                            + Tilf√∏j
                        </button>
                    </div>
                    <div class="keywords-list space-y-1 text-sm">
                        <!-- Keywords populated here -->
                    </div>
                </div>

                <!-- Headlines Section -->
                <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm">
                            Headlines (<span class="headlines-count">0</span>/15)
                        </h6>
                        <div class="flex space-x-2">
                            <button type="button" class="shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors flex items-center">
                                üîÄ Shuffle
                            </button>
                            <button type="button" class="add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="headlines-list space-y-2">
                        <!-- Headlines populated here -->
                    </div>
                </div>

                <!-- Descriptions Section -->
                <div class="p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm">
                            Descriptions (<span class="descriptions-count">0</span>/4)
                        </h6>
                        <div class="flex space-x-2">
                            <button type="button" class="generate-ai-descriptions-btn text-xs px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded hover:shadow-lg transition-all flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Generer med AI
                            </button>
                            <button type="button" class="add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="descriptions-list space-y-2">
                        <!-- Descriptions populated here -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- STEP 7: SEO Info - Sidebar med Services -->
    <div id="step-content-7" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <div class="flex items-center justify-center gap-4 mb-4">
                <h2 class="text-3xl font-bold text-gray-900">üîç SEO Information</h2>
                <button type="button" onclick="exportSeoContentCSV()"
                        class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-medium
                               hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Eksporter til WordPress CSV</span>
                </button>
            </div>
            <p class="text-gray-600">Konfigurer meta tags for hver service-underside</p>
        </div>

        <!-- SEO Builder Container with Sidebar -->
        <div id="seo-builder-container" class="flex gap-6 max-w-[2000px]">
            <!-- Sidebar Navigation -->
            <div class="w-[280px] flex-shrink-0">
                <div class="sticky top-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÑ Undersider</h3>
                    <div id="seo-nav-list" class="space-y-2">
                        <!-- Dynamically populated by renderSeoSidebar() -->
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 min-w-0">
                <div id="active-seo-content">
                    <!-- Dynamically populated by renderActiveSeoContent() -->
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">V√¶lg en service fra sidebaren</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 8: Programmatic Byside Setup (var STEP 9) -->
    <div id="step-content-8" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üåç Programmatic Byside Setup</h2>
            <p class="text-gray-600">Konfigurer geo-kampagne og WordPress upload</p>
        </div>

        <div class="space-y-8">
            <!-- Hidden inputs for compatibility -->
            <input type="hidden" id="programmatic-website-url" value="">
            <div id="sitemap-loading" class="hidden"></div>
            <div id="sitemap-error" class="hidden"><span id="sitemap-error-message"></span></div>
            <div id="sitemap-success" class="hidden"></div>

            <!-- Sitemap Status (simplified - only shows URL count when available) -->
            <div id="sitemap-status" class="mb-4 hidden">
                <div class="flex items-center space-x-2 text-green-600 bg-green-50 px-4 py-2 rounded-lg inline-flex">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span id="sitemap-urls-count">0 URLs fundet i sitemap</span>
                </div>
            </div>

            <!-- Hidden: behold city-search for kompatibilitet men skjult -->
            <input type="hidden" id="city-search" value="">
            <input type="hidden" id="selected-cities-count" value="0">

            <!-- City Page Status -->
            <div id="city-page-status-section" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 hidden">
                <!-- Header med Credit Counter -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">üìä Byside Status</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 px-4 py-2 bg-green-100 rounded-lg">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-semibold text-green-800" id="existing-pages-count">0</span>
                            <span class="text-green-700 text-sm">eksisterer</span>
                        </div>
                        <div class="flex items-center space-x-2 px-4 py-2 bg-yellow-100 rounded-lg">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span class="font-semibold text-yellow-800" id="missing-pages-count">0</span>
                            <span class="text-yellow-700 text-sm">mangler</span>
                        </div>
                        <!-- Credit Counter -->
                        <div class="flex items-center space-x-2 px-4 py-2 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <span class="text-purple-700 text-sm font-medium">Credits:</span>
                            <span class="font-bold text-purple-800 text-lg" id="credits-count">0</span>
                        </div>
                    </div>
                </div>

                <div id="city-page-status-loading" class="flex items-center justify-center py-8 hidden">
                    <svg class="animate-spin h-8 w-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ml-3 text-gray-600">Tjekker bysider...</span>
                </div>

                <!-- Resultat: To kolonner -->
                <div id="city-page-results" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Eksisterende sider (venstre) -->
                        <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Eksisterende sider (0 credits)
                            </h4>
                            <div id="existing-pages-list" class="space-y-2">
                                <!-- Dynamisk liste af eksisterende sider med links -->
                            </div>
                            <p id="no-existing-pages" class="text-sm text-green-600 italic hidden">Ingen eksisterende sider fundet</p>
                        </div>

                        <!-- Manglende sider (h√∏jre) -->
                        <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-yellow-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Nye sider (1 credit per side)
                                </h4>
                                <div class="flex space-x-2">
                                    <button type="button" onclick="selectAllMissingPages()" class="text-xs text-yellow-700 hover:text-yellow-900 font-medium">V√¶lg alle</button>
                                    <span class="text-yellow-400">|</span>
                                    <button type="button" onclick="deselectAllMissingPages()" class="text-xs text-yellow-700 hover:text-yellow-900 font-medium">Frav√¶lg alle</button>
                                </div>
                            </div>
                            <div id="missing-pages-list" class="space-y-2">
                                <!-- Dynamisk liste af manglende sider med checkboxes -->
                            </div>
                            <p id="no-missing-pages" class="text-sm text-yellow-600 italic hidden">Alle bysider eksisterer allerede!</p>
                        </div>
                    </div>

                    <!-- City Coverage Grid med dots -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                                By-oversigt
                            </h4>
                            <!-- Legend -->
                            <div class="flex items-center gap-4 text-xs text-gray-500">
                                <span class="flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                    Har byside
                                </span>
                                <span class="flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-gray-300"></span>
                                    Ingen byside
                                </span>

                                <!-- Filter toggle -->
                                <div class="inline-flex items-center gap-2 ml-auto">
                                    <span class="text-gray-500">Sekund√¶re byer</span>
                                    <label for="show-secondary-cities"
                                           style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;"
                                           onclick="toggleSecondaryCities(event)">
                                        <input type="checkbox" id="show-secondary-cities"
                                               style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 10;"
                                               onchange="filterSecondaryCities()">
                                        <span id="cb-toggle-track" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #d1d5db; border-radius: 24px; transition: background-color 0.2s; pointer-events: none;"></span>
                                        <span id="cb-toggle-knob" style="position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s; pointer-events: none;"></span>
                                    </label>
                                    <span id="secondary-city-count" class="text-gray-400 tabular-nums"></span>
                                </div>
                            </div>
                        </div>
                        <div id="city-coverage-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-1 text-sm text-gray-600 bg-white rounded-lg p-4 border border-gray-200">
                            <!-- Dynamisk genereret af JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEO Meta Tags Generering -->
            <div id="seo-meta-tags-section" class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">üè∑Ô∏è SEO Meta Tags</h3>
                        <p class="text-sm text-gray-600 mt-1">Gener√©r 7 varianter af meta titler (50-60 tegn) og meta beskrivelser (120-160 tegn)</p>
                    </div>
                    <button type="button" id="generate-meta-tags-btn" onclick="generateAIMetaTags()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span>Generer 7 varianter med AI</span>
                    </button>
                </div>

                <!-- Loading state - Now uses Roberto modal -->

                <!-- Preview af genererede meta tags -->
                <div id="meta-tags-preview" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Meta Titler -->
                        <div class="bg-white rounded-xl p-4 border border-blue-100">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-blue-800 flex items-center">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm"
                                          style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üì∞</span>
                                    Meta Titler (<span id="meta-titles-count">0</span>/10)
                                </h4>
                                <button type="button" class="add-meta-title-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                                        style="background: linear-gradient(135deg, #dbeafe20, #bfdbfe20); color: #2563eb;">
                                    + Tilf√∏j
                                </button>
                            </div>
                            <div id="meta-titles-list" class="space-y-2">
                                <!-- Dynamisk liste af meta titler -->
                            </div>
                        </div>

                        <!-- Meta Beskrivelser -->
                        <div class="bg-white rounded-xl p-4 border border-indigo-100">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-indigo-800 flex items-center">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm"
                                          style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe);">üìù</span>
                                    Meta Beskrivelser (<span id="meta-descriptions-count">0</span>/10)
                                </h4>
                                <button type="button" class="add-meta-desc-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                                        style="background: linear-gradient(135deg, #e0e7ff20, #c7d2fe20); color: #4f46e5;">
                                    + Tilf√∏j
                                </button>
                            </div>
                            <div id="meta-descriptions-list" class="space-y-2">
                                <!-- Dynamisk liste af meta beskrivelser -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <strong>üí° Tip:</strong> Ved eksport blandes titler og beskrivelser automatisk, s√• hver byside f√•r en unik kombination.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 9: Summary and Export (var STEP 10) -->
    <div id="step-content-9" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üìã Opsummering og Generering</h2>
            <p class="text-gray-600">Gennemg√• dine valg og generer output</p>
        </div>

        <!-- Campaign Summary -->
        <div id="campaign-summary" class="space-y-6">
            <!-- Summary content will be generated dynamically -->
        </div>

        <!-- Export Options based on selected purposes -->
        <div class="mt-8 border-t pt-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üì§ Generer Output</h3>
            <div id="export-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Export options will be generated dynamically based on selected purposes -->
            </div>
        </div>

        <!-- Gem som Kunde Section -->
        <div class="mt-8 pt-8 border-t border-gray-200">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border border-blue-100">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Gem Kundedata</h3>
                            <p class="text-sm text-gray-600">Gem alle indsamlede data til kundeprofil for senere brug</p>
                        </div>
                    </div>
                    <button id="save-as-client-btn" onclick="saveAsClient()"
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Gem som Kunde
                    </button>
                </div>

                <!-- Feedback after save -->
                <div id="client-saved-link" class="mt-4 hidden">
                    <a id="client-profile-link" href="#" target="_blank"
                       class="inline-flex items-center gap-2 text-purple-600 hover:text-purple-800 font-medium transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        Se kundeprofil
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Controls -->
<div class="flex justify-between items-center mb-8">
    <button id="prev-btn" class="px-6 py-3 bg-gray-200 text-gray-600 rounded-lg font-medium hover:bg-gray-300 transition-all duration-200" onclick="previousStep()" style="display: none;">
        ‚Üê Forrige Step
    </button>
    <div class="flex-1"></div>
    <button id="next-btn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200" onclick="nextStep()">
        N√¶ste Step ‚Üí
    </button>
    <button id="create-campaign-btn" class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200" onclick="createCampaign()" style="display: none;">
        üöÄ Opret Kampagne
    </button>
</div>

<!-- Authorization Modal -->
<div id="authorization-modal" class="fixed inset-0 flex items-center justify-center" style="z-index: 2147483647; display: none;">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <!-- Modal content - centreret -->
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6">
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900">Autorisation p√•kr√¶vet</h3>
                <p class="text-sm text-gray-500">Bekr√¶ft autorisations-status</p>
            </div>
        </div>
        <p class="text-gray-600 mb-6">For at sikre korrekte annoncetekster, bekr√¶ft venligst om virksomheden er autoriseret:</p>
        <div id="authorization-questions" class="space-y-4">
            <!-- Dynamically generated questions -->
        </div>
        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
            <button id="auth-modal-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                Annuller
            </button>
            <button id="auth-modal-confirm" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Forts√¶t
            </button>
        </div>
    </div>
</div>

<!-- Negative Keywords Editor Modal -->
<div id="negative-keywords-editor-modal" class="fixed inset-0 flex items-center justify-center" style="z-index: 2147483646; display: none;">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50 neg-editor-backdrop"></div>
    <!-- Modal content -->
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[85vh] flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <span class="text-xl">üìã</span>
                    </div>
                    <div>
                        <h3 id="neg-editor-title" class="text-xl font-bold text-gray-900">Negative S√∏geord</h3>
                        <p id="neg-editor-subtitle" class="text-sm text-gray-500">Se og rediger s√∏geord i listen</p>
                    </div>
                </div>
                <button type="button" id="neg-editor-close" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>

        <!-- Add new keyword form -->
        <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <input type="text" id="neg-editor-new-keyword" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" placeholder="Tilf√∏j nyt negativt s√∏geord...">
                <button type="button" id="neg-editor-add-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 text-sm">
                    + Tilf√∏j
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Tilf√∏jede s√∏geord gemmes kun i denne session og anvendes ved export.</p>
        </div>

        <!-- Keywords list -->
        <div class="flex-1 overflow-y-auto p-4">
            <div id="neg-editor-keywords-list" class="space-y-2">
                <!-- Keywords will be loaded here -->
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">
                    <span id="neg-editor-count">0</span> s√∏geord i listen
                    (<span id="neg-editor-custom-count">0</span> tilf√∏jet i denne session)
                </span>
                <button type="button" id="neg-editor-done-btn" class="px-6 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors">
                    F√¶rdig
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Roberto Loading Modal - Typing Robot Animation -->
<div id="roberto-loading-modal" class="fixed inset-0 flex items-center justify-center" style="z-index: 2147483648; display: none;">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
    <!-- Modal content -->
    <div class="relative flex flex-col items-center justify-center p-8 bg-white rounded-xl max-w-sm mx-auto" style="border: 1px solid #444; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
        <div id="roberto-svg-container">
        <svg viewBox="0 0 200 200" class="w-64 h-64">
            <!-- Robot Body -->
            <rect x="70" y="80" width="60" height="50" rx="8" fill="#64748b" />

            <!-- Robot Head -->
            <rect x="65" y="35" width="70" height="50" rx="10" fill="#94a3b8" />

            <!-- Antenna -->
            <line x1="100" y1="35" x2="100" y2="20" stroke="#64748b" stroke-width="3" />
            <circle cx="100" cy="16" r="5" fill="#f59e0b">
                <animate attributeName="fill" values="#f59e0b;#fbbf24;#f59e0b" dur="1s" repeatCount="indefinite" />
            </circle>

            <!-- Eyes -->
            <circle cx="82" cy="55" r="8" fill="#1e293b" />
            <circle cx="118" cy="55" r="8" fill="#1e293b" />
            <circle cx="84" cy="53" r="3" fill="#22d3ee">
                <animate attributeName="cy" values="53;55;53" dur="2s" repeatCount="indefinite" />
            </circle>
            <circle cx="120" cy="53" r="3" fill="#22d3ee">
                <animate attributeName="cy" values="53;55;53" dur="2s" repeatCount="indefinite" />
            </circle>

            <!-- Mouth -->
            <rect x="88" y="68" width="24" height="4" rx="2" fill="#1e293b" />

            <!-- Left Arm with typing animation -->
            <g>
                <rect x="40" y="90" width="30" height="12" rx="6" fill="#64748b">
                    <animateTransform attributeName="transform" type="rotate" values="0 70 96;-5 70 96;0 70 96" dur="0.3s" repeatCount="indefinite" />
                </rect>
                <circle cx="42" cy="96" r="6" fill="#94a3b8">
                    <animate attributeName="cy" values="96;92;96" dur="0.3s" repeatCount="indefinite" />
                </circle>
            </g>

            <!-- Right Arm with typing animation -->
            <g>
                <rect x="130" y="90" width="30" height="12" rx="6" fill="#64748b">
                    <animateTransform attributeName="transform" type="rotate" values="0 130 96;5 130 96;0 130 96" dur="0.3s" repeatCount="indefinite" begin="0.15s" />
                </rect>
                <circle cx="158" cy="96" r="6" fill="#94a3b8">
                    <animate attributeName="cy" values="96;92;96" dur="0.3s" repeatCount="indefinite" begin="0.15s" />
                </circle>
            </g>

            <!-- Typewriter Base -->
            <rect x="30" y="140" width="140" height="25" rx="4" fill="#374151" />
            <rect x="35" y="135" width="130" height="10" rx="2" fill="#4b5563" />

            <!-- Typewriter Keys -->
            <rect x="45" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0s" /></rect>
            <rect x="59" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.05s" /></rect>
            <rect x="73" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.1s" /></rect>
            <rect x="87" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.15s" /></rect>
            <rect x="101" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.2s" /></rect>
            <rect x="115" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.25s" /></rect>
            <rect x="129" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.3s" /></rect>
            <rect x="143" y="142" width="10" height="6" rx="1" fill="#6b7280"><animate attributeName="y" values="142;140;142" dur="0.15s" repeatCount="indefinite" begin="0.35s" /></rect>

            <!-- Paper/Screen with prompt -->
            <rect x="40" y="102" width="120" height="44" fill="#1e293b" rx="3" />
            <rect x="43" y="105" width="114" height="38" fill="#0f172a" rx="2" />

            <!-- Prompt text lines -->
            <text x="48" y="117" font-size="5.5" fill="#22d3ee" font-family="monospace" id="roberto-line1">&gt; Analyserer data...</text>
            <text x="48" y="127" font-size="5.5" fill="#a5f3fc" font-family="monospace" id="roberto-line2">&gt; Bygger kampagne</text>
            <text x="48" y="137" font-size="5.5" fill="#a5f3fc" font-family="monospace">
                <tspan id="roberto-line3">  struktur</tspan>
                <tspan fill="#22d3ee">_</tspan>
                <animate attributeName="opacity" values="1;0;1" dur="1s" repeatCount="indefinite" />
            </text>

            <!-- Carriage -->
            <rect x="50" y="105" width="100" height="8" rx="2" fill="#1f2937">
                <animate attributeName="x" values="50;55;50" dur="4s" repeatCount="indefinite" />
            </rect>
        </svg>
        </div>

        <!-- Loading text with animated dots -->
        <div class="mt-6 text-slate-700 text-lg font-mono" id="roberto-loading-text">
            Woosaah<span id="roberto-dots"></span>
        </div>

        <p class="mt-2 text-slate-500 text-sm" id="roberto-subtitle">
            Roberto din Co-manager - Arbejder s√• hurtigt han kan
        </p>
    </div>
</div>

<script>
// Roberto Loading Modal - Backend Widget Manager
let loadedRobertoWidgets = {};
let robertoDotsInterval = null;
let lastShownWidgetIndex = {};  // Track last shown widget per operation type for variety

// Load widgets from backend on page load
async function loadRobertoWidgets() {
    try {
        const response = await fetch('/ai/ajax/widgets-for-operation/');
        const data = await response.json();
        if (data.success) {
            loadedRobertoWidgets = data.widgets;
            console.log('[Roberto] Loaded widgets from backend:', Object.keys(loadedRobertoWidgets));
        }
    } catch (error) {
        console.error('[Roberto] Failed to load widgets:', error);
    }
}

// Initialize widgets on page load
loadRobertoWidgets();

function showRobertoLoading(operationTypeOrCustomTexts = 'random') {
    const modal = document.getElementById('roberto-loading-modal');
    if (!modal) return;

    let widget = null;
    let texts = null;

    // Check if we received custom texts (legacy support) or operation type
    if (typeof operationTypeOrCustomTexts === 'object' && operationTypeOrCustomTexts !== null) {
        // Legacy: custom texts object passed directly
        texts = operationTypeOrCustomTexts;
    } else {
        // New: operation type string
        const operationType = operationTypeOrCustomTexts;

        // Get widgets ONLY for this specific operation type (no fallback to random)
        let availableWidgets = loadedRobertoWidgets[operationType] || [];

        if (availableWidgets.length === 0) {
            // No active widgets for this operation type - show blank modal
            texts = {
                loadingText: 'Ingen Loading Widget',
                subtitle: `Ingen aktiv widget for: ${operationType}`
            };
            // Clear the SVG container to show blank
            const svgContainer = document.getElementById('roberto-svg-container');
            if (svgContainer) {
                svgContainer.innerHTML = '';
            }
            console.log('[Roberto] No active widgets for operation type:', operationType);
        } else {
            // Select widget with variety - avoid showing same widget twice in a row
            let widgetIndex = 0;
            const maxIndex = Math.min(3, availableWidgets.length);  // Only consider top 3 by priority

            if (maxIndex > 1) {
                // Get last shown index for this operation type
                const lastIndex = lastShownWidgetIndex[operationType];

                // Build array of available indices (excluding last shown)
                const availableIndices = [];
                for (let i = 0; i < maxIndex; i++) {
                    if (i !== lastIndex) {
                        availableIndices.push(i);
                    }
                }

                // Select randomly from available indices
                widgetIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            }

            // Store the selected index for next time
            lastShownWidgetIndex[operationType] = widgetIndex;

            widget = availableWidgets[widgetIndex];
            texts = widget.text_config;
            console.log('[Roberto] Selected widget:', widget.name, 'index:', widgetIndex, 'for:', operationType);
        }
    }

    // Update SVG if widget has one
    if (widget && widget.svg_content) {
        const svgContainer = document.getElementById('roberto-svg-container');
        if (svgContainer) {
            svgContainer.innerHTML = widget.svg_content;
            console.log('[Roberto] Swapped SVG for widget:', widget.name);
        }
    }

    // Update text content (check if elements exist - they may not exist in all SVG widgets)
    const line1El = document.getElementById('roberto-line1');
    const line2El = document.getElementById('roberto-line2');
    const line3El = document.getElementById('roberto-line3');
    const loadingTextEl = document.getElementById('roberto-loading-text');
    const subtitleEl = document.getElementById('roberto-subtitle');

    if (line1El) line1El.textContent = texts.line1 || '> Loading...';
    if (line2El) line2El.textContent = texts.line2 || '> Arbejder';
    if (line3El) line3El.textContent = texts.line3 || '  p√• det';
    if (loadingTextEl) loadingTextEl.innerHTML = (texts.loadingText || 'Vent') + '<span id="roberto-dots"></span>';
    if (subtitleEl) subtitleEl.textContent = texts.subtitle || 'Roberto arbejder';

    // Start dots animation
    let dots = '';
    robertoDotsInterval = setInterval(() => {
        dots = dots.length >= 3 ? '' : dots + '.';
        const dotsEl = document.getElementById('roberto-dots');
        if (dotsEl) dotsEl.textContent = dots;
    }, 400);

    // Show modal
    modal.style.display = 'flex';
    console.log('[Roberto] Modal shown, operation:', operationTypeOrCustomTexts);
}

function hideRobertoLoading() {
    const modal = document.getElementById('roberto-loading-modal');
    if (!modal) return;

    // Hide modal immediately - it stays visible until operation completes
    modal.style.display = 'none';
    if (robertoDotsInterval) {
        clearInterval(robertoDotsInterval);
        robertoDotsInterval = null;
    }
    console.log('[Roberto] Modal hidden');
}

// Convenience functions for specific loading contexts (using operation types)
function showRobertoScraping() {
    showRobertoLoading('crawling');
}

function showRobertoDetecting() {
    showRobertoLoading('service_detection');
}

function showRobertoGenerating() {
    showRobertoLoading('company_description');
}

function showRobertoMetaTags() {
    showRobertoLoading('meta_tags');
}

function showRobertoSeoContent() {
    showRobertoLoading('seo_content');
}

function showRobertoUspAnalysis() {
    showRobertoLoading('usp_analysis');
}
</script>

<script>
// Wizard State Management
let currentStep = 0;  // Start at step 0 (purpose selection)

let campaignConfig = {
    client_id: null,  // Selected client ID (null = new client)
    selected_purposes: [],  // ['company_description', 'google_ads', 'seo', 'programmatic']
    industry_ids: [],  // Changed from industry_id to support multiple industries
    service_ids: [],
    service_purposes: {},  // {serviceId: {google_ads: true, seo: true, programmatic: true}}
    usp_ids: [],
    usp_custom_texts: {},  // {usp_id: "custom text"} for edited USPs
    usp_variable_values: {},  // {usp_id: {varIndex: "brugerv√¶rdi"}} for variable substitution
    custom_usps: [],  // Array of custom USP texts added by user
    custom_services: [],  // Array of custom services detected by AI: [{name, industry, confidence}]
    custom_service_purposes: {},  // {index: {google_ads: true, seo: true, programmatic: true}} - purpose settings for custom services
    suggested_industries: [],  // Array of AI-suggested industries not in database
    negative_keyword_list_ids: [],
    budget_strategy_id: null,
    ad_template_id: null,
    geographic_region_ids: [],
    industry_authorizations: {},  // {industry_id: true/false} for industries requiring authorization
    // Purpose-specific data
    company_info: {
        core_competencies: '',
        ai_generated: false,
        key_points: [],
        profile: {}  // Structured JSON profile for use in other AI prompts
    },
    seo_info: {
        website_url: '',
        focus_keywords: []
    },
    // NYT: SEO Pages - √©n meta titel/beskrivelse per service underside
    seo_pages: {
        // service_id: { service_name, meta_title, meta_description, seo_keywords: [], keywords_loaded: false }
    },
    programmatic_info: {
        selected_cities: []
    },
    // NYT: Geo-kampagne konfiguration (Step 4)
    geo_config: {
        enabled_services: [],  // Hvilke services f√•r geo-kampagne
        create_byside_urls: true,  // Auto-genereres altid
        byside_urls: []  // [{city, url, exists, edited}]
    },
    // NYT: Kampagne & Annoncebygger (Step 5)
    campaigns: {},  // {industryId: {industry_id, industry_name, budget, negative_keyword_list_ids, geo_config, ad_groups: {serviceId: {...}}}}
    // Custom negative keywords added in this session (per list)
    custom_negative_keywords: {},  // {listId: ['keyword1', 'keyword2', ...]}
    // Template ad group for copying headlines/descriptions to other ad groups
    // Supports both industry and GEO campaigns (shared template pool)
    template_ad_group: {
        type: null,           // 'industry' or 'geo'
        industry_id: null,    // Only used when type='industry'
        service_id: null,     // Used by both types
        source_service_name: null  // Original service name for substitution
    },
    // USP Analysis from website scraping (Smart USP Pre-fill)
    usp_analysis: {
        status: 'idle',  // 'idle', 'analyzing', 'success', 'error'
        timestamp: null,
        matched_usps: [],
        custom_usps: [],
        extracted_facts: {},
        applied: false,  // Track if suggestions have been applied to UI
        pages_scraped: 0,
        total_urls_found: 0,
        content_length: 0
    },
    // Service Detection from website scraping (Auto-select industries/services)
    service_detection: {
        status: 'idle',  // 'idle', 'detecting', 'success', 'error'
        timestamp: null,
        detected_services: [],
        detected_service_ids: [],
        suggested_services: [],  // Services not in DB but detected on website
        detected_industries: [],
        detected_industry_ids: [],
        primary_industry: null,
        confidence_scores: {},
        applied: false  // Track if detection has been applied to UI
    }
};

// Crawl State - shared across all purposes (website analysis, programmatic, SEO)
let crawlState = {
    website_url: '',
    scrape_mode: 10,  // 10, 50, 100, or 0 (all pages)
    crawl_status: 'idle', // 'idle' | 'crawling' | 'success' | 'error'
    crawl_timestamp: null,
    crawl_error: null,
    sitemap_urls: [],
    urls_found: 0,
    city_matches: [],      // Genbruges i Programmatic step
    existing_count: 0,
    missing_count: 0,
    scraped_pages: {},      // Pages with meta_title, meta_description, content
    extracted_reviews: []   // Reviews extracted via Playwright (Trustpilot, Google etc.)
};

// Server data - will be populated from Django context
let serverData = {
    negative_keyword_lists: [],
    usp_templates: [],
    google_keywords: {},  // Gem keywords per industry
    services_by_id: {}  // Lookup map: serviceId -> {id, name, description, color, industry_name, ...}
};

// ========================================
// localStorage Persistence (7-day expiry)
// ========================================
const STORAGE_KEY = 'campaignBuilderState';
const STORAGE_EXPIRY_DAYS = 7;

// Debounce helper function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Save current state to localStorage
function saveStateToStorage() {
    try {
        const stateToSave = {
            version: 2,  // State version for migration
            currentStep: currentStep,
            campaignConfig: campaignConfig,
            crawlState: crawlState,  // Include crawl state
            timestamp: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
        console.log('State saved to localStorage');
    } catch (e) {
        console.warn('Could not save state to localStorage:', e);
    }
}

// Migrate state from older versions
function migrateState(state) {
    const currentVersion = 2;
    const stateVersion = state.version || 1;

    if (stateVersion < currentVersion) {
        console.log(`Migrating state from v${stateVersion} to v${currentVersion}`);

        // v1 -> v2: Add crawlState, offset steps
        if (stateVersion < 2) {
            // Initialize crawlState if not present
            if (!state.crawlState) {
                state.crawlState = {
                    website_url: '',
                    scrape_mode: 10,
                    crawl_status: 'idle',
                    crawl_timestamp: null,
                    crawl_error: null,
                    sitemap_urls: [],
                    urls_found: 0,
                    city_matches: [],
                    existing_count: 0,
                    missing_count: 0
                };
            }
            // Add scrape_mode to existing crawlState if missing
            if (state.crawlState && state.crawlState.scrape_mode === undefined) {
                state.crawlState.scrape_mode = 10;
            }

            // Initialize service_purposes if not present
            if (!state.campaignConfig.service_purposes) {
                state.campaignConfig.service_purposes = {};
            }

            // Offset step numbers (old steps 1+ become 2+, etc.)
            // Step 0 stays 0, but we add new Step 1 (Website URL) and Step 4 (Auto-Crawl)
            if (state.currentStep >= 1) {
                state.currentStep += 1;  // Offset for new Step 1
            }
            if (state.currentStep >= 4) {
                state.currentStep += 1;  // Offset for new Step 4
            }
        }

        state.version = currentVersion;
    }

    return state;
}

// Load state from localStorage (returns null if expired or not found)
function loadStateFromStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return null;

        let state = JSON.parse(saved);
        const expiryMs = STORAGE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;

        // Check if expired
        if (Date.now() - state.timestamp > expiryMs) {
            console.log('Saved state expired, clearing');
            clearSavedState();
            return null;
        }

        // Migrate from older versions
        state = migrateState(state);

        // Restore crawlState if present
        if (state.crawlState) {
            crawlState = state.crawlState;
        }

        console.log('Loaded state from localStorage, age:', Math.round((Date.now() - state.timestamp) / 1000 / 60), 'minutes');
        return state;
    } catch (e) {
        console.warn('Could not load state from localStorage:', e);
        return null;
    }
}

// Clear saved state from localStorage
function clearSavedState() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        console.log('Cleared saved state from localStorage');
    } catch (e) {
        console.warn('Could not clear localStorage:', e);
    }
}

// Debounced save for frequent updates (500ms delay)
const debouncedSaveState = debounce(saveStateToStorage, 500);

// =============================================================================
// UI RESTORE HANDLER REGISTRY (Extensible pattern for future-proof persistence)
// =============================================================================
// To add a new field to localStorage persistence:
// 1. Add field to campaignConfig object (automatic save/load)
// 2. Register a UI restore handler below with registerUIRestoreHandler()
// =============================================================================

const uiRestoreHandlers = [];

// Register a UI restore handler for a specific data field
// @param name - Identifier for logging/debugging
// @param handler - Function that receives campaignConfig and restores UI
// @param options.async - Set to true if handler returns a Promise
// @param options.priority - Lower numbers run first (default: 50)
function registerUIRestoreHandler(name, handler, options = {}) {
    uiRestoreHandlers.push({
        name,
        handler,
        async: options.async || false,
        priority: options.priority || 50
    });
}

// Step 0: Purposes (priority: 10)
registerUIRestoreHandler('purposes', (config) => {
    config.selected_purposes.forEach(purpose => {
        $(`.purpose-card[data-purpose="${purpose}"]`).addClass('selected');
    });
    const purposeCount = config.selected_purposes.length;
    $('#purposes-count').text(purposeCount);
    if (purposeCount > 0) {
        $('#selected-purposes-summary').show();
    }
}, { priority: 10 });

// Step 1: Industries (priority: 20)
registerUIRestoreHandler('industries', (config) => {
    config.industry_ids.forEach(industryId => {
        const card = $(`.industry-card[data-industry-id="${industryId}"]`);
        card.addClass('selected');

        // Show auth question if applicable
        const requiresAuth = card.data('requires-auth') === true || card.data('requires-auth') === 'true';
        if (requiresAuth) {
            card.find('.auth-question').show();
            // Restore authorization answer
            const authAnswer = config.industry_authorizations[industryId];
            if (authAnswer !== undefined) {
                card.find(`input[name="auth-${industryId}"][value="${authAnswer}"]`).prop('checked', true);
            }
        }
    });
}, { priority: 20 });

// Step 1: Services (priority: 30, async - waits for AJAX)
registerUIRestoreHandler('services', async (config) => {
    if (config.industry_ids.length > 0) {
        $('#services-section').show();
        // Load services for selected industries - await the Promise!
        // Service selections are restored in processServiceResponses()
        await loadServicesForSelectedIndustries();
    }
}, { async: true, priority: 30 });

// Step 2: USPs (priority: 40)
registerUIRestoreHandler('usps', (config) => {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        config.usp_ids.forEach(uspId => {
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            checkbox.prop('checked', true);
            // Note: usp-has-variables class is handled by usp_variables handler below
        });
    }, 100);
}, { priority: 40 });

// Step 2: USP Variables (priority: 41) - Restore variable values with renderUspWithVariables
registerUIRestoreHandler('usp_variables', (config) => {
    if (!config.usp_ids || config.usp_ids.length === 0) return;
    if (!config.usp_variable_values || Object.keys(config.usp_variable_values).length === 0) return;

    setTimeout(() => {
        config.usp_ids.forEach(uspId => {
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            if (!checkbox.length) return;

            const originalText = checkbox.data('original-text');
            if (originalText && parseUspVariables(originalText).length > 0) {
                const displayText = checkbox.closest('.usp-item').find('.usp-display-text');
                // GENBRUG eksisterende renderUspWithVariables funktion
                displayText.html(renderUspWithVariables(originalText, uspId));
                displayText.addClass('usp-has-variables');
            }
        });
    }, 150);
}, { priority: 41 });

// Step 2: Custom USPs (priority: 45) - Restore custom USPs with renderCustomUsps
registerUIRestoreHandler('custom_usps', (config) => {
    if (config.custom_usps && config.custom_usps.length > 0) {
        // GENBRUG eksisterende renderCustomUsps funktion
        renderCustomUsps();
    }
}, { priority: 45 });

// Step 5: Geo Map Targeting (priority: 50) - Restore geo map selected cities
registerUIRestoreHandler('geo_map_targeting', (config) => {
    if (config.geo_map_targeting && config.geo_map_targeting.postal_names && config.geo_map_targeting.postal_names.length > 0) {
        // Opdater display feltet med gemte bynavne
        $('#geo-map-selected-cities').val(config.geo_map_targeting.postal_names.join(', '));
        $('#geo-map-city-count').text(config.geo_map_targeting.postal_names.length);
        $('#geo-map-summary').show();
        console.log('Restored geo_map_targeting:', config.geo_map_targeting.postal_names);
    }
}, { priority: 50 });

// Step 1: Website URL (priority: 5) - Restore crawlState.website_url
registerUIRestoreHandler('website_url', (config) => {
    if (crawlState.website_url) {
        $('#website-url-input').val(crawlState.website_url);
        console.log('Restored website_url:', crawlState.website_url);
    }
}, { priority: 5 });

// Step 1: Scrape Mode (priority: 6) - Restore crawlState.scrape_mode
registerUIRestoreHandler('scrape_mode', (config) => {
    if (crawlState.scrape_mode !== undefined) {
        $(`input[name="scrape-mode"][value="${crawlState.scrape_mode}"]`).prop('checked', true);
        console.log('Restored scrape_mode:', crawlState.scrape_mode);
    }
}, { priority: 6 });

// Step 2: Service Purposes (priority: 26, after services) - Restore service purpose checkboxes
registerUIRestoreHandler('service_purposes', (config) => {
    if (config.service_purposes && Object.keys(config.service_purposes).length > 0) {
        Object.entries(config.service_purposes).forEach(([serviceId, purposes]) => {
            const purposesContainer = $(`.service-purposes[data-service-id="${serviceId}"]`);
            // Show the purposes container for selected services
            purposesContainer.removeClass('hidden');
            // Restore checkbox states
            Object.entries(purposes).forEach(([purpose, isEnabled]) => {
                const checkbox = $(`.service-purpose-checkbox[data-service-id="${serviceId}"][data-purpose="${purpose}"]`);
                checkbox.prop('checked', isEnabled);
            });
        });
        console.log('Restored service_purposes:', config.service_purposes);
    }
}, { priority: 26 });

// Step 2: Custom Service Purposes (priority: 27, after service_purposes) - Restore custom service purpose checkboxes
registerUIRestoreHandler('custom_service_purposes', (config) => {
    if (config.custom_service_purposes && Object.keys(config.custom_service_purposes).length > 0) {
        // Re-render custom services to show the checkboxes with correct state
        // The checkbox states are already stored in campaignConfig.custom_service_purposes
        renderCustomServices();
        console.log('Restored custom_service_purposes:', config.custom_service_purposes);
    }
}, { priority: 27 });

// Restore UI from saved state using registered handlers
async function restoreUIFromState() {
    console.log('Restoring UI from saved state...');

    // Sort handlers by priority (lower runs first)
    const sorted = [...uiRestoreHandlers].sort((a, b) => a.priority - b.priority);

    for (const { name, handler, async: isAsync } of sorted) {
        try {
            console.log(`Restoring: ${name}`);
            if (isAsync) {
                await handler(campaignConfig);
            } else {
                handler(campaignConfig);
            }
        } catch (e) {
            console.warn(`Failed to restore ${name}:`, e);
        }
    }

    console.log('UI restoration complete');
}

// Purpose definitions
const PURPOSES = {
    company_description: {
        id: 'company_description',
        name: 'Virksomhedsbeskrivelse Prompt',
        icon: 'üìù',
        description: 'Generer info til ChatGPT prompt for virksomhedsbeskrivelse',
        steps: ['company_info']
    },
    google_ads: {
        id: 'google_ads',
        name: 'Google Ads Kampagner',
        icon: 'üìä',
        description: 'Generer Google Ads kampagne-filer',
        steps: ['budget_strategy', 'geo_targeting']
    },
    seo: {
        id: 'seo',
        name: 'SEO Analyser',
        icon: 'üîç',
        description: 'SEO analyser og metabeskrivelser',
        steps: ['seo_info']
    },
    programmatic: {
        id: 'programmatic',
        name: 'Programmatic Byside',
        icon: 'üåç',
        description: 'Geo-kampagne + WordPress upload fil',
        steps: ['programmatic_setup']
    }
};

// Konverter dansk tekst til URL-venlig slug
function danishSlug(text) {
    return text
        .toLowerCase()
        .replace(/√¶/g, 'ae')
        .replace(/√∏/g, 'oe')
        .replace(/√•/g, 'aa')
        .replace(/\s+/g, '-')           // mellemrum ‚Üí bindestreg
        .replace(/[^a-z0-9-]/g, '')     // fjern ugyldige tegn
        .replace(/-+/g, '-')            // fjern multiple bindestreger
        .replace(/^-|-$/g, '');         // fjern bindestreg i start/slut
}

// Update "Anvend til" checkboxes in step 2 when purposes change in step 0
function updateServicePurposesUI() {
    const purposes = campaignConfig.selected_purposes || [];
    const hasGoogleAds = purposes.includes('google_ads');
    const hasSeo = purposes.includes('seo');
    const hasProgrammatic = purposes.includes('programmatic');
    const hasAnyRelevant = hasGoogleAds || hasSeo || hasProgrammatic;

    // Update each service card's "Anvend til" section
    $('.service-card.selected').each(function() {
        const serviceId = $(this).data('service-id');
        const purposesContainer = $(this).find('.service-purposes');

        // If no relevant purposes, hide the section
        if (!hasAnyRelevant) {
            purposesContainer.addClass('hidden');
            return;
        }

        // Build new checkboxes HTML based on selected purposes
        let checkboxesHtml = '';
        if (hasGoogleAds) {
            const isChecked = campaignConfig.service_purposes[serviceId]?.google_ads !== false;
            checkboxesHtml += `
                <label class="inline-flex items-center text-xs bg-green-50 px-2 py-1 rounded cursor-pointer hover:bg-green-100 transition-colors">
                    <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                           data-service-id="${serviceId}" data-purpose="google_ads" ${isChecked ? 'checked' : ''}>
                    <span class="text-green-700">Google Ads</span>
                </label>`;
        }
        if (hasSeo) {
            const isChecked = campaignConfig.service_purposes[serviceId]?.seo !== false;
            checkboxesHtml += `
                <label class="inline-flex items-center text-xs bg-orange-50 px-2 py-1 rounded cursor-pointer hover:bg-orange-100 transition-colors">
                    <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                           data-service-id="${serviceId}" data-purpose="seo" ${isChecked ? 'checked' : ''}>
                    <span class="text-orange-700">SEO</span>
                </label>`;
        }
        if (hasProgrammatic) {
            const isChecked = campaignConfig.service_purposes[serviceId]?.programmatic !== false;
            checkboxesHtml += `
                <label class="inline-flex items-center text-xs bg-purple-50 px-2 py-1 rounded cursor-pointer hover:bg-purple-100 transition-colors">
                    <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                           data-service-id="${serviceId}" data-purpose="programmatic" ${isChecked ? 'checked' : ''}>
                    <span class="text-purple-700">Byside</span>
                </label>`;
        }

        // Update the container content
        purposesContainer.html(`
            <p class="text-xs text-gray-500 mb-2">Anvend til:</p>
            <div class="flex flex-wrap gap-2">
                ${checkboxesHtml}
            </div>
        `);
        purposesContainer.removeClass('hidden');

        // Update service_purposes to match current purposes (add new ones as true)
        if (!campaignConfig.service_purposes[serviceId]) {
            campaignConfig.service_purposes[serviceId] = {};
        }
        if (hasGoogleAds && campaignConfig.service_purposes[serviceId].google_ads === undefined) {
            campaignConfig.service_purposes[serviceId].google_ads = true;
        }
        if (hasSeo && campaignConfig.service_purposes[serviceId].seo === undefined) {
            campaignConfig.service_purposes[serviceId].seo = true;
        }
        if (hasProgrammatic && campaignConfig.service_purposes[serviceId].programmatic === undefined) {
            campaignConfig.service_purposes[serviceId].programmatic = true;
        }
    });

    // Also update custom service purposes when purposes change
    // Re-render custom services to show updated purpose checkboxes
    if (campaignConfig.custom_services.length > 0) {
        renderCustomServices();
    }
}

// Get services filtered by a specific purpose
// Returns only services where that purpose is enabled
function getServicesForPurpose(purpose) {
    return campaignConfig.service_ids.filter(serviceId => {
        const purposes = campaignConfig.service_purposes[serviceId];
        // If no purposes set, include by default (backwards compatibility)
        if (!purposes) return true;
        return purposes[purpose] === true;
    });
}

// Get custom services (AI-suggested) filtered by a specific purpose
// Returns array of custom services where that purpose is enabled
function getCustomServicesForPurpose(purpose) {
    // Check if the purpose is in the user's selected purposes
    const isPurposeSelected = (campaignConfig.selected_purposes || []).includes(purpose);

    return campaignConfig.custom_services.filter((service, index) => {
        const purposes = campaignConfig.custom_service_purposes[index];

        // If no purposes set for this service, default to true if purpose is selected
        if (!purposes) {
            return isPurposeSelected;
        }

        // If the specific purpose is not defined, default to true if purpose is selected
        if (purposes[purpose] === undefined) {
            return isPurposeSelected;
        }

        return purposes[purpose] === true;
    }).map((service, index) => ({
        ...service,
        customIndex: campaignConfig.custom_services.indexOf(service)  // Track original index
    }));
}

// Get visible steps based on selected purposes
function getVisibleSteps() {
    // Base steps: 0 (purpose), 1 (website URL), 2 (industry/services), 3 (USPs)
    let steps = [0, 1, 2, 3];

    // Purpose-specific steps
    // Geo targeting for google_ads, company_description, eller programmatic
    if (campaignConfig.selected_purposes.includes('google_ads') ||
        campaignConfig.selected_purposes.includes('company_description') ||
        campaignConfig.selected_purposes.includes('programmatic')) {
        steps.push(4);  // Geo targeting step
    }
    // Campaign builder KUN for google_ads
    if (campaignConfig.selected_purposes.includes('google_ads')) {
        steps.push(6);  // Kampagne & Annoncebygger step
    }
    if (campaignConfig.selected_purposes.includes('company_description')) {
        steps.push(5);  // Virksomhedsinfo med AI (efter geo targeting)
    }
    if (campaignConfig.selected_purposes.includes('seo')) {
        steps.push(7);  // SEO info step
    }
    if (campaignConfig.selected_purposes.includes('programmatic')) {
        steps.push(8);  // Programmatic setup step
    }

    // Always add summary step at the end
    steps.push(9);  // Summary step

    // Sort steps to ensure correct order
    steps.sort((a, b) => a - b);

    return steps;
}

// Get total number of visible steps
function getMaxSteps() {
    return getVisibleSteps().length;
}

// Get the next visible step
function getNextVisibleStep(current) {
    const visibleSteps = getVisibleSteps();
    const currentIndex = visibleSteps.indexOf(current);
    if (currentIndex >= 0 && currentIndex < visibleSteps.length - 1) {
        return visibleSteps[currentIndex + 1];
    }
    return current;
}

// Get the previous visible step
function getPrevVisibleStep(current) {
    const visibleSteps = getVisibleSteps();
    const currentIndex = visibleSteps.indexOf(current);
    if (currentIndex > 0) {
        return visibleSteps[currentIndex - 1];
    }
    return current;
}

// Track which industries require authorization
let industriesRequiringAuth = {};  // {industry_id: industry_name}

// Initialize wizard
$(document).ready(async function() {
    // Try to restore saved state from localStorage
    const savedState = loadStateFromStorage();
    if (savedState) {
        console.log('Found saved state, restoring...');
        campaignConfig = savedState.campaignConfig;
        const targetStep = savedState.currentStep;

        // Set currentStep to 0 temporarily while restoring UI
        currentStep = 0;

        // Wait for UI restoration (including async service loading)
        await restoreUIFromState();

        // Now navigate to the saved step AFTER all data is loaded
        currentStep = targetStep;
        console.log('Navigating to saved step:', targetStep);
    }

    updateWizardState();
    setupEventListeners();
    initUspDisplayTexts(); // Format USP display texts to show default values instead of variable syntax

    // Setup reset button handler
    $('#reset-wizard-btn').on('click', function() {
        if (confirm('Er du sikker? Alle valg vil blive slettet.')) {
            clearSavedState();
            location.reload();
        }
    });

});

// Setup event listeners
function setupEventListeners() {
    // Purpose selection (multiple)
    $('.purpose-card').on('click', function() {
        $(this).toggleClass('selected');

        const purposeId = $(this).data('purpose');
        if ($(this).hasClass('selected')) {
            if (!campaignConfig.selected_purposes.includes(purposeId)) {
                campaignConfig.selected_purposes.push(purposeId);
            }
        } else {
            campaignConfig.selected_purposes = campaignConfig.selected_purposes.filter(p => p !== purposeId);
        }

        // Update purposes count
        const count = campaignConfig.selected_purposes.length;
        $('#purposes-count').text(count);
        if (count > 0) {
            $('#selected-purposes-summary').show();
        } else {
            $('#selected-purposes-summary').hide();
        }

        // Update "Anvend til" checkboxes in step 2 to match new purposes
        updateServicePurposesUI();

        console.log('Selected purposes:', campaignConfig.selected_purposes);
        debouncedSaveState(); // Auto-save on selection change
    });

    // Industry selection (multiple)
    $('.industry-card').on('click', function(e) {
        // Don't toggle if clicking on radio button or label
        if ($(e.target).hasClass('auth-radio') || $(e.target).closest('label').length > 0) {
            return;
        }

        $(this).toggleClass('selected');

        const industryId = $(this).data('industry-id');
        const requiresAuth = $(this).data('requires-auth') === true || $(this).data('requires-auth') === 'true';
        const authQuestion = $(this).find('.auth-question');

        if ($(this).hasClass('selected')) {
            // Add industry to selection
            if (!campaignConfig.industry_ids.includes(industryId)) {
                campaignConfig.industry_ids.push(industryId);
            }

            // Show auth question if this industry requires it
            if (requiresAuth) {
                authQuestion.slideDown(200);
                // Pre-fill if we have a previous answer
                const existingAnswer = campaignConfig.industry_authorizations[industryId];
                if (existingAnswer !== undefined) {
                    $(this).find(`input[name="auth-${industryId}"][value="${existingAnswer}"]`).prop('checked', true);
                }
            }
        } else {
            // Remove industry from selection
            campaignConfig.industry_ids = campaignConfig.industry_ids.filter(id => id !== industryId);
            // Hide auth question and clear selection
            authQuestion.slideUp(200);
            $(this).find('.auth-radio').prop('checked', false);
            // Remove authorization answer
            delete campaignConfig.industry_authorizations[industryId];

            // Remove services that belong to the deselected industry
            // Get services for this industry from DOM (service cards that will be removed)
            const servicesForRemovedIndustry = [];
            $(`.service-card`).each(function() {
                const serviceId = parseInt($(this).data('service-id'));
                // Check if this service's industry matches the removed industry
                // by looking at the industry badge text
                const industryBadge = $(this).find('.bg-purple-100.text-purple-800').text().trim();
                const removedIndustryCard = $(`.industry-card[data-industry-id="${industryId}"]`);
                const removedIndustryName = removedIndustryCard.find('h4').text().trim();

                if (industryBadge === removedIndustryName) {
                    servicesForRemovedIndustry.push(serviceId);
                }
            });

            campaignConfig.service_ids = campaignConfig.service_ids.filter(
                serviceId => !servicesForRemovedIndustry.includes(serviceId)
            );

            // Update Step 4 UI if it has been rendered
            const geoServicesContainer = document.querySelector('#geo-services-container');
            if (geoServicesContainer && geoServicesContainer.children.length > 0) {
                populateGeoServicesContainer();
            }
        }

        // Load services for all selected industries
        loadServicesForSelectedIndustries();

        // Show services section if any industries are selected
        if (campaignConfig.industry_ids.length > 0) {
            $('#services-section').show();
        } else {
            $('#services-section').hide();
        }
        debouncedSaveState(); // Auto-save on selection change
    });

    // Handle authorization radio button changes
    $(document).on('change', '.auth-radio', function() {
        const card = $(this).closest('.industry-card');
        const industryId = card.data('industry-id');
        const isAuthorized = $(this).val() === 'true';
        campaignConfig.industry_authorizations[industryId] = isAuthorized;
        console.log('Authorization updated:', industryId, isAuthorized);
        debouncedSaveState(); // Auto-save on authorization change
    });
    
    // Service selection (multiple)
    $(document).on('click', '.service-card', function(e) {
        // Don't toggle selection when clicking on purpose checkboxes
        if ($(e.target).hasClass('service-purpose-checkbox') || $(e.target).closest('label').find('.service-purpose-checkbox').length) {
            return;
        }

        $(this).toggleClass('selected');

        const serviceId = $(this).data('service-id');
        const purposesContainer = $(this).find('.service-purposes');

        if ($(this).hasClass('selected')) {
            if (!campaignConfig.service_ids.includes(serviceId)) {
                campaignConfig.service_ids.push(serviceId);
            }
            // Initialize service_purposes based on selected purposes from step 0
            if (!campaignConfig.service_purposes[serviceId]) {
                const purposes = campaignConfig.selected_purposes || [];
                campaignConfig.service_purposes[serviceId] = {
                    google_ads: purposes.includes('google_ads'),
                    seo: purposes.includes('seo'),
                    programmatic: purposes.includes('programmatic')
                };
            }
            // Show purpose checkboxes (only if we have relevant purposes)
            const hasPurposes = campaignConfig.selected_purposes.some(p =>
                ['google_ads', 'seo', 'programmatic'].includes(p)
            );
            if (hasPurposes) {
                purposesContainer.removeClass('hidden');
            }
        } else {
            campaignConfig.service_ids = campaignConfig.service_ids.filter(id => id !== serviceId);
            // Remove service_purposes entry
            delete campaignConfig.service_purposes[serviceId];
            // Hide purpose checkboxes
            purposesContainer.addClass('hidden');
        }

        // Step validation is handled in nextStep() function
        debouncedSaveState(); // Auto-save on selection change
    });

    // Service purpose checkbox change handler
    $(document).on('change', '.service-purpose-checkbox', function(e) {
        e.stopPropagation(); // Prevent triggering card click

        const serviceId = $(this).data('service-id');
        const purpose = $(this).data('purpose');
        const isChecked = $(this).is(':checked');

        // Ensure service_purposes entry exists
        if (!campaignConfig.service_purposes[serviceId]) {
            campaignConfig.service_purposes[serviceId] = {
                google_ads: true,
                seo: true,
                programmatic: true
            };
        }

        // Update the specific purpose
        campaignConfig.service_purposes[serviceId][purpose] = isChecked;

        console.log(`Service ${serviceId} purpose ${purpose} set to ${isChecked}`);
        debouncedSaveState();
    });
    
    // USP selection with variable rendering
    $('.usp-checkbox').on('change', function() {
        const uspId = parseInt($(this).data('usp-id'));
        const uspItem = $(this).closest('.usp-item');
        const displayText = uspItem.find('.usp-display-text');
        const editInput = uspItem.find('.usp-edit-input');
        const originalText = $(this).data('original-text');

        if ($(this).is(':checked')) {
            if (!campaignConfig.usp_ids.includes(uspId)) {
                campaignConfig.usp_ids.push(uspId);
            }

            // Check if USP has variables
            if (uspHasVariables(originalText)) {
                // Render with variable spans (hide old edit input)
                editInput.hide();
                displayText.html(renderUspWithVariables(originalText, uspId)).show();
                displayText.addClass('usp-has-variables');
            } else {
                // No variables - render as full-text editable span (same style as variable)
                editInput.hide();
                const currentText = campaignConfig.usp_custom_texts[uspId] || originalText;
                displayText.html(`<span class="usp-full-text" data-usp-id="${uspId}" data-original="${escapeHtml(originalText)}" title="Klik for at redigere">${escapeHtml(currentText)}</span>`).show();
                displayText.addClass('usp-has-full-text');
                campaignConfig.usp_custom_texts[uspId] = currentText;
            }
        } else {
            campaignConfig.usp_ids = campaignConfig.usp_ids.filter(id => id !== uspId);
            // Reset to display text (with default values substituted, no variable syntax)
            editInput.hide();
            const displayTextFormatted = uspHasVariables(originalText) ? getUspDisplayText(originalText) : originalText;
            displayText.text(displayTextFormatted).show();
            displayText.removeClass('usp-has-variables usp-has-full-text');
            // Remove custom values
            delete campaignConfig.usp_custom_texts[uspId];
            delete campaignConfig.usp_variable_values[uspId];
        }
        debouncedSaveState(); // Auto-save on USP selection change
    });

    // Update custom text when editing (for USPs without variables)
    $(document).on('input', '.usp-edit-input', function() {
        const uspItem = $(this).closest('.usp-item');
        const uspId = parseInt(uspItem.data('usp-id'));
        campaignConfig.usp_custom_texts[uspId] = $(this).val();
        debouncedSaveState(); // Auto-save on USP text edit
    });

    // Variable inline editing - click to edit
    $(document).on('click', '.usp-variable', function(e) {
        e.stopPropagation();
        startVariableEdit(this);
    });

    // Variable editing - save on blur
    $(document).on('blur', '.usp-variable-input', function() {
        saveVariableEdit($(this));
    });

    // Variable editing - save on Enter, cancel on Escape
    $(document).on('keydown', '.usp-variable-input', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveVariableEdit($(this));
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelVariableEdit($(this));
        }
    });

    // Full-text USP inline editing - click to edit
    $(document).on('click', '.usp-full-text', function(e) {
        e.stopPropagation();
        startFullTextEdit(this);
    });

    // Full-text editing - save on blur
    $(document).on('blur', '.usp-full-text-input', function() {
        saveFullTextEdit($(this));
    });

    // Full-text editing - save on Enter, cancel on Escape
    $(document).on('keydown', '.usp-full-text-input', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveFullTextEdit($(this));
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelFullTextEdit($(this));
        }
    });

    // Negative keyword list selection
    $('.negative-keyword-card').on('click', function() {
        $(this).toggleClass('selected');
        
        const listId = $(this).data('list-id');
        if ($(this).hasClass('selected')) {
            if (!campaignConfig.negative_keyword_list_ids.includes(listId)) {
                campaignConfig.negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.negative_keyword_list_ids = campaignConfig.negative_keyword_list_ids.filter(id => id !== listId);
        }
    });
    
    // Budget strategy selection (single)
    $('.budget-strategy-card').on('click', function() {
        $('.budget-strategy-card').removeClass('selected');
        $(this).addClass('selected');
        campaignConfig.budget_strategy_id = $(this).data('budget-id');
    });
    
    // Ad template selection (single)
    $('.ad-template-card').on('click', function() {
        $('.ad-template-card').removeClass('selected');
        $(this).addClass('selected');
        campaignConfig.ad_template_id = $(this).data('template-id');
    });
    
    // Geographic region selection (multiple)
    $('.geographic-region-card').on('click', function() {
        $(this).toggleClass('selected');

        const regionId = $(this).data('region-id');
        const regionName = $(this).data('region-name');
        const cities = $(this).data('cities') || [];

        if ($(this).hasClass('selected')) {
            if (!campaignConfig.geographic_region_ids.includes(regionId)) {
                campaignConfig.geographic_region_ids.push(regionId);
            }
            // Add region's cities to geo-map as a circle
            addRegionToGeoMap(regionId, regionName, cities);
        } else {
            campaignConfig.geographic_region_ids = campaignConfig.geographic_region_ids.filter(id => id !== regionId);
            // Remove region's circle from geo-map
            removeRegionFromGeoMap(regionId);
        }
    });

    // Custom USP - Add button click
    $('#add-custom-usp-btn').on('click', function() {
        addCustomUsp();
    });

    // Custom USP - Enter key in input
    $('#custom-usp-input').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            addCustomUsp();
        }
    });

    // Custom USP - Remove button (delegated)
    $(document).on('click', '.remove-custom-usp', function() {
        const index = $(this).data('index');
        removeCustomUsp(index);
    });

    // Custom USP - Click to edit (delegated)
    $(document).on('click', '.custom-usp-display-text', function() {
        const item = $(this).closest('.custom-usp-item');
        const displayText = item.find('.custom-usp-display-text');
        const editInput = item.find('.custom-usp-edit-input');

        displayText.hide();
        editInput.show().focus().select();
    });

    // Custom USP - Save on blur or Enter (delegated)
    $(document).on('blur', '.custom-usp-edit-input', function() {
        saveCustomUspEdit($(this));
    });

    $(document).on('keypress', '.custom-usp-edit-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).blur();
        }
    });

    // Custom USP - Cancel on Escape
    $(document).on('keydown', '.custom-usp-edit-input', function(e) {
        if (e.which === 27) {
            const index = $(this).data('index');
            const originalText = campaignConfig.custom_usps[index];
            $(this).val(originalText);
            $(this).blur();
        }
    });
}

// Add custom USP
function addCustomUsp() {
    const input = $('#custom-usp-input');
    const text = input.val().trim();

    if (!text) {
        alert('Indtast venligst en USP tekst');
        input.focus();
        return;
    }

    // Check for duplicates
    if (campaignConfig.custom_usps.includes(text)) {
        alert('Denne USP er allerede tilf√∏jet');
        return;
    }

    // Add to config
    campaignConfig.custom_usps.push(text);

    // Clear input
    input.val('');

    // Render custom USPs
    renderCustomUsps();

    console.log('Custom USPs:', campaignConfig.custom_usps);
}

// Remove custom USP
function removeCustomUsp(index) {
    campaignConfig.custom_usps.splice(index, 1);
    renderCustomUsps();
    console.log('Custom USPs:', campaignConfig.custom_usps);
}

// Save custom USP edit
function saveCustomUspEdit(input) {
    const index = input.data('index');
    const newText = input.val().trim();
    const item = input.closest('.custom-usp-item');
    const displayText = item.find('.custom-usp-display-text');

    if (newText && newText !== campaignConfig.custom_usps[index]) {
        // Check for duplicates (excluding current)
        const otherUsps = campaignConfig.custom_usps.filter((_, i) => i !== index);
        if (otherUsps.includes(newText)) {
            alert('Denne USP tekst findes allerede');
            input.val(campaignConfig.custom_usps[index]);
        } else {
            campaignConfig.custom_usps[index] = newText;
            displayText.text(newText);
            console.log('Custom USP updated:', campaignConfig.custom_usps);
        }
    } else if (!newText) {
        // Revert to original if empty
        input.val(campaignConfig.custom_usps[index]);
    }

    // Hide input, show text
    input.hide();
    displayText.show();
}

// Render custom USPs list
function renderCustomUsps() {
    const container = $('#custom-usps-container');
    container.empty();

    campaignConfig.custom_usps.forEach((usp, index) => {
        const html = `
            <div class="flex items-start p-3 bg-white rounded-lg border custom-usp-item" data-index="${index}">
                <span class="w-5 h-5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs flex items-center justify-center mt-0.5 flex-shrink-0">‚úì</span>
                <div class="flex-1 px-2">
                    <p class="font-medium text-gray-900 text-sm custom-usp-display-text cursor-pointer hover:text-purple-600" data-index="${index}">${escapeHtml(usp)}</p>
                    <input type="text" class="custom-usp-edit-input w-full px-2 py-1 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" style="display: none;" value="${escapeHtml(usp)}" data-index="${index}">
                </div>
                <button type="button" class="remove-custom-usp text-gray-400 hover:text-red-500 transition-colors flex-shrink-0" data-index="${index}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        `;
        container.append(html);
    });
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =====================================================
// USP Variable System Functions
// =====================================================

// Parse USP text and identify variables with format {VARIABEL:default}
function parseUspVariables(text) {
    const regex = /\{([A-Z√Ü√ò√Ö0-9_]+)(?::([^}]*))?\}/g;
    const variables = [];
    let match;
    while ((match = regex.exec(text)) !== null) {
        variables.push({
            fullMatch: match[0],
            name: match[1],
            defaultValue: match[2] || '',
            startIndex: match.index,
            endIndex: match.index + match[0].length
        });
    }
    return variables;
}

// Check if USP text contains variables
function uspHasVariables(text) {
    return parseUspVariables(text).length > 0;
}

// Get USP display text with default values substituted (plain text, no HTML)
// Used for showing the USP text when NOT selected (no interactive spans)
function getUspDisplayText(text) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        return text; // No variables, return as-is
    }

    let result = text;
    // Replace backwards to preserve indices
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        result = result.substring(0, v.startIndex) + v.defaultValue + result.substring(v.endIndex);
    }
    return result;
}

// Initialize USP display texts to show default values instead of variable syntax
function initUspDisplayTexts() {
    $('.usp-item').each(function() {
        const $item = $(this);
        const $checkbox = $item.find('.usp-checkbox');
        const $displayText = $item.find('.usp-display-text');

        // Only format if not already checked
        if (!$checkbox.is(':checked')) {
            const originalText = $checkbox.data('original-text');
            if (originalText && uspHasVariables(originalText)) {
                const displayText = getUspDisplayText(originalText);
                $displayText.text(displayText);
            }
        }
    });
}

// Render USP with clickable variable spans
function renderUspWithVariables(text, uspId) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        // No variables - return plain text (for custom USPs or USPs without variables)
        return escapeHtml(text);
    }

    let html = '';
    let lastIndex = 0;

    variables.forEach((v, idx) => {
        // Add static text before the variable
        if (v.startIndex > lastIndex) {
            html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex, v.startIndex))}</span>`;
        }

        // Get current value (user-set or default)
        const userValues = campaignConfig.usp_variable_values[uspId] || {};
        const currentValue = userValues[idx] !== undefined ? userValues[idx] : v.defaultValue;

        // Add clickable variable span
        html += `<span class="usp-variable"
                      data-usp-id="${uspId}"
                      data-var-name="${v.name}"
                      data-var-index="${idx}"
                      data-default="${escapeHtml(v.defaultValue)}"
                      title="Klik for at redigere ${v.name}">${escapeHtml(currentValue)}</span>`;

        lastIndex = v.endIndex;
    });

    // Add remaining static text after last variable
    if (lastIndex < text.length) {
        html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex))}</span>`;
    }

    return html;
}

// Get final USP text with all variables substituted
function getUspFinalText(uspId, originalText) {
    const variables = parseUspVariables(originalText);
    if (variables.length === 0) {
        // Check if there's a custom text override
        return campaignConfig.usp_custom_texts[uspId] || originalText;
    }

    const userValues = campaignConfig.usp_variable_values[uspId] || {};

    let result = originalText;
    // Replace backwards to preserve indices
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        const value = userValues[i] !== undefined ? userValues[i] : v.defaultValue;
        result = result.substring(0, v.startIndex) + value + result.substring(v.endIndex);
    }
    return result;
}

// Start inline editing of a variable
function startVariableEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const varIndex = $el.data('var-index');
    const varName = $el.data('var-name');
    const defaultValue = $el.data('default');

    // Get current value
    const userValues = campaignConfig.usp_variable_values[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    // Replace span content with input
    $el.addClass('editing');
    const inputWidth = Math.max(50, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="usp-variable-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;" placeholder="${escapeHtml(varName)}">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save variable edit
function saveVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');
    const newValue = $input.val().trim();

    // Initialize if needed
    if (!campaignConfig.usp_variable_values[uspId]) {
        campaignConfig.usp_variable_values[uspId] = {};
    }

    // Save value (or use default if empty)
    const valueToSave = newValue || defaultValue;
    campaignConfig.usp_variable_values[uspId][varIndex] = valueToSave;

    // Update span display
    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    console.log('Variable saved:', uspId, varIndex, valueToSave);
}

// Cancel variable edit
function cancelVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');

    // Get current saved value or default
    const userValues = campaignConfig.usp_variable_values[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    // Restore span display
    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// =====================================================
// Full-text USP Editing Functions (for USPs without variables)
// =====================================================

// Start inline editing of full-text USP
function startFullTextEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const originalText = $el.data('original');

    // Get current value
    const currentValue = campaignConfig.usp_custom_texts[uspId] || originalText;

    // Replace span content with input
    $el.addClass('editing');
    const inputWidth = Math.max(100, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="usp-full-text-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save full-text edit
function saveFullTextEdit($input) {
    const $span = $input.closest('.usp-full-text');
    const uspId = $span.data('usp-id');
    const originalText = $span.data('original');
    const newValue = $input.val().trim();

    // Save value (or use original if empty)
    const valueToSave = newValue || originalText;
    campaignConfig.usp_custom_texts[uspId] = valueToSave;

    // Update span display
    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    // Auto-save
    debouncedSaveState();

    console.log('Full-text USP saved:', uspId, valueToSave);
}

// Cancel full-text edit
function cancelFullTextEdit($input) {
    const $span = $input.closest('.usp-full-text');
    const uspId = $span.data('usp-id');
    const originalText = $span.data('original');

    // Get current saved value or original
    const currentValue = campaignConfig.usp_custom_texts[uspId] || originalText;

    // Restore span display
    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// Load services for all selected industries
function loadServicesForSelectedIndustries() {
    const servicesContainer = $('#services-container');

    // Check if we have any industries (DB or AI-suggested)
    const hasDbIndustries = campaignConfig.industry_ids.length > 0;
    const hasAiIndustries = (campaignConfig.suggested_industries || []).length > 0;

    if (!hasDbIndustries && !hasAiIndustries) {
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <p class="text-gray-500">V√¶lg mindst √©n branche for at se services</p>
            </div>
        `);
        return Promise.resolve();
    }

    // If only AI-suggested industries (no DB industries), show message and rely on custom_services
    if (!hasDbIndustries && hasAiIndustries) {
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-amber-100 rounded-full flex items-center justify-center">
                    <span class="text-2xl">‚ú®</span>
                </div>
                <p class="text-gray-700 font-medium">Kun AI-foresl√•ede brancher valgt</p>
                <p class="text-gray-500 text-sm mt-1">Dine services vises i "AI-Foresl√•ede Services" sektionen nedenfor</p>
            </div>
        `);
        $('#services-section').show();
        return Promise.resolve();
    }
    
    // Show loading state
    servicesContainer.html(`
        <div class="col-span-full text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"></div>
            <p class="text-gray-500 mt-2">Indl√¶ser services for ${campaignConfig.industry_ids.length} branche(r)...</p>
        </div>
    `);
    
    // Make parallel AJAX calls for all selected industries (services AND keywords)
    const servicePromises = campaignConfig.industry_ids.map(industryId => {
        return $.ajax({
            url: `/ajax/get-industry-services/${industryId}/`,
            method: 'GET'
        });
    });

    // Also fetch keywords for each industry in parallel
    const keywordPromises = campaignConfig.industry_ids.map(industryId => {
        return $.ajax({
            url: `/ajax/get-industry-keywords/${industryId}/`,
            method: 'GET'
        });
    });

    // Wait for both service and keyword requests to complete
    return Promise.all([
        Promise.all(servicePromises),
        Promise.all(keywordPromises)
    ]).then(([serviceResponses, keywordResponses]) => {
        // Store keywords in serverData
        keywordResponses.forEach((data, index) => {
            const industryId = campaignConfig.industry_ids[index];
            if (data && data.success) {
                serverData.google_keywords[industryId] = data.keywords || [];
                console.log(`Loaded ${data.keywords?.length || 0} keywords for industry ${industryId}`);
            }
        });

        // Continue processing services (convert to same format as before)
        const responses = serviceResponses.map(r => [r]);
        processServiceResponses(responses);
    }).catch(error => {
        console.error('Error loading industry data:', error);
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <p class="text-red-500">Der opstod en fejl ved indl√¶sning af data</p>
            </div>
        `);
    });
}

function processServiceResponses(responses) {
    const servicesContainer = $('#services-container');
    const responseArray = responses;

    console.log('AJAX responses received:', responseArray);

    let allServices = [];
    let industryNames = [];

    // Clear industriesRequiringAuth for currently selected industries
    // (will be repopulated below)
    campaignConfig.industry_ids.forEach(id => {
        delete industriesRequiringAuth[id];
    });

    responseArray.forEach((response, index) => {
        const data = response[0]; // AJAX response is wrapped in array
        const industryId = campaignConfig.industry_ids[index];
        console.log(`Processing industry ${industryId}:`, data);

        if (data && data.success) {
            industryNames.push(data.industry_name);
            data.services.forEach(service => {
                // Add industry info to service for display
                service.industry_name = data.industry_name;
                allServices.push(service);

                // Store in lookup map for later use (e.g., SEO Builder)
                serverData.services_by_id[service.id] = {
                    id: service.id,
                    name: service.name,
                    description: service.description,
                    industry_name: service.industry_name,
                    keyword_count: service.keyword_count,
                    color: service.color || '#8B5CF6'
                };
            });

            // Track if this industry requires authorization
            console.log(`Industry ${industryId} requires_authorization:`, data.requires_authorization);
            if (data.requires_authorization) {
                industriesRequiringAuth[industryId] = data.industry_name;
                console.log('Added to industriesRequiringAuth:', industriesRequiringAuth);
            }
        }
    });

    if (allServices.length === 0) {
        // No services available in any selected industry
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-gray-500 mb-4">Ingen services tilg√¶ngelige i de valgte brancher</p>
                <p class="text-sm text-gray-400">Valgte brancher: ${industryNames.join(', ')}</p>
                <p class="text-sm text-gray-400 mt-2">Du kan tilf√∏je services i <a href="/industry-manager/" class="text-purple-600 hover:text-purple-700 font-medium">Industry Manager</a></p>
            </div>
        `);
    } else {
        // Sort services alphabetically for clean display
        allServices.sort((a, b) => a.name.localeCompare(b.name));

        let servicesHtml = '';

        // Display all services in a clean list without industry headers
        allServices.forEach(service => {
            servicesHtml += `
                <div class="selection-card p-4 rounded-lg border-2 service-card" data-service-id="${service.id}">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${service.name}</h4>
                            <p class="text-sm text-gray-500">${service.description || 'Ingen beskrivelse'}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${service.keyword_count} keywords
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    ${service.industry_name}
                                </span>
                            </div>
                            <!-- Purpose checkboxes (shown when selected, only for selected purposes) -->
                            ${(() => {
                                const purposes = campaignConfig.selected_purposes || [];
                                const hasGoogleAds = purposes.includes('google_ads');
                                const hasSeo = purposes.includes('seo');
                                const hasProgrammatic = purposes.includes('programmatic');

                                // Only show section if at least one relevant purpose is selected
                                if (!hasGoogleAds && !hasSeo && !hasProgrammatic) return '';

                                let checkboxes = '';
                                if (hasGoogleAds) {
                                    checkboxes += `
                                        <label class="inline-flex items-center text-xs bg-green-50 px-2 py-1 rounded cursor-pointer hover:bg-green-100 transition-colors">
                                            <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                                                   data-service-id="${service.id}" data-purpose="google_ads" checked>
                                            <span class="text-green-700">Google Ads</span>
                                        </label>`;
                                }
                                if (hasSeo) {
                                    checkboxes += `
                                        <label class="inline-flex items-center text-xs bg-orange-50 px-2 py-1 rounded cursor-pointer hover:bg-orange-100 transition-colors">
                                            <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                                                   data-service-id="${service.id}" data-purpose="seo" checked>
                                            <span class="text-orange-700">SEO</span>
                                        </label>`;
                                }
                                if (hasProgrammatic) {
                                    checkboxes += `
                                        <label class="inline-flex items-center text-xs bg-purple-50 px-2 py-1 rounded cursor-pointer hover:bg-purple-100 transition-colors">
                                            <input type="checkbox" class="service-purpose-checkbox w-3 h-3 mr-1"
                                                   data-service-id="${service.id}" data-purpose="programmatic" checked>
                                            <span class="text-purple-700">Byside</span>
                                        </label>`;
                                }

                                return `
                                    <div class="service-purposes hidden mt-3 pt-3 border-t border-gray-200" data-service-id="${service.id}">
                                        <p class="text-xs text-gray-500 mb-2">Anvend til:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${checkboxes}
                                        </div>
                                    </div>`;
                            })()}
                        </div>
                    </div>
                </div>
            `;
        });

        servicesContainer.html(servicesHtml);

        // Restore service selections from saved state (after DOM is updated)
        campaignConfig.service_ids.forEach(serviceId => {
            const card = $(`.service-card[data-service-id="${serviceId}"]`);
            card.addClass('selected');

            // Show the purpose checkboxes container
            const purposesContainer = card.find('.service-purposes');
            purposesContainer.removeClass('hidden');

            // Restore checkbox states from service_purposes
            const purposes = campaignConfig.service_purposes[serviceId];
            if (purposes) {
                Object.entries(purposes).forEach(([purpose, isEnabled]) => {
                    const checkbox = purposesContainer.find(`.service-purpose-checkbox[data-purpose="${purpose}"]`);
                    checkbox.prop('checked', isEnabled);
                });
            }
        });
    }
}

// Navigation functions
async function nextStep() {
    const visibleSteps = getVisibleSteps();
    const lastStep = visibleSteps[visibleSteps.length - 1];

    if (currentStep < lastStep) {
        if (validateCurrentStep()) {
            // When leaving Step 1 (Website URL) with a URL, scrape and detect services first
            if (currentStep === 1 && crawlState.website_url && campaignConfig.service_detection.status === 'idle') {
                // Show loading state
                $('#next-btn').prop('disabled', true).html(`
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyserer hjemmeside...
                `);

                try {
                    await scrapeAndDetectServices();
                } catch (error) {
                    console.error('[Service Detection] Error:', error);
                }

                // Reset button
                $('#next-btn').prop('disabled', false).text('N√¶ste ‚Üí');
            }

            // Start background USP analysis when leaving Step 1 (Website URL)
            if (currentStep === 1 && crawlState.website_url && campaignConfig.usp_analysis.status === 'idle') {
                startBackgroundUspAnalysis();
            }

            // Start background crawl when leaving Step 3 (USPs)
            if (currentStep === 3 && crawlState.website_url && crawlState.crawl_status === 'idle') {
                startBackgroundCrawl();
            }

            currentStep = getNextVisibleStep(currentStep);
            updateWizardState();
            saveStateToStorage(); // Save state on step change

            // Apply service detection when arriving at Step 2 (Industries/Services)
            if (currentStep === 2 && campaignConfig.service_detection.status === 'success' && !campaignConfig.service_detection.applied) {
                applyServiceDetection();
            }

            // Special handling for final step (summary)
            if (currentStep === 9) {  // Summary step (var 10, nu 9)
                generateCampaignSummary();
            }
        }
    }
}

function previousStep() {
    if (currentStep > 0) {
        currentStep = getPrevVisibleStep(currentStep);
        updateWizardState();
        saveStateToStorage(); // Save state on step change
    }
}

// Go to a specific step (for navigation links)
function goToStep(stepNumber) {
    const visibleSteps = getVisibleSteps();
    if (visibleSteps.includes(stepNumber)) {
        currentStep = stepNumber;
        updateWizardState();
        saveStateToStorage();
    }
}

// Validate current step
function validateCurrentStep() {
    switch(currentStep) {
        case 0:  // Purpose selection
            if (campaignConfig.selected_purposes.length === 0) {
                alert('V√¶lg venligst mindst √©t form√•l f√∏r du forts√¶tter.');
                return false;
            }
            return true;
        case 1:  // Website URL (NEW - optional, no validation required)
            return true;
        case 2:  // Industry & Services (was case 1)
            // Check if user has selected at least one industry (from DB OR AI-suggested)
            const hasDbIndustry = campaignConfig.industry_ids.length > 0;
            const hasAiIndustry = (campaignConfig.suggested_industries || []).length > 0;
            if (!hasDbIndustry && !hasAiIndustry) {
                alert('V√¶lg venligst mindst √©n branche f√∏r du forts√¶tter.');
                return false;
            }
            // Check if user has selected at least one service (from DB OR AI-suggested/custom)
            const hasDbService = campaignConfig.service_ids.length > 0;
            const hasAiService = (campaignConfig.custom_services || []).length > 0;
            if (!hasDbService && !hasAiService) {
                alert('V√¶lg mindst √©n service f√∏r du forts√¶tter.');
                return false;
            }

            // Check if all authorization questions are answered
            const authRequired = getIndustriesRequiringAuthorization();
            for (const ind of authRequired) {
                if (campaignConfig.industry_authorizations[ind.id] === undefined) {
                    alert(`Angiv venligst om virksomheden er autoriseret ${ind.name}`);
                    // Scroll to the card and highlight
                    const card = $(`.industry-card[data-industry-id="${ind.id}"]`);
                    card[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.find('.auth-question').addClass('bg-red-50 border border-red-200 rounded p-2');
                    setTimeout(() => {
                        card.find('.auth-question').removeClass('bg-red-50 border border-red-200 rounded p-2');
                    }, 3000);
                    return false;
                }
            }

            return true;
        case 3:  // USPs
            if (campaignConfig.usp_ids.length === 0) {
                alert('V√¶lg mindst √©n USP f√∏r du forts√¶tter.');
                return false;
            }
            return true;
        case 4:  // Geographic Targeting (flyttet fra step 5)
            // Region is optional if user has manually selected cities via the map
            const hasRegionsSelected = campaignConfig.geographic_region_ids.length > 0;
            const hasManualCities = campaignConfig.geo_map_targeting?.postal_codes?.length > 0;

            if (!hasRegionsSelected && !hasManualCities) {
                alert('V√¶lg mindst √©n geografisk region eller v√¶lg byer manuelt p√• kortet.');
                return false;
            }
            // Save geo config settings
            campaignConfig.geo_config.create_byside_urls = true;  // Altid auto-genereret
            campaignConfig.geo_config.url_pattern = $('#url-pattern').val() || '/{SERVICE}/{BYNAVN}/';
            // Collect enabled services for geo campaigns
            campaignConfig.geo_config.enabled_services = [];
            $('.geo-service-checkbox:checked').each(function() {
                campaignConfig.geo_config.enabled_services.push(parseInt($(this).data('service-id')));
            });
            // Auto-generer byside URLs til brug i Programmatic step
            generateBysideUrls();
            return true;
        case 5:  // Company Info med AI (flyttet fra step 4)
            if (!$('#core-competencies').val().trim()) {
                alert('Indtast venligst virksomhedsbeskrivelse.');
                $('#core-competencies').focus();
                return false;
            }
            // Save to config
            campaignConfig.company_info.core_competencies = $('#core-competencies').val().trim();
            return true;
        case 6:  // Campaign & Ad Builder (var 7)
            // Validate that campaigns have been initialized
            if (Object.keys(campaignConfig.campaigns).length === 0) {
                alert('Der er ingen kampagner at konfigurere. G√• tilbage og v√¶lg brancher og services.');
                return false;
            }
            // Save campaign configurations from UI first
            saveCampaignsFromUI();

            // Validate each campaign is 100% complete
            const MIN_HEADLINES = 5;
            const MAX_HEADLINES = 15;
            const MIN_DESCRIPTIONS = 4;
            const validationErrors = [];

            // Get custom services that have Google Ads enabled for filtering
            const googleAdsCustomServices = getCustomServicesForPurpose('google_ads');
            const googleAdsCustomServiceNames = new Set(
                googleAdsCustomServices.map(s => s.name.toLowerCase())
            );

            for (const [industryId, campaign] of Object.entries(campaignConfig.campaigns)) {
                const campaignName = campaign.industry_name || `Kampagne ${industryId}`;
                const isAiCampaign = industryId.startsWith('ai_');

                // For AI campaigns, check if any of its services have Google Ads enabled
                if (isAiCampaign) {
                    const hasGoogleAdsServices = Object.values(campaign.ad_groups || {}).some(adGroup => {
                        const serviceName = (adGroup.service_name || '').toLowerCase();
                        return googleAdsCustomServiceNames.has(serviceName);
                    });
                    // Skip entire AI campaign if no services have Google Ads enabled
                    if (!hasGoogleAdsServices) {
                        continue;
                    }
                }

                // Check daily budget
                if (!campaign.daily_budget || campaign.daily_budget <= 0) {
                    validationErrors.push(`${campaignName}: Dagligt budget er p√•kr√¶vet`);
                }

                // Check each ad group
                for (const [serviceId, adGroup] of Object.entries(campaign.ad_groups || {})) {
                    const adGroupName = adGroup.service_name || `Annoncegruppe ${serviceId}`;

                    // For AI ad groups, skip validation if the service doesn't have Google Ads enabled
                    if (isAiCampaign) {
                        const serviceName = (adGroup.service_name || '').toLowerCase();
                        if (!googleAdsCustomServiceNames.has(serviceName)) {
                            continue;  // Skip this ad group - service doesn't have Google Ads enabled
                        }
                    }

                    const headlineCount = (adGroup.headlines || []).length;
                    const descriptionCount = (adGroup.descriptions || []).length;

                    if (headlineCount < MIN_HEADLINES) {
                        validationErrors.push(`${campaignName} ‚Üí ${adGroupName}: Mangler ${MIN_HEADLINES - headlineCount} overskrifter (har ${headlineCount}, min ${MIN_HEADLINES})`);
                    } else if (headlineCount > MAX_HEADLINES) {
                        validationErrors.push(`${campaignName} ‚Üí ${adGroupName}: For mange overskrifter (har ${headlineCount}, maks ${MAX_HEADLINES})`);
                    }
                    if (descriptionCount < MIN_DESCRIPTIONS) {
                        validationErrors.push(`${campaignName} ‚Üí ${adGroupName}: Mangler ${MIN_DESCRIPTIONS - descriptionCount} beskrivelser (har ${descriptionCount}/${MIN_DESCRIPTIONS})`);
                    }
                }
            }

            if (validationErrors.length > 0) {
                alert('F√∏lgende felter mangler at blive udfyldt:\n\n' + validationErrors.join('\n'));
                return false;
            }
            return true;
        case 7:  // SEO Info - Page-based structure
            // Check that all SEO pages have meta title and description
            // Use allSeoPageKeys (page paths) instead of service IDs
            if (!allSeoPageKeys || allSeoPageKeys.length === 0) {
                // No SEO pages, allow to continue
                return true;
            }

            // Check each page
            for (const page of allSeoPageKeys) {
                const seoPage = campaignConfig.seo_pages[page.path];
                if (!seoPage || !seoPage.meta_title || !seoPage.meta_title.trim()) {
                    const pageName = page.page_title || page.path;
                    alert(`Indtast venligst meta titel for "${pageName}"`);
                    setActiveSeoPage(page.path);
                    return false;
                }
                if (!seoPage.meta_description || !seoPage.meta_description.trim()) {
                    const pageName = page.page_title || page.path;
                    alert(`Indtast venligst meta beskrivelse for "${pageName}"`);
                    setActiveSeoPage(page.path);
                    return false;
                }
            }
            return true;
        case 8:  // Programmatic Byside (var 9)
            // Brug byer fra Geo-Kampagne Ops√¶tning (Step 4)
            const cities = getSelectedCities();
            if (cities.length === 0) {
                alert('V√¶lg f√∏rst byer i Geo-Kampagne Ops√¶tning (Step 4)');
                return false;
            }
            // Gem byerne til programmatic_info for kompatibilitet
            campaignConfig.programmatic_info.selected_cities = cities;
            return true;
        default:
            return true;
    }
}

// Update wizard state
function updateWizardState() {
    // Hide all step content
    $('.step-content').hide();

    // Show current step content
    $(`#step-content-${currentStep}`).show().addClass('animate-fade-in');

    // Get visible steps for progress calculation
    const visibleSteps = getVisibleSteps();
    const currentStepIndex = visibleSteps.indexOf(currentStep);
    const maxSteps = visibleSteps.length;

    // Update progress bar
    const progressPercent = ((currentStepIndex + 1) / maxSteps) * 100;
    $('#wizard-progress').css('width', `${progressPercent}%`);

    // Step descriptions based on step number
    const stepDescriptions = {
        0: 'V√¶lg form√•l',
        1: 'Website URL',
        2: 'Brancher og services',
        3: 'USPs',
        4: 'Geo-Kampagne Ops√¶tning',
        5: 'Virksomhedsbeskrivelse',
        6: 'Kampagne & Annoncebygger',
        7: 'SEO information',
        8: 'Programmatic byside',
        9: 'Opsummering'
    };

    $('#current-step').text(currentStepIndex + 1);
    $('#step-description').text(stepDescriptions[currentStep] || 'Step');

    // Update progress text with total steps
    $('p.text-sm.text-gray-500.mt-2').html(
        `Step <span id="current-step">${currentStepIndex + 1}</span> of ${maxSteps} - <span id="step-description">${stepDescriptions[currentStep] || 'Step'}</span>`
    );

    // Update navigation buttons
    if (currentStep === 0) {
        $('#prev-btn').hide();
    } else {
        $('#prev-btn').show();
    }

    const lastStep = visibleSteps[visibleSteps.length - 1];
    if (currentStep === lastStep) {
        $('#next-btn').hide();
        $('#create-campaign-btn').show();
    } else {
        $('#next-btn').show();
        $('#create-campaign-btn').hide();
    }

    // Initialize Step 7 (Programmatic Byside) when shown
    if (currentStep === 7) {
        initStep7FromGeoAndUsps();
    }

    // Apply USP suggestions when entering Step 3
    if (currentStep === 3) {
        if (campaignConfig.usp_analysis.status === 'success' && !campaignConfig.usp_analysis.applied) {
            setTimeout(applyUspSuggestions, 200);
        }
        updateUspAnalysisStatusUI();
    }
}

// Initialize Step 7 with data from Step 4 (Geo) and Step 2 (USPs)
function initStep7FromGeoAndUsps() {
    // Function kept for compatibility - summaries removed from UI
}

// Generate campaign summary for final step
function generateCampaignSummary() {
    const summaryContainer = $('#campaign-summary');
    const exportContainer = $('#export-options-container');

    // Build summary HTML based on selected purposes
    let summaryHtml = `
        <div class="bg-white rounded-lg p-6 border border-gray-200 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üéØ Valgte Form√•l</h3>
            <div class="flex flex-wrap gap-2">
                ${campaignConfig.selected_purposes.map(p => {
                    const purpose = PURPOSES[p];
                    return `<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">${purpose.icon} ${purpose.name}</span>`;
                }).join('')}
            </div>
        </div>

        <div class="bg-white rounded-lg p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìã Konfiguration</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üè¢ Brancher & Services</h4>
                    <p class="text-sm text-gray-600 mb-1">Brancher: ${campaignConfig.industry_ids.length + (campaignConfig.suggested_industries || []).length} valgt${(campaignConfig.suggested_industries || []).length > 0 ? ` <span class="text-amber-600">(${(campaignConfig.suggested_industries || []).length} AI)</span>` : ''}</p>
                    <p class="text-sm text-gray-600">Services: ${campaignConfig.service_ids.length + (campaignConfig.custom_services || []).length} valgt${(campaignConfig.custom_services || []).length > 0 ? ` <span class="text-purple-600">(${(campaignConfig.custom_services || []).length} AI)</span>` : ''}</p>
                </div>

                <div>
                    <h4 class="font-medium text-gray-900 mb-2">‚≠ê USPs</h4>
                    <p class="text-sm text-gray-600">USPs: ${campaignConfig.usp_ids.length} valgt</p>
                </div>
    `;

    // Add purpose-specific summaries
    if (campaignConfig.selected_purposes.includes('company_description')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üìù Virksomhedsinfo</h4>
                    <p class="text-sm text-gray-600">Beskrivelse: ${campaignConfig.company_info.core_competencies ? 'Udfyldt' : 'Ikke udfyldt'}</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('google_ads')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üí∞ Google Ads</h4>
                    <p class="text-sm text-gray-600 mb-1">Budget strategi: ${campaignConfig.budget_strategy_id ? 'Valgt' : 'Ikke valgt'}</p>
                    <p class="text-sm text-gray-600 mb-1">Ad template: ${campaignConfig.ad_template_id ? 'Valgt' : 'Ikke valgt'}</p>
                    <p class="text-sm text-gray-600">Regioner: ${campaignConfig.geographic_region_ids.length} valgt</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('seo')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üîç SEO</h4>
                    <p class="text-sm text-gray-600 mb-1">Website: ${campaignConfig.seo_info.website_url || 'Ikke udfyldt'}</p>
                    <p class="text-sm text-gray-600">Keywords: ${campaignConfig.seo_info.focus_keywords.length} stk</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('programmatic')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üåç Programmatic Byside</h4>
                    <p class="text-sm text-gray-600">Byer: ${campaignConfig.programmatic_info.selected_cities.length} valgt</p>
                </div>
        `;
    }

    summaryHtml += `
            </div>
        </div>
    `;

    summaryContainer.html(summaryHtml);

    // Generate export buttons based on selected purposes
    let exportHtml = '';

    if (campaignConfig.selected_purposes.includes('company_description')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="generateCompanyPrompt()">
                <h4 class="font-medium text-white mb-2">üìù Generer ChatGPT Prompt</h4>
                <p class="text-blue-100 text-sm">Gener√©r virksomhedsbeskrivelse prompt</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('google_ads')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="exportGoogleAdsCsv()">
                <h4 class="font-medium text-white mb-2">üìä Google Ads Editor CSV</h4>
                <p class="text-green-100 text-sm">Eksport√©r til Google Ads Editor format</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('seo')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-orange-600 to-orange-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="generateSeoReport()">
                <h4 class="font-medium text-white mb-2">üîç SEO Rapport</h4>
                <p class="text-orange-100 text-sm">Gener√©r SEO analyse og meta-forslag</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('programmatic')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="exportProgrammaticFiles()">
                <h4 class="font-medium text-white mb-2">üåç WordPress Byside Export</h4>
                <p class="text-purple-100 text-sm">Download CSV til WP All Import</p>
            </button>
        `;
    }

    exportContainer.html(exportHtml);
}

// Export functions
function exportCampaign(format) {
    console.log('Exporting campaign:', format, campaignConfig);
    alert(`Eksporterer kampagne i ${format} format...`);
}

// Purpose-specific export functions
function generateCompanyPrompt() {
    console.log('Generating company description prompt...', campaignConfig.company_info);
    alert('Genererer ChatGPT prompt... (Backend integration kommer i n√¶ste fase)');
}

async function exportGoogleAdsCsv() {
    console.log('Exporting Google Ads CSV...', campaignConfig);

    // Valider at der er kampagner at eksportere
    if (!campaignConfig.campaigns || Object.keys(campaignConfig.campaigns).length === 0) {
        showToast('Ingen kampagner at eksportere. Gennemf√∏r wizard f√∏rst.', 'error');
        return;
    }

    try {
        showToast('Genererer Google Ads fil...', 'info');

        const response = await fetch('/export-campaign-builder-csv/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(campaignConfig)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Export fejlede');
        }

        // Download filen
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // F√• filnavn fra Content-Disposition header
        const disposition = response.headers.get('Content-Disposition');
        let filename = 'Google_Ads_Export.csv';
        if (disposition && disposition.includes('filename=')) {
            const match = disposition.match(/filename="?([^"]+)"?/);
            if (match) filename = match[1];
        }

        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showToast('Google Ads fil downloadet!', 'success');

    } catch (error) {
        console.error('Export error:', error);
        showToast('Fejl ved eksport: ' + error.message, 'error');
    }
}

function generateSeoReport() {
    console.log('Generating SEO report...', campaignConfig.seo_info);
    alert('Genererer SEO rapport... (Backend integration kommer i n√¶ste fase)');
}

// Toast notification function
function showToast(message, type = 'success') {
    // Remove any existing toasts
    $('.toast-notification').remove();

    const bgColor = type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-amber-500' : 'bg-blue-500';

    let iconSvg;
    if (type === 'success') {
        iconSvg = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>`;
    } else if (type === 'warning') {
        iconSvg = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>`;
    } else {
        iconSvg = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`;
    }

    const toast = $(`
        <div class="toast-notification fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 z-50 transform translate-y-0 opacity-100 transition-all duration-300">
            ${iconSvg}
            <span>${message}</span>
        </div>
    `);

    $('body').append(toast);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.css({ transform: 'translateY(20px)', opacity: '0' });
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Helper function to get cookie value (for CSRF token)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// =====================================================
// Client Data Loading & Saving
// =====================================================

async function loadClientData() {
    const clientId = $('#client-select').val();
    if (!clientId) {
        showToast('V√¶lg en kunde f√∏rst', 'warning');
        return;
    }

    const btn = $('#load-client-btn');
    const originalHtml = btn.html();
    btn.prop('disabled', true).html(`
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Indl√¶ser...
    `);

    try {
        const response = await fetch(`/ajax/clients/${clientId}/campaign-data/`);
        const data = await response.json();

        if (data.success) {
            console.log('Loading full campaign config from client:', data);

            // If we have a full campaign_config saved, restore it
            if (data.campaign_config && Object.keys(data.campaign_config).length > 0) {
                // Deep merge campaign_config into local campaignConfig
                // This preserves any new fields in the local object while restoring saved data
                const savedConfig = data.campaign_config;

                // Restore all campaign config fields
                campaignConfig.client_id = parseInt(clientId);
                campaignConfig.selected_purposes = savedConfig.selected_purposes || [];
                campaignConfig.industry_ids = savedConfig.industry_ids || [];
                campaignConfig.service_ids = savedConfig.service_ids || [];
                campaignConfig.service_purposes = savedConfig.service_purposes || {};
                campaignConfig.usp_ids = savedConfig.usp_ids || [];
                campaignConfig.usp_custom_texts = savedConfig.usp_custom_texts || {};
                campaignConfig.usp_variable_values = savedConfig.usp_variable_values || {};
                campaignConfig.custom_usps = savedConfig.custom_usps || [];
                campaignConfig.custom_services = savedConfig.custom_services || [];
                campaignConfig.custom_service_purposes = savedConfig.custom_service_purposes || {};
                campaignConfig.suggested_industries = savedConfig.suggested_industries || [];
                campaignConfig.negative_keyword_list_ids = savedConfig.negative_keyword_list_ids || [];
                campaignConfig.budget_strategy_id = savedConfig.budget_strategy_id || null;
                campaignConfig.ad_template_id = savedConfig.ad_template_id || null;
                campaignConfig.geographic_region_ids = savedConfig.geographic_region_ids || [];
                campaignConfig.industry_authorizations = savedConfig.industry_authorizations || {};

                // Restore nested objects
                if (savedConfig.company_info) {
                    campaignConfig.company_info = { ...campaignConfig.company_info, ...savedConfig.company_info };
                }
                if (savedConfig.seo_info) {
                    campaignConfig.seo_info = { ...campaignConfig.seo_info, ...savedConfig.seo_info };
                }
                if (savedConfig.seo_pages) {
                    campaignConfig.seo_pages = savedConfig.seo_pages;
                }
                if (savedConfig.programmatic_info) {
                    campaignConfig.programmatic_info = { ...campaignConfig.programmatic_info, ...savedConfig.programmatic_info };
                }
                if (savedConfig.geo_config) {
                    campaignConfig.geo_config = { ...campaignConfig.geo_config, ...savedConfig.geo_config };
                }
                if (savedConfig.campaigns) {
                    campaignConfig.campaigns = savedConfig.campaigns;
                }
                if (savedConfig.custom_negative_keywords) {
                    campaignConfig.custom_negative_keywords = savedConfig.custom_negative_keywords;
                }
                if (savedConfig.template_ad_group) {
                    campaignConfig.template_ad_group = savedConfig.template_ad_group;
                }
                if (savedConfig.usp_analysis) {
                    campaignConfig.usp_analysis = { ...campaignConfig.usp_analysis, ...savedConfig.usp_analysis };
                }
                if (savedConfig.service_detection) {
                    campaignConfig.service_detection = { ...campaignConfig.service_detection, ...savedConfig.service_detection };
                }
                if (savedConfig.geo_map_targeting) {
                    campaignConfig.geo_map_targeting = savedConfig.geo_map_targeting;
                }

                // Restore crawlState from scraped_data if available
                if (data.scraped_data) {
                    crawlState.scraped_pages = data.scraped_data.scraped_pages || {};
                    crawlState.extracted_reviews = data.scraped_data.extracted_reviews || [];
                    crawlState.sitemap_urls = data.scraped_data.sitemap_urls || [];
                    crawlState.urls_found = data.scraped_data.urls_found || 0;
                    crawlState.city_matches = data.scraped_data.city_matches || [];
                }

                // Pre-fill website URL
                if (data.website_url) {
                    crawlState.website_url = data.website_url;
                }

                console.log('Restored campaignConfig:', campaignConfig);

                // Run all UI restore handlers to update the interface
                await restoreUIFromState();

                // Show feedback
                $('#client-loaded-name').text(`${data.name} - alle data indl√¶st`);
                $('#client-loaded-feedback').removeClass('hidden');
                showToast(`Kunde "${data.name}" - alle kampagne data indl√¶st`, 'success');
            } else {
                // Fallback: No saved campaign_config, use individual fields
                campaignConfig.client_id = parseInt(clientId);

                // Pre-fill website URL
                if (data.website_url) {
                    crawlState.website_url = data.website_url;
                    $('#website-url-input').val(data.website_url);
                }

                // Restore company profile if exists
                if (data.company_profile) {
                    campaignConfig.company_info.profile = data.company_profile;
                }

                // Restore selected purposes
                if (data.selected_purposes && data.selected_purposes.length > 0) {
                    campaignConfig.selected_purposes = data.selected_purposes;
                    data.selected_purposes.forEach(purpose => {
                        $(`.purpose-card[data-purpose="${purpose}"]`).addClass('selected');
                    });
                    const count = data.selected_purposes.length;
                    $('#purposes-count').text(count);
                    $('#selected-purposes-summary').toggle(count > 0);
                }

                // Restore geographic regions
                if (data.geographic_regions && data.geographic_regions.length > 0) {
                    campaignConfig.geographic_region_ids = data.geographic_regions;
                }

                // Restore detected services
                if (data.detected_services) {
                    campaignConfig.custom_services = data.detected_services;
                }

                // Restore detected USPs
                if (data.detected_usps) {
                    campaignConfig.usp_analysis.matched_usps = data.detected_usps;
                }

                // Show feedback
                $('#client-loaded-name').text(`${data.name} - basis data indl√¶st`);
                $('#client-loaded-feedback').removeClass('hidden');
                showToast(`Kunde "${data.name}" indl√¶st (basis data)`, 'success');
            }

            debouncedSaveState();
        } else {
            showToast('Fejl ved indl√¶sning: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error loading client data:', error);
        showToast('Fejl ved indl√¶sning af kunde data', 'error');
    } finally {
        btn.prop('disabled', false).html(originalHtml);
    }
}

async function saveAsClient() {
    let clientName = '';

    // If new client, ask for name
    if (!campaignConfig.client_id) {
        clientName = prompt('Indtast kundenavn:');
        if (!clientName) {
            showToast('Kundenavn er p√•kr√¶vet', 'warning');
            return;
        }
    }

    const btn = $('#save-as-client-btn');
    const originalHtml = btn.html();
    btn.prop('disabled', true).html(`
        <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Gemmer...
    `);

    const data = {
        client_id: campaignConfig.client_id,
        name: clientName,
        website_url: crawlState.website_url || '',
        description: campaignConfig.company_info?.core_competencies || '',
        company_profile: campaignConfig.company_info?.profile || {},
        detected_services: campaignConfig.custom_services || [],
        detected_usps: campaignConfig.usp_analysis?.matched_usps || [],
        selected_purposes: campaignConfig.selected_purposes || [],
        geographic_regions: campaignConfig.geographic_region_ids || [],
        selected_services: campaignConfig.service_ids || [],
        selected_usps: campaignConfig.usp_ids || [],
        campaign_config: campaignConfig  // Full backup
    };

    try {
        const response = await fetch('/ajax/clients/save-from-builder/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            campaignConfig.client_id = result.client_id;

            // Update dropdown to show client is saved
            if (clientName) {
                $('#client-select').append(`<option value="${result.client_id}" selected>${clientName}</option>`);
            }

            showToast('Kunde gemt!', 'success');

            // Show link to client profile
            $('#client-saved-link').removeClass('hidden');
            $('#client-profile-link').attr('href', `/clients/${result.client_id}/`);
        } else {
            showToast('Fejl: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error saving client:', error);
        showToast('Fejl ved gemning af kunde', 'error');
    } finally {
        btn.prop('disabled', false).html(originalHtml);
    }
}

// =====================================================
// AI Company Description Generation
// =====================================================

async function generateCompanyDescriptionAI() {
    const btn = $('#generate-description-btn');
    const originalBtnHtml = btn.html();

    // Collect data from previous steps
    const requestData = {
        website_url: crawlState.website_url || '',
        industries: getSelectedIndustryNames(),
        services: getSelectedServiceNames(),
        usps: getSelectedUspTexts(),
        geographic_areas: getSelectedGeographicAreas()
    };

    // Validate we have enough data
    if (!requestData.industries.length && !requestData.services.length) {
        showToast('V√¶lg brancher og services for at generere beskrivelse', 'warning');
        return;
    }

    // Show loading state with Roberto
    btn.prop('disabled', true);
    btn.html('<span class="animate-spin inline-block mr-2">‚è≥</span> Roberto arbejder...');

    // Show Roberto loading animation
    showRobertoLoading('company_research');

    try {
        const response = await fetch('/ajax/generate-company-description/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        });

        // Update button text for generation phase
        btn.html('<span class="animate-spin inline-block mr-2">‚è≥</span> Genererer beskrivelse...');

        const data = await response.json();

        if (data.success) {
            // Populate the description field
            $('#core-competencies').val(data.description);
            $('#description-source-badge').removeClass('hidden').text('AI-genereret');

            // Save to config
            campaignConfig.company_info.core_competencies = data.description;
            campaignConfig.company_info.ai_generated = true;

            // Save and display profile JSON if available (for use in other AI prompts)
            if (data.profile && Object.keys(data.profile).length > 0) {
                // Ensure ALL selected cities are included (AI may truncate the list)
                const allSelectedAreas = getSelectedGeographicAreas();
                if (allSelectedAreas.length > 0) {
                    if (!data.profile.geografisk_daekning) {
                        data.profile.geografisk_daekning = {};
                    }
                    // Always use the actual selected cities, not AI's truncated version
                    data.profile.geografisk_daekning.alle_byer = allSelectedAreas;
                }

                // Also ensure ALL USPs are included
                const allUsps = getSelectedUspTexts();
                if (allUsps.length > 0 && data.profile.usps) {
                    // Add any USPs that AI missed
                    const existingUspTexts = data.profile.usps.map(u => u.usp || u);
                    allUsps.forEach(uspText => {
                        if (!existingUspTexts.includes(uspText)) {
                            data.profile.usps.push({
                                usp: uspText,
                                kategori: 'andet',
                                konkret_detalje: null
                            });
                        }
                    });
                }

                // Ensure ALL services are included (AI may truncate the list)
                const allServices = getSelectedServiceNames();
                if (allServices.length > 0) {
                    if (!data.profile.virksomhed) {
                        data.profile.virksomhed = {};
                    }
                    // Always use the actual selected services, not AI's truncated version
                    data.profile.virksomhed.alle_services = allServices;
                }

                // Also ensure ALL industries are included
                const allIndustries = getSelectedIndustryNames();
                if (allIndustries.length > 0) {
                    if (!data.profile.virksomhed) {
                        data.profile.virksomhed = {};
                    }
                    data.profile.virksomhed.alle_brancher = allIndustries;
                }

                campaignConfig.company_info.profile = data.profile;
                renderProfileJson(data.profile);
            }

            // Display key points if available
            if (data.key_points && data.key_points.length > 0) {
                renderKeyPoints(data.key_points);
                campaignConfig.company_info.key_points = data.key_points;
            }

            // Show appropriate success message with model info
            const modelInfo = data.model_used ? ` (Model: ${data.model_used})` : '';
            if (data.used_research) {
                showToast(`Beskrivelse genereret med online research!${modelInfo}`, 'success');
            } else {
                showToast(`Beskrivelse genereret!${modelInfo}`, 'success');
            }
            debouncedSaveState();
        } else {
            showToast('Fejl: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('AI generation error:', error);
        showToast('Kunne ikke generere beskrivelse', 'error');
    } finally {
        btn.prop('disabled', false);
        btn.html(originalBtnHtml);
        hideRobertoLoading();
    }
}

function getSelectedIndustryNames() {
    const names = [];
    // Database industries
    campaignConfig.industry_ids.forEach(id => {
        const card = $(`.industry-card[data-industry-id="${id}"]`);
        const name = card.find('h4').text().trim();
        if (name) names.push(name);
    });
    // AI-suggested industries (not in database)
    if (campaignConfig.suggested_industries && campaignConfig.suggested_industries.length > 0) {
        campaignConfig.suggested_industries.forEach(industryName => {
            if (industryName && !names.includes(industryName)) {
                names.push(industryName);
            }
        });
    }
    return names;
}

function getSelectedServiceNames() {
    const names = [];
    // Database services
    campaignConfig.service_ids.forEach(id => {
        if (serverData.services_by_id && serverData.services_by_id[id]) {
            const service = serverData.services_by_id[id];
            if (service && service.name) {
                names.push(service.name);
            }
        }
    });
    // AI-suggested/custom services (not in database)
    if (campaignConfig.custom_services && campaignConfig.custom_services.length > 0) {
        campaignConfig.custom_services.forEach(cs => {
            if (cs && cs.name && !names.includes(cs.name)) {
                names.push(cs.name);
            }
        });
    }
    return names;
}

function getSelectedUspTexts() {
    const texts = [];
    const addedTexts = new Set(); // Avoid duplicates

    // 1. Selected USP templates from usp_ids
    campaignConfig.usp_ids.forEach(uspId => {
        let text = null;

        // First check for custom edited text
        if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
            text = campaignConfig.usp_custom_texts[uspId];
        } else {
            // Try to get from DOM
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            const originalText = checkbox.data('original-text');
            if (originalText) {
                text = getUspFinalText ? getUspFinalText(uspId, originalText) : originalText;
            } else {
                // Fallback: try display text
                const displayText = checkbox.closest('.usp-item').find('.usp-display-text').text().trim();
                if (displayText) text = displayText;
            }
        }

        if (text && !addedTexts.has(text)) {
            texts.push(text);
            addedTexts.add(text);
        }
    });

    // 2. Custom USPs (user-added and AI-suggested)
    if (campaignConfig.custom_usps && campaignConfig.custom_usps.length > 0) {
        campaignConfig.custom_usps.forEach(usp => {
            if (usp && !addedTexts.has(usp)) {
                texts.push(usp);
                addedTexts.add(usp);
            }
        });
    }

    // 3. AI-analyzed USPs that may not have been applied yet
    if (campaignConfig.usp_analysis && campaignConfig.usp_analysis.status === 'success') {
        // Add custom USPs from AI analysis
        if (campaignConfig.usp_analysis.custom_usps) {
            campaignConfig.usp_analysis.custom_usps.forEach(item => {
                const uspText = item.text || item;
                if (uspText && !addedTexts.has(uspText)) {
                    texts.push(uspText);
                    addedTexts.add(uspText);
                }
            });
        }
    }

    return texts;
}

function getSelectedGeographicAreas() {
    const areas = [];
    const addedAreas = new Set(); // Avoid duplicates

    // 1. Region names from geographic_region_ids
    campaignConfig.geographic_region_ids.forEach(id => {
        // Try to get from DOM
        const card = $(`.geographic-region-card[data-region-id="${id}"]`);
        let name = card.data('region-name');

        // Fallback: try to get from card title
        if (!name) {
            name = card.find('h4').text().trim();
        }

        if (name && !addedAreas.has(name)) {
            areas.push(name);
            addedAreas.add(name);
        }
    });

    // 2. Manual geo map selections (postal names = city names)
    if (campaignConfig.geo_map_targeting && campaignConfig.geo_map_targeting.postal_names) {
        campaignConfig.geo_map_targeting.postal_names.forEach(name => {
            if (name && !addedAreas.has(name)) {
                areas.push(name);
                addedAreas.add(name);
            }
        });
    }

    // 3. Also include negative city list source cities if available
    if (campaignConfig.negative_city_source_cities && campaignConfig.negative_city_source_cities.length > 0) {
        campaignConfig.negative_city_source_cities.forEach(name => {
            if (name && !addedAreas.has(name)) {
                areas.push(name);
                addedAreas.add(name);
            }
        });
    }

    return areas;
}

function renderKeyPoints(keyPoints) {
    const container = $('#key-points-container');
    container.empty();

    keyPoints.forEach(point => {
        container.append(`
            <div class="flex items-start p-2 bg-gray-50 rounded-lg">
                <span class="w-5 h-5 rounded-full bg-purple-100 text-purple-600 text-xs flex items-center justify-center mt-0.5 mr-2">‚úì</span>
                <span class="text-sm text-gray-700">${escapeHtml(point)}</span>
            </div>
        `);
    });

    $('#key-points-section').removeClass('hidden');
}

function renderProfileJson(profile) {
    if (!profile || Object.keys(profile).length === 0) {
        $('#profile-json-section').addClass('hidden');
        return;
    }

    // Format JSON with nice indentation
    const formattedJson = JSON.stringify(profile, null, 2);
    $('#profile-json-display').text(formattedJson);
    $('#profile-json-section').removeClass('hidden');

    // Collapse by default
    $('#profile-json-content').addClass('hidden');
    $('#profile-toggle-icon').removeClass('rotate-180');
}

function toggleProfileJson() {
    const content = $('#profile-json-content');
    const icon = $('#profile-toggle-icon');

    if (content.hasClass('hidden')) {
        content.removeClass('hidden');
        icon.addClass('rotate-180');
    } else {
        content.addClass('hidden');
        icon.removeClass('rotate-180');
    }
}

function copyProfileJson() {
    const jsonText = $('#profile-json-display').text();
    navigator.clipboard.writeText(jsonText).then(() => {
        showToast('JSON kopieret til udklipsholder', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Kunne ikke kopiere JSON', 'error');
    });
}

function updateCompanyInfo() {
    campaignConfig.company_info.core_competencies = $('#core-competencies').val().trim();
    debouncedSaveState();
}

// Export WordPress CSV - KUN manglende byer (smart eksport)
function exportProgrammaticFiles() {
    console.log('Exporting WordPress CSV (kun manglende byer)...', programmaticState);

    const selectedCities = getSelectedCities();
    const serviceName = getServiceNameForProgrammatic() || 'service';
    const usps = getActiveUsps();

    // Determine which cities to export
    let citiesToExport = [];

    if (programmaticState.city_matches && programmaticState.city_matches.length > 0) {
        // Smart export: Only selected missing pages (from checkboxes)
        if (programmaticState.selected_new_cities && programmaticState.selected_new_cities.length > 0) {
            citiesToExport = programmaticState.selected_new_cities;
        } else {
            // Fallback: all missing cities
            const missingCities = programmaticState.city_matches.filter(m => m.status === 'missing');
            citiesToExport = missingCities.map(m => m.city);
        }

        if (citiesToExport.length === 0) {
            showToast('Ingen nye bysider valgt! V√¶lg mindst √©n by fra listen.', 'info');
            return;
        }

        const skippedCount = programmaticState.existing_count + (programmaticState.missing_count - citiesToExport.length);
        if (skippedCount > 0) {
            showToast(`${skippedCount} sider springes over (eksisterende eller fravalgte).`, 'info');
        }
    } else {
        // No sitemap crawl done - export all selected cities
        if (selectedCities.length === 0) {
            showToast('Ingen byer valgt. V√¶lg f√∏rst byer i Geo-Kampagne Ops√¶tning (Step 4).', 'error');
            return;
        }
        citiesToExport = selectedCities;
    }

    // Brug AI-genererede meta tags hvis tilg√¶ngelige, ellers fallback til default
    const metaTitles = programmaticState.generated_meta_titles.length > 0
        ? programmaticState.generated_meta_titles
        : getDefaultMetaTitles(serviceName, usps);

    const metaDescs = programmaticState.generated_meta_descriptions.length > 0
        ? programmaticState.generated_meta_descriptions
        : getDefaultMetaDescriptions(serviceName, usps);

    // Opret CSV content til WordPress WP All Import med varierede meta tags
    // Bruger semikolon som separator for korrekt Excel-import i Danmark
    let csv = 'post_title;post_name;bynavn;service;meta_title;meta_description\n';

    citiesToExport.forEach((cityName, index) => {
        const urlSlug = `${serviceName.toLowerCase().replace(/\s+/g, '-')}-${cityName.toLowerCase().replace(/\s+/g, '-').replace(/√¶/g, 'ae').replace(/√∏/g, 'oe').replace(/√•/g, 'aa')}`;

        // Modulo fordeling for variation: titel og beskrivelse offset med 3
        const titleVariant = index % metaTitles.length;
        const descVariant = (index + 3) % metaDescs.length;

        // Meta title: Erstat {BYNAVN} placeholder
        const metaTitle = metaTitles[titleVariant]
            .replace(/{BYNAVN}/g, cityName)
            .replace(/{SERVICE}/g, serviceName);

        // Meta description: Erstat {BYNAVN} placeholder
        const metaDescription = metaDescs[descVariant]
            .replace(/{BYNAVN}/g, cityName)
            .replace(/{SERVICE}/g, serviceName);

        // Escape semikolon i v√¶rdier og brug semikolon som separator
        const escapeValue = (val) => val.replace(/"/g, '""');
        csv += `"${escapeValue(serviceName)} ${escapeValue(cityName)}";"${escapeValue(urlSlug)}";"${escapeValue(cityName)}";"${escapeValue(serviceName)}";"${escapeValue(metaTitle)}";"${escapeValue(metaDescription)}"\n`;
    });

    // Download filen med UTF-8 BOM for korrekt dansk tegn-encoding i Excel
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `wordpress-bysider-${citiesToExport.length}-byer.csv`;
    link.click();

    showToast(`Eksporteret ${citiesToExport.length} bysider til WordPress import med USPs og meta tags.`, 'success');
}

// Export Google Ads CSV - ALLE byer (med korrekt Final URL)
function exportGoogleAdsCsv() {
    console.log('Exporting Google Ads CSV (alle byer)...', programmaticState);

    const selectedCities = getSelectedCities();
    if (selectedCities.length === 0) {
        showToast('Ingen byer valgt. V√¶lg f√∏rst byer i Geo-Kampagne Ops√¶tning (Step 4).', 'error');
        return;
    }

    const serviceName = getServiceNameForProgrammatic() || 'service';
    const websiteUrl = $('#programmatic-website-url').val().trim() || '';

    // Build CSV for Google Ads Editor import (semikolon som separator for dansk Excel)
    let csv = 'Campaign;Ad Group;Keyword;Match Type;Final URL;Headline 1;Headline 2;Description 1\n';

    const escapeValue = (val) => val.replace(/"/g, '""');

    selectedCities.forEach(cityName => {
        // Check if city has existing page
        const match = programmaticState.city_matches?.find(m => m.city === cityName);
        let finalUrl;

        if (match && match.existing_url) {
            // Use existing URL
            finalUrl = match.existing_url.startsWith('http') ? match.existing_url : (websiteUrl + match.existing_url);
        } else {
            // Generate new URL
            const urlSlug = `${serviceName.toLowerCase().replace(/\s+/g, '-')}-${cityName.toLowerCase().replace(/\s+/g, '-').replace(/√¶/g, 'ae').replace(/√∏/g, 'oe').replace(/√•/g, 'aa')}`;
            finalUrl = websiteUrl ? `${websiteUrl.replace(/\/$/, '')}/${urlSlug}/` : `/${urlSlug}/`;
        }

        // Process templates - default headlines og description baseret p√• service og by
        const headline1 = `${serviceName} ${cityName}`;
        const headline2 = `Professionel ${serviceName}`;
        const description1 = `Professionel ${serviceName} i ${cityName}. Ring for gratis tilbud!`;

        const campaignName = `${serviceName} - Geo`;
        const adGroupName = cityName;
        const keyword = `${serviceName} ${cityName}`;

        csv += `"${escapeValue(campaignName)}";"${escapeValue(adGroupName)}";"${escapeValue(keyword)}";"Phrase";"${escapeValue(finalUrl)}";"${escapeValue(headline1)}";"${escapeValue(headline2)}";"${escapeValue(description1)}"\n`;
    });

    // Download med UTF-8 BOM for korrekt dansk tegn-encoding
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `google-ads-geo-${selectedCities.length}-byer.csv`;
    link.click();

    const existingCount = programmaticState.city_matches?.filter(m => m.status === 'existing').length || 0;
    const missingCount = selectedCities.length - existingCount;

    showToast(`Eksporteret ${selectedCities.length} byer til Google Ads (${existingCount} med eksist. URL, ${missingCount} med ny URL).`, 'success');
}

// Create campaign function
function createCampaign() {
    console.log('Creating campaign with config:', campaignConfig);
    alert('Kampagne oprettes... (Backend integration kommer i n√¶ste fase)');
}

// NOTE: Programmatic Byside Helper Functions (selectAllCities, etc.) are defined in the Step 7
// section below (around line 8730) to avoid duplication and maintain better organization.

// =====================================================
// Authorization Functions
// =====================================================

// Get industries that require authorization (always show modal, even if already answered)
function getIndustriesRequiringAuthorization() {
    return campaignConfig.industry_ids
        .filter(id => industriesRequiringAuth[id])  // Only industries that require auth
        // REMOVED: .filter(id => campaignConfig.industry_authorizations[id] === undefined)
        // Modal skal ALTID vises s√• brugeren kan bekr√¶fte/√¶ndre sit valg
        .map(id => ({ id: id, name: industriesRequiringAuth[id] }));
}

// Show authorization modal with pre-filled answers if they exist
function showAuthorizationModal(industries) {
    // BUGFIX: Flyt modal til body for at undg√• overflow/position problemer
    // Modalen er placeret inde i block content som er nested i en max-w container
    // som forhindrer fixed positioning i at virke korrekt
    const modal = document.getElementById('authorization-modal');
    if (modal && modal.parentElement !== document.body) {
        document.body.appendChild(modal);
    }

    const questionsHtml = industries.map(ind => {
        // Tjek om der allerede er et svar for denne branche
        const existingAnswer = campaignConfig.industry_authorizations[ind.id];
        const yesChecked = existingAnswer === true ? 'checked' : '';
        const noChecked = existingAnswer === false ? 'checked' : '';

        return `
            <div class="auth-question bg-gray-50 rounded-lg p-4" data-industry-id="${ind.id}">
                <p class="font-medium text-gray-900 mb-3">Er virksomheden autoriseret ${ind.name}?</p>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="auth-${ind.id}" value="true" class="auth-radio w-5 h-5 text-green-600 focus:ring-green-500" ${yesChecked}>
                        <span class="text-green-700 font-medium">Ja, autoriseret</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="auth-${ind.id}" value="false" class="auth-radio w-5 h-5 text-gray-600 focus:ring-gray-500" ${noChecked}>
                        <span class="text-gray-700">Nej</span>
                    </label>
                </div>
            </div>
        `;
    }).join('');

    $('#authorization-questions').html(questionsHtml);

    // Fjern hidden klasse OG s√¶t display: flex eksplicit for at tvinge visning
    const $modal = $('#authorization-modal');
    $modal.removeClass('hidden');
    modal.style.display = 'flex';

    console.log('showAuthorizationModal: Modal should now be visible');
    console.log('- Modal classes:', modal.className);
    console.log('- Modal display style:', modal.style.display);
    console.log('- Modal computed display:', window.getComputedStyle(modal).display);

    updateAuthModalConfirmButton();
}

// Update confirm button state based on whether all questions are answered
function updateAuthModalConfirmButton() {
    const totalQuestions = $('.auth-question').length;
    const answeredQuestions = $('.auth-radio:checked').length;
    const allAnswered = totalQuestions === answeredQuestions;
    $('#auth-modal-confirm').prop('disabled', !allAnswered);
}

// Initialize authorization modal event handlers
$(document).ready(function() {
    // Update confirm button when radio changes
    $(document).on('change', '.auth-radio', updateAuthModalConfirmButton);

    // Cancel button
    $('#auth-modal-cancel').on('click', function() {
        $('#authorization-modal').addClass('hidden').css('display', 'none');
    });

    // Confirm button - save answers and continue
    $('#auth-modal-confirm').on('click', function() {
        // Save the answers
        $('.auth-question').each(function() {
            const industryId = $(this).data('industry-id');
            const value = $(this).find('.auth-radio:checked').val() === 'true';
            campaignConfig.industry_authorizations[industryId] = value;
        });

        // Close modal
        $('#authorization-modal').addClass('hidden').css('display', 'none');

        // Continue to next step
        currentStep++;
        updateWizardState();
    });
});

// =====================================================
// Campaign & Ad Builder Functions (Step 5)
// =====================================================

// Store fetched data for industries and services
let fetchedIndustryData = {};

// Initialize campaigns when entering step 5
function initializeCampaignsBuilder() {
    console.log('Initializing campaigns builder...');
    console.log('Selected industries:', campaignConfig.industry_ids);
    console.log('Selected services:', campaignConfig.service_ids);

    const container = $('#campaigns-builder-container');
    container.html('<p class="text-gray-500 text-center py-8">Indl√¶ser kampagne data...</p>');

    // Fetch industry and service data for building campaigns
    fetchCampaignBuilderData().then(() => {
        renderCampaignsBuilder();
    }).catch(err => {
        console.error('Error fetching campaign builder data:', err);
        container.html('<p class="text-red-500 text-center py-8">Fejl ved indl√¶sning af data. Pr√∏v at g√• tilbage og frem igen.</p>');
    });
}

// Fetch all data needed for campaign builder
async function fetchCampaignBuilderData() {
    // Fetch data for each selected industry
    const promises = campaignConfig.industry_ids.map(industryId =>
        $.ajax({
            url: `/ajax/get-industry-services/${industryId}/`,
            method: 'GET'
        }).then(response => {
            fetchedIndustryData[industryId] = response;
            return response;
        })
    );

    // Also fetch negative keyword lists
    const negKeywordsPromise = $.ajax({
        url: '/ajax/get-negative-keyword-lists/',
        method: 'GET'
    }).then(response => {
        serverData.negative_keyword_lists = response.lists || [];
        return response;
    }).catch(() => {
        serverData.negative_keyword_lists = [];
    });

    promises.push(negKeywordsPromise);

    // Fetch keywords for each selected service that has Google Ads enabled
    const googleAdsServiceIds = getServicesForPurpose('google_ads');
    const serviceKeywordsPromises = googleAdsServiceIds.map(serviceId =>
        $.ajax({
            url: `/ajax/get-service-keywords/${serviceId}/`,
            method: 'GET'
        }).then(response => {
            // Store keywords per serviceId (not industryId)
            serverData.google_keywords[serviceId] = response.keywords || [];
            return response;
        }).catch(() => {
            serverData.google_keywords[serviceId] = [];
        })
    );

    promises.push(...serviceKeywordsPromises);

    await Promise.all(promises);
}

// State for new sidebar UI
let activeCampaignKey = null;
let allCampaignKeys = [];

// State for SEO Builder (Step 7) - PAGE-BASED structure
let activeSeoPagePath = null;  // Active page path (e.g., "/", "/privatflytning/")
let allSeoPageKeys = [];  // [{path, page_title, services: [{name, color, isCustom}], color}]

// Hent default negative keyword list IDs baseret p√• valgte Google Ads services
// Returnerer IDs for lister der er tilknyttet de valgte services + by-listen
function getDefaultNegativeKeywordListIds() {
    const selectedServiceIds = getServicesForPurpose('google_ads');
    const defaultIds = [];

    if (!serverData.negative_keyword_lists) return defaultIds;

    serverData.negative_keyword_lists.forEach(list => {
        // Inkluder by-listen hvis den eksisterer
        if (list.is_city_list && list.keyword_count > 0) {
            defaultIds.push(list.id);
            return;
        }

        // Inkluder lister der er tilknyttet mindst √©n af de valgte services
        const connectedIds = list.connected_service_ids || [];
        if (connectedIds.some(sid => selectedServiceIds.includes(sid))) {
            defaultIds.push(list.id);
        }
    });

    return defaultIds;
}

// Render the campaigns builder UI - NEW SIDEBAR VERSION
function renderCampaignsBuilder() {
    const legacyContainer = $('#campaigns-builder-container');
    legacyContainer.empty();

    // Group services by industry - only include services enabled for Google Ads
    const googleAdsServices = getServicesForPurpose('google_ads');
    const servicesByIndustry = {};

    // Add DB industries
    campaignConfig.industry_ids.forEach(industryId => {
        const industryData = fetchedIndustryData[industryId];
        if (industryData && industryData.success) {
            const filteredServices = industryData.services.filter(s =>
                googleAdsServices.includes(s.id)
            );
            // Only add industry if it has services enabled for Google Ads
            if (filteredServices.length > 0) {
                servicesByIndustry[industryId] = {
                    name: industryData.industry_name,
                    services: filteredServices
                };
            }
        }
    });

    // Add AI-suggested industries with their custom services
    // ONLY include custom services that have Google Ads enabled in their purpose settings
    const googleAdsCustomServices = getCustomServicesForPurpose('google_ads');
    const assignedCustomServices = new Set();

    (campaignConfig.suggested_industries || []).forEach(industryName => {
        // Create a unique key for AI-suggested industries (use name as key with prefix)
        const aiIndustryKey = `ai_${industryName.toLowerCase().replace(/\s+/g, '_')}`;

        // Get custom services for this AI industry (only those with Google Ads enabled)
        const aiServices = googleAdsCustomServices
            .filter(s => s.industry?.toLowerCase() === industryName.toLowerCase())
            .map((s) => {
                assignedCustomServices.add(s.name.toLowerCase());
                const originalIndex = s.customIndex !== undefined ? s.customIndex : campaignConfig.custom_services.indexOf(s);
                return {
                    id: `ai_${originalIndex}_${s.name.toLowerCase().replace(/\s+/g, '_')}`,
                    name: s.name,
                    description: s.evidence || '',
                    ai_suggested: true,
                    confidence: s.confidence,
                    customIndex: originalIndex
                };
            });

        if (aiServices.length > 0) {
            servicesByIndustry[aiIndustryKey] = {
                name: `${industryName} ‚ú®`,
                services: aiServices,
                ai_suggested: true
            };
        }
    });

    // Handle orphan custom services (services without a matching suggested industry)
    // Only include those with Google Ads enabled
    const orphanServices = googleAdsCustomServices
        .filter(s => !assignedCustomServices.has(s.name.toLowerCase()))
        .map((s) => {
            const originalIndex = s.customIndex !== undefined ? s.customIndex : campaignConfig.custom_services.indexOf(s);
            return {
                id: `ai_orphan_${originalIndex}_${s.name.toLowerCase().replace(/\s+/g, '_')}`,
                name: s.name,
                description: s.evidence || '',
                ai_suggested: true,
                confidence: s.confidence,
                customIndex: originalIndex
            };
        });

    if (orphanServices.length > 0) {
        servicesByIndustry['ai_other'] = {
            name: 'Andre AI Services ‚ú®',
            services: orphanServices,
            ai_suggested: true
        };
    }

    // Reset campaign keys
    allCampaignKeys = [];

    // Create a campaign for each industry
    Object.keys(servicesByIndustry).forEach(industryId => {
        const industryInfo = servicesByIndustry[industryId];

        // Get list of service IDs that should have Google Ads enabled
        const googleAdsServiceIds = industryInfo.services.map(s => s.id);

        // Initialize campaign config if not exists
        if (!campaignConfig.campaigns[industryId]) {
            // Hent default negative keyword list IDs baseret p√• valgte services
            const defaultNegListIds = getDefaultNegativeKeywordListIds();

            campaignConfig.campaigns[industryId] = {
                industry_id: parseInt(industryId),
                industry_name: industryInfo.name,
                daily_budget: '',
                bidding_strategy: 'maximize_clicks',
                target_cpa: null,
                negative_keyword_list_ids: defaultNegListIds,  // Pre-v√¶lg tilknyttede lister
                ad_groups: {},
                approved: false
            };

            // Initialize ad groups for each service
            industryInfo.services.forEach(service => {
                const serviceKeywords = serverData.google_keywords[service.id] || [];

                const adGroupKeywords = serviceKeywords.map(kw => ({
                    id: kw.id,
                    keyword: kw.keyword_text,
                    match_type: kw.match_type,
                    is_primary: kw.is_primary
                }));

                campaignConfig.campaigns[industryId].ad_groups[service.id] = {
                    service_id: service.id,
                    service_name: service.name,
                    keywords: adGroupKeywords,
                    headlines: [],
                    descriptions: [],
                    approved: false
                };
            });
        } else {
            // SYNC existing campaign with current Google Ads services
            const existingAdGroups = campaignConfig.campaigns[industryId].ad_groups;

            // Remove ad_groups for services no longer enabled for Google Ads
            Object.keys(existingAdGroups).forEach(serviceId => {
                if (!googleAdsServiceIds.includes(parseInt(serviceId))) {
                    console.log(`Removing ad_group for service ${serviceId} (Google Ads disabled)`);
                    delete existingAdGroups[serviceId];
                }
            });

            // Add ad_groups for new services enabled for Google Ads
            industryInfo.services.forEach(service => {
                if (!existingAdGroups[service.id]) {
                    console.log(`Adding ad_group for service ${service.id} (Google Ads enabled)`);
                    const serviceKeywords = serverData.google_keywords[service.id] || [];

                    const adGroupKeywords = serviceKeywords.map(kw => ({
                        id: kw.id,
                        keyword: kw.keyword_text,
                        match_type: kw.match_type,
                        is_primary: kw.is_primary
                    }));

                    existingAdGroups[service.id] = {
                        service_id: service.id,
                        service_name: service.name,
                        keywords: adGroupKeywords,
                        headlines: [],
                        descriptions: [],
                        approved: false
                    };
                }
            });
        }

        // Add to campaign keys list
        allCampaignKeys.push({ type: 'industry', id: industryId, name: industryInfo.name });
    });

    // Add GEO campaigns
    if (campaignConfig.geo_config && campaignConfig.geo_config.create_byside_urls &&
        campaignConfig.geo_config.byside_urls_by_service &&
        Object.keys(campaignConfig.geo_config.byside_urls_by_service).length > 0) {

        if (!campaignConfig.geo_campaigns) {
            campaignConfig.geo_campaigns = {};
        }

        Object.entries(campaignConfig.geo_config.byside_urls_by_service).forEach(([serviceId, urls]) => {
            if (!urls || urls.length === 0) return;

            const serviceName = urls[0]?.serviceName || 'Service';

            if (!campaignConfig.geo_campaigns[serviceId]) {
                // Hent default negative keyword list IDs baseret p√• valgte services
                const defaultNegListIds = getDefaultNegativeKeywordListIds();

                campaignConfig.geo_campaigns[serviceId] = {
                    name: `${serviceName} - GEO Kampagne`,
                    daily_budget: '',
                    bidding_strategy: 'maximize_clicks',
                    target_cpa: null,
                    match_type: 'phrase',
                    negative_keyword_list_ids: defaultNegListIds,  // Pre-v√¶lg tilknyttede lister
                    serviceId: serviceId,
                    serviceName: serviceName,
                    approved: false,
                    ad_group: {
                        name: 'GEO Annoncegruppe',
                        keywords: urls.map(item => ({
                            keyword: item.keyword,
                            url: item.url,
                            city: item.city,
                            match_type: 'phrase'
                        })),
                        headlines: [],
                        descriptions: []
                    }
                };
            }

            // Add to campaign keys list
            allCampaignKeys.push({ type: 'geo', id: serviceId, name: `${serviceName} - GEO` });
        });

        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[firstServiceId];
        }
    }

    // Render sidebar navigation
    renderCampaignSidebar();

    // Set active campaign and render content
    if (allCampaignKeys.length > 0) {
        if (activeCampaignKey) {
            // Check if the active campaign still exists in the new list
            const stillExists = allCampaignKeys.some(k =>
                k.type === activeCampaignKey.type && k.id === activeCampaignKey.id
            );
            if (stillExists) {
                // Re-render the active campaign content with updated data
                renderActiveCampaignContent(activeCampaignKey);
            } else {
                // Active campaign no longer exists, switch to first
                setActiveCampaign(allCampaignKeys[0]);
            }
        } else {
            // No active campaign, set the first one
            setActiveCampaign(allCampaignKeys[0]);
        }
    }

    // Setup event handlers
    setupStep5EventHandlers();
}

// Render sidebar navigation
function renderCampaignSidebar() {
    const sidebarContainer = $('#campaign-nav-list');
    sidebarContainer.empty();

    if (allCampaignKeys.length === 0) {
        sidebarContainer.html('<p class="text-gray-400 text-sm text-center py-4">Ingen kampagner</p>');
        return;
    }

    allCampaignKeys.forEach((campaignKey, index) => {
        const isActive = activeCampaignKey && activeCampaignKey.type === campaignKey.type && activeCampaignKey.id === campaignKey.id;
        const completion = calculateCampaignCompletion(campaignKey);
        const isGeo = campaignKey.type === 'geo';

        // Use design system colors - gradient progress bar style
        const progressColor = completion.percent === 100 ? '#10b981' :
                             completion.percent >= 50 ? '#8b5cf6' : '#9ca3af';

        const html = `
            <div class="campaign-nav-item selection-card cursor-pointer rounded-xl p-4 mb-3 ${isActive ? 'selected' : ''}"
                 data-campaign-type="${campaignKey.type}" data-campaign-id="${campaignKey.id}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background: linear-gradient(135deg, ${isGeo ? '#d1fae5' : '#ede9fe'}, ${isGeo ? '#a7f3d0' : '#ddd6fe'});">
                            ${isGeo ? 'üåç' : 'üè¢'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(campaignKey.name)}</p>
                            <p class="text-xs text-gray-500">${completion.adGroupCount} annoncegruppe${completion.adGroupCount !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                </div>
                <!-- Progress bar -->
                <div class="progress-bar-container mt-2" style="height: 4px;">
                    <div class="progress-bar" style="width: ${completion.percent}%; background: linear-gradient(90deg, #8b5cf6, #ec4899);"></div>
                </div>
                <p class="text-xs text-gray-400 mt-1 text-right">${completion.percent}% komplet</p>
            </div>
        `;
        sidebarContainer.append(html);
    });
}

// Calculate campaign completion status
function calculateCampaignCompletion(campaignKey) {
    let total = 0;
    let completed = 0;
    let adGroupCount = 0;

    if (campaignKey.type === 'industry') {
        const campaign = campaignConfig.campaigns[campaignKey.id];
        if (campaign && campaign.ad_groups) {
            adGroupCount = Object.keys(campaign.ad_groups).length;
            Object.values(campaign.ad_groups).forEach(adGroup => {
                total += 3; // keywords, headlines, descriptions
                if (adGroup.keywords && adGroup.keywords.length > 0) completed++;
                if (adGroup.headlines && adGroup.headlines.length >= 3) completed++;
                if (adGroup.descriptions && adGroup.descriptions.length >= 2) completed++;
            });
        }
    } else if (campaignKey.type === 'geo') {
        const geoCampaign = campaignConfig.geo_campaigns[campaignKey.id];
        if (geoCampaign) {
            adGroupCount = 1;
            total = 1; // keywords
            if (geoCampaign.ad_group && geoCampaign.ad_group.keywords && geoCampaign.ad_group.keywords.length > 0) {
                completed = 1;
            }
        }
    }

    return {
        percent: total > 0 ? Math.round((completed / total) * 100) : 0,
        completed,
        total,
        adGroupCount
    };
}

// Set active campaign and render its content
function setActiveCampaign(campaignKey) {
    activeCampaignKey = campaignKey;

    // Update sidebar selection
    $('.campaign-nav-item').removeClass('bg-purple-100 border-2 border-purple-500').addClass('bg-white border border-gray-200');
    $(`.campaign-nav-item[data-campaign-type="${campaignKey.type}"][data-campaign-id="${campaignKey.id}"]`)
        .removeClass('bg-white border border-gray-200')
        .addClass('bg-purple-100 border-2 border-purple-500');

    // Render active campaign content
    renderActiveCampaignContent(campaignKey);
}

// Render active campaign content in main area
function renderActiveCampaignContent(campaignKey) {
    const contentContainer = $('#active-campaign-content');
    contentContainer.empty();

    if (campaignKey.type === 'industry') {
        const campaign = campaignConfig.campaigns[campaignKey.id];
        const isAiCampaign = campaignKey.id.startsWith('ai_');

        let services = [];
        if (isAiCampaign) {
            // For AI campaigns, build services array from ad_groups
            services = Object.entries(campaign.ad_groups || {}).map(([serviceKey, adGroup]) => ({
                id: serviceKey,
                name: adGroup.service_name || serviceKey
            }));
        } else {
            // For database campaigns, use fetchedIndustryData
            const industryData = fetchedIndustryData[campaignKey.id];
            services = industryData?.services?.filter(s => getServicesForPurpose('google_ads').includes(s.id)) || [];
        }

        const html = renderIndustryCampaignContent(campaignKey.id, campaign, services);
        contentContainer.html(html);
    } else if (campaignKey.type === 'geo') {
        const geoCampaign = campaignConfig.geo_campaigns[campaignKey.id];
        const html = renderGeoCampaignContent(campaignKey.id, geoCampaign);
        contentContainer.html(html);
    }

    // Setup content-specific event handlers
    setupCampaignContentHandlers();
}

// Render industry campaign content
function renderIndustryCampaignContent(industryId, campaign, services) {
    const adGroupsHtml = services.map(service => {
        const adGroup = campaign.ad_groups[service.id] || { keywords: [], headlines: [], descriptions: [] };
        return renderAdGroupCard(industryId, service.id, adGroup, service.name);
    }).join('');

    return `
        <div class="campaign-detail" data-industry-id="${industryId}">
            <!-- Campaign Header Card -->
            <div class="wizard-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-lg" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(campaign.industry_name)}</h3>
                            <p class="text-sm text-gray-500">${Object.keys(campaign.ad_groups).length} annoncegruppe${Object.keys(campaign.ad_groups).length !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                    <button type="button" class="approve-campaign-btn px-5 py-2.5 rounded-xl font-medium transition-all duration-200 ${campaign.approved ? 'text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                            style="${campaign.approved ? 'background: linear-gradient(90deg, #10b981, #059669);' : ''}"
                            data-industry-id="${industryId}">
                        ${campaign.approved ? '‚úì Godkendt' : 'Godkend Kampagne'}
                    </button>
                </div>

                <!-- Budget & Strategy -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dagligt Budget (DKK)</label>
                        <input type="number" class="campaign-daily-budget w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${campaign.daily_budget}" data-industry-id="${industryId}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bidding Strategi</label>
                        <select class="campaign-bidding-strategy w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-industry-id="${industryId}">
                            <option value="maximize_clicks" ${campaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                            <option value="maximize_conversions" ${campaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                            <option value="target_cpa" ${campaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                            <option value="manual_cpc" ${campaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                        </select>
                    </div>
                    <div class="target-cpa-field" style="display: ${campaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target CPA (DKK)</label>
                        <input type="number" class="campaign-target-cpa w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${campaign.target_cpa || ''}" data-industry-id="${industryId}">
                    </div>
                </div>

                <!-- Negative Keywords as Chips -->
                <div class="border-t border-gray-100 pt-5">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="neg-keyword-chips-container flex flex-wrap gap-2" data-industry-id="${industryId}" data-campaign-type="industry">
                        ${renderNegativeKeywordChips(campaign.negative_keyword_list_ids, industryId, 'industry')}
                    </div>
                </div>
            </div>

            <!-- Ad Groups Grid -->
            <h4 class="font-semibold text-gray-900 mb-4 text-lg">Annoncegrupper</h4>
            <div class="ad-groups-grid grid grid-cols-1 lg:grid-cols-2 gap-4">
                ${adGroupsHtml}
            </div>
        </div>
    `;
}

// Render ad group card
function renderAdGroupCard(industryId, serviceId, adGroup, serviceName) {
    const keywordCount = adGroup.keywords?.length || 0;
    const headlineCount = adGroup.headlines?.length || 0;
    const descriptionCount = adGroup.descriptions?.length || 0;

    // Calculate progress
    const totalItems = 3;
    let completedItems = 0;
    if (keywordCount > 0) completedItems++;
    if (headlineCount >= 3) completedItems++;
    if (descriptionCount >= 2) completedItems++;
    const progressPercent = Math.round((completedItems / totalItems) * 100);

    // Check if this ad group is the active template (use == for type-agnostic comparison)
    const isTemplate = campaignConfig.template_ad_group.industry_id == industryId &&
                       campaignConfig.template_ad_group.service_id == serviceId;

    return `
        <div class="ad-group-card selection-card rounded-xl p-6 ${isTemplate ? 'ring-2 ring-purple-400' : ''}"
             data-industry-id="${industryId}" data-service-id="${serviceId}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-11 h-11 rounded-xl flex items-center justify-center text-lg shadow-sm" style="background: linear-gradient(135deg, ${isTemplate ? '#f3e8ff, #e9d5ff' : '#dbeafe, #bfdbfe'});">
                        ${isTemplate ? 'üìã' : 'üîß'}
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 flex items-center">
                            ${escapeHtml(serviceName)}
                            ${isTemplate ? '<span class="ml-2 px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">Template</span>' : ''}
                        </h5>
                        <p class="text-xs text-gray-500">${progressPercent}% komplet</p>
                    </div>
                </div>
                <button type="button" class="edit-ad-group-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                        style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;"
                        data-industry-id="${industryId}" data-service-id="${serviceId}">
                    Rediger
                </button>
            </div>

            <!-- Progress bar -->
            <div class="progress-bar-container mb-4" style="height: 4px;">
                <div class="progress-bar" style="width: ${progressPercent}%; background: linear-gradient(90deg, #8b5cf6, #ec4899);"></div>
            </div>

            <!-- Status Checklist -->
            <div class="space-y-2.5 text-sm">
                <div class="flex items-center justify-between ${keywordCount > 0 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${keywordCount > 0 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                            ${keywordCount > 0 ? '‚úì' : ''}
                        </span>
                        S√∏geord
                    </span>
                    <span class="font-medium text-gray-600">${keywordCount}</span>
                </div>
                <div class="flex items-center justify-between ${headlineCount >= 3 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${headlineCount >= 3 ? 'bg-green-100 text-green-600' : headlineCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400'}">
                            ${headlineCount >= 3 ? '‚úì' : headlineCount > 0 ? '!' : ''}
                        </span>
                        Headlines
                    </span>
                    <span class="font-medium text-gray-600">${headlineCount}/15</span>
                </div>
                <div class="flex items-center justify-between ${descriptionCount >= 2 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${descriptionCount >= 2 ? 'bg-green-100 text-green-600' : descriptionCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400'}">
                            ${descriptionCount >= 2 ? '‚úì' : descriptionCount > 0 ? '!' : ''}
                        </span>
                        Beskrivelser
                    </span>
                    <span class="font-medium text-gray-600">${descriptionCount}/4</span>
                </div>
            </div>
        </div>
    `;
}

// Render GEO ad group card (matches industry ad group card design)
function renderGeoAdGroupCard(serviceId, geoCampaign) {
    const adGroup = geoCampaign.ad_group || {};
    const serviceName = geoCampaign.serviceName || geoCampaign.name || 'GEO Annoncegruppe';

    // Calculate progress (same logic as industry)
    const keywordsOk = (adGroup.keywords?.length || 0) > 0;
    const headlinesOk = (adGroup.headlines?.length || 0) >= 3;
    const descriptionsOk = (adGroup.descriptions?.length || 0) >= 2;
    const completedSteps = [keywordsOk, headlinesOk, descriptionsOk].filter(Boolean).length;
    const progressPercent = Math.round((completedSteps / 3) * 100);

    // Status icons
    const keywordStatus = keywordsOk ? '‚úì' : '';
    const headlineStatus = headlinesOk ? '‚úì' : ((adGroup.headlines?.length || 0) > 0 ? '!' : '');
    const descStatus = descriptionsOk ? '‚úì' : ((adGroup.descriptions?.length || 0) > 0 ? '!' : '');

    const keywordCount = adGroup.keywords?.length || 0;
    const headlineCount = adGroup.headlines?.length || 0;
    const descriptionCount = adGroup.descriptions?.length || 0;

    return `
        <div class="ad-group-card selection-card rounded-xl p-6" data-service-id="${serviceId}">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-11 h-11 rounded-xl flex items-center justify-center text-lg shadow-sm"
                         style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                        üåç
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900">${serviceName}</h5>
                        <p class="text-xs text-gray-500">${progressPercent}% komplet</p>
                    </div>
                </div>
                <button type="button" class="edit-geo-ad-group-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                        style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669;"
                        data-service-id="${serviceId}"
                        onclick="openGeoAdGroupEditPanel('${serviceId}')">
                    Rediger
                </button>
            </div>

            <!-- Progress bar (green for GEO) -->
            <div class="progress-bar-container mb-4" style="height: 4px;">
                <div class="progress-bar" style="width: ${progressPercent}%; background: linear-gradient(90deg, #10b981, #34d399);"></div>
            </div>

            <!-- Status Checklist -->
            <div class="space-y-2.5 text-sm">
                <div class="flex items-center justify-between text-gray-900">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${keywordsOk ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                            ${keywordStatus}
                        </span>
                        S√∏geord
                    </span>
                    <span class="font-medium text-gray-600">${keywordCount}</span>
                </div>
                <div class="flex items-center justify-between text-gray-900">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${headlinesOk ? 'bg-green-100 text-green-600' : (headlineCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400')}">
                            ${headlineStatus}
                        </span>
                        Headlines
                    </span>
                    <span class="font-medium text-gray-600">${headlineCount}/15</span>
                </div>
                <div class="flex items-center justify-between text-gray-900">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${descriptionsOk ? 'bg-green-100 text-green-600' : (descriptionCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400')}">
                            ${descStatus}
                        </span>
                        Beskrivelser
                    </span>
                    <span class="font-medium text-gray-600">${descriptionCount}/4</span>
                </div>
            </div>
        </div>
    `;
}

// Render GEO campaign content
function renderGeoCampaignContent(serviceId, geoCampaign) {
    const keywordCount = geoCampaign.ad_group?.keywords?.length || 0;

    let keywordsHtml = '';
    if (geoCampaign.ad_group && geoCampaign.ad_group.keywords) {
        geoCampaign.ad_group.keywords.slice(0, 10).forEach((kw, index) => {
            keywordsHtml += `
                <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #d1fae520, #d1fae510);">
                    <span class="font-medium text-gray-900">${escapeHtml(kw.keyword)}</span>
                    <span class="text-xs text-emerald-600 truncate max-w-xs">${escapeHtml(kw.url || '')}</span>
                </div>
            `;
        });
        if (geoCampaign.ad_group.keywords.length > 10) {
            keywordsHtml += `<p class="text-sm text-gray-500 text-center py-2">+ ${geoCampaign.ad_group.keywords.length - 10} flere s√∏geord</p>`;
        }
    }

    return `
        <div class="geo-campaign-detail" data-service-id="${serviceId}">
            <!-- Campaign Header Card -->
            <div class="wizard-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-lg" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                            üåç
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(geoCampaign.name)}</h3>
                            <p class="text-sm text-gray-500">${keywordCount} geo-s√∏geord</p>
                        </div>
                    </div>
                    <span class="px-4 py-2 rounded-xl text-sm font-semibold text-emerald-700" style="background: linear-gradient(135deg, #d1fae520, #d1fae510);">GEO Kampagne</span>
                </div>

                <!-- Budget & Strategy -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dagligt Budget (DKK)</label>
                        <input type="number" class="geo-campaign-daily-budget w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${geoCampaign.daily_budget}" data-service-id="${serviceId}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bidding Strategi</label>
                        <select class="geo-campaign-bidding-strategy w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-service-id="${serviceId}">
                            <option value="maximize_clicks" ${geoCampaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                            <option value="maximize_conversions" ${geoCampaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                            <option value="target_cpa" ${geoCampaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                            <option value="manual_cpc" ${geoCampaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Match Type</label>
                        <select class="geo-campaign-match-type w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-service-id="${serviceId}">
                            <option value="phrase" ${geoCampaign.match_type === 'phrase' ? 'selected' : ''}>Phrase Match</option>
                            <option value="exact" ${geoCampaign.match_type === 'exact' ? 'selected' : ''}>Exact Match</option>
                        </select>
                    </div>
                </div>

                <!-- Negative Keywords as Chips -->
                <div class="border-t border-gray-100 pt-5">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="neg-keyword-chips-container flex flex-wrap gap-2" data-service-id="${serviceId}" data-campaign-type="geo">
                        ${renderNegativeKeywordChips(geoCampaign.negative_keyword_list_ids, serviceId, 'geo')}
                    </div>
                </div>
            </div>

            <!-- Annoncegruppe Card (Single ad group for GEO) -->
            <div class="wizard-card p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-gray-900 flex items-center">
                        <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üì∞</span>
                        Annoncegruppe
                    </h4>
                </div>
                ${renderGeoAdGroupCard(serviceId, geoCampaign)}
            </div>

            <!-- GEO Keywords Preview -->
            <div class="wizard-card p-6">
                <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üîë</span>
                    GEO S√∏geord (${keywordCount})
                </h4>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${keywordsHtml || '<p class="text-gray-500 text-center py-4">Ingen s√∏geord</p>'}
                </div>
            </div>
        </div>
    `;
}

// Render negative keyword chips (clickable selection like Industry Manager)
// Kun vis lister der er tilknyttet de valgte services ELLER er by-listen
function renderNegativeKeywordChips(selectedIds, entityId, campaignType) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-gray-500 text-sm">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    // Hent alle valgte service IDs fra campaignConfig
    const selectedServiceIds = campaignConfig.service_ids || [];

    // Filtrer lister: Vis kun dem der er tilknyttet valgte services ELLER er by-listen
    const relevantLists = serverData.negative_keyword_lists.filter(list => {
        // Altid vis by-listen (Ekskluderede Byer)
        if (list.is_city_list) return true;

        // Vis hvis listen er tilknyttet mindst √©n af de valgte services
        const connectedIds = list.connected_service_ids || [];
        return connectedIds.some(sid => selectedServiceIds.includes(sid));
    });

    if (relevantLists.length === 0) {
        return '<p class="text-gray-500 text-sm">Ingen negative s√∏geordslister tilknyttet de valgte services</p>';
    }

    return relevantLists.map(list => {
        const isSelected = selectedIds.includes(list.id);
        // Use design system purple/pink colors instead of harsh red
        const selectedStyle = isSelected
            ? 'background: linear-gradient(135deg, #8b5cf620, #8b5cf610); border-color: #8b5cf6; color: #7c3aed;'
            : '';
        const selectedClass = isSelected
            ? 'selected'
            : 'bg-gray-50 border-gray-200 text-gray-600 hover:border-purple-300 hover:bg-purple-50';

        return `
            <button type="button"
                    class="neg-keyword-chip selection-card px-4 py-2.5 rounded-xl border-2 text-sm font-medium transition-all duration-200 cursor-pointer ${selectedClass}"
                    style="${selectedStyle}"
                    data-list-id="${list.id}"
                    data-entity-id="${entityId}"
                    data-campaign-type="${campaignType}">
                <span class="flex items-center space-x-2">
                    <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs ${isSelected ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-400'}">${isSelected ? '‚úì' : '+'}</span>
                    <span>${escapeHtml(list.name)}</span>
                    <span class="text-xs ${isSelected ? 'text-purple-400' : 'text-gray-400'}">(${list.keyword_count})</span>
                </span>
            </button>
        `;
    }).join('');
}

// Setup Step 5 event handlers
function setupStep5EventHandlers() {
    // Campaign nav click
    $(document).off('click', '.campaign-nav-item').on('click', '.campaign-nav-item', function() {
        const type = $(this).data('campaign-type');
        const id = $(this).data('campaign-id');
        setActiveCampaign({ type, id: String(id) });
    });

    // Batch approve all
    $('#batch-approve-all-btn').off('click').on('click', function() {
        // Approve all industry campaigns
        Object.keys(campaignConfig.campaigns).forEach(industryId => {
            campaignConfig.campaigns[industryId].approved = true;
            Object.values(campaignConfig.campaigns[industryId].ad_groups).forEach(ag => {
                ag.approved = true;
            });
        });
        // Approve all geo campaigns
        if (campaignConfig.geo_campaigns) {
            Object.keys(campaignConfig.geo_campaigns).forEach(serviceId => {
                campaignConfig.geo_campaigns[serviceId].approved = true;
            });
        }
        // Refresh UI
        renderCampaignSidebar();
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
        alert('Alle kampagner er godkendt!');
    });

    // Negative keyword chip click
    $(document).off('click', '.neg-keyword-chip').on('click', '.neg-keyword-chip', function() {
        const listId = parseInt($(this).data('list-id'));
        const entityId = $(this).data('entity-id');
        const campaignType = $(this).data('campaign-type');

        let selectedIds;
        if (campaignType === 'industry') {
            selectedIds = campaignConfig.campaigns[entityId].negative_keyword_list_ids;
        } else {
            selectedIds = campaignConfig.geo_campaigns[entityId].negative_keyword_list_ids;
        }

        const index = selectedIds.indexOf(listId);
        if (index > -1) {
            selectedIds.splice(index, 1);
        } else {
            selectedIds.push(listId);
        }

        // Re-render chips
        const container = $(this).closest('.neg-keyword-chips-container');
        container.html(renderNegativeKeywordChips(selectedIds, entityId, campaignType));
    });
}

// Setup campaign content handlers
function setupCampaignContentHandlers() {
    // Budget change
    $(document).off('change', '.campaign-daily-budget').on('change', '.campaign-daily-budget', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].daily_budget = $(this).val() ? parseInt($(this).val()) : '';
    });

    // Bidding strategy change
    $(document).off('change', '.campaign-bidding-strategy').on('change', '.campaign-bidding-strategy', function() {
        const industryId = $(this).data('industry-id');
        const strategy = $(this).val();
        campaignConfig.campaigns[industryId].bidding_strategy = strategy;

        const targetCpaField = $(this).closest('.campaign-detail').find('.target-cpa-field');
        if (strategy === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }
    });

    // Target CPA change
    $(document).off('change', '.campaign-target-cpa').on('change', '.campaign-target-cpa', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].target_cpa = parseInt($(this).val()) || null;
    });

    // GEO budget change
    $(document).off('change', '.geo-campaign-daily-budget').on('change', '.geo-campaign-daily-budget', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].daily_budget = $(this).val() ? parseInt($(this).val()) : '';
    });

    // GEO bidding strategy change
    $(document).off('change', '.geo-campaign-bidding-strategy').on('change', '.geo-campaign-bidding-strategy', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].bidding_strategy = $(this).val();
    });

    // GEO match type change
    $(document).off('change', '.geo-campaign-match-type').on('change', '.geo-campaign-match-type', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].match_type = $(this).val();
    });

    // Approve campaign button
    $(document).off('click', '.approve-campaign-btn').on('click', '.approve-campaign-btn', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].approved = !campaignConfig.campaigns[industryId].approved;

        if (campaignConfig.campaigns[industryId].approved) {
            $(this).removeClass('bg-gray-100 text-gray-700 hover:bg-green-100').addClass('bg-green-500 text-white');
            $(this).html('‚úì Godkendt');
        } else {
            $(this).removeClass('bg-green-500 text-white').addClass('bg-gray-100 text-gray-700 hover:bg-green-100');
            $(this).html('Godkend Kampagne');
        }

        renderCampaignSidebar();
    });

    // Edit ad group button - open slide panel
    $(document).off('click', '.edit-ad-group-btn').on('click', '.edit-ad-group-btn', function() {
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        openAdGroupEditPanel(industryId, serviceId);
    });

    // Edit GEO ad group button - open slide panel for GEO campaigns
    $(document).off('click', '.edit-geo-ad-group-btn').on('click', '.edit-geo-ad-group-btn', function() {
        console.log('GEO Rediger button clicked');
        const serviceId = $(this).data('service-id');
        console.log('Service ID from button:', serviceId);
        openGeoAdGroupEditPanel(serviceId);
    });
}

// Open ad group edit slide panel
function openAdGroupEditPanel(industryId, serviceId) {
    const campaign = campaignConfig.campaigns[industryId];
    const adGroup = campaign.ad_groups[serviceId];

    // Create slide panel HTML with design system styling
    const panelHtml = `
        <div id="ad-group-edit-panel" class="fixed inset-0 z-50">
            <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="panel-overlay"></div>
            <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-white shadow-2xl transform transition-transform duration-300" id="panel-content" style="border-radius: 24px 0 0 24px;">
                <div class="h-full flex flex-col">
                    <!-- Panel Header -->
                    <div class="p-6 border-b border-gray-100" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-lg" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                                    üîß
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${escapeHtml(adGroup.service_name)}</h3>
                                    <p class="text-sm text-gray-500">Rediger annoncegruppe</p>
                                </div>
                            </div>
                            <button type="button" class="close-panel-btn w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb);">
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Panel Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Template Checkbox -->
                        <div class="flex items-center justify-between mb-6 p-4 rounded-xl border-2 transition-all duration-200 ${campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId ? 'bg-purple-50 border-purple-300' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="use-as-template" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" ${campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId ? 'checked' : ''}>
                                <label for="use-as-template" class="text-sm font-medium text-gray-700 cursor-pointer">
                                    Brug som template for andre annoncegrupper
                                </label>
                            </div>
                            ${campaignConfig.template_ad_group.source_service_name ? '<span class="text-xs text-purple-600 font-medium">Aktiv template: ' + campaignConfig.template_ad_group.source_service_name + '</span>' : ''}
                        </div>

                        <!-- Keywords Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üîë</span>
                                    S√∏geord (${adGroup.keywords.length})
                                </h4>
                                <button type="button" class="add-keyword-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                    + Tilf√∏j
                                </button>
                            </div>
                            <div class="panel-keywords-list space-y-2 max-h-48 overflow-y-auto" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelKeywordsList(adGroup.keywords, serviceId)}
                            </div>
                            <div class="add-keyword-form hidden mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                                <div class="flex items-center space-x-2">
                                    <input type="text" class="new-keyword-input flex-1 px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="Nyt s√∏geord...">
                                    <select class="new-keyword-match-type px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                        <option value="broad">Broad</option>
                                        <option value="phrase">Phrase</option>
                                        <option value="exact">Exact</option>
                                    </select>
                                    <button type="button" class="save-new-keyword-btn px-4 py-2.5 rounded-xl font-medium text-white transition-all duration-200 hover:shadow-lg" style="background: linear-gradient(90deg, #8b5cf6, #ec4899);">Gem</button>
                                    <button type="button" class="cancel-keyword-btn px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all">Annuller</button>
                                </div>
                            </div>
                        </div>

                        <!-- Headlines Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center headlines-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">üì∞</span>
                                    Headlines (<span class="headlines-count">${adGroup.headlines.length}</span>/15)
                                </h4>
                                <div class="flex space-x-2">
                                    ${campaignConfig.template_ad_group?.service_id && !(campaignConfig.template_ad_group.type === 'industry' && campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId) ?
                                        '<button type="button" class="apply-template-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e;" title="Kopier headlines og beskrivelser fra ' + campaignConfig.template_ad_group.source_service_name + '">üìã Hent fra template</button>' : ''}
                                    <button type="button" class="shuffle-headlines-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;">
                                        üîÄ Shuffle
                                    </button>
                                    <button type="button" class="add-headline-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="panel-headlines-list space-y-2" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines)}
                            </div>
                        </div>

                        <!-- Descriptions Section -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center descriptions-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üìù</span>
                                    Beskrivelser (<span class="descriptions-count">${adGroup.descriptions.length}</span>/4)
                                </h4>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="generate-ai-descriptions-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md flex items-center gap-2" style="background: linear-gradient(135deg, #8b5cf620, #a78bfa20); color: #7c3aed;">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                        Generer med AI
                                    </button>
                                    <button type="button" class="add-description-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="panel-descriptions-list space-y-2" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions)}
                            </div>
                        </div>
                    </div>

                    <!-- Panel Footer -->
                    <div class="p-6 border-t border-gray-100" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="close-panel-btn px-6 py-2.5 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;">
                                Luk
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing panel first
    $('#ad-group-edit-panel').remove();

    // Add panel directly to document body (outside wizard form)
    $(document.body).append(panelHtml);

    // Force panel to be visible by ensuring correct styles
    setTimeout(() => {
        const panel = document.getElementById('ad-group-edit-panel');
        if (panel) {
            panel.style.position = 'fixed';
            panel.style.top = '0';
            panel.style.left = '0';
            panel.style.right = '0';
            panel.style.bottom = '0';
            panel.style.zIndex = '9999';
        }
    }, 10);

    // Setup panel event handlers
    setupPanelEventHandlers(industryId, serviceId);
}

// Open GEO ad group edit slide panel
function openGeoAdGroupEditPanel(serviceId) {
    console.log('openGeoAdGroupEditPanel called with serviceId:', serviceId);
    console.log('geo_campaigns:', campaignConfig.geo_campaigns);

    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) {
        console.error('GEO campaign not found for serviceId:', serviceId);
        alert('GEO kampagne ikke fundet. Pr√∏v at genindl√¶se siden.');
        return;
    }

    const adGroup = geoCampaign.ad_group;
    if (!adGroup) {
        console.error('Ad group not found in GEO campaign:', geoCampaign);
        alert('Annoncegruppe ikke fundet. Pr√∏v at genindl√¶se siden.');
        return;
    }

    // Ensure arrays exist (for backwards compatibility with existing campaigns)
    if (!adGroup.keywords) adGroup.keywords = [];
    if (!adGroup.headlines) adGroup.headlines = [];
    if (!adGroup.descriptions) adGroup.descriptions = [];

    // Create slide panel HTML with GEO-specific styling (green gradient theme)
    const panelHtml = `
        <div id="geo-ad-group-edit-panel" class="fixed inset-0 z-50">
            <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="geo-panel-overlay"></div>
            <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-white shadow-2xl transform transition-transform duration-300" id="geo-panel-content" style="border-radius: 24px 0 0 24px;">
                <div class="h-full flex flex-col">
                    <!-- Panel Header (GEO green theme) -->
                    <div class="p-6 border-b border-gray-100" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-lg" style="background: linear-gradient(135deg, #a7f3d0, #6ee7b7);">
                                    üåç
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${escapeHtml(geoCampaign.name)}</h3>
                                    <p class="text-sm text-gray-600">Rediger GEO annoncegruppe</p>
                                </div>
                            </div>
                            <button type="button" class="close-geo-panel-btn w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb);">
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Panel Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Template Checkbox (GEO green theme) -->
                        <div class="flex items-center justify-between mb-6 p-4 rounded-xl border-2 transition-all duration-200
                                    ${campaignConfig.template_ad_group?.type === 'geo' &&
                                      campaignConfig.template_ad_group?.service_id == serviceId ?
                                      'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="geo-use-as-template"
                                       class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500"
                                       ${campaignConfig.template_ad_group?.type === 'geo' &&
                                         campaignConfig.template_ad_group?.service_id == serviceId ? 'checked' : ''}>
                                <label for="geo-use-as-template" class="text-sm font-medium text-gray-700 cursor-pointer">
                                    Brug som template for andre annoncegrupper
                                </label>
                            </div>
                            ${campaignConfig.template_ad_group?.source_service_name ?
                              '<span class="text-xs ' + (campaignConfig.template_ad_group.type === 'geo' ? 'text-emerald-600' : 'text-purple-600') + ' font-medium">Aktiv template: ' + campaignConfig.template_ad_group.source_service_name + '</span>' : ''}
                        </div>

                        <!-- Keywords Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üîë</span>
                                    S√∏geord (${adGroup.keywords.length})
                                </h4>
                                <button type="button" class="add-geo-keyword-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                    + Tilf√∏j
                                </button>
                            </div>
                            <div class="geo-panel-keywords-list space-y-2 max-h-48 overflow-y-auto" data-service-id="${serviceId}">
                                ${renderGeoPanelKeywordsList(adGroup.keywords, serviceId)}
                            </div>
                            <div class="add-geo-keyword-form hidden mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                                <div class="flex items-center space-x-2">
                                    <input type="text" class="new-geo-keyword-input flex-1 px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all" placeholder="Nyt s√∏geord...">
                                    <select class="new-geo-keyword-match-type px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                                        <option value="broad">Broad</option>
                                        <option value="phrase">Phrase</option>
                                        <option value="exact">Exact</option>
                                    </select>
                                    <button type="button" class="save-new-geo-keyword-btn px-4 py-2.5 rounded-xl font-medium text-white transition-all duration-200 hover:shadow-lg" style="background: linear-gradient(90deg, #059669, #10b981);">Gem</button>
                                    <button type="button" class="cancel-geo-keyword-btn px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all">Annuller</button>
                                </div>
                            </div>
                        </div>

                        <!-- Headlines Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center geo-headlines-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">üì∞</span>
                                    Headlines (<span class="geo-headlines-count">${adGroup.headlines.length}</span>/15)
                                </h4>
                                <div class="flex space-x-2">
                                    ${campaignConfig.template_ad_group?.service_id &&
                                      !(campaignConfig.template_ad_group.type === 'geo' &&
                                        campaignConfig.template_ad_group.service_id == serviceId) ?
                                      `<button type="button" class="apply-geo-template-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                                       style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e;"
                                       title="Hent fra ${campaignConfig.template_ad_group.source_service_name}">
                                       üìã Hent fra template
                                      </button>` : ''}
                                    <button type="button" class="shuffle-geo-headlines-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669;">
                                        üîÄ Shuffle
                                    </button>
                                    <button type="button" class="add-geo-headline-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="geo-panel-headlines-list space-y-2" data-service-id="${serviceId}">
                                ${renderGeoPanelHeadlinesList(serviceId, adGroup.headlines)}
                            </div>
                        </div>

                        <!-- Descriptions Section -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center geo-descriptions-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üìù</span>
                                    Beskrivelser (<span class="geo-descriptions-count">${adGroup.descriptions.length}</span>/4)
                                </h4>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="generate-geo-ai-descriptions-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md flex items-center gap-2" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                        Generer med AI
                                    </button>
                                    <button type="button" class="add-geo-description-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="geo-panel-descriptions-list space-y-2" data-service-id="${serviceId}">
                                ${renderGeoPanelDescriptionsList(serviceId, adGroup.descriptions)}
                            </div>
                        </div>
                    </div>

                    <!-- Panel Footer -->
                    <div class="p-6 border-t border-gray-100" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="close-geo-panel-btn px-6 py-2.5 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669;">
                                Luk
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing panel first
    $('#geo-ad-group-edit-panel').remove();

    // Add panel directly to document body
    $(document.body).append(panelHtml);

    // Force panel to be visible
    setTimeout(() => {
        const panel = document.getElementById('geo-ad-group-edit-panel');
        if (panel) {
            panel.style.position = 'fixed';
            panel.style.top = '0';
            panel.style.left = '0';
            panel.style.right = '0';
            panel.style.bottom = '0';
            panel.style.zIndex = '9999';
        }
    }, 10);

    // Setup GEO panel event handlers
    setupGeoPanelEventHandlers(serviceId);
}

// Render GEO panel keywords list
function renderGeoPanelKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen s√∏geord</p>';
    }

    return keywords.map((kw, index) => `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
            <div class="flex items-center space-x-2">
                <span class="text-gray-900 font-medium">${escapeHtml(kw.keyword)}</span>
                <span class="text-xs px-2.5 py-1 rounded-lg font-medium" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669;">${kw.match_type}</span>
            </div>
            <button type="button" class="remove-geo-keyword-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
        </div>
    `).join('');
}

// Render GEO panel headlines list
function renderGeoPanelHeadlinesList(serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen headlines. Klik "Shuffle" for at generere.</p>';
    }

    // Create array with original indices for sorting
    const headlinesWithIndices = headlines.map((headline, index) => ({
        headline,
        originalIndex: index
    }));

    // Sort: unlocked first, locked at the bottom
    headlinesWithIndices.sort((a, b) => {
        const aLocked = typeof a.headline === 'object' ? a.headline.locked : false;
        const bLocked = typeof b.headline === 'object' ? b.headline.locked : false;
        if (aLocked === bLocked) return 0;
        return aLocked ? 1 : -1;
    });

    return headlinesWithIndices.map(({headline, originalIndex}) => {
        const text = typeof headline === 'object' ? headline.text : headline;
        const locked = typeof headline === 'object' ? headline.locked : false;
        const charCount = text.length;
        const charColor = charCount > 30 ? 'text-red-500' : charCount > 25 ? 'text-yellow-500' : 'text-gray-400';

        return `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm ${locked ? 'ring-2 ring-emerald-400' : ''}" style="background: linear-gradient(135deg, ${locked ? '#d1fae5, #a7f3d0' : '#f9fafb, #f3f4f6'});">
            <div class="flex items-center space-x-2 flex-1 min-w-0">
                <button type="button" class="lock-geo-headline-btn w-8 h-8 shrink-0 rounded-lg flex items-center justify-center transition-all ${locked ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}" data-index="${originalIndex}" title="${locked ? 'Klik for at l√•se op' : 'Klik for at fryse denne headline'}">
                    ${locked ? 'üîí' : 'üîì'}
                </button>
                <input type="text" class="geo-headline-input flex-1 min-w-0 px-3 py-1.5 border border-transparent rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-gray-900 bg-transparent hover:bg-white transition-all"
                       value="${escapeHtml(text)}" data-index="${originalIndex}" maxlength="30">
            </div>
            <div class="flex items-center space-x-1 ml-2 shrink-0">
                <span class="text-xs ${charColor} geo-headline-char-count w-10">${charCount}/30</span>
                <button type="button" class="remove-geo-headline-btn w-6 h-6 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${originalIndex}">√ó</button>
            </div>
        </div>
    `;
    }).join('');
}

// Render GEO panel descriptions list
function renderGeoPanelDescriptionsList(serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen beskrivelser</p>';
    }

    return descriptions.map((desc, index) => {
        const charCount = desc.length;
        const charColor = charCount > 90 ? 'text-red-500' : charCount > 75 ? 'text-yellow-500' : 'text-gray-400';

        return `
            <div class="flex items-center space-x-2 p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                <textarea class="geo-description-input flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all resize-none" rows="2" maxlength="90" data-index="${index}">${escapeHtml(desc)}</textarea>
                <span class="text-xs ${charColor}">${charCount}/90</span>
                <button type="button" class="remove-geo-description-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
            </div>
        `;
    }).join('');
}

// Render panel keywords list
function renderPanelKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen s√∏geord</p>';
    }

    return keywords.map((kw, index) => `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
            <div class="flex items-center space-x-2">
                <span class="text-gray-900 font-medium">${escapeHtml(kw.keyword)}</span>
                <span class="text-xs px-2.5 py-1 rounded-lg font-medium" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8;">${kw.match_type}</span>
            </div>
            <button type="button" class="remove-keyword-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
        </div>
    `).join('');
}

// Render panel headlines list
function renderPanelHeadlinesList(industryId, serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen headlines. Klik "Shuffle" for at generere.</p>';
    }

    // Create array with original indices for sorting
    const headlinesWithIndices = headlines.map((headline, index) => ({
        headline,
        originalIndex: index
    }));

    // Sort: unlocked first, locked at the bottom
    headlinesWithIndices.sort((a, b) => {
        const aLocked = typeof a.headline === 'object' ? a.headline.locked : false;
        const bLocked = typeof b.headline === 'object' ? b.headline.locked : false;
        if (aLocked === bLocked) return 0;
        return aLocked ? 1 : -1;  // Locked items go to the end
    });

    return headlinesWithIndices.map(({ headline, originalIndex }) => {
        // Support both old strings and new objects
        const text = typeof headline === 'string' ? headline : headline.text;
        const locked = typeof headline === 'object' ? headline.locked : false;

        return `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm ${locked ? 'ring-2 ring-purple-400' : ''}" style="background: linear-gradient(135deg, ${locked ? '#f3e8ff, #ede9fe' : '#f9fafb, #f3f4f6'});">
            <div class="flex items-center space-x-2 flex-1 min-w-0">
                <button type="button" class="lock-headline-btn w-8 h-8 shrink-0 rounded-lg flex items-center justify-center transition-all ${locked ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}" data-index="${originalIndex}" title="${locked ? 'Klik for at l√•se op' : 'Klik for at fryse denne headline'}">
                    ${locked ? 'üîí' : 'üîì'}
                </button>
                <input type="text" class="headline-input flex-1 min-w-0 px-3 py-1.5 border border-transparent rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 bg-transparent hover:bg-white transition-all"
                       value="${escapeHtml(text)}" data-index="${originalIndex}" maxlength="30">
            </div>
            <div class="flex items-center space-x-1 ml-2 shrink-0">
                <span class="text-xs text-gray-400 headline-char-count w-10">${text.length}/30</span>
                <button type="button" class="remove-headline-btn w-6 h-6 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${originalIndex}">√ó</button>
            </div>
        </div>
    `}).join('');
}

// Render panel descriptions list
function renderPanelDescriptionsList(industryId, serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="flex items-start justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
            <textarea class="description-input flex-1 px-3 py-1.5 border border-transparent rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 bg-transparent hover:bg-white transition-all resize-none overflow-hidden"
                   data-index="${index}" maxlength="90" rows="1" style="min-height: 36px;">${escapeHtml(desc)}</textarea>
            <div class="flex items-center space-x-2 ml-2 mt-1">
                <span class="text-xs text-gray-400 desc-char-count">${desc.length}/90</span>
                <button type="button" class="remove-description-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
            </div>
        </div>
    `).join('');
}

// Apply template headlines and descriptions to target ad group
function applyTemplateToAdGroup(targetIndustryId, targetServiceId) {
    const template = campaignConfig.template_ad_group;

    // Check if there's an active template
    if (!template?.service_id) {
        console.log('No template set');
        return;
    }

    // Get source ad group based on template type
    let sourceAdGroup, sourceServiceName;
    if (template.type === 'industry') {
        // Source is from industry campaign
        sourceAdGroup = campaignConfig.campaigns[template.industry_id]?.ad_groups[template.service_id];
        sourceServiceName = sourceAdGroup?.service_name || template.source_service_name;
    } else if (template.type === 'geo') {
        // Source is from GEO campaign
        sourceAdGroup = campaignConfig.geo_campaigns[template.service_id]?.ad_group;
        sourceServiceName = template.source_service_name;
    }

    if (!sourceAdGroup) {
        console.error('Source ad group not found');
        return;
    }

    // Get target industry ad group
    const targetAdGroup = campaignConfig.campaigns[targetIndustryId]?.ad_groups[targetServiceId];
    if (!targetAdGroup) {
        console.error('Target ad group not found');
        return;
    }

    const targetServiceName = targetAdGroup.service_name;

    console.log('Applying template from', sourceServiceName, 'to', targetServiceName);

    // Copy headlines with service name substitution
    const sourceHeadlines = sourceAdGroup.headlines || [];
    targetAdGroup.headlines = sourceHeadlines.map(h => {
        const text = typeof h === 'object' ? h.text : h;
        // Case-insensitive replacement of service name
        const substituted = text.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
        return { text: substituted, locked: false };
    });

    // Copy descriptions with service name substitution
    const sourceDescriptions = sourceAdGroup.descriptions || [];
    targetAdGroup.descriptions = sourceDescriptions.map(desc => {
        const text = typeof desc === 'object' ? desc.text || desc : desc;
        return text.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
    });

    console.log('Template applied successfully. Headlines:', targetAdGroup.headlines.length, 'Descriptions:', targetAdGroup.descriptions.length);
}

// Apply template to GEO ad group (supports both industry and GEO templates)
function applyTemplateToGeoAdGroup(targetServiceId) {
    const template = campaignConfig.template_ad_group;

    // Check if there's an active template
    if (!template?.service_id) {
        console.log('No template set');
        return;
    }

    // Get source ad group based on template type
    let sourceAdGroup, sourceServiceName;
    if (template.type === 'industry') {
        // Source is from industry campaign
        sourceAdGroup = campaignConfig.campaigns[template.industry_id]?.ad_groups[template.service_id];
        sourceServiceName = sourceAdGroup?.service_name || template.source_service_name;
    } else if (template.type === 'geo') {
        // Source is from GEO campaign
        sourceAdGroup = campaignConfig.geo_campaigns[template.service_id]?.ad_group;
        sourceServiceName = template.source_service_name;
    }

    if (!sourceAdGroup) {
        console.error('Source ad group not found');
        return;
    }

    // Get target GEO ad group
    const targetAdGroup = campaignConfig.geo_campaigns[targetServiceId]?.ad_group;
    if (!targetAdGroup) {
        console.error('Target GEO ad group not found');
        return;
    }

    const geoCampaign = campaignConfig.geo_campaigns[targetServiceId];
    const targetServiceName = geoCampaign.serviceName || geoCampaign.name;

    console.log('Applying template from', sourceServiceName, 'to GEO', targetServiceName);

    // Copy headlines with service name substitution
    const sourceHeadlines = sourceAdGroup.headlines || [];
    targetAdGroup.headlines = sourceHeadlines.map(h => {
        const text = typeof h === 'object' ? h.text : h;
        // Case-insensitive replacement of service name
        const substituted = text.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
        return { text: substituted, locked: false };
    });

    // Copy descriptions with service name substitution
    const sourceDescriptions = sourceAdGroup.descriptions || [];
    targetAdGroup.descriptions = sourceDescriptions.map(desc => {
        const text = typeof desc === 'object' ? desc.text || desc : desc;
        return text.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
    });

    console.log('Template applied to GEO. Headlines:', targetAdGroup.headlines.length, 'Descriptions:', targetAdGroup.descriptions.length);
}

// Escape special regex characters
function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Setup panel event handlers
function setupPanelEventHandlers(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Remove any existing document-level event handlers for panel elements
    $(document).off('click', '.close-panel-btn, #panel-overlay');
    $(document).off('click', '.remove-keyword-btn');
    $(document).off('click', '.lock-headline-btn');
    $(document).off('input', '.headline-input');
    $(document).off('input', '.description-input');
    $(document).off('click', '.remove-headline-btn');
    $(document).off('click', '.remove-description-btn');

    // Close panel
    $(document).on('click', '.close-panel-btn, #panel-overlay', function() {
        // Auto-save state when closing panel to preserve changes
        saveStateToStorage();
        $('#ad-group-edit-panel').remove();
        // Refresh the ad group card
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
    });

    // Add keyword
    $('.add-keyword-panel-btn').on('click', function() {
        $('.add-keyword-form').removeClass('hidden');
    });

    $('.cancel-keyword-btn').on('click', function() {
        $('.add-keyword-form').addClass('hidden');
        $('.new-keyword-input').val('');
    });

    $('.save-new-keyword-btn').on('click', function() {
        const keyword = $('.new-keyword-input').val().trim();
        const matchType = $('.new-keyword-match-type').val();

        if (keyword) {
            adGroup.keywords.push({
                keyword: keyword,
                match_type: matchType,
                is_primary: false
            });

            // Re-render keywords list
            $('.panel-keywords-list').html(renderPanelKeywordsList(adGroup.keywords, serviceId));
            $('.add-keyword-form').addClass('hidden');
            $('.new-keyword-input').val('');

            // Update header count
            $('h4:contains("S√∏geord")').html(`
                <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üîë</span>
                S√∏geord (${adGroup.keywords.length})
            `);
        }
    });

    // Remove keyword
    $(document).on('click', '.remove-keyword-btn', function() {
        const index = $(this).data('index');
        adGroup.keywords.splice(index, 1);
        $('.panel-keywords-list').html(renderPanelKeywordsList(adGroup.keywords, serviceId));
    });

    // Shuffle headlines - use the global shuffleHeadlines function that reads example_headlines
    $('.shuffle-headlines-panel-btn').on('click', function() {
        // Call the global shuffleHeadlines function which:
        // 1. Gets example_headlines from each selected USP's data attribute
        // 2. Picks 1 random headline per USP
        // 3. Adds custom USPs 1:1
        // 4. Shuffles and limits to 15
        shuffleHeadlines(industryId, serviceId);

        // Re-render the panel headlines list with the updated data
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Add headline
    $('.add-headline-panel-btn').on('click', function() {
        if (adGroup.headlines.length < 15) {
            adGroup.headlines.push('');
            $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
            // Update headline counter
            $('.headlines-count').text(adGroup.headlines.length);
            // Focus the new input
            $('.panel-headlines-list .headline-input').last().focus();
        }
    });

    // Update headline on input - handles both strings and objects
    $(document).on('input', '.headline-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();

        // Handle both strings and objects
        if (typeof adGroup.headlines[index] === 'string') {
            adGroup.headlines[index] = value;
        } else {
            adGroup.headlines[index].text = value;
        }

        // Update character counter with color feedback
        const charCount = $(this).closest('div[class*="p-3"]').find('.headline-char-count');
        charCount.text(`${value.length}/30`);
        charCount.removeClass('text-gray-400 text-yellow-500 text-red-500');
        if (value.length > 30) {
            charCount.addClass('text-red-500 font-medium');
        } else if (value.length > 25) {
            charCount.addClass('text-yellow-500');
        } else {
            charCount.addClass('text-gray-400');
        }
    });

    // Remove headline
    $(document).on('click', '.remove-headline-btn', function() {
        const index = $(this).data('index');
        adGroup.headlines.splice(index, 1);
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Toggle headline lock
    $(document).on('click', '.lock-headline-btn', function() {
        const index = $(this).data('index');
        const headline = adGroup.headlines[index];

        // Convert to object if necessary
        if (typeof headline === 'string') {
            adGroup.headlines[index] = { text: headline, locked: true };
        } else {
            adGroup.headlines[index].locked = !headline.locked;
        }

        // Re-render the list
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
    });

    // Template checkbox handler
    $('#use-as-template').on('change', function() {
        if ($(this).is(':checked')) {
            // Set this ad group as the template
            campaignConfig.template_ad_group = {
                type: 'industry',
                industry_id: industryId,
                service_id: serviceId,
                source_service_name: adGroup.service_name
            };
            console.log('Template set:', campaignConfig.template_ad_group);
        } else {
            // Only clear if this is the current template
            if (campaignConfig.template_ad_group.type === 'industry' &&
                campaignConfig.template_ad_group.industry_id === industryId &&
                campaignConfig.template_ad_group.service_id === serviceId) {
                campaignConfig.template_ad_group = {
                    type: null,
                    industry_id: null,
                    service_id: null,
                    source_service_name: null
                };
                console.log('Template cleared');
            }
        }
        // Re-render the campaign content to update template badge on ad group cards
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
    });

    // Apply template button handler
    $('.apply-template-btn').on('click', function() {
        applyTemplateToAdGroup(industryId, serviceId);
        // Re-render both lists
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Add description
    $('.add-description-panel-btn').on('click', function() {
        if (adGroup.descriptions.length < 4) {
            adGroup.descriptions.push('');
            $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
            $('.panel-descriptions-list .description-input').last().focus();
        }
    });

    // Generate descriptions with AI
    $('.generate-ai-descriptions-btn').on('click', async function() {
        const btn = $(this);
        const originalHtml = btn.html();

        // Loading state
        btn.prop('disabled', true);
        btn.html(`
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <span>Genererer...</span>
        `);

        try {
            // Collect USP texts from selected USP templates
            const uspTexts = [];
            campaignConfig.usp_ids.forEach(uspId => {
                // First try to get custom edited text, then display text, then original text from data attribute
                const uspCheckbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
                if (uspCheckbox.length) {
                    // Check if there's a custom text for this USP
                    if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
                        uspTexts.push(campaignConfig.usp_custom_texts[uspId]);
                    } else {
                        // Get the display text from .usp-display-text or fallback to original text
                        const uspItem = uspCheckbox.closest('.usp-item');
                        const displayText = uspItem.find('.usp-display-text').text().trim();
                        if (displayText) {
                            uspTexts.push(displayText);
                        } else {
                            // Fallback to data attribute
                            const originalText = uspCheckbox.data('original-text');
                            if (originalText) uspTexts.push(originalText);
                        }
                    }
                }
            });

            // Also add custom USPs added by user
            if (campaignConfig.custom_usps && campaignConfig.custom_usps.length > 0) {
                campaignConfig.custom_usps.forEach(usp => {
                    if (usp && usp.trim()) uspTexts.push(usp.trim());
                });
            }

            // Get keywords - extract keyword text from objects
            const keywordObjects = adGroup.keywords || [];
            const keywordStrings = keywordObjects.map(kw => typeof kw === 'string' ? kw : kw.keyword);

            // Get industry name
            const campaign = campaignConfig.campaigns[industryId];
            const industryName = campaign ? campaign.industry_name : '';

            const response = await fetch('/ajax/generate-descriptions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    service_name: adGroup.service_name,
                    industry_name: industryName,
                    usps: uspTexts,
                    keywords: keywordStrings.slice(0, 10)
                })
            });

            const data = await response.json();

            if (data.success) {
                // Replace descriptions with AI-generated ones
                adGroup.descriptions = data.descriptions;
                $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));

                // Update the descriptions count in the header
                $('.descriptions-count').text(adGroup.descriptions.length);

                // Success feedback
                showToast('4 beskrivelser genereret med AI!', 'success');
            } else {
                showToast('Fejl: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('AI generation error:', error);
            showToast('Kunne ikke generere beskrivelser', 'error');
        } finally {
            btn.prop('disabled', false);
            btn.html(originalHtml);
        }
    });

    // Update description on input
    $(document).on('input', '.description-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();
        adGroup.descriptions[index] = value;

        // Auto-resize textarea
        this.style.height = 'auto';
        this.style.height = Math.max(36, this.scrollHeight) + 'px';

        // Update character counter with color feedback
        const charCount = $(this).closest('div[class*="p-3"]').find('.desc-char-count');
        charCount.text(`${value.length}/90`);
        charCount.removeClass('text-gray-400 text-yellow-500 text-red-500 font-medium');
        if (value.length > 90) {
            charCount.addClass('text-red-500 font-medium');
        } else if (value.length > 75) {
            charCount.addClass('text-yellow-500');
        } else {
            charCount.addClass('text-gray-400');
        }
    });

    // Auto-resize description textareas on initial load
    $(document).on('focus', '.description-input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(36, this.scrollHeight) + 'px';
    });

    // Remove description
    $(document).on('click', '.remove-description-btn', function() {
        const index = $(this).data('index');
        adGroup.descriptions.splice(index, 1);
        $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
    });
}

// Setup GEO panel event handlers
function setupGeoPanelEventHandlers(serviceId) {
    const adGroup = campaignConfig.geo_campaigns[serviceId].ad_group;

    // Remove any existing document-level event handlers for GEO panel elements
    $(document).off('click', '.close-geo-panel-btn, #geo-panel-overlay');
    $(document).off('click', '.remove-geo-keyword-btn');
    $(document).off('click', '.lock-geo-headline-btn');
    $(document).off('input', '.geo-headline-input');
    $(document).off('input', '.geo-description-input');
    $(document).off('click', '.remove-geo-headline-btn');
    $(document).off('click', '.remove-geo-description-btn');

    // Close panel
    $(document).on('click', '.close-geo-panel-btn, #geo-panel-overlay', function() {
        // Auto-save state when closing panel
        saveStateToStorage();
        $('#geo-ad-group-edit-panel').remove();
        // Refresh the geo campaign content
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
    });

    // Add keyword
    $('.add-geo-keyword-panel-btn').on('click', function() {
        $('.add-geo-keyword-form').removeClass('hidden');
    });

    $('.cancel-geo-keyword-btn').on('click', function() {
        $('.add-geo-keyword-form').addClass('hidden');
        $('.new-geo-keyword-input').val('');
    });

    $('.save-new-geo-keyword-btn').on('click', function() {
        const keyword = $('.new-geo-keyword-input').val().trim();
        const matchType = $('.new-geo-keyword-match-type').val();

        if (keyword) {
            adGroup.keywords.push({
                keyword: keyword,
                match_type: matchType,
                is_primary: false
            });

            // Re-render keywords list
            $('.geo-panel-keywords-list').html(renderGeoPanelKeywordsList(adGroup.keywords, serviceId));
            $('.add-geo-keyword-form').addClass('hidden');
            $('.new-geo-keyword-input').val('');
        }
    });

    // Remove keyword
    $(document).on('click', '.remove-geo-keyword-btn', function() {
        const index = $(this).data('index');
        adGroup.keywords.splice(index, 1);
        $('.geo-panel-keywords-list').html(renderGeoPanelKeywordsList(adGroup.keywords, serviceId));
    });

    // Shuffle headlines for GEO - generates from selected USPs
    $('.shuffle-geo-headlines-panel-btn').on('click', function() {
        shuffleGeoHeadlines(serviceId);
        $('.geo-panel-headlines-list').html(renderGeoPanelHeadlinesList(serviceId, adGroup.headlines));
        $('.geo-headlines-count').text(adGroup.headlines.length);
    });

    // Add headline
    $('.add-geo-headline-panel-btn').on('click', function() {
        if (adGroup.headlines.length < 15) {
            adGroup.headlines.push('');
            $('.geo-panel-headlines-list').html(renderGeoPanelHeadlinesList(serviceId, adGroup.headlines));
            $('.geo-headlines-count').text(adGroup.headlines.length);
            $('.geo-panel-headlines-list .geo-headline-input').last().focus();
        }
    });

    // Update headline on input
    $(document).on('input', '.geo-headline-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();

        if (typeof adGroup.headlines[index] === 'string') {
            adGroup.headlines[index] = value;
        } else {
            adGroup.headlines[index].text = value;
        }

        // Update character counter
        const container = $(this).closest('div[class*="p-3"]');
        const charSpan = container.find('span.text-xs');
        charSpan.text(`${value.length}/30`);
        charSpan.removeClass('text-gray-400 text-yellow-500 text-red-500');
        if (value.length > 30) {
            charSpan.addClass('text-red-500');
        } else if (value.length > 25) {
            charSpan.addClass('text-yellow-500');
        } else {
            charSpan.addClass('text-gray-400');
        }
    });

    // Remove headline
    $(document).on('click', '.remove-geo-headline-btn', function() {
        const index = $(this).data('index');
        adGroup.headlines.splice(index, 1);
        $('.geo-panel-headlines-list').html(renderGeoPanelHeadlinesList(serviceId, adGroup.headlines));
        $('.geo-headlines-count').text(adGroup.headlines.length);
    });

    // Toggle headline lock
    $(document).on('click', '.lock-geo-headline-btn', function() {
        const index = $(this).data('index');
        const headline = adGroup.headlines[index];

        if (typeof headline === 'string') {
            adGroup.headlines[index] = { text: headline, locked: true };
        } else {
            adGroup.headlines[index].locked = !headline.locked;
        }

        $('.geo-panel-headlines-list').html(renderGeoPanelHeadlinesList(serviceId, adGroup.headlines));
    });

    // Add description
    $('.add-geo-description-panel-btn').on('click', function() {
        if (adGroup.descriptions.length < 4) {
            adGroup.descriptions.push('');
            $('.geo-panel-descriptions-list').html(renderGeoPanelDescriptionsList(serviceId, adGroup.descriptions));
            $('.geo-descriptions-count').text(adGroup.descriptions.length);
            $('.geo-panel-descriptions-list .geo-description-input').last().focus();
        }
    });

    // Generate descriptions with AI for GEO
    $('.generate-geo-ai-descriptions-btn').on('click', async function() {
        const btn = $(this);
        const originalHtml = btn.html();

        btn.prop('disabled', true);
        btn.html(`
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <span>Genererer...</span>
        `);

        try {
            const geoCampaign = campaignConfig.geo_campaigns[serviceId];

            // Collect USP texts
            const uspTexts = [];
            campaignConfig.usp_ids.forEach(uspId => {
                const uspCheckbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
                if (uspCheckbox.length) {
                    if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
                        uspTexts.push(campaignConfig.usp_custom_texts[uspId]);
                    } else {
                        const uspItem = uspCheckbox.closest('.usp-item');
                        const displayText = uspItem.find('.usp-display-text').text().trim();
                        if (displayText) {
                            uspTexts.push(displayText);
                        } else {
                            const originalText = uspCheckbox.data('original-text');
                            if (originalText) uspTexts.push(originalText);
                        }
                    }
                }
            });

            // Add custom USPs
            if (campaignConfig.custom_usps && campaignConfig.custom_usps.length > 0) {
                campaignConfig.custom_usps.forEach(usp => {
                    if (usp && usp.trim()) uspTexts.push(usp.trim());
                });
            }

            // Get keywords
            const keywordObjects = adGroup.keywords || [];
            const keywordStrings = keywordObjects.map(kw => typeof kw === 'string' ? kw : kw.keyword);

            const response = await fetch('/ajax/generate-descriptions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    service_name: geoCampaign.name,
                    industry_name: 'GEO Kampagne',
                    usps: uspTexts,
                    keywords: keywordStrings.slice(0, 10)
                })
            });

            const data = await response.json();

            if (data.success) {
                adGroup.descriptions = data.descriptions;
                $('.geo-panel-descriptions-list').html(renderGeoPanelDescriptionsList(serviceId, adGroup.descriptions));
                $('.geo-descriptions-count').text(adGroup.descriptions.length);
                showToast('4 beskrivelser genereret med AI!', 'success');
            } else {
                showToast('Fejl: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('AI generation error:', error);
            showToast('Kunne ikke generere beskrivelser', 'error');
        } finally {
            btn.prop('disabled', false);
            btn.html(originalHtml);
        }
    });

    // Update description on input
    $(document).on('input', '.geo-description-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();
        adGroup.descriptions[index] = value;

        // Auto-resize textarea
        this.style.height = 'auto';
        this.style.height = Math.max(36, this.scrollHeight) + 'px';

        // Update character counter
        const container = $(this).closest('div[class*="p-3"]');
        const charSpan = container.find('span.text-xs');
        charSpan.text(`${value.length}/90`);
        charSpan.removeClass('text-gray-400 text-yellow-500 text-red-500');
        if (value.length > 90) {
            charSpan.addClass('text-red-500');
        } else if (value.length > 75) {
            charSpan.addClass('text-yellow-500');
        } else {
            charSpan.addClass('text-gray-400');
        }
    });

    // Remove description
    $(document).on('click', '.remove-geo-description-btn', function() {
        const index = $(this).data('index');
        adGroup.descriptions.splice(index, 1);
        $('.geo-panel-descriptions-list').html(renderGeoPanelDescriptionsList(serviceId, adGroup.descriptions));
        $('.geo-descriptions-count').text(adGroup.descriptions.length);
    });

    // GEO Template checkbox handler
    $('#geo-use-as-template').on('change', function() {
        const geoCampaign = campaignConfig.geo_campaigns[serviceId];

        if ($(this).is(':checked')) {
            // Set this GEO ad group as the template
            campaignConfig.template_ad_group = {
                type: 'geo',
                industry_id: null,
                service_id: serviceId,
                source_service_name: geoCampaign.serviceName || geoCampaign.name
            };
            console.log('GEO Template set:', campaignConfig.template_ad_group);
        } else {
            // Only clear if this is the current template
            if (campaignConfig.template_ad_group?.type === 'geo' &&
                campaignConfig.template_ad_group?.service_id == serviceId) {
                campaignConfig.template_ad_group = {
                    type: null,
                    industry_id: null,
                    service_id: null,
                    source_service_name: null
                };
                console.log('GEO Template cleared');
            }
        }
    });

    // Apply template to GEO ad group
    $('.apply-geo-template-btn').on('click', function() {
        applyTemplateToGeoAdGroup(serviceId);
        // Re-render lists
        $('.geo-panel-headlines-list').html(renderGeoPanelHeadlinesList(serviceId, adGroup.headlines));
        $('.geo-panel-descriptions-list').html(renderGeoPanelDescriptionsList(serviceId, adGroup.descriptions));
        $('.geo-headlines-count').text(adGroup.headlines.length);
        $('.geo-descriptions-count').text(adGroup.descriptions.length);
        showToast('Template anvendt!', 'success');
    });
}

// Shuffle headlines for GEO campaigns
// Matches industry shuffleHeadlines() behavior with standard headlines and locked preservation
function shuffleGeoHeadlines(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const adGroup = geoCampaign.ad_group;
    const maxHeadlines = 15;

    // 1. Preserve locked headlines and note their positions
    const lockedHeadlines = [];
    const lockedIndices = new Set();

    if (adGroup.headlines && adGroup.headlines.length > 0) {
        adGroup.headlines.forEach((headline, index) => {
            if (typeof headline === 'object' && headline.locked) {
                lockedHeadlines.push({ index, headline });
                lockedIndices.add(index);
            }
        });
    }

    // Create a Set of locked headline texts for duplicate filtering
    const lockedTexts = new Set(
        lockedHeadlines.map(({ headline }) =>
            typeof headline === 'object' ? headline.text : headline
        )
    );

    // 2. Generate new headlines from USPs
    let availableHeadlines = [];

    campaignConfig.usp_ids.forEach(uspId => {
        const $checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
        if (!$checkbox.length) return;

        // Get example_headlines from data attribute
        let exampleHeadlines = [];
        try {
            let headlinesData = $checkbox.attr('data-example-headlines');
            if (headlinesData && headlinesData !== 'null' && headlinesData !== '[]' && headlinesData !== 'None') {
                exampleHeadlines = JSON.parse(headlinesData);
            }
        } catch (e) {
            console.warn('Could not parse example_headlines for USP', uspId, e);
        }

        if (Array.isArray(exampleHeadlines) && exampleHeadlines.length > 0) {
            // Pick 1 random headline from this USP's example_headlines
            const randomIndex = Math.floor(Math.random() * exampleHeadlines.length);
            let headline = exampleHeadlines[randomIndex];

            // Substitute variables - use service name from GEO campaign
            headline = substituteGeoHeadlineVariables(headline, serviceId, uspId);

            // Only add if within 30 character limit
            if (headline.length <= 30) {
                availableHeadlines.push({ text: headline, locked: false });
            }
        } else {
            // Fallback: Use USP text if no example_headlines
            const originalText = $checkbox.data('original-text');
            const finalText = getUspFinalText(uspId, originalText);
            if (finalText && finalText.length <= 30) {
                availableHeadlines.push({ text: finalText, locked: false });
            }
        }
    });

    // 3. Custom USPs are used 1:1 directly as headlines
    if (campaignConfig.custom_usps) {
        campaignConfig.custom_usps.forEach(usp => {
            if (usp && usp.length <= 30) {
                availableHeadlines.push({ text: usp, locked: false });
            }
        });
    }

    // Filter out headlines that match locked headline texts (avoid duplicates)
    availableHeadlines = availableHeadlines.filter(h => !lockedTexts.has(h.text));

    // 4. Add standard headlines with Google Ads dynamic insertion
    // {SERVICE} is substituted with the service name
    // {LOCATION(City)} is Google Ads native syntax - stays as is for dynamic city insertion
    // {KeyWord:{SERVICE}} becomes e.g. {KeyWord:Elektriker} for keyword insertion
    const standardHeadlineTemplates = [
        '{SERVICE} {LOCATION(City)}',
        '{KeyWord:{SERVICE}}'
    ];

    // Get service name from the GEO campaign
    const serviceName = geoCampaign.serviceName || geoCampaign.name || '';

    // Generate standard headlines (separate from regular pool)
    const standardHeadlines = [];
    console.log('GEO Standard headlines - serviceName:', serviceName);
    if (serviceName) {
        standardHeadlineTemplates.forEach(template => {
            // Only substitute {SERVICE} - leave {LOCATION(City)} and {KeyWord:...} as Google Ads syntax
            const substituted = template.replace(/\{SERVICE\}/gi, serviceName);
            console.log('GEO Standard headline template:', template, '-> substituted:', substituted, 'length:', substituted.length);
            if (substituted.length <= 30 && !lockedTexts.has(substituted)) {
                standardHeadlines.push({ text: substituted, locked: false, source: 'standard' });
            }
        });
    }
    console.log('GEO Standard headlines generated:', standardHeadlines.length, standardHeadlines);

    if (availableHeadlines.length === 0 && lockedHeadlines.length === 0 && standardHeadlines.length === 0) {
        alert('Ingen headlines fundet. Tjek at dine USPs har tilknyttede example_headlines eller tilf√∏j manuelt.');
        return;
    }

    // 5. Shuffle only the USP headlines (Fisher-Yates algorithm)
    for (let i = availableHeadlines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableHeadlines[i], availableHeadlines[j]] = [availableHeadlines[j], availableHeadlines[i]];
    }

    // 6. Calculate how many new headlines we need
    const slotsNeeded = maxHeadlines - lockedHeadlines.length;
    const finalHeadlines = new Array(maxHeadlines).fill(null);

    // 7. Place locked headlines at their original positions
    lockedHeadlines.forEach(({ index, headline }) => {
        if (index < maxHeadlines) {
            finalHeadlines[index] = headline;
        }
    });

    // 8. Fill empty slots - FIRST with standard headlines (always included), then with USP headlines
    let slotIndex = 0;

    // First: Add standard headlines to the first available slots
    for (let stdIdx = 0; stdIdx < standardHeadlines.length && slotIndex < maxHeadlines; ) {
        if (finalHeadlines[slotIndex] === null) {
            finalHeadlines[slotIndex] = standardHeadlines[stdIdx];
            stdIdx++;
        }
        slotIndex++;
    }

    // Then: Fill remaining slots with USP headlines
    let uspIndex = 0;
    for (let i = 0; i < maxHeadlines && uspIndex < availableHeadlines.length; i++) {
        if (finalHeadlines[i] === null) {
            finalHeadlines[i] = availableHeadlines[uspIndex++];
        }
    }

    // 9. Remove null values and update
    adGroup.headlines = finalHeadlines.filter(h => h !== null);

    console.log('Shuffled GEO headlines (locked:', lockedHeadlines.length, ', new:', adGroup.headlines.length - lockedHeadlines.length, '):', adGroup.headlines);
}

// Helper function: Substitute variables in GEO headline text
function substituteGeoHeadlineVariables(headline, serviceId, uspId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    const serviceName = geoCampaign?.serviceName || geoCampaign?.name || '';

    let result = headline;

    // Apply USP-specific variable substitution (VAR1, VAR2, VAR3)
    if (uspId) {
        result = substituteUspVariables(result, uspId);
    }

    // Apply general placeholders
    if (serviceName) {
        result = result.replace(/\{SERVICE\}/gi, serviceName);
    }

    return result;
}

// Render GEO campaign accordion - now accepts serviceId for multiple campaigns
function renderGeoCampaignAccordion(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    const keywordCount = geoCampaign.ad_group.keywords.length;

    let keywordsHtml = '';
    geoCampaign.ad_group.keywords.forEach((kw, index) => {
        keywordsHtml += `
            <div class="geo-keyword-item flex items-center justify-between p-2 bg-white rounded border border-gray-200 mb-2" data-index="${index}" data-service-id="${serviceId}">
                <div class="flex-1">
                    <span class="font-medium text-gray-900">${escapeHtml(kw.keyword)}</span>
                    <span class="match-type-badge text-xs text-gray-500 ml-2">[${kw.match_type}]</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-blue-600 truncate max-w-xs" title="${escapeHtml(kw.url)}">${escapeHtml(kw.url)}</span>
                </div>
            </div>
        `;
    });

    let html = `
        <div class="campaign-accordion geo-campaign-accordion bg-white rounded-2xl shadow-lg border border-green-200 overflow-hidden mb-4" data-campaign-type="geo" data-service-id="${serviceId}">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #10B98120, #10B98110);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-green-600 to-emerald-600">
                            üåç
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${escapeHtml(geoCampaign.name)}</h3>
                            <p class="text-sm text-gray-600">${keywordCount} geo-s√∏geord med URL'er</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">GEO</span>
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="geo-campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" value="${geoCampaign.daily_budget}" data-service-id="${serviceId}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="geo-campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-service-id="${serviceId}">
                                <option value="maximize_clicks" ${geoCampaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                                <option value="maximize_conversions" ${geoCampaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                                <option value="target_cpa" ${geoCampaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                                <option value="manual_cpc" ${geoCampaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                            </select>
                        </div>
                        <div class="geo-target-cpa-field" style="display: ${geoCampaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};" data-service-id="${serviceId}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="geo-campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" value="${geoCampaign.target_cpa || ''}" data-service-id="${serviceId}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keyword Match Type</label>
                            <select class="geo-campaign-match-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-service-id="${serviceId}">
                                <option value="phrase" ${geoCampaign.match_type === 'phrase' ? 'selected' : ''}>Phrase Match</option>
                                <option value="exact" ${geoCampaign.match_type === 'exact' ? 'selected' : ''}>Exact Match</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="geo-negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3" data-service-id="${serviceId}">
                        ${renderNegativeKeywordListsForGeo(geoCampaign.negative_keyword_list_ids, serviceId)}
                    </div>
                </div>

                <!-- GEO Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üîë</span>
                        GEO S√∏geord med URL'er
                    </h4>
                    <p class="text-sm text-gray-600 mb-4">
                        Hvert s√∏geord har sin egen landing page URL. Format: {service} {by} ‚Üí /{service}-{by}/
                    </p>
                    <div class="geo-keywords-container max-h-64 overflow-y-auto" data-service-id="${serviceId}">
                        ${keywordsHtml}
                    </div>
                </div>

                <!-- GEO Headlines Section -->
                <div class="p-6 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-yellow-100 text-yellow-700">üìù</span>
                            Headlines (<span class="geo-headlines-count" data-service-id="${serviceId}">${geoCampaign.ad_group.headlines?.length || 0}</span>/15)
                        </h4>
                        <div class="flex space-x-2">
                            <button type="button" class="geo-shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-service-id="${serviceId}">
                                üîÄ Shuffle
                            </button>
                            <button type="button" class="geo-add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-service-id="${serviceId}">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="geo-headlines-list space-y-2" data-service-id="${serviceId}">
                        ${renderGeoHeadlinesList(serviceId, geoCampaign.ad_group.headlines || [])}
                    </div>
                </div>

                <!-- GEO Descriptions Section -->
                <div class="p-6 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üìÑ</span>
                            Descriptions (<span class="geo-descriptions-count" data-service-id="${serviceId}">${geoCampaign.ad_group.descriptions?.length || 0}</span>/4)
                        </h4>
                        <button type="button" class="geo-add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-service-id="${serviceId}">
                            + Tilf√∏j
                        </button>
                    </div>
                    <div class="geo-descriptions-list space-y-2" data-service-id="${serviceId}">
                        ${renderGeoDescriptionsList(serviceId, geoCampaign.ad_group.descriptions || [])}
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

// Render negative keyword lists for GEO campaign - now accepts serviceId for multiple campaigns
function renderNegativeKeywordListsForGeo(selectedIds, serviceId) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-sm text-gray-500 col-span-2">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    let html = '';
    serverData.negative_keyword_lists.forEach(list => {
        const isChecked = selectedIds && selectedIds.includes(list.id);
        html += `
            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                <input type="checkbox" class="geo-negative-list-checkbox w-4 h-4 text-green-600 rounded"
                       data-list-id="${list.id}" data-service-id="${serviceId}" ${isChecked ? 'checked' : ''}>
                <span class="ml-3 text-sm text-gray-700">${escapeHtml(list.name)}</span>
                <span class="ml-auto text-xs text-gray-400">${list.keyword_count || 0} ord</span>
            </label>
        `;
    });

    return html;
}

// Render GEO headlines list
function renderGeoHeadlinesList(serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Shuffle" for at auto-generere headlines fra USPs, eller "Tilf√∏j" for manuel tilf√∏jelse</p>';
    }

    return headlines.map((headline, index) => `
        <div class="geo-headline-item flex items-center space-x-2" data-service-id="${serviceId}">
            <input type="text" class="geo-headline-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent"
                   value="${escapeHtml(headline)}" maxlength="30" data-index="${index}" data-service-id="${serviceId}">
            <span class="text-xs text-gray-500 w-10">${headline.length}/30</span>
            <button type="button" class="remove-geo-headline-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}" data-service-id="${serviceId}">‚úï</button>
        </div>
    `).join('');
}

// Render GEO descriptions list
function renderGeoDescriptionsList(serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Tilf√∏j" for at tilf√∏je beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="geo-description-item flex items-center space-x-2" data-service-id="${serviceId}">
            <textarea class="geo-description-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                      maxlength="90" rows="2" data-index="${index}" data-service-id="${serviceId}">${escapeHtml(desc)}</textarea>
            <span class="text-xs text-gray-500 w-10">${desc.length}/90</span>
            <button type="button" class="remove-geo-description-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}" data-service-id="${serviceId}">‚úï</button>
        </div>
    `).join('');
}

// Add headline to GEO campaign
function addGeoHeadline(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    // Initialize headlines if not exists
    if (!geoCampaign.ad_group.headlines) {
        geoCampaign.ad_group.headlines = [];
    }

    if (geoCampaign.ad_group.headlines.length >= 15) {
        alert('Maksimalt 15 headlines per GEO kampagne.');
        return;
    }

    geoCampaign.ad_group.headlines.push('');
    refreshGeoHeadlinesList(serviceId);
}

// Add description to GEO campaign
function addGeoDescription(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    // Initialize descriptions if not exists
    if (!geoCampaign.ad_group.descriptions) {
        geoCampaign.ad_group.descriptions = [];
    }

    if (geoCampaign.ad_group.descriptions.length >= 4) {
        alert('Maksimalt 4 beskrivelser per GEO kampagne.');
        return;
    }

    geoCampaign.ad_group.descriptions.push('');
    refreshGeoDescriptionsList(serviceId);
}

// Remove headline from GEO campaign
function removeGeoHeadline(serviceId, index) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign || !geoCampaign.ad_group.headlines) return;

    geoCampaign.ad_group.headlines.splice(index, 1);
    refreshGeoHeadlinesList(serviceId);
}

// Remove description from GEO campaign
function removeGeoDescription(serviceId, index) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign || !geoCampaign.ad_group.descriptions) return;

    geoCampaign.ad_group.descriptions.splice(index, 1);
    refreshGeoDescriptionsList(serviceId);
}

// Refresh GEO headlines list in UI
function refreshGeoHeadlinesList(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const headlinesList = $(`.geo-headlines-list[data-service-id="${serviceId}"]`);
    headlinesList.html(renderGeoHeadlinesList(serviceId, geoCampaign.ad_group.headlines || []));

    // Update count
    $(`.geo-headlines-count[data-service-id="${serviceId}"]`).text(geoCampaign.ad_group.headlines?.length || 0);
}

// Refresh GEO descriptions list in UI
function refreshGeoDescriptionsList(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const descList = $(`.geo-descriptions-list[data-service-id="${serviceId}"]`);
    descList.html(renderGeoDescriptionsList(serviceId, geoCampaign.ad_group.descriptions || []));

    // Update count
    $(`.geo-descriptions-count[data-service-id="${serviceId}"]`).text(geoCampaign.ad_group.descriptions?.length || 0);
}

// =====================================================
// Negative Keyword Editor Functions
// =====================================================

// Current state for the negative keyword editor
let negativeKeywordEditorState = {
    listId: null,
    listName: '',
    industryId: null,
    serverKeywords: [],  // Keywords from server
    isLoading: false
};

// Open the negative keyword editor modal
function openNegativeKeywordEditor(listId, listName, industryId) {
    negativeKeywordEditorState.listId = listId;
    negativeKeywordEditorState.listName = listName;
    negativeKeywordEditorState.industryId = industryId;
    negativeKeywordEditorState.isLoading = true;

    // Update modal title
    $('#neg-editor-title').text(listName);
    $('#neg-editor-subtitle').text('Indl√¶ser s√∏geord...');

    // Show loading state
    $('#neg-editor-keywords-list').html('<p class="text-center text-gray-500 py-8">Indl√¶ser s√∏geord...</p>');

    // Show modal
    const modal = document.getElementById('negative-keywords-editor-modal');
    if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
    }
    modal.style.display = 'flex';

    // Fetch keywords from server
    $.ajax({
        url: `/ajax/get-negative-keywords/${listId}/`,
        method: 'GET'
    }).done(function(response) {
        negativeKeywordEditorState.serverKeywords = response.keywords || [];
        negativeKeywordEditorState.isLoading = false;
        $('#neg-editor-subtitle').text('Se og rediger s√∏geord i listen');
        renderNegativeKeywordEditorList();
    }).fail(function() {
        negativeKeywordEditorState.isLoading = false;
        $('#neg-editor-keywords-list').html('<p class="text-center text-red-500 py-8">Fejl ved indl√¶sning af s√∏geord</p>');
    });
}

// Close the negative keyword editor modal
function closeNegativeKeywordEditor() {
    const modal = document.getElementById('negative-keywords-editor-modal');
    modal.style.display = 'none';

    // Clear input
    $('#neg-editor-new-keyword').val('');

    // Update keyword count in main view
    updateNegativeKeywordListCount(negativeKeywordEditorState.listId);
}

// Render the keywords list in the editor
function renderNegativeKeywordEditorList() {
    const listId = negativeKeywordEditorState.listId;
    const serverKeywords = negativeKeywordEditorState.serverKeywords;
    const customKeywords = campaignConfig.custom_negative_keywords[listId] || [];

    let html = '';

    // First render custom keywords (added in this session) - marked with green badge
    customKeywords.forEach((keyword, index) => {
        html += `
            <div class="flex items-center justify-between p-2 bg-green-50 rounded border border-green-200">
                <div class="flex items-center space-x-2">
                    <span class="text-xs px-2 py-0.5 bg-green-500 text-white rounded">Ny</span>
                    <span class="text-sm text-gray-800">${escapeHtml(keyword)}</span>
                </div>
                <button type="button" class="remove-custom-neg-keyword-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">
                    ‚úï
                </button>
            </div>
        `;
    });

    // Then render server keywords
    serverKeywords.forEach(keyword => {
        const keywordText = typeof keyword === 'string' ? keyword : keyword.keyword_text;
        html += `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                <span class="text-sm text-gray-800">${escapeHtml(keywordText)}</span>
                <span class="text-xs text-gray-400">Fra liste</span>
            </div>
        `;
    });

    if (!html) {
        html = '<p class="text-center text-gray-500 py-4">Ingen s√∏geord i listen</p>';
    }

    $('#neg-editor-keywords-list').html(html);

    // Update counts
    const totalCount = serverKeywords.length + customKeywords.length;
    $('#neg-editor-count').text(totalCount);
    $('#neg-editor-custom-count').text(customKeywords.length);
}

// Add a new custom negative keyword
function addCustomNegativeKeyword(keyword) {
    const listId = negativeKeywordEditorState.listId;
    const trimmedKeyword = keyword.trim().toLowerCase();

    if (!trimmedKeyword) return;

    // Initialize array if not exists
    if (!campaignConfig.custom_negative_keywords[listId]) {
        campaignConfig.custom_negative_keywords[listId] = [];
    }

    // Check for duplicates
    const customKeywords = campaignConfig.custom_negative_keywords[listId];
    const serverKeywords = negativeKeywordEditorState.serverKeywords;

    const existsInCustom = customKeywords.some(k => k.toLowerCase() === trimmedKeyword);
    const existsInServer = serverKeywords.some(k => {
        const kText = typeof k === 'string' ? k : k.keyword_text;
        return kText.toLowerCase() === trimmedKeyword;
    });

    if (existsInCustom || existsInServer) {
        alert('S√∏geordet findes allerede i listen');
        return;
    }

    // Add keyword
    campaignConfig.custom_negative_keywords[listId].push(trimmedKeyword);

    // Re-render list
    renderNegativeKeywordEditorList();

    // Clear input
    $('#neg-editor-new-keyword').val('').focus();
}

// Remove a custom negative keyword
function removeCustomNegativeKeyword(index) {
    const listId = negativeKeywordEditorState.listId;
    if (campaignConfig.custom_negative_keywords[listId]) {
        campaignConfig.custom_negative_keywords[listId].splice(index, 1);
        renderNegativeKeywordEditorList();
    }
}

// Update the keyword count displayed in the main view
function updateNegativeKeywordListCount(listId) {
    const serverList = serverData.negative_keyword_lists.find(l => l.id === listId);
    const serverCount = serverList ? serverList.keyword_count : 0;
    const customCount = (campaignConfig.custom_negative_keywords[listId] || []).length;
    const totalCount = serverCount + customCount;

    $(`.neg-list-keyword-count[data-list-id="${listId}"]`).text(totalCount);
}

// Event handlers for negative keyword editor
$(document).on('click', '.view-edit-neg-keywords-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const listId = $(this).data('list-id');
    const listName = $(this).data('list-name');
    const industryId = $(this).data('industry-id');
    openNegativeKeywordEditor(listId, listName, industryId);
});

$(document).on('click', '#neg-editor-close, #neg-editor-done-btn, .neg-editor-backdrop', function(e) {
    if (e.target === this) {
        closeNegativeKeywordEditor();
    }
});

$(document).on('click', '#neg-editor-add-btn', function() {
    const keyword = $('#neg-editor-new-keyword').val();
    addCustomNegativeKeyword(keyword);
});

$(document).on('keypress', '#neg-editor-new-keyword', function(e) {
    if (e.which === 13) {
        e.preventDefault();
        const keyword = $(this).val();
        addCustomNegativeKeyword(keyword);
    }
});

$(document).on('click', '.remove-custom-neg-keyword-btn', function() {
    const index = $(this).data('index');
    removeCustomNegativeKeyword(index);
});

// Event handler for GEO campaign match type changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-match-type', function() {
    const newMatchType = $(this).val();
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        // Update specific campaign
        campaignConfig.geo_campaigns[serviceId].match_type = newMatchType;

        // Update all keywords in this campaign with new match type
        campaignConfig.geo_campaigns[serviceId].ad_group.keywords.forEach(kw => {
            kw.match_type = newMatchType;
        });

        // Update UI display of match type badges for this campaign only
        $(`.geo-campaign-accordion[data-service-id="${serviceId}"] .geo-keyword-item .match-type-badge`).text(`[${newMatchType}]`);

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else {
        // Fallback for backward compatibility
        if (campaignConfig.geo_campaign) {
            campaignConfig.geo_campaign.match_type = newMatchType;
            campaignConfig.geo_campaign.ad_group.keywords.forEach(kw => {
                kw.match_type = newMatchType;
            });
            $('.geo-keyword-item .match-type-badge').text(`[${newMatchType}]`);
        }
    }
});

// Event handler for GEO campaign daily budget changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-daily-budget', function() {
    const newBudget = parseInt($(this).val()) || 300;
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].daily_budget = newBudget;

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.daily_budget = newBudget;
    }
});

// Event handler for GEO campaign bidding strategy changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-bidding-strategy', function() {
    const newStrategy = $(this).val();
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].bidding_strategy = newStrategy;

        // Show/hide target CPA field for this campaign
        const targetCpaField = $(`.geo-target-cpa-field[data-service-id="${serviceId}"]`);
        if (newStrategy === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.bidding_strategy = newStrategy;
        if (newStrategy === 'target_cpa') {
            $('.geo-target-cpa-field').show();
        } else {
            $('.geo-target-cpa-field').hide();
        }
    }
});

// Event handler for GEO campaign target CPA changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-target-cpa', function() {
    const newTargetCpa = parseInt($(this).val()) || 0;
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].target_cpa = newTargetCpa;

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.target_cpa = newTargetCpa;
    }
});

// Event handler for GEO campaign negative keyword list changes - supports multiple campaigns
$(document).on('change', '.geo-negative-list-checkbox', function() {
    const listId = parseInt($(this).data('list-id'));
    const serviceId = $(this).data('service-id');
    const isChecked = $(this).is(':checked');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        if (!campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids) {
            campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids = [];
        }

        if (isChecked) {
            if (!campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.includes(listId)) {
                campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids =
                campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.filter(id => id !== listId);
        }

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        if (!campaignConfig.geo_campaign.negative_keyword_list_ids) {
            campaignConfig.geo_campaign.negative_keyword_list_ids = [];
        }

        if (isChecked) {
            if (!campaignConfig.geo_campaign.negative_keyword_list_ids.includes(listId)) {
                campaignConfig.geo_campaign.negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.geo_campaign.negative_keyword_list_ids =
                campaignConfig.geo_campaign.negative_keyword_list_ids.filter(id => id !== listId);
        }
    }
});

// Event handlers for GEO Headlines
$(document).on('click', '.geo-add-headline-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    addGeoHeadline(serviceId);
});

$(document).on('click', '.geo-shuffle-headlines-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    shuffleGeoHeadlines(serviceId);
});

$(document).on('click', '.remove-geo-headline-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    removeGeoHeadline(serviceId, index);
});

$(document).on('input', '.geo-headline-input', function() {
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    const value = $(this).val();
    const len = value.length;

    // Update character count
    $(this).siblings('span').text(`${len}/30`);
    if (len > 30) {
        $(this).siblings('span').addClass('text-red-500');
    } else {
        $(this).siblings('span').removeClass('text-red-500');
    }

    // Update campaignConfig
    if (campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].ad_group.headlines[index] = value;
    }
});

// Event handlers for GEO Descriptions
$(document).on('click', '.geo-add-description-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    addGeoDescription(serviceId);
});

$(document).on('click', '.remove-geo-description-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    removeGeoDescription(serviceId, index);
});

$(document).on('input', '.geo-description-input', function() {
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    const value = $(this).val();
    const len = value.length;

    // Update character count
    $(this).siblings('span').text(`${len}/90`);
    if (len > 90) {
        $(this).siblings('span').addClass('text-red-500');
    } else {
        $(this).siblings('span').removeClass('text-red-500');
    }

    // Update campaignConfig
    if (campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].ad_group.descriptions[index] = value;
    }
});

// Render a single campaign accordion
function renderCampaignAccordion(industryId, industryInfo) {
    const campaign = campaignConfig.campaigns[industryId];
    const adGroupCount = Object.keys(campaign.ad_groups).length;

    let html = `
        <div class="campaign-accordion bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" data-industry-id="${industryId}">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #8B5CF620, #8B5CF610);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-purple-600 to-pink-600">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${escapeHtml(industryInfo.name)}</h3>
                            <p class="text-sm text-gray-600">${adGroupCount} annoncegruppe${adGroupCount !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="${campaign.daily_budget}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="maximize_clicks" ${campaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                                <option value="maximize_conversions" ${campaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                                <option value="target_cpa" ${campaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                                <option value="target_roas" ${campaign.bidding_strategy === 'target_roas' ? 'selected' : ''}>Target ROAS</option>
                                <option value="manual_cpc" ${campaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                            </select>
                        </div>
                        <div class="target-cpa-field" style="display: ${campaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="${campaign.target_cpa || ''}">
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${renderNegativeKeywordLists(industryId, campaign.negative_keyword_list_ids)}
                    </div>
                </div>

                <!-- Ad Groups Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4">Annoncegrupper</h4>
                    <div class="ad-groups-container space-y-4">
                        ${renderAdGroups(industryId, industryInfo.services)}
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

// Render negative keyword list checkboxes
function renderNegativeKeywordLists(industryId, selectedIds) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-gray-500 text-sm">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    return serverData.negative_keyword_lists.map(list => {
        const isChecked = selectedIds.includes(list.id) ? 'checked' : '';
        return `
            <div class="flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                <label class="flex items-center cursor-pointer flex-1">
                    <input type="checkbox" class="neg-keyword-list-checkbox w-4 h-4 text-purple-600 rounded focus:ring-purple-500 mr-3"
                           data-industry-id="${industryId}" data-list-id="${list.id}" ${isChecked}>
                    <div>
                        <span class="font-medium text-gray-900">${escapeHtml(list.name)}</span>
                        <span class="text-xs text-gray-500 ml-2">(<span class="neg-list-keyword-count" data-list-id="${list.id}">${list.keyword_count}</span> s√∏geord)</span>
                    </div>
                </label>
                <button type="button" class="view-edit-neg-keywords-btn ml-2 text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                        data-list-id="${list.id}" data-list-name="${escapeHtml(list.name)}" data-industry-id="${industryId}">
                    Se/Rediger
                </button>
            </div>
        `;
    }).join('');
}

// Render ad groups for a campaign
function renderAdGroups(industryId, services) {
    const campaign = campaignConfig.campaigns[industryId];

    return services.filter(s => campaignConfig.service_ids.includes(s.id)).map(service => {
        const adGroup = campaign.ad_groups[service.id] || {
            headlines: [],
            descriptions: [],
            keywords: service.keywords || []
        };

        return `
            <div class="ad-group-item bg-gray-50 rounded-xl p-4 border border-gray-200" data-service-id="${service.id}" data-industry-id="${industryId}">
                <!-- Ad Group Header -->
                <div class="ad-group-header flex items-center justify-between mb-4 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-blue-100 text-blue-700">
                            üîß
                        </div>
                        <div>
                            <h5 class="font-semibold text-gray-900">${escapeHtml(service.name)}</h5>
                            <p class="text-xs text-gray-500">${adGroup.keywords.length} s√∏geord</p>
                        </div>
                    </div>
                    <span class="ad-group-toggle-icon text-xl transition-transform duration-200">‚ñº</span>
                </div>

                <!-- Ad Group Content -->
                <div class="ad-group-content">
                    <!-- Keywords Section -->
                    <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm flex items-center">
                                <span class="mr-2">üîë</span> S√∏geord
                            </h6>
                            <button type="button" class="add-keyword-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                    data-industry-id="${industryId}" data-service-id="${service.id}">
                                + Tilf√∏j
                            </button>
                        </div>
                        <div class="keywords-list space-y-1 text-sm max-h-32 overflow-y-auto" data-service-id="${service.id}" data-industry-id="${industryId}">
                            ${renderKeywordsList(adGroup.keywords, service.id)}
                        </div>
                    </div>

                    <!-- Headlines Section -->
                    <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm">
                                Headlines (<span class="headlines-count">${adGroup.headlines.length}</span>/15)
                            </h6>
                            <div class="flex space-x-2">
                                <button type="button" class="shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors flex items-center"
                                        data-industry-id="${industryId}" data-service-id="${service.id}">
                                    üîÄ Shuffle
                                </button>
                                <button type="button" class="add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                        data-industry-id="${industryId}" data-service-id="${service.id}">
                                    + Tilf√∏j
                                </button>
                            </div>
                        </div>
                        <div class="headlines-list space-y-2">
                            ${renderHeadlinesList(industryId, service.id, adGroup.headlines)}
                        </div>
                    </div>

                    <!-- Descriptions Section -->
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm">
                                Descriptions (<span class="descriptions-count">${adGroup.descriptions.length}</span>/4)
                            </h6>
                            <button type="button" class="add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                    data-industry-id="${industryId}" data-service-id="${service.id}">
                                + Tilf√∏j
                            </button>
                        </div>
                        <div class="descriptions-list space-y-2">
                            ${renderDescriptionsList(industryId, service.id, adGroup.descriptions)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Render keywords list with edit/delete buttons (like Industry Manager)
function renderKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<p class="text-gray-400 text-xs">Ingen s√∏geord defineret. Tilf√∏j keywords i Industry Manager.</p>';
    }

    // Build table HTML (same format as Industry Manager)
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left py-2 px-3 font-medium text-gray-700 text-xs">Keyword</th>
                        <th class="text-left py-2 px-3 font-medium text-gray-700 text-xs">Match Type</th>
                        <th class="text-center py-2 px-3 font-medium text-gray-700 text-xs">Prim.</th>
                        <th class="text-right py-2 px-3 font-medium text-gray-700 text-xs">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">`;

    keywords.forEach(kw => {
        const keyword = typeof kw === 'string' ? kw : kw.keyword;
        const matchType = typeof kw === 'object' && kw.match_type ? kw.match_type : 'broad';
        const isPrimary = typeof kw === 'object' && kw.is_primary;
        const keywordId = typeof kw === 'object' && kw.id ? kw.id : null;

        // Match type badge classes (same as Industry Manager)
        const matchTypeBadgeClass = matchType === 'exact' ? 'bg-purple-100 text-purple-800' :
                                   matchType === 'phrase' ? 'bg-blue-100 text-blue-800' :
                                   'bg-gray-100 text-gray-800';

        // Match type display text
        const matchTypeDisplay = matchType === 'exact' ? 'Exact Match' :
                                matchType === 'phrase' ? 'Phrase Match' : 'Broad Match';

        // Primary icon
        const primaryIcon = isPrimary ? '<span class="text-yellow-500 text-sm">‚≠ê</span>' : '<span class="text-gray-300 text-sm">‚òÜ</span>';

        // Action buttons
        const actionButtons = keywordId ? `
            <button class="edit-service-keyword-btn text-gray-400 hover:text-purple-600 p-1"
                    data-keyword-id="${keywordId}" data-service-id="${serviceId || ''}" title="Rediger keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </button>
            <button class="delete-service-keyword-btn text-gray-400 hover:text-red-600 p-1"
                    data-keyword-id="${keywordId}" data-service-id="${serviceId || ''}" title="Slet keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </button>
        ` : '';

        html += `
            <tr class="keyword-row hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keywordId || ''}">
                <td class="py-2 px-3">
                    <span class="keyword-text font-medium text-gray-900 text-xs">${escapeHtml(keyword)}</span>
                </td>
                <td class="py-2 px-3">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${matchTypeBadgeClass}">
                        ${matchTypeDisplay}
                    </span>
                </td>
                <td class="py-2 px-3 text-center">
                    ${primaryIcon}
                </td>
                <td class="py-2 px-3 text-right">
                    <div class="flex items-center justify-end space-x-1">
                        ${actionButtons}
                    </div>
                </td>
            </tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

// Render headlines list
function renderHeadlinesList(industryId, serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Shuffle" for at auto-generere headlines fra USPs, eller "Tilf√∏j" for manuel tilf√∏jelse</p>';
    }

    return headlines.map((headline, index) => `
        <div class="headline-item flex items-center space-x-2">
            <input type="text" class="headline-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   value="${escapeHtml(headline)}" maxlength="30" data-index="${index}">
            <span class="text-xs text-gray-500 w-10">${headline.length}/30</span>
            <button type="button" class="remove-headline-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">‚úï</button>
        </div>
    `).join('');
}

// Render descriptions list
function renderDescriptionsList(industryId, serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Tilf√∏j" for at tilf√∏je beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="description-item flex items-center space-x-2">
            <textarea class="description-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                      maxlength="90" rows="2" data-index="${index}">${escapeHtml(desc)}</textarea>
            <span class="text-xs text-gray-500 w-10">${desc.length}/90</span>
            <button type="button" class="remove-description-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">‚úï</button>
        </div>
    `).join('');
}

// Setup event handlers for campaign accordions
function setupCampaignAccordionHandlers() {
    // Campaign accordion toggle
    $(document).off('click', '.campaign-header').on('click', '.campaign-header', function() {
        const accordion = $(this).closest('.campaign-accordion');
        const content = accordion.find('.campaign-content');
        const icon = $(this).find('.campaign-toggle-icon');

        content.slideToggle(200);
        icon.toggleClass('rotate-180');
    });

    // Ad group toggle
    $(document).off('click', '.ad-group-header').on('click', '.ad-group-header', function() {
        const adGroup = $(this).closest('.ad-group-item');
        const content = adGroup.find('.ad-group-content');
        const icon = $(this).find('.ad-group-toggle-icon');

        content.slideToggle(200);
        icon.toggleClass('rotate-180');
    });

    // Bidding strategy change - show/hide target CPA field
    $(document).off('change', '.campaign-bidding-strategy').on('change', '.campaign-bidding-strategy', function() {
        const accordion = $(this).closest('.campaign-accordion');
        const targetCpaField = accordion.find('.target-cpa-field');

        if ($(this).val() === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }
    });

    // Negative keyword list checkbox
    $(document).off('change', '.neg-keyword-list-checkbox').on('change', '.neg-keyword-list-checkbox', function() {
        const industryId = $(this).data('industry-id');
        const listId = $(this).data('list-id');

        if ($(this).is(':checked')) {
            if (!campaignConfig.campaigns[industryId].negative_keyword_list_ids.includes(listId)) {
                campaignConfig.campaigns[industryId].negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.campaigns[industryId].negative_keyword_list_ids =
                campaignConfig.campaigns[industryId].negative_keyword_list_ids.filter(id => id !== listId);
        }
    });

    // Shuffle headlines button
    $(document).off('click', '.shuffle-headlines-btn').on('click', '.shuffle-headlines-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        shuffleHeadlines(industryId, serviceId);
    });

    // Add headline button
    $(document).off('click', '.add-headline-btn').on('click', '.add-headline-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        addHeadline(industryId, serviceId);
    });

    // Add description button
    $(document).off('click', '.add-description-btn').on('click', '.add-description-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        addDescription(industryId, serviceId);
    });

    // Remove headline button
    $(document).off('click', '.remove-headline-btn').on('click', '.remove-headline-btn', function(e) {
        e.stopPropagation();
        const adGroup = $(this).closest('.ad-group-item');
        const industryId = adGroup.data('industry-id');
        const serviceId = adGroup.data('service-id');
        const index = $(this).data('index');
        removeHeadline(industryId, serviceId, index);
    });

    // Remove description button
    $(document).off('click', '.remove-description-btn').on('click', '.remove-description-btn', function(e) {
        e.stopPropagation();
        const adGroup = $(this).closest('.ad-group-item');
        const industryId = adGroup.data('industry-id');
        const serviceId = adGroup.data('service-id');
        const index = $(this).data('index');
        removeDescription(industryId, serviceId, index);
    });

    // Headline input change - update character count
    $(document).off('input', '.headline-input').on('input', '.headline-input', function() {
        const len = $(this).val().length;
        $(this).siblings('span').text(`${len}/30`);
        if (len > 30) {
            $(this).siblings('span').addClass('text-red-500');
        } else {
            $(this).siblings('span').removeClass('text-red-500');
        }
    });

    // Description input change - update character count
    $(document).off('input', '.description-input').on('input', '.description-input', function() {
        const len = $(this).val().length;
        $(this).siblings('span').text(`${len}/90`);
        if (len > 90) {
            $(this).siblings('span').addClass('text-red-500');
        } else {
            $(this).siblings('span').removeClass('text-red-500');
        }
    });

    // Add keyword button - show inline form
    $(document).off('click', '.add-keyword-btn').on('click', '.add-keyword-btn', function(e) {
        e.stopPropagation();
        const adGroupItem = $(this).closest('.ad-group-item');
        const industryId = adGroupItem.data('industry-id');
        const serviceId = adGroupItem.data('service-id');
        showAddKeywordForm(industryId, serviceId);
    });

    // Save new keyword
    $(document).off('click', '.save-new-keyword-btn').on('click', '.save-new-keyword-btn', function(e) {
        e.stopPropagation();
        const form = $(this).closest('.add-keyword-form');
        const adGroupItem = form.closest('.ad-group-item');
        const industryId = adGroupItem.data('industry-id');
        const serviceId = adGroupItem.data('service-id');
        const keyword = form.find('.new-keyword-input').val().trim();
        const matchType = form.find('.new-keyword-match-type').val();

        if (keyword) {
            saveNewKeyword(industryId, serviceId, keyword, matchType);
        }
    });

    // Cancel add keyword
    $(document).off('click', '.cancel-new-keyword-btn').on('click', '.cancel-new-keyword-btn', function(e) {
        e.stopPropagation();
        $(this).closest('.add-keyword-form').remove();
    });

    // Enter key in new keyword input
    $(document).off('keypress', '.new-keyword-input').on('keypress', '.new-keyword-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).closest('.add-keyword-form').find('.save-new-keyword-btn').click();
        }
    });
}

// Shuffle headlines - generate from selected USPs' example_headlines
// Respects locked headlines - they stay in place while only unlocked ones are replaced
function shuffleHeadlines(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    const maxHeadlines = 15;

    // 1. Preserve locked headlines and note their positions
    const lockedHeadlines = [];
    const lockedIndices = new Set();

    if (adGroup.headlines && adGroup.headlines.length > 0) {
        adGroup.headlines.forEach((headline, index) => {
            if (typeof headline === 'object' && headline.locked) {
                lockedHeadlines.push({ index, headline });
                lockedIndices.add(index);
            }
        });
    }

    // Create a Set of locked headline texts for duplicate filtering
    const lockedTexts = new Set(
        lockedHeadlines.map(({ headline }) =>
            typeof headline === 'object' ? headline.text : headline
        )
    );

    // 2. Generate new headlines from USPs
    let availableHeadlines = [];

    campaignConfig.usp_ids.forEach(uspId => {
        const $checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
        if (!$checkbox.length) return;

        // Get example_headlines from data attribute (now outputs proper JSON via |tojson filter)
        let exampleHeadlines = [];
        try {
            let headlinesData = $checkbox.attr('data-example-headlines');
            if (headlinesData && headlinesData !== 'null' && headlinesData !== '[]' && headlinesData !== 'None') {
                exampleHeadlines = JSON.parse(headlinesData);
            }
        } catch (e) {
            console.warn('Could not parse example_headlines for USP', uspId, e);
        }

        if (Array.isArray(exampleHeadlines) && exampleHeadlines.length > 0) {
            // Pick 1 random headline from this USP's example_headlines
            const randomIndex = Math.floor(Math.random() * exampleHeadlines.length);
            let headline = exampleHeadlines[randomIndex];

            // Substitute variables like {SERVICE}, {BRANCHE}, and {VAR1:default} etc.
            headline = substituteHeadlineVariables(headline, industryId, serviceId, uspId);

            // Only add if within 30 character limit
            if (headline.length <= 30) {
                availableHeadlines.push({ text: headline, locked: false });
            }
        } else {
            // Fallback: Use USP text if no example_headlines
            const originalText = $checkbox.data('original-text');
            const finalText = getUspFinalText(uspId, originalText);
            if (finalText.length <= 30) {
                availableHeadlines.push({ text: finalText, locked: false });
            }
        }
    });

    // 3. Custom USPs are used 1:1 directly as headlines
    campaignConfig.custom_usps.forEach(usp => {
        if (usp.length <= 30) {
            availableHeadlines.push({ text: usp, locked: false });
        }
    });

    // Filter out headlines that match locked headline texts (avoid duplicates)
    availableHeadlines = availableHeadlines.filter(h => !lockedTexts.has(h.text));

    // 4. Add standard headlines with Google Ads dynamic insertion
    // These are ALWAYS included and placed first (not shuffled away)
    // {SERVICE} is substituted with the service name
    // {LOCATION(City)} is Google Ads native syntax - stays as is for dynamic city insertion
    // {KeyWord:{SERVICE}} becomes e.g. {KeyWord:VVS} for keyword insertion
    const standardHeadlineTemplates = [
        '{SERVICE} {LOCATION(City)}',
        '{KeyWord:{SERVICE}}'
    ];

    // Get service name from the adGroup (stored when ad group was created)
    const serviceName = adGroup.service_name || '';

    // Generate standard headlines (separate from regular pool)
    const standardHeadlines = [];
    console.log('Standard headlines - serviceName:', serviceName);
    if (serviceName) {
        standardHeadlineTemplates.forEach(template => {
            // Only substitute {SERVICE} - leave {LOCATION(City)} and {KeyWord:...} as Google Ads syntax
            const substituted = template.replace(/\{SERVICE\}/gi, serviceName);
            console.log('Standard headline template:', template, '-> substituted:', substituted, 'length:', substituted.length);
            if (substituted.length <= 30 && !lockedTexts.has(substituted)) {
                standardHeadlines.push({ text: substituted, locked: false, source: 'standard' });
            }
        });
    }
    console.log('Standard headlines generated:', standardHeadlines.length, standardHeadlines);

    if (availableHeadlines.length === 0 && lockedHeadlines.length === 0 && standardHeadlines.length === 0) {
        alert('Ingen headlines fundet. Tjek at dine USPs har tilknyttede example_headlines eller tilf√∏j manuelt.');
        return;
    }

    // 5. Shuffle only the USP headlines (Fisher-Yates algorithm)
    for (let i = availableHeadlines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableHeadlines[i], availableHeadlines[j]] = [availableHeadlines[j], availableHeadlines[i]];
    }

    // 6. Calculate how many new headlines we need
    const slotsNeeded = maxHeadlines - lockedHeadlines.length;
    const finalHeadlines = new Array(maxHeadlines).fill(null);

    // 7. Place locked headlines at their original positions
    lockedHeadlines.forEach(({ index, headline }) => {
        if (index < maxHeadlines) {
            finalHeadlines[index] = headline;
        }
    });

    // 8. Fill empty slots - FIRST with standard headlines (always included), then with USP headlines
    let slotIndex = 0;

    // First: Add standard headlines to the first available slots
    for (let stdIdx = 0; stdIdx < standardHeadlines.length && slotIndex < maxHeadlines; ) {
        if (finalHeadlines[slotIndex] === null) {
            finalHeadlines[slotIndex] = standardHeadlines[stdIdx];
            stdIdx++;
        }
        slotIndex++;
    }

    // Then: Fill remaining slots with USP headlines
    let uspIndex = 0;
    for (let i = 0; i < maxHeadlines && uspIndex < availableHeadlines.length; i++) {
        if (finalHeadlines[i] === null) {
            finalHeadlines[i] = availableHeadlines[uspIndex++];
        }
    }

    // 9. Remove null values and update
    adGroup.headlines = finalHeadlines.filter(h => h !== null);

    // 9. Update count in main view (the panel will be re-rendered after shuffle button click in openAdGroupEditPanel)
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);

    console.log('Shuffled headlines (locked:', lockedHeadlines.length, ', new:', adGroup.headlines.length - lockedHeadlines.length, '):', adGroup.headlines);
}

// Helper function: Get final text for a USP (with custom edits applied)
function getUspFinalText(uspId, originalText) {
    // Check if there's a custom text for this USP
    if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
        return campaignConfig.usp_custom_texts[uspId];
    }

    // Otherwise, apply variable substitution to original text
    return substituteUspVariables(originalText, uspId);
}

// Helper function: Extract variable values by comparing original template with edited text
function extractVariableValuesFromEditedText(originalTemplate, editedText) {
    const varValues = {};
    if (!originalTemplate || !editedText) return varValues;

    // Find all VAR patterns in original template with their positions
    const varPattern = /\{VAR(\d+)(?::([^}]*))?\}/gi;
    let match;
    const varPositions = [];

    while ((match = varPattern.exec(originalTemplate)) !== null) {
        varPositions.push({
            varIndex: match[1],
            defaultValue: match[2] || '',
            start: match.index,
            end: match.index + match[0].length,
            fullMatch: match[0]
        });
    }

    if (varPositions.length === 0) return varValues;

    // Build regex pattern to extract values from edited text
    // Strategy: First replace VAR patterns with placeholders, then escape everything, then put capture groups
    let regexPattern = originalTemplate;

    // Replace VAR patterns with unique placeholder that won't be escaped
    const placeholder = '\x00VARCAPTURE\x00';
    regexPattern = regexPattern.replace(/\{VAR(\d+)(?::[^}]*)?\}/gi, placeholder);

    // Now escape all special regex characters
    regexPattern = regexPattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // Replace placeholders with capture groups
    regexPattern = regexPattern.replace(new RegExp(placeholder.replace(/\x00/g, '\\x00'), 'g'), '(.+?)');

    try {
        const extractRegex = new RegExp('^' + regexPattern + '$', 'i');
        const extractMatch = editedText.match(extractRegex);

        console.log('extractVariableValuesFromEditedText:', {
            original: originalTemplate,
            edited: editedText,
            regexPattern: regexPattern,
            match: extractMatch
        });

        if (extractMatch) {
            // Map extracted values to variable indices
            varPositions.forEach((varPos, index) => {
                if (extractMatch[index + 1]) {
                    varValues[varPos.varIndex] = extractMatch[index + 1];
                }
            });
        }
    } catch (e) {
        console.warn('Could not extract variable values:', e);
    }

    return varValues;
}

// Helper function: Substitute USP-specific variables (VAR1, VAR2, VAR3) in text
function substituteUspVariables(text, uspId) {
    if (!text) return '';

    let result = text;
    let varValues = {};

    // First, try to extract values from the edited USP text
    // Use the usp-item container which has data-usp-id attribute
    const $uspItem = $(`.usp-item[data-usp-id="${uspId}"]`);
    if ($uspItem.length) {
        const $checkbox = $uspItem.find('.usp-checkbox');
        const originalText = $checkbox.data('original-text');
        const $editInput = $uspItem.find('.usp-edit-input');

        console.log('substituteUspVariables for USP', uspId, {
            uspItemFound: $uspItem.length > 0,
            originalText: originalText,
            editInputFound: $editInput.length > 0,
            editedText: $editInput.length ? $editInput.val() : null
        });

        if ($editInput.length && originalText) {
            const editedText = $editInput.val();
            // Only extract if the text was actually edited (not identical to original)
            if (editedText && editedText !== originalText) {
                varValues = extractVariableValuesFromEditedText(originalText, editedText);
                console.log('Extracted VAR values:', varValues);
            }
        }
    }

    // Fall back to stored values if extraction didn't work
    if (Object.keys(varValues).length === 0) {
        varValues = campaignConfig.usp_variable_values && campaignConfig.usp_variable_values[uspId]
            ? campaignConfig.usp_variable_values[uspId]
            : {};
    }

    console.log('substituteUspVariables - varValues for USP', uspId, ':', JSON.stringify(varValues));

    // Replace {VAR1:default}, {VAR2:default}, {VAR3:default} patterns
    // Pattern: {VAR followed by digit, optionally :default value, then }
    // Track which VAR we're at (0-based index) for matching with stored values
    let varCounter = 0;
    result = result.replace(/\{VAR(\d+)(?::([^}]*))?\}/gi, (match, varNumber, defaultValue) => {
        // The varNumber is the number from VAR1, VAR2 etc (1-based)
        // But usp_variable_values uses 0-based index from renderUspWithVariables
        const varIndex = varCounter;
        varCounter++;

        console.log(`  Replacing ${match}: varNumber=${varNumber}, varIndex=${varIndex}, stored value for index=${varValues[varIndex]}, stored value for number=${varValues[varNumber]}`);

        // Check if we have a stored value - try both 0-based index and VAR number
        if (varValues[varIndex] !== undefined) {
            console.log(`    Using stored value (index ${varIndex}): ${varValues[varIndex]}`);
            return varValues[varIndex];
        }
        if (varValues[varNumber] !== undefined) {
            console.log(`    Using stored value (number ${varNumber}): ${varValues[varNumber]}`);
            return varValues[varNumber];
        }
        // Otherwise use the default value from the pattern (e.g., "1-3" from {VAR1:1-3})
        console.log(`    Using default: ${defaultValue}`);
        return defaultValue || '';
    });

    return result;
}

// Helper function: Substitute variables in headline text
function substituteHeadlineVariables(headline, industryId, serviceId, uspId) {
    // Get industry and service names from serverData
    const industry = serverData.industries ? serverData.industries.find(i => i.id == industryId) : null;
    const service = industry && industry.services ? industry.services.find(s => s.id == serviceId) : null;

    let result = headline;

    // Apply USP-specific variable substitution (VAR1, VAR2, VAR3)
    if (uspId) {
        result = substituteUspVariables(result, uspId);
    }

    // Apply general placeholders
    if (service && service.name) {
        result = result.replace(/\{SERVICE\}/gi, service.name);
    }
    if (industry && industry.name) {
        result = result.replace(/\{BRANCHE\}/gi, industry.name);
    }

    return result;
}

// Add a new headline
function addHeadline(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.headlines.length >= 15) {
        alert('Maksimalt 15 headlines per annoncegruppe.');
        return;
    }

    adGroup.headlines.push('');

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const headlinesList = adGroupElement.find('.headlines-list');
    headlinesList.html(renderHeadlinesList(industryId, serviceId, adGroup.headlines));
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);

    // Focus the new input
    headlinesList.find('.headline-input').last().focus();
}

// Remove a headline
function removeHeadline(industryId, serviceId, index) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    adGroup.headlines.splice(index, 1);

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const headlinesList = adGroupElement.find('.headlines-list');
    headlinesList.html(renderHeadlinesList(industryId, serviceId, adGroup.headlines));
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);
}

// Add a new description
function addDescription(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.descriptions.length >= 4) {
        alert('Maksimalt 4 beskrivelser per annoncegruppe.');
        return;
    }

    adGroup.descriptions.push('');

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const descList = adGroupElement.find('.descriptions-list');
    descList.html(renderDescriptionsList(industryId, serviceId, adGroup.descriptions));
    adGroupElement.find('.descriptions-count').text(adGroup.descriptions.length);

    // Focus the new input
    descList.find('.description-input').last().focus();
}

// Remove a description
function removeDescription(industryId, serviceId, index) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    adGroup.descriptions.splice(index, 1);

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const descList = adGroupElement.find('.descriptions-list');
    descList.html(renderDescriptionsList(industryId, serviceId, adGroup.descriptions));
    adGroupElement.find('.descriptions-count').text(adGroup.descriptions.length);
}

// Show inline form to add new keyword
function showAddKeywordForm(industryId, serviceId) {
    const adGroupItem = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const keywordsSection = adGroupItem.find('.keywords-list');

    // Remove any existing form
    keywordsSection.find('.add-keyword-form').remove();

    // Insert form at top
    const formHtml = `
        <div class="add-keyword-form p-2 bg-blue-50 rounded mb-2 border border-blue-200">
            <div class="flex items-center space-x-2">
                <input type="text" class="new-keyword-input flex-1 px-2 py-1 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Indtast s√∏geord...">
                <select class="new-keyword-match-type text-sm border rounded px-2 py-1">
                    <option value="broad">Broad</option>
                    <option value="phrase">Phrase</option>
                    <option value="exact">Exact</option>
                </select>
                <button class="save-new-keyword-btn text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">Gem</button>
                <button class="cancel-new-keyword-btn text-xs px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">Annuller</button>
            </div>
        </div>
    `;
    keywordsSection.prepend(formHtml);
    keywordsSection.find('.new-keyword-input').focus();
}

// Save a new custom keyword to the ad group
function saveNewKeyword(industryId, serviceId, keyword, matchType) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Initialize custom_keywords if not exists
    if (!adGroup.custom_keywords) {
        adGroup.custom_keywords = [];
    }

    // Add the new keyword
    adGroup.custom_keywords.push({
        keyword: keyword,
        match_type: matchType,
        is_primary: false,
        is_custom: true
    });

    // Re-render keywords list
    refreshKeywordsList(industryId, serviceId);

    console.log('Added custom keyword:', keyword, 'to', industryId, serviceId);
}

// Refresh the keywords list in the UI
function refreshKeywordsList(industryId, serviceId) {
    const adGroupItem = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const keywordsSection = adGroupItem.find('.keywords-list');
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Combine server keywords with custom keywords
    const serverKeywords = serverData.google_keywords && serverData.google_keywords[serviceId]
        ? serverData.google_keywords[serviceId]
        : [];

    const customKeywords = adGroup.custom_keywords || [];

    // Build combined list - custom keywords first, then server keywords
    const allKeywords = [...customKeywords, ...serverKeywords];

    // Render the list
    keywordsSection.html(renderKeywordsList(allKeywords, serviceId));

    // Update count
    adGroupItem.find('.keywords-count').text(allKeywords.length);
}

// Remove a custom keyword
function removeCustomKeyword(industryId, serviceId, keywordIndex) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.custom_keywords && adGroup.custom_keywords[keywordIndex]) {
        adGroup.custom_keywords.splice(keywordIndex, 1);
        refreshKeywordsList(industryId, serviceId);
    }
}

// Save campaigns from UI to campaignConfig
function saveCampaignsFromUI() {
    $('.campaign-accordion').each(function() {
        const industryId = $(this).data('industry-id');
        const campaign = campaignConfig.campaigns[industryId];

        // Save budget settings
        campaign.daily_budget = parseInt($(this).find('.campaign-daily-budget').val()) || 500;
        campaign.bidding_strategy = $(this).find('.campaign-bidding-strategy').val();
        campaign.target_cpa = parseInt($(this).find('.campaign-target-cpa').val()) || null;

        // Save headlines and descriptions from inputs
        $(this).find('.ad-group-item').each(function() {
            const serviceId = $(this).data('service-id');
            const adGroup = campaign.ad_groups[serviceId];

            adGroup.headlines = [];
            $(this).find('.headline-input').each(function() {
                const val = $(this).val().trim();
                if (val) adGroup.headlines.push(val);
            });

            adGroup.descriptions = [];
            $(this).find('.description-input').each(function() {
                const val = $(this).val().trim();
                if (val) adGroup.descriptions.push(val);
            });
        });
    });

    console.log('Saved campaigns:', campaignConfig.campaigns);
}

// =====================================================
// Geo Service Selection Functions (Step 4)
// =====================================================

// Populate geo services container based on selected services
function populateGeoServicesContainer() {
    const container = $('#geo-services-container');

    if (campaignConfig.service_ids.length === 0) {
        container.html('<p class="text-gray-500 col-span-full text-center py-4">V√¶lg services i Step 1 for at se geo-kampagne muligheder</p>');
        return;
    }

    // Get service names from the selected service cards (they were loaded in step 1)
    let servicesHtml = '';
    campaignConfig.service_ids.forEach(serviceId => {
        const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
        const serviceName = serviceCard.find('h4').text() || `Service ${serviceId}`;
        const isChecked = campaignConfig.geo_config.enabled_services.includes(serviceId) ? 'checked' : '';

        servicesHtml += `
            <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors">
                <input type="checkbox" class="geo-service-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500 mr-3"
                       data-service-id="${serviceId}" ${isChecked}>
                <span class="font-medium text-gray-900">${escapeHtml(serviceName)}</span>
            </label>
        `;
    });

    container.html(servicesHtml);
}

// Generate negative city list button click handler
$(document).on('click', '#generate-negative-cities-btn', function() {
    var selectedCities = campaignConfig.geo_map_targeting?.postal_names || [];

    if (selectedCities.length === 0) {
        alert('V√¶lg f√∏rst nogle byer/regioner f√∏r du kan generere en negativ by-liste.');
        return;
    }

    var btn = $(this);
    var originalHtml = btn.html();
    btn.prop('disabled', true).html('<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span> Opdaterer...');

    // Simpelt request - backend h√•ndterer singleton listen
    $.ajax({
        url: '/ajax/generate-negative-city-list/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            selected_cities: selectedCities
        }),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                // Show success result
                $('#negative-city-list-name').text(response.list_name);
                $('#negative-city-list-count').text(response.keywords_count);
                $('#negative-city-list-result').slideDown(200);

                // Update button to show success
                var successText = response.updated ? '‚úì Liste Opdateret' : '‚úì Liste Oprettet';
                btn.html(successText).addClass('bg-green-600').removeClass('from-red-600 to-orange-600');

                // Opdater serverData direkte med det nye antal (for √∏jeblikkelig Step 5 opdatering)
                var list = (serverData.negative_keyword_lists || []).find(function(l) {
                    return l.name === 'Ekskluderede Byer';
                });
                if (list) {
                    list.keyword_count = response.keywords_count;
                } else {
                    // Listen blev nyoprettet - tilf√∏j den til serverData
                    serverData.negative_keyword_lists = serverData.negative_keyword_lists || [];
                    serverData.negative_keyword_lists.push({
                        id: response.list_id,
                        name: response.list_name,
                        description: '',
                        keyword_count: response.keywords_count
                    });
                }

                // Opdater Step 5 chips med det samme
                updateStep5NegativeKeywordChips();

                setTimeout(function() {
                    btn.html('üîÑ Opdater Negativ By-Liste').removeClass('bg-green-600').addClass('from-red-600 to-orange-600');
                    btn.prop('disabled', false);
                }, 2000);
            } else {
                alert('Fejl: ' + (response.error || 'Ukendt fejl'));
                btn.html(originalHtml).prop('disabled', false);
            }
        },
        error: function(xhr, status, error) {
            alert('Der opstod en fejl: ' + error);
            btn.html(originalHtml).prop('disabled', false);
        }
    });
});

// Refresh serverData.negative_keyword_lists efter opdatering
// S√• Step 5 (Kampagne & Annoncebygger) viser opdaterede data
function refreshNegativeKeywordLists() {
    $.ajax({
        url: '/ajax/get-negative-keyword-lists/',
        method: 'GET',
        success: function(response) {
            serverData.negative_keyword_lists = response.lists || [];

            // Opdater Step 5 chips uanset synlighed (s√• data er klar n√•r bruger navigerer)
            updateStep5NegativeKeywordChips();
        }
    });
}

// Opdater negative keyword chips i Step 5
function updateStep5NegativeKeywordChips() {
    // Opdater industri-kampagne chips
    // FIX: Brug .neg-keyword-chips-container og data-industry-id (matcher HTML struktur)
    Object.keys(campaignConfig.campaigns || {}).forEach(function(industryId) {
        var campaign = campaignConfig.campaigns[industryId];
        var container = $(`.neg-keyword-chips-container[data-industry-id="${industryId}"][data-campaign-type="industry"]`);
        if (container.length) {
            container.html(renderNegativeKeywordChips(campaign.negative_keyword_list_ids || [], industryId, 'industry'));
        }
    });

    // Opdater geo-kampagne chips
    // FIX: Brug .neg-keyword-chips-container og data-service-id (matcher HTML struktur)
    Object.keys(campaignConfig.geo_campaigns || {}).forEach(function(serviceId) {
        var geoCampaign = campaignConfig.geo_campaigns[serviceId];
        var container = $(`.neg-keyword-chips-container[data-service-id="${serviceId}"][data-campaign-type="geo"]`);
        if (container.length) {
            container.html(renderNegativeKeywordChips(geoCampaign.negative_keyword_list_ids || [], serviceId, 'geo'));
        }

        // Legacy accordions (hvis de stadig bruges)
        var legacyContainer = $(`.geo-negative-keywords-container[data-service-id="${serviceId}"]`);
        if (legacyContainer.length) {
            legacyContainer.html(renderNegativeKeywordListsForGeo(geoCampaign.negative_keyword_list_ids || [], serviceId));
        }
    });
}

// Update negative city count when geo selection changes
var autoUpdateNegativeCityListTimer = null;
var updateNegativeCityCountTimer = null;

function updateNegativeCityCount() {
    var selectedCities = campaignConfig.geo_map_targeting?.postal_names || [];
    var btn = $('#generate-negative-cities-btn');

    if (selectedCities.length > 0) {
        btn.prop('disabled', false);

        // Debounce AJAX kald for at undg√• for mange requests
        if (updateNegativeCityCountTimer) {
            clearTimeout(updateNegativeCityCountTimer);
        }

        updateNegativeCityCountTimer = setTimeout(function() {
            // Hent faktisk antal fra backend via AJAX
            $.ajax({
                url: '/ajax/get-negative-city-count/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    selected_cities: selectedCities
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    $('#negative-city-count').text(response.count);
                },
                error: function() {
                    // Fallback til estimat hvis AJAX fejler
                    var estimatedExcluded = Math.max(0, 1089 - selectedCities.length);
                    $('#negative-city-count').text(estimatedExcluded);
                }
            });
        }, 300); // 300ms debounce

        // Auto-opdater negativ by-liste i baggrunden (med debounce)
        // Clear previous timer
        if (autoUpdateNegativeCityListTimer) {
            clearTimeout(autoUpdateNegativeCityListTimer);
        }

        // Debounce: vent 1.5 sekunder f√∏r automatisk opdatering
        autoUpdateNegativeCityListTimer = setTimeout(function() {
            autoUpdateNegativeCityList();
        }, 1500);
    } else {
        $('#negative-city-count').text('0');
        btn.prop('disabled', true);
    }
}

// Auto-update the negative city list when geo selection changes
// Runs automatically in background when cities are selected - no manual button click needed
function autoUpdateNegativeCityList() {
    var selectedCities = campaignConfig.geo_map_targeting?.postal_names || [];

    // Kun k√∏r hvis der er valgte byer
    if (selectedCities.length === 0) {
        return;
    }

    console.log('[AutoNegative] Opdaterer negativ by-liste automatisk med', selectedCities.length, 'valgte byer');

    // Simpelt request - backend h√•ndterer singleton listen
    $.ajax({
        url: '/ajax/generate-negative-city-list/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            selected_cities: selectedCities
        }),
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                console.log('[AutoNegative] Liste opdateret:', response.keywords_count, 'ekskluderede byer');

                // Opdater serverData direkte med det nye antal (for √∏jeblikkelig Step 5 opdatering)
                var list = (serverData.negative_keyword_lists || []).find(function(l) {
                    return l.name === 'Ekskluderede Byer';
                });
                if (list) {
                    list.keyword_count = response.keywords_count;
                } else {
                    // Listen blev nyoprettet - tilf√∏j den til serverData
                    serverData.negative_keyword_lists = serverData.negative_keyword_lists || [];
                    serverData.negative_keyword_lists.push({
                        id: response.list_id,
                        name: response.list_name,
                        description: '',
                        keyword_count: response.keywords_count
                    });
                }

                // Opdater Step 5 chips med det samme
                updateStep5NegativeKeywordChips();
            }
        },
        error: function(xhr, status, error) {
            console.error('[AutoNegative] Fejl ved opdatering:', error);
        }
    });
}

// Generate byside URLs for EACH selected service - creates separate URL sets per service
// Runs automatically when leaving step 4 - no UI elements needed
// Respects "Anvend til: Byside" checkbox from step 2
function generateBysideUrls() {
    // Initialize data structures for multiple services
    campaignConfig.geo_config.byside_urls = [];  // Keep for backward compatibility
    campaignConfig.geo_config.byside_urls_by_service = {};

    // Get cities from geo map targeting (postal_names)
    const allCities = campaignConfig.geo_map_targeting && campaignConfig.geo_map_targeting.postal_names
        ? campaignConfig.geo_map_targeting.postal_names
        : [];

    if (allCities.length === 0) {
        return;  // No cities selected, nothing to generate
    }

    // Get services that have "Byside/Programmatic" enabled in step 2
    const programmaticServiceIds = getServicesForPurpose('programmatic');

    // Get selected services from geo checkboxes, but filter by programmatic purpose
    const selectedServices = [];
    $('.geo-service-checkbox:checked').each(function() {
        const serviceId = parseInt($(this).data('service-id'));
        // Only include if "Byside" is checked for this service in step 2
        if (programmaticServiceIds.includes(serviceId)) {
            const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
            const serviceName = serviceCard.find('h4').text().trim() || 'service';
            selectedServices.push({ id: serviceId, name: serviceName });
        }
    });

    // Fallback to industry if no services selected (but only if programmatic is generally enabled)
    if (selectedServices.length === 0 && programmaticServiceIds.length === 0) {
        const industryCard = $('.industry-card.selected').first();
        const industryName = industryCard.find('h4').text().trim() || 'branche';
        selectedServices.push({ id: 'industry', name: industryName });
    }

    // Generate URLs for EACH selected service
    selectedServices.forEach(service => {
        const serviceSlug = danishSlug(service.name);
        const serviceUrls = [];

        allCities.forEach(cityName => {
            const bySlug = danishSlug(cityName);
            const url = `/${serviceSlug}-${bySlug}/`;

            const urlEntry = {
                city: cityName,
                url: url,
                keyword: `${service.name} ${cityName}`,
                serviceName: service.name,
                serviceId: service.id,
                exists: false,
                edited: false
            };

            serviceUrls.push(urlEntry);
            campaignConfig.geo_config.byside_urls.push(urlEntry);  // Also add to flat array for compatibility
        });

        campaignConfig.geo_config.byside_urls_by_service[service.id] = serviceUrls;
    });
    // Data is now ready for use in Programmatic step
}

// Download URLs for WordPress import
$(document).on('click', '#download-urls-btn', function() {
    const urls = campaignConfig.geo_config.byside_urls;
    if (urls.length === 0) {
        alert('Ingen URLs at downloade. Klik "Generer" f√∏rst.');
        return;
    }

    // Create CSV content (semikolon som separator for dansk Excel)
    let csv = 'by;url\n';
    urls.forEach(u => {
        csv += `"${u.city}";"${u.url}"\n`;
    });

    // Download med UTF-8 BOM for korrekt dansk tegn-encoding
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'byside_urls.csv';
    link.click();
});

// =====================================================
// Update navigation to trigger step initialization
// =====================================================

// Override updateWizardState to handle step-specific initialization
const originalUpdateWizardState = updateWizardState;
updateWizardState = function() {
    originalUpdateWizardState();

    // Step-specific initializations (Auto-Crawl fjernet - k√∏rer nu i baggrunden)
    if (currentStep === 5) {
        // Geo targeting step (var 6) - populate services
        populateGeoServicesContainer();

        // Preload DAWA data in background to eliminate delay when selecting regions
        loadDAWAGeoJSON().then(function() {
            console.log('DAWA data preloaded for step 5');
        });
    } else if (currentStep === 6) {
        // Campaign builder step (var 7)
        initializeCampaignsBuilder();
    } else if (currentStep === 7) {
        // SEO Information step - render sidebar with services
        renderSeoBuilder();
    } else if (currentStep === 8) {
        // Programmatic Byside step (var 9) - init from crawlState
        initStep9FromCrawlState();
    }
};

// Step 4: Auto-Crawl - Called when step 4 is shown
function onStep4Shown() {
    // Show URL being analyzed
    $('#crawl-url-display').text(crawlState.website_url || 'Ingen URL');

    // Check if we have a URL
    if (!crawlState.website_url) {
        // No URL - show the no-url message
        $('#autocrawl-loading').addClass('hidden');
        $('#autocrawl-results').addClass('hidden');
        $('#autocrawl-error').addClass('hidden');
        $('#autocrawl-no-url').removeClass('hidden');
        return;
    }

    // Check if already crawled
    if (crawlState.crawl_status === 'success' && crawlState.urls_found > 0) {
        // Show cached results
        showAutoCrawlResults();
        return;
    }

    // Start auto-crawl
    if (crawlState.crawl_status === 'idle' || crawlState.crawl_status === 'error') {
        startAutoCrawl();
    }
}

// Start the automatic crawl process
async function startAutoCrawl() {
    console.log('Starting auto-crawl for:', crawlState.website_url);

    // Update state
    crawlState.crawl_status = 'crawling';

    // Show loading state
    $('#autocrawl-loading').removeClass('hidden');
    $('#autocrawl-results').addClass('hidden');
    $('#autocrawl-error').addClass('hidden');
    $('#autocrawl-no-url').addClass('hidden');
    $('#crawl-url-display').text(crawlState.website_url);

    try {
        // Call sitemap crawl endpoint
        const response = await $.ajax({
            url: '/ajax/crawl-sitemap/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({ website_url: crawlState.website_url })
        });

        if (response.success) {
            // Update crawl state
            crawlState.sitemap_urls = response.urls || [];
            crawlState.urls_found = response.urls_found || 0;
            crawlState.crawl_status = 'success';
            crawlState.crawl_timestamp = Date.now();
            crawlState.crawl_error = null;

            // Try to match city pages if we have geo targeting data
            await matchCityPagesAutoCrawl();

            // Save state
            debouncedSaveState();

            // Show results
            showAutoCrawlResults();

        } else {
            throw new Error(response.error || 'Kunne ikke crawle sitemap');
        }

    } catch (error) {
        console.error('Auto-crawl error:', error);
        crawlState.crawl_status = 'error';
        crawlState.crawl_error = error.message || 'Ukendt fejl';

        // Show error state
        $('#autocrawl-loading').addClass('hidden');
        $('#autocrawl-results').addClass('hidden');
        $('#autocrawl-no-url').addClass('hidden');
        $('#autocrawl-error').removeClass('hidden');
        $('#autocrawl-error-message').text(crawlState.crawl_error);

        debouncedSaveState();
    }
}

// ==========================================
// SMART USP PRE-FILL FROM WEBSITE SCRAPING
// ==========================================

// Start background USP analysis (scrape website + AI matching)
async function startBackgroundUspAnalysis() {
    if (!crawlState.website_url || campaignConfig.usp_analysis.status === 'analyzing') {
        console.log('[USP Analysis] Skipped - no URL or already analyzing');
        return;
    }

    console.log('[USP Analysis] Starting for:', crawlState.website_url);
    campaignConfig.usp_analysis.status = 'analyzing';
    debouncedSaveState();

    // Show Roberto loading animation
    showRobertoLoading('usp_analysis');

    try {
        const response = await $.ajax({
            url: '/ajax/analyze-website-usps/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                website_url: crawlState.website_url,
                industry_ids: campaignConfig.industry_ids,
                scrape_mode: crawlState.scrape_mode !== undefined ? crawlState.scrape_mode : 10
            })
        });

        if (response.success) {
            campaignConfig.usp_analysis = {
                status: 'success',
                timestamp: Date.now(),
                matched_usps: response.analysis.matched_usps || [],
                custom_usps: response.analysis.custom_usps || [],
                extracted_facts: response.analysis.extracted_facts || {},
                applied: false,
                pages_scraped: response.pages_scraped || 1,
                total_urls_found: response.total_urls_found || 1,
                content_length: response.scraped_content_length || 0
            };

            console.log('[USP Analysis] Complete:',
                campaignConfig.usp_analysis.matched_usps.length, 'matched,',
                campaignConfig.usp_analysis.custom_usps.length, 'custom,',
                campaignConfig.usp_analysis.pages_scraped, 'pages scraped');

            debouncedSaveState();
            hideRobertoLoading();

            // If user is already on Step 3, apply suggestions immediately
            if (currentStep === 3 && !campaignConfig.usp_analysis.applied) {
                applyUspSuggestions();
            }
        } else {
            throw new Error(response.error || 'Unknown error');
        }
    } catch (error) {
        console.error('[USP Analysis] Error:', error);
        campaignConfig.usp_analysis.status = 'error';
        debouncedSaveState();
        hideRobertoLoading();
    }
}

// Apply USP suggestions to UI (auto-check USPs and add custom USPs)
function applyUspSuggestions() {
    if (campaignConfig.usp_analysis.applied || campaignConfig.usp_analysis.status !== 'success') {
        return;
    }

    const analysis = campaignConfig.usp_analysis;
    let matchedCount = 0;
    let customCount = 0;

    // 1. Auto-select matched USPs
    analysis.matched_usps.forEach(match => {
        const uspId = match.usp_template_id;
        const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);

        if (checkbox.length && !checkbox.is(':checked')) {
            // Check the checkbox
            checkbox.prop('checked', true);

            // Add to campaignConfig
            if (!campaignConfig.usp_ids.includes(uspId)) {
                campaignConfig.usp_ids.push(uspId);
            }

            // Store variable values if provided
            if (match.variable_values && Object.keys(match.variable_values).length > 0) {
                campaignConfig.usp_variable_values[uspId] = match.variable_values;
            }

            // Trigger change handler to render with variables
            checkbox.trigger('change');

            // Add AI-suggested visual indicator
            checkbox.closest('.usp-item').addClass('ai-suggested');
            matchedCount++;
        }
    });

    // 2. Add custom USPs
    analysis.custom_usps.forEach(custom => {
        if (custom.text && !campaignConfig.custom_usps.includes(custom.text)) {
            campaignConfig.custom_usps.push(custom.text);
            customCount++;
        }
    });

    // 3. Re-render custom USPs if any were added
    if (customCount > 0) {
        renderCustomUsps();
        // Mark AI-suggested custom USPs
        setTimeout(() => {
            $('#custom-usps-container .custom-usp-item').each(function() {
                const text = $(this).find('.custom-usp-display-text').text();
                if (analysis.custom_usps.some(c => c.text === text)) {
                    $(this).addClass('ai-suggested');
                }
            });
        }, 100);
    }

    // Mark as applied
    campaignConfig.usp_analysis.applied = true;
    debouncedSaveState();

    // Show notification
    if (matchedCount > 0 || customCount > 0) {
        showUspSuggestionsNotification(matchedCount, customCount);
    }

    // Update status indicator
    updateUspAnalysisStatusUI();
}

// Show notification when USP suggestions are applied
function showUspSuggestionsNotification(matchedCount, customCount) {
    const total = matchedCount + customCount;
    if (total === 0) return;

    let message = `‚ú® AI har valgt ${matchedCount} USP'er`;
    if (customCount > 0) {
        message += ` og tilf√∏jet ${customCount} unikke fakta`;
    }
    message += ' fra din hjemmeside';

    // Create toast notification
    const toast = $(`
        <div class="fixed bottom-4 right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-4 rounded-xl shadow-lg z-50" style="animation: slideIn 0.3s ease-out">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">‚ú®</span>
                <span>${message}</span>
            </div>
        </div>
    `);

    $('body').append(toast);
    setTimeout(() => toast.fadeOut(300, () => toast.remove()), 5000);
}

// Update USP analysis status indicator in Step 3 header
function updateUspAnalysisStatusUI() {
    const statusDiv = $('#usp-analysis-status');
    if (!statusDiv.length) return;

    const icon = statusDiv.find('.usp-analysis-icon');
    const text = statusDiv.find('.usp-analysis-text');

    switch (campaignConfig.usp_analysis.status) {
        case 'analyzing':
            statusDiv.removeClass('hidden');
            icon.html('<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>');
            text.text('AI analyserer hjemmeside for USP\'er...');
            break;

        case 'success':
            const matched = campaignConfig.usp_analysis.matched_usps.length;
            const custom = campaignConfig.usp_analysis.custom_usps.length;
            if (matched > 0 || custom > 0) {
                statusDiv.removeClass('hidden');
                icon.text('‚ú®');
                text.html(`AI foreslog <strong>${matched}</strong> USP'er og <strong>${custom}</strong> unikke fakta fra hjemmesiden`);
            } else {
                statusDiv.addClass('hidden');
            }
            break;

        case 'error':
            statusDiv.removeClass('hidden').removeClass('bg-purple-50 border-purple-200').addClass('bg-yellow-50 border-yellow-200');
            icon.text('‚ö†Ô∏è');
            text.text('Kunne ikke analysere hjemmesiden. V√¶lg USP\'er manuelt.');
            break;

        default:
            statusDiv.addClass('hidden');
    }
}


// ==========================================
// SERVICE DETECTION (Auto-select industries/services from website)
// ==========================================

// Scrape website and detect services (called when leaving Step 1)
async function scrapeAndDetectServices() {
    if (!crawlState.website_url || campaignConfig.service_detection.status === 'detecting') {
        console.log('[Service Detection] Skipped - no URL or already detecting');
        return;
    }

    console.log('[Service Detection] Starting for:', crawlState.website_url);
    console.log('[Roberto] About to show Roberto loading modal...');
    campaignConfig.service_detection.status = 'detecting';
    debouncedSaveState();

    // Show Roberto loading animation
    showRobertoDetecting();
    console.log('[Roberto] showRobertoDetecting() called, display:', document.getElementById('roberto-loading-modal')?.style.display);

    try {
        const response = await $.ajax({
            url: '/ajax/scrape-detect-services/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                website_url: crawlState.website_url,
                scrape_mode: crawlState.scrape_mode !== undefined ? crawlState.scrape_mode : 10
            })
        });

        if (response.success) {
            campaignConfig.service_detection = {
                status: 'success',
                timestamp: Date.now(),
                detected_services: response.detected_services || [],
                detected_service_ids: response.detected_service_ids || [],
                suggested_services: response.suggested_services || [],
                detected_industries: response.detected_industries || [],
                detected_industry_ids: response.detected_industry_ids || [],
                primary_industry: response.primary_industry,
                suggested_industry: response.suggested_industry,  // For industries not in DB
                confidence_scores: response.confidence_scores || {},
                applied: false,
                pages_scraped: response.pages_scraped || 1,
                content_length: response.content_length || 0
            };

            // Store scraped pages with meta tags in crawlState
            if (response.scraped_pages) {
                crawlState.scraped_pages = response.scraped_pages;
                console.log('[Service Detection] Stored scraped_pages:', Object.keys(response.scraped_pages).length, 'pages');
            }

            // Store extracted reviews (from Trustpilot, Google etc. via Playwright)
            if (response.extracted_reviews && response.extracted_reviews.length > 0) {
                crawlState.extracted_reviews = response.extracted_reviews;
                console.log('[Service Detection] Extracted reviews:', response.extracted_reviews.length);
            }

            console.log('[Service Detection] Complete:',
                campaignConfig.service_detection.detected_service_ids.length, 'services detected,',
                campaignConfig.service_detection.suggested_services.length, 'suggested services,',
                campaignConfig.service_detection.detected_industry_ids.length, 'industries detected,',
                campaignConfig.service_detection.pages_scraped, 'pages scraped');

            debouncedSaveState();
            hideRobertoLoading();
        } else {
            throw new Error(response.error || 'Unknown error');
        }
    } catch (error) {
        console.error('[Service Detection] Error:', error);
        campaignConfig.service_detection.status = 'error';
        debouncedSaveState();
        hideRobertoLoading();
    }
}

/**
 * Get scraped page data for a specific path.
 * @param {string} path - The path to look up (e.g., '/vedvarende-energi/')
 * @returns {object|null} - Page data with content, meta_title, meta_description, or null if not found
 */
function getScrapedPageData(path) {
    if (!path || !crawlState.scraped_pages) {
        return null;
    }

    // Try exact match first
    if (crawlState.scraped_pages[path]) {
        return crawlState.scraped_pages[path];
    }

    // Try with/without trailing slash
    const pathWithSlash = path.endsWith('/') ? path : path + '/';
    const pathWithoutSlash = path.endsWith('/') ? path.slice(0, -1) : path;

    return crawlState.scraped_pages[pathWithSlash] ||
           crawlState.scraped_pages[pathWithoutSlash] ||
           null;
}

// Track which source paths are already assigned to services (to prevent duplicates)
let usedSourcePaths = new Set();

/**
 * Reset the used source paths tracker.
 * Should be called when services list changes.
 */
function resetUsedSourcePaths() {
    usedSourcePaths = new Set();
}

/**
 * Mark a source path as used by a service.
 * @param {string} path - The path being used
 */
function markSourcePathUsed(path) {
    if (path && path !== '/' && path !== '') {
        usedSourcePaths.add(path);
    }
}

/**
 * Check if a source path is already used.
 * @param {string} path - The path to check
 * @returns {boolean} - True if already used
 */
function isSourcePathUsed(path) {
    return usedSourcePaths.has(path);
}

/**
 * Find the best matching scraped page for a service name.
 * Used when source_path is "/" or not specific enough.
 * Excludes homepage and already-used paths.
 * @param {string} serviceName - The service name to match
 * @param {boolean} markAsUsed - Whether to mark the found path as used (default: true)
 * @returns {object|null} - Best matching page data, or null if no good match
 */
function findBestMatchingPage(serviceName, markAsUsed = true) {
    if (!serviceName || !crawlState.scraped_pages) {
        return null;
    }

    const normalizedServiceName = serviceName.toLowerCase()
        .replace(/[√¶]/g, 'ae').replace(/[√∏]/g, 'o').replace(/[√•]/g, 'aa')
        .replace(/[^a-z0-9]/g, '');

    let bestMatch = null;
    let bestScore = 0;

    for (const [path, pageData] of Object.entries(crawlState.scraped_pages)) {
        // Skip homepage - never use it as source
        if (path === '/' || path === '') continue;

        // Skip already used paths - each page can only be used by one service
        if (isSourcePathUsed(path)) continue;

        // Normalize path for comparison
        const normalizedPath = path.toLowerCase()
            .replace(/[√¶]/g, 'ae').replace(/[√∏]/g, 'o').replace(/[√•]/g, 'aa')
            .replace(/[^a-z0-9]/g, '');

        // Also check meta_title
        const normalizedTitle = (pageData.meta_title || '').toLowerCase()
            .replace(/[√¶]/g, 'ae').replace(/[√∏]/g, 'o').replace(/[√•]/g, 'aa')
            .replace(/[^a-z0-9]/g, '');

        // Calculate match score
        let score = 0;

        // Exact service name in path
        if (normalizedPath.includes(normalizedServiceName)) {
            score += 10;
        }

        // Service name in title
        if (normalizedTitle.includes(normalizedServiceName)) {
            score += 5;
        }

        // Partial word matches in path
        const serviceWords = normalizedServiceName.match(/[a-z]{3,}/g) || [];
        serviceWords.forEach(word => {
            if (normalizedPath.includes(word)) score += 2;
            if (normalizedTitle.includes(word)) score += 1;
        });

        if (score > bestScore) {
            bestScore = score;
            bestMatch = { path, pageData, score };
        }
    }

    // Only return if we have a reasonable match (score > 2)
    if (bestMatch && bestMatch.score > 2) {
        console.log(`[SEO] Auto-matched service "${serviceName}" to page "${bestMatch.path}" (score: ${bestMatch.score})`);
        // Mark this path as used so other services don't get it
        if (markAsUsed) {
            markSourcePathUsed(bestMatch.path);
        }
        // Return pageData with path attached for reference
        return { ...bestMatch.pageData, path: bestMatch.path };
    }

    return null;
}

// Apply detected services to UI (auto-select industries and services)
function applyServiceDetection() {
    if (campaignConfig.service_detection.applied || campaignConfig.service_detection.status !== 'success') {
        return;
    }

    const detection = campaignConfig.service_detection;
    let industriesSelected = 0;
    let servicesSelected = 0;
    let customServicesAdded = 0;

    // 1. Auto-select detected industries
    detection.detected_industry_ids.forEach(industryId => {
        const industryCard = $(`.industry-card[data-industry-id="${industryId}"]`);

        if (industryCard.length && !industryCard.hasClass('selected')) {
            // Click the industry card to select it
            industryCard.click();
            industriesSelected++;

            // Add AI-suggested visual indicator
            industryCard.addClass('ai-suggested');
        }
    });

    // Wait a bit for services to load after industry selection
    setTimeout(() => {
        // 2. Auto-select detected services
        detection.detected_service_ids.forEach(serviceId => {
            const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);

            if (serviceCard.length && !serviceCard.hasClass('selected')) {
                // Click the service card to select it
                serviceCard.click();
                servicesSelected++;

                // Add AI-suggested visual indicator
                serviceCard.addClass('ai-suggested');

                // Add confidence badge
                const confidence = detection.confidence_scores[serviceId];
                if (confidence && confidence > 0.8) {
                    serviceCard.find('.service-name, h4').first().append(
                        `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                            ‚ú® AI ${Math.round(confidence * 100)}%
                        </span>`
                    );
                }
            }
        });

        // 3. Add suggested services (custom services not in DB)
        if (detection.suggested_services && detection.suggested_services.length > 0) {
            detection.suggested_services.forEach(suggested => {
                // Check if not already added
                const exists = campaignConfig.custom_services.some(
                    cs => cs.name.toLowerCase() === suggested.name.toLowerCase()
                );
                if (!exists) {
                    campaignConfig.custom_services.push({
                        name: suggested.name,
                        industry: suggested.industry,
                        confidence: suggested.confidence,
                        evidence: suggested.evidence,
                        source_path: suggested.source_path || null,
                        has_dedicated_page: suggested.has_dedicated_page,
                        ai_suggested: true
                    });
                    customServicesAdded++;
                }
            });

            // Render custom services UI
            if (customServicesAdded > 0) {
                renderCustomServices();
            }
        }

        // Mark as applied
        campaignConfig.service_detection.applied = true;
        debouncedSaveState();

        // Render suggested industries section if a new industry was suggested
        const suggestedIndustry = campaignConfig.service_detection.suggested_industry;
        if (suggestedIndustry) {
            renderSuggestedIndustries();
            // Count services that would be added if industry is selected
            const suggestedServices = campaignConfig.service_detection.suggested_services || [];
            customServicesAdded = suggestedServices.filter(
                svc => svc.industry?.toLowerCase() === suggestedIndustry.toLowerCase()
            ).length;
        }

        // Show notification
        if (industriesSelected > 0 || servicesSelected > 0 || customServicesAdded > 0 || suggestedIndustry) {
            showServiceDetectionNotification(industriesSelected, servicesSelected, customServicesAdded, suggestedIndustry);
        }
    }, 500);
}

// Helper function to show/hide the AI suggestions wrapper section
function updateAiSuggestionsVisibility() {
    const aiSection = $('#ai-suggestions-section');
    const hasIndustries = !$('#suggested-industries-section').hasClass('hidden');
    const hasServices = $('#custom-services-section').length > 0 && campaignConfig.custom_services.length > 0;

    if (hasIndustries || hasServices) {
        aiSection.removeClass('hidden');
    } else {
        aiSection.addClass('hidden');
    }
}

// Generate purpose checkboxes HTML for custom services
function getCustomServicePurposeCheckboxes(index) {
    const purposes = campaignConfig.selected_purposes || [];
    const hasGoogleAds = purposes.includes('google_ads');
    const hasSeo = purposes.includes('seo');
    const hasProgrammatic = purposes.includes('programmatic');

    // If no relevant purposes, return empty
    if (!hasGoogleAds && !hasSeo && !hasProgrammatic) return '';

    // Initialize custom_service_purposes for this index if not exists
    if (!campaignConfig.custom_service_purposes[index]) {
        campaignConfig.custom_service_purposes[index] = {
            google_ads: hasGoogleAds,
            seo: hasSeo,
            programmatic: hasProgrammatic
        };
    }

    let checkboxes = '';
    if (hasGoogleAds) {
        const isChecked = campaignConfig.custom_service_purposes[index]?.google_ads !== false;
        checkboxes += `
            <label class="inline-flex items-center text-xs bg-green-50 px-2 py-1 rounded cursor-pointer hover:bg-green-100 transition-colors">
                <input type="checkbox" class="custom-service-purpose-checkbox w-3 h-3 mr-1"
                       data-index="${index}" data-purpose="google_ads" ${isChecked ? 'checked' : ''}>
                <span class="text-green-700">Google Ads</span>
            </label>`;
    }
    if (hasSeo) {
        const isChecked = campaignConfig.custom_service_purposes[index]?.seo !== false;
        checkboxes += `
            <label class="inline-flex items-center text-xs bg-orange-50 px-2 py-1 rounded cursor-pointer hover:bg-orange-100 transition-colors">
                <input type="checkbox" class="custom-service-purpose-checkbox w-3 h-3 mr-1"
                       data-index="${index}" data-purpose="seo" ${isChecked ? 'checked' : ''}>
                <span class="text-orange-700">SEO</span>
            </label>`;
    }
    if (hasProgrammatic) {
        const isChecked = campaignConfig.custom_service_purposes[index]?.programmatic !== false;
        checkboxes += `
            <label class="inline-flex items-center text-xs bg-purple-50 px-2 py-1 rounded cursor-pointer hover:bg-purple-100 transition-colors">
                <input type="checkbox" class="custom-service-purpose-checkbox w-3 h-3 mr-1"
                       data-index="${index}" data-purpose="programmatic" ${isChecked ? 'checked' : ''}>
                <span class="text-purple-700">Byside</span>
            </label>`;
    }

    return `
        <div class="custom-service-purposes mt-3 pt-3 border-t border-purple-200" data-index="${index}">
            <p class="text-xs text-gray-500 mb-2">Anvend til:</p>
            <div class="flex flex-wrap gap-2">
                ${checkboxes}
            </div>
        </div>`;
}

// Render custom services UI (services detected by AI but not in database)
function renderCustomServices() {
    let container = $('#custom-services-container');

    // Create container if it doesn't exist - now inside ai-suggestions-section
    if (!container.length) {
        const aiSectionInner = $('#ai-suggestions-section .border-t');
        if (aiSectionInner.length) {
            aiSectionInner.append(`
                <div id="custom-services-section" class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">‚ú®</span>
                        AI-Foresl√•ede Services
                        <span class="ml-2 text-sm font-normal text-gray-500">(ikke i databasen)</span>
                    </h3>
                    <div id="custom-services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    </div>
                </div>
            `);
            container = $('#custom-services-container');
        }
    }

    // Clear existing
    container.empty();

    // Render each custom service
    const websiteUrl = crawlState.website_url || campaignConfig.website_url || '';
    const baseUrl = websiteUrl.replace(/\/$/, ''); // Remove trailing slash

    campaignConfig.custom_services.forEach((service, index) => {
        const confidencePercent = Math.round((service.confidence || 0.8) * 100);
        const purposeCheckboxes = getCustomServicePurposeCheckboxes(index);

        // Build source URL display
        let sourceUrlHtml = '';
        if (service.source_path) {
            const fullUrl = baseUrl + service.source_path;
            const hasDedicatedPage = service.has_dedicated_page !== false; // Default to true if not specified

            if (hasDedicatedPage) {
                sourceUrlHtml = `
                    <div class="mt-2 flex items-center text-xs">
                        <span class="text-green-600 mr-1">‚úì</span>
                        <a href="${fullUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline truncate" title="${fullUrl}">
                            ${service.source_path}
                        </a>
                    </div>
                `;
            } else {
                sourceUrlHtml = `
                    <div class="mt-2 flex items-center text-xs">
                        <span class="text-amber-500 mr-1">‚ö†</span>
                        <span class="text-gray-500">Ingen dedikeret side</span>
                        <span class="text-gray-400 mx-1">‚Ä¢</span>
                        <a href="${fullUrl}" target="_blank" class="text-gray-500 hover:text-gray-700 hover:underline truncate" title="Fundet p√•: ${fullUrl}">
                            n√¶vnt p√• ${service.source_path}
                        </a>
                    </div>
                `;
            }
        }

        const card = $(`
            <div class="custom-service-card bg-purple-50 border-2 border-purple-200 rounded-lg p-4 relative" data-index="${index}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="font-medium text-gray-900">${service.name}</span>
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                ‚ú® AI ${confidencePercent}%
                            </span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${service.industry || 'Ikke tilknyttet'}</p>
                        ${service.evidence ? `<p class="text-xs text-gray-400 mt-1 italic">"${service.evidence.substring(0, 80)}..."</p>` : ''}
                        ${sourceUrlHtml}
                    </div>
                    <button type="button" class="remove-custom-service text-gray-400 hover:text-red-500 ml-2" data-index="${index}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                ${purposeCheckboxes}
            </div>
        `);
        container.append(card);
    });

    // Show/hide section based on whether there are custom services
    if (campaignConfig.custom_services.length > 0) {
        $('#custom-services-section').show();
    } else {
        $('#custom-services-section').hide();
    }

    // Update the wrapper visibility
    updateAiSuggestionsVisibility();
}

// Event handler for removing custom services
$(document).on('click', '.remove-custom-service', function() {
    const index = $(this).data('index');
    campaignConfig.custom_services.splice(index, 1);
    // Also remove from custom_service_purposes and reindex
    delete campaignConfig.custom_service_purposes[index];
    // Reindex the remaining purposes
    const newPurposes = {};
    campaignConfig.custom_services.forEach((_, newIndex) => {
        // Find the old index that maps to this new index
        const oldIndex = newIndex >= index ? newIndex + 1 : newIndex;
        if (campaignConfig.custom_service_purposes[oldIndex]) {
            newPurposes[newIndex] = campaignConfig.custom_service_purposes[oldIndex];
        }
    });
    campaignConfig.custom_service_purposes = newPurposes;
    renderCustomServices();
    debouncedSaveState();
});

// Event handler for custom service purpose checkbox changes
$(document).on('change', '.custom-service-purpose-checkbox', function(e) {
    e.stopPropagation(); // Prevent triggering card click

    const index = $(this).data('index');
    const purpose = $(this).data('purpose');
    const isChecked = $(this).is(':checked');

    // Ensure custom_service_purposes entry exists
    if (!campaignConfig.custom_service_purposes[index]) {
        campaignConfig.custom_service_purposes[index] = {
            google_ads: true,
            seo: true,
            programmatic: true
        };
    }

    // Update the purpose setting
    campaignConfig.custom_service_purposes[index][purpose] = isChecked;

    console.log('Custom service purpose updated:', index, purpose, isChecked);
    debouncedSaveState();
});

// Render suggested industries as selectable cards (like existing industry cards)
function renderSuggestedIndustries() {
    const suggestedIndustry = campaignConfig.service_detection?.suggested_industry;
    const suggestedServices = campaignConfig.service_detection?.suggested_services || [];

    const aiSection = $('#ai-suggestions-section');
    const section = $('#suggested-industries-section');
    const container = $('#suggested-industries-container');

    if (!suggestedIndustry) {
        section.addClass('hidden');
        updateAiSuggestionsVisibility();
        return;
    }

    // Show sections
    aiSection.removeClass('hidden');
    section.removeClass('hidden');
    container.empty();

    // Count services for this industry
    const industryServices = suggestedServices.filter(
        svc => svc.industry?.toLowerCase() === suggestedIndustry.toLowerCase()
    );

    // Check if this suggested industry is already selected
    const isSelected = campaignConfig.suggested_industries?.includes(suggestedIndustry);

    // Create industry card (similar style to existing industry cards)
    const card = $(`
        <div class="suggested-industry-card cursor-pointer bg-white rounded-xl border-2 p-4 transition-all duration-200 hover:shadow-lg ${isSelected ? 'border-amber-500 bg-amber-50 selected' : 'border-gray-200 hover:border-amber-300'}"
             data-industry-name="${suggestedIndustry}">
            <div class="flex items-start justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl flex items-center justify-center text-white text-2xl mr-4">
                        üÜï
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-gray-900">${suggestedIndustry}</h4>
                        <p class="text-sm text-gray-500">${industryServices.length} foresl√•ede services</p>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                        ‚ú® AI
                    </span>
                    <div class="mt-2 w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-amber-500 bg-amber-500' : 'border-gray-300'}">
                        ${isSelected ? '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `);

    container.append(card);

    // If selected, also render the services
    if (isSelected) {
        renderSuggestedIndustryServices(suggestedIndustry, industryServices);
    }
}

// Render services for a selected suggested industry
function renderSuggestedIndustryServices(industryName, services) {
    // Add services to custom_services if not already there
    services.forEach(service => {
        const exists = campaignConfig.custom_services.some(
            cs => cs.name.toLowerCase() === service.name.toLowerCase()
        );
        if (!exists) {
            campaignConfig.custom_services.push({
                name: service.name,
                industry: service.industry,
                confidence: service.confidence,
                evidence: service.evidence,
                ai_suggested: true
            });
        }
    });
    renderCustomServices();
}

// Handle click on suggested industry card
$(document).on('click', '.suggested-industry-card', function() {
    const card = $(this);
    const industryName = card.data('industry-name');
    const isCurrentlySelected = card.hasClass('selected');

    // Initialize suggested_industries array if needed
    if (!campaignConfig.suggested_industries) {
        campaignConfig.suggested_industries = [];
    }

    if (isCurrentlySelected) {
        // Deselect: remove from array and remove services
        campaignConfig.suggested_industries = campaignConfig.suggested_industries.filter(i => i !== industryName);

        // Remove custom services for this industry
        campaignConfig.custom_services = campaignConfig.custom_services.filter(
            cs => cs.industry?.toLowerCase() !== industryName.toLowerCase()
        );

        card.removeClass('selected border-amber-500 bg-amber-50').addClass('border-gray-200');
        card.find('.rounded-full').removeClass('border-amber-500 bg-amber-500').addClass('border-gray-300').empty();
    } else {
        // Select: add to array and add services
        if (!campaignConfig.suggested_industries.includes(industryName)) {
            campaignConfig.suggested_industries.push(industryName);
        }

        // Get services for this industry
        const suggestedServices = campaignConfig.service_detection?.suggested_services || [];
        const industryServices = suggestedServices.filter(
            svc => svc.industry?.toLowerCase() === industryName.toLowerCase()
        );

        renderSuggestedIndustryServices(industryName, industryServices);

        card.addClass('selected border-amber-500 bg-amber-50').removeClass('border-gray-200');
        card.find('.rounded-full').addClass('border-amber-500 bg-amber-500').removeClass('border-gray-300')
            .html('<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>');
    }

    renderCustomServices();
    debouncedSaveState();
})

// Show notification when service detection is applied
function showServiceDetectionNotification(industriesCount, servicesCount, customServicesCount = 0, suggestedIndustry = null) {
    if (industriesCount === 0 && servicesCount === 0 && customServicesCount === 0 && !suggestedIndustry) return;

    let message = '‚ú® AI har fundet';
    const parts = [];

    // If a new industry is suggested (not in database)
    if (suggestedIndustry) {
        parts.push(`ny branche "${suggestedIndustry}"`);
    } else if (industriesCount > 0) {
        parts.push(`${industriesCount} branche${industriesCount > 1 ? 'r' : ''}`);
    }

    if (servicesCount > 0) parts.push(`${servicesCount} service${servicesCount > 1 ? 's' : ''}`);
    if (customServicesCount > 0) parts.push(`${customServicesCount} foresl√•et service${customServicesCount > 1 ? 's' : ''}`);
    message += ' ' + parts.join(' og ') + ' fra din hjemmeside';

    // Create toast notification
    const toast = $(`
        <div class="fixed bottom-4 right-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 rounded-xl shadow-lg z-50" style="animation: slideIn 0.3s ease-out">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">üîç</span>
                <span>${message}</span>
            </div>
        </div>
    `);

    $('body').append(toast);
    setTimeout(() => toast.fadeOut(300, () => toast.remove()), 5000);
}


// Start background crawl (no UI updates - runs silently)
async function startBackgroundCrawl() {
    if (!crawlState.website_url || crawlState.crawl_status !== 'idle') {
        console.log('Background crawl skipped:', crawlState.crawl_status);
        return;
    }

    console.log('Starting background crawl for:', crawlState.website_url);
    crawlState.crawl_status = 'crawling';

    try {
        const response = await $.ajax({
            url: '/ajax/crawl-sitemap/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({ website_url: crawlState.website_url })
        });

        if (response.success) {
            crawlState.sitemap_urls = response.urls || [];
            crawlState.urls_found = response.urls_found || 0;
            crawlState.crawl_status = 'success';
            crawlState.crawl_timestamp = Date.now();
            crawlState.crawl_error = null;

            // Match city pages if geo targeting is set
            await matchCityPagesAutoCrawl();
            debouncedSaveState();

            console.log('Background crawl completed:', crawlState.urls_found, 'URLs found');
        } else {
            throw new Error(response.error || 'Kunne ikke crawle sitemap');
        }
    } catch (error) {
        console.error('Background crawl error:', error);
        crawlState.crawl_status = 'error';
        crawlState.crawl_error = error.message || 'Ukendt fejl';
        debouncedSaveState();
    }
}

// Match city pages during auto-crawl (uses geo_map_targeting if available)
async function matchCityPagesAutoCrawl() {
    // Check if we have geo map targeting cities
    const cities = campaignConfig.geo_map_targeting?.postal_names || [];
    if (cities.length === 0) {
        console.log('No cities to match during auto-crawl');
        return;
    }

    // Get service name for matching
    const serviceName = getFirstSelectedServiceName();
    if (!serviceName) {
        console.log('No service selected for city matching');
        return;
    }

    try {
        const response = await $.ajax({
            url: '/ajax/match-city-pages/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                website_url: crawlState.website_url,
                service_name: serviceName,
                cities: cities
            })
        });

        if (response.success) {
            crawlState.city_matches = response.results || [];
            crawlState.existing_count = response.existing_count || 0;
            crawlState.missing_count = response.missing_count || 0;
            console.log('City match results:', response);
        }
    } catch (error) {
        console.error('City match error during auto-crawl:', error);
    }
}

// Get first selected service name for crawl matching
function getFirstSelectedServiceName() {
    // Try to get from loaded services data
    const serviceIds = campaignConfig.service_ids || [];
    if (serviceIds.length === 0) return null;

    // Find in rendered service cards
    const firstServiceCard = $(`.service-card[data-service-id="${serviceIds[0]}"]`);
    if (firstServiceCard.length) {
        return firstServiceCard.find('h4').text().trim() ||
               firstServiceCard.find('.font-medium').first().text().trim();
    }

    return null;
}

// Show auto-crawl results
function showAutoCrawlResults() {
    $('#autocrawl-loading').addClass('hidden');
    $('#autocrawl-error').addClass('hidden');
    $('#autocrawl-no-url').addClass('hidden');
    $('#autocrawl-results').removeClass('hidden');

    // Update result counts
    $('#autocrawl-total-urls').text(crawlState.urls_found);
    $('#autocrawl-existing-pages').text(crawlState.existing_count);
}

// =====================================================
// Service Keyword Edit/Delete Functions (Step 5)
// =====================================================

// Delete service keyword via AJAX
$(document).on('click', '.delete-service-keyword-btn', function(e) {
    e.stopPropagation();
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const keywordItem = $(this).closest('.keyword-item');
    const keywordText = keywordItem.find('.keyword-text').text();

    if (!confirm(`Er du sikker p√• at du vil slette s√∏geordet "${keywordText}"?`)) {
        return;
    }

    $.ajax({
        url: `/ajax/delete-service-keyword/${keywordId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // Remove from UI
                keywordItem.fadeOut(200, function() {
                    $(this).remove();
                });

                // Update serverData.google_keywords for this service
                if (serverData.google_keywords[serviceId]) {
                    serverData.google_keywords[serviceId] = serverData.google_keywords[serviceId].filter(kw => kw.id !== keywordId);
                }

                // Update campaignConfig.campaigns as well
                Object.values(campaignConfig.campaigns).forEach(campaign => {
                    if (campaign.ad_groups && campaign.ad_groups[serviceId]) {
                        campaign.ad_groups[serviceId].keywords = campaign.ad_groups[serviceId].keywords.filter(kw => kw.id !== keywordId);
                    }
                });

                console.log('Keyword deleted successfully:', keywordId);
            } else {
                alert('Kunne ikke slette s√∏geordet: ' + (response.error || 'Ukendt fejl'));
            }
        },
        error: function(xhr) {
            console.error('Error deleting keyword:', xhr);
            alert('Fejl ved sletning af s√∏geord. Pr√∏v igen.');
        }
    });
});

// Edit service keyword via AJAX - show inline edit form
$(document).on('click', '.edit-service-keyword-btn', function(e) {
    e.stopPropagation();
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const keywordItem = $(this).closest('.keyword-item');
    const keywordTextSpan = keywordItem.find('.keyword-text');
    const currentText = keywordTextSpan.text();

    // Replace keyword text with input field for editing
    const inputHtml = `
        <input type="text" class="keyword-edit-input text-xs px-1 py-0.5 border border-blue-300 rounded w-24 focus:ring-1 focus:ring-blue-500"
               value="${escapeHtml(currentText)}" data-keyword-id="${keywordId}" data-service-id="${serviceId}" data-original="${escapeHtml(currentText)}">
        <button type="button" class="save-keyword-edit-btn text-green-600 hover:text-green-800 text-xs ml-1" title="Gem">‚úì</button>
        <button type="button" class="cancel-keyword-edit-btn text-gray-400 hover:text-gray-600 text-xs ml-1" title="Annuller">‚úï</button>
    `;

    keywordTextSpan.html(inputHtml);
    keywordTextSpan.find('.keyword-edit-input').focus().select();

    // Hide action buttons while editing
    keywordItem.find('.keyword-actions').addClass('hidden');
});

// Save keyword edit
$(document).on('click', '.save-keyword-edit-btn', function(e) {
    e.stopPropagation();
    const input = $(this).siblings('.keyword-edit-input');
    const keywordId = input.data('keyword-id');
    const serviceId = input.data('service-id');
    const newText = input.val().trim();
    const originalText = input.data('original');

    if (!newText) {
        alert('S√∏geord kan ikke v√¶re tomt');
        return;
    }

    if (newText === originalText) {
        // No changes, just restore
        restoreKeywordDisplay(input, originalText);
        return;
    }

    $.ajax({
        url: `/ajax/update-service-keyword/${keywordId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        data: {
            keyword_text: newText
        },
        success: function(response) {
            if (response.success) {
                // Update UI with new text
                restoreKeywordDisplay(input, newText);

                // Update serverData.google_keywords
                if (serverData.google_keywords[serviceId]) {
                    const kwIndex = serverData.google_keywords[serviceId].findIndex(kw => kw.id === keywordId);
                    if (kwIndex !== -1) {
                        serverData.google_keywords[serviceId][kwIndex].keyword_text = newText;
                    }
                }

                // Update campaignConfig
                Object.values(campaignConfig.campaigns).forEach(campaign => {
                    if (campaign.ad_groups && campaign.ad_groups[serviceId]) {
                        const kwIndex = campaign.ad_groups[serviceId].keywords.findIndex(kw => kw.id === keywordId);
                        if (kwIndex !== -1) {
                            campaign.ad_groups[serviceId].keywords[kwIndex].keyword = newText;
                        }
                    }
                });

                console.log('Keyword updated successfully:', keywordId, newText);
            } else {
                alert('Kunne ikke opdatere s√∏geordet: ' + (response.error || 'Ukendt fejl'));
                restoreKeywordDisplay(input, originalText);
            }
        },
        error: function(xhr) {
            console.error('Error updating keyword:', xhr);
            alert('Fejl ved opdatering af s√∏geord. Pr√∏v igen.');
            restoreKeywordDisplay(input, originalText);
        }
    });
});

// Cancel keyword edit
$(document).on('click', '.cancel-keyword-edit-btn', function(e) {
    e.stopPropagation();
    const input = $(this).siblings('.keyword-edit-input');
    const originalText = input.data('original');
    restoreKeywordDisplay(input, originalText);
});

// Handle Enter/Escape in keyword edit input
$(document).on('keydown', '.keyword-edit-input', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        $(this).siblings('.save-keyword-edit-btn').click();
    } else if (e.key === 'Escape') {
        e.preventDefault();
        $(this).siblings('.cancel-keyword-edit-btn').click();
    }
});

// Helper function to restore keyword display after editing
function restoreKeywordDisplay(input, text) {
    const keywordTextSpan = input.parent();
    const keywordItem = keywordTextSpan.closest('.keyword-item');

    keywordTextSpan.text(text);
    keywordItem.find('.keyword-actions').removeClass('hidden');
}

// ==========================================
// GEOGRAPHIC MAP MODAL - DAWA + Google Maps
// ==========================================

// =============================================================================
// LEAFLET POLYGON-BASED GEO MAP (replacing circle-based Google Maps approach)
// =============================================================================

var geoMap = null;  // Leaflet map instance
var geoGeoJsonLayer = null;  // Layer containing all postal code polygons
var geoPostalData = {};  // { postalCode: { geometry, navn, polygon, displayName, additionalNames } }
var geoSelectedPostals = {};  // { postalCode: { source: 'region'|'typed'|'clicked'|'circle', polygon } }
var geoSelectedCityNames = [];  // Array of city names for 1:1 display count
var geoCircleMode = false;  // Toggle for circle drawing mode
var geoCircles = [];  // Array of Leaflet circles (for optional circle mode)
var geoCircleDrawing = null;  // Current circle being drawn
var geoPostalCustomizations = {};  // Customizations from PostalCode Manager

// Color scheme for different selection sources
var GEO_COLORS = {
    region: { fill: '#3B82F6', stroke: '#2563EB' },    // Blue - from region selection
    typed: { fill: '#10B981', stroke: '#059669' },     // Green - manually typed
    clicked: { fill: '#8B5CF6', stroke: '#7C3AED' },   // Purple - clicked on map
    circle: { fill: '#F59E0B', stroke: '#D97706' },    // Orange - circle mode
    hover: { fill: '#6366F1', stroke: '#4F46E5' },     // Indigo - hover state
    default: { fill: '#E5E7EB', stroke: '#9CA3AF' }    // Gray - unselected
};

// Load PostalCode customizations from database
function loadPostalCustomizations() {
    return $.ajax({
        url: '{% url "get_postal_codes_api" %}',
        timeout: 10000,
        dataType: 'json'
    }).then(function(data) {
        console.log('PostalCode customizations loaded:', data.postal_codes.length, 'entries');
        data.postal_codes.forEach(function(pc) {
            geoPostalCustomizations[pc.code] = {
                displayName: pc.display_name || '',
                additionalNames: pc.additional_names ? pc.additional_names.split(',').map(function(n) { return n.trim().toLowerCase(); }).filter(Boolean) : []
            };
        });
        return geoPostalCustomizations;
    }).catch(function(error) {
        console.warn('Could not load postal customizations:', error);
        return {};
    });
}

// Consolidate K√∏benhavn K, V and Frederiksberg C postal codes into single entries
// Uses DAWA name matching instead of numeric ranges to ensure geographic continuity
// Turf.js is used to merge all matching polygons into one big polygon per city
function consolidateCopenhagenPostals(postalData) {
    // Use name patterns instead of numeric ranges
    // This ensures we only group geographically contiguous areas
    var consolidations = {
        'kbh_k': {
            namePattern: 'K√∏benhavn K',  // Matches postal codes named "K√∏benhavn K"
            displayName: 'K√∏benhavn',
            codes: []
        },
        'kbh_v': {
            namePatterns: ['Vesterbro', 'K√∏benhavn V'],  // Matches either name
            displayName: 'Vesterbro',
            codes: []
        },
        'frb_c': {
            namePattern: 'Frederiksberg',  // Matches postal codes containing "Frederiksberg"
            displayName: 'Frederiksberg',
            codes: []
        }
    };

    // Find all postal codes that should be consolidated based on DAWA name
    for (var nr in postalData) {
        var postal = postalData[nr];
        var davaName = postal.navn || '';

        for (var key in consolidations) {
            var c = consolidations[key];
            var matches = false;

            // Check if name matches pattern(s)
            if (c.namePatterns) {
                // Multiple patterns - check if any match
                matches = c.namePatterns.some(function(pattern) {
                    return davaName.indexOf(pattern) !== -1;
                });
            } else if (c.namePattern) {
                // Single pattern
                matches = davaName.indexOf(c.namePattern) !== -1;
            }

            if (matches) {
                c.codes.push(nr);
                break;  // Each postal code belongs to only one group
            }
        }
    }

    // For each consolidation: merge all polygons into one, hide the rest
    for (var key in consolidations) {
        var c = consolidations[key];
        if (c.codes.length > 0) {
            c.codes.sort();
            var primaryCode = c.codes[0];

            // Update primary with display name and all consolidated codes
            postalData[primaryCode].displayName = c.displayName;
            postalData[primaryCode].consolidatedCodes = c.codes;

            // Merge all polygons into one using Turf.js
            try {
                var polygonsToMerge = [];
                c.codes.forEach(function(code) {
                    var postal = postalData[code];
                    if (postal && postal.geometry) {
                        var feature = turf.feature(postal.geometry);
                        polygonsToMerge.push(feature);
                    }
                });

                if (polygonsToMerge.length > 1) {
                    // Use turf.union to merge all polygons
                    var merged = polygonsToMerge[0];
                    for (var i = 1; i < polygonsToMerge.length; i++) {
                        try {
                            merged = turf.union(merged, polygonsToMerge[i]);
                        } catch (e) {
                            // Skip invalid polygons
                            console.warn('Could not merge polygon', c.codes[i], e);
                        }
                    }

                    // Replace primary code's geometry with merged polygon
                    if (merged && merged.geometry) {
                        postalData[primaryCode].geometry = merged.geometry;
                        console.log('Merged', c.displayName + ':', c.codes.length, 'polygons into one (by name: ' + (c.namePattern || c.namePatterns.join('/')) + ')');
                    }
                }
            } catch (e) {
                console.error('Error merging polygons for', c.displayName, e);
            }

            console.log('Consolidated', c.displayName + ':', c.codes.length, 'postal codes into', primaryCode, '(matched by DAWA name)');

            // Hide the other postal codes from map display (show only merged polygon)
            for (var i = 1; i < c.codes.length; i++) {
                postalData[c.codes[i]].hidden = true;
            }
        }
    }

    return postalData;
}

// Load DAWA GeoJSON data for all postal codes
var dawaLoadingPromise = null;  // Track ongoing load to prevent duplicates

function loadDAWAGeoJSON() {
    if (Object.keys(geoPostalData).length > 0) {
        return Promise.resolve(geoPostalData);
    }

    // If already loading, return existing promise
    if (dawaLoadingPromise) {
        return dawaLoadingPromise;
    }

    console.log('Loading DAWA GeoJSON data...');

    // Load both DAWA data and customizations (with browser caching enabled)
    dawaLoadingPromise = Promise.all([
        $.ajax({
            url: 'https://dawa.aws.dk/postnumre?format=geojson',
            timeout: 30000,
            dataType: 'json',
            cache: true  // Allow browser caching for better performance
        }),
        loadPostalCustomizations()
    ]).then(function(results) {
        var geojson = results[0];
        console.log('DAWA GeoJSON loaded:', geojson.features.length, 'postal codes');

        // Build lookup by postal code with customizations
        geojson.features.forEach(function(feature) {
            var nr = feature.properties.nr;
            var customization = geoPostalCustomizations[nr] || {};

            geoPostalData[nr] = {
                nr: nr,
                navn: feature.properties.navn,
                displayName: customization.displayName || '',
                additionalNames: customization.additionalNames || [],
                geometry: feature.geometry,
                polygon: null,  // Will be set when added to map
                hidden: false,  // For consolidated postal codes
                consolidatedCodes: null  // Array of codes if this is a primary consolidated code
            };
        });

        // Consolidate K√∏benhavn K, V and Frederiksberg C
        consolidateCopenhagenPostals(geoPostalData);

        dawaLoadingPromise = null;  // Clear so future calls return cached data
        return geoPostalData;
    }).catch(function(error) {
        console.error('Error loading DAWA GeoJSON:', error);
        dawaLoadingPromise = null;  // Clear so retries can happen
        // Don't alert - just log and throw
        throw error;
    });

    return dawaLoadingPromise;
}

// Pre-load DAWA GeoJSON data in background for faster region selection
// This runs after the function is defined, with a delay so main UI loads first
setTimeout(function() {
    console.log('[Performance] Pre-loading DAWA GeoJSON data...');
    loadDAWAGeoJSON().then(function() {
        console.log('[Performance] DAWA GeoJSON pre-loaded successfully:', Object.keys(geoPostalData).length, 'postal codes');
    }).catch(function(err) {
        console.warn('[Performance] DAWA pre-load failed (will retry on demand):', err.message);
    });
}, 1500);  // 1.5 sec delay so main UI loads first

// Get display name for a postal code (uses customization or DAWA name)
function getPostalDisplayName(nr) {
    var postal = geoPostalData[nr];
    if (!postal) return nr;
    return postal.displayName || postal.navn;
}

// Find postal code by city name (checks both DAWA name and additional names)
function findPostalCodeByName(cityName) {
    if (!cityName) return null;
    var searchName = cityName.toLowerCase().trim();

    for (var nr in geoPostalData) {
        var postal = geoPostalData[nr];

        // Check DAWA name
        if (postal.navn.toLowerCase() === searchName) {
            return nr;
        }

        // Check display name
        if (postal.displayName && postal.displayName.toLowerCase() === searchName) {
            return nr;
        }

        // Check additional names (includes cities like Husum, N√∏rrebro etc.)
        if (postal.additionalNames && postal.additionalNames.includes(searchName)) {
            return nr;
        }
    }

    return null;
}

// Initialize Leaflet map with Danish postal code polygons
function initGeoModal() {
    var mapContainer = document.getElementById('geo-modal-map');
    if (!mapContainer) {
        console.error('geo-modal-map element not found');
        return Promise.reject('Map container not found');
    }

    // If map already exists, check if GeoJSON layer needs to be created
    if (geoMap) {
        geoMap.invalidateSize();
        // If GeoJSON layer doesn't exist yet, create it
        if (!geoGeoJsonLayer) {
            return loadDAWAGeoJSON().then(function(postalData) {
                createGeoJsonLayer(postalData);
            });
        }
        return Promise.resolve();
    }

    // Create Leaflet map centered on Denmark
    geoMap = L.map('geo-modal-map', {
        center: [55.670523, 12.583819],  // Copenhagen
        zoom: 7,
        minZoom: 5,
        maxZoom: 18
    });

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(geoMap);

    // Load and display postal code polygons
    return loadDAWAGeoJSON().then(function(postalData) {
        createGeoJsonLayer(postalData);
    });
}

// Create GeoJSON layer from postal data
function createGeoJsonLayer(postalData) {
    if (geoGeoJsonLayer) {
        console.log('GeoJSON layer already exists');
        return;
    }

    // Create GeoJSON features array (skip hidden/consolidated postal codes)
    var features = Object.values(postalData)
        .filter(function(postal) {
            return !postal.hidden;  // Skip consolidated postal codes (show only primary)
        })
        .map(function(postal) {
            return {
                type: 'Feature',
                properties: { nr: postal.nr, navn: postal.navn },
                geometry: postal.geometry
            };
        });

    // Add GeoJSON layer with styling
    geoGeoJsonLayer = L.geoJSON({ type: 'FeatureCollection', features: features }, {
        style: getPolygonStyle,
        onEachFeature: onEachPostalFeature
    }).addTo(geoMap);

    // Store polygon references
    geoGeoJsonLayer.eachLayer(function(layer) {
        var nr = layer.feature.properties.nr;
        if (geoPostalData[nr]) {
            geoPostalData[nr].polygon = layer;
        }
    });

    console.log('Geo map initialized with', features.length, 'postal polygons');

    // Restore saved selections from campaignConfig
    if (campaignConfig.geo_map_targeting && campaignConfig.geo_map_targeting.postal_codes) {
        campaignConfig.geo_map_targeting.postal_codes.forEach(function(code) {
            selectPostal(code, 'restored');
        });
        console.log('Restored', campaignConfig.geo_map_targeting.postal_codes.length, 'postal codes from saved state');
    }

    // Sync any pre-selected regions
    syncRegionsToMap();
    updateGeoSelectionDisplay();

    // Refresh all polygon styles after delays to ensure selections are applied
    // (syncRegionsToMap is async so we need multiple refreshes)
    setTimeout(function() {
        refreshAllPolygonStyles();
    }, 500);
    setTimeout(function() {
        refreshAllPolygonStyles();
    }, 1500);
    setTimeout(function() {
        refreshAllPolygonStyles();
    }, 3000);
}

// Refresh all polygon styles based on current geoSelectedPostals
function refreshAllPolygonStyles() {
    if (!geoGeoJsonLayer) {
        console.log('Geo layer not ready, skipping style refresh');
        return;
    }

    var selectedCount = Object.keys(geoSelectedPostals).length;
    if (selectedCount === 0) {
        console.log('No selections to refresh');
        return;
    }

    geoGeoJsonLayer.eachLayer(function(layer) {
        var nr = layer.feature.properties.nr;
        layer.setStyle(getPolygonStyle({ properties: { nr: nr } }));
    });

    console.log('Refreshed polygon styles for', selectedCount, 'selected postal codes');
}

// Get style for a postal code polygon
function getPolygonStyle(feature) {
    var nr = feature.properties.nr;
    var selected = geoSelectedPostals[nr];

    // For consolidated postal codes, check if ANY of the underlying codes are selected
    if (!selected) {
        var postal = geoPostalData[nr];
        if (postal && postal.consolidatedCodes) {
            for (var i = 0; i < postal.consolidatedCodes.length; i++) {
                if (geoSelectedPostals[postal.consolidatedCodes[i]]) {
                    selected = geoSelectedPostals[postal.consolidatedCodes[i]];
                    break;
                }
            }
        }
    }

    if (selected) {
        var colors = GEO_COLORS[selected.source] || GEO_COLORS.clicked;
        return {
            fillColor: colors.fill,
            fillOpacity: 0.4,
            color: colors.stroke,
            weight: 2,
            opacity: 0.8
        };
    }

    return {
        fillColor: GEO_COLORS.default.fill,
        fillOpacity: 0.1,
        color: GEO_COLORS.default.stroke,
        weight: 1,
        opacity: 0.5
    };
}

// Attach events to each postal code polygon
function onEachPostalFeature(feature, layer) {
    var nr = feature.properties.nr;
    var postal = geoPostalData[nr];

    // Use display name if available (for consolidated areas like K√∏benhavn)
    var displayName = postal && postal.displayName ? postal.displayName : feature.properties.navn;

    // Tooltip showing postal code info
    layer.bindTooltip(displayName, { sticky: true });

    // Hover effects
    layer.on('mouseover', function(e) {
        if (!geoSelectedPostals[nr]) {
            layer.setStyle({
                fillColor: GEO_COLORS.hover.fill,
                fillOpacity: 0.3,
                weight: 2
            });
        }
    });

    layer.on('mouseout', function(e) {
        if (!geoSelectedPostals[nr]) {
            layer.setStyle(getPolygonStyle(feature));
        }
    });

    // Click to toggle selection
    layer.on('click', function(e) {
        if (geoCircleMode) return;  // Ignore clicks in circle mode

        togglePostalSelection(nr, 'clicked');
        L.DomEvent.stopPropagation(e);
    });
}

// Toggle selection of a postal code
function togglePostalSelection(postalCode, source) {
    postalCode = String(postalCode);
    var postal = geoPostalData[postalCode];

    // Check if this is a consolidated postal code (K√∏benhavn, Vesterbro, Frederiksberg)
    if (postal && postal.consolidatedCodes) {
        // For consolidated codes, check if ANY of them are selected
        var anySelected = postal.consolidatedCodes.some(function(code) {
            return !!geoSelectedPostals[code];
        });

        if (anySelected) {
            // Deselect ALL consolidated codes
            deselectPostal(postalCode);
        } else {
            // Select ALL consolidated codes
            selectPostal(postalCode, source);
        }
    } else {
        // Normal postal code - simple toggle
        if (geoSelectedPostals[postalCode]) {
            // Deselect
            delete geoSelectedPostals[postalCode];
        } else {
            // Select
            geoSelectedPostals[postalCode] = { source: source };
        }

        // Update polygon style
        if (postal && postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    }

    updateGeoSelectionDisplay();
}

// Select a postal code (without toggle)
// Now tracks multiple regionIds so postal codes shared between regions aren't lost when one region is deselected
function selectPostal(postalCode, source, regionId = null) {
    postalCode = String(postalCode);

    // Helper to add regionId to existing selection
    function addRegionToSelection(code, isConsolidated) {
        if (geoSelectedPostals[code]) {
            // Already selected - add this regionId if not already present
            if (regionId && source === 'region') {
                if (!geoSelectedPostals[code].regionIds) {
                    // Convert old single regionId to array
                    geoSelectedPostals[code].regionIds = geoSelectedPostals[code].regionId ?
                        [geoSelectedPostals[code].regionId] : [];
                    delete geoSelectedPostals[code].regionId;
                }
                if (geoSelectedPostals[code].regionIds.indexOf(regionId) === -1) {
                    geoSelectedPostals[code].regionIds.push(regionId);
                }
            }
        } else {
            // New selection
            var newSelection = {
                source: source,
                regionIds: regionId ? [regionId] : []
            };
            // Only mark as consolidated if it's actually part of a consolidated group
            if (isConsolidated) {
                newSelection.consolidated = true;
            }
            geoSelectedPostals[code] = newSelection;
        }
    }

    // If this is a consolidated postal code (like K√∏benhavn K), select all underlying codes
    var postal = geoPostalData[postalCode];
    if (postal && postal.consolidatedCodes) {
        // Select all consolidated codes internally - mark them as consolidated
        postal.consolidatedCodes.forEach(function(code) {
            addRegionToSelection(code, true);
        });
        // Update only the primary polygon style (consolidated codes share this polygon)
        if (postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    } else {
        // Regular postal code - NOT consolidated
        addRegionToSelection(postalCode, false);

        if (postal && postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    }
}

// Deselect a postal code
function deselectPostal(postalCode) {
    postalCode = String(postalCode);

    // If this is a consolidated postal code, deselect all underlying codes
    var postal = geoPostalData[postalCode];
    if (postal && postal.consolidatedCodes) {
        postal.consolidatedCodes.forEach(function(code) {
            delete geoSelectedPostals[code];
        });
        // Update only the primary polygon style
        if (postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    } else if (geoSelectedPostals[postalCode]) {
        delete geoSelectedPostals[postalCode];

        if (postal && postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    }
}

// Find consolidated primary code for cities with multiple postal codes
function findConsolidatedPrimaryCode(cityName) {
    var name = (cityName || '').toLowerCase().trim();
    if (name === 'k√∏benhavn') {
        return '1050';  // K√∏benhavn K primary (1050-1473)
    }
    if (name === 'vesterbro') {
        return '1550';  // K√∏benhavn V primary (1550-1799)
    }
    if (name === 'frederiksberg') {
        return '1800';  // Frederiksberg C primary (1800-1999)
    }
    return null;
}

// Batch select postal codes without updating polygons (for performance)
function selectPostalBatch(postalCode, source, regionId, changedPostals) {
    postalCode = String(postalCode);

    function addRegionToSelection(code, isConsolidated) {
        if (geoSelectedPostals[code]) {
            if (regionId && source === 'region') {
                if (!geoSelectedPostals[code].regionIds) {
                    geoSelectedPostals[code].regionIds = geoSelectedPostals[code].regionId ?
                        [geoSelectedPostals[code].regionId] : [];
                    delete geoSelectedPostals[code].regionId;
                }
                if (geoSelectedPostals[code].regionIds.indexOf(regionId) === -1) {
                    geoSelectedPostals[code].regionIds.push(regionId);
                    changedPostals.add(code);
                }
            }
        } else {
            var newSelection = {
                source: source,
                regionIds: regionId ? [regionId] : []
            };
            if (isConsolidated) {
                newSelection.consolidated = true;
            }
            geoSelectedPostals[code] = newSelection;
            changedPostals.add(code);
        }
    }

    var postal = geoPostalData[postalCode];
    if (postal && postal.consolidatedCodes) {
        postal.consolidatedCodes.forEach(function(code) {
            addRegionToSelection(code, true);
        });
        changedPostals.add(postalCode);  // Track primary for polygon update
    } else {
        addRegionToSelection(postalCode, false);
    }
}

// Refresh polygon styles for changed postal codes only
function refreshChangedPolygons(changedPostals) {
    changedPostals.forEach(function(postalCode) {
        var postal = geoPostalData[postalCode];
        if (postal && postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    });
}

// Add region's cities as selected postal codes (polygon-based) - OPTIMIZED with batching
function addRegionToGeoMap(regionId, regionName, cities) {
    if (!cities || cities.length === 0) return;

    var startTime = performance.now();

    loadDAWAGeoJSON().then(function() {
        var changedPostals = new Set();  // Track which postal codes need polygon updates

        cities.forEach(function(city) {
            var postalCode = null;
            var cityName = city.name || city.dawa_name || '';
            var foundPostalCode = false;

            // 0. SPECIAL: MULTI postnummer for K√∏benhavn/Vesterbro/Frederiksberg
            if (city.postal_code === 'MULTI') {
                var primaryCode = findConsolidatedPrimaryCode(city.name);
                if (primaryCode && geoPostalData[primaryCode]) {
                    selectPostalBatch(primaryCode, 'region', regionId, changedPostals);
                    foundPostalCode = true;
                }
            } else {
                // 1. PRIORITET: Brug postal_code direkte hvis tilg√¶ngelig
                if (city.postal_code && /^\d{4}$/.test(city.postal_code)) {
                    postalCode = city.postal_code;
                }
                // 2. FALLBACK: dawa_name hvis det er et postnummer
                else if (city.dawa_name && /^\d{4}$/.test(city.dawa_name)) {
                    postalCode = city.dawa_name;
                }
                // 3. SIDSTE UDVEJ: Navnematching
                else {
                    var lookupName = city.dawa_name || city.name || '';
                    postalCode = findPostalCodeByName(lookupName);
                }

                if (postalCode && geoPostalData[postalCode]) {
                    selectPostalBatch(postalCode, 'region', regionId, changedPostals);
                    foundPostalCode = true;
                }
            }

            // Always track city name (for display), but mark if it's keyword-only (no postal code)
            if (!geoSelectedCityNames.find(function(c) { return c.name === cityName && c.regionId === regionId; })) {
                geoSelectedCityNames.push({
                    name: cityName,
                    regionId: regionId,
                    keywordOnly: !foundPostalCode  // True for areas like Nordsj√¶lland
                });
            }
        });

        // Batch update all changed polygons at once
        refreshChangedPolygons(changedPostals);

        updateGeoSelectionDisplay();

        // Pan to show selected area
        fitMapToSelection();

        // Sync to campaignConfig so generate-urls works immediately
        syncGeoMapTargetingToConfig();

        var endTime = performance.now();
        console.log('[Performance] addRegionToGeoMap completed in', Math.round(endTime - startTime), 'ms for', cities.length, 'cities,', changedPostals.size, 'polygons updated');
    });
}

// Remove region's postal codes from selection
// Only fully removes postal codes if they're not also selected by another region
function removeRegionFromGeoMap(regionId) {
    var postalsToFullyRemove = [];
    var postalsToUpdateStyle = [];

    for (var nr in geoSelectedPostals) {
        var selection = geoSelectedPostals[nr];

        // Check if this postal code has this regionId
        var hasRegion = false;
        if (selection.regionIds && selection.regionIds.indexOf(regionId) !== -1) {
            hasRegion = true;
        } else if (selection.regionId === regionId) {
            // Old format with single regionId
            hasRegion = true;
        }

        if (hasRegion) {
            if (selection.regionIds) {
                // Remove this regionId from the array
                var idx = selection.regionIds.indexOf(regionId);
                if (idx !== -1) {
                    selection.regionIds.splice(idx, 1);
                }
                // Only fully remove if no more regions reference it
                if (selection.regionIds.length === 0) {
                    postalsToFullyRemove.push(nr);
                } else {
                    postalsToUpdateStyle.push(nr);
                }
            } else {
                // Old format - just remove it
                postalsToFullyRemove.push(nr);
            }
        }
    }

    // Fully deselect postal codes with no remaining region references
    postalsToFullyRemove.forEach(function(postalCode) {
        deselectPostal(postalCode);
    });

    // Update styles for postal codes that are still selected by other regions
    postalsToUpdateStyle.forEach(function(postalCode) {
        var postal = geoPostalData[postalCode];
        if (postal && postal.polygon) {
            postal.polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    });

    // Remove city names for this region from the 1:1 tracking
    geoSelectedCityNames = geoSelectedCityNames.filter(function(c) {
        return c.regionId !== regionId;
    });

    updateGeoSelectionDisplay();

    // Sync to campaignConfig
    syncGeoMapTargetingToConfig();
}

// Get all postal codes for a region
function getRegionPostalCodes(regionCard) {
    var cities = $(regionCard).data('cities') || [];
    var postalCodes = [];

    cities.forEach(function(city) {
        // 0. SPECIAL: MULTI postnummer for K√∏benhavn/Vesterbro/Frederiksberg
        if (city.postal_code === 'MULTI') {
            var primaryCode = findConsolidatedPrimaryCode(city.name);
            if (primaryCode && geoPostalData[primaryCode]) {
                var postal = geoPostalData[primaryCode];
                if (postal.consolidatedCodes) {
                    // Add all consolidated codes
                    postal.consolidatedCodes.forEach(function(code) {
                        if (postalCodes.indexOf(code) === -1) {
                            postalCodes.push(code);
                        }
                    });
                } else {
                    postalCodes.push(primaryCode);
                }
            }
            return; // Continue to next city
        }

        var postalCode = null;

        // 1. PRIORITET: Brug postal_code direkte hvis tilg√¶ngelig
        if (city.postal_code && /^\d{4}$/.test(city.postal_code)) {
            postalCode = city.postal_code;
        }
        // 2. FALLBACK: dawa_name hvis det er et postnummer
        else if (city.dawa_name && /^\d{4}$/.test(city.dawa_name)) {
            postalCode = city.dawa_name;
        }
        // 3. SIDSTE UDVEJ: Navnematching (legacy)
        else {
            var cityName = city.dawa_name || city.name || '';
            postalCode = findPostalCodeByName(cityName);
        }

        if (postalCode && geoPostalData[postalCode]) {
            postalCodes.push(postalCode);
        }
    });

    return postalCodes;
}

// Check if all postal codes for a region are selected
function isRegionFullySelected(regionCard) {
    var regionPostalCodes = getRegionPostalCodes(regionCard);

    if (regionPostalCodes.length === 0) return false;

    // Check if ALL postal codes are selected
    return regionPostalCodes.every(function(postalCode) {
        return geoSelectedPostals[postalCode] !== undefined;
    });
}

// Sync region card selection state with actual postal code selections
function syncRegionSelectionState() {
    $('.geographic-region-card').each(function() {
        var regionCard = $(this);
        var regionId = regionCard.data('region-id');
        var isFullySelected = isRegionFullySelected(this);
        var isCurrentlyMarked = regionCard.hasClass('selected');

        if (isFullySelected && !isCurrentlyMarked) {
            // All cities selected - mark region as selected
            regionCard.addClass('selected');
            if (!campaignConfig.geographic_region_ids.includes(regionId)) {
                campaignConfig.geographic_region_ids.push(regionId);
            }
        } else if (!isFullySelected && isCurrentlyMarked) {
            // Not all cities selected - unmark region
            regionCard.removeClass('selected');
            campaignConfig.geographic_region_ids = campaignConfig.geographic_region_ids.filter(function(id) {
                return id !== regionId;
            });
        }
    });
}

// Fit map bounds to show all selected postal codes
function fitMapToSelection() {
    if (!geoMap) return;

    var selectedPostals = Object.keys(geoSelectedPostals);
    if (selectedPostals.length === 0) return;

    var bounds = L.latLngBounds();
    selectedPostals.forEach(function(nr) {
        if (geoPostalData[nr] && geoPostalData[nr].polygon) {
            bounds.extend(geoPostalData[nr].polygon.getBounds());
        }
    });

    if (bounds.isValid()) {
        geoMap.fitBounds(bounds, { padding: [20, 20] });
    }
}

// Sync selected regions to map polygons
function syncRegionsToMap() {
    $('.geographic-region-card.selected').each(function() {
        var regionId = $(this).data('region-id');
        var regionName = $(this).data('region-name');
        var cities = $(this).data('cities') || [];
        addRegionToGeoMap(regionId, regionName, cities);
    });
}

// Update the display of selected postal codes
function updateGeoSelectionDisplay() {
    var selectedList = [];
    var cityCountExcludingKeywords = 0;

    // Use city names from regions for display
    geoSelectedCityNames.forEach(function(city) {
        if (selectedList.indexOf(city.name) === -1) {
            selectedList.push(city.name);
            // Only count cities with postal codes (not keyword-only areas like Nordsj√¶lland)
            if (!city.keywordOnly) {
                cityCountExcludingKeywords++;
            }
        }
    });

    // Also add postal codes selected directly (typed, clicked, circle) that are not from regions
    for (var nr in geoSelectedPostals) {
        var selection = geoSelectedPostals[nr];

        // Skip if this was added from a region (city names already tracked)
        if (selection.regionIds && selection.regionIds.length > 0) {
            continue;
        }
        if (selection.regionId) {
            continue;
        }

        var postal = geoPostalData[nr];
        if (postal) {
            var displayName = getPostalDisplayName(nr);
            if (selectedList.indexOf(displayName) === -1) {
                selectedList.push(displayName);
                cityCountExcludingKeywords++;
            }
        } else {
            if (selectedList.indexOf(nr) === -1) {
                selectedList.push(nr);
                cityCountExcludingKeywords++;
            }
        }
    }

    selectedList.sort();

    // Update modal display (show all including keywords)
    $('#geo-panel-selected-cities').val(selectedList.join('\n'));
    $('#geo-panel-city-count').text(cityCountExcludingKeywords);

    // Also update Step 4 display (outside modal)
    if (selectedList.length > 0) {
        var displayText = selectedList.slice(0, 5).join(', ');
        if (selectedList.length > 5) {
            displayText += ' +' + (selectedList.length - 5) + ' mere';
        }
        $('#geo-map-selected-cities').val(displayText);
        // Show count excluding keyword-only areas
        $('#geo-map-city-count').text(cityCountExcludingKeywords);
        $('#geo-map-summary').show();
    } else {
        $('#geo-map-selected-cities').val('').attr('placeholder', 'Klik p√• knappen for at v√¶lge omr√•der...');
        $('#geo-map-summary').hide();
    }

    // Sync region selection state with actual postal code selections
    syncRegionSelectionState();
}

// Sync geo map targeting data to campaignConfig for immediate use (e.g., generate URLs)
function syncGeoMapTargetingToConfig() {
    // Build postal_names from tracked city names
    var postalNames = [];
    geoSelectedCityNames.forEach(function(city) {
        if (postalNames.indexOf(city.name) === -1) {
            postalNames.push(city.name);
        }
    });

    // Build postal_codes from geoSelectedPostals
    var postalCodes = Object.keys(geoSelectedPostals);

    // Update campaignConfig
    campaignConfig.geo_map_targeting = {
        postal_codes: postalCodes,
        postal_names: postalNames,
        circles: geoCircles.map(function(c) {
            return { lat: c.lat, lng: c.lng, radius: c.radius };
        })
    };

    debouncedSaveState();

    // Update negative city count display
    updateNegativeCityCount();
}

// Add postal codes from input field
function addPostalCodesFromInput() {
    var input = $('#geo-postal-input').val();
    if (!input.trim()) return;

    // Parse comma-separated postal codes
    var codes = input.split(/[,\s]+/).map(function(s) { return s.trim(); }).filter(Boolean);

    codes.forEach(function(code) {
        if (/^\d{4}$/.test(code) && geoPostalData[code]) {
            selectPostal(code, 'typed');
        }
    });

    updateGeoSelectionDisplay();
    $('#geo-postal-input').val('');

    // Pan to show new selection
    fitMapToSelection();
}

// Toggle circle drawing mode
function toggleCircleMode() {
    geoCircleMode = !geoCircleMode;

    var btn = $('#toggle-circle-mode');
    if (geoCircleMode) {
        btn.addClass('bg-orange-100 border-orange-500');
        btn.html('<span class="mr-1">‚úì</span> Cirkel-mode aktiv');

        // Add click handler for circle creation
        geoMap.on('click', onCircleModeClick);
    } else {
        btn.removeClass('bg-orange-100 border-orange-500');
        btn.html('<span class="mr-1">‚≠ï</span> Cirkel-tegning');

        // Remove circle click handler
        geoMap.off('click', onCircleModeClick);
    }
}

// Handle click in circle mode
function onCircleModeClick(e) {
    if (!geoCircleMode) return;

    var circle = L.circle(e.latlng, {
        radius: 15000,  // 15km default
        color: GEO_COLORS.circle.stroke,
        fillColor: GEO_COLORS.circle.fill,
        fillOpacity: 0.3,
        weight: 2
    }).addTo(geoMap);

    // Add click to remove
    circle.on('click', function() {
        geoMap.removeLayer(circle);
        geoCircles = geoCircles.filter(function(c) { return c !== circle; });
        selectPostalsInCircles();
    });

    geoCircles.push(circle);
    selectPostalsInCircles();
}

// Select all postal codes that fall within any circle
function selectPostalsInCircles() {
    // First, deselect all circle-sourced postals
    for (var nr in geoSelectedPostals) {
        if (geoSelectedPostals[nr].source === 'circle') {
            deselectPostal(nr);
        }
    }

    // Then check each postal code center against circles
    geoCircles.forEach(function(circle) {
        var center = circle.getLatLng();
        var radius = circle.getRadius();

        for (var nr in geoPostalData) {
            var postal = geoPostalData[nr];
            if (postal.polygon) {
                var postalCenter = postal.polygon.getBounds().getCenter();
                var distance = center.distanceTo(postalCenter);

                if (distance <= radius) {
                    selectPostal(nr, 'circle');
                }
            }
        }
    });

    updateGeoSelectionDisplay();
}

// Clear all selections
function clearAllGeoSelections() {
    // Clear polygon selections
    for (var nr in geoSelectedPostals) {
        deselectPostal(nr);
    }
    geoSelectedPostals = {};

    // Clear circles
    geoCircles.forEach(function(circle) {
        geoMap.removeLayer(circle);
    });
    geoCircles = [];

    updateGeoSelectionDisplay();
}

// Panel open/close functions
function openGeoMapPanel() {
    $('#geo-map-panel-overlay').removeClass('hidden');
    setTimeout(function() {
        $('#geo-map-panel-overlay').removeClass('opacity-0');
        $('#geo-map-panel').removeClass('translate-x-full');

        // Initialize map after panel is visible
        setTimeout(function() {
            initGeoModal().then(function() {
                // Map is ready
            }).catch(function(err) {
                console.error('Error initializing geo modal:', err);
            });
        }, 100);
    }, 10);
}

function closeGeoMapPanel() {
    $('#geo-map-panel').addClass('translate-x-full');
    $('#geo-map-panel-overlay').addClass('opacity-0');
    setTimeout(function() {
        $('#geo-map-panel-overlay').addClass('hidden');
    }, 300);
}

// Event handlers for geographic map panel
$('#open-geo-map-btn').click(function() {
    openGeoMapPanel();
});

$(document).on('click', '#close-geo-map-panel', function() {
    closeGeoMapPanel();
});

$(document).on('click', '#geo-map-panel-overlay', function(e) {
    if (e.target === this) closeGeoMapPanel();
});

$(document).on('click', '#geo-add-postal-btn', function() {
    addPostalCodesFromInput();
});

$(document).on('keypress', '#geo-postal-input', function(e) {
    if (e.which === 13) {
        e.preventDefault();
        addPostalCodesFromInput();
    }
});

$(document).on('click', '#toggle-circle-mode', function() {
    toggleCircleMode();
});

$(document).on('click', '#clear-geo-map-selection', function() {
    clearAllGeoSelections();
});

// =====================================================
// STEP 9: Programmatic Byside Functions
// =====================================================

// State for Programmatic Byside (only programmatic-specific data)
// NOTE: Website crawl data is now stored in global crawlState object
let programmaticState = {
    selected_new_cities: [],  // Cities selected for WordPress export (user can deselect)
    generated_meta_titles: [],  // AI-generated SEO meta titles (7 variants)
    generated_meta_descriptions: []  // AI-generated SEO meta descriptions (7 variants)
};

// Initialize Step 9 with data from crawlState (called when step is shown)
function initStep9FromCrawlState() {
    // DEBUG: Log crawlState at init
    console.log('=== initStep9FromCrawlState DEBUG ===');
    console.log('crawlState.website_url:', crawlState.website_url);
    console.log('crawlState.crawl_status:', crawlState.crawl_status);
    console.log('crawlState.urls_found:', crawlState.urls_found);
    console.log('crawlState.city_matches length:', crawlState.city_matches?.length);
    console.log('crawlState.existing_count:', crawlState.existing_count);
    console.log('crawlState.missing_count:', crawlState.missing_count);
    if (crawlState.city_matches?.length > 0) {
        console.log('First city_match:', JSON.stringify(crawlState.city_matches[0], null, 2));
    }
    console.log('=====================================');

    // Pre-populate URL field from crawlState (hidden input)
    if (crawlState.website_url) {
        $('#programmatic-website-url').val(crawlState.website_url);
    }

    // If crawl was already done, show URL count
    if (crawlState.crawl_status === 'success' && crawlState.urls_found > 0) {
        $('#sitemap-status').removeClass('hidden');
        $('#sitemap-urls-count').text(`${crawlState.urls_found} URLs fundet i sitemap`);

        // If city matches exist, populate them
        if (crawlState.city_matches.length > 0) {
            $('#city-page-status-section').removeClass('hidden');
            $('#existing-pages-count').text(crawlState.existing_count);
            $('#missing-pages-count').text(crawlState.missing_count);
            renderCityPageLists(crawlState.city_matches);
            updateCreditsCount();
            $('#city-page-results').removeClass('hidden');
        } else {
            // Only auto-check city pages if we have a service selected
            const serviceName = getServiceNameForProgrammatic();
            if (serviceName) {
                checkCityPages();
            }
            // Otherwise user will need to ensure service is selected first
        }
    }
}

// Crawl sitemap from customer website (can still be called manually, but reuses crawlState if available)
async function crawlSitemap() {
    const websiteUrl = $('#programmatic-website-url').val().trim();
    if (!websiteUrl) {
        alert('Indtast venligst en website URL');
        return;
    }

    // Check if we already have this URL crawled in crawlState
    if (crawlState.crawl_status === 'success' &&
        crawlState.website_url === websiteUrl &&
        crawlState.urls_found > 0) {
        // Reuse existing crawl data
        $('#sitemap-status').removeClass('hidden');
        $('#sitemap-loading').addClass('hidden');
        $('#sitemap-success').removeClass('hidden');
        $('#sitemap-urls-count').text(`${crawlState.urls_found} URLs fundet i sitemap (genbrugt)`);

        // Run city pages check
        await checkCityPages();
        return;
    }

    // Show loading state
    $('#sitemap-status').removeClass('hidden');
    $('#sitemap-loading').removeClass('hidden');
    $('#sitemap-success').addClass('hidden');
    $('#sitemap-error').addClass('hidden');
    $('#crawl-sitemap-btn').prop('disabled', true).addClass('opacity-50');

    try {
        const response = await $.ajax({
            url: '/ajax/crawl-sitemap/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({ website_url: websiteUrl })
        });

        $('#sitemap-loading').addClass('hidden');

        if (response.success) {
            // Update global crawlState (not programmaticState)
            crawlState.website_url = websiteUrl;
            crawlState.sitemap_urls = response.urls || [];
            crawlState.urls_found = response.urls_found || 0;
            crawlState.crawl_status = 'success';
            crawlState.crawl_timestamp = Date.now();

            $('#sitemap-success').removeClass('hidden');
            $('#sitemap-urls-count').text(`${response.urls_found} URLs fundet i sitemap`);

            // Save state
            debouncedSaveState();

            // Automatisk k√∏r checkCityPages efter succesfuld sitemap crawl
            await checkCityPages();
        } else {
            $('#sitemap-error').removeClass('hidden');
            $('#sitemap-error-message').text(response.error || 'Kunne ikke crawle sitemap');
        }
    } catch (error) {
        console.error('Sitemap crawl error:', error);
        $('#sitemap-loading').addClass('hidden');
        $('#sitemap-error').removeClass('hidden');
        $('#sitemap-error-message').text('Fejl ved crawling af sitemap');
    }

    $('#crawl-sitemap-btn').prop('disabled', false).removeClass('opacity-50');
}

// Check which city pages exist on the website
async function checkCityPages() {
    // Use crawlState URL instead of programmaticState
    const websiteUrl = crawlState.website_url || $('#programmatic-website-url').val().trim();
    const selectedCities = getSelectedCities();

    // DEBUG: Log request parameters
    console.log('=== checkCityPages REQUEST DEBUG ===');
    console.log('Website URL:', websiteUrl);
    console.log('Selected cities count:', selectedCities.length);
    console.log('Selected cities (first 10):', selectedCities.slice(0, 10));

    if (!websiteUrl) {
        alert('Crawl venligst sitemap f√∏rst');
        return;
    }

    if (selectedCities.length === 0) {
        alert('V√¶lg venligst mindst √©n by');
        return;
    }

    // Get the service name from campaign config
    const serviceName = getServiceNameForProgrammatic();
    console.log('Service name for matching:', serviceName);
    console.log('========================================');

    if (!serviceName) {
        alert('Ingen service valgt. G√• tilbage og v√¶lg en service.');
        return;
    }

    // Show loading
    $('#city-page-status-section').removeClass('hidden');
    $('#city-page-status-loading').removeClass('hidden');
    $('#city-page-results').addClass('hidden');

    try {
        const response = await $.ajax({
            url: '/ajax/match-city-pages/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                website_url: websiteUrl,
                service_name: serviceName,
                cities: selectedCities
            })
        });

        $('#city-page-status-loading').addClass('hidden');

        if (response.success) {
            // DEBUG: Log full API response
            console.log('=== checkCityPages API Response DEBUG ===');
            console.log('Full response:', response);
            console.log('response.results:', response.results);
            console.log('response.existing_count:', response.existing_count);
            console.log('response.missing_count:', response.missing_count);
            console.log('==========================================');

            programmaticState.city_matches = response.results || [];
            programmaticState.existing_count = response.existing_count || 0;
            programmaticState.missing_count = response.missing_count || 0;

            // Update counters
            $('#existing-pages-count').text(programmaticState.existing_count);
            $('#missing-pages-count').text(programmaticState.missing_count);

            // Render the two lists (existing and missing)
            renderCityPageLists(programmaticState.city_matches);

            // Update credits count
            updateCreditsCount();

            $('#city-page-results').removeClass('hidden');
        } else {
            alert('Fejl ved tjek af bysider: ' + (response.error || 'Ukendt fejl'));
            $('#city-page-status-section').addClass('hidden');
        }
    } catch (error) {
        console.error('City page check error:', error);
        alert('Fejl ved tjek af bysider');
        $('#city-page-status-loading').addClass('hidden');
        $('#city-page-status-section').addClass('hidden');
    }
}

// Render the city page lists (existing and missing)
function renderCityPageLists(results) {
    // DEBUG: Log what we receive
    console.log('=== renderCityPageLists DEBUG ===');
    console.log('Total results:', results.length);
    console.log('Sample results (first 5):', results.slice(0, 5));
    console.log('Results with existing status:', results.filter(r => r.status === 'existing').length);
    console.log('Results with missing status:', results.filter(r => r.status === 'missing').length);
    console.log('Results with other/no status:', results.filter(r => r.status !== 'existing' && r.status !== 'missing').length);
    if (results.length > 0) {
        console.log('First result full object:', JSON.stringify(results[0], null, 2));
    }
    console.log('=================================');

    const existingList = $('#existing-pages-list');
    const missingList = $('#missing-pages-list');
    existingList.empty();
    missingList.empty();

    // Split results into existing and missing
    const existingPages = results.filter(r => r.status === 'existing');
    const missingPages = results.filter(r => r.status === 'missing');

    // Render existing pages (with links, no checkboxes)
    if (existingPages.length === 0) {
        $('#no-existing-pages').removeClass('hidden');
    } else {
        $('#no-existing-pages').addClass('hidden');
        existingPages.forEach(result => {
            const isPrimary = result.is_primary !== false;  // Default to true if not specified
            const item = `
                <div class="flex items-center justify-between py-2 px-3 bg-white rounded-lg border border-green-100 city-page-item" data-is-primary="${isPrimary}" data-has-existing="true">
                    <span class="text-sm font-medium text-gray-900">${escapeHtml(result.city)}</span>
                    <a href="${escapeHtml(result.existing_url)}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        √Öbn
                    </a>
                </div>
            `;
            existingList.append(item);
        });
    }

    // Render missing pages (with checkboxes, all checked by default)
    if (missingPages.length === 0) {
        $('#no-missing-pages').removeClass('hidden');
    } else {
        $('#no-missing-pages').addClass('hidden');
        missingPages.forEach((result, index) => {
            const isPrimary = result.is_primary !== false;  // Default to true if not specified
            const item = `
                <div class="flex items-center py-2 px-3 bg-white rounded-lg border border-yellow-100 city-page-item" data-is-primary="${isPrimary}" data-has-existing="false">
                    <input type="checkbox"
                           class="missing-page-checkbox w-4 h-4 text-yellow-600 rounded border-gray-300 focus:ring-yellow-500 mr-3"
                           data-city="${escapeHtml(result.city)}"
                           id="missing-page-${index}"
                           checked
                           onchange="updateCreditsCount()">
                    <label for="missing-page-${index}" class="text-sm font-medium text-gray-900 cursor-pointer flex-1">
                        ${escapeHtml(result.city)}
                    </label>
                    <span class="text-xs text-yellow-600 font-medium">+1 credit</span>
                </div>
            `;
            missingList.append(item);
        });
    }

    // Render city coverage grid with dots
    renderCityCoverageGrid(results);

    // Apply filter state (default: hide secondary cities without byside)
    setTimeout(filterSecondaryCities, 50);
}

// Render the city coverage grid with green/gray dots
function renderCityCoverageGrid(results) {
    const coverageGrid = $('#city-coverage-grid');
    coverageGrid.empty();

    // Results now include both primary and secondary cities from backend
    if (!results || results.length === 0) {
        coverageGrid.html('<p class="text-gray-500 text-sm italic col-span-full">Ingen byer valgt</p>');
        return;
    }

    // Sort results alphabetically by city name
    const sortedResults = [...results].sort((a, b) => a.city.localeCompare(b.city, 'da'));

    // Render each city with appropriate dot color and is_primary flag
    sortedResults.forEach(result => {
        const hasExisting = result.status === 'existing';
        const isPrimary = result.is_primary !== false;  // Default to true if not specified
        const dotColor = hasExisting ? 'bg-green-500' : 'bg-gray-300';

        const item = `
            <span class="flex items-center gap-1 city-coverage-item" data-city="${escapeHtml(result.city)}" data-is-primary="${isPrimary}" data-has-existing="${hasExisting}">
                <span class="byside-indicator w-2 h-2 rounded-full ${dotColor} flex-shrink-0"></span>
                <span class="city-name truncate" title="${escapeHtml(result.city)}">${escapeHtml(result.city)}</span>
            </span>
        `;
        coverageGrid.append(item);
    });
}

// Update credits count based on selected missing pages
function updateCreditsCount() {
    const selectedCount = $('.missing-page-checkbox:checked').length;
    $('#credits-count').text(selectedCount);

    // Store selected cities for export
    programmaticState.selected_new_cities = [];
    $('.missing-page-checkbox:checked').each(function() {
        programmaticState.selected_new_cities.push($(this).data('city'));
    });
}

// Select all missing pages
function selectAllMissingPages() {
    $('.missing-page-checkbox').prop('checked', true);
    updateCreditsCount();
}

// Deselect all missing pages
function deselectAllMissingPages() {
    $('.missing-page-checkbox').prop('checked', false);
    updateCreditsCount();
}

// Filter secondary cities in Programmatic Byside section
// Logic: Show if isPrimary OR hasExisting OR toggleOn
function filterSecondaryCities() {
    const showSecondary = document.getElementById('show-secondary-cities');
    if (!showSecondary) return;

    const showSecondaryChecked = showSecondary.checked;

    // Update toggle visuals
    const track = document.getElementById('cb-toggle-track');
    const knob = document.getElementById('cb-toggle-knob');
    if (track && knob) {
        if (showSecondaryChecked) {
            track.style.background = 'linear-gradient(to right, #a855f7, #ec4899)';
            knob.style.transform = 'translateX(20px)';
        } else {
            track.style.background = '#d1d5db';
            knob.style.transform = 'translateX(0)';
        }
    }

    // Filter items in existing-pages-list
    document.querySelectorAll('#existing-pages-list .city-page-item').forEach(item => {
        const isPrimary = item.dataset.isPrimary === 'true';
        // Existing pages: show if primary OR toggle ON (secondary with existing always shown)
        // Since these have existing pages, we always show them (secondary with green dot)
        item.style.display = '';  // Always show existing pages
    });

    // Filter items in missing-pages-list
    document.querySelectorAll('#missing-pages-list .city-page-item').forEach(item => {
        const isPrimary = item.dataset.isPrimary === 'true';
        // Missing pages: show if primary OR toggle ON
        if (isPrimary || showSecondaryChecked) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    // Filter city-coverage-grid items
    document.querySelectorAll('#city-coverage-grid .city-coverage-item').forEach(item => {
        const isPrimary = item.dataset.isPrimary === 'true';
        const hasExisting = item.dataset.hasExisting === 'true';

        // Show if: isPrimary OR hasExisting (green dot) OR toggleOn
        if (isPrimary || hasExisting || showSecondaryChecked) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });

    updateSecondaryCityCount();
}

// Backup toggle handler for label click
function toggleSecondaryCities(event) {
    // Don't double-toggle if checkbox was clicked directly
    if (event.target.tagName === 'INPUT') return;

    const checkbox = document.getElementById('show-secondary-cities');
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        filterSecondaryCities();
    }
}

// Update displayed count next to toggle
function updateSecondaryCityCount() {
    const total = document.querySelectorAll('#city-coverage-grid .city-coverage-item').length;
    const secondaryWithoutExisting = document.querySelectorAll('#city-coverage-grid .city-coverage-item[data-is-primary="false"][data-has-existing="false"]').length;
    const countSpan = document.getElementById('secondary-city-count');
    const toggle = document.getElementById('show-secondary-cities');

    if (countSpan && secondaryWithoutExisting > 0) {
        if (toggle && toggle.checked) {
            countSpan.textContent = `(${secondaryWithoutExisting} sekund√¶re vises)`;
            countSpan.className = 'text-purple-600 tabular-nums font-medium';
        } else {
            countSpan.textContent = `(${secondaryWithoutExisting} skjulte)`;
            countSpan.className = 'text-gray-400 tabular-nums';
        }
    } else if (countSpan) {
        countSpan.textContent = '';
    }
}

// Generate AI Meta Tags (7 titles + 7 descriptions)
async function generateAIMetaTags() {
    const serviceName = getServiceNameForProgrammatic();
    const serviceId = getServiceIdForProgrammatic();
    const usps = getActiveUsps();

    // Debug: log what's being sent to the backend
    console.log('Generating meta tags with:', { service_id: serviceId, service_name: serviceName, usps_count: usps.length });

    if (!serviceName) {
        alert('V√¶lg venligst en service f√∏rst');
        return;
    }

    // Show loading with Roberto
    $('#generate-meta-tags-btn').prop('disabled', true).addClass('opacity-50');
    $('#meta-tags-preview').addClass('hidden');

    // Show Roberto loading animation
    showRobertoLoading('meta_tags');

    try {
        const response = await $.ajax({
            url: '/ajax/generate-programmatic-descriptions/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                service_name: serviceName,
                service_id: serviceId,  // For few-shot examples from ServiceMetaExample
                usps: usps,
                generate_meta_tags: true
            })
        });

        if (response.success) {
            programmaticState.generated_meta_titles = response.meta_titles || [];
            programmaticState.generated_meta_descriptions = response.meta_descriptions || [];

            // Render the generated meta tags
            renderGeneratedMetaTags();

            showToast(`Genereret ${response.meta_titles.length} meta titler og ${response.meta_descriptions.length} meta beskrivelser`, 'success');
        } else {
            alert('Fejl ved generering: ' + (response.error || 'Ukendt fejl'));
        }
    } catch (error) {
        console.error('Meta tag generation error:', error);
        alert('Fejl ved generering af meta tags');
    }

    $('#generate-meta-tags-btn').prop('disabled', false).removeClass('opacity-50');
    hideRobertoLoading();
}

// =================================================================
// PIXEL MEASUREMENT UTILITY (Google SERP uses pixels, not chars)
// Title: Arial 20px (matching Storybase CTR tool), Description: Arial 14px
// =================================================================
const SERP_FONTS = {
    title: { font: 'Arial', size: 20, maxPixels: 600 },
    description: { font: 'Arial', size: 14, maxPixels: 920 }
};

function measurePixelWidth(text, fontSize = 18, fontFamily = 'Arial') {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = `${fontSize}px ${fontFamily}`;
    return Math.round(ctx.measureText(text).width);
}

function getTitlePixelInfo(text) {
    const pixels = measurePixelWidth(text, SERP_FONTS.title.size, SERP_FONTS.title.font);
    const max = SERP_FONTS.title.maxPixels;
    return { pixels, max, isOver: pixels > max };
}

function getDescriptionPixelInfo(text) {
    const pixels = measurePixelWidth(text, SERP_FONTS.description.size, SERP_FONTS.description.font);
    const max = SERP_FONTS.description.maxPixels;
    return { pixels, max, isOver: pixels > max };
}

// Render generated meta tags in the UI
function renderGeneratedMetaTags() {
    const titlesList = $('#meta-titles-list');
    const descsList = $('#meta-descriptions-list');
    titlesList.empty();
    descsList.empty();

    // Render meta titles - samme design som panel descriptions
    programmaticState.generated_meta_titles.forEach((title, index) => {
        const charCount = title.length;
        const pixelInfo = getTitlePixelInfo(title);
        // Color: green if optimal chars AND under pixel limit, yellow if short, red if over
        const isOver = pixelInfo.isOver || charCount > 60;
        const isOptimal = !isOver && charCount >= 50 && charCount <= 60;
        const charClass = isOver ? 'text-red-500' : (isOptimal ? 'text-green-500' : 'text-yellow-500');
        const item = `
            <div class="flex items-start justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm"
                 style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                <input type="text" class="meta-title-input flex-1 px-3 py-1.5 border border-transparent rounded-lg
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-transparent
                       hover:bg-white transition-all text-sm"
                       data-index="${index}" maxlength="100" value="${escapeHtml(title)}">
                <div class="flex items-center space-x-2 ml-2 mt-1">
                    <span class="text-xs ${charClass} meta-title-char-count whitespace-nowrap">${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px</span>
                    <button type="button" class="remove-meta-title-btn w-7 h-7 rounded-lg flex items-center justify-center
                            text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
                </div>
            </div>
        `;
        titlesList.append(item);
    });

    // Render meta descriptions - samme design som panel descriptions
    programmaticState.generated_meta_descriptions.forEach((desc, index) => {
        const charCount = desc.length;
        const pixelInfo = getDescriptionPixelInfo(desc);
        // Color: green if optimal chars AND under pixel limit, yellow if short, red if over
        const isOver = pixelInfo.isOver || charCount > 160;
        const isOptimal = !isOver && charCount >= 120 && charCount <= 160;
        const charClass = isOver ? 'text-red-500' : (isOptimal ? 'text-green-500' : 'text-yellow-500');
        const item = `
            <div class="flex items-start justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm"
                 style="background: linear-gradient(135deg, #f5f3ff, #ede9fe);">
                <textarea class="meta-desc-input flex-1 px-3 py-1.5 border border-transparent rounded-lg
                          focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-gray-900 bg-transparent
                          hover:bg-white transition-all resize-none overflow-hidden text-sm"
                          data-index="${index}" maxlength="250" rows="2" style="min-height: 48px;">${escapeHtml(desc)}</textarea>
                <div class="flex items-center space-x-2 ml-2 mt-1">
                    <span class="text-xs ${charClass} meta-desc-char-count whitespace-nowrap">${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px</span>
                    <button type="button" class="remove-meta-desc-btn w-7 h-7 rounded-lg flex items-center justify-center
                            text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
                </div>
            </div>
        `;
        descsList.append(item);
    });

    // Update counters
    $('#meta-titles-count').text(programmaticState.generated_meta_titles.length);
    $('#meta-descriptions-count').text(programmaticState.generated_meta_descriptions.length);

    // Show preview
    $('#meta-tags-preview').removeClass('hidden');
}

// === Meta Titel Input Handler (live update) ===
$(document).on('input', '.meta-title-input', function() {
    const index = $(this).data('index');
    const value = $(this).val();
    programmaticState.generated_meta_titles[index] = value;

    // Opdater tegnt√¶ller med pixel-visning
    const charCount = value.length;
    const pixelInfo = getTitlePixelInfo(value);
    const $counter = $(this).closest('div').find('.meta-title-char-count');
    $counter.text(`${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px`);
    $counter.removeClass('text-gray-400 text-yellow-500 text-green-500 text-red-500');

    const isOver = pixelInfo.isOver || charCount > 60;
    const isOptimal = !isOver && charCount >= 50 && charCount <= 60;
    if (isOver) {
        $counter.addClass('text-red-500');
    } else if (isOptimal) {
        $counter.addClass('text-green-500');
    } else {
        $counter.addClass('text-yellow-500');
    }
});

// === Meta Beskrivelse Input Handler ===
$(document).on('input', '.meta-desc-input', function() {
    const index = $(this).data('index');
    const value = $(this).val();
    programmaticState.generated_meta_descriptions[index] = value;

    // Auto-resize textarea
    this.style.height = 'auto';
    this.style.height = Math.max(48, this.scrollHeight) + 'px';

    // Opdater tegnt√¶ller med pixel-visning
    const charCount = value.length;
    const pixelInfo = getDescriptionPixelInfo(value);
    const $counter = $(this).closest('div').find('.meta-desc-char-count');
    $counter.text(`${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px`);
    $counter.removeClass('text-gray-400 text-yellow-500 text-green-500 text-red-500');

    const isOver = pixelInfo.isOver || charCount > 160;
    const isOptimal = !isOver && charCount >= 120 && charCount <= 160;
    if (isOver) {
        $counter.addClass('text-red-500');
    } else if (isOptimal) {
        $counter.addClass('text-green-500');
    } else {
        $counter.addClass('text-yellow-500');
    }
});

// === Fjern Meta Titel ===
$(document).on('click', '.remove-meta-title-btn', function() {
    if (programmaticState.generated_meta_titles.length > 1) {
        const index = $(this).data('index');
        programmaticState.generated_meta_titles.splice(index, 1);
        renderGeneratedMetaTags();
    }
});

// === Fjern Meta Beskrivelse ===
$(document).on('click', '.remove-meta-desc-btn', function() {
    if (programmaticState.generated_meta_descriptions.length > 1) {
        const index = $(this).data('index');
        programmaticState.generated_meta_descriptions.splice(index, 1);
        renderGeneratedMetaTags();
    }
});

// === Tilf√∏j Meta Titel ===
$(document).on('click', '.add-meta-title-btn', function() {
    if (programmaticState.generated_meta_titles.length < 10) {
        programmaticState.generated_meta_titles.push('{SERVICE} i {BYNAVN} - Ny titel');
        renderGeneratedMetaTags();
    }
});

// === Tilf√∏j Meta Beskrivelse ===
$(document).on('click', '.add-meta-desc-btn', function() {
    if (programmaticState.generated_meta_descriptions.length < 10) {
        programmaticState.generated_meta_descriptions.push('Ny meta beskrivelse for {SERVICE} i {BYNAVN}. Kontakt os for mere information.');
        renderGeneratedMetaTags();
    }
});

// Default meta title templates (fallback if AI not used)
// KRAV: Meta titler skal v√¶re mellem 50-60 tegn
function getDefaultMetaTitles(serviceName, usps) {
    const usp1 = usps[0] ? usps[0].substring(0, 15) : 'Kvalitet';
    // Templates designet til at ramme 50-60 tegn med typiske service navne
    return [
        `${serviceName} i {BYNAVN} | Professionel Service & R√•dgivning`,
        `{BYNAVN} ${serviceName} | Hurtig Service & Gratis Tilbud`,
        `Autoriseret ${serviceName} i {BYNAVN} | Ring for Tilbud`,
        `${serviceName} {BYNAVN} - ${usp1} & Professionel Service`,
        `Din Lokale ${serviceName} i {BYNAVN} | Gratis R√•dgivning`,
        `${serviceName} Ekspert i {BYNAVN} | Certificeret & P√•lidelig`,
        `Professionel ${serviceName} i {BYNAVN} | Hurtig Respons`
    ];
}

// Default meta description templates (fallback if AI not used)
// KRAV: Meta beskrivelser skal v√¶re 150-160 tegn med vigtigste budskab i f√∏rste 120 tegn
function getDefaultMetaDescriptions(serviceName, usps) {
    const usp1 = usps[0] || 'Professionel service med garanti';
    const usp2 = usps[1] || 'Hurtig og p√•lidelig service';
    // Templates designet til 150-160 tegn - vigtigste info f√∏r 120-tegn gr√¶nsen
    return [
        `Professionel ${serviceName} i {BYNAVN}. ${usp1}. Gratis tilbud inden for 24 timer. Ring nu og f√• personlig r√•dgivning fra vores eksperter.`,
        `${serviceName} eksperter i {BYNAVN} med mange √•rs erfaring. ${usp1}. Kontakt os i dag for et uforpligtende tilbud og gratis r√•dgivning.`,
        `Autoriseret ${serviceName} firma i {BYNAVN}. ${usp1}. Vi garanterer kvalitet og hurtig service. Book dit gratis tilbud online nu.`,
        `Leder du efter ${serviceName} i {BYNAVN}? ${usp1}. ${usp2}. F√• et gratis tilbud inden for 2 timer. Ring eller book online i dag.`,
        `{BYNAVN}s foretrukne ${serviceName}. ${usp1}. Over 1000 tilfredse kunder. Ring nu for gratis r√•dgivning og uforpligtende tilbud.`,
        `${serviceName} i {BYNAVN} - ${usp1}. ${usp2}. Vi er klar til at hj√¶lpe dig. Kontakt os for et gratis og uforpligtende tilbud.`,
        `Din lokale ${serviceName} i {BYNAVN}. ${usp1}. Hurtig respons og fair priser. Book dit gratis tilbud online eller ring direkte til os.`
    ];
}

// ============================================================================
// SEO BUILDER (Step 7) - Sidebar navigation med services
// ============================================================================

// Main orchestrator for SEO Builder - PAGE-BASED structure
async function renderSeoBuilder() {
    console.log('renderSeoBuilder() called - PAGE-BASED mode');

    // Get services that are enabled for SEO (from Step 2)
    const seoServiceIds = getServicesForPurpose('seo');
    console.log('SEO service IDs:', seoServiceIds);

    // Also get AI-suggested/custom services that have SEO enabled
    const customServices = getCustomServicesForPurpose('seo');
    console.log('Custom services for SEO:', customServices.length);

    // Check if we have existing SEO pages from restored data
    const existingSeoPages = Object.keys(campaignConfig.seo_pages || {}).filter(key => key.startsWith('/'));
    const hasExistingPages = existingSeoPages.length > 0;
    console.log('Existing SEO pages:', existingSeoPages.length);

    if (seoServiceIds.length === 0 && customServices.length === 0 && !hasExistingPages) {
        $('#seo-builder-container').html(`
            <div class="text-center py-12 text-gray-500">
                <p class="text-lg mb-2">Ingen services valgt til SEO</p>
                <p class="text-sm">G√• tilbage til Step 2 og v√¶lg services med SEO form√•l</p>
            </div>
        `);
        return;
    }

    // If we have existing pages but no current services, build from existing pages
    if (seoServiceIds.length === 0 && customServices.length === 0 && hasExistingPages) {
        console.log('Building SEO sidebar from existing restored pages');

        // Build allSeoPageKeys from existing seo_pages
        allSeoPageKeys = [];

        existingSeoPages.sort((a, b) => {
            if (a === '/') return -1;
            if (b === '/') return 1;
            return a.localeCompare(b);
        }).forEach(path => {
            const pageData = campaignConfig.seo_pages[path];
            allSeoPageKeys.push({
                path: path,
                page_title: pageData.page_title || (path === '/' ? 'Forside' : path.replace(/\//g, ' ').trim()),
                services: (pageData.services || []).map(name => ({ name, color: '#8B5CF6', isCustom: false })),
                color: '#8B5CF6'
            });
        });

        console.log('[SEO Builder] Restored', allSeoPageKeys.length, 'pages from saved data');

        // Render sidebar
        renderSeoSidebar();

        // Set first page as active
        if (!activeSeoPagePath && allSeoPageKeys.length > 0) {
            setActiveSeoPage(allSeoPageKeys[0].path);
        } else if (activeSeoPagePath) {
            const pageExists = allSeoPageKeys.some(p => p.path === activeSeoPagePath);
            if (pageExists) {
                renderActiveSeoContent(activeSeoPagePath);
            } else if (allSeoPageKeys.length > 0) {
                setActiveSeoPage(allSeoPageKeys[0].path);
            }
        }

        // Setup event handlers
        setupSeoEventHandlers();
        return;
    }

    // Collect all services with their source paths
    const allServices = [];

    // 1. Collect database services
    for (const serviceId of seoServiceIds) {
        let serviceName = '';
        let serviceColor = '#8B5CF6';

        if (serverData.services_by_id && serverData.services_by_id[serviceId]) {
            serviceName = serverData.services_by_id[serviceId].name;
            serviceColor = serverData.services_by_id[serviceId].color || '#8B5CF6';
        } else {
            const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
            const h4 = serviceCard.find('h4').first();
            if (h4.length) {
                serviceName = h4.clone().children().remove().end().text().trim() || h4.text().trim();
            }
            if (!serviceName) {
                serviceName = serviceCard.find('.service-name').first().text().trim() || `Service ${serviceId}`;
            }
        }

        // Try to find a matching page for DB services
        const matchedPage = findBestMatchingPage(serviceName, false); // Don't mark as used yet
        const sourcePath = matchedPage ? matchedPage.path : '/';

        allServices.push({
            id: serviceId,
            name: serviceName,
            color: serviceColor,
            isCustom: false,
            source_path: sourcePath
        });
    }

    // 2. Collect AI-suggested/custom services
    customServices.forEach((cs) => {
        const originalIndex = cs.customIndex !== undefined ? cs.customIndex : campaignConfig.custom_services.indexOf(cs);
        const customId = `custom_${originalIndex}`;
        const serviceName = cs.name || cs;

        // Determine source_path
        let sourcePath = cs.source_path;
        if (!sourcePath || sourcePath === '' || sourcePath === '/') {
            // Try to find a matching page
            const matchedPage = findBestMatchingPage(serviceName, false);
            sourcePath = matchedPage ? matchedPage.path : '/';
        }

        allServices.push({
            id: customId,
            name: serviceName,
            color: '#EC4899',
            isCustom: true,
            confidence: cs.confidence,
            source_path: sourcePath
        });
    });

    // 3. GROUP SERVICES BY PAGE (source_path)
    const pageGroups = {};

    allServices.forEach(service => {
        const path = service.source_path || '/';
        if (!pageGroups[path]) {
            pageGroups[path] = {
                path: path,
                services: [],
                page_title: path === '/' ? 'Forside' : getPageTitle(path)
            };
        }
        pageGroups[path].services.push({
            id: service.id,
            name: service.name,
            color: service.color,
            isCustom: service.isCustom,
            confidence: service.confidence
        });
    });

    // 4. Build allSeoPageKeys from grouped pages
    allSeoPageKeys = [];

    // Sort pages: homepage first, then alphabetically by path
    const sortedPaths = Object.keys(pageGroups).sort((a, b) => {
        if (a === '/') return -1;
        if (b === '/') return 1;
        return a.localeCompare(b);
    });

    sortedPaths.forEach(path => {
        const group = pageGroups[path];
        // Use first service's color as page color, or default
        const pageColor = group.services[0]?.color || '#8B5CF6';

        allSeoPageKeys.push({
            path: group.path,
            page_title: group.page_title,
            services: group.services,
            color: pageColor
        });
    });

    console.log('[SEO Builder] Created', allSeoPageKeys.length, 'page entries from', allServices.length, 'services');

    // 5. Initialize campaignConfig.seo_pages for each PAGE (keyed by path)
    // Migrate old service-keyed data if needed
    const oldSeoPages = { ...campaignConfig.seo_pages };

    allSeoPageKeys.forEach(page => {
        if (!campaignConfig.seo_pages[page.path]) {
            // Try to migrate data from old service-keyed format
            const serviceOnThisPage = page.services[0];
            const oldData = serviceOnThisPage ? oldSeoPages[serviceOnThisPage.id] : null;

            // Get scraped page data
            const scrapedData = getScrapedPageData(page.path);

            campaignConfig.seo_pages[page.path] = {
                page_title: page.page_title,
                services: page.services.map(s => s.name),
                meta_title: oldData?.meta_title || scrapedData?.meta_title || '',
                meta_description: oldData?.meta_description || scrapedData?.meta_description || '',
                seo_keywords: oldData?.seo_keywords || [],
                keywords_loaded: oldData?.keywords_loaded || false,
                sections: oldData?.sections || null
            };
        } else {
            // Update services list in existing entry
            campaignConfig.seo_pages[page.path].services = page.services.map(s => s.name);
        }
    });

    // 6. Clean up old service-keyed entries (keep only path-keyed)
    Object.keys(campaignConfig.seo_pages).forEach(key => {
        // If key is not a path (doesn't start with / and isn't a valid path), remove it
        const isPath = key.startsWith('/') || key === '/';
        const isValidPage = allSeoPageKeys.some(p => p.path === key);
        if (!isPath || !isValidPage) {
            // Keep old format data temporarily for migration, but don't render it
            // Only delete if it's definitely old format (numeric or custom_X)
            if (/^\d+$/.test(key) || key.startsWith('custom_')) {
                delete campaignConfig.seo_pages[key];
            }
        }
    });

    // Render sidebar
    renderSeoSidebar();

    // Set first page as active if none selected
    if (!activeSeoPagePath && allSeoPageKeys.length > 0) {
        setActiveSeoPage(allSeoPageKeys[0].path);
    } else if (activeSeoPagePath) {
        // Verify active page still exists
        const pageExists = allSeoPageKeys.some(p => p.path === activeSeoPagePath);
        if (pageExists) {
            renderActiveSeoContent(activeSeoPagePath);
        } else if (allSeoPageKeys.length > 0) {
            setActiveSeoPage(allSeoPageKeys[0].path);
        }
    }

    // Setup event handlers
    setupSeoEventHandlers();
}

// Helper: Get page title from path or scraped data
function getPageTitle(path) {
    // Try to get from scraped pages
    const scrapedData = getScrapedPageData(path);
    if (scrapedData && scrapedData.meta_title) {
        // Extract meaningful title from meta_title
        let title = scrapedData.meta_title;
        // Remove common suffixes like "| Company Name"
        title = title.split('|')[0].split('-')[0].trim();
        if (title.length > 3) return title;
    }

    // Fallback: derive from path
    // /privatflytning/ -> "Privatflytning"
    const cleanPath = path.replace(/^\/|\/$/g, '');
    if (!cleanPath) return 'Forside';

    return cleanPath
        .split(/[-_]/)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

// Render SEO sidebar navigation - PAGE-BASED
function renderSeoSidebar() {
    const sidebar = $('#seo-nav-list');
    sidebar.empty();

    allSeoPageKeys.forEach(page => {
        const seoPage = campaignConfig.seo_pages[page.path] || {};
        const isComplete = seoPage.meta_title && seoPage.meta_description;
        const isActive = activeSeoPagePath === page.path;

        // Icon based on page type
        const pageIcon = page.path === '/' ? 'üè†' : 'üìÑ';

        // Services list (truncated if many)
        const serviceNames = page.services.map(s => s.name);
        const servicesDisplay = serviceNames.length > 3
            ? serviceNames.slice(0, 3).join(', ') + ` +${serviceNames.length - 3}`
            : serviceNames.join(', ');

        // AI badge if any service is AI-suggested
        const hasAiService = page.services.some(s => s.isCustom);
        const aiBadge = hasAiService
            ? '<span class="ml-2 px-1.5 py-0.5 bg-pink-100 text-pink-700 text-xs rounded font-medium">AI</span>'
            : '';

        const html = `
            <div class="seo-nav-item selection-card cursor-pointer p-4 rounded-xl border-2 transition-all duration-200
                        ${isActive ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300 hover:bg-gray-50'}"
                 data-page-path="${escapeHtml(page.path)}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-lg"
                             style="background-color: ${page.color}">
                            ${pageIcon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 truncate">${escapeHtml(page.page_title)}${aiBadge}</div>
                            <div class="text-xs text-gray-400 truncate" title="${escapeHtml(page.path)}">${escapeHtml(page.path)}</div>
                            <div class="text-xs text-gray-500 truncate mt-0.5" title="${escapeHtml(serviceNames.join(', '))}">
                                ${page.services.length} service${page.services.length !== 1 ? 's' : ''}: ${escapeHtml(servicesDisplay)}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center ml-2">
                        ${isComplete ?
                            '<span class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-sm">‚úì</span>' :
                            '<span class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-sm">‚óã</span>'
                        }
                    </div>
                </div>
            </div>
        `;
        sidebar.append(html);
    });
}

// Set active SEO page
function setActiveSeoPage(pagePath) {
    activeSeoPagePath = pagePath;

    // Update sidebar highlight
    $('.seo-nav-item').removeClass('border-purple-500 bg-purple-50')
                      .addClass('border-gray-200');
    $(`.seo-nav-item[data-page-path="${CSS.escape(pagePath)}"]`)
        .removeClass('border-gray-200')
        .addClass('border-purple-500 bg-purple-50');

    // Render content for this page
    renderActiveSeoContent(pagePath);
}

// Legacy function for backwards compatibility
function setActiveSeoService(serviceId) {
    // Find the page that contains this service
    const page = allSeoPageKeys.find(p => p.services.some(s => s.id === serviceId));
    if (page) {
        setActiveSeoPage(page.path);
    }
}

// Count words in text
function countWords(text) {
    if (!text || typeof text !== 'string') return 0;
    // Split by whitespace and filter out empty strings
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    return words.length;
}

// ============================================
// REVIEW SECTION FUNCTIONS
// ============================================

// Render star rating display
function renderStars(rating) {
    const fullStars = Math.floor(rating || 0);
    const halfStar = (rating || 0) % 1 >= 0.5;
    let stars = '';
    for (let i = 0; i < 5; i++) {
        if (i < fullStars) {
            stars += '<span class="text-yellow-400 text-lg">‚òÖ</span>';
        } else if (i === fullStars && halfStar) {
            stars += '<span class="text-yellow-400 text-lg">‚òÖ</span>';
        } else {
            stars += '<span class="text-gray-300 text-lg">‚òÜ</span>';
        }
    }
    return stars;
}

// Render a single review card (editable)
function renderReviewCard(serviceId, sectionIndex, review, reviewIndex) {
    return `
        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100 review-card"
             data-review-index="${reviewIndex}">
            <div class="flex items-center justify-between mb-2">
                <input type="text"
                       class="review-author font-medium text-gray-900 bg-transparent border-0 p-0 w-24 focus:ring-0 focus:outline-none"
                       value="${escapeHtml(review.author || '')}"
                       placeholder="Navn"
                       data-service-id="${serviceId}"
                       data-section-index="${sectionIndex}"
                       data-review-index="${reviewIndex}">
                <select class="review-platform text-xs text-gray-500 bg-transparent border-0 p-0 focus:ring-0"
                        data-service-id="${serviceId}"
                        data-section-index="${sectionIndex}"
                        data-review-index="${reviewIndex}">
                    <option value="Trustpilot" ${review.platform === 'Trustpilot' ? 'selected' : ''}>Trustpilot</option>
                    <option value="Google" ${review.platform === 'Google' ? 'selected' : ''}>Google</option>
                    <option value="Facebook" ${review.platform === 'Facebook' ? 'selected' : ''}>Facebook</option>
                    <option value="Anmeldh√•ndv√¶rker" ${review.platform === 'Anmeldh√•ndv√¶rker' ? 'selected' : ''}>Anmeldh√•ndv√¶rker</option>
                </select>
            </div>
            <div class="flex items-center mb-2 space-x-1">
                ${[1,2,3,4,5].map(star => `
                    <button type="button"
                            onclick="setReviewRating('${serviceId}', ${sectionIndex}, ${reviewIndex}, ${star})"
                            class="review-star text-lg ${star <= (review.rating || 5) ? 'text-yellow-400' : 'text-gray-300'} hover:text-yellow-500 transition-colors">
                        ‚òÖ
                    </button>
                `).join('')}
            </div>
            <textarea class="review-text w-full text-sm text-gray-600 border border-gray-200 rounded p-2 resize-none focus:ring-1 focus:ring-purple-500"
                      rows="3"
                      data-service-id="${serviceId}"
                      data-section-index="${sectionIndex}"
                      data-review-index="${reviewIndex}"
                      placeholder="Anmeldelsestekst...">${escapeHtml(review.text || '')}</textarea>
            <button type="button"
                    onclick="removeReview('${serviceId}', ${sectionIndex}, ${reviewIndex})"
                    class="mt-2 text-xs text-red-400 hover:text-red-600">
                Fjern anmeldelse
            </button>
        </div>
    `;
}

// Render review section (with carousel if > 3 reviews)
function renderReviewSection(serviceId, section, index) {
    const reviews = section.reviews || [];
    const hasCarousel = reviews.length > 3;

    // Del reviews op i grupper af 3 for karrusel
    const pages = [];
    for (let i = 0; i < reviews.length; i += 3) {
        pages.push(reviews.slice(i, Math.min(i + 3, reviews.length)));
    }

    const reviewCardsHtml = hasCarousel ? `
        <!-- Karrusel container -->
        <div class="review-carousel relative" data-page="0" data-service-id="${serviceId}" data-section-index="${index}">
            <!-- Navigation pile -->
            <button type="button" onclick="carouselPrev('${serviceId}', ${index})"
                    class="carousel-prev absolute left-0 top-1/2 -translate-y-1/2 z-10 w-8 h-8 bg-white shadow-md rounded-full flex items-center justify-center hover:bg-gray-50 text-gray-600">
                ‚óÄ
            </button>

            <!-- Review pages -->
            <div class="carousel-pages mx-10">
                ${pages.map((pageReviews, pageIndex) => `
                    <div class="carousel-page ${pageIndex === 0 ? '' : 'hidden'}" data-page-index="${pageIndex}">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${pageReviews.map((review, i) => {
                                const globalIndex = pageIndex * 3 + i;
                                return renderReviewCard(serviceId, index, review, globalIndex);
                            }).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>

            <button type="button" onclick="carouselNext('${serviceId}', ${index})"
                    class="carousel-next absolute right-0 top-1/2 -translate-y-1/2 z-10 w-8 h-8 bg-white shadow-md rounded-full flex items-center justify-center hover:bg-gray-50 text-gray-600">
                ‚ñ∂
            </button>

            <!-- Dots navigation -->
            <div class="flex justify-center mt-4 space-x-2">
                ${pages.map((_, i) => `
                    <button type="button" onclick="carouselGoTo('${serviceId}', ${index}, ${i})"
                            class="carousel-dot w-2.5 h-2.5 rounded-full transition-colors ${i === 0 ? 'bg-purple-600' : 'bg-gray-300'}">
                    </button>
                `).join('')}
            </div>
        </div>
    ` : `
        <!-- Standard grid for 3 eller f√¶rre -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${reviews.map((review, i) => renderReviewCard(serviceId, index, review, i)).join('')}
        </div>
    `;

    return `
        <div class="seo-section bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200"
             data-section-index="${index}" data-section-type="reviews">
            <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-medium text-purple-600 uppercase flex items-center">
                    <span class="mr-2">‚≠ê</span> Anmeldelser ${hasCarousel ? `(${reviews.length} stk)` : ''}
                </span>
                <button type="button" onclick="removeSeoSection('${serviceId}', ${index})"
                        class="text-red-400 hover:text-red-600 p-1" title="Fjern anmeldelsessektion">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>

            <input type="text"
                   class="seo-section-header w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   data-service-id="${serviceId}"
                   data-section-index="${index}"
                   value="${escapeHtml(section.header || 'Hvad siger vores kunder')}"
                   placeholder="Overskrift til anmeldelsessektion">

            ${reviewCardsHtml}

            <!-- Tilf√∏j anmeldelse knap -->
            <button type="button" onclick="addReviewToSection('${serviceId}', ${index})"
                    class="mt-4 w-full border-2 border-dashed border-gray-300 rounded-lg py-3 text-gray-400 hover:border-purple-400 hover:text-purple-500 transition-colors">
                + Tilf√∏j anmeldelse
            </button>
        </div>
    `;
}

// Add new review section
function addReviewSection(serviceId) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId]) return;
    if (!campaignConfig.seo_pages[rawId].sections) {
        campaignConfig.seo_pages[rawId].sections = [];
    }

    // Brug ekstraherede reviews fra crawl hvis tilg√¶ngelige
    let reviewsToUse = [];
    if (crawlState.extracted_reviews && crawlState.extracted_reviews.length > 0) {
        // Brug crawl reviews (fra Elementor testimonials, Trustpilot etc.)
        reviewsToUse = crawlState.extracted_reviews.map(r => ({
            author: r.author || '',
            rating: r.rating || 5,
            text: r.text || '',
            platform: r.platform || 'Trustpilot'
        }));
        console.log('[addReviewSection] Using', reviewsToUse.length, 'extracted reviews from crawl');
    } else {
        // Fallback til √©n tom review
        reviewsToUse = [{ author: '', rating: 5, text: '', platform: 'Trustpilot' }];
    }

    campaignConfig.seo_pages[rawId].sections.push({
        type: 'reviews',
        header: 'Hvad siger vores kunder',
        reviews: reviewsToUse
    });

    renderActiveSeoContent(rawId);
    debouncedSaveState();
}

// Add review to existing section
function addReviewToSection(serviceId, sectionIndex) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId]?.sections?.[sectionIndex]) return;

    campaignConfig.seo_pages[rawId].sections[sectionIndex].reviews.push({
        author: '',
        rating: 5,
        text: '',
        platform: 'Trustpilot'
    });

    renderActiveSeoContent(rawId);
    debouncedSaveState();
}

// Remove review from section
function removeReview(serviceId, sectionIndex, reviewIndex) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId]?.sections?.[sectionIndex]?.reviews) return;

    const reviews = campaignConfig.seo_pages[rawId].sections[sectionIndex].reviews;
    if (reviews.length <= 1) {
        // Hvis kun 1 anmeldelse, fjern hele sektionen
        removeSeoSection(serviceId, sectionIndex);
        return;
    }

    reviews.splice(reviewIndex, 1);
    renderActiveSeoContent(rawId);
    debouncedSaveState();
}

// Set review rating
function setReviewRating(serviceId, sectionIndex, reviewIndex, rating) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId]?.sections?.[sectionIndex]?.reviews?.[reviewIndex]) return;

    campaignConfig.seo_pages[rawId].sections[sectionIndex].reviews[reviewIndex].rating = rating;
    renderActiveSeoContent(rawId);
    debouncedSaveState();
}

// Carousel navigation functions
function carouselNext(serviceId, sectionIndex) {
    const carousel = document.querySelector(`[data-section-index="${sectionIndex}"][data-section-type="reviews"] .review-carousel`);
    if (!carousel) return;

    const currentPage = parseInt(carousel.dataset.page) || 0;
    const pages = carousel.querySelectorAll('.carousel-page');
    const newPage = (currentPage + 1) % pages.length;
    updateCarouselPage(carousel, newPage);
}

function carouselPrev(serviceId, sectionIndex) {
    const carousel = document.querySelector(`[data-section-index="${sectionIndex}"][data-section-type="reviews"] .review-carousel`);
    if (!carousel) return;

    const currentPage = parseInt(carousel.dataset.page) || 0;
    const pages = carousel.querySelectorAll('.carousel-page');
    const newPage = (currentPage - 1 + pages.length) % pages.length;
    updateCarouselPage(carousel, newPage);
}

function carouselGoTo(serviceId, sectionIndex, pageIndex) {
    const carousel = document.querySelector(`[data-section-index="${sectionIndex}"][data-section-type="reviews"] .review-carousel`);
    if (!carousel) return;
    updateCarouselPage(carousel, pageIndex);
}

function updateCarouselPage(carousel, pageIndex) {
    carousel.dataset.page = pageIndex;

    // Skjul alle sider, vis kun den aktive
    carousel.querySelectorAll('.carousel-page').forEach((page, i) => {
        page.classList.toggle('hidden', i !== pageIndex);
    });

    // Opdater dots
    carousel.querySelectorAll('.carousel-dot').forEach((dot, i) => {
        dot.classList.toggle('bg-purple-600', i === pageIndex);
        dot.classList.toggle('bg-gray-300', i !== pageIndex);
    });
}

// ============================================
// END REVIEW SECTION FUNCTIONS
// ============================================

// Parse content into sections (fallback when backend sections not available)
// Splits content based on paragraphs - no limit on number of sections
function parseContentIntoSections(content) {
    if (!content) return [{ header: '', content: '' }];

    // Clean up content - normalize line breaks
    let cleanContent = content.replace(/\r\n/g, '\n').trim();

    // Remove AIDA phase markers that AI might include (they should NOT become headers)
    cleanContent = cleanContent
        .replace(/^\*?\*?(Attention|Interest|Desire|Action)\s*\(.*?\)\*?\*?:?\s*/gmi, '')
        .replace(/^\*?\*?(Opm√¶rksomhed|Interesse|√ònske|Handling)\*?\*?:?\s*/gmi, '')
        .replace(/^#{1,4}\s*(Attention|Interest|Desire|Action|Opm√¶rksomhed|Interesse|√ònske|Handling).*\n/gmi, '')
        .trim();

    // Split by double newlines (paragraphs)
    const paragraphs = cleanContent.split(/\n\n+/).filter(p => p.trim());
    const sections = [];
    let currentHeader = '';
    let currentContent = [];

    paragraphs.forEach((para) => {
        const trimmed = para.trim();
        if (!trimmed) return;

        // Remove markdown header prefix if present (e.g., ## Header)
        const cleanPara = trimmed.replace(/^#{1,4}\s*/, '');

        // Check if this looks like a quote/review (starts with quote character)
        const isQuotedText = /^["¬ª¬´'"]/.test(cleanPara);

        // Detect if this looks like a header:
        // - Starts with markdown # (definitely a header)
        // - OR: Short (< 100 chars) AND doesn't end with period, question mark, or exclamation
        // - BUT: Never treat quoted text as header (likely review)
        const isHeader = (
            !isQuotedText && (
                trimmed.startsWith('#') ||
                (cleanPara.length < 100 && !cleanPara.match(/[.!?]$/))
            )
        );

        if (isHeader) {
            // Save previous section if we have content
            if (currentContent.length > 0) {
                sections.push({
                    header: currentHeader,
                    content: currentContent.join('\n\n')
                });
            }
            // Start new section with this header
            currentHeader = cleanPara;
            currentContent = [];
        } else {
            // This is content - add to current section
            currentContent.push(cleanPara);
        }
    });

    // Don't forget the last section
    if (currentHeader || currentContent.length > 0) {
        sections.push({
            header: currentHeader,
            content: currentContent.join('\n\n')
        });
    }

    // Ensure at least one section
    if (sections.length === 0) {
        sections = [{ header: '', content: cleanContent }];
    }

    // Post-process: Check for review content and consolidate review sections
    const processedSections = [];
    let pendingReviews = [];
    let reviewSectionHeader = '';
    let reviewSectionIndex = -1;

    for (let i = 0; i < sections.length; i++) {
        const section = sections[i];
        const combinedText = (section.header || '') + ' ' + (section.content || '');

        // Check if this section contains review-like content
        if (detectReviewContent(combinedText)) {
            const reviews = extractReviewsFromText(combinedText);
            if (reviews.length > 0) {
                // Collect reviews to merge later
                if (pendingReviews.length === 0) {
                    reviewSectionIndex = processedSections.length;
                    // Use this section's header if it looks like a review section header
                    if (section.header && /anmeldelse|kunde|siger|testimonial/i.test(section.header)) {
                        reviewSectionHeader = section.header;
                    } else if (!reviewSectionHeader) {
                        reviewSectionHeader = 'Hvad siger vores kunder';
                    }
                }
                pendingReviews.push(...reviews);
                console.log('[parseContentIntoSections] Found', reviews.length, 'reviews in section', i);
                continue;
            }
        }

        // Not a review section - flush pending reviews first
        if (pendingReviews.length > 0) {
            processedSections.push({
                type: 'reviews',
                header: reviewSectionHeader,
                reviews: pendingReviews
            });
            console.log('[parseContentIntoSections] Created review section with', pendingReviews.length, 'reviews');
            pendingReviews = [];
            reviewSectionHeader = '';
        }

        // Add normal text section
        processedSections.push({
            type: 'text',
            header: section.header,
            content: section.content
        });
    }

    // Don't forget remaining reviews at the end
    if (pendingReviews.length > 0) {
        processedSections.push({
            type: 'reviews',
            header: reviewSectionHeader || 'Hvad siger vores kunder',
            reviews: pendingReviews
        });
        console.log('[parseContentIntoSections] Created final review section with', pendingReviews.length, 'reviews');
    }

    return processedSections;
}

// Detect if text contains review/testimonial content
function detectReviewContent(text) {
    if (!text) return false;
    // Must have at least one strong indicator of review content
    const strongReviewPatterns = [
        /\d[.,]?\d?\s*stjerner?/i,                              // "5 stjerner", "4.8 stjerner"
        /‚òÖ+|‚òÜ+/,                                                 // Star symbols
        /["¬ª¬´"]([^"¬ª¬´"]{10,})["¬ª¬´"]\s*[-‚Äì‚Äî]\s*[A-Z√Ü√ò√Ö]/,       // "Quote 10+ chars" - Name
        /trustpilot|google\s*review|facebook\s*anmeldelse/i,   // Platform names (specific)
    ];
    // Weak indicators that support review detection
    const weakReviewPatterns = [
        /\b(anbefaler|tilfreds|fantastisk|professionel|god oplevelse|kan varmt anbefales)\b/i,
        /kunde[rns]*\s*(siger|mener|udtaler)/i
    ];

    // Need at least one strong pattern match
    const hasStrongMatch = strongReviewPatterns.some(p => p.test(text));
    // Or two+ weak patterns
    const weakMatches = weakReviewPatterns.filter(p => p.test(text)).length;

    return hasStrongMatch || weakMatches >= 2;
}

// Extract reviews from text using pattern matching
function extractReviewsFromText(text) {
    const reviews = [];

    // Pattern 1: "Quote text" - Author Name
    const pattern1 = /["¬ª¬´"]([^"¬ª¬´"]{10,300})["¬ª¬´"]\s*[-‚Äì‚Äî]\s*([A-Z√Ü√ò√Ö][a-z√¶√∏√•]+(?:\s+[A-Z√Ü√ò√Ö][a-z√¶√∏√•]+)?)/g;
    let match;
    while ((match = pattern1.exec(text)) !== null) {
        reviews.push({
            author: match[2].trim(),
            rating: 5,
            text: match[1].trim(),
            platform: detectPlatformFromText(text)
        });
    }

    // Pattern 2: Author Name: "Quote text" or Author Name siger: "Quote text"
    const pattern2 = /([A-Z√Ü√ò√Ö][a-z√¶√∏√•]+(?:\s+[A-Z√Ü√ò√Ö][a-z√¶√∏√•]+)?)\s*(?:siger|:)\s*["¬ª¬´"]([^"¬ª¬´"]{10,300})["¬ª¬´"]/g;
    while ((match = pattern2.exec(text)) !== null) {
        // Avoid duplicates
        const alreadyAdded = reviews.some(r => r.text === match[2].trim());
        if (!alreadyAdded) {
            reviews.push({
                author: match[1].trim(),
                rating: 5,
                text: match[2].trim(),
                platform: detectPlatformFromText(text)
            });
        }
    }

    return reviews;
}

// Detect which review platform is mentioned in text
function detectPlatformFromText(text) {
    if (!text) return 'Trustpilot';
    const lower = text.toLowerCase();
    if (lower.includes('google')) return 'Google';
    if (lower.includes('facebook')) return 'Facebook';
    if (lower.includes('anmeldh√•ndv√¶rker') || lower.includes('anmeld h√•ndv√¶rker')) return 'Anmeldh√•ndv√¶rker';
    return 'Trustpilot';
}

// Render active SEO PAGE content - PAGE-BASED structure
async function renderActiveSeoContent(pagePath) {
    const container = $('#active-seo-content');
    const page = allSeoPageKeys.find(p => p.path === pagePath);
    let seoPageData = campaignConfig.seo_pages[pagePath] || {};

    if (!page) {
        container.html('<div class="text-gray-500 p-4">Side ikke fundet</div>');
        return;
    }

    const websiteUrl = crawlState.website_url || '';
    const baseUrl = websiteUrl.replace(/\/$/, '');

    // Get scraped page data
    let scrapedPageData = getScrapedPageData(pagePath);

    // Pre-fill from scraped data if fields are empty
    if (scrapedPageData) {
        if (!seoPageData.meta_title && scrapedPageData.meta_title) {
            seoPageData.meta_title = scrapedPageData.meta_title;
            campaignConfig.seo_pages[pagePath] = seoPageData;
        }
        if (!seoPageData.meta_description && scrapedPageData.meta_description) {
            seoPageData.meta_description = scrapedPageData.meta_description;
            campaignConfig.seo_pages[pagePath] = seoPageData;
        }
        // Use structured sections from backend
        if (!seoPageData.sections && scrapedPageData.sections && scrapedPageData.sections.length > 0) {
            seoPageData.sections = scrapedPageData.sections.map(s => ({
                header: s.header || '',
                content: s.content || '',
                tag: s.tag || 'h2'
            }));

            // Filter out review-like sections
            if (crawlState.extracted_reviews && crawlState.extracted_reviews.length > 0) {
                const reviewAuthors = crawlState.extracted_reviews.map(r => (r.author || '').toLowerCase().trim());
                const reviewTexts = crawlState.extracted_reviews.map(r => (r.text || '').substring(0, 50).toLowerCase().trim());

                seoPageData.sections = seoPageData.sections.filter(section => {
                    const header = (section.header || '').toLowerCase().trim();
                    const content = (section.content || '').toLowerCase().trim();
                    const headerMatchesAuthor = reviewAuthors.some(author =>
                        author && header && (header.includes(author) || author.includes(header))
                    );
                    const contentMatchesReview = reviewTexts.some(reviewText =>
                        reviewText && content && content.substring(0, 60).includes(reviewText.substring(0, 30))
                    );
                    return !headerMatchesAuthor && !contentMatchesReview;
                });
            }

            // Auto-insert reviews
            if (crawlState.extracted_reviews && crawlState.extracted_reviews.length > 0) {
                const hasReviewSection = seoPageData.sections.some(s => s.type === 'reviews');
                if (!hasReviewSection) {
                    seoPageData.sections.push({
                        type: 'reviews',
                        header: 'Hvad siger vores kunder',
                        reviews: crawlState.extracted_reviews.map(r => ({
                            author: r.author || '',
                            rating: r.rating || 5,
                            text: r.text || '',
                            platform: r.platform || 'Trustpilot'
                        }))
                    });
                }
            }
            campaignConfig.seo_pages[pagePath] = seoPageData;
        }
    }

    // Initialize sections array if not exists
    if (!seoPageData.sections) {
        seoPageData.sections = [{ header: '', content: '' }];
        campaignConfig.seo_pages[pagePath] = seoPageData;
    }

    // Calculate character counts
    const titleLength = (seoPageData.meta_title || '').length;
    const descLength = (seoPageData.meta_description || '').length;
    const titleClass = titleLength > 60 ? 'text-red-500' : (titleLength >= 50 ? 'text-green-500' : 'text-yellow-500');
    const descClass = descLength > 160 ? 'text-red-500' : (descLength >= 150 ? 'text-green-500' : 'text-yellow-500');

    // Page icon
    const pageIcon = pagePath === '/' ? 'üè†' : 'üìÑ';

    // Source page link
    let sourcePageHtml = '';
    if (pagePath !== '/') {
        const fullUrl = baseUrl + pagePath;
        sourcePageHtml = `
            <a href="${escapeHtml(fullUrl)}" target="_blank"
               class="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-4">
                <span class="mr-1">üîó</span> Se eksisterende side: ${escapeHtml(pagePath)}
            </a>
        `;
    }

    // Build services tags HTML
    const servicesTagsHtml = page.services.length > 0 ? `
        <div class="mb-4">
            <div class="text-xs text-gray-500 mb-2">Services p√• denne side:</div>
            <div class="flex flex-wrap gap-2">
                ${page.services.map(s => `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                          style="background-color: ${s.color}20; color: ${s.color}; border: 1px solid ${s.color}40;">
                        ${s.isCustom ? '<span class="mr-1 text-xs">AI</span>' : ''}
                        ${escapeHtml(s.name)}
                    </span>
                `).join('')}
            </div>
        </div>
    ` : '';

    // AI button - always show for pages with AI services or homepage
    const hasAiServices = page.services.some(s => s.isCustom);
    const aiButtonHtml = `
        <button type="button" onclick="generateSeoContentForPage('${escapeHtml(pagePath)}')"
                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium
                       hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span>‚ú® Generer med AI</span>
        </button>
    `;

    // Create safe ID from path for DOM elements
    const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');

    // Build sections HTML
    const sectionsHtml = seoPageData.sections.map((section, index) => {
        if (section.type === 'reviews') {
            return renderReviewSectionForPage(pagePath, section, index);
        }

        return `
            <div class="seo-section bg-gray-50 rounded-xl p-4 border border-gray-200" data-section-index="${index}" data-section-type="text">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs font-medium text-gray-500 uppercase">Afsnit ${index + 1}</span>
                    <div class="flex items-center space-x-2">
                        ${seoPageData.sections.length > 1 ? `
                            <button type="button" onclick="removeSeoSectionFromPage('${escapeHtml(pagePath)}', ${index})"
                                    class="text-red-400 hover:text-red-600 p-1" title="Fjern afsnit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <input type="text"
                       class="seo-section-header w-full px-3 py-2 border border-gray-300 rounded-lg mb-2
                              focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 font-medium"
                       data-page-path="${escapeHtml(pagePath)}"
                       data-section-index="${index}"
                       placeholder="Overskrift til afsnit"
                       value="${escapeHtml(section.header || '')}">
                <textarea class="seo-section-content w-full px-3 py-2 border border-gray-300 rounded-lg
                                focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 resize-none"
                          data-page-path="${escapeHtml(pagePath)}"
                          data-section-index="${index}"
                          rows="4"
                          placeholder="Indhold til afsnit...">${escapeHtml(section.content || '')}</textarea>
                <div class="flex justify-end mt-1">
                    <span class="text-xs text-gray-400 seo-section-word-count" data-page-path="${escapeHtml(pagePath)}" data-section-index="${index}">
                        ${countWords(section.content || '')} ord
                    </span>
                </div>
            </div>
        `;
    }).join('');

    const html = `
        <div class="seo-page-content" data-page-path="${escapeHtml(pagePath)}">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl"
                         style="background-color: ${page.color}">
                        ${pageIcon}
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(page.page_title)}</h3>
                        <p class="text-gray-500">Konfigurer meta tags og indhold for ${pagePath === '/' ? 'forsiden' : 'denne underside'}</p>
                    </div>
                </div>
                ${aiButtonHtml}
            </div>

            ${sourcePageHtml}
            ${servicesTagsHtml}

            <!-- SEO Keywords Section -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900 flex items-center text-sm">
                        <span class="w-6 h-6 rounded-lg mr-2 flex items-center justify-center text-xs" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üîë</span>
                        S√∏geord (<span id="seo-keywords-count-${safeId}">${seoPageData.keywords_loaded ? (seoPageData.seo_keywords || []).length : '...'}</span>)
                    </h4>
                    <button type="button" class="add-seo-keyword-btn text-xs px-3 py-1.5 rounded-lg font-medium transition-all duration-200 hover:shadow-md"
                            style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;"
                            data-page-path="${escapeHtml(pagePath)}">
                        + Tilf√∏j
                    </button>
                </div>
                <div id="seo-keywords-container-${safeId}" class="seo-keywords-list space-y-2 max-h-32 overflow-y-auto" data-page-path="${escapeHtml(pagePath)}">
                    ${seoPageData.keywords_loaded ?
                        renderSeoKeywordsListForPage(seoPageData.seo_keywords || [], pagePath) :
                        '<div class="text-gray-400 p-2 text-sm">Henter SEO keywords...</div>'
                    }
                </div>
                <div class="add-seo-keyword-form hidden mt-2 p-3 rounded-xl" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);" data-page-path="${escapeHtml(pagePath)}">
                    <div class="flex items-center space-x-2">
                        <input type="text" class="new-seo-keyword-input flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all text-sm" placeholder="Nyt SEO s√∏geord...">
                        <select class="new-seo-keyword-type px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all text-sm">
                            <option value="money">Money</option>
                            <option value="price">Pris</option>
                            <option value="info">Info</option>
                            <option value="lsi">LSI</option>
                        </select>
                        <button type="button" class="save-new-seo-keyword-btn px-3 py-2 rounded-lg font-medium text-white transition-all duration-200 hover:shadow-lg text-sm" style="background: linear-gradient(90deg, #8b5cf6, #ec4899);" data-page-path="${escapeHtml(pagePath)}">Gem</button>
                        <button type="button" class="cancel-seo-keyword-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all text-sm" data-page-path="${escapeHtml(pagePath)}">Annuller</button>
                    </div>
                </div>
            </div>

            <!-- Meta Title -->
            <div class="bg-white rounded-xl p-5 mb-4 border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <label class="font-semibold text-gray-900">üè∑Ô∏è Meta Titel</label>
                    <span class="text-sm ${titleClass}" id="meta-title-count-${safeId}">${titleLength}/60</span>
                </div>
                <input type="text"
                       class="seo-meta-title w-full px-4 py-3 border border-gray-300 rounded-lg
                              focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900"
                       data-page-path="${escapeHtml(pagePath)}"
                       maxlength="100"
                       placeholder="Indtast meta titel (50-60 tegn anbefales)"
                       value="${escapeHtml(seoPageData.meta_title || '')}">
                <p class="text-xs text-gray-500 mt-1">Vises som titlen i Google s√∏geresultater</p>
            </div>

            <!-- Meta Description -->
            <div class="bg-white rounded-xl p-5 mb-4 border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <label class="font-semibold text-gray-900">üìù Meta Beskrivelse</label>
                    <span class="text-sm ${descClass}" id="meta-desc-count-${safeId}">${descLength}/160</span>
                </div>
                <textarea class="seo-meta-description w-full px-4 py-3 border border-gray-300 rounded-lg
                                focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 resize-none"
                          data-page-path="${escapeHtml(pagePath)}"
                          rows="3"
                          maxlength="250"
                          placeholder="Indtast meta beskrivelse (150-160 tegn)">${escapeHtml(seoPageData.meta_description || '')}</textarea>
                <p class="text-xs text-gray-500 mt-1">Vises under titlen i Google s√∏geresultater</p>
            </div>

            <!-- Page Content Sections -->
            <div class="bg-white rounded-xl p-5 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <label class="font-semibold text-gray-900">üìÑ Sideindhold <span class="text-gray-400 font-normal text-sm">(${seoPageData.sections.length} afsnit, <span id="seo-total-words-${safeId}">${seoPageData.sections.reduce((sum, s) => sum + countWords(s.content || ''), 0)}</span> ord)</span></label>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="addSeoSectionToPage('${escapeHtml(pagePath)}')"
                                class="text-sm px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-medium hover:bg-purple-200 transition-all">
                            + Tilf√∏j afsnit
                        </button>
                        <button type="button" onclick="addReviewSectionToPage('${escapeHtml(pagePath)}')"
                                class="text-sm px-3 py-1.5 bg-pink-100 text-pink-700 rounded-lg font-medium hover:bg-pink-200 transition-all">
                            ‚≠ê Tilf√∏j anmeldelser
                        </button>
                    </div>
                </div>
                <div id="seo-sections-container-${safeId}" class="space-y-4">
                    ${sectionsHtml}
                </div>
                <p class="text-xs text-gray-500 mt-3">Hvert afsnit best√•r af en overskrift og indhold.</p>
            </div>
        </div>
    `;

    container.html(html);

    // Load SEO keywords if not already loaded
    if (!seoPageData.keywords_loaded) {
        await loadSeoKeywordsForPage(pagePath);
    }
}

// Helper functions for page-based SEO
function renderSeoKeywordsListForPage(keywords, pagePath) {
    if (!keywords || keywords.length === 0) {
        return '<div class="text-gray-400 p-2 text-sm">Ingen s√∏geord endnu</div>';
    }
    return keywords.map((kw, i) => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
            <span class="text-sm text-gray-700">${escapeHtml(kw.keyword || kw)}</span>
            <button type="button" class="remove-seo-keyword text-red-400 hover:text-red-600 text-xs"
                    data-page-path="${escapeHtml(pagePath)}" data-index="${i}">√ó</button>
        </div>
    `).join('');
}

function renderReviewSectionForPage(pagePath, section, index) {
    // Use the same review rendering logic but with page path
    const reviews = section.reviews || [];
    const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');

    return `
        <div class="seo-section bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200"
             data-section-index="${index}" data-section-type="reviews">
            <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-medium text-purple-600 uppercase flex items-center">
                    <span class="mr-2">‚≠ê</span> Anmeldelser (${reviews.length} stk)
                </span>
                <button type="button" onclick="removeSeoSectionFromPage('${escapeHtml(pagePath)}', ${index})"
                        class="text-red-400 hover:text-red-600 p-1" title="Fjern anmeldelsessektion">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
            <input type="text"
                   class="seo-section-header w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   data-page-path="${escapeHtml(pagePath)}"
                   data-section-index="${index}"
                   value="${escapeHtml(section.header || 'Hvad siger vores kunder')}"
                   placeholder="Overskrift til anmeldelsessektion">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                ${reviews.slice(0, 6).map((review, i) => `
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-900 text-sm">${escapeHtml(review.author || 'Anonym')}</span>
                            <span class="text-xs text-gray-500">${escapeHtml(review.platform || 'Trustpilot')}</span>
                        </div>
                        <div class="flex mb-2">${'‚òÖ'.repeat(review.rating || 5)}${'‚òÜ'.repeat(5 - (review.rating || 5))}</div>
                        <p class="text-sm text-gray-600 line-clamp-3">${escapeHtml(review.text || '')}</p>
                    </div>
                `).join('')}
            </div>
            ${reviews.length > 6 ? `<p class="text-xs text-gray-500 mt-2">+${reviews.length - 6} flere anmeldelser</p>` : ''}
        </div>
    `;
}

async function loadSeoKeywordsForPage(pagePath) {
    const page = allSeoPageKeys.find(p => p.path === pagePath);
    if (!page) return;

    // Use services on this page to generate keywords
    const serviceNames = page.services.map(s => s.name);
    const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');

    try {
        const response = await $.ajax({
            url: '/ajax/get-seo-keywords/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                service_names: serviceNames,
                page_path: pagePath
            })
        });

        if (response.success) {
            campaignConfig.seo_pages[pagePath].seo_keywords = response.keywords || [];
            campaignConfig.seo_pages[pagePath].keywords_loaded = true;

            $(`#seo-keywords-container-${safeId}`).html(
                renderSeoKeywordsListForPage(response.keywords || [], pagePath)
            );
            $(`#seo-keywords-count-${safeId}`).text((response.keywords || []).length);
            debouncedSaveState();
        }
    } catch (error) {
        console.error('Error loading SEO keywords for page:', pagePath, error);
        campaignConfig.seo_pages[pagePath].keywords_loaded = true;
        campaignConfig.seo_pages[pagePath].seo_keywords = [];
    }
}

// Page-based section functions
function addSeoSectionToPage(pagePath) {
    if (!campaignConfig.seo_pages[pagePath]) return;
    if (!campaignConfig.seo_pages[pagePath].sections) {
        campaignConfig.seo_pages[pagePath].sections = [];
    }
    campaignConfig.seo_pages[pagePath].sections.push({ header: '', content: '' });
    renderActiveSeoContent(pagePath);
    debouncedSaveState();
}

function removeSeoSectionFromPage(pagePath, index) {
    if (!campaignConfig.seo_pages[pagePath]?.sections) return;
    if (campaignConfig.seo_pages[pagePath].sections.length <= 1) return;
    campaignConfig.seo_pages[pagePath].sections.splice(index, 1);
    renderActiveSeoContent(pagePath);
    debouncedSaveState();
}

function addReviewSectionToPage(pagePath) {
    if (!campaignConfig.seo_pages[pagePath]) return;
    if (!campaignConfig.seo_pages[pagePath].sections) {
        campaignConfig.seo_pages[pagePath].sections = [];
    }

    let reviewsToUse = [];
    if (crawlState.extracted_reviews && crawlState.extracted_reviews.length > 0) {
        reviewsToUse = crawlState.extracted_reviews.map(r => ({
            author: r.author || '',
            rating: r.rating || 5,
            text: r.text || '',
            platform: r.platform || 'Trustpilot'
        }));
    } else {
        reviewsToUse = [{ author: '', rating: 5, text: '', platform: 'Trustpilot' }];
    }

    campaignConfig.seo_pages[pagePath].sections.push({
        type: 'reviews',
        header: 'Hvad siger vores kunder',
        reviews: reviewsToUse
    });

    renderActiveSeoContent(pagePath);
    debouncedSaveState();
}

// Generate SEO content for a page
async function generateSeoContentForPage(pagePath) {
    const page = allSeoPageKeys.find(p => p.path === pagePath);
    if (!page) {
        alert('Side ikke fundet');
        return;
    }

    const serviceNames = page.services.map(s => s.name);
    const scrapedData = getScrapedPageData(pagePath);

    // Get company profile and USPs for context
    const companyProfile = campaignConfig.company_profile || null;
    const usps = getActiveUsps();

    showRobertoLoading('seo_content');

    try {
        const response = await $.ajax({
            url: '/ajax/generate-seo-content/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                action: scrapedData ? 'rewrite' : 'generate_new',
                service_name: serviceNames.join(' & '),  // Backend expects service_name (singular)
                page_path: pagePath,
                page_title: page.page_title,
                existing_content: scrapedData?.content || '',
                existing_meta_title: scrapedData?.meta_title || '',
                existing_meta_description: scrapedData?.meta_description || '',
                company_profile: companyProfile,
                usps: usps
            })
        });

        if (response.success) {
            if (response.meta_title) {
                campaignConfig.seo_pages[pagePath].meta_title = response.meta_title;
            }
            if (response.meta_description) {
                campaignConfig.seo_pages[pagePath].meta_description = response.meta_description;
            }
            if (response.sections) {
                campaignConfig.seo_pages[pagePath].sections = response.sections;
            }

            renderActiveSeoContent(pagePath);
            debouncedSaveState();
            showToast('SEO indhold genereret med AI', 'success');
        } else {
            alert('Fejl ved generering: ' + (response.error || 'Ukendt fejl'));
        }
    } catch (error) {
        console.error('SEO generation error:', error);
        alert('Fejl ved generering af SEO indhold');
    }

    hideRobertoLoading();
}

// Add a new section to SEO page (no limit - matches page structure)
function addSeoSection(serviceId) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId]) return;

    if (!campaignConfig.seo_pages[rawId].sections) {
        campaignConfig.seo_pages[rawId].sections = [];
    }

    // Add new section with empty header - user fills in their own
    campaignConfig.seo_pages[rawId].sections.push({ header: '', content: '' });
    renderActiveSeoContent(rawId);
    debouncedSaveState();
}

// Remove a section from SEO page
function removeSeoSection(serviceId, sectionIndex) {
    const rawId = String(serviceId).startsWith('custom_') ? serviceId : parseInt(serviceId) || serviceId;
    if (!campaignConfig.seo_pages[rawId] || !campaignConfig.seo_pages[rawId].sections) return;

    if (campaignConfig.seo_pages[rawId].sections.length > 1) {
        campaignConfig.seo_pages[rawId].sections.splice(sectionIndex, 1);
        renderActiveSeoContent(rawId);
        debouncedSaveState();
    }
}

// Export SEO content to WordPress-compatible CSV
async function exportSeoContentCSV() {
    // Prepare SEO pages data for export
    const seoPages = campaignConfig.seo_pages || {};

    // Add service name and source_path to each page from allSeoServiceKeys
    const enrichedPages = {};
    for (const [serviceId, pageData] of Object.entries(seoPages)) {
        const serviceInfo = allSeoServiceKeys.find(s => String(s.id) === String(serviceId));
        enrichedPages[serviceId] = {
            ...pageData,
            service_name: serviceInfo?.name || pageData.service_name || 'Ukendt service',
            source_path: serviceInfo?.source_path || pageData.source_path || '/'
        };
    }

    if (Object.keys(enrichedPages).length === 0) {
        showToast('Ingen SEO sider at eksportere. Udfyld mindst √©n service.', 'warning');
        return;
    }

    try {
        const response = await fetch('/ajax/export-seo-content-csv/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                seo_pages: enrichedPages,
                website_url: crawlState.website_url || campaignConfig.website_url || ''
            })
        });

        if (response.ok) {
            // Download the CSV file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'seo_content_export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            showToast(`CSV eksporteret med ${Object.keys(enrichedPages).length} sider!`, 'success');
        } else {
            const error = await response.json();
            showToast(`Fejl: ${error.error || 'Kunne ikke eksportere'}`, 'error');
        }
    } catch (error) {
        console.error('Export error:', error);
        showToast('Fejl ved eksport af CSV', 'error');
    }
}

// Render SEO keywords list (new design matching Campaign Builder)
function renderSeoKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<div class="text-gray-400 italic p-3">Ingen SEO keywords fundet for denne service</div>';
    }

    const typeLabels = {
        'money': 'money',
        'price': 'pris',
        'info': 'info',
        'lsi': 'lsi'
    };

    const typeColors = {
        'money': 'background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669;',
        'price': 'background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706;',
        'info': 'background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8;',
        'lsi': 'background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;'
    };

    return keywords.map((kw, index) => {
        const typeLabel = typeLabels[kw.keyword_type] || kw.keyword_type;
        const typeStyle = typeColors[kw.keyword_type] || 'background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #4b5563;';

        return `
            <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-900 font-medium">${escapeHtml(kw.keyword_text)}</span>
                    <span class="text-xs px-2.5 py-1 rounded-lg font-medium" style="${typeStyle}">${typeLabel}</span>
                    ${kw.search_volume ? `<span class="text-xs text-gray-400">(${kw.search_volume})</span>` : ''}
                </div>
                <button type="button" class="remove-seo-keyword-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all"
                        data-keyword-id="${kw.id}" data-service-id="${serviceId}" data-index="${index}">√ó</button>
            </div>
        `;
    }).join('');
}

// Legacy function for backward compatibility
function renderSeoKeywordChips(keywords) {
    return renderSeoKeywordsList(keywords, null);
}

// Load SEO keywords for a service from the database
async function loadSeoKeywordsForService(serviceId) {
    try {
        const response = await $.ajax({
            url: `/ajax/get-service-seo-keywords/${serviceId}/`,
            method: 'GET',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (response.success) {
            campaignConfig.seo_pages[serviceId].seo_keywords = response.keywords || [];
            campaignConfig.seo_pages[serviceId].keywords_loaded = true;

            // Update the UI with new list design
            $(`#seo-keywords-container-${serviceId}`).html(
                renderSeoKeywordsList(response.keywords, serviceId)
            );
            $(`#seo-keywords-count-${serviceId}`).text(response.keywords.length);
        } else {
            console.error('Failed to load SEO keywords:', response.error);
            $(`#seo-keywords-container-${serviceId}`).html(
                '<div class="text-red-400 p-3">Kunne ikke hente SEO keywords</div>'
            );
        }
    } catch (error) {
        console.error('Error loading SEO keywords:', error);
        campaignConfig.seo_pages[serviceId].seo_keywords = [];
        campaignConfig.seo_pages[serviceId].keywords_loaded = true;
        $(`#seo-keywords-container-${serviceId}`).html(
            '<div class="text-gray-400 italic p-3">Ingen SEO keywords fundet</div>'
        );
    }
}

// Generate SEO meta title and description with AI
async function generateSeoMetaForService(serviceId) {
    const service = allSeoServiceKeys.find(s => s.id === serviceId);
    const seoPage = campaignConfig.seo_pages[serviceId];

    if (!service) {
        alert('Service ikke fundet');
        return;
    }

    // Get keywords and USPs for context
    const keywords = seoPage.seo_keywords || [];
    const usps = getActiveUsps();

    // Show loading state
    const generateBtn = $(`.seo-service-content[data-service-id="${serviceId}"] button`).first();
    const originalText = generateBtn.html();
    generateBtn.prop('disabled', true).html(`
        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Genererer...</span>
    `);

    // Show Roberto loading animation
    showRobertoLoading('meta_tags');

    try {
        // Debug: log what we're sending
        console.log('Generating SEO meta with:', { service_id: serviceId, service_name: service.name });

        const response = await $.ajax({
            url: '/ajax/generate-seo-meta/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify({
                service_name: service.name,
                service_id: serviceId,  // For few-shot examples from ServiceMetaExample
                seo_keywords: keywords.map(k => k.keyword_text),
                usps: usps
            })
        });

        if (response.success) {
            // Update the seo_pages config
            campaignConfig.seo_pages[serviceId].meta_title = response.meta_title || '';
            campaignConfig.seo_pages[serviceId].meta_description = response.meta_description || '';

            // Update the inputs
            $(`.seo-meta-title[data-service-id="${serviceId}"]`).val(response.meta_title || '');
            $(`.seo-meta-description[data-service-id="${serviceId}"]`).val(response.meta_description || '');

            // Update character counts
            updateSeoCharCount(serviceId, 'title', (response.meta_title || '').length);
            updateSeoCharCount(serviceId, 'description', (response.meta_description || '').length);

            // Update sidebar status
            renderSeoSidebar();

            showToast('Meta tags genereret med AI', 'success');
        } else {
            alert('Fejl ved generering: ' + (response.error || 'Ukendt fejl'));
        }
    } catch (error) {
        console.error('SEO meta generation error:', error);
        // Fallback to default templates (50-60 tegn titel, 150-160 tegn beskrivelse)
        const usp1 = usps[0] || 'Professionel service med garanti';
        const defaultTitle = `${service.name} i Danmark | Professionel Service & R√•dgivning`;
        const defaultDesc = `Professionel ${service.name} med ${usp1}. Gratis tilbud inden for 24 timer. Ring nu og f√• personlig r√•dgivning fra vores eksperter.`;

        campaignConfig.seo_pages[serviceId].meta_title = defaultTitle;
        campaignConfig.seo_pages[serviceId].meta_description = defaultDesc;

        $(`.seo-meta-title[data-service-id="${serviceId}"]`).val(defaultTitle);
        $(`.seo-meta-description[data-service-id="${serviceId}"]`).val(defaultDesc);

        updateSeoCharCount(serviceId, 'title', defaultTitle.length);
        updateSeoCharCount(serviceId, 'description', defaultDesc.length);

        renderSeoSidebar();
        showToast('Bruger standard meta tags (AI ikke tilg√¶ngelig)', 'warning');
    }

    generateBtn.prop('disabled', false).html(originalText);
    hideRobertoLoading();
}

// Generate SEO content with AI for any service (custom or predefined)
async function generateSeoContentWithAI(serviceId) {
    const service = allSeoServiceKeys.find(s => s.id === serviceId);
    const seoPage = campaignConfig.seo_pages[serviceId];

    if (!service) {
        alert('Service ikke fundet');
        return;
    }

    // Determine if we're generating new content or rewriting existing
    const isAiService = service.isCustom === true;
    const hasDedicatedPage = service.has_dedicated_page !== false;

    // Try to get scraped page data - either from source_path or by matching service name
    let scrapedPageData = service.source_path ? getScrapedPageData(service.source_path) : null;

    // For DB services or when source_path is "/" or empty, try to find matching page
    if (!scrapedPageData || service.source_path === '/' || !service.source_path) {
        const matchedPage = findBestMatchingPage(service.name);
        if (matchedPage) {
            scrapedPageData = matchedPage;
        }
    }
    const action = hasDedicatedPage && scrapedPageData ? 'rewrite' : 'generate_new';

    // Get USPs for context
    const usps = getActiveUsps();

    // Show loading state
    const generateBtn = $(`.seo-service-content[data-service-id="${serviceId}"] button`).first();
    const originalText = generateBtn.html();
    generateBtn.prop('disabled', true).html(`
        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>${action === 'rewrite' ? 'Omskriver...' : 'Genererer...'}</span>
    `);

    // Show Roberto loading animation
    showRobertoLoading('content_generation');

    try {
        // Get company profile from campaignConfig (generated during company description step)
        const companyProfile = campaignConfig.company_profile || null;

        // Get primary city/geographic area for local SEO
        let city = '';
        if (campaignConfig.geographic_region_ids && campaignConfig.geographic_region_ids.length > 0) {
            // Try to get the first selected region's cities
            const regionId = campaignConfig.geographic_region_ids[0];
            // If we have cached region data, get the first city
            if (window.loadedRegionsData && window.loadedRegionsData[regionId]) {
                const cities = window.loadedRegionsData[regionId].cities || [];
                if (cities.length > 0) {
                    city = cities[0].name || '';
                }
            }
        }

        // Build request data with AIDA-model support
        const requestData = {
            action: action,
            service_name: service.name,
            industry: service.industry || '',
            usps: usps,
            company_profile: companyProfile,  // Full company profile JSON for rich content
            city: city  // Geographic area for local SEO keywords
        };

        // For rewrite, add existing content
        if (action === 'rewrite' && scrapedPageData) {
            requestData.existing_content = scrapedPageData.content || '';
            requestData.existing_meta_title = scrapedPageData.meta_title || '';
            requestData.existing_meta_description = scrapedPageData.meta_description || '';
        }

        console.log('[SEO AI Generation]', action, requestData);

        const response = await $.ajax({
            url: '/ajax/generate-seo-content/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify(requestData)
        });

        if (response.success) {
            // Update the seo_pages config
            campaignConfig.seo_pages[serviceId].meta_title = response.meta_title || '';
            campaignConfig.seo_pages[serviceId].meta_description = response.meta_description || '';

            // Parse intro_text into sections for the new segmented UI
            let sections = [];
            if (response.intro_text) {
                sections = parseContentIntoSections(response.intro_text);
            }

            // Handle reviews from AI response - insert as review section at correct position
            if (response.reviews && response.reviews.length > 0) {
                // Create review section from detected reviews
                const reviewSection = {
                    type: 'reviews',
                    header: 'Hvad siger vores kunder',
                    reviews: response.reviews.map(r => ({
                        author: r.author || 'Anonym',
                        rating: parseInt(r.rating) || 5,
                        text: r.text || '',
                        platform: r.platform || 'Trustpilot'
                    }))
                };

                // Determine position (default: after first section)
                const position = Math.min(
                    response.reviews[0]?.position || 1,
                    sections.length
                );

                // Insert review section at correct position
                sections.splice(position, 0, reviewSection);
                console.log('[SEO AI] Inserted review section at position', position, 'with', response.reviews.length, 'reviews');
            }

            campaignConfig.seo_pages[serviceId].sections = sections;

            // Re-render the entire content panel to show updated sections
            await renderActiveSeoContent(serviceId);

            // Update sidebar status
            renderSeoSidebar();

            showToast(action === 'rewrite' ? 'Indhold omskrevet med AI' : 'Indhold genereret med AI', 'success');
        } else {
            alert('Fejl ved generering: ' + (response.error || 'Ukendt fejl'));
        }
    } catch (error) {
        console.error('SEO content generation error:', error);
        showToast('Fejl ved AI-generering: ' + error.message, 'error');
    }

    generateBtn.prop('disabled', false).html(originalText);
    hideRobertoLoading();
}

// Update SEO character count display
// KRAV: Meta titel 50-60 tegn, Meta beskrivelse 150-160 tegn
function updateSeoCharCount(serviceId, type, length) {
    const selector = type === 'title' ? `#meta-title-count-${serviceId}` : `#meta-desc-count-${serviceId}`;
    const max = type === 'title' ? 60 : 160;
    const min = type === 'title' ? 50 : 150;

    let colorClass = 'text-yellow-500';
    if (length > max) {
        colorClass = 'text-red-500';
    } else if (length >= min) {
        colorClass = 'text-green-500';
    }

    $(selector).text(`${length}/${max}`).removeClass('text-red-500 text-green-500 text-yellow-500').addClass(colorClass);
}

// Setup SEO Builder event handlers - PAGE-BASED
function setupSeoEventHandlers() {
    // Sidebar navigation click - PAGE BASED
    $(document).off('click', '.seo-nav-item').on('click', '.seo-nav-item', function() {
        const pagePath = $(this).data('page-path');
        if (pagePath !== undefined) {
            setActiveSeoPage(pagePath);
        }
    });

    // Meta title input change - PAGE BASED
    $(document).off('input', '.seo-meta-title').on('input', '.seo-meta-title', function() {
        const pagePath = $(this).data('page-path');
        if (!pagePath) return;

        const value = $(this).val();
        if (campaignConfig.seo_pages[pagePath]) {
            campaignConfig.seo_pages[pagePath].meta_title = value;
        }

        const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');
        updateSeoCharCountForPage(safeId, 'title', value.length);
        renderSeoSidebar();
        debouncedSaveState();
    });

    // Meta description input change - PAGE BASED
    $(document).off('input', '.seo-meta-description').on('input', '.seo-meta-description', function() {
        const pagePath = $(this).data('page-path');
        if (!pagePath) return;

        const value = $(this).val();
        if (campaignConfig.seo_pages[pagePath]) {
            campaignConfig.seo_pages[pagePath].meta_description = value;
        }

        const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');
        updateSeoCharCountForPage(safeId, 'description', value.length);
        renderSeoSidebar();
        debouncedSaveState();
    });

    // Section header input change - PAGE BASED
    $(document).off('input', '.seo-section-header').on('input', '.seo-section-header', function() {
        const pagePath = $(this).data('page-path');
        if (!pagePath) return;

        const sectionIndex = parseInt($(this).data('section-index'));
        const value = $(this).val();

        if (campaignConfig.seo_pages[pagePath]?.sections?.[sectionIndex]) {
            campaignConfig.seo_pages[pagePath].sections[sectionIndex].header = value;
        }
        debouncedSaveState();
    });

    // Section content input change - PAGE BASED
    $(document).off('input', '.seo-section-content').on('input', '.seo-section-content', function() {
        const pagePath = $(this).data('page-path');
        if (!pagePath) return;

        const sectionIndex = parseInt($(this).data('section-index'));
        const value = $(this).val();

        if (campaignConfig.seo_pages[pagePath]?.sections?.[sectionIndex]) {
            campaignConfig.seo_pages[pagePath].sections[sectionIndex].content = value;
        }

        // Update word count for this section
        const wordCount = countWords(value);
        const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');
        $(`.seo-section-word-count[data-page-path="${pagePath}"][data-section-index="${sectionIndex}"]`).text(`${wordCount} ord`);

        // Update total word count
        if (campaignConfig.seo_pages[pagePath]?.sections) {
            const totalWords = campaignConfig.seo_pages[pagePath].sections.reduce((sum, s) => sum + countWords(s.content || ''), 0);
            $(`#seo-total-words-${safeId}`).text(totalWords);
        }
        debouncedSaveState();
    });

    // Show add SEO keyword form - PAGE BASED
    $(document).off('click', '.add-seo-keyword-btn').on('click', '.add-seo-keyword-btn', function() {
        const pagePath = $(this).data('page-path');
        if (pagePath) {
            $(`.add-seo-keyword-form[data-page-path="${pagePath}"]`).removeClass('hidden');
            $(`.add-seo-keyword-form[data-page-path="${pagePath}"] .new-seo-keyword-input`).focus();
        }
    });

    // Cancel add SEO keyword - PAGE BASED
    $(document).off('click', '.cancel-seo-keyword-btn').on('click', '.cancel-seo-keyword-btn', function() {
        const pagePath = $(this).data('page-path');
        if (pagePath) {
            $(`.add-seo-keyword-form[data-page-path="${pagePath}"]`).addClass('hidden');
            $(`.add-seo-keyword-form[data-page-path="${pagePath}"] .new-seo-keyword-input`).val('');
        }
    });

    // Save new SEO keyword - PAGE BASED
    $(document).off('click', '.save-new-seo-keyword-btn').on('click', '.save-new-seo-keyword-btn', function() {
        const pagePath = $(this).data('page-path');
        if (!pagePath) return;

        const form = $(`.add-seo-keyword-form[data-page-path="${CSS.escape(pagePath)}"]`);
        const keywordText = form.find('.new-seo-keyword-input').val().trim();
        const keywordType = form.find('.new-seo-keyword-type').val();

        if (!keywordText) {
            alert('Indtast et s√∏geord');
            return;
        }

        // Ensure page exists in config
        if (!campaignConfig.seo_pages[pagePath]) {
            campaignConfig.seo_pages[pagePath] = {
                seo_keywords: [],
                meta_title: '',
                meta_description: '',
                sections: []
            };
        }

        // Check for duplicate keyword
        const existingKeywords = campaignConfig.seo_pages[pagePath].seo_keywords || [];
        if (existingKeywords.some(kw => kw.keyword_text.toLowerCase() === keywordText.toLowerCase())) {
            alert('Dette keyword findes allerede for denne side');
            return;
        }

        // Add to local state (no server call - keywords are local to the page)
        const newKeyword = {
            id: `local_${Date.now()}`,  // Unique local ID
            keyword_text: keywordText,
            keyword_type: keywordType || 'primary',
            created_at: new Date().toISOString()
        };

        if (!campaignConfig.seo_pages[pagePath].seo_keywords) {
            campaignConfig.seo_pages[pagePath].seo_keywords = [];
        }
        campaignConfig.seo_pages[pagePath].seo_keywords.push(newKeyword);

        // Re-render keywords list
        const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');
        $(`#seo-keywords-container-${safeId}`).html(
            renderSeoKeywordsListForPage(campaignConfig.seo_pages[pagePath].seo_keywords, pagePath)
        );
        $(`#seo-keywords-count-${safeId}`).text(campaignConfig.seo_pages[pagePath].seo_keywords.length);

        // Hide form and clear input
        form.addClass('hidden');
        form.find('.new-seo-keyword-input').val('');

        showToast('SEO keyword tilf√∏jet', 'success');
    });

    // Remove SEO keyword - PAGE BASED
    $(document).off('click', '.remove-seo-keyword-btn').on('click', '.remove-seo-keyword-btn', function() {
        const keywordId = $(this).data('keyword-id');
        const pagePath = $(this).data('page-path');

        if (!pagePath || !keywordId) return;

        if (!confirm('Er du sikker p√• at du vil slette dette SEO keyword?')) {
            return;
        }

        // Remove from local state
        if (campaignConfig.seo_pages[pagePath] && campaignConfig.seo_pages[pagePath].seo_keywords) {
            campaignConfig.seo_pages[pagePath].seo_keywords =
                campaignConfig.seo_pages[pagePath].seo_keywords.filter(kw => kw.id !== keywordId);

            // Re-render keywords list
            const safeId = pagePath.replace(/[^a-zA-Z0-9]/g, '_');
            $(`#seo-keywords-container-${safeId}`).html(
                renderSeoKeywordsListForPage(campaignConfig.seo_pages[pagePath].seo_keywords, pagePath)
            );
            $(`#seo-keywords-count-${safeId}`).text(campaignConfig.seo_pages[pagePath].seo_keywords.length);

            showToast('SEO keyword slettet', 'success');
        }
    });

    // Handle Enter key in new keyword input - PAGE BASED
    $(document).off('keypress', '.new-seo-keyword-input').on('keypress', '.new-seo-keyword-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            const pagePath = $(this).closest('.add-seo-keyword-form').data('page-path');
            if (pagePath) {
                $(`.save-new-seo-keyword-btn[data-page-path="${CSS.escape(pagePath)}"]`).click();
            }
        }
    });
}

// ============================================================================
// END SEO BUILDER
// ============================================================================

// Get selected cities - DIREKTE fra geo_map_targeting (Step 4)
function getSelectedCities() {
    // Brug byer valgt i Geo-Kampagne Ops√¶tning (Step 4) - 1:1 match
    return campaignConfig.geo_map_targeting?.postal_names || [];
}

// Get active USPs from Step 2 for meta titles/descriptions
function getActiveUsps() {
    const usps = [];

    // Template USPs (med evt. custom tekst)
    if (campaignConfig.usp_ids && campaignConfig.usp_ids.length > 0) {
        campaignConfig.usp_ids.forEach(uspId => {
            const customText = campaignConfig.usp_custom_texts?.[uspId];
            if (customText) {
                usps.push(customText);
            } else {
                // Hent original tekst fra DOM
                const original = $(`.usp-checkbox[data-usp-id="${uspId}"]`)
                    .closest('.usp-item')
                    .find('.usp-display-text').text().trim();
                if (original) {
                    usps.push(original);
                }
            }
        });
    }

    // Custom USPs
    if (campaignConfig.custom_usps && campaignConfig.custom_usps.length > 0) {
        campaignConfig.custom_usps.forEach(usp => {
            if (usp && usp.trim()) {
                usps.push(usp.trim());
            }
        });
    }

    return usps;
}

// Get service name for programmatic geo
function getServiceNameForProgrammatic() {
    // 0. Check custom services with programmatic purpose FIRST (AI-suggested services)
    const customProgrammaticServices = getCustomServicesForPurpose('programmatic');
    if (customProgrammaticServices.length > 0) {
        return customProgrammaticServices[0].name;
    }

    // 1. Try to get from selected services via serverData.services_by_id (most reliable)
    if (campaignConfig.service_ids && campaignConfig.service_ids.length > 0) {
        const firstServiceId = campaignConfig.service_ids[0];
        // Check serverData.services_by_id first (populated when services are rendered)
        if (serverData.services_by_id && serverData.services_by_id[firstServiceId]) {
            return serverData.services_by_id[firstServiceId].name;
        }
        // Fallback: search in fetchedIndustryData
        for (const industryId in fetchedIndustryData) {
            const industryData = fetchedIndustryData[industryId];
            if (industryData && industryData.services) {
                const service = industryData.services.find(s => s.id === firstServiceId);
                if (service) return service.name;
            }
        }
    }

    // 2. Try to get from geo_config enabled_services (set in step 4)
    if (campaignConfig.geo_config && campaignConfig.geo_config.enabled_services &&
        campaignConfig.geo_config.enabled_services.length > 0) {
        const firstServiceId = campaignConfig.geo_config.enabled_services[0];
        // Check serverData.services_by_id first
        if (serverData.services_by_id && serverData.services_by_id[firstServiceId]) {
            return serverData.services_by_id[firstServiceId].name;
        }
        // Fallback: search in fetchedIndustryData
        for (const industryId in fetchedIndustryData) {
            const industryData = fetchedIndustryData[industryId];
            if (industryData && industryData.services) {
                const service = industryData.services.find(s => s.id === firstServiceId);
                if (service) return service.name;
            }
        }
    }

    // 3. Fallback: try to get from industry name
    if (campaignConfig.industry_ids && campaignConfig.industry_ids.length > 0) {
        const industryId = campaignConfig.industry_ids[0];
        const industryData = fetchedIndustryData[industryId];
        if (industryData) return industryData.industry_name;
    }

    // 4. Last resort: try to get first service from serverData or any industry data
    if (serverData.services_by_id) {
        const firstServiceId = Object.keys(serverData.services_by_id)[0];
        if (firstServiceId) {
            return serverData.services_by_id[firstServiceId].name;
        }
    }
    for (const industryId in fetchedIndustryData) {
        const industryData = fetchedIndustryData[industryId];
        if (industryData && industryData.services && industryData.services.length > 0) {
            return industryData.services[0].name;
        }
        if (industryData && industryData.industry_name) {
            return industryData.industry_name;
        }
    }

    return null;
}

// Get service ID for programmatic geo (used for few-shot examples)
function getServiceIdForProgrammatic() {
    // 0. Check custom services with programmatic purpose FIRST (AI-suggested services)
    const customProgrammaticServices = getCustomServicesForPurpose('programmatic');
    if (customProgrammaticServices.length > 0) {
        // Return custom_X format for custom services
        const index = campaignConfig.custom_services.indexOf(customProgrammaticServices[0]);
        if (index !== -1) {
            return `custom_${index}`;
        }
    }

    // 1. Check service_ids first (user explicitly selected services)
    if (campaignConfig.service_ids && campaignConfig.service_ids.length > 0) {
        return campaignConfig.service_ids[0];
    }

    // 2. Check geo_config enabled_services (set in step 4)
    if (campaignConfig.geo_config && campaignConfig.geo_config.enabled_services &&
        campaignConfig.geo_config.enabled_services.length > 0) {
        return campaignConfig.geo_config.enabled_services[0];
    }

    // 3. Fallback: get first service from serverData.services_by_id
    if (serverData.services_by_id) {
        const firstServiceId = Object.keys(serverData.services_by_id)[0];
        if (firstServiceId) {
            return parseInt(firstServiceId);
        }
    }

    // 4. Fallback: find first service from fetched industry data
    for (const industryId of (campaignConfig.industry_ids || [])) {
        const industryData = fetchedIndustryData[industryId];
        if (industryData && industryData.services && industryData.services.length > 0) {
            return industryData.services[0].id;
        }
    }

    return null;
}

// Select all cities
function selectAllCities() {
    $('.city-checkbox:visible').prop('checked', true);
    updateSelectedCitiesCount();
}

// Deselect all cities
function deselectAllCities() {
    $('.city-checkbox').prop('checked', false);
    updateSelectedCitiesCount();
}

// Update selected cities count
function updateSelectedCitiesCount() {
    const count = $('.city-checkbox:checked').length;
    $('#selected-cities-count').text(count);
}

// City search filter
$(document).on('input', '#city-search', function() {
    const searchTerm = $(this).val().toLowerCase();
    $('.city-checkbox-label').each(function() {
        const cityName = $(this).find('.city-checkbox').data('city-name').toLowerCase();
        $(this).toggle(cityName.includes(searchTerm));
    });
});

// City checkbox change handler
$(document).on('change', '.city-checkbox', function() {
    updateSelectedCitiesCount();
});

// =====================================================
// END STEP 7 Functions
// =====================================================

$(document).on('click', '#save-geo-map-selection', function() {
    var selectedPostals = Object.keys(geoSelectedPostals);

    // Build display names list (consolidated + additional_names)
    var displayNames = [];
    var processedConsolidations = {};

    selectedPostals.forEach(function(nr) {
        var postal = geoPostalData[nr];
        var selection = geoSelectedPostals[nr];

        // Skip if this is part of a consolidated group
        if (selection && selection.consolidated) {
            // Find the primary code for this consolidated group
            for (var primaryNr in geoPostalData) {
                var primaryPostal = geoPostalData[primaryNr];
                if (primaryPostal.consolidatedCodes && primaryPostal.consolidatedCodes.indexOf(nr) !== -1) {
                    if (!processedConsolidations[primaryNr]) {
                        processedConsolidations[primaryNr] = true;
                        displayNames.push(primaryPostal.displayName);
                    }
                    break;
                }
            }
            return;
        }

        if (postal) {
            // Use display name
            var displayName = postal.displayName || postal.navn;
            displayNames.push(displayName);

            // Add additional_names
            if (postal.additionalNames && postal.additionalNames.length > 0) {
                postal.additionalNames.forEach(function(name) {
                    var capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
                    displayNames.push(capitalizedName);
                });
            }
        }
    });

    // Sort and remove duplicates
    displayNames = [...new Set(displayNames)].sort();

    // DEBUG: Log what names are being sent
    console.log('=== GEO MAP SAVE DEBUG ===');
    console.log('Selected postal codes:', selectedPostals.length);
    console.log('Display names count:', displayNames.length);
    console.log('Display names:', displayNames);
    console.log('==========================');

    // Update the display field in step 4
    if (displayNames.length > 0) {
        $('#geo-map-selected-cities').val(displayNames.join(', '));
        $('#geo-map-summary').show();
        $('#geo-map-city-count').text(displayNames.length);
    } else {
        $('#geo-map-selected-cities').val('');
        $('#geo-map-summary').hide();
    }

    // Store in campaignConfig for later use
    if (typeof campaignConfig !== 'undefined') {
        campaignConfig.geo_map_targeting = {
            postal_codes: selectedPostals,
            postal_names: displayNames,
            circles: geoCircles.map(function(c) {
                return {
                    lat: c.getLatLng().lat,
                    lng: c.getLatLng().lng,
                    radius: c.getRadius() / 1000
                };
            })
        };
        console.log('Geo targeting saved to campaignConfig:', campaignConfig.geo_map_targeting);

        // Save to localStorage
        debouncedSaveState();

        // Update negative city count and trigger auto-update if list is visible
        updateNegativeCityCount();
    }

    closeGeoMapPanel();
});
</script>

<!-- Geographic Map Slide Panel -->
<div id="geo-map-panel-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300">
    <div id="geo-map-panel" class="fixed right-0 top-0 h-full w-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
        <!-- Panel Header -->
        <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-green-50 to-blue-50">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <span class="mr-2">üåç</span> Geo-Kampagne Ops√¶tning
                </h2>
                <p class="text-sm text-gray-600">V√¶lg postnumre p√• kortet eller skriv dem manuelt</p>
            </div>
            <button type="button" id="close-geo-map-panel" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Map and Selected Postal Codes - Side by Side -->
            <div class="flex gap-4 mb-4 h-full">
                <!-- Map Container (Leaflet) - 75% width -->
                <div id="geo-modal-map" style="width: 75%; height: 100%;" class="border border-gray-300 rounded-lg"></div>

                <!-- Right Side Panel - 25% width -->
                <div style="width: 25%;" class="flex flex-col gap-4">
                    <!-- Selected Postal Codes Display -->
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Valgte postnumre (<span id="geo-panel-city-count" class="font-semibold text-green-600">0</span>):
                        </label>
                        <textarea id="geo-panel-selected-cities" readonly
                                  class="w-full h-48 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                                  placeholder="V√¶lg postnumre p√• kortet eller skriv dem manuelt..."></textarea>
                    </div>

                    <!-- Postnummer Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Tilf√∏j postnumre manuelt:
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="geo-postal-input"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                   placeholder="F.eks. 2100, 2200, 2300">
                            <button type="button" id="geo-add-postal-btn"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                Tilf√∏j
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Skriv et eller flere postnumre adskilt med komma</p>
                    </div>

                    <!-- Color Legend -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <h3 class="font-semibold text-gray-900 mb-2 flex items-center text-sm">
                            <span class="mr-2">üé®</span> Farvekoder:
                        </h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: #3B82F6;"></span>
                                <span class="text-gray-700">Region-valgte</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: #10B981;"></span>
                                <span class="text-gray-700">Manuelt indtastede</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: #8B5CF6;"></span>
                                <span class="text-gray-700">Klikket p√• kort</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: #F59E0B;"></span>
                                <span class="text-gray-700">Cirkel-tegning</span>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <h3 class="font-semibold text-blue-900 mb-2 flex items-center text-sm">
                            <span class="mr-2">üìç</span> Instruktioner:
                        </h3>
                        <ul class="text-xs text-blue-800 space-y-1">
                            <li><strong>Klik</strong> p√• et postnummer-omr√•de for at v√¶lge/frav√¶lge</li>
                            <li><strong>Skriv</strong> postnumre i feltet for at tilf√∏je dem</li>
                            <li><strong>Hold Shift</strong> og klik for at v√¶lge flere omr√•der</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Footer -->
        <div class="p-6 border-t border-gray-200 flex justify-between">
            <button type="button" id="clear-geo-map-selection"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Ryd alle valg
            </button>
            <div class="flex gap-3">
                <button type="button" id="toggle-circle-mode"
                        class="px-4 py-2 border border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 transition-colors">
                    <span class="mr-1">‚≠ï</span> Cirkel-tegning
                </button>
                <button type="button" id="save-geo-map-selection"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    Gem valg
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API Script -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=Function.prototype"></script>

{% endblock %}