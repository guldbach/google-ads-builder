{% extends 'base.html' %}
{% load json_filters %}

{% block title %}Campaign Builder Wizard | Google Ads Builder{% endblock %}

{% block content %}

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Include Leaflet for polygon-based geographic visualization -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Custom CSS for Multi-Step Wizard -->
<style>

.step-content {
    min-height: 500px;
    transition: opacity 0.3s ease;
}

.wizard-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #f3f4f6;
    transition: all 0.3s ease;
}

.selection-card {
    transition: all 0.2s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.selection-card:hover {
    border-color: #c084fc;
    box-shadow: 0 4px 20px rgba(192, 132, 252, 0.2);
    transform: translateY(-2px);
}

.selection-card.selected {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #8b5cf620, #8b5cf610);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
}

.checkbox-custom {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.statistics-card {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid #e2e8f0;
}

.category-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.progress-bar-container {
    width: 100%;
    height: 6px;
    background-color: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #8b5cf6, #ec4899);
    transition: width 0.5s ease;
    border-radius: 3px;
}

.animate-fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* USP Variable Styling */
.usp-variable {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-variable:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-variable.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-variable-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 50px;
    max-width: 150px;
}
.usp-text-static {
    color: #374151;
}

/* Full-text USP variable (for USPs without variables) */
.usp-full-text {
    background: linear-gradient(135deg, #f3e8ff, #fce7f3);
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
    border: 1px dashed #a855f7;
    transition: all 0.2s;
    display: inline-block;
}
.usp-full-text:hover {
    background: linear-gradient(135deg, #e9d5ff, #fbcfe8);
    border-style: solid;
}
.usp-full-text.editing {
    background: white;
    border: 2px solid #a855f7;
    padding: 1px 5px;
}
.usp-full-text-input {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    min-width: 100px;
}

</style>

<!-- Hero Section -->
<div class="text-center mb-12 p-12 bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl">
    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
        <span class="text-4xl">üöÄ</span>
    </div>
    <h1 class="text-5xl font-bold text-gray-900 mb-4">Campaign Builder Wizard</h1>
    <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Intelligent kampagne ops√¶tning med multi-step guide. Byg professionelle Google Ads kampagner med USPs, negative keywords, budget strategier og geo-targeting.
    </p>
    
    <!-- Progress Bar -->
    <div class="mt-8 max-w-md mx-auto">
        <div class="progress-bar-container">
            <div class="progress-bar" id="wizard-progress" style="width: 20%"></div>
        </div>
        <p class="text-sm text-gray-500 mt-2">
            Step <span id="current-step">1</span> of 5 - <span id="step-description">Select Industry & Services</span>
        </p>
        <!-- Start Forfra Button -->
        <button id="reset-wizard-btn" class="mt-4 px-4 py-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Start Forfra
        </button>
    </div>
</div>



<!-- Wizard Content Container -->
<div class="wizard-card p-8 mb-8">

    <!-- STEP 0: Purpose Selection -->
    <div id="step-content-0" class="step-content animate-fade-in">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üéØ V√¶lg Form√•l</h2>
            <p class="text-gray-600">Hvad skal Campaign Builder bruges til? Du kan v√¶lge flere form√•l.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            <!-- Virksomhedsbeskrivelse Prompt -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="company_description">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-2xl shadow-lg">
                        üìù
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Virksomhedsbeskrivelse Prompt</h3>
                        <p class="text-sm text-gray-600">Generer info til ChatGPT prompt for virksomhedsbeskrivelse som kan bruges til prompting af tekst.</p>
                    </div>
                </div>
            </div>

            <!-- Google Ads Kampagner -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="google_ads">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center text-2xl shadow-lg">
                        üìä
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Google Ads Kampagner</h3>
                        <p class="text-sm text-gray-600">Generer Google Ads kampagne-filer med budget strategi, ad templates og geo-targeting.</p>
                    </div>
                </div>
            </div>

            <!-- SEO Analyser -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="seo">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center text-2xl shadow-lg">
                        üîç
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">SEO Analyser</h3>
                        <p class="text-sm text-gray-600">SEO analyser og metabeskrivelser til hjemmeside optimering.</p>
                    </div>
                </div>
            </div>

            <!-- Programmatic Byside -->
            <div class="selection-card p-6 rounded-xl border-2 purpose-card cursor-pointer" data-purpose="programmatic">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-2xl shadow-lg">
                        üåç
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Programmatic Byside</h3>
                        <p class="text-sm text-gray-600">Geo-kampagne med byside setup + WordPress upload fil til WP All Import.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected purposes summary -->
        <div id="selected-purposes-summary" class="mt-8 text-center" style="display: none;">
            <p class="text-sm text-gray-500">Valgte form√•l: <span id="purposes-count" class="font-semibold text-purple-600">0</span></p>
        </div>
    </div>

    <!-- STEP 1: Industry & Service Selection -->
    <div id="step-content-1" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üè¢ V√¶lg Brancher og Services</h2>
            <p class="text-gray-600">Du kan v√¶lge flere brancher og kombinere deres services</p>
        </div>
        
        <!-- Industry Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üìã V√¶lg Brancher (flere muligt)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for industry in industries %}
                <div class="selection-card p-4 rounded-lg border-2 industry-card" data-industry-id="{{ industry.id }}" data-requires-auth="{{ industry.requires_authorization|yesno:'true,false' }}">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" style="background-color: {{ industry.color }}20;">
                            {{ industry.icon }}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ industry.name }}</h4>
                            <p class="text-sm text-gray-500">{{ industry.description }}</p>
                            <div class="flex items-center mt-2 space-x-3">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    {{ industry.industry_services.count }} services
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Authorization question (hidden by default, shown when selected) -->
                    {% if industry.requires_authorization %}
                    <div class="auth-question mt-3 pt-3 border-t border-gray-200" style="display: none;">
                        <p class="text-sm font-medium text-gray-700 mb-2">Er virksomheden autoriseret?</p>
                        <div class="flex space-x-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="auth-{{ industry.id }}" value="true" class="auth-radio mr-2 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Ja, autoriseret</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="auth-{{ industry.id }}" value="false" class="auth-radio mr-2 text-purple-600 focus:ring-purple-500">
                                <span class="text-sm text-gray-700">Nej</span>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8">
                    <p class="text-gray-500">Ingen brancher tilg√¶ngelige. Opret en branche i <a href="{% url 'industry_manager' %}" class="text-purple-600 hover:text-purple-700 font-medium">Industry Manager</a>.</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Service Selection (Hidden initially) -->
        <div id="services-section" class="mb-8" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‚öôÔ∏è V√¶lg Services</h3>
            <div id="services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Services will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- STEP 2: USP Selection -->
    <div id="step-content-2" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">‚≠ê USPs</h2>
        </div>

        <!-- Custom USPs Section -->
        <div class="mb-8 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border border-purple-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                    <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-purple-600 to-pink-600">‚ûï</span>
                    Tilf√∏j egne USPs
                </h3>
            </div>
            <div class="flex gap-3 mb-4">
                <input type="text" id="custom-usp-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Indtast din egen USP...">
                <button type="button" id="add-custom-usp-btn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Tilf√∏j
                </button>
            </div>
            <div id="custom-usps-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Custom USPs will be added here -->
            </div>
            <p class="text-xs text-gray-500 mt-3">Tilf√∏j virksomhedens unikke salgsargumenter som ikke findes i listen nedenfor</p>
        </div>

        <!-- USP Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">‚≠ê V√¶lg USPs fra listen</h3>
            <div class="space-y-6">
                {% for category in usp_categories %}
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white" style="background-color: {{ category.color }};">
                            {{ category.icon }}
                        </span>
                        {{ category.name }}
                        <span class="ml-2 category-badge bg-purple-100 text-purple-800">{{ category.usptemplate_set.count }} USPs</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for usp in category.usptemplate_set.all %}
                        <div class="flex items-start p-3 bg-white rounded-lg border usp-item" data-usp-id="{{ usp.id }}">
                            <input type="checkbox" class="checkbox-custom usp-checkbox mt-1" data-usp-id="{{ usp.id }}" data-is-cta="{{ usp.is_cta|yesno:'true,false' }}" data-original-text="{{ usp.text }}" data-example-headlines='{{ usp.example_headlines|tojson }}'>
                            <div class="flex-1" style="padding-left: 10px;">
                                <p class="font-medium text-gray-900 usp-display-text">{{ usp.text }}</p>
                                <input type="text" class="usp-edit-input w-full px-2 py-1 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" style="display: none;" value="{{ usp.text }}">
                                {% if usp.is_cta %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">
                                    CTA
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <p class="text-gray-500">Ingen USP kategorier tilg√¶ngelige.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- STEP 3: Company Description Info (for Virksomhedsbeskrivelse purpose) -->
    <div id="step-content-3" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üìù Virksomhedsinformation</h2>
            <p class="text-gray-600">Udfyld information om virksomheden til ChatGPT prompt generering</p>
        </div>

        <div class="max-w-2xl mx-auto space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Firmanavn *</label>
                <input type="text" id="company-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Indtast firmanavn">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Generel information om virksomheden og dens v√¶rdis√¶t *</label>
                <textarea id="core-competencies" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Beskriv virksomheden, dens historie, v√¶rdier og hvad der g√∏r den unik..."></textarea>
                <p class="text-xs text-gray-500 mt-1">Fort√¶l om virksomhedens baggrund, v√¶rdier og s√¶rlige kendetegn</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">M√•lgruppe *</label>
                <textarea id="target-audience" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="F.eks. boligejere i K√∏benhavn mellem 30-55 √•r, der s√∏ger p√•lidelig h√•ndv√¶rkerservice til renovering og vedligeholdelse af deres hjem"></textarea>
                <p class="text-xs text-gray-500 mt-1">Beskriv den prim√¶re m√•lgruppe - hvem er kunderne, hvor bor de, og hvad s√∏ger de?</p>
            </div>
        </div>
    </div>

    <!-- STEP 4: Geographic Targeting (FLYTTET FRA STEP 5) -->
    <div id="step-content-4" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üåç Geografisk M√•lretning</h2>
            <p class="text-gray-600">V√¶lg geografiske regioner og konfigurer geo-kampagner</p>
        </div>

        <!-- Geographic Regions Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üó∫Ô∏è V√¶lg Geografiske Regioner</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for region in geographic_regions %}
                <div class="selection-card p-4 rounded-lg border-2 geographic-region-card"
                     data-region-id="{{ region.id }}"
                     data-region-name="{{ region.name|escapejs }}"
                     data-cities='[{% for city in region.cities.all %}{"name": "{{ city.city_name|escapejs }}", "dawa_name": "{{ city.city_synonym|default:city.city_name|escapejs }}"}{% if not forloop.last %}, {% endif %}{% endfor %}]'>
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-xl">
                            üèôÔ∏è
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">{{ region.name }}</h4>
                            <p class="text-sm text-gray-500 mb-2">{{ region.description|truncatechars:50 }}</p>
                            <div class="flex items-center space-x-2">
                                <span class="category-badge bg-blue-100 text-blue-800">{{ region.cities.count }} byer</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8">
                    <p class="text-gray-500">Ingen geografiske regioner tilg√¶ngelige. Opret regioner i <a href="{% url 'geographic_regions_manager' %}" class="text-purple-600 hover:text-purple-700 font-medium">Geographic Regions Manager</a>.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Custom Geographic Selection via Map -->
        <div class="mb-8 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-green-600 to-blue-600">üìç</span>
                V√¶lg Omr√•de p√• Kort
            </h3>
            <p class="text-sm text-gray-600 mb-4">Tegn cirkler p√• kortet for at v√¶lge specifikke omr√•der med danske byer</p>

            <div class="flex items-center gap-4">
                <input type="text" id="geo-map-selected-cities" readonly
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"
                       placeholder="Klik p√• knappen for at v√¶lge omr√•der...">
                <button type="button" id="open-geo-map-btn"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    V√¶lg p√• Kort
                </button>
            </div>

            <!-- Selected cities count -->
            <div id="geo-map-summary" class="mt-3 text-sm text-gray-500" style="display: none;">
                <span id="geo-map-city-count" class="font-semibold text-green-600">0</span> byer valgt
            </div>
        </div>

        <!-- Geo Campaign Service Selection -->
        <div class="mb-8 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-200">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="w-8 h-8 rounded-lg mr-3 flex items-center justify-center text-white bg-gradient-to-r from-blue-600 to-purple-600">üìç</span>
                Geo-Kampagne Ops√¶tning
            </h3>
            <p class="text-sm text-gray-600 mb-4">V√¶lg hvilke services der skal have separate geo-kampagner</p>

            <div id="geo-services-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                <!-- Services will be populated dynamically based on selected services in step 1 -->
                <p class="text-gray-500 col-span-full text-center py-4">V√¶lg services i Step 1 for at se geo-kampagne muligheder</p>
            </div>

            <!-- Byside URL Toggle -->
            <div class="border-t border-blue-200 pt-4 mt-4">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="create-byside-urls" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 mr-3">
                    <span class="font-medium text-gray-900">Generer byside URLs til import</span>
                </label>
                <p class="text-xs text-gray-500 ml-8 mt-1">Opret URL-liste til WordPress byside import</p>
            </div>

            <!-- Byside URL Configuration (hidden by default) -->
            <div id="byside-url-config" class="border-t border-blue-200 pt-4 mt-4" style="display: none;">
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <span class="font-medium">URL Format:</span> /{branche}-{by}/
                        <span class="text-blue-600 ml-2">(f.eks. /toemrer-aarhus/)</span>
                    </p>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-900">üìù Byside URL Liste</h4>
                    <div class="flex space-x-2">
                        <button type="button" id="generate-urls-btn" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                            üîÑ Generer
                        </button>
                        <button type="button" id="copy-urls-btn" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                            üìã Kopi√©r alle
                        </button>
                    </div>
                </div>

                <div id="byside-urls-table" class="bg-white rounded-lg border border-gray-200 overflow-hidden max-h-64 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-600">By</th>
                                <th class="px-4 py-2 text-left text-gray-600">URL</th>
                                <th class="px-4 py-2 text-center text-gray-600">Status</th>
                            </tr>
                        </thead>
                        <tbody id="byside-urls-body">
                            <tr>
                                <td colspan="3" class="px-4 py-4 text-center text-gray-500">V√¶lg regioner og klik "Generer" for at se URLs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="button" id="download-urls-btn" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download til WordPress Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 5: Kampagne & Annoncebygger - HYBRID SIDEBAR + CARDS LAYOUT -->
    <div id="step-content-5" class="step-content" style="display: none;">
        <!-- Header with Batch Actions -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Kampagne & Annoncebygger</h2>
                <p class="text-gray-600 text-sm">Gennemg√• og godkend kampagner og annoncegrupper</p>
            </div>
            <div class="flex items-center space-x-3">
                <button type="button" id="batch-approve-all-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center">
                    <span class="mr-2">‚úì</span> Godkend Alle
                </button>
            </div>
        </div>

        <!-- Sidebar + Main Content Layout -->
        <div class="step5-layout flex gap-6" style="min-height: 600px;">
            <!-- Campaign Sidebar Navigation -->
            <div class="campaign-sidebar w-72 bg-gray-50 rounded-xl border border-gray-200 p-4 flex-shrink-0 overflow-y-auto" style="max-height: 700px;">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Kampagner</h3>
                <div class="campaign-nav-list space-y-2" id="campaign-nav-list">
                    <!-- Dynamisk populated -->
                    <p class="text-gray-400 text-sm text-center py-4">Indl√¶ser...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="campaign-main-content flex-1 overflow-y-auto" style="max-height: 700px;">
                <div id="active-campaign-content">
                    <p class="text-gray-500 text-center py-8">V√¶lg en kampagne i sidebaren for at se detaljer</p>
                </div>
            </div>
        </div>

        <!-- Legacy container for compatibility - hidden -->
        <div id="campaigns-builder-container" class="hidden"></div>
    </div>

    <!-- STEP 5 CONTINUED (hidden template for campaign accordion) -->
    <template id="campaign-accordion-template">
        <div class="campaign-accordion bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" data-industry-id="">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #8B5CF620, #8B5CF610);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-purple-600 to-pink-600">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 campaign-name">Kampagne Navn</h3>
                            <p class="text-sm text-gray-600"><span class="ad-groups-count">0</span> annoncegrupper</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="maximize_clicks">Maximize Clicks</option>
                                <option value="maximize_conversions">Maximize Conversions</option>
                                <option value="target_cpa">Target CPA</option>
                                <option value="target_roas">Target ROAS</option>
                                <option value="manual_cpc">Manual CPC</option>
                            </select>
                        </div>
                        <div class="target-cpa-field" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1">
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Ad Groups Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4">Annoncegrupper</h4>
                    <div class="ad-groups-container space-y-4">
                        <!-- Ad groups will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Ad Group Template -->
    <template id="ad-group-template">
        <div class="ad-group-item bg-gray-50 rounded-xl p-4 border border-gray-200" data-service-id="">
            <!-- Ad Group Header -->
            <div class="ad-group-header flex items-center justify-between mb-4 cursor-pointer">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-blue-100 text-blue-700">
                        üîß
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 ad-group-name">Service Navn</h5>
                        <p class="text-xs text-gray-500"><span class="keywords-count">0</span> s√∏geord</p>
                    </div>
                </div>
                <span class="ad-group-toggle-icon text-xl transition-transform duration-200">‚ñº</span>
            </div>

            <!-- Ad Group Content -->
            <div class="ad-group-content">
                <!-- Keywords Section -->
                <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm flex items-center">
                            <span class="mr-2">üîë</span> S√∏geord
                        </h6>
                        <button type="button" class="add-keyword-btn text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                            + Tilf√∏j
                        </button>
                    </div>
                    <div class="keywords-list space-y-1 text-sm">
                        <!-- Keywords populated here -->
                    </div>
                </div>

                <!-- Headlines Section -->
                <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm">
                            Headlines (<span class="headlines-count">0</span>/15)
                        </h6>
                        <div class="flex space-x-2">
                            <button type="button" class="shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors flex items-center">
                                üîÄ Shuffle
                            </button>
                            <button type="button" class="add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="headlines-list space-y-2">
                        <!-- Headlines populated here -->
                    </div>
                </div>

                <!-- Descriptions Section -->
                <div class="p-3 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h6 class="font-medium text-gray-900 text-sm">
                            Descriptions (<span class="descriptions-count">0</span>/4)
                        </h6>
                        <div class="flex space-x-2">
                            <button type="button" class="generate-ai-descriptions-btn text-xs px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded hover:shadow-lg transition-all flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Generer med AI
                            </button>
                            <button type="button" class="add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="descriptions-list space-y-2">
                        <!-- Descriptions populated here -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- STEP 6: SEO Info (for SEO purpose) -->
    <div id="step-content-6" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üîç SEO Information</h2>
            <p class="text-gray-600">Udfyld information til SEO analyse og metabeskrivelser</p>
        </div>

        <div class="max-w-2xl mx-auto space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Website URL *</label>
                <input type="url" id="seo-website-url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://www.example.dk">
                <p class="text-xs text-gray-500 mt-1">Den hjemmeside der skal analyseres</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fokus Keywords *</label>
                <textarea id="seo-focus-keywords" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="vvs installation&#10;blikkenslager k√∏benhavn&#10;akut vvs"></textarea>
                <p class="text-xs text-gray-500 mt-1">√ât keyword per linje - de vigtigste s√∏geord for virksomheden</p>
            </div>

            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-medium text-blue-900 mb-2">üí° Tip til fokus keywords</h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>‚Ä¢ Inkluder geografiske termer (by, omr√•de)</li>
                    <li>‚Ä¢ Brug b√•de korte og lange s√∏geord</li>
                    <li>‚Ä¢ T√¶nk p√• hvad dine kunder s√∏ger p√•</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- STEP 7: Programmatic Byside Setup -->
    <div id="step-content-7" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üåç Programmatic Byside Setup</h2>
            <p class="text-gray-600">Konfigurer geo-kampagne og WordPress upload</p>
        </div>

        <div class="space-y-8">
            <!-- City Selection -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">üèôÔ∏è V√¶lg Byer</h3>
                <p class="text-sm text-gray-600 mb-4">V√¶lg de byer der skal inkluderes i geo-kampagnen</p>

                <div class="mb-4">
                    <input type="text" id="city-search" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="S√∏g efter by...">
                </div>

                <div id="programmatic-cities-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto">
                    {% for region in geographic_regions %}
                        {% for city in region.cities.all %}
                        <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-purple-50 city-checkbox-label">
                            <input type="checkbox" class="city-checkbox mr-2" data-city-name="{{ city.name }}" data-city-slug="{{ city.slug }}">
                            <span class="text-sm">{{ city.name }}</span>
                        </label>
                        {% endfor %}
                    {% endfor %}
                </div>

                <div class="mt-4 flex items-center justify-between">
                    <span class="text-sm text-gray-500">Valgte byer: <span id="selected-cities-count" class="font-semibold text-purple-600">0</span></span>
                    <button type="button" onclick="selectAllCities()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">V√¶lg alle</button>
                </div>
            </div>

            <!-- Headline Templates -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">üì∞ Headline Templates</h3>
                <p class="text-sm text-gray-600 mb-4">Definer headline templates med placeholders: <code class="bg-gray-200 px-1 rounded">{SERVICE}</code>, <code class="bg-gray-200 px-1 rounded">{BYNAVN}</code></p>

                <div id="headline-templates-container" class="space-y-3">
                    <div class="headline-template-row flex items-center space-x-2">
                        <input type="text" class="headline-template-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="{SERVICE} i {BYNAVN}" maxlength="30">
                        <span class="text-xs text-gray-500 w-12 text-right char-count">0/30</span>
                    </div>
                </div>
                <button type="button" onclick="addHeadlineTemplate()" class="mt-3 text-sm text-purple-600 hover:text-purple-700 font-medium">+ Tilf√∏j headline</button>
            </div>

            <!-- Description Templates -->
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">üìù Description Templates</h3>
                        <p class="text-sm text-gray-600 mt-1">Definer description templates med placeholders</p>
                    </div>
                    <button type="button" id="generate-ai-descriptions-btn" onclick="generateAIDescriptions()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span>Generer med AI</span>
                    </button>
                </div>

                <div id="description-templates-container" class="space-y-3">
                    <div class="description-template-row flex items-center space-x-2">
                        <textarea class="description-template-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Professionel {SERVICE} i {BYNAVN}. Ring nu for gratis tilbud!" rows="2" maxlength="90"></textarea>
                        <span class="text-xs text-gray-500 w-12 text-right char-count">0/90</span>
                    </div>
                </div>
                <button type="button" onclick="addDescriptionTemplate()" class="mt-3 text-sm text-purple-600 hover:text-purple-700 font-medium">+ Tilf√∏j description</button>
            </div>
        </div>
    </div>

    <!-- STEP 8: Summary and Export -->
    <div id="step-content-8" class="step-content" style="display: none;">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">üìã Opsummering og Generering</h2>
            <p class="text-gray-600">Gennemg√• dine valg og generer output</p>
        </div>

        <!-- Campaign Summary -->
        <div id="campaign-summary" class="space-y-6">
            <!-- Summary content will be generated dynamically -->
        </div>

        <!-- Export Options based on selected purposes -->
        <div class="mt-8 border-t pt-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">üì§ Generer Output</h3>
            <div id="export-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Export options will be generated dynamically based on selected purposes -->
            </div>
        </div>
    </div>
</div>

<!-- Navigation Controls -->
<div class="flex justify-between items-center mb-8">
    <button id="prev-btn" class="px-6 py-3 bg-gray-200 text-gray-600 rounded-lg font-medium hover:bg-gray-300 transition-all duration-200" onclick="previousStep()" style="display: none;">
        ‚Üê Forrige Step
    </button>
    <div class="flex-1"></div>
    <button id="next-btn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200" onclick="nextStep()">
        N√¶ste Step ‚Üí
    </button>
    <button id="create-campaign-btn" class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200" onclick="createCampaign()" style="display: none;">
        üöÄ Opret Kampagne
    </button>
</div>

<!-- Authorization Modal -->
<div id="authorization-modal" class="fixed inset-0 flex items-center justify-center" style="z-index: 2147483647; display: none;">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <!-- Modal content - centreret -->
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6">
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-gray-900">Autorisation p√•kr√¶vet</h3>
                <p class="text-sm text-gray-500">Bekr√¶ft autorisations-status</p>
            </div>
        </div>
        <p class="text-gray-600 mb-6">For at sikre korrekte annoncetekster, bekr√¶ft venligst om virksomheden er autoriseret:</p>
        <div id="authorization-questions" class="space-y-4">
            <!-- Dynamically generated questions -->
        </div>
        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
            <button id="auth-modal-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                Annuller
            </button>
            <button id="auth-modal-confirm" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Forts√¶t
            </button>
        </div>
    </div>
</div>

<!-- Negative Keywords Editor Modal -->
<div id="negative-keywords-editor-modal" class="fixed inset-0 flex items-center justify-center" style="z-index: 2147483646; display: none;">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black bg-opacity-50 neg-editor-backdrop"></div>
    <!-- Modal content -->
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[85vh] flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <span class="text-xl">üìã</span>
                    </div>
                    <div>
                        <h3 id="neg-editor-title" class="text-xl font-bold text-gray-900">Negative S√∏geord</h3>
                        <p id="neg-editor-subtitle" class="text-sm text-gray-500">Se og rediger s√∏geord i listen</p>
                    </div>
                </div>
                <button type="button" id="neg-editor-close" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
        </div>

        <!-- Add new keyword form -->
        <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <input type="text" id="neg-editor-new-keyword" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" placeholder="Tilf√∏j nyt negativt s√∏geord...">
                <button type="button" id="neg-editor-add-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 text-sm">
                    + Tilf√∏j
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Tilf√∏jede s√∏geord gemmes kun i denne session og anvendes ved export.</p>
        </div>

        <!-- Keywords list -->
        <div class="flex-1 overflow-y-auto p-4">
            <div id="neg-editor-keywords-list" class="space-y-2">
                <!-- Keywords will be loaded here -->
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">
                    <span id="neg-editor-count">0</span> s√∏geord i listen
                    (<span id="neg-editor-custom-count">0</span> tilf√∏jet i denne session)
                </span>
                <button type="button" id="neg-editor-done-btn" class="px-6 py-2 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors">
                    F√¶rdig
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Wizard State Management
let currentStep = 0;  // Start at step 0 (purpose selection)
let campaignConfig = {
    selected_purposes: [],  // ['company_description', 'google_ads', 'seo', 'programmatic']
    industry_ids: [],  // Changed from industry_id to support multiple industries
    service_ids: [],
    usp_ids: [],
    usp_custom_texts: {},  // {usp_id: "custom text"} for edited USPs
    usp_variable_values: {},  // {usp_id: {varIndex: "brugerv√¶rdi"}} for variable substitution
    custom_usps: [],  // Array of custom USP texts added by user
    negative_keyword_list_ids: [],
    budget_strategy_id: null,
    ad_template_id: null,
    geographic_region_ids: [],
    industry_authorizations: {},  // {industry_id: true/false} for industries requiring authorization
    // Purpose-specific data
    company_info: {
        company_name: '',
        core_competencies: '',
        target_audience: ''
    },
    seo_info: {
        website_url: '',
        focus_keywords: []
    },
    programmatic_info: {
        selected_cities: [],
        headline_templates: [],
        description_templates: []
    },
    // NYT: Geo-kampagne konfiguration (Step 4)
    geo_config: {
        enabled_services: [],  // Hvilke services f√•r geo-kampagne
        create_byside_urls: false,
        byside_urls: []  // [{city, url, exists, edited}]
    },
    // NYT: Kampagne & Annoncebygger (Step 5)
    campaigns: {},  // {industryId: {industry_id, industry_name, budget, negative_keyword_list_ids, geo_config, ad_groups: {serviceId: {...}}}}
    // Custom negative keywords added in this session (per list)
    custom_negative_keywords: {},  // {listId: ['keyword1', 'keyword2', ...]}
    // Template ad group for copying headlines/descriptions to other ad groups
    template_ad_group: {
        industry_id: null,
        service_id: null,
        source_service_name: null  // Original service name for substitution
    }
};

// Server data - will be populated from Django context
let serverData = {
    negative_keyword_lists: [],
    usp_templates: [],
    google_keywords: {}  // Gem keywords per industry
};

// ========================================
// localStorage Persistence (7-day expiry)
// ========================================
const STORAGE_KEY = 'campaignBuilderState';
const STORAGE_EXPIRY_DAYS = 7;

// Debounce helper function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Save current state to localStorage
function saveStateToStorage() {
    try {
        const stateToSave = {
            currentStep: currentStep,
            campaignConfig: campaignConfig,
            timestamp: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
        console.log('State saved to localStorage');
    } catch (e) {
        console.warn('Could not save state to localStorage:', e);
    }
}

// Load state from localStorage (returns null if expired or not found)
function loadStateFromStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return null;

        const state = JSON.parse(saved);
        const expiryMs = STORAGE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;

        // Check if expired
        if (Date.now() - state.timestamp > expiryMs) {
            console.log('Saved state expired, clearing');
            clearSavedState();
            return null;
        }

        console.log('Loaded state from localStorage, age:', Math.round((Date.now() - state.timestamp) / 1000 / 60), 'minutes');
        return state;
    } catch (e) {
        console.warn('Could not load state from localStorage:', e);
        return null;
    }
}

// Clear saved state from localStorage
function clearSavedState() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        console.log('Cleared saved state from localStorage');
    } catch (e) {
        console.warn('Could not clear localStorage:', e);
    }
}

// Debounced save for frequent updates (500ms delay)
const debouncedSaveState = debounce(saveStateToStorage, 500);

// =============================================================================
// UI RESTORE HANDLER REGISTRY (Extensible pattern for future-proof persistence)
// =============================================================================
// To add a new field to localStorage persistence:
// 1. Add field to campaignConfig object (automatic save/load)
// 2. Register a UI restore handler below with registerUIRestoreHandler()
// =============================================================================

const uiRestoreHandlers = [];

// Register a UI restore handler for a specific data field
// @param name - Identifier for logging/debugging
// @param handler - Function that receives campaignConfig and restores UI
// @param options.async - Set to true if handler returns a Promise
// @param options.priority - Lower numbers run first (default: 50)
function registerUIRestoreHandler(name, handler, options = {}) {
    uiRestoreHandlers.push({
        name,
        handler,
        async: options.async || false,
        priority: options.priority || 50
    });
}

// Step 0: Purposes (priority: 10)
registerUIRestoreHandler('purposes', (config) => {
    config.selected_purposes.forEach(purpose => {
        $(`.purpose-card[data-purpose="${purpose}"]`).addClass('selected');
    });
    const purposeCount = config.selected_purposes.length;
    $('#purposes-count').text(purposeCount);
    if (purposeCount > 0) {
        $('#selected-purposes-summary').show();
    }
}, { priority: 10 });

// Step 1: Industries (priority: 20)
registerUIRestoreHandler('industries', (config) => {
    config.industry_ids.forEach(industryId => {
        const card = $(`.industry-card[data-industry-id="${industryId}"]`);
        card.addClass('selected');

        // Show auth question if applicable
        const requiresAuth = card.data('requires-auth') === true || card.data('requires-auth') === 'true';
        if (requiresAuth) {
            card.find('.auth-question').show();
            // Restore authorization answer
            const authAnswer = config.industry_authorizations[industryId];
            if (authAnswer !== undefined) {
                card.find(`input[name="auth-${industryId}"][value="${authAnswer}"]`).prop('checked', true);
            }
        }
    });
}, { priority: 20 });

// Step 1: Services (priority: 30, async - waits for AJAX)
registerUIRestoreHandler('services', async (config) => {
    if (config.industry_ids.length > 0) {
        $('#services-section').show();
        // Load services for selected industries - await the Promise!
        // Service selections are restored in processServiceResponses()
        await loadServicesForSelectedIndustries();
    }
}, { async: true, priority: 30 });

// Step 2: USPs (priority: 40)
registerUIRestoreHandler('usps', (config) => {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        config.usp_ids.forEach(uspId => {
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            checkbox.prop('checked', true);
            // Note: usp-has-variables class is handled by usp_variables handler below
        });
    }, 100);
}, { priority: 40 });

// Step 2: USP Variables (priority: 41) - Restore variable values with renderUspWithVariables
registerUIRestoreHandler('usp_variables', (config) => {
    if (!config.usp_ids || config.usp_ids.length === 0) return;
    if (!config.usp_variable_values || Object.keys(config.usp_variable_values).length === 0) return;

    setTimeout(() => {
        config.usp_ids.forEach(uspId => {
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            if (!checkbox.length) return;

            const originalText = checkbox.data('original-text');
            if (originalText && parseUspVariables(originalText).length > 0) {
                const displayText = checkbox.closest('.usp-item').find('.usp-display-text');
                // GENBRUG eksisterende renderUspWithVariables funktion
                displayText.html(renderUspWithVariables(originalText, uspId));
                displayText.addClass('usp-has-variables');
            }
        });
    }, 150);
}, { priority: 41 });

// Step 2: Custom USPs (priority: 45) - Restore custom USPs with renderCustomUsps
registerUIRestoreHandler('custom_usps', (config) => {
    if (config.custom_usps && config.custom_usps.length > 0) {
        // GENBRUG eksisterende renderCustomUsps funktion
        renderCustomUsps();
    }
}, { priority: 45 });

// Restore UI from saved state using registered handlers
async function restoreUIFromState() {
    console.log('Restoring UI from saved state...');

    // Sort handlers by priority (lower runs first)
    const sorted = [...uiRestoreHandlers].sort((a, b) => a.priority - b.priority);

    for (const { name, handler, async: isAsync } of sorted) {
        try {
            console.log(`Restoring: ${name}`);
            if (isAsync) {
                await handler(campaignConfig);
            } else {
                handler(campaignConfig);
            }
        } catch (e) {
            console.warn(`Failed to restore ${name}:`, e);
        }
    }

    console.log('UI restoration complete');
}

// Purpose definitions
const PURPOSES = {
    company_description: {
        id: 'company_description',
        name: 'Virksomhedsbeskrivelse Prompt',
        icon: 'üìù',
        description: 'Generer info til ChatGPT prompt for virksomhedsbeskrivelse',
        steps: ['company_info']
    },
    google_ads: {
        id: 'google_ads',
        name: 'Google Ads Kampagner',
        icon: 'üìä',
        description: 'Generer Google Ads kampagne-filer',
        steps: ['budget_strategy', 'geo_targeting']
    },
    seo: {
        id: 'seo',
        name: 'SEO Analyser',
        icon: 'üîç',
        description: 'SEO analyser og metabeskrivelser',
        steps: ['seo_info']
    },
    programmatic: {
        id: 'programmatic',
        name: 'Programmatic Byside',
        icon: 'üåç',
        description: 'Geo-kampagne + WordPress upload fil',
        steps: ['programmatic_setup']
    }
};

// Konverter dansk tekst til URL-venlig slug
function danishSlug(text) {
    return text
        .toLowerCase()
        .replace(/√¶/g, 'ae')
        .replace(/√∏/g, 'oe')
        .replace(/√•/g, 'aa')
        .replace(/\s+/g, '-')           // mellemrum ‚Üí bindestreg
        .replace(/[^a-z0-9-]/g, '')     // fjern ugyldige tegn
        .replace(/-+/g, '-')            // fjern multiple bindestreger
        .replace(/^-|-$/g, '');         // fjern bindestreg i start/slut
}

// Get visible steps based on selected purposes
function getVisibleSteps() {
    // Base steps: 0 (purpose), 1 (industry/services), 2 (USPs)
    let steps = [0, 1, 2];

    // Add purpose-specific steps
    if (campaignConfig.selected_purposes.includes('company_description')) {
        steps.push(3);  // Company info step
    }
    if (campaignConfig.selected_purposes.includes('google_ads')) {
        steps.push(4);  // Budget strategy step
        steps.push(5);  // Geo targeting step
    }
    if (campaignConfig.selected_purposes.includes('seo')) {
        steps.push(6);  // SEO info step
    }
    if (campaignConfig.selected_purposes.includes('programmatic')) {
        steps.push(7);  // Programmatic setup step
    }

    // Always add summary step at the end
    steps.push(8);

    return steps;
}

// Get total number of visible steps
function getMaxSteps() {
    return getVisibleSteps().length;
}

// Get the next visible step
function getNextVisibleStep(current) {
    const visibleSteps = getVisibleSteps();
    const currentIndex = visibleSteps.indexOf(current);
    if (currentIndex >= 0 && currentIndex < visibleSteps.length - 1) {
        return visibleSteps[currentIndex + 1];
    }
    return current;
}

// Get the previous visible step
function getPrevVisibleStep(current) {
    const visibleSteps = getVisibleSteps();
    const currentIndex = visibleSteps.indexOf(current);
    if (currentIndex > 0) {
        return visibleSteps[currentIndex - 1];
    }
    return current;
}

// Track which industries require authorization
let industriesRequiringAuth = {};  // {industry_id: industry_name}

// Initialize wizard
$(document).ready(async function() {
    // Try to restore saved state from localStorage
    const savedState = loadStateFromStorage();
    if (savedState) {
        console.log('Found saved state, restoring...');
        campaignConfig = savedState.campaignConfig;
        const targetStep = savedState.currentStep;

        // Set currentStep to 0 temporarily while restoring UI
        currentStep = 0;

        // Wait for UI restoration (including async service loading)
        await restoreUIFromState();

        // Now navigate to the saved step AFTER all data is loaded
        currentStep = targetStep;
        console.log('Navigating to saved step:', targetStep);
    }

    updateWizardState();
    setupEventListeners();
    initUspDisplayTexts(); // Format USP display texts to show default values instead of variable syntax

    // Setup reset button handler
    $('#reset-wizard-btn').on('click', function() {
        if (confirm('Er du sikker? Alle valg vil blive slettet.')) {
            clearSavedState();
            location.reload();
        }
    });
});

// Setup event listeners
function setupEventListeners() {
    // Purpose selection (multiple)
    $('.purpose-card').on('click', function() {
        $(this).toggleClass('selected');

        const purposeId = $(this).data('purpose');
        if ($(this).hasClass('selected')) {
            if (!campaignConfig.selected_purposes.includes(purposeId)) {
                campaignConfig.selected_purposes.push(purposeId);
            }
        } else {
            campaignConfig.selected_purposes = campaignConfig.selected_purposes.filter(p => p !== purposeId);
        }

        // Update purposes count
        const count = campaignConfig.selected_purposes.length;
        $('#purposes-count').text(count);
        if (count > 0) {
            $('#selected-purposes-summary').show();
        } else {
            $('#selected-purposes-summary').hide();
        }

        console.log('Selected purposes:', campaignConfig.selected_purposes);
        debouncedSaveState(); // Auto-save on selection change
    });

    // Industry selection (multiple)
    $('.industry-card').on('click', function(e) {
        // Don't toggle if clicking on radio button or label
        if ($(e.target).hasClass('auth-radio') || $(e.target).closest('label').length > 0) {
            return;
        }

        $(this).toggleClass('selected');

        const industryId = $(this).data('industry-id');
        const requiresAuth = $(this).data('requires-auth') === true || $(this).data('requires-auth') === 'true';
        const authQuestion = $(this).find('.auth-question');

        if ($(this).hasClass('selected')) {
            // Add industry to selection
            if (!campaignConfig.industry_ids.includes(industryId)) {
                campaignConfig.industry_ids.push(industryId);
            }

            // Show auth question if this industry requires it
            if (requiresAuth) {
                authQuestion.slideDown(200);
                // Pre-fill if we have a previous answer
                const existingAnswer = campaignConfig.industry_authorizations[industryId];
                if (existingAnswer !== undefined) {
                    $(this).find(`input[name="auth-${industryId}"][value="${existingAnswer}"]`).prop('checked', true);
                }
            }
        } else {
            // Remove industry from selection
            campaignConfig.industry_ids = campaignConfig.industry_ids.filter(id => id !== industryId);
            // Hide auth question and clear selection
            authQuestion.slideUp(200);
            $(this).find('.auth-radio').prop('checked', false);
            // Remove authorization answer
            delete campaignConfig.industry_authorizations[industryId];

            // Remove services that belong to the deselected industry
            // Get services for this industry from DOM (service cards that will be removed)
            const servicesForRemovedIndustry = [];
            $(`.service-card`).each(function() {
                const serviceId = parseInt($(this).data('service-id'));
                // Check if this service's industry matches the removed industry
                // by looking at the industry badge text
                const industryBadge = $(this).find('.bg-purple-100.text-purple-800').text().trim();
                const removedIndustryCard = $(`.industry-card[data-industry-id="${industryId}"]`);
                const removedIndustryName = removedIndustryCard.find('h4').text().trim();

                if (industryBadge === removedIndustryName) {
                    servicesForRemovedIndustry.push(serviceId);
                }
            });

            campaignConfig.service_ids = campaignConfig.service_ids.filter(
                serviceId => !servicesForRemovedIndustry.includes(serviceId)
            );

            // Update Step 4 UI if it has been rendered
            const geoServicesContainer = document.querySelector('#geo-services-container');
            if (geoServicesContainer && geoServicesContainer.children.length > 0) {
                populateGeoServicesContainer();
            }
        }

        // Load services for all selected industries
        loadServicesForSelectedIndustries();

        // Show services section if any industries are selected
        if (campaignConfig.industry_ids.length > 0) {
            $('#services-section').show();
        } else {
            $('#services-section').hide();
        }
        debouncedSaveState(); // Auto-save on selection change
    });

    // Handle authorization radio button changes
    $(document).on('change', '.auth-radio', function() {
        const card = $(this).closest('.industry-card');
        const industryId = card.data('industry-id');
        const isAuthorized = $(this).val() === 'true';
        campaignConfig.industry_authorizations[industryId] = isAuthorized;
        console.log('Authorization updated:', industryId, isAuthorized);
        debouncedSaveState(); // Auto-save on authorization change
    });
    
    // Service selection (multiple)
    $(document).on('click', '.service-card', function() {
        $(this).toggleClass('selected');

        const serviceId = $(this).data('service-id');
        if ($(this).hasClass('selected')) {
            if (!campaignConfig.service_ids.includes(serviceId)) {
                campaignConfig.service_ids.push(serviceId);
            }
        } else {
            campaignConfig.service_ids = campaignConfig.service_ids.filter(id => id !== serviceId);
        }

        // Step validation is handled in nextStep() function
        debouncedSaveState(); // Auto-save on selection change
    });
    
    // USP selection with variable rendering
    $('.usp-checkbox').on('change', function() {
        const uspId = parseInt($(this).data('usp-id'));
        const uspItem = $(this).closest('.usp-item');
        const displayText = uspItem.find('.usp-display-text');
        const editInput = uspItem.find('.usp-edit-input');
        const originalText = $(this).data('original-text');

        if ($(this).is(':checked')) {
            if (!campaignConfig.usp_ids.includes(uspId)) {
                campaignConfig.usp_ids.push(uspId);
            }

            // Check if USP has variables
            if (uspHasVariables(originalText)) {
                // Render with variable spans (hide old edit input)
                editInput.hide();
                displayText.html(renderUspWithVariables(originalText, uspId)).show();
                displayText.addClass('usp-has-variables');
            } else {
                // No variables - render as full-text editable span (same style as variable)
                editInput.hide();
                const currentText = campaignConfig.usp_custom_texts[uspId] || originalText;
                displayText.html(`<span class="usp-full-text" data-usp-id="${uspId}" data-original="${escapeHtml(originalText)}" title="Klik for at redigere">${escapeHtml(currentText)}</span>`).show();
                displayText.addClass('usp-has-full-text');
                campaignConfig.usp_custom_texts[uspId] = currentText;
            }
        } else {
            campaignConfig.usp_ids = campaignConfig.usp_ids.filter(id => id !== uspId);
            // Reset to display text (with default values substituted, no variable syntax)
            editInput.hide();
            const displayTextFormatted = uspHasVariables(originalText) ? getUspDisplayText(originalText) : originalText;
            displayText.text(displayTextFormatted).show();
            displayText.removeClass('usp-has-variables usp-has-full-text');
            // Remove custom values
            delete campaignConfig.usp_custom_texts[uspId];
            delete campaignConfig.usp_variable_values[uspId];
        }
        debouncedSaveState(); // Auto-save on USP selection change
    });

    // Update custom text when editing (for USPs without variables)
    $(document).on('input', '.usp-edit-input', function() {
        const uspItem = $(this).closest('.usp-item');
        const uspId = parseInt(uspItem.data('usp-id'));
        campaignConfig.usp_custom_texts[uspId] = $(this).val();
        debouncedSaveState(); // Auto-save on USP text edit
    });

    // Variable inline editing - click to edit
    $(document).on('click', '.usp-variable', function(e) {
        e.stopPropagation();
        startVariableEdit(this);
    });

    // Variable editing - save on blur
    $(document).on('blur', '.usp-variable-input', function() {
        saveVariableEdit($(this));
    });

    // Variable editing - save on Enter, cancel on Escape
    $(document).on('keydown', '.usp-variable-input', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveVariableEdit($(this));
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelVariableEdit($(this));
        }
    });

    // Full-text USP inline editing - click to edit
    $(document).on('click', '.usp-full-text', function(e) {
        e.stopPropagation();
        startFullTextEdit(this);
    });

    // Full-text editing - save on blur
    $(document).on('blur', '.usp-full-text-input', function() {
        saveFullTextEdit($(this));
    });

    // Full-text editing - save on Enter, cancel on Escape
    $(document).on('keydown', '.usp-full-text-input', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveFullTextEdit($(this));
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelFullTextEdit($(this));
        }
    });

    // Negative keyword list selection
    $('.negative-keyword-card').on('click', function() {
        $(this).toggleClass('selected');
        
        const listId = $(this).data('list-id');
        if ($(this).hasClass('selected')) {
            if (!campaignConfig.negative_keyword_list_ids.includes(listId)) {
                campaignConfig.negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.negative_keyword_list_ids = campaignConfig.negative_keyword_list_ids.filter(id => id !== listId);
        }
    });
    
    // Budget strategy selection (single)
    $('.budget-strategy-card').on('click', function() {
        $('.budget-strategy-card').removeClass('selected');
        $(this).addClass('selected');
        campaignConfig.budget_strategy_id = $(this).data('budget-id');
    });
    
    // Ad template selection (single)
    $('.ad-template-card').on('click', function() {
        $('.ad-template-card').removeClass('selected');
        $(this).addClass('selected');
        campaignConfig.ad_template_id = $(this).data('template-id');
    });
    
    // Geographic region selection (multiple)
    $('.geographic-region-card').on('click', function() {
        $(this).toggleClass('selected');

        const regionId = $(this).data('region-id');
        const regionName = $(this).data('region-name');
        const cities = $(this).data('cities') || [];

        if ($(this).hasClass('selected')) {
            if (!campaignConfig.geographic_region_ids.includes(regionId)) {
                campaignConfig.geographic_region_ids.push(regionId);
            }
            // Add region's cities to geo-map as a circle
            addRegionToGeoMap(regionId, regionName, cities);
        } else {
            campaignConfig.geographic_region_ids = campaignConfig.geographic_region_ids.filter(id => id !== regionId);
            // Remove region's circle from geo-map
            removeRegionFromGeoMap(regionId);
        }
    });

    // Custom USP - Add button click
    $('#add-custom-usp-btn').on('click', function() {
        addCustomUsp();
    });

    // Custom USP - Enter key in input
    $('#custom-usp-input').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            addCustomUsp();
        }
    });

    // Custom USP - Remove button (delegated)
    $(document).on('click', '.remove-custom-usp', function() {
        const index = $(this).data('index');
        removeCustomUsp(index);
    });

    // Custom USP - Click to edit (delegated)
    $(document).on('click', '.custom-usp-display-text', function() {
        const item = $(this).closest('.custom-usp-item');
        const displayText = item.find('.custom-usp-display-text');
        const editInput = item.find('.custom-usp-edit-input');

        displayText.hide();
        editInput.show().focus().select();
    });

    // Custom USP - Save on blur or Enter (delegated)
    $(document).on('blur', '.custom-usp-edit-input', function() {
        saveCustomUspEdit($(this));
    });

    $(document).on('keypress', '.custom-usp-edit-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).blur();
        }
    });

    // Custom USP - Cancel on Escape
    $(document).on('keydown', '.custom-usp-edit-input', function(e) {
        if (e.which === 27) {
            const index = $(this).data('index');
            const originalText = campaignConfig.custom_usps[index];
            $(this).val(originalText);
            $(this).blur();
        }
    });
}

// Add custom USP
function addCustomUsp() {
    const input = $('#custom-usp-input');
    const text = input.val().trim();

    if (!text) {
        alert('Indtast venligst en USP tekst');
        input.focus();
        return;
    }

    // Check for duplicates
    if (campaignConfig.custom_usps.includes(text)) {
        alert('Denne USP er allerede tilf√∏jet');
        return;
    }

    // Add to config
    campaignConfig.custom_usps.push(text);

    // Clear input
    input.val('');

    // Render custom USPs
    renderCustomUsps();

    console.log('Custom USPs:', campaignConfig.custom_usps);
}

// Remove custom USP
function removeCustomUsp(index) {
    campaignConfig.custom_usps.splice(index, 1);
    renderCustomUsps();
    console.log('Custom USPs:', campaignConfig.custom_usps);
}

// Save custom USP edit
function saveCustomUspEdit(input) {
    const index = input.data('index');
    const newText = input.val().trim();
    const item = input.closest('.custom-usp-item');
    const displayText = item.find('.custom-usp-display-text');

    if (newText && newText !== campaignConfig.custom_usps[index]) {
        // Check for duplicates (excluding current)
        const otherUsps = campaignConfig.custom_usps.filter((_, i) => i !== index);
        if (otherUsps.includes(newText)) {
            alert('Denne USP tekst findes allerede');
            input.val(campaignConfig.custom_usps[index]);
        } else {
            campaignConfig.custom_usps[index] = newText;
            displayText.text(newText);
            console.log('Custom USP updated:', campaignConfig.custom_usps);
        }
    } else if (!newText) {
        // Revert to original if empty
        input.val(campaignConfig.custom_usps[index]);
    }

    // Hide input, show text
    input.hide();
    displayText.show();
}

// Render custom USPs list
function renderCustomUsps() {
    const container = $('#custom-usps-container');
    container.empty();

    campaignConfig.custom_usps.forEach((usp, index) => {
        const html = `
            <div class="flex items-start p-3 bg-white rounded-lg border custom-usp-item" data-index="${index}">
                <span class="w-5 h-5 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs flex items-center justify-center mt-0.5 flex-shrink-0">‚úì</span>
                <div class="flex-1 px-2">
                    <p class="font-medium text-gray-900 text-sm custom-usp-display-text cursor-pointer hover:text-purple-600" data-index="${index}">${escapeHtml(usp)}</p>
                    <input type="text" class="custom-usp-edit-input w-full px-2 py-1 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" style="display: none;" value="${escapeHtml(usp)}" data-index="${index}">
                </div>
                <button type="button" class="remove-custom-usp text-gray-400 hover:text-red-500 transition-colors flex-shrink-0" data-index="${index}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        `;
        container.append(html);
    });
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =====================================================
// USP Variable System Functions
// =====================================================

// Parse USP text and identify variables with format {VARIABEL:default}
function parseUspVariables(text) {
    const regex = /\{([A-Z√Ü√ò√Ö0-9_]+)(?::([^}]*))?\}/g;
    const variables = [];
    let match;
    while ((match = regex.exec(text)) !== null) {
        variables.push({
            fullMatch: match[0],
            name: match[1],
            defaultValue: match[2] || '',
            startIndex: match.index,
            endIndex: match.index + match[0].length
        });
    }
    return variables;
}

// Check if USP text contains variables
function uspHasVariables(text) {
    return parseUspVariables(text).length > 0;
}

// Get USP display text with default values substituted (plain text, no HTML)
// Used for showing the USP text when NOT selected (no interactive spans)
function getUspDisplayText(text) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        return text; // No variables, return as-is
    }

    let result = text;
    // Replace backwards to preserve indices
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        result = result.substring(0, v.startIndex) + v.defaultValue + result.substring(v.endIndex);
    }
    return result;
}

// Initialize USP display texts to show default values instead of variable syntax
function initUspDisplayTexts() {
    $('.usp-item').each(function() {
        const $item = $(this);
        const $checkbox = $item.find('.usp-checkbox');
        const $displayText = $item.find('.usp-display-text');

        // Only format if not already checked
        if (!$checkbox.is(':checked')) {
            const originalText = $checkbox.data('original-text');
            if (originalText && uspHasVariables(originalText)) {
                const displayText = getUspDisplayText(originalText);
                $displayText.text(displayText);
            }
        }
    });
}

// Render USP with clickable variable spans
function renderUspWithVariables(text, uspId) {
    const variables = parseUspVariables(text);
    if (variables.length === 0) {
        // No variables - return plain text (for custom USPs or USPs without variables)
        return escapeHtml(text);
    }

    let html = '';
    let lastIndex = 0;

    variables.forEach((v, idx) => {
        // Add static text before the variable
        if (v.startIndex > lastIndex) {
            html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex, v.startIndex))}</span>`;
        }

        // Get current value (user-set or default)
        const userValues = campaignConfig.usp_variable_values[uspId] || {};
        const currentValue = userValues[idx] !== undefined ? userValues[idx] : v.defaultValue;

        // Add clickable variable span
        html += `<span class="usp-variable"
                      data-usp-id="${uspId}"
                      data-var-name="${v.name}"
                      data-var-index="${idx}"
                      data-default="${escapeHtml(v.defaultValue)}"
                      title="Klik for at redigere ${v.name}">${escapeHtml(currentValue)}</span>`;

        lastIndex = v.endIndex;
    });

    // Add remaining static text after last variable
    if (lastIndex < text.length) {
        html += `<span class="usp-text-static">${escapeHtml(text.substring(lastIndex))}</span>`;
    }

    return html;
}

// Get final USP text with all variables substituted
function getUspFinalText(uspId, originalText) {
    const variables = parseUspVariables(originalText);
    if (variables.length === 0) {
        // Check if there's a custom text override
        return campaignConfig.usp_custom_texts[uspId] || originalText;
    }

    const userValues = campaignConfig.usp_variable_values[uspId] || {};

    let result = originalText;
    // Replace backwards to preserve indices
    for (let i = variables.length - 1; i >= 0; i--) {
        const v = variables[i];
        const value = userValues[i] !== undefined ? userValues[i] : v.defaultValue;
        result = result.substring(0, v.startIndex) + value + result.substring(v.endIndex);
    }
    return result;
}

// Start inline editing of a variable
function startVariableEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const varIndex = $el.data('var-index');
    const varName = $el.data('var-name');
    const defaultValue = $el.data('default');

    // Get current value
    const userValues = campaignConfig.usp_variable_values[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    // Replace span content with input
    $el.addClass('editing');
    const inputWidth = Math.max(50, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="usp-variable-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;" placeholder="${escapeHtml(varName)}">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save variable edit
function saveVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');
    const newValue = $input.val().trim();

    // Initialize if needed
    if (!campaignConfig.usp_variable_values[uspId]) {
        campaignConfig.usp_variable_values[uspId] = {};
    }

    // Save value (or use default if empty)
    const valueToSave = newValue || defaultValue;
    campaignConfig.usp_variable_values[uspId][varIndex] = valueToSave;

    // Update span display
    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    console.log('Variable saved:', uspId, varIndex, valueToSave);
}

// Cancel variable edit
function cancelVariableEdit($input) {
    const $span = $input.closest('.usp-variable');
    const uspId = $span.data('usp-id');
    const varIndex = $span.data('var-index');
    const defaultValue = $span.data('default');

    // Get current saved value or default
    const userValues = campaignConfig.usp_variable_values[uspId] || {};
    const currentValue = userValues[varIndex] !== undefined ? userValues[varIndex] : defaultValue;

    // Restore span display
    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// =====================================================
// Full-text USP Editing Functions (for USPs without variables)
// =====================================================

// Start inline editing of full-text USP
function startFullTextEdit(element) {
    const $el = $(element);
    if ($el.hasClass('editing')) return;

    const uspId = $el.data('usp-id');
    const originalText = $el.data('original');

    // Get current value
    const currentValue = campaignConfig.usp_custom_texts[uspId] || originalText;

    // Replace span content with input
    $el.addClass('editing');
    const inputWidth = Math.max(100, currentValue.length * 8 + 20);
    $el.html(`<input type="text" class="usp-full-text-input" value="${escapeHtml(currentValue)}" style="width: ${inputWidth}px;">`);

    const $input = $el.find('input');
    $input.focus().select();
}

// Save full-text edit
function saveFullTextEdit($input) {
    const $span = $input.closest('.usp-full-text');
    const uspId = $span.data('usp-id');
    const originalText = $span.data('original');
    const newValue = $input.val().trim();

    // Save value (or use original if empty)
    const valueToSave = newValue || originalText;
    campaignConfig.usp_custom_texts[uspId] = valueToSave;

    // Update span display
    $span.removeClass('editing');
    $span.html(escapeHtml(valueToSave));

    // Auto-save
    debouncedSaveState();

    console.log('Full-text USP saved:', uspId, valueToSave);
}

// Cancel full-text edit
function cancelFullTextEdit($input) {
    const $span = $input.closest('.usp-full-text');
    const uspId = $span.data('usp-id');
    const originalText = $span.data('original');

    // Get current saved value or original
    const currentValue = campaignConfig.usp_custom_texts[uspId] || originalText;

    // Restore span display
    $span.removeClass('editing');
    $span.html(escapeHtml(currentValue));
}

// Load services for all selected industries
function loadServicesForSelectedIndustries() {
    const servicesContainer = $('#services-container');
    
    if (campaignConfig.industry_ids.length === 0) {
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <p class="text-gray-500">V√¶lg mindst √©n branche for at se services</p>
            </div>
        `);
        return Promise.resolve();
    }
    
    // Show loading state
    servicesContainer.html(`
        <div class="col-span-full text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"></div>
            <p class="text-gray-500 mt-2">Indl√¶ser services for ${campaignConfig.industry_ids.length} branche(r)...</p>
        </div>
    `);
    
    // Make parallel AJAX calls for all selected industries (services AND keywords)
    const servicePromises = campaignConfig.industry_ids.map(industryId => {
        return $.ajax({
            url: `/ajax/get-industry-services/${industryId}/`,
            method: 'GET'
        });
    });

    // Also fetch keywords for each industry in parallel
    const keywordPromises = campaignConfig.industry_ids.map(industryId => {
        return $.ajax({
            url: `/ajax/get-industry-keywords/${industryId}/`,
            method: 'GET'
        });
    });

    // Wait for both service and keyword requests to complete
    return Promise.all([
        Promise.all(servicePromises),
        Promise.all(keywordPromises)
    ]).then(([serviceResponses, keywordResponses]) => {
        // Store keywords in serverData
        keywordResponses.forEach((data, index) => {
            const industryId = campaignConfig.industry_ids[index];
            if (data && data.success) {
                serverData.google_keywords[industryId] = data.keywords || [];
                console.log(`Loaded ${data.keywords?.length || 0} keywords for industry ${industryId}`);
            }
        });

        // Continue processing services (convert to same format as before)
        const responses = serviceResponses.map(r => [r]);
        processServiceResponses(responses);
    }).catch(error => {
        console.error('Error loading industry data:', error);
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <p class="text-red-500">Der opstod en fejl ved indl√¶sning af data</p>
            </div>
        `);
    });
}

function processServiceResponses(responses) {
    const servicesContainer = $('#services-container');
    const responseArray = responses;

    console.log('AJAX responses received:', responseArray);

    let allServices = [];
    let industryNames = [];

    // Clear industriesRequiringAuth for currently selected industries
    // (will be repopulated below)
    campaignConfig.industry_ids.forEach(id => {
        delete industriesRequiringAuth[id];
    });

    responseArray.forEach((response, index) => {
        const data = response[0]; // AJAX response is wrapped in array
        const industryId = campaignConfig.industry_ids[index];
        console.log(`Processing industry ${industryId}:`, data);

        if (data && data.success) {
            industryNames.push(data.industry_name);
            data.services.forEach(service => {
                // Add industry info to service for display
                service.industry_name = data.industry_name;
                allServices.push(service);
            });

            // Track if this industry requires authorization
            console.log(`Industry ${industryId} requires_authorization:`, data.requires_authorization);
            if (data.requires_authorization) {
                industriesRequiringAuth[industryId] = data.industry_name;
                console.log('Added to industriesRequiringAuth:', industriesRequiringAuth);
            }
        }
    });

    if (allServices.length === 0) {
        // No services available in any selected industry
        servicesContainer.html(`
            <div class="col-span-full text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p class="text-gray-500 mb-4">Ingen services tilg√¶ngelige i de valgte brancher</p>
                <p class="text-sm text-gray-400">Valgte brancher: ${industryNames.join(', ')}</p>
                <p class="text-sm text-gray-400 mt-2">Du kan tilf√∏je services i <a href="/industry-manager/" class="text-purple-600 hover:text-purple-700 font-medium">Industry Manager</a></p>
            </div>
        `);
    } else {
        // Sort services alphabetically for clean display
        allServices.sort((a, b) => a.name.localeCompare(b.name));

        let servicesHtml = '';

        // Display all services in a clean list without industry headers
        allServices.forEach(service => {
            servicesHtml += `
                <div class="selection-card p-4 rounded-lg border-2 service-card" data-service-id="${service.id}">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${service.name}</h4>
                            <p class="text-sm text-gray-500">${service.description || 'Ingen beskrivelse'}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${service.keyword_count} keywords
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    ${service.industry_name}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        servicesContainer.html(servicesHtml);

        // Restore service selections from saved state (after DOM is updated)
        campaignConfig.service_ids.forEach(serviceId => {
            $(`.service-card[data-service-id="${serviceId}"]`).addClass('selected');
        });
    }
}

// Navigation functions
function nextStep() {
    const visibleSteps = getVisibleSteps();
    const lastStep = visibleSteps[visibleSteps.length - 1];

    if (currentStep < lastStep) {
        if (validateCurrentStep()) {
            currentStep = getNextVisibleStep(currentStep);
            updateWizardState();
            saveStateToStorage(); // Save state on step change

            // Special handling for final step (summary)
            if (currentStep === 8) {
                generateCampaignSummary();
            }
        }
    }
}

function previousStep() {
    if (currentStep > 0) {
        currentStep = getPrevVisibleStep(currentStep);
        updateWizardState();
        saveStateToStorage(); // Save state on step change
    }
}

// Validate current step
function validateCurrentStep() {
    switch(currentStep) {
        case 0:  // Purpose selection
            if (campaignConfig.selected_purposes.length === 0) {
                alert('V√¶lg venligst mindst √©t form√•l f√∏r du forts√¶tter.');
                return false;
            }
            return true;
        case 1:  // Industry & Services
            if (campaignConfig.industry_ids.length === 0) {
                alert('V√¶lg venligst mindst √©n branche f√∏r du forts√¶tter.');
                return false;
            }
            if (campaignConfig.service_ids.length === 0) {
                alert('V√¶lg mindst √©n service f√∏r du forts√¶tter.');
                return false;
            }

            // Check if all authorization questions are answered
            const authRequired = getIndustriesRequiringAuthorization();
            for (const ind of authRequired) {
                if (campaignConfig.industry_authorizations[ind.id] === undefined) {
                    alert(`Angiv venligst om virksomheden er autoriseret ${ind.name}`);
                    // Scroll to the card and highlight
                    const card = $(`.industry-card[data-industry-id="${ind.id}"]`);
                    card[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.find('.auth-question').addClass('bg-red-50 border border-red-200 rounded p-2');
                    setTimeout(() => {
                        card.find('.auth-question').removeClass('bg-red-50 border border-red-200 rounded p-2');
                    }, 3000);
                    return false;
                }
            }

            return true;
        case 2:  // USPs
            if (campaignConfig.usp_ids.length === 0) {
                alert('V√¶lg mindst √©n USP f√∏r du forts√¶tter.');
                return false;
            }
            return true;
        case 3:  // Company Info (for Virksomhedsbeskrivelse)
            if (!$('#company-name').val().trim()) {
                alert('Indtast venligst firmanavn.');
                $('#company-name').focus();
                return false;
            }
            if (!$('#core-competencies').val().trim()) {
                alert('Indtast venligst kernekompetencer.');
                $('#core-competencies').focus();
                return false;
            }
            if (!$('#target-audience').val().trim()) {
                alert('Indtast venligst m√•lgruppe.');
                $('#target-audience').focus();
                return false;
            }
            // Save to config
            campaignConfig.company_info.company_name = $('#company-name').val().trim();
            campaignConfig.company_info.core_competencies = $('#core-competencies').val().trim();
            campaignConfig.company_info.target_audience = $('#target-audience').val().trim();
            return true;
        case 4:  // Geographic Targeting (Step 4)
            // Check if there are regions available
            const regionCardsCount = $('.geographic-region-card').length;
            if (regionCardsCount > 0 && campaignConfig.geographic_region_ids.length === 0) {
                alert('V√¶lg mindst √©n geografisk region f√∏r du forts√¶tter.');
                return false;
            }
            // Save geo config settings
            campaignConfig.geo_config.create_byside_urls = $('#create-byside-urls').is(':checked');
            campaignConfig.geo_config.url_pattern = $('#url-pattern').val() || '/{SERVICE}/{BYNAVN}/';
            // Collect enabled services for geo campaigns
            campaignConfig.geo_config.enabled_services = [];
            $('.geo-service-checkbox:checked').each(function() {
                campaignConfig.geo_config.enabled_services.push(parseInt($(this).data('service-id')));
            });
            return true;
        case 5:  // Campaign & Ad Builder (Step 5)
            // Validate that campaigns have been initialized
            if (Object.keys(campaignConfig.campaigns).length === 0) {
                alert('Der er ingen kampagner at konfigurere. G√• tilbage og v√¶lg brancher og services.');
                return false;
            }
            // Save campaign configurations from UI
            saveCampaignsFromUI();
            return true;
        case 6:  // SEO Info
            if (!$('#seo-website-url').val().trim()) {
                alert('Indtast venligst website URL.');
                $('#seo-website-url').focus();
                return false;
            }
            if (!$('#seo-focus-keywords').val().trim()) {
                alert('Indtast venligst fokus keywords.');
                $('#seo-focus-keywords').focus();
                return false;
            }
            // Save to config
            campaignConfig.seo_info.website_url = $('#seo-website-url').val().trim();
            campaignConfig.seo_info.focus_keywords = $('#seo-focus-keywords').val().trim().split('\n').filter(k => k.trim());
            return true;
        case 7:  // Programmatic Byside
            if (campaignConfig.programmatic_info.selected_cities.length === 0) {
                alert('V√¶lg mindst √©n by f√∏r du forts√¶tter.');
                return false;
            }
            // Collect headline and description templates
            campaignConfig.programmatic_info.headline_templates = [];
            $('.headline-template-input').each(function() {
                const val = $(this).val().trim();
                if (val) campaignConfig.programmatic_info.headline_templates.push(val);
            });
            campaignConfig.programmatic_info.description_templates = [];
            $('.description-template-input').each(function() {
                const val = $(this).val().trim();
                if (val) campaignConfig.programmatic_info.description_templates.push(val);
            });
            if (campaignConfig.programmatic_info.headline_templates.length === 0) {
                alert('Tilf√∏j mindst √©n headline template.');
                return false;
            }
            return true;
        default:
            return true;
    }
}

// Update wizard state
function updateWizardState() {
    // Hide all step content
    $('.step-content').hide();

    // Show current step content
    $(`#step-content-${currentStep}`).show().addClass('animate-fade-in');

    // Get visible steps for progress calculation
    const visibleSteps = getVisibleSteps();
    const currentStepIndex = visibleSteps.indexOf(currentStep);
    const maxSteps = visibleSteps.length;

    // Update progress bar
    const progressPercent = ((currentStepIndex + 1) / maxSteps) * 100;
    $('#wizard-progress').css('width', `${progressPercent}%`);

    // Step descriptions based on step number
    const stepDescriptions = {
        0: 'V√¶lg form√•l',
        1: 'Brancher og services',
        2: 'USPs',
        3: 'Virksomhedsinformation',
        4: 'Geografisk m√•lretning',
        5: 'Kampagne & Annoncebygger',
        6: 'SEO information',
        7: 'Programmatic byside',
        8: 'Opsummering'
    };

    $('#current-step').text(currentStepIndex + 1);
    $('#step-description').text(stepDescriptions[currentStep] || 'Step');

    // Update progress text with total steps
    $('p.text-sm.text-gray-500.mt-2').html(
        `Step <span id="current-step">${currentStepIndex + 1}</span> of ${maxSteps} - <span id="step-description">${stepDescriptions[currentStep] || 'Step'}</span>`
    );

    // Update navigation buttons
    if (currentStep === 0) {
        $('#prev-btn').hide();
    } else {
        $('#prev-btn').show();
    }

    const lastStep = visibleSteps[visibleSteps.length - 1];
    if (currentStep === lastStep) {
        $('#next-btn').hide();
        $('#create-campaign-btn').show();
    } else {
        $('#next-btn').show();
        $('#create-campaign-btn').hide();
    }
}

// Generate campaign summary for final step
function generateCampaignSummary() {
    const summaryContainer = $('#campaign-summary');
    const exportContainer = $('#export-options-container');

    // Build summary HTML based on selected purposes
    let summaryHtml = `
        <div class="bg-white rounded-lg p-6 border border-gray-200 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üéØ Valgte Form√•l</h3>
            <div class="flex flex-wrap gap-2">
                ${campaignConfig.selected_purposes.map(p => {
                    const purpose = PURPOSES[p];
                    return `<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">${purpose.icon} ${purpose.name}</span>`;
                }).join('')}
            </div>
        </div>

        <div class="bg-white rounded-lg p-6 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìã Konfiguration</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üè¢ Brancher & Services</h4>
                    <p class="text-sm text-gray-600 mb-1">Brancher: ${campaignConfig.industry_ids.length} valgt</p>
                    <p class="text-sm text-gray-600">Services: ${campaignConfig.service_ids.length} valgt</p>
                </div>

                <div>
                    <h4 class="font-medium text-gray-900 mb-2">‚≠ê USPs</h4>
                    <p class="text-sm text-gray-600">USPs: ${campaignConfig.usp_ids.length} valgt</p>
                </div>
    `;

    // Add purpose-specific summaries
    if (campaignConfig.selected_purposes.includes('company_description')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üìù Virksomhedsinfo</h4>
                    <p class="text-sm text-gray-600 mb-1">Firma: ${campaignConfig.company_info.company_name || 'Ikke udfyldt'}</p>
                    <p class="text-sm text-gray-600">M√•lgruppe: ${campaignConfig.company_info.target_audience ? 'Udfyldt' : 'Ikke udfyldt'}</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('google_ads')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üí∞ Google Ads</h4>
                    <p class="text-sm text-gray-600 mb-1">Budget strategi: ${campaignConfig.budget_strategy_id ? 'Valgt' : 'Ikke valgt'}</p>
                    <p class="text-sm text-gray-600 mb-1">Ad template: ${campaignConfig.ad_template_id ? 'Valgt' : 'Ikke valgt'}</p>
                    <p class="text-sm text-gray-600">Regioner: ${campaignConfig.geographic_region_ids.length} valgt</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('seo')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üîç SEO</h4>
                    <p class="text-sm text-gray-600 mb-1">Website: ${campaignConfig.seo_info.website_url || 'Ikke udfyldt'}</p>
                    <p class="text-sm text-gray-600">Keywords: ${campaignConfig.seo_info.focus_keywords.length} stk</p>
                </div>
        `;
    }

    if (campaignConfig.selected_purposes.includes('programmatic')) {
        summaryHtml += `
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">üåç Programmatic Byside</h4>
                    <p class="text-sm text-gray-600 mb-1">Byer: ${campaignConfig.programmatic_info.selected_cities.length} valgt</p>
                    <p class="text-sm text-gray-600 mb-1">Headlines: ${campaignConfig.programmatic_info.headline_templates.length} stk</p>
                    <p class="text-sm text-gray-600">Descriptions: ${campaignConfig.programmatic_info.description_templates.length} stk</p>
                </div>
        `;
    }

    summaryHtml += `
            </div>
        </div>
    `;

    summaryContainer.html(summaryHtml);

    // Generate export buttons based on selected purposes
    let exportHtml = '';

    if (campaignConfig.selected_purposes.includes('company_description')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="generateCompanyPrompt()">
                <h4 class="font-medium text-white mb-2">üìù Generer ChatGPT Prompt</h4>
                <p class="text-blue-100 text-sm">Gener√©r virksomhedsbeskrivelse prompt</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('google_ads')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="exportGoogleAdsCsv()">
                <h4 class="font-medium text-white mb-2">üìä Google Ads Editor CSV</h4>
                <p class="text-green-100 text-sm">Eksport√©r til Google Ads Editor format</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('seo')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-orange-600 to-orange-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="generateSeoReport()">
                <h4 class="font-medium text-white mb-2">üîç SEO Rapport</h4>
                <p class="text-orange-100 text-sm">Gener√©r SEO analyse og meta-forslag</p>
            </button>
        `;
    }

    if (campaignConfig.selected_purposes.includes('programmatic')) {
        exportHtml += `
            <button class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-lg text-left hover:shadow-lg transition-all" onclick="exportProgrammaticFiles()">
                <h4 class="font-medium text-white mb-2">üåç Programmatic Export</h4>
                <p class="text-purple-100 text-sm">Google Ads CSV + WordPress Excel</p>
            </button>
        `;
    }

    exportContainer.html(exportHtml);
}

// Export functions
function exportCampaign(format) {
    console.log('Exporting campaign:', format, campaignConfig);
    alert(`Eksporterer kampagne i ${format} format...`);
}

// Purpose-specific export functions
function generateCompanyPrompt() {
    console.log('Generating company description prompt...', campaignConfig.company_info);
    alert('Genererer ChatGPT prompt... (Backend integration kommer i n√¶ste fase)');
}

function exportGoogleAdsCsv() {
    console.log('Exporting Google Ads CSV...', campaignConfig);
    alert('Eksporterer Google Ads CSV... (Backend integration kommer i n√¶ste fase)');
}

function generateSeoReport() {
    console.log('Generating SEO report...', campaignConfig.seo_info);
    alert('Genererer SEO rapport... (Backend integration kommer i n√¶ste fase)');
}

// Toast notification function
function showToast(message, type = 'success') {
    // Remove any existing toasts
    $('.toast-notification').remove();

    const bgColor = type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const iconSvg = type === 'success' ?
        `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>` :
        `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`;

    const toast = $(`
        <div class="toast-notification fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 z-50 transform translate-y-0 opacity-100 transition-all duration-300">
            ${iconSvg}
            <span>${message}</span>
        </div>
    `);

    $('body').append(toast);

    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.css({ transform: 'translateY(20px)', opacity: '0' });
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Helper function to get cookie value (for CSRF token)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function exportProgrammaticFiles() {
    console.log('Exporting programmatic files...', campaignConfig.programmatic_info);
    alert('Eksporterer programmatic filer... (Backend integration kommer i n√¶ste fase)');
}

// Create campaign function
function createCampaign() {
    console.log('Creating campaign with config:', campaignConfig);
    alert('Kampagne oprettes... (Backend integration kommer i n√¶ste fase)');
}

// =====================================================
// Programmatic Byside Helper Functions
// =====================================================

// City selection
function selectAllCities() {
    $('.city-checkbox').prop('checked', true).trigger('change');
}

// Update city count
$(document).on('change', '.city-checkbox', function() {
    const cityName = $(this).data('city-name');
    const citySlug = $(this).data('city-slug');

    if ($(this).is(':checked')) {
        if (!campaignConfig.programmatic_info.selected_cities.find(c => c.name === cityName)) {
            campaignConfig.programmatic_info.selected_cities.push({
                name: cityName,
                slug: citySlug
            });
        }
    } else {
        campaignConfig.programmatic_info.selected_cities = campaignConfig.programmatic_info.selected_cities.filter(c => c.name !== cityName);
    }

    $('#selected-cities-count').text(campaignConfig.programmatic_info.selected_cities.length);
});

// City search filter
$(document).on('input', '#city-search', function() {
    const searchTerm = $(this).val().toLowerCase();
    $('.city-checkbox-label').each(function() {
        const cityName = $(this).find('.city-checkbox').data('city-name').toLowerCase();
        if (cityName.includes(searchTerm)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
});

// Add headline template
function addHeadlineTemplate() {
    const container = $('#headline-templates-container');
    container.append(`
        <div class="headline-template-row flex items-center space-x-2">
            <input type="text" class="headline-template-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="{SERVICE} i {BYNAVN}" maxlength="30">
            <span class="text-xs text-gray-500 w-12 text-right char-count">0/30</span>
            <button type="button" onclick="$(this).closest('.headline-template-row').remove()" class="text-red-500 hover:text-red-700 p-1">‚úï</button>
        </div>
    `);
}

// Add description template
function addDescriptionTemplate() {
    const container = $('#description-templates-container');
    container.append(`
        <div class="description-template-row flex items-center space-x-2">
            <textarea class="description-template-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Professionel {SERVICE} i {BYNAVN}. Ring nu!" rows="2" maxlength="90"></textarea>
            <span class="text-xs text-gray-500 w-12 text-right char-count">0/90</span>
            <button type="button" onclick="$(this).closest('.description-template-row').remove()" class="text-red-500 hover:text-red-700 p-1">‚úï</button>
        </div>
    `);
}

// Generate AI descriptions using OpenAI
async function generateAIDescriptions() {
    const btn = $('#generate-ai-descriptions-btn');
    const originalHtml = btn.html();

    // Show loading state
    btn.prop('disabled', true).html(`
        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Genererer...</span>
    `);

    try {
        // Collect data from wizard state
        const selectedServices = campaignConfig.service_ids;
        const selectedIndustries = campaignConfig.industry_ids;
        const selectedUsps = campaignConfig.usp_ids;

        // Get first selected service name (simplified)
        let serviceName = 'Service';
        const serviceCard = $(`.service-card.selected`).first();
        if (serviceCard.length) {
            serviceName = serviceCard.find('h4').text().trim() || 'Service';
        }

        // Get first selected industry name
        let industryName = 'Branche';
        const industryCard = $(`.industry-card.selected`).first();
        if (industryCard.length) {
            industryName = industryCard.find('h4').text().trim() || 'Branche';
        }

        // Collect selected USP texts
        const usps = [];
        selectedUsps.forEach(uspId => {
            const checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
            if (checkbox.length) {
                const uspText = checkbox.closest('.usp-card').find('.usp-text').text().trim();
                if (uspText) usps.push(uspText);
            }
        });

        // Collect custom USPs
        campaignConfig.custom_usps.forEach(usp => {
            if (usp && usp.trim()) usps.push(usp.trim());
        });

        // Collect headline templates as keywords
        const keywords = [];
        $('.headline-template-input').each(function() {
            const val = $(this).val().trim();
            if (val) keywords.push(val.replace(/{SERVICE}/g, serviceName).replace(/{BYNAVN}/g, 'by'));
        });

        // Call the AI endpoint
        const response = await fetch('/ajax/generate-descriptions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                service_name: serviceName,
                industry_name: industryName,
                usps: usps.length > 0 ? usps : ['Professionel service', 'Hurtig levering'],
                keywords: keywords.length > 0 ? keywords : [serviceName.toLowerCase()]
            })
        });

        const data = await response.json();

        if (data.success && data.descriptions && data.descriptions.length > 0) {
            // Clear existing description templates
            $('#description-templates-container').empty();

            // Add generated descriptions
            data.descriptions.forEach(description => {
                const charCount = description.length;
                $('#description-templates-container').append(`
                    <div class="description-template-row flex items-center space-x-2">
                        <textarea class="description-template-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Professionel {SERVICE} i {BYNAVN}. Ring nu!" rows="2" maxlength="90">${description}</textarea>
                        <span class="text-xs ${charCount >= 90 ? 'text-red-500' : 'text-gray-500'} w-12 text-right char-count">${charCount}/90</span>
                        <button type="button" onclick="$(this).closest('.description-template-row').remove()" class="text-red-500 hover:text-red-700 p-1">‚úï</button>
                    </div>
                `);
            });

            // Show success message
            btn.removeClass('from-purple-600 to-pink-600').addClass('from-green-600 to-green-700');
            btn.html(`
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>${data.descriptions.length} genereret</span>
            `);

            // Reset button after 2 seconds
            setTimeout(() => {
                btn.removeClass('from-green-600 to-green-700').addClass('from-purple-600 to-pink-600');
                btn.html(originalHtml);
                btn.prop('disabled', false);
            }, 2000);
        } else {
            throw new Error(data.error || 'Kunne ikke generere descriptions');
        }
    } catch (error) {
        console.error('AI Generation error:', error);

        // Show error state
        btn.removeClass('from-purple-600 to-pink-600').addClass('from-red-600 to-red-700');
        btn.html(`
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Fejl</span>
        `);

        alert('Fejl ved AI generering: ' + error.message);

        // Reset button after 2 seconds
        setTimeout(() => {
            btn.removeClass('from-red-600 to-red-700').addClass('from-purple-600 to-pink-600');
            btn.html(originalHtml);
            btn.prop('disabled', false);
        }, 2000);
    }
}

// Update character counts for templates
$(document).on('input', '.headline-template-input, .description-template-input', function() {
    const maxLength = $(this).attr('maxlength');
    const currentLength = $(this).val().length;
    $(this).siblings('.char-count').text(`${currentLength}/${maxLength}`);

    // Visual feedback for limit
    if (currentLength >= maxLength) {
        $(this).siblings('.char-count').addClass('text-red-500').removeClass('text-gray-500');
    } else {
        $(this).siblings('.char-count').removeClass('text-red-500').addClass('text-gray-500');
    }
});

// =====================================================
// Authorization Functions
// =====================================================

// Get industries that require authorization (always show modal, even if already answered)
function getIndustriesRequiringAuthorization() {
    return campaignConfig.industry_ids
        .filter(id => industriesRequiringAuth[id])  // Only industries that require auth
        // REMOVED: .filter(id => campaignConfig.industry_authorizations[id] === undefined)
        // Modal skal ALTID vises s√• brugeren kan bekr√¶fte/√¶ndre sit valg
        .map(id => ({ id: id, name: industriesRequiringAuth[id] }));
}

// Show authorization modal with pre-filled answers if they exist
function showAuthorizationModal(industries) {
    // BUGFIX: Flyt modal til body for at undg√• overflow/position problemer
    // Modalen er placeret inde i block content som er nested i en max-w container
    // som forhindrer fixed positioning i at virke korrekt
    const modal = document.getElementById('authorization-modal');
    if (modal && modal.parentElement !== document.body) {
        document.body.appendChild(modal);
    }

    const questionsHtml = industries.map(ind => {
        // Tjek om der allerede er et svar for denne branche
        const existingAnswer = campaignConfig.industry_authorizations[ind.id];
        const yesChecked = existingAnswer === true ? 'checked' : '';
        const noChecked = existingAnswer === false ? 'checked' : '';

        return `
            <div class="auth-question bg-gray-50 rounded-lg p-4" data-industry-id="${ind.id}">
                <p class="font-medium text-gray-900 mb-3">Er virksomheden autoriseret ${ind.name}?</p>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="auth-${ind.id}" value="true" class="auth-radio w-5 h-5 text-green-600 focus:ring-green-500" ${yesChecked}>
                        <span class="text-green-700 font-medium">Ja, autoriseret</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="auth-${ind.id}" value="false" class="auth-radio w-5 h-5 text-gray-600 focus:ring-gray-500" ${noChecked}>
                        <span class="text-gray-700">Nej</span>
                    </label>
                </div>
            </div>
        `;
    }).join('');

    $('#authorization-questions').html(questionsHtml);

    // Fjern hidden klasse OG s√¶t display: flex eksplicit for at tvinge visning
    const $modal = $('#authorization-modal');
    $modal.removeClass('hidden');
    modal.style.display = 'flex';

    console.log('showAuthorizationModal: Modal should now be visible');
    console.log('- Modal classes:', modal.className);
    console.log('- Modal display style:', modal.style.display);
    console.log('- Modal computed display:', window.getComputedStyle(modal).display);

    updateAuthModalConfirmButton();
}

// Update confirm button state based on whether all questions are answered
function updateAuthModalConfirmButton() {
    const totalQuestions = $('.auth-question').length;
    const answeredQuestions = $('.auth-radio:checked').length;
    const allAnswered = totalQuestions === answeredQuestions;
    $('#auth-modal-confirm').prop('disabled', !allAnswered);
}

// Initialize authorization modal event handlers
$(document).ready(function() {
    // Update confirm button when radio changes
    $(document).on('change', '.auth-radio', updateAuthModalConfirmButton);

    // Cancel button
    $('#auth-modal-cancel').on('click', function() {
        $('#authorization-modal').addClass('hidden').css('display', 'none');
    });

    // Confirm button - save answers and continue
    $('#auth-modal-confirm').on('click', function() {
        // Save the answers
        $('.auth-question').each(function() {
            const industryId = $(this).data('industry-id');
            const value = $(this).find('.auth-radio:checked').val() === 'true';
            campaignConfig.industry_authorizations[industryId] = value;
        });

        // Close modal
        $('#authorization-modal').addClass('hidden').css('display', 'none');

        // Continue to next step
        currentStep++;
        updateWizardState();
    });
});

// =====================================================
// Campaign & Ad Builder Functions (Step 5)
// =====================================================

// Store fetched data for industries and services
let fetchedIndustryData = {};

// Initialize campaigns when entering step 5
function initializeCampaignsBuilder() {
    console.log('Initializing campaigns builder...');
    console.log('Selected industries:', campaignConfig.industry_ids);
    console.log('Selected services:', campaignConfig.service_ids);

    const container = $('#campaigns-builder-container');
    container.html('<p class="text-gray-500 text-center py-8">Indl√¶ser kampagne data...</p>');

    // Fetch industry and service data for building campaigns
    fetchCampaignBuilderData().then(() => {
        renderCampaignsBuilder();
    }).catch(err => {
        console.error('Error fetching campaign builder data:', err);
        container.html('<p class="text-red-500 text-center py-8">Fejl ved indl√¶sning af data. Pr√∏v at g√• tilbage og frem igen.</p>');
    });
}

// Fetch all data needed for campaign builder
async function fetchCampaignBuilderData() {
    // Fetch data for each selected industry
    const promises = campaignConfig.industry_ids.map(industryId =>
        $.ajax({
            url: `/ajax/get-industry-services/${industryId}/`,
            method: 'GET'
        }).then(response => {
            fetchedIndustryData[industryId] = response;
            return response;
        })
    );

    // Also fetch negative keyword lists
    const negKeywordsPromise = $.ajax({
        url: '/ajax/get-negative-keyword-lists/',
        method: 'GET'
    }).then(response => {
        serverData.negative_keyword_lists = response.lists || [];
        return response;
    }).catch(() => {
        serverData.negative_keyword_lists = [];
    });

    promises.push(negKeywordsPromise);

    // Fetch keywords for each selected service (ServiceKeyword, not IndustryKeyword)
    const serviceKeywordsPromises = campaignConfig.service_ids.map(serviceId =>
        $.ajax({
            url: `/ajax/get-service-keywords/${serviceId}/`,
            method: 'GET'
        }).then(response => {
            // Store keywords per serviceId (not industryId)
            serverData.google_keywords[serviceId] = response.keywords || [];
            return response;
        }).catch(() => {
            serverData.google_keywords[serviceId] = [];
        })
    );

    promises.push(...serviceKeywordsPromises);

    await Promise.all(promises);
}

// State for new sidebar UI
let activeCampaignKey = null;
let allCampaignKeys = [];

// Render the campaigns builder UI - NEW SIDEBAR VERSION
function renderCampaignsBuilder() {
    const legacyContainer = $('#campaigns-builder-container');
    legacyContainer.empty();

    // Group services by industry
    const servicesByIndustry = {};
    campaignConfig.industry_ids.forEach(industryId => {
        const industryData = fetchedIndustryData[industryId];
        if (industryData && industryData.success) {
            servicesByIndustry[industryId] = {
                name: industryData.industry_name,
                services: industryData.services.filter(s =>
                    campaignConfig.service_ids.includes(s.id)
                )
            };
        }
    });

    // Reset campaign keys
    allCampaignKeys = [];

    // Create a campaign for each industry
    Object.keys(servicesByIndustry).forEach(industryId => {
        const industryInfo = servicesByIndustry[industryId];

        // Initialize campaign config if not exists
        if (!campaignConfig.campaigns[industryId]) {
            campaignConfig.campaigns[industryId] = {
                industry_id: parseInt(industryId),
                industry_name: industryInfo.name,
                daily_budget: '',
                bidding_strategy: 'maximize_clicks',
                target_cpa: null,
                negative_keyword_list_ids: [],
                ad_groups: {},
                approved: false
            };

            // Initialize ad groups for each service
            industryInfo.services.forEach(service => {
                const serviceKeywords = serverData.google_keywords[service.id] || [];

                const adGroupKeywords = serviceKeywords.map(kw => ({
                    id: kw.id,
                    keyword: kw.keyword_text,
                    match_type: kw.match_type,
                    is_primary: kw.is_primary
                }));

                campaignConfig.campaigns[industryId].ad_groups[service.id] = {
                    service_id: service.id,
                    service_name: service.name,
                    keywords: adGroupKeywords,
                    headlines: [],
                    descriptions: [],
                    approved: false
                };
            });
        }

        // Add to campaign keys list
        allCampaignKeys.push({ type: 'industry', id: industryId, name: industryInfo.name });
    });

    // Add GEO campaigns
    if (campaignConfig.geo_config && campaignConfig.geo_config.create_byside_urls &&
        campaignConfig.geo_config.byside_urls_by_service &&
        Object.keys(campaignConfig.geo_config.byside_urls_by_service).length > 0) {

        if (!campaignConfig.geo_campaigns) {
            campaignConfig.geo_campaigns = {};
        }

        Object.entries(campaignConfig.geo_config.byside_urls_by_service).forEach(([serviceId, urls]) => {
            if (!urls || urls.length === 0) return;

            const serviceName = urls[0]?.serviceName || 'Service';

            if (!campaignConfig.geo_campaigns[serviceId]) {
                campaignConfig.geo_campaigns[serviceId] = {
                    name: `${serviceName} - GEO Kampagne`,
                    daily_budget: '',
                    bidding_strategy: 'maximize_clicks',
                    target_cpa: null,
                    match_type: 'phrase',
                    negative_keyword_list_ids: [],
                    serviceId: serviceId,
                    serviceName: serviceName,
                    approved: false,
                    ad_group: {
                        name: 'GEO Annoncegruppe',
                        keywords: urls.map(item => ({
                            keyword: item.keyword,
                            url: item.url,
                            city: item.city,
                            match_type: 'phrase'
                        }))
                    }
                };
            }

            // Add to campaign keys list
            allCampaignKeys.push({ type: 'geo', id: serviceId, name: `${serviceName} - GEO` });
        });

        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[firstServiceId];
        }
    }

    // Render sidebar navigation
    renderCampaignSidebar();

    // Set first campaign as active
    if (allCampaignKeys.length > 0 && !activeCampaignKey) {
        setActiveCampaign(allCampaignKeys[0]);
    }

    // Setup event handlers
    setupStep5EventHandlers();
}

// Render sidebar navigation
function renderCampaignSidebar() {
    const sidebarContainer = $('#campaign-nav-list');
    sidebarContainer.empty();

    if (allCampaignKeys.length === 0) {
        sidebarContainer.html('<p class="text-gray-400 text-sm text-center py-4">Ingen kampagner</p>');
        return;
    }

    allCampaignKeys.forEach((campaignKey, index) => {
        const isActive = activeCampaignKey && activeCampaignKey.type === campaignKey.type && activeCampaignKey.id === campaignKey.id;
        const completion = calculateCampaignCompletion(campaignKey);
        const isGeo = campaignKey.type === 'geo';

        // Use design system colors - gradient progress bar style
        const progressColor = completion.percent === 100 ? '#10b981' :
                             completion.percent >= 50 ? '#8b5cf6' : '#9ca3af';

        const html = `
            <div class="campaign-nav-item selection-card cursor-pointer rounded-xl p-4 mb-3 ${isActive ? 'selected' : ''}"
                 data-campaign-type="${campaignKey.type}" data-campaign-id="${campaignKey.id}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background: linear-gradient(135deg, ${isGeo ? '#d1fae5' : '#ede9fe'}, ${isGeo ? '#a7f3d0' : '#ddd6fe'});">
                            ${isGeo ? 'üåç' : 'üè¢'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(campaignKey.name)}</p>
                            <p class="text-xs text-gray-500">${completion.adGroupCount} annoncegruppe${completion.adGroupCount !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                </div>
                <!-- Progress bar -->
                <div class="progress-bar-container mt-2" style="height: 4px;">
                    <div class="progress-bar" style="width: ${completion.percent}%; background: linear-gradient(90deg, #8b5cf6, #ec4899);"></div>
                </div>
                <p class="text-xs text-gray-400 mt-1 text-right">${completion.percent}% komplet</p>
            </div>
        `;
        sidebarContainer.append(html);
    });
}

// Calculate campaign completion status
function calculateCampaignCompletion(campaignKey) {
    let total = 0;
    let completed = 0;
    let adGroupCount = 0;

    if (campaignKey.type === 'industry') {
        const campaign = campaignConfig.campaigns[campaignKey.id];
        if (campaign && campaign.ad_groups) {
            adGroupCount = Object.keys(campaign.ad_groups).length;
            Object.values(campaign.ad_groups).forEach(adGroup => {
                total += 3; // keywords, headlines, descriptions
                if (adGroup.keywords && adGroup.keywords.length > 0) completed++;
                if (adGroup.headlines && adGroup.headlines.length >= 3) completed++;
                if (adGroup.descriptions && adGroup.descriptions.length >= 2) completed++;
            });
        }
    } else if (campaignKey.type === 'geo') {
        const geoCampaign = campaignConfig.geo_campaigns[campaignKey.id];
        if (geoCampaign) {
            adGroupCount = 1;
            total = 1; // keywords
            if (geoCampaign.ad_group && geoCampaign.ad_group.keywords && geoCampaign.ad_group.keywords.length > 0) {
                completed = 1;
            }
        }
    }

    return {
        percent: total > 0 ? Math.round((completed / total) * 100) : 0,
        completed,
        total,
        adGroupCount
    };
}

// Set active campaign and render its content
function setActiveCampaign(campaignKey) {
    activeCampaignKey = campaignKey;

    // Update sidebar selection
    $('.campaign-nav-item').removeClass('bg-purple-100 border-2 border-purple-500').addClass('bg-white border border-gray-200');
    $(`.campaign-nav-item[data-campaign-type="${campaignKey.type}"][data-campaign-id="${campaignKey.id}"]`)
        .removeClass('bg-white border border-gray-200')
        .addClass('bg-purple-100 border-2 border-purple-500');

    // Render active campaign content
    renderActiveCampaignContent(campaignKey);
}

// Render active campaign content in main area
function renderActiveCampaignContent(campaignKey) {
    const contentContainer = $('#active-campaign-content');
    contentContainer.empty();

    if (campaignKey.type === 'industry') {
        const campaign = campaignConfig.campaigns[campaignKey.id];
        const industryData = fetchedIndustryData[campaignKey.id];
        const services = industryData?.services?.filter(s => campaignConfig.service_ids.includes(s.id)) || [];

        const html = renderIndustryCampaignContent(campaignKey.id, campaign, services);
        contentContainer.html(html);
    } else if (campaignKey.type === 'geo') {
        const geoCampaign = campaignConfig.geo_campaigns[campaignKey.id];
        const html = renderGeoCampaignContent(campaignKey.id, geoCampaign);
        contentContainer.html(html);
    }

    // Setup content-specific event handlers
    setupCampaignContentHandlers();
}

// Render industry campaign content
function renderIndustryCampaignContent(industryId, campaign, services) {
    const adGroupsHtml = services.map(service => {
        const adGroup = campaign.ad_groups[service.id] || { keywords: [], headlines: [], descriptions: [] };
        return renderAdGroupCard(industryId, service.id, adGroup, service.name);
    }).join('');

    return `
        <div class="campaign-detail" data-industry-id="${industryId}">
            <!-- Campaign Header Card -->
            <div class="wizard-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-lg" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(campaign.industry_name)}</h3>
                            <p class="text-sm text-gray-500">${Object.keys(campaign.ad_groups).length} annoncegruppe${Object.keys(campaign.ad_groups).length !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                    <button type="button" class="approve-campaign-btn px-5 py-2.5 rounded-xl font-medium transition-all duration-200 ${campaign.approved ? 'text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                            style="${campaign.approved ? 'background: linear-gradient(90deg, #10b981, #059669);' : ''}"
                            data-industry-id="${industryId}">
                        ${campaign.approved ? '‚úì Godkendt' : 'Godkend Kampagne'}
                    </button>
                </div>

                <!-- Budget & Strategy -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dagligt Budget (DKK)</label>
                        <input type="number" class="campaign-daily-budget w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${campaign.daily_budget}" data-industry-id="${industryId}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bidding Strategi</label>
                        <select class="campaign-bidding-strategy w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-industry-id="${industryId}">
                            <option value="maximize_clicks" ${campaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                            <option value="maximize_conversions" ${campaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                            <option value="target_cpa" ${campaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                            <option value="manual_cpc" ${campaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                        </select>
                    </div>
                    <div class="target-cpa-field" style="display: ${campaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target CPA (DKK)</label>
                        <input type="number" class="campaign-target-cpa w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${campaign.target_cpa || ''}" data-industry-id="${industryId}">
                    </div>
                </div>

                <!-- Negative Keywords as Chips -->
                <div class="border-t border-gray-100 pt-5">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="neg-keyword-chips-container flex flex-wrap gap-2" data-industry-id="${industryId}" data-campaign-type="industry">
                        ${renderNegativeKeywordChips(campaign.negative_keyword_list_ids, industryId, 'industry')}
                    </div>
                </div>
            </div>

            <!-- Ad Groups Grid -->
            <h4 class="font-semibold text-gray-900 mb-4 text-lg">Annoncegrupper</h4>
            <div class="ad-groups-grid grid grid-cols-1 lg:grid-cols-2 gap-4">
                ${adGroupsHtml}
            </div>
        </div>
    `;
}

// Render ad group card
function renderAdGroupCard(industryId, serviceId, adGroup, serviceName) {
    const keywordCount = adGroup.keywords?.length || 0;
    const headlineCount = adGroup.headlines?.length || 0;
    const descriptionCount = adGroup.descriptions?.length || 0;

    // Calculate progress
    const totalItems = 3;
    let completedItems = 0;
    if (keywordCount > 0) completedItems++;
    if (headlineCount >= 3) completedItems++;
    if (descriptionCount >= 2) completedItems++;
    const progressPercent = Math.round((completedItems / totalItems) * 100);

    // Check if this ad group is the active template (use == for type-agnostic comparison)
    const isTemplate = campaignConfig.template_ad_group.industry_id == industryId &&
                       campaignConfig.template_ad_group.service_id == serviceId;

    return `
        <div class="ad-group-card selection-card rounded-xl p-6 ${isTemplate ? 'ring-2 ring-purple-400' : ''}"
             data-industry-id="${industryId}" data-service-id="${serviceId}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-11 h-11 rounded-xl flex items-center justify-center text-lg shadow-sm" style="background: linear-gradient(135deg, ${isTemplate ? '#f3e8ff, #e9d5ff' : '#dbeafe, #bfdbfe'});">
                        ${isTemplate ? 'üìã' : 'üîß'}
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-900 flex items-center">
                            ${escapeHtml(serviceName)}
                            ${isTemplate ? '<span class="ml-2 px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">Template</span>' : ''}
                        </h5>
                        <p class="text-xs text-gray-500">${progressPercent}% komplet</p>
                    </div>
                </div>
                <button type="button" class="edit-ad-group-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md"
                        style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;"
                        data-industry-id="${industryId}" data-service-id="${serviceId}">
                    Rediger
                </button>
            </div>

            <!-- Progress bar -->
            <div class="progress-bar-container mb-4" style="height: 4px;">
                <div class="progress-bar" style="width: ${progressPercent}%; background: linear-gradient(90deg, #8b5cf6, #ec4899);"></div>
            </div>

            <!-- Status Checklist -->
            <div class="space-y-2.5 text-sm">
                <div class="flex items-center justify-between ${keywordCount > 0 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${keywordCount > 0 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                            ${keywordCount > 0 ? '‚úì' : ''}
                        </span>
                        S√∏geord
                    </span>
                    <span class="font-medium text-gray-600">${keywordCount}</span>
                </div>
                <div class="flex items-center justify-between ${headlineCount >= 3 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${headlineCount >= 3 ? 'bg-green-100 text-green-600' : headlineCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400'}">
                            ${headlineCount >= 3 ? '‚úì' : headlineCount > 0 ? '!' : ''}
                        </span>
                        Headlines
                    </span>
                    <span class="font-medium text-gray-600">${headlineCount}/15</span>
                </div>
                <div class="flex items-center justify-between ${descriptionCount >= 2 ? 'text-gray-900' : 'text-gray-400'}">
                    <span class="flex items-center">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs mr-2 ${descriptionCount >= 2 ? 'bg-green-100 text-green-600' : descriptionCount > 0 ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-400'}">
                            ${descriptionCount >= 2 ? '‚úì' : descriptionCount > 0 ? '!' : ''}
                        </span>
                        Beskrivelser
                    </span>
                    <span class="font-medium text-gray-600">${descriptionCount}/4</span>
                </div>
            </div>
        </div>
    `;
}

// Render GEO campaign content
function renderGeoCampaignContent(serviceId, geoCampaign) {
    const keywordCount = geoCampaign.ad_group?.keywords?.length || 0;

    let keywordsHtml = '';
    if (geoCampaign.ad_group && geoCampaign.ad_group.keywords) {
        geoCampaign.ad_group.keywords.slice(0, 10).forEach((kw, index) => {
            keywordsHtml += `
                <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #d1fae520, #d1fae510);">
                    <span class="font-medium text-gray-900">${escapeHtml(kw.keyword)}</span>
                    <span class="text-xs text-emerald-600 truncate max-w-xs">${escapeHtml(kw.url || '')}</span>
                </div>
            `;
        });
        if (geoCampaign.ad_group.keywords.length > 10) {
            keywordsHtml += `<p class="text-sm text-gray-500 text-center py-2">+ ${geoCampaign.ad_group.keywords.length - 10} flere s√∏geord</p>`;
        }
    }

    return `
        <div class="geo-campaign-detail" data-service-id="${serviceId}">
            <!-- Campaign Header Card -->
            <div class="wizard-card p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-lg" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                            üåç
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(geoCampaign.name)}</h3>
                            <p class="text-sm text-gray-500">${keywordCount} geo-s√∏geord</p>
                        </div>
                    </div>
                    <span class="px-4 py-2 rounded-xl text-sm font-semibold text-emerald-700" style="background: linear-gradient(135deg, #d1fae520, #d1fae510);">GEO Kampagne</span>
                </div>

                <!-- Budget & Strategy -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dagligt Budget (DKK)</label>
                        <input type="number" class="geo-campaign-daily-budget w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                               min="1" value="${geoCampaign.daily_budget}" data-service-id="${serviceId}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bidding Strategi</label>
                        <select class="geo-campaign-bidding-strategy w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-service-id="${serviceId}">
                            <option value="maximize_clicks" ${geoCampaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                            <option value="maximize_conversions" ${geoCampaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                            <option value="target_cpa" ${geoCampaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                            <option value="manual_cpc" ${geoCampaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Match Type</label>
                        <select class="geo-campaign-match-type w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" data-service-id="${serviceId}">
                            <option value="phrase" ${geoCampaign.match_type === 'phrase' ? 'selected' : ''}>Phrase Match</option>
                            <option value="exact" ${geoCampaign.match_type === 'exact' ? 'selected' : ''}>Exact Match</option>
                        </select>
                    </div>
                </div>

                <!-- Negative Keywords as Chips -->
                <div class="border-t border-gray-100 pt-5">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="neg-keyword-chips-container flex flex-wrap gap-2" data-service-id="${serviceId}" data-campaign-type="geo">
                        ${renderNegativeKeywordChips(geoCampaign.negative_keyword_list_ids, serviceId, 'geo')}
                    </div>
                </div>
            </div>

            <!-- GEO Keywords Preview -->
            <div class="wizard-card p-6">
                <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üîë</span>
                    GEO S√∏geord (${keywordCount})
                </h4>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${keywordsHtml || '<p class="text-gray-500 text-center py-4">Ingen s√∏geord</p>'}
                </div>
            </div>
        </div>
    `;
}

// Render negative keyword chips (clickable selection like Industry Manager)
function renderNegativeKeywordChips(selectedIds, entityId, campaignType) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-gray-500 text-sm">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    return serverData.negative_keyword_lists.map(list => {
        const isSelected = selectedIds.includes(list.id);
        // Use design system purple/pink colors instead of harsh red
        const selectedStyle = isSelected
            ? 'background: linear-gradient(135deg, #8b5cf620, #8b5cf610); border-color: #8b5cf6; color: #7c3aed;'
            : '';
        const selectedClass = isSelected
            ? 'selected'
            : 'bg-gray-50 border-gray-200 text-gray-600 hover:border-purple-300 hover:bg-purple-50';

        return `
            <button type="button"
                    class="neg-keyword-chip selection-card px-4 py-2.5 rounded-xl border-2 text-sm font-medium transition-all duration-200 cursor-pointer ${selectedClass}"
                    style="${selectedStyle}"
                    data-list-id="${list.id}"
                    data-entity-id="${entityId}"
                    data-campaign-type="${campaignType}">
                <span class="flex items-center space-x-2">
                    <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs ${isSelected ? 'bg-purple-100 text-purple-600' : 'bg-gray-100 text-gray-400'}">${isSelected ? '‚úì' : '+'}</span>
                    <span>${escapeHtml(list.name)}</span>
                    <span class="text-xs ${isSelected ? 'text-purple-400' : 'text-gray-400'}">(${list.keyword_count})</span>
                </span>
            </button>
        `;
    }).join('');
}

// Setup Step 5 event handlers
function setupStep5EventHandlers() {
    // Campaign nav click
    $(document).off('click', '.campaign-nav-item').on('click', '.campaign-nav-item', function() {
        const type = $(this).data('campaign-type');
        const id = $(this).data('campaign-id');
        setActiveCampaign({ type, id: String(id) });
    });

    // Batch approve all
    $('#batch-approve-all-btn').off('click').on('click', function() {
        // Approve all industry campaigns
        Object.keys(campaignConfig.campaigns).forEach(industryId => {
            campaignConfig.campaigns[industryId].approved = true;
            Object.values(campaignConfig.campaigns[industryId].ad_groups).forEach(ag => {
                ag.approved = true;
            });
        });
        // Approve all geo campaigns
        if (campaignConfig.geo_campaigns) {
            Object.keys(campaignConfig.geo_campaigns).forEach(serviceId => {
                campaignConfig.geo_campaigns[serviceId].approved = true;
            });
        }
        // Refresh UI
        renderCampaignSidebar();
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
        alert('Alle kampagner er godkendt!');
    });

    // Negative keyword chip click
    $(document).off('click', '.neg-keyword-chip').on('click', '.neg-keyword-chip', function() {
        const listId = parseInt($(this).data('list-id'));
        const entityId = $(this).data('entity-id');
        const campaignType = $(this).data('campaign-type');

        let selectedIds;
        if (campaignType === 'industry') {
            selectedIds = campaignConfig.campaigns[entityId].negative_keyword_list_ids;
        } else {
            selectedIds = campaignConfig.geo_campaigns[entityId].negative_keyword_list_ids;
        }

        const index = selectedIds.indexOf(listId);
        if (index > -1) {
            selectedIds.splice(index, 1);
        } else {
            selectedIds.push(listId);
        }

        // Re-render chips
        const container = $(this).closest('.neg-keyword-chips-container');
        container.html(renderNegativeKeywordChips(selectedIds, entityId, campaignType));
    });
}

// Setup campaign content handlers
function setupCampaignContentHandlers() {
    // Budget change
    $(document).off('change', '.campaign-daily-budget').on('change', '.campaign-daily-budget', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].daily_budget = $(this).val() ? parseInt($(this).val()) : '';
    });

    // Bidding strategy change
    $(document).off('change', '.campaign-bidding-strategy').on('change', '.campaign-bidding-strategy', function() {
        const industryId = $(this).data('industry-id');
        const strategy = $(this).val();
        campaignConfig.campaigns[industryId].bidding_strategy = strategy;

        const targetCpaField = $(this).closest('.campaign-detail').find('.target-cpa-field');
        if (strategy === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }
    });

    // Target CPA change
    $(document).off('change', '.campaign-target-cpa').on('change', '.campaign-target-cpa', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].target_cpa = parseInt($(this).val()) || null;
    });

    // GEO budget change
    $(document).off('change', '.geo-campaign-daily-budget').on('change', '.geo-campaign-daily-budget', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].daily_budget = $(this).val() ? parseInt($(this).val()) : '';
    });

    // GEO bidding strategy change
    $(document).off('change', '.geo-campaign-bidding-strategy').on('change', '.geo-campaign-bidding-strategy', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].bidding_strategy = $(this).val();
    });

    // GEO match type change
    $(document).off('change', '.geo-campaign-match-type').on('change', '.geo-campaign-match-type', function() {
        const serviceId = $(this).data('service-id');
        campaignConfig.geo_campaigns[serviceId].match_type = $(this).val();
    });

    // Approve campaign button
    $(document).off('click', '.approve-campaign-btn').on('click', '.approve-campaign-btn', function() {
        const industryId = $(this).data('industry-id');
        campaignConfig.campaigns[industryId].approved = !campaignConfig.campaigns[industryId].approved;

        if (campaignConfig.campaigns[industryId].approved) {
            $(this).removeClass('bg-gray-100 text-gray-700 hover:bg-green-100').addClass('bg-green-500 text-white');
            $(this).html('‚úì Godkendt');
        } else {
            $(this).removeClass('bg-green-500 text-white').addClass('bg-gray-100 text-gray-700 hover:bg-green-100');
            $(this).html('Godkend Kampagne');
        }

        renderCampaignSidebar();
    });

    // Edit ad group button - open slide panel
    $(document).off('click', '.edit-ad-group-btn').on('click', '.edit-ad-group-btn', function() {
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        openAdGroupEditPanel(industryId, serviceId);
    });
}

// Open ad group edit slide panel
function openAdGroupEditPanel(industryId, serviceId) {
    const campaign = campaignConfig.campaigns[industryId];
    const adGroup = campaign.ad_groups[serviceId];

    // Create slide panel HTML with design system styling
    const panelHtml = `
        <div id="ad-group-edit-panel" class="fixed inset-0 z-50">
            <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="panel-overlay"></div>
            <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-white shadow-2xl transform transition-transform duration-300" id="panel-content" style="border-radius: 24px 0 0 24px;">
                <div class="h-full flex flex-col">
                    <!-- Panel Header -->
                    <div class="p-6 border-b border-gray-100" style="background: linear-gradient(135deg, #f3e8ff, #fce7f3);">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-lg" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                                    üîß
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${escapeHtml(adGroup.service_name)}</h3>
                                    <p class="text-sm text-gray-500">Rediger annoncegruppe</p>
                                </div>
                            </div>
                            <button type="button" class="close-panel-btn w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb);">
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Panel Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Template Checkbox -->
                        <div class="flex items-center justify-between mb-6 p-4 rounded-xl border-2 transition-all duration-200 ${campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId ? 'bg-purple-50 border-purple-300' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="use-as-template" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" ${campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId ? 'checked' : ''}>
                                <label for="use-as-template" class="text-sm font-medium text-gray-700 cursor-pointer">
                                    Brug som template for andre annoncegrupper
                                </label>
                            </div>
                            ${campaignConfig.template_ad_group.source_service_name ? '<span class="text-xs text-purple-600 font-medium">Aktiv template: ' + campaignConfig.template_ad_group.source_service_name + '</span>' : ''}
                        </div>

                        <!-- Keywords Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">üîë</span>
                                    S√∏geord (${adGroup.keywords.length})
                                </h4>
                                <button type="button" class="add-keyword-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                    + Tilf√∏j
                                </button>
                            </div>
                            <div class="panel-keywords-list space-y-2 max-h-48 overflow-y-auto" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelKeywordsList(adGroup.keywords, serviceId)}
                            </div>
                            <div class="add-keyword-form hidden mt-3 p-4 rounded-xl" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                                <div class="flex items-center space-x-2">
                                    <input type="text" class="new-keyword-input flex-1 px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" placeholder="Nyt s√∏geord...">
                                    <select class="new-keyword-match-type px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                        <option value="broad">Broad</option>
                                        <option value="phrase">Phrase</option>
                                        <option value="exact">Exact</option>
                                    </select>
                                    <button type="button" class="save-new-keyword-btn px-4 py-2.5 rounded-xl font-medium text-white transition-all duration-200 hover:shadow-lg" style="background: linear-gradient(90deg, #8b5cf6, #ec4899);">Gem</button>
                                    <button type="button" class="cancel-keyword-btn px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all">Annuller</button>
                                </div>
                            </div>
                        </div>

                        <!-- Headlines Section -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center headlines-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">üì∞</span>
                                    Headlines (<span class="headlines-count">${adGroup.headlines.length}</span>/15)
                                </h4>
                                <div class="flex space-x-2">
                                    ${campaignConfig.template_ad_group.industry_id && !(campaignConfig.template_ad_group.industry_id === industryId && campaignConfig.template_ad_group.service_id === serviceId) ?
                                        '<button type="button" class="apply-template-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e;" title="Kopier headlines og beskrivelser fra ' + campaignConfig.template_ad_group.source_service_name + '">üìã Hent fra template</button>' : ''}
                                    <button type="button" class="shuffle-headlines-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;">
                                        üîÄ Shuffle
                                    </button>
                                    <button type="button" class="add-headline-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="panel-headlines-list space-y-2" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines)}
                            </div>
                        </div>

                        <!-- Descriptions Section -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold text-gray-900 flex items-center descriptions-section-header">
                                    <span class="w-7 h-7 rounded-lg mr-2 flex items-center justify-center text-sm" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">üìù</span>
                                    Beskrivelser (<span class="descriptions-count">${adGroup.descriptions.length}</span>/4)
                                </h4>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="generate-ai-descriptions-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md flex items-center gap-2" style="background: linear-gradient(135deg, #8b5cf620, #a78bfa20); color: #7c3aed;">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                        Generer med AI
                                    </button>
                                    <button type="button" class="add-description-panel-btn text-sm px-4 py-2 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #d1fae520, #a7f3d020); color: #059669;">
                                        + Tilf√∏j
                                    </button>
                                </div>
                            </div>
                            <div class="panel-descriptions-list space-y-2" data-industry-id="${industryId}" data-service-id="${serviceId}">
                                ${renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions)}
                            </div>
                        </div>
                    </div>

                    <!-- Panel Footer -->
                    <div class="p-6 border-t border-gray-100" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="close-panel-btn px-6 py-2.5 rounded-xl font-medium transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed;">
                                Luk
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing panel first
    $('#ad-group-edit-panel').remove();

    // Add panel directly to document body (outside wizard form)
    $(document.body).append(panelHtml);

    // Force panel to be visible by ensuring correct styles
    setTimeout(() => {
        const panel = document.getElementById('ad-group-edit-panel');
        if (panel) {
            panel.style.position = 'fixed';
            panel.style.top = '0';
            panel.style.left = '0';
            panel.style.right = '0';
            panel.style.bottom = '0';
            panel.style.zIndex = '9999';
        }
    }, 10);

    // Setup panel event handlers
    setupPanelEventHandlers(industryId, serviceId);
}

// Render panel keywords list
function renderPanelKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen s√∏geord</p>';
    }

    return keywords.map((kw, index) => `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
            <div class="flex items-center space-x-2">
                <span class="text-gray-900 font-medium">${escapeHtml(kw.keyword)}</span>
                <span class="text-xs px-2.5 py-1 rounded-lg font-medium" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8;">${kw.match_type}</span>
            </div>
            <button type="button" class="remove-keyword-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
        </div>
    `).join('');
}

// Render panel headlines list
function renderPanelHeadlinesList(industryId, serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen headlines. Klik "Shuffle" for at generere.</p>';
    }

    // Create array with original indices for sorting
    const headlinesWithIndices = headlines.map((headline, index) => ({
        headline,
        originalIndex: index
    }));

    // Sort: unlocked first, locked at the bottom
    headlinesWithIndices.sort((a, b) => {
        const aLocked = typeof a.headline === 'object' ? a.headline.locked : false;
        const bLocked = typeof b.headline === 'object' ? b.headline.locked : false;
        if (aLocked === bLocked) return 0;
        return aLocked ? 1 : -1;  // Locked items go to the end
    });

    return headlinesWithIndices.map(({ headline, originalIndex }) => {
        // Support both old strings and new objects
        const text = typeof headline === 'string' ? headline : headline.text;
        const locked = typeof headline === 'object' ? headline.locked : false;

        return `
        <div class="flex items-center justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm ${locked ? 'ring-2 ring-purple-400' : ''}" style="background: linear-gradient(135deg, ${locked ? '#f3e8ff, #ede9fe' : '#f9fafb, #f3f4f6'});">
            <div class="flex items-center space-x-2 flex-1 min-w-0">
                <button type="button" class="lock-headline-btn w-8 h-8 shrink-0 rounded-lg flex items-center justify-center transition-all ${locked ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}" data-index="${originalIndex}" title="${locked ? 'Klik for at l√•se op' : 'Klik for at fryse denne headline'}">
                    ${locked ? 'üîí' : 'üîì'}
                </button>
                <input type="text" class="headline-input flex-1 min-w-0 px-3 py-1.5 border border-transparent rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 bg-transparent hover:bg-white transition-all"
                       value="${escapeHtml(text)}" data-index="${originalIndex}" maxlength="30">
            </div>
            <div class="flex items-center space-x-1 ml-2 shrink-0">
                <span class="text-xs text-gray-400 headline-char-count w-10">${text.length}/30</span>
                <button type="button" class="remove-headline-btn w-6 h-6 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${originalIndex}">√ó</button>
            </div>
        </div>
    `}).join('');
}

// Render panel descriptions list
function renderPanelDescriptionsList(industryId, serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-500 text-sm text-center py-2">Ingen beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="flex items-start justify-between p-3 rounded-xl transition-all duration-200 hover:shadow-sm" style="background: linear-gradient(135deg, #f9fafb, #f3f4f6);">
            <textarea class="description-input flex-1 px-3 py-1.5 border border-transparent rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 bg-transparent hover:bg-white transition-all resize-none overflow-hidden"
                   data-index="${index}" maxlength="90" rows="1" style="min-height: 36px;">${escapeHtml(desc)}</textarea>
            <div class="flex items-center space-x-2 ml-2 mt-1">
                <span class="text-xs text-gray-400 desc-char-count">${desc.length}/90</span>
                <button type="button" class="remove-description-btn w-7 h-7 rounded-lg flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-all" data-index="${index}">√ó</button>
            </div>
        </div>
    `).join('');
}

// Apply template headlines and descriptions to target ad group
function applyTemplateToAdGroup(targetIndustryId, targetServiceId) {
    const template = campaignConfig.template_ad_group;

    // Check if there's an active template
    if (!template.industry_id || !template.service_id) {
        console.log('No template set');
        return;
    }

    // Get source and target ad groups
    const sourceAdGroup = campaignConfig.campaigns[template.industry_id].ad_groups[template.service_id];
    const targetAdGroup = campaignConfig.campaigns[targetIndustryId].ad_groups[targetServiceId];

    if (!sourceAdGroup || !targetAdGroup) {
        console.error('Source or target ad group not found');
        return;
    }

    const sourceServiceName = template.source_service_name;
    const targetServiceName = targetAdGroup.service_name;

    console.log('Applying template from', sourceServiceName, 'to', targetServiceName);

    // Copy headlines with service name substitution
    targetAdGroup.headlines = sourceAdGroup.headlines.map(h => {
        const text = typeof h === 'object' ? h.text : h;
        // Case-insensitive replacement of service name
        const substituted = text.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
        return { text: substituted, locked: false };
    });

    // Copy descriptions with service name substitution
    targetAdGroup.descriptions = sourceAdGroup.descriptions.map(desc => {
        return desc.replace(new RegExp(escapeRegExp(sourceServiceName), 'gi'), targetServiceName);
    });

    console.log('Template applied successfully. Headlines:', targetAdGroup.headlines.length, 'Descriptions:', targetAdGroup.descriptions.length);
}

// Escape special regex characters
function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Setup panel event handlers
function setupPanelEventHandlers(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Remove any existing document-level event handlers for panel elements
    $(document).off('click', '.close-panel-btn, #panel-overlay');
    $(document).off('click', '.remove-keyword-btn');
    $(document).off('click', '.lock-headline-btn');
    $(document).off('input', '.headline-input');
    $(document).off('input', '.description-input');
    $(document).off('click', '.remove-headline-btn');
    $(document).off('click', '.remove-description-btn');

    // Close panel
    $(document).on('click', '.close-panel-btn, #panel-overlay', function() {
        // Auto-save state when closing panel to preserve changes
        saveStateToStorage();
        $('#ad-group-edit-panel').remove();
        // Refresh the ad group card
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
    });

    // Add keyword
    $('.add-keyword-panel-btn').on('click', function() {
        $('.add-keyword-form').removeClass('hidden');
    });

    $('.cancel-keyword-btn').on('click', function() {
        $('.add-keyword-form').addClass('hidden');
        $('.new-keyword-input').val('');
    });

    $('.save-new-keyword-btn').on('click', function() {
        const keyword = $('.new-keyword-input').val().trim();
        const matchType = $('.new-keyword-match-type').val();

        if (keyword) {
            adGroup.keywords.push({
                keyword: keyword,
                match_type: matchType,
                is_primary: false
            });

            // Re-render keywords list
            $('.panel-keywords-list').html(renderPanelKeywordsList(adGroup.keywords, serviceId));
            $('.add-keyword-form').addClass('hidden');
            $('.new-keyword-input').val('');

            // Update header count
            $('h4:contains("S√∏geord")').html(`
                <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üîë</span>
                S√∏geord (${adGroup.keywords.length})
            `);
        }
    });

    // Remove keyword
    $(document).on('click', '.remove-keyword-btn', function() {
        const index = $(this).data('index');
        adGroup.keywords.splice(index, 1);
        $('.panel-keywords-list').html(renderPanelKeywordsList(adGroup.keywords, serviceId));
    });

    // Shuffle headlines - use the global shuffleHeadlines function that reads example_headlines
    $('.shuffle-headlines-panel-btn').on('click', function() {
        // Call the global shuffleHeadlines function which:
        // 1. Gets example_headlines from each selected USP's data attribute
        // 2. Picks 1 random headline per USP
        // 3. Adds custom USPs 1:1
        // 4. Shuffles and limits to 15
        shuffleHeadlines(industryId, serviceId);

        // Re-render the panel headlines list with the updated data
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Add headline
    $('.add-headline-panel-btn').on('click', function() {
        if (adGroup.headlines.length < 15) {
            adGroup.headlines.push('');
            $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
            // Update headline counter
            $('.headlines-count').text(adGroup.headlines.length);
            // Focus the new input
            $('.panel-headlines-list .headline-input').last().focus();
        }
    });

    // Update headline on input - handles both strings and objects
    $(document).on('input', '.headline-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();

        // Handle both strings and objects
        if (typeof adGroup.headlines[index] === 'string') {
            adGroup.headlines[index] = value;
        } else {
            adGroup.headlines[index].text = value;
        }

        // Update character counter with color feedback
        const charCount = $(this).closest('div[class*="p-3"]').find('.headline-char-count');
        charCount.text(`${value.length}/30`);
        charCount.removeClass('text-gray-400 text-yellow-500 text-red-500');
        if (value.length > 30) {
            charCount.addClass('text-red-500 font-medium');
        } else if (value.length > 25) {
            charCount.addClass('text-yellow-500');
        } else {
            charCount.addClass('text-gray-400');
        }
    });

    // Remove headline
    $(document).on('click', '.remove-headline-btn', function() {
        const index = $(this).data('index');
        adGroup.headlines.splice(index, 1);
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Toggle headline lock
    $(document).on('click', '.lock-headline-btn', function() {
        const index = $(this).data('index');
        const headline = adGroup.headlines[index];

        // Convert to object if necessary
        if (typeof headline === 'string') {
            adGroup.headlines[index] = { text: headline, locked: true };
        } else {
            adGroup.headlines[index].locked = !headline.locked;
        }

        // Re-render the list
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
    });

    // Template checkbox handler
    $('#use-as-template').on('change', function() {
        if ($(this).is(':checked')) {
            // Set this ad group as the template
            campaignConfig.template_ad_group = {
                industry_id: industryId,
                service_id: serviceId,
                source_service_name: adGroup.service_name
            };
            console.log('Template set:', campaignConfig.template_ad_group);
        } else {
            // Only clear if this is the current template
            if (campaignConfig.template_ad_group.industry_id === industryId &&
                campaignConfig.template_ad_group.service_id === serviceId) {
                campaignConfig.template_ad_group = {
                    industry_id: null,
                    service_id: null,
                    source_service_name: null
                };
                console.log('Template cleared');
            }
        }
        // Re-render the campaign content to update template badge on ad group cards
        if (activeCampaignKey) {
            renderActiveCampaignContent(activeCampaignKey);
        }
    });

    // Apply template button handler
    $('.apply-template-btn').on('click', function() {
        applyTemplateToAdGroup(industryId, serviceId);
        // Re-render both lists
        $('.panel-headlines-list').html(renderPanelHeadlinesList(industryId, serviceId, adGroup.headlines));
        $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
        // Update headline counter
        $('.headlines-count').text(adGroup.headlines.length);
    });

    // Add description
    $('.add-description-panel-btn').on('click', function() {
        if (adGroup.descriptions.length < 4) {
            adGroup.descriptions.push('');
            $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
            $('.panel-descriptions-list .description-input').last().focus();
        }
    });

    // Generate descriptions with AI
    $('.generate-ai-descriptions-btn').on('click', async function() {
        const btn = $(this);
        const originalHtml = btn.html();

        // Loading state
        btn.prop('disabled', true);
        btn.html(`
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            <span>Genererer...</span>
        `);

        try {
            // Collect USP texts from selected USP templates
            const uspTexts = [];
            campaignConfig.usp_ids.forEach(uspId => {
                // First try to get custom edited text, then display text, then original text from data attribute
                const uspCheckbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
                if (uspCheckbox.length) {
                    // Check if there's a custom text for this USP
                    if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
                        uspTexts.push(campaignConfig.usp_custom_texts[uspId]);
                    } else {
                        // Get the display text from .usp-display-text or fallback to original text
                        const uspItem = uspCheckbox.closest('.usp-item');
                        const displayText = uspItem.find('.usp-display-text').text().trim();
                        if (displayText) {
                            uspTexts.push(displayText);
                        } else {
                            // Fallback to data attribute
                            const originalText = uspCheckbox.data('original-text');
                            if (originalText) uspTexts.push(originalText);
                        }
                    }
                }
            });

            // Also add custom USPs added by user
            if (campaignConfig.custom_usps && campaignConfig.custom_usps.length > 0) {
                campaignConfig.custom_usps.forEach(usp => {
                    if (usp && usp.trim()) uspTexts.push(usp.trim());
                });
            }

            // Get keywords - extract keyword text from objects
            const keywordObjects = adGroup.keywords || [];
            const keywordStrings = keywordObjects.map(kw => typeof kw === 'string' ? kw : kw.keyword);

            // Get industry name
            const campaign = campaignConfig.campaigns[industryId];
            const industryName = campaign ? campaign.industry_name : '';

            const response = await fetch('/ajax/generate-descriptions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    service_name: adGroup.service_name,
                    industry_name: industryName,
                    usps: uspTexts,
                    keywords: keywordStrings.slice(0, 10)
                })
            });

            const data = await response.json();

            if (data.success) {
                // Replace descriptions with AI-generated ones
                adGroup.descriptions = data.descriptions;
                $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));

                // Update the descriptions count in the header
                $('.descriptions-count').text(adGroup.descriptions.length);

                // Success feedback
                showToast('4 beskrivelser genereret med AI!', 'success');
            } else {
                showToast('Fejl: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('AI generation error:', error);
            showToast('Kunne ikke generere beskrivelser', 'error');
        } finally {
            btn.prop('disabled', false);
            btn.html(originalHtml);
        }
    });

    // Update description on input
    $(document).on('input', '.description-input', function() {
        const index = $(this).data('index');
        const value = $(this).val();
        adGroup.descriptions[index] = value;

        // Auto-resize textarea
        this.style.height = 'auto';
        this.style.height = Math.max(36, this.scrollHeight) + 'px';

        // Update character counter with color feedback
        const charCount = $(this).closest('div[class*="p-3"]').find('.desc-char-count');
        charCount.text(`${value.length}/90`);
        charCount.removeClass('text-gray-400 text-yellow-500 text-red-500 font-medium');
        if (value.length > 90) {
            charCount.addClass('text-red-500 font-medium');
        } else if (value.length > 75) {
            charCount.addClass('text-yellow-500');
        } else {
            charCount.addClass('text-gray-400');
        }
    });

    // Auto-resize description textareas on initial load
    $(document).on('focus', '.description-input', function() {
        this.style.height = 'auto';
        this.style.height = Math.max(36, this.scrollHeight) + 'px';
    });

    // Remove description
    $(document).on('click', '.remove-description-btn', function() {
        const index = $(this).data('index');
        adGroup.descriptions.splice(index, 1);
        $('.panel-descriptions-list').html(renderPanelDescriptionsList(industryId, serviceId, adGroup.descriptions));
    });
}

// Render GEO campaign accordion - now accepts serviceId for multiple campaigns
function renderGeoCampaignAccordion(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    const keywordCount = geoCampaign.ad_group.keywords.length;

    let keywordsHtml = '';
    geoCampaign.ad_group.keywords.forEach((kw, index) => {
        keywordsHtml += `
            <div class="geo-keyword-item flex items-center justify-between p-2 bg-white rounded border border-gray-200 mb-2" data-index="${index}" data-service-id="${serviceId}">
                <div class="flex-1">
                    <span class="font-medium text-gray-900">${escapeHtml(kw.keyword)}</span>
                    <span class="match-type-badge text-xs text-gray-500 ml-2">[${kw.match_type}]</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-blue-600 truncate max-w-xs" title="${escapeHtml(kw.url)}">${escapeHtml(kw.url)}</span>
                </div>
            </div>
        `;
    });

    let html = `
        <div class="campaign-accordion geo-campaign-accordion bg-white rounded-2xl shadow-lg border border-green-200 overflow-hidden mb-4" data-campaign-type="geo" data-service-id="${serviceId}">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #10B98120, #10B98110);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-green-600 to-emerald-600">
                            üåç
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${escapeHtml(geoCampaign.name)}</h3>
                            <p class="text-sm text-gray-600">${keywordCount} geo-s√∏geord med URL'er</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">GEO</span>
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="geo-campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" value="${geoCampaign.daily_budget}" data-service-id="${serviceId}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="geo-campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-service-id="${serviceId}">
                                <option value="maximize_clicks" ${geoCampaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                                <option value="maximize_conversions" ${geoCampaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                                <option value="target_cpa" ${geoCampaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                                <option value="manual_cpc" ${geoCampaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                            </select>
                        </div>
                        <div class="geo-target-cpa-field" style="display: ${geoCampaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};" data-service-id="${serviceId}">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="geo-campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" value="${geoCampaign.target_cpa || ''}" data-service-id="${serviceId}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keyword Match Type</label>
                            <select class="geo-campaign-match-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-service-id="${serviceId}">
                                <option value="phrase" ${geoCampaign.match_type === 'phrase' ? 'selected' : ''}>Phrase Match</option>
                                <option value="exact" ${geoCampaign.match_type === 'exact' ? 'selected' : ''}>Exact Match</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="geo-negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3" data-service-id="${serviceId}">
                        ${renderNegativeKeywordListsForGeo(geoCampaign.negative_keyword_list_ids, serviceId)}
                    </div>
                </div>

                <!-- GEO Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üîë</span>
                        GEO S√∏geord med URL'er
                    </h4>
                    <p class="text-sm text-gray-600 mb-4">
                        Hvert s√∏geord har sin egen landing page URL. Format: {service} {by} ‚Üí /{service}-{by}/
                    </p>
                    <div class="geo-keywords-container max-h-64 overflow-y-auto" data-service-id="${serviceId}">
                        ${keywordsHtml}
                    </div>
                </div>

                <!-- GEO Headlines Section -->
                <div class="p-6 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-yellow-100 text-yellow-700">üìù</span>
                            Headlines (<span class="geo-headlines-count" data-service-id="${serviceId}">${geoCampaign.ad_group.headlines?.length || 0}</span>/15)
                        </h4>
                        <div class="flex space-x-2">
                            <button type="button" class="geo-shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-service-id="${serviceId}">
                                üîÄ Shuffle
                            </button>
                            <button type="button" class="geo-add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-service-id="${serviceId}">
                                + Tilf√∏j
                            </button>
                        </div>
                    </div>
                    <div class="geo-headlines-list space-y-2" data-service-id="${serviceId}">
                        ${renderGeoHeadlinesList(serviceId, geoCampaign.ad_group.headlines || [])}
                    </div>
                </div>

                <!-- GEO Descriptions Section -->
                <div class="p-6 border-t border-gray-100">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-blue-100 text-blue-700">üìÑ</span>
                            Descriptions (<span class="geo-descriptions-count" data-service-id="${serviceId}">${geoCampaign.ad_group.descriptions?.length || 0}</span>/4)
                        </h4>
                        <button type="button" class="geo-add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-service-id="${serviceId}">
                            + Tilf√∏j
                        </button>
                    </div>
                    <div class="geo-descriptions-list space-y-2" data-service-id="${serviceId}">
                        ${renderGeoDescriptionsList(serviceId, geoCampaign.ad_group.descriptions || [])}
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

// Render negative keyword lists for GEO campaign - now accepts serviceId for multiple campaigns
function renderNegativeKeywordListsForGeo(selectedIds, serviceId) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-sm text-gray-500 col-span-2">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    let html = '';
    serverData.negative_keyword_lists.forEach(list => {
        const isChecked = selectedIds && selectedIds.includes(list.id);
        html += `
            <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                <input type="checkbox" class="geo-negative-list-checkbox w-4 h-4 text-green-600 rounded"
                       data-list-id="${list.id}" data-service-id="${serviceId}" ${isChecked ? 'checked' : ''}>
                <span class="ml-3 text-sm text-gray-700">${escapeHtml(list.name)}</span>
                <span class="ml-auto text-xs text-gray-400">${list.keyword_count || 0} ord</span>
            </label>
        `;
    });

    return html;
}

// Render GEO headlines list
function renderGeoHeadlinesList(serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Shuffle" for at auto-generere headlines fra USPs, eller "Tilf√∏j" for manuel tilf√∏jelse</p>';
    }

    return headlines.map((headline, index) => `
        <div class="geo-headline-item flex items-center space-x-2" data-service-id="${serviceId}">
            <input type="text" class="geo-headline-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent"
                   value="${escapeHtml(headline)}" maxlength="30" data-index="${index}" data-service-id="${serviceId}">
            <span class="text-xs text-gray-500 w-10">${headline.length}/30</span>
            <button type="button" class="remove-geo-headline-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}" data-service-id="${serviceId}">‚úï</button>
        </div>
    `).join('');
}

// Render GEO descriptions list
function renderGeoDescriptionsList(serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Tilf√∏j" for at tilf√∏je beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="geo-description-item flex items-center space-x-2" data-service-id="${serviceId}">
            <textarea class="geo-description-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                      maxlength="90" rows="2" data-index="${index}" data-service-id="${serviceId}">${escapeHtml(desc)}</textarea>
            <span class="text-xs text-gray-500 w-10">${desc.length}/90</span>
            <button type="button" class="remove-geo-description-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}" data-service-id="${serviceId}">‚úï</button>
        </div>
    `).join('');
}

// Add headline to GEO campaign
function addGeoHeadline(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    // Initialize headlines if not exists
    if (!geoCampaign.ad_group.headlines) {
        geoCampaign.ad_group.headlines = [];
    }

    if (geoCampaign.ad_group.headlines.length >= 15) {
        alert('Maksimalt 15 headlines per GEO kampagne.');
        return;
    }

    geoCampaign.ad_group.headlines.push('');
    refreshGeoHeadlinesList(serviceId);
}

// Add description to GEO campaign
function addGeoDescription(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    // Initialize descriptions if not exists
    if (!geoCampaign.ad_group.descriptions) {
        geoCampaign.ad_group.descriptions = [];
    }

    if (geoCampaign.ad_group.descriptions.length >= 4) {
        alert('Maksimalt 4 beskrivelser per GEO kampagne.');
        return;
    }

    geoCampaign.ad_group.descriptions.push('');
    refreshGeoDescriptionsList(serviceId);
}

// Remove headline from GEO campaign
function removeGeoHeadline(serviceId, index) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign || !geoCampaign.ad_group.headlines) return;

    geoCampaign.ad_group.headlines.splice(index, 1);
    refreshGeoHeadlinesList(serviceId);
}

// Remove description from GEO campaign
function removeGeoDescription(serviceId, index) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign || !geoCampaign.ad_group.descriptions) return;

    geoCampaign.ad_group.descriptions.splice(index, 1);
    refreshGeoDescriptionsList(serviceId);
}

// Shuffle GEO headlines from USPs
function shuffleGeoHeadlines(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const maxHeadlines = 15;
    let availableHeadlines = [];

    // Get selected USP texts (with variables substituted)
    campaignConfig.usp_ids.forEach(uspId => {
        const $checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
        if ($checkbox.length) {
            const originalText = $checkbox.data('original-text');
            const finalText = getUspFinalText(uspId, originalText);
            // Truncate to 30 chars for headline
            if (finalText && finalText.length <= 30) {
                availableHeadlines.push(finalText);
            }
        }
    });

    // Also add custom USPs that fit
    if (campaignConfig.custom_usps) {
        campaignConfig.custom_usps.forEach(usp => {
            if (usp.length <= 30) {
                availableHeadlines.push(usp);
            }
        });
    }

    if (availableHeadlines.length === 0) {
        alert('Ingen USPs valgt der passer til headline-l√¶ngde (max 30 tegn). Tilf√∏j manuelt.');
        return;
    }

    // Shuffle the array
    for (let i = availableHeadlines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableHeadlines[i], availableHeadlines[j]] = [availableHeadlines[j], availableHeadlines[i]];
    }

    // Take up to maxHeadlines
    geoCampaign.ad_group.headlines = availableHeadlines.slice(0, maxHeadlines);
    refreshGeoHeadlinesList(serviceId);

    console.log('Shuffled GEO headlines:', geoCampaign.ad_group.headlines);
}

// Refresh GEO headlines list in UI
function refreshGeoHeadlinesList(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const headlinesList = $(`.geo-headlines-list[data-service-id="${serviceId}"]`);
    headlinesList.html(renderGeoHeadlinesList(serviceId, geoCampaign.ad_group.headlines || []));

    // Update count
    $(`.geo-headlines-count[data-service-id="${serviceId}"]`).text(geoCampaign.ad_group.headlines?.length || 0);
}

// Refresh GEO descriptions list in UI
function refreshGeoDescriptionsList(serviceId) {
    const geoCampaign = campaignConfig.geo_campaigns[serviceId];
    if (!geoCampaign) return;

    const descList = $(`.geo-descriptions-list[data-service-id="${serviceId}"]`);
    descList.html(renderGeoDescriptionsList(serviceId, geoCampaign.ad_group.descriptions || []));

    // Update count
    $(`.geo-descriptions-count[data-service-id="${serviceId}"]`).text(geoCampaign.ad_group.descriptions?.length || 0);
}

// =====================================================
// Negative Keyword Editor Functions
// =====================================================

// Current state for the negative keyword editor
let negativeKeywordEditorState = {
    listId: null,
    listName: '',
    industryId: null,
    serverKeywords: [],  // Keywords from server
    isLoading: false
};

// Open the negative keyword editor modal
function openNegativeKeywordEditor(listId, listName, industryId) {
    negativeKeywordEditorState.listId = listId;
    negativeKeywordEditorState.listName = listName;
    negativeKeywordEditorState.industryId = industryId;
    negativeKeywordEditorState.isLoading = true;

    // Update modal title
    $('#neg-editor-title').text(listName);
    $('#neg-editor-subtitle').text('Indl√¶ser s√∏geord...');

    // Show loading state
    $('#neg-editor-keywords-list').html('<p class="text-center text-gray-500 py-8">Indl√¶ser s√∏geord...</p>');

    // Show modal
    const modal = document.getElementById('negative-keywords-editor-modal');
    if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
    }
    modal.style.display = 'flex';

    // Fetch keywords from server
    $.ajax({
        url: `/ajax/get-negative-keywords/${listId}/`,
        method: 'GET'
    }).done(function(response) {
        negativeKeywordEditorState.serverKeywords = response.keywords || [];
        negativeKeywordEditorState.isLoading = false;
        $('#neg-editor-subtitle').text('Se og rediger s√∏geord i listen');
        renderNegativeKeywordEditorList();
    }).fail(function() {
        negativeKeywordEditorState.isLoading = false;
        $('#neg-editor-keywords-list').html('<p class="text-center text-red-500 py-8">Fejl ved indl√¶sning af s√∏geord</p>');
    });
}

// Close the negative keyword editor modal
function closeNegativeKeywordEditor() {
    const modal = document.getElementById('negative-keywords-editor-modal');
    modal.style.display = 'none';

    // Clear input
    $('#neg-editor-new-keyword').val('');

    // Update keyword count in main view
    updateNegativeKeywordListCount(negativeKeywordEditorState.listId);
}

// Render the keywords list in the editor
function renderNegativeKeywordEditorList() {
    const listId = negativeKeywordEditorState.listId;
    const serverKeywords = negativeKeywordEditorState.serverKeywords;
    const customKeywords = campaignConfig.custom_negative_keywords[listId] || [];

    let html = '';

    // First render custom keywords (added in this session) - marked with green badge
    customKeywords.forEach((keyword, index) => {
        html += `
            <div class="flex items-center justify-between p-2 bg-green-50 rounded border border-green-200">
                <div class="flex items-center space-x-2">
                    <span class="text-xs px-2 py-0.5 bg-green-500 text-white rounded">Ny</span>
                    <span class="text-sm text-gray-800">${escapeHtml(keyword)}</span>
                </div>
                <button type="button" class="remove-custom-neg-keyword-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">
                    ‚úï
                </button>
            </div>
        `;
    });

    // Then render server keywords
    serverKeywords.forEach(keyword => {
        const keywordText = typeof keyword === 'string' ? keyword : keyword.keyword_text;
        html += `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                <span class="text-sm text-gray-800">${escapeHtml(keywordText)}</span>
                <span class="text-xs text-gray-400">Fra liste</span>
            </div>
        `;
    });

    if (!html) {
        html = '<p class="text-center text-gray-500 py-4">Ingen s√∏geord i listen</p>';
    }

    $('#neg-editor-keywords-list').html(html);

    // Update counts
    const totalCount = serverKeywords.length + customKeywords.length;
    $('#neg-editor-count').text(totalCount);
    $('#neg-editor-custom-count').text(customKeywords.length);
}

// Add a new custom negative keyword
function addCustomNegativeKeyword(keyword) {
    const listId = negativeKeywordEditorState.listId;
    const trimmedKeyword = keyword.trim().toLowerCase();

    if (!trimmedKeyword) return;

    // Initialize array if not exists
    if (!campaignConfig.custom_negative_keywords[listId]) {
        campaignConfig.custom_negative_keywords[listId] = [];
    }

    // Check for duplicates
    const customKeywords = campaignConfig.custom_negative_keywords[listId];
    const serverKeywords = negativeKeywordEditorState.serverKeywords;

    const existsInCustom = customKeywords.some(k => k.toLowerCase() === trimmedKeyword);
    const existsInServer = serverKeywords.some(k => {
        const kText = typeof k === 'string' ? k : k.keyword_text;
        return kText.toLowerCase() === trimmedKeyword;
    });

    if (existsInCustom || existsInServer) {
        alert('S√∏geordet findes allerede i listen');
        return;
    }

    // Add keyword
    campaignConfig.custom_negative_keywords[listId].push(trimmedKeyword);

    // Re-render list
    renderNegativeKeywordEditorList();

    // Clear input
    $('#neg-editor-new-keyword').val('').focus();
}

// Remove a custom negative keyword
function removeCustomNegativeKeyword(index) {
    const listId = negativeKeywordEditorState.listId;
    if (campaignConfig.custom_negative_keywords[listId]) {
        campaignConfig.custom_negative_keywords[listId].splice(index, 1);
        renderNegativeKeywordEditorList();
    }
}

// Update the keyword count displayed in the main view
function updateNegativeKeywordListCount(listId) {
    const serverList = serverData.negative_keyword_lists.find(l => l.id === listId);
    const serverCount = serverList ? serverList.keyword_count : 0;
    const customCount = (campaignConfig.custom_negative_keywords[listId] || []).length;
    const totalCount = serverCount + customCount;

    $(`.neg-list-keyword-count[data-list-id="${listId}"]`).text(totalCount);
}

// Event handlers for negative keyword editor
$(document).on('click', '.view-edit-neg-keywords-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const listId = $(this).data('list-id');
    const listName = $(this).data('list-name');
    const industryId = $(this).data('industry-id');
    openNegativeKeywordEditor(listId, listName, industryId);
});

$(document).on('click', '#neg-editor-close, #neg-editor-done-btn, .neg-editor-backdrop', function(e) {
    if (e.target === this) {
        closeNegativeKeywordEditor();
    }
});

$(document).on('click', '#neg-editor-add-btn', function() {
    const keyword = $('#neg-editor-new-keyword').val();
    addCustomNegativeKeyword(keyword);
});

$(document).on('keypress', '#neg-editor-new-keyword', function(e) {
    if (e.which === 13) {
        e.preventDefault();
        const keyword = $(this).val();
        addCustomNegativeKeyword(keyword);
    }
});

$(document).on('click', '.remove-custom-neg-keyword-btn', function() {
    const index = $(this).data('index');
    removeCustomNegativeKeyword(index);
});

// Event handler for GEO campaign match type changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-match-type', function() {
    const newMatchType = $(this).val();
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        // Update specific campaign
        campaignConfig.geo_campaigns[serviceId].match_type = newMatchType;

        // Update all keywords in this campaign with new match type
        campaignConfig.geo_campaigns[serviceId].ad_group.keywords.forEach(kw => {
            kw.match_type = newMatchType;
        });

        // Update UI display of match type badges for this campaign only
        $(`.geo-campaign-accordion[data-service-id="${serviceId}"] .geo-keyword-item .match-type-badge`).text(`[${newMatchType}]`);

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else {
        // Fallback for backward compatibility
        if (campaignConfig.geo_campaign) {
            campaignConfig.geo_campaign.match_type = newMatchType;
            campaignConfig.geo_campaign.ad_group.keywords.forEach(kw => {
                kw.match_type = newMatchType;
            });
            $('.geo-keyword-item .match-type-badge').text(`[${newMatchType}]`);
        }
    }
});

// Event handler for GEO campaign daily budget changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-daily-budget', function() {
    const newBudget = parseInt($(this).val()) || 300;
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].daily_budget = newBudget;

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.daily_budget = newBudget;
    }
});

// Event handler for GEO campaign bidding strategy changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-bidding-strategy', function() {
    const newStrategy = $(this).val();
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].bidding_strategy = newStrategy;

        // Show/hide target CPA field for this campaign
        const targetCpaField = $(`.geo-target-cpa-field[data-service-id="${serviceId}"]`);
        if (newStrategy === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.bidding_strategy = newStrategy;
        if (newStrategy === 'target_cpa') {
            $('.geo-target-cpa-field').show();
        } else {
            $('.geo-target-cpa-field').hide();
        }
    }
});

// Event handler for GEO campaign target CPA changes - supports multiple campaigns
$(document).on('change', '.geo-campaign-target-cpa', function() {
    const newTargetCpa = parseInt($(this).val()) || 0;
    const serviceId = $(this).data('service-id');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].target_cpa = newTargetCpa;

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        campaignConfig.geo_campaign.target_cpa = newTargetCpa;
    }
});

// Event handler for GEO campaign negative keyword list changes - supports multiple campaigns
$(document).on('change', '.geo-negative-list-checkbox', function() {
    const listId = parseInt($(this).data('list-id'));
    const serviceId = $(this).data('service-id');
    const isChecked = $(this).is(':checked');

    if (serviceId && campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        if (!campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids) {
            campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids = [];
        }

        if (isChecked) {
            if (!campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.includes(listId)) {
                campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids =
                campaignConfig.geo_campaigns[serviceId].negative_keyword_list_ids.filter(id => id !== listId);
        }

        // Update backward compatible geo_campaign if this is the first one
        const firstServiceId = Object.keys(campaignConfig.geo_campaigns)[0];
        if (serviceId == firstServiceId) {
            campaignConfig.geo_campaign = campaignConfig.geo_campaigns[serviceId];
        }
    } else if (campaignConfig.geo_campaign) {
        if (!campaignConfig.geo_campaign.negative_keyword_list_ids) {
            campaignConfig.geo_campaign.negative_keyword_list_ids = [];
        }

        if (isChecked) {
            if (!campaignConfig.geo_campaign.negative_keyword_list_ids.includes(listId)) {
                campaignConfig.geo_campaign.negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.geo_campaign.negative_keyword_list_ids =
                campaignConfig.geo_campaign.negative_keyword_list_ids.filter(id => id !== listId);
        }
    }
});

// Event handlers for GEO Headlines
$(document).on('click', '.geo-add-headline-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    addGeoHeadline(serviceId);
});

$(document).on('click', '.geo-shuffle-headlines-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    shuffleGeoHeadlines(serviceId);
});

$(document).on('click', '.remove-geo-headline-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    removeGeoHeadline(serviceId, index);
});

$(document).on('input', '.geo-headline-input', function() {
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    const value = $(this).val();
    const len = value.length;

    // Update character count
    $(this).siblings('span').text(`${len}/30`);
    if (len > 30) {
        $(this).siblings('span').addClass('text-red-500');
    } else {
        $(this).siblings('span').removeClass('text-red-500');
    }

    // Update campaignConfig
    if (campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].ad_group.headlines[index] = value;
    }
});

// Event handlers for GEO Descriptions
$(document).on('click', '.geo-add-description-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    addGeoDescription(serviceId);
});

$(document).on('click', '.remove-geo-description-btn', function(e) {
    e.stopPropagation();
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    removeGeoDescription(serviceId, index);
});

$(document).on('input', '.geo-description-input', function() {
    const serviceId = $(this).data('service-id');
    const index = $(this).data('index');
    const value = $(this).val();
    const len = value.length;

    // Update character count
    $(this).siblings('span').text(`${len}/90`);
    if (len > 90) {
        $(this).siblings('span').addClass('text-red-500');
    } else {
        $(this).siblings('span').removeClass('text-red-500');
    }

    // Update campaignConfig
    if (campaignConfig.geo_campaigns && campaignConfig.geo_campaigns[serviceId]) {
        campaignConfig.geo_campaigns[serviceId].ad_group.descriptions[index] = value;
    }
});

// Render a single campaign accordion
function renderCampaignAccordion(industryId, industryInfo) {
    const campaign = campaignConfig.campaigns[industryId];
    const adGroupCount = Object.keys(campaign.ad_groups).length;

    let html = `
        <div class="campaign-accordion bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" data-industry-id="${industryId}">
            <!-- Campaign Header -->
            <div class="campaign-header p-6 cursor-pointer" style="background: linear-gradient(135deg, #8B5CF620, #8B5CF610);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white bg-gradient-to-r from-purple-600 to-pink-600">
                            üè¢
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${escapeHtml(industryInfo.name)}</h3>
                            <p class="text-sm text-gray-600">${adGroupCount} annoncegruppe${adGroupCount !== 1 ? 'r' : ''}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="campaign-toggle-icon text-2xl transition-transform duration-200">‚ñº</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Content (collapsible) -->
            <div class="campaign-content">
                <!-- Budget Section -->
                <div class="p-6 border-t border-gray-100 bg-gray-50">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-green-100 text-green-700">üí∞</span>
                        Budget & Strategi
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dagligt Budget (DKK)</label>
                            <input type="number" class="campaign-daily-budget w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="${campaign.daily_budget}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bidding Strategi</label>
                            <select class="campaign-bidding-strategy w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="maximize_clicks" ${campaign.bidding_strategy === 'maximize_clicks' ? 'selected' : ''}>Maximize Clicks</option>
                                <option value="maximize_conversions" ${campaign.bidding_strategy === 'maximize_conversions' ? 'selected' : ''}>Maximize Conversions</option>
                                <option value="target_cpa" ${campaign.bidding_strategy === 'target_cpa' ? 'selected' : ''}>Target CPA</option>
                                <option value="target_roas" ${campaign.bidding_strategy === 'target_roas' ? 'selected' : ''}>Target ROAS</option>
                                <option value="manual_cpc" ${campaign.bidding_strategy === 'manual_cpc' ? 'selected' : ''}>Manual CPC</option>
                            </select>
                        </div>
                        <div class="target-cpa-field" style="display: ${campaign.bidding_strategy === 'target_cpa' ? 'block' : 'none'};">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target CPA (DKK)</label>
                            <input type="number" class="campaign-target-cpa w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="1" value="${campaign.target_cpa || ''}">
                        </div>
                    </div>
                </div>

                <!-- Negative Keywords Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="w-6 h-6 rounded mr-2 flex items-center justify-center text-sm bg-red-100 text-red-700">üìã</span>
                        Negative S√∏geordslister
                    </h4>
                    <div class="negative-keywords-container grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${renderNegativeKeywordLists(industryId, campaign.negative_keyword_list_ids)}
                    </div>
                </div>

                <!-- Ad Groups Section -->
                <div class="p-6 border-t border-gray-100">
                    <h4 class="font-semibold text-gray-900 mb-4">Annoncegrupper</h4>
                    <div class="ad-groups-container space-y-4">
                        ${renderAdGroups(industryId, industryInfo.services)}
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

// Render negative keyword list checkboxes
function renderNegativeKeywordLists(industryId, selectedIds) {
    if (!serverData.negative_keyword_lists || serverData.negative_keyword_lists.length === 0) {
        return '<p class="text-gray-500 text-sm">Ingen negative s√∏geordslister tilg√¶ngelige</p>';
    }

    return serverData.negative_keyword_lists.map(list => {
        const isChecked = selectedIds.includes(list.id) ? 'checked' : '';
        return `
            <div class="flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                <label class="flex items-center cursor-pointer flex-1">
                    <input type="checkbox" class="neg-keyword-list-checkbox w-4 h-4 text-purple-600 rounded focus:ring-purple-500 mr-3"
                           data-industry-id="${industryId}" data-list-id="${list.id}" ${isChecked}>
                    <div>
                        <span class="font-medium text-gray-900">${escapeHtml(list.name)}</span>
                        <span class="text-xs text-gray-500 ml-2">(<span class="neg-list-keyword-count" data-list-id="${list.id}">${list.keyword_count}</span> s√∏geord)</span>
                    </div>
                </label>
                <button type="button" class="view-edit-neg-keywords-btn ml-2 text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                        data-list-id="${list.id}" data-list-name="${escapeHtml(list.name)}" data-industry-id="${industryId}">
                    Se/Rediger
                </button>
            </div>
        `;
    }).join('');
}

// Render ad groups for a campaign
function renderAdGroups(industryId, services) {
    const campaign = campaignConfig.campaigns[industryId];

    return services.filter(s => campaignConfig.service_ids.includes(s.id)).map(service => {
        const adGroup = campaign.ad_groups[service.id] || {
            headlines: [],
            descriptions: [],
            keywords: service.keywords || []
        };

        return `
            <div class="ad-group-item bg-gray-50 rounded-xl p-4 border border-gray-200" data-service-id="${service.id}" data-industry-id="${industryId}">
                <!-- Ad Group Header -->
                <div class="ad-group-header flex items-center justify-between mb-4 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg bg-blue-100 text-blue-700">
                            üîß
                        </div>
                        <div>
                            <h5 class="font-semibold text-gray-900">${escapeHtml(service.name)}</h5>
                            <p class="text-xs text-gray-500">${adGroup.keywords.length} s√∏geord</p>
                        </div>
                    </div>
                    <span class="ad-group-toggle-icon text-xl transition-transform duration-200">‚ñº</span>
                </div>

                <!-- Ad Group Content -->
                <div class="ad-group-content">
                    <!-- Keywords Section -->
                    <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm flex items-center">
                                <span class="mr-2">üîë</span> S√∏geord
                            </h6>
                            <button type="button" class="add-keyword-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                    data-industry-id="${industryId}" data-service-id="${service.id}">
                                + Tilf√∏j
                            </button>
                        </div>
                        <div class="keywords-list space-y-1 text-sm max-h-32 overflow-y-auto" data-service-id="${service.id}" data-industry-id="${industryId}">
                            ${renderKeywordsList(adGroup.keywords, service.id)}
                        </div>
                    </div>

                    <!-- Headlines Section -->
                    <div class="mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm">
                                Headlines (<span class="headlines-count">${adGroup.headlines.length}</span>/15)
                            </h6>
                            <div class="flex space-x-2">
                                <button type="button" class="shuffle-headlines-btn text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors flex items-center"
                                        data-industry-id="${industryId}" data-service-id="${service.id}">
                                    üîÄ Shuffle
                                </button>
                                <button type="button" class="add-headline-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                        data-industry-id="${industryId}" data-service-id="${service.id}">
                                    + Tilf√∏j
                                </button>
                            </div>
                        </div>
                        <div class="headlines-list space-y-2">
                            ${renderHeadlinesList(industryId, service.id, adGroup.headlines)}
                        </div>
                    </div>

                    <!-- Descriptions Section -->
                    <div class="p-3 bg-white rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="font-medium text-gray-900 text-sm">
                                Descriptions (<span class="descriptions-count">${adGroup.descriptions.length}</span>/4)
                            </h6>
                            <button type="button" class="add-description-btn text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                    data-industry-id="${industryId}" data-service-id="${service.id}">
                                + Tilf√∏j
                            </button>
                        </div>
                        <div class="descriptions-list space-y-2">
                            ${renderDescriptionsList(industryId, service.id, adGroup.descriptions)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Render keywords list with edit/delete buttons (like Industry Manager)
function renderKeywordsList(keywords, serviceId) {
    if (!keywords || keywords.length === 0) {
        return '<p class="text-gray-400 text-xs">Ingen s√∏geord defineret. Tilf√∏j keywords i Industry Manager.</p>';
    }

    // Build table HTML (same format as Industry Manager)
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left py-2 px-3 font-medium text-gray-700 text-xs">Keyword</th>
                        <th class="text-left py-2 px-3 font-medium text-gray-700 text-xs">Match Type</th>
                        <th class="text-center py-2 px-3 font-medium text-gray-700 text-xs">Prim.</th>
                        <th class="text-right py-2 px-3 font-medium text-gray-700 text-xs">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">`;

    keywords.forEach(kw => {
        const keyword = typeof kw === 'string' ? kw : kw.keyword;
        const matchType = typeof kw === 'object' && kw.match_type ? kw.match_type : 'broad';
        const isPrimary = typeof kw === 'object' && kw.is_primary;
        const keywordId = typeof kw === 'object' && kw.id ? kw.id : null;

        // Match type badge classes (same as Industry Manager)
        const matchTypeBadgeClass = matchType === 'exact' ? 'bg-purple-100 text-purple-800' :
                                   matchType === 'phrase' ? 'bg-blue-100 text-blue-800' :
                                   'bg-gray-100 text-gray-800';

        // Match type display text
        const matchTypeDisplay = matchType === 'exact' ? 'Exact Match' :
                                matchType === 'phrase' ? 'Phrase Match' : 'Broad Match';

        // Primary icon
        const primaryIcon = isPrimary ? '<span class="text-yellow-500 text-sm">‚≠ê</span>' : '<span class="text-gray-300 text-sm">‚òÜ</span>';

        // Action buttons
        const actionButtons = keywordId ? `
            <button class="edit-service-keyword-btn text-gray-400 hover:text-purple-600 p-1"
                    data-keyword-id="${keywordId}" data-service-id="${serviceId || ''}" title="Rediger keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </button>
            <button class="delete-service-keyword-btn text-gray-400 hover:text-red-600 p-1"
                    data-keyword-id="${keywordId}" data-service-id="${serviceId || ''}" title="Slet keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </button>
        ` : '';

        html += `
            <tr class="keyword-row hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keywordId || ''}">
                <td class="py-2 px-3">
                    <span class="keyword-text font-medium text-gray-900 text-xs">${escapeHtml(keyword)}</span>
                </td>
                <td class="py-2 px-3">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${matchTypeBadgeClass}">
                        ${matchTypeDisplay}
                    </span>
                </td>
                <td class="py-2 px-3 text-center">
                    ${primaryIcon}
                </td>
                <td class="py-2 px-3 text-right">
                    <div class="flex items-center justify-end space-x-1">
                        ${actionButtons}
                    </div>
                </td>
            </tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

// Render headlines list
function renderHeadlinesList(industryId, serviceId, headlines) {
    if (!headlines || headlines.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Shuffle" for at auto-generere headlines fra USPs, eller "Tilf√∏j" for manuel tilf√∏jelse</p>';
    }

    return headlines.map((headline, index) => `
        <div class="headline-item flex items-center space-x-2">
            <input type="text" class="headline-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   value="${escapeHtml(headline)}" maxlength="30" data-index="${index}">
            <span class="text-xs text-gray-500 w-10">${headline.length}/30</span>
            <button type="button" class="remove-headline-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">‚úï</button>
        </div>
    `).join('');
}

// Render descriptions list
function renderDescriptionsList(industryId, serviceId, descriptions) {
    if (!descriptions || descriptions.length === 0) {
        return '<p class="text-gray-400 text-xs">Klik "Tilf√∏j" for at tilf√∏je beskrivelser</p>';
    }

    return descriptions.map((desc, index) => `
        <div class="description-item flex items-center space-x-2">
            <textarea class="description-input flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                      maxlength="90" rows="2" data-index="${index}">${escapeHtml(desc)}</textarea>
            <span class="text-xs text-gray-500 w-10">${desc.length}/90</span>
            <button type="button" class="remove-description-btn text-red-400 hover:text-red-600 text-sm" data-index="${index}">‚úï</button>
        </div>
    `).join('');
}

// Setup event handlers for campaign accordions
function setupCampaignAccordionHandlers() {
    // Campaign accordion toggle
    $(document).off('click', '.campaign-header').on('click', '.campaign-header', function() {
        const accordion = $(this).closest('.campaign-accordion');
        const content = accordion.find('.campaign-content');
        const icon = $(this).find('.campaign-toggle-icon');

        content.slideToggle(200);
        icon.toggleClass('rotate-180');
    });

    // Ad group toggle
    $(document).off('click', '.ad-group-header').on('click', '.ad-group-header', function() {
        const adGroup = $(this).closest('.ad-group-item');
        const content = adGroup.find('.ad-group-content');
        const icon = $(this).find('.ad-group-toggle-icon');

        content.slideToggle(200);
        icon.toggleClass('rotate-180');
    });

    // Bidding strategy change - show/hide target CPA field
    $(document).off('change', '.campaign-bidding-strategy').on('change', '.campaign-bidding-strategy', function() {
        const accordion = $(this).closest('.campaign-accordion');
        const targetCpaField = accordion.find('.target-cpa-field');

        if ($(this).val() === 'target_cpa') {
            targetCpaField.show();
        } else {
            targetCpaField.hide();
        }
    });

    // Negative keyword list checkbox
    $(document).off('change', '.neg-keyword-list-checkbox').on('change', '.neg-keyword-list-checkbox', function() {
        const industryId = $(this).data('industry-id');
        const listId = $(this).data('list-id');

        if ($(this).is(':checked')) {
            if (!campaignConfig.campaigns[industryId].negative_keyword_list_ids.includes(listId)) {
                campaignConfig.campaigns[industryId].negative_keyword_list_ids.push(listId);
            }
        } else {
            campaignConfig.campaigns[industryId].negative_keyword_list_ids =
                campaignConfig.campaigns[industryId].negative_keyword_list_ids.filter(id => id !== listId);
        }
    });

    // Shuffle headlines button
    $(document).off('click', '.shuffle-headlines-btn').on('click', '.shuffle-headlines-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        shuffleHeadlines(industryId, serviceId);
    });

    // Add headline button
    $(document).off('click', '.add-headline-btn').on('click', '.add-headline-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        addHeadline(industryId, serviceId);
    });

    // Add description button
    $(document).off('click', '.add-description-btn').on('click', '.add-description-btn', function(e) {
        e.stopPropagation();
        const industryId = $(this).data('industry-id');
        const serviceId = $(this).data('service-id');
        addDescription(industryId, serviceId);
    });

    // Remove headline button
    $(document).off('click', '.remove-headline-btn').on('click', '.remove-headline-btn', function(e) {
        e.stopPropagation();
        const adGroup = $(this).closest('.ad-group-item');
        const industryId = adGroup.data('industry-id');
        const serviceId = adGroup.data('service-id');
        const index = $(this).data('index');
        removeHeadline(industryId, serviceId, index);
    });

    // Remove description button
    $(document).off('click', '.remove-description-btn').on('click', '.remove-description-btn', function(e) {
        e.stopPropagation();
        const adGroup = $(this).closest('.ad-group-item');
        const industryId = adGroup.data('industry-id');
        const serviceId = adGroup.data('service-id');
        const index = $(this).data('index');
        removeDescription(industryId, serviceId, index);
    });

    // Headline input change - update character count
    $(document).off('input', '.headline-input').on('input', '.headline-input', function() {
        const len = $(this).val().length;
        $(this).siblings('span').text(`${len}/30`);
        if (len > 30) {
            $(this).siblings('span').addClass('text-red-500');
        } else {
            $(this).siblings('span').removeClass('text-red-500');
        }
    });

    // Description input change - update character count
    $(document).off('input', '.description-input').on('input', '.description-input', function() {
        const len = $(this).val().length;
        $(this).siblings('span').text(`${len}/90`);
        if (len > 90) {
            $(this).siblings('span').addClass('text-red-500');
        } else {
            $(this).siblings('span').removeClass('text-red-500');
        }
    });

    // Add keyword button - show inline form
    $(document).off('click', '.add-keyword-btn').on('click', '.add-keyword-btn', function(e) {
        e.stopPropagation();
        const adGroupItem = $(this).closest('.ad-group-item');
        const industryId = adGroupItem.data('industry-id');
        const serviceId = adGroupItem.data('service-id');
        showAddKeywordForm(industryId, serviceId);
    });

    // Save new keyword
    $(document).off('click', '.save-new-keyword-btn').on('click', '.save-new-keyword-btn', function(e) {
        e.stopPropagation();
        const form = $(this).closest('.add-keyword-form');
        const adGroupItem = form.closest('.ad-group-item');
        const industryId = adGroupItem.data('industry-id');
        const serviceId = adGroupItem.data('service-id');
        const keyword = form.find('.new-keyword-input').val().trim();
        const matchType = form.find('.new-keyword-match-type').val();

        if (keyword) {
            saveNewKeyword(industryId, serviceId, keyword, matchType);
        }
    });

    // Cancel add keyword
    $(document).off('click', '.cancel-new-keyword-btn').on('click', '.cancel-new-keyword-btn', function(e) {
        e.stopPropagation();
        $(this).closest('.add-keyword-form').remove();
    });

    // Enter key in new keyword input
    $(document).off('keypress', '.new-keyword-input').on('keypress', '.new-keyword-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            $(this).closest('.add-keyword-form').find('.save-new-keyword-btn').click();
        }
    });
}

// Shuffle headlines - generate from selected USPs' example_headlines
// Respects locked headlines - they stay in place while only unlocked ones are replaced
function shuffleHeadlines(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    const maxHeadlines = 15;

    // 1. Preserve locked headlines and note their positions
    const lockedHeadlines = [];
    const lockedIndices = new Set();

    if (adGroup.headlines && adGroup.headlines.length > 0) {
        adGroup.headlines.forEach((headline, index) => {
            if (typeof headline === 'object' && headline.locked) {
                lockedHeadlines.push({ index, headline });
                lockedIndices.add(index);
            }
        });
    }

    // Create a Set of locked headline texts for duplicate filtering
    const lockedTexts = new Set(
        lockedHeadlines.map(({ headline }) =>
            typeof headline === 'object' ? headline.text : headline
        )
    );

    // 2. Generate new headlines from USPs
    let availableHeadlines = [];

    campaignConfig.usp_ids.forEach(uspId => {
        const $checkbox = $(`.usp-checkbox[data-usp-id="${uspId}"]`);
        if (!$checkbox.length) return;

        // Get example_headlines from data attribute (now outputs proper JSON via |tojson filter)
        let exampleHeadlines = [];
        try {
            let headlinesData = $checkbox.attr('data-example-headlines');
            if (headlinesData && headlinesData !== 'null' && headlinesData !== '[]' && headlinesData !== 'None') {
                exampleHeadlines = JSON.parse(headlinesData);
            }
        } catch (e) {
            console.warn('Could not parse example_headlines for USP', uspId, e);
        }

        if (Array.isArray(exampleHeadlines) && exampleHeadlines.length > 0) {
            // Pick 1 random headline from this USP's example_headlines
            const randomIndex = Math.floor(Math.random() * exampleHeadlines.length);
            let headline = exampleHeadlines[randomIndex];

            // Substitute variables like {SERVICE}, {BRANCHE}, and {VAR1:default} etc.
            headline = substituteHeadlineVariables(headline, industryId, serviceId, uspId);

            // Only add if within 30 character limit
            if (headline.length <= 30) {
                availableHeadlines.push({ text: headline, locked: false });
            }
        } else {
            // Fallback: Use USP text if no example_headlines
            const originalText = $checkbox.data('original-text');
            const finalText = getUspFinalText(uspId, originalText);
            if (finalText.length <= 30) {
                availableHeadlines.push({ text: finalText, locked: false });
            }
        }
    });

    // 3. Custom USPs are used 1:1 directly as headlines
    campaignConfig.custom_usps.forEach(usp => {
        if (usp.length <= 30) {
            availableHeadlines.push({ text: usp, locked: false });
        }
    });

    // Filter out headlines that match locked headline texts (avoid duplicates)
    availableHeadlines = availableHeadlines.filter(h => !lockedTexts.has(h.text));

    // 4. Add standard headlines with Google Ads dynamic insertion
    // These are ALWAYS included and placed first (not shuffled away)
    // {SERVICE} is substituted with the service name
    // {LOCATION(City)} is Google Ads native syntax - stays as is for dynamic city insertion
    // {KeyWord:{SERVICE}} becomes e.g. {KeyWord:VVS} for keyword insertion
    const standardHeadlineTemplates = [
        '{SERVICE} {LOCATION(City)}',
        '{KeyWord:{SERVICE}}'
    ];

    // Get service name from the adGroup (stored when ad group was created)
    const serviceName = adGroup.service_name || '';

    // Generate standard headlines (separate from regular pool)
    const standardHeadlines = [];
    console.log('Standard headlines - serviceName:', serviceName);
    if (serviceName) {
        standardHeadlineTemplates.forEach(template => {
            // Only substitute {SERVICE} - leave {LOCATION(City)} and {KeyWord:...} as Google Ads syntax
            const substituted = template.replace(/\{SERVICE\}/gi, serviceName);
            console.log('Standard headline template:', template, '-> substituted:', substituted, 'length:', substituted.length);
            if (substituted.length <= 30 && !lockedTexts.has(substituted)) {
                standardHeadlines.push({ text: substituted, locked: false, source: 'standard' });
            }
        });
    }
    console.log('Standard headlines generated:', standardHeadlines.length, standardHeadlines);

    if (availableHeadlines.length === 0 && lockedHeadlines.length === 0 && standardHeadlines.length === 0) {
        alert('Ingen headlines fundet. Tjek at dine USPs har tilknyttede example_headlines eller tilf√∏j manuelt.');
        return;
    }

    // 5. Shuffle only the USP headlines (Fisher-Yates algorithm)
    for (let i = availableHeadlines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableHeadlines[i], availableHeadlines[j]] = [availableHeadlines[j], availableHeadlines[i]];
    }

    // 6. Calculate how many new headlines we need
    const slotsNeeded = maxHeadlines - lockedHeadlines.length;
    const finalHeadlines = new Array(maxHeadlines).fill(null);

    // 7. Place locked headlines at their original positions
    lockedHeadlines.forEach(({ index, headline }) => {
        if (index < maxHeadlines) {
            finalHeadlines[index] = headline;
        }
    });

    // 8. Fill empty slots - FIRST with standard headlines (always included), then with USP headlines
    let slotIndex = 0;

    // First: Add standard headlines to the first available slots
    for (let stdIdx = 0; stdIdx < standardHeadlines.length && slotIndex < maxHeadlines; ) {
        if (finalHeadlines[slotIndex] === null) {
            finalHeadlines[slotIndex] = standardHeadlines[stdIdx];
            stdIdx++;
        }
        slotIndex++;
    }

    // Then: Fill remaining slots with USP headlines
    let uspIndex = 0;
    for (let i = 0; i < maxHeadlines && uspIndex < availableHeadlines.length; i++) {
        if (finalHeadlines[i] === null) {
            finalHeadlines[i] = availableHeadlines[uspIndex++];
        }
    }

    // 9. Remove null values and update
    adGroup.headlines = finalHeadlines.filter(h => h !== null);

    // 9. Update count in main view (the panel will be re-rendered after shuffle button click in openAdGroupEditPanel)
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);

    console.log('Shuffled headlines (locked:', lockedHeadlines.length, ', new:', adGroup.headlines.length - lockedHeadlines.length, '):', adGroup.headlines);
}

// Helper function: Get final text for a USP (with custom edits applied)
function getUspFinalText(uspId, originalText) {
    // Check if there's a custom text for this USP
    if (campaignConfig.usp_custom_texts && campaignConfig.usp_custom_texts[uspId]) {
        return campaignConfig.usp_custom_texts[uspId];
    }

    // Otherwise, apply variable substitution to original text
    return substituteUspVariables(originalText, uspId);
}

// Helper function: Extract variable values by comparing original template with edited text
function extractVariableValuesFromEditedText(originalTemplate, editedText) {
    const varValues = {};
    if (!originalTemplate || !editedText) return varValues;

    // Find all VAR patterns in original template with their positions
    const varPattern = /\{VAR(\d+)(?::([^}]*))?\}/gi;
    let match;
    const varPositions = [];

    while ((match = varPattern.exec(originalTemplate)) !== null) {
        varPositions.push({
            varIndex: match[1],
            defaultValue: match[2] || '',
            start: match.index,
            end: match.index + match[0].length,
            fullMatch: match[0]
        });
    }

    if (varPositions.length === 0) return varValues;

    // Build regex pattern to extract values from edited text
    // Strategy: First replace VAR patterns with placeholders, then escape everything, then put capture groups
    let regexPattern = originalTemplate;

    // Replace VAR patterns with unique placeholder that won't be escaped
    const placeholder = '\x00VARCAPTURE\x00';
    regexPattern = regexPattern.replace(/\{VAR(\d+)(?::[^}]*)?\}/gi, placeholder);

    // Now escape all special regex characters
    regexPattern = regexPattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // Replace placeholders with capture groups
    regexPattern = regexPattern.replace(new RegExp(placeholder.replace(/\x00/g, '\\x00'), 'g'), '(.+?)');

    try {
        const extractRegex = new RegExp('^' + regexPattern + '$', 'i');
        const extractMatch = editedText.match(extractRegex);

        console.log('extractVariableValuesFromEditedText:', {
            original: originalTemplate,
            edited: editedText,
            regexPattern: regexPattern,
            match: extractMatch
        });

        if (extractMatch) {
            // Map extracted values to variable indices
            varPositions.forEach((varPos, index) => {
                if (extractMatch[index + 1]) {
                    varValues[varPos.varIndex] = extractMatch[index + 1];
                }
            });
        }
    } catch (e) {
        console.warn('Could not extract variable values:', e);
    }

    return varValues;
}

// Helper function: Substitute USP-specific variables (VAR1, VAR2, VAR3) in text
function substituteUspVariables(text, uspId) {
    if (!text) return '';

    let result = text;
    let varValues = {};

    // First, try to extract values from the edited USP text
    // Use the usp-item container which has data-usp-id attribute
    const $uspItem = $(`.usp-item[data-usp-id="${uspId}"]`);
    if ($uspItem.length) {
        const $checkbox = $uspItem.find('.usp-checkbox');
        const originalText = $checkbox.data('original-text');
        const $editInput = $uspItem.find('.usp-edit-input');

        console.log('substituteUspVariables for USP', uspId, {
            uspItemFound: $uspItem.length > 0,
            originalText: originalText,
            editInputFound: $editInput.length > 0,
            editedText: $editInput.length ? $editInput.val() : null
        });

        if ($editInput.length && originalText) {
            const editedText = $editInput.val();
            // Only extract if the text was actually edited (not identical to original)
            if (editedText && editedText !== originalText) {
                varValues = extractVariableValuesFromEditedText(originalText, editedText);
                console.log('Extracted VAR values:', varValues);
            }
        }
    }

    // Fall back to stored values if extraction didn't work
    if (Object.keys(varValues).length === 0) {
        varValues = campaignConfig.usp_variable_values && campaignConfig.usp_variable_values[uspId]
            ? campaignConfig.usp_variable_values[uspId]
            : {};
    }

    console.log('substituteUspVariables - varValues for USP', uspId, ':', JSON.stringify(varValues));

    // Replace {VAR1:default}, {VAR2:default}, {VAR3:default} patterns
    // Pattern: {VAR followed by digit, optionally :default value, then }
    // Track which VAR we're at (0-based index) for matching with stored values
    let varCounter = 0;
    result = result.replace(/\{VAR(\d+)(?::([^}]*))?\}/gi, (match, varNumber, defaultValue) => {
        // The varNumber is the number from VAR1, VAR2 etc (1-based)
        // But usp_variable_values uses 0-based index from renderUspWithVariables
        const varIndex = varCounter;
        varCounter++;

        console.log(`  Replacing ${match}: varNumber=${varNumber}, varIndex=${varIndex}, stored value for index=${varValues[varIndex]}, stored value for number=${varValues[varNumber]}`);

        // Check if we have a stored value - try both 0-based index and VAR number
        if (varValues[varIndex] !== undefined) {
            console.log(`    Using stored value (index ${varIndex}): ${varValues[varIndex]}`);
            return varValues[varIndex];
        }
        if (varValues[varNumber] !== undefined) {
            console.log(`    Using stored value (number ${varNumber}): ${varValues[varNumber]}`);
            return varValues[varNumber];
        }
        // Otherwise use the default value from the pattern (e.g., "1-3" from {VAR1:1-3})
        console.log(`    Using default: ${defaultValue}`);
        return defaultValue || '';
    });

    return result;
}

// Helper function: Substitute variables in headline text
function substituteHeadlineVariables(headline, industryId, serviceId, uspId) {
    // Get industry and service names from serverData
    const industry = serverData.industries ? serverData.industries.find(i => i.id == industryId) : null;
    const service = industry && industry.services ? industry.services.find(s => s.id == serviceId) : null;

    let result = headline;

    // Apply USP-specific variable substitution (VAR1, VAR2, VAR3)
    if (uspId) {
        result = substituteUspVariables(result, uspId);
    }

    // Apply general placeholders
    if (service && service.name) {
        result = result.replace(/\{SERVICE\}/gi, service.name);
    }
    if (industry && industry.name) {
        result = result.replace(/\{BRANCHE\}/gi, industry.name);
    }

    return result;
}

// Add a new headline
function addHeadline(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.headlines.length >= 15) {
        alert('Maksimalt 15 headlines per annoncegruppe.');
        return;
    }

    adGroup.headlines.push('');

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const headlinesList = adGroupElement.find('.headlines-list');
    headlinesList.html(renderHeadlinesList(industryId, serviceId, adGroup.headlines));
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);

    // Focus the new input
    headlinesList.find('.headline-input').last().focus();
}

// Remove a headline
function removeHeadline(industryId, serviceId, index) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    adGroup.headlines.splice(index, 1);

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const headlinesList = adGroupElement.find('.headlines-list');
    headlinesList.html(renderHeadlinesList(industryId, serviceId, adGroup.headlines));
    adGroupElement.find('.headlines-count').text(adGroup.headlines.length);
}

// Add a new description
function addDescription(industryId, serviceId) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.descriptions.length >= 4) {
        alert('Maksimalt 4 beskrivelser per annoncegruppe.');
        return;
    }

    adGroup.descriptions.push('');

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const descList = adGroupElement.find('.descriptions-list');
    descList.html(renderDescriptionsList(industryId, serviceId, adGroup.descriptions));
    adGroupElement.find('.descriptions-count').text(adGroup.descriptions.length);

    // Focus the new input
    descList.find('.description-input').last().focus();
}

// Remove a description
function removeDescription(industryId, serviceId, index) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];
    adGroup.descriptions.splice(index, 1);

    // Re-render
    const adGroupElement = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const descList = adGroupElement.find('.descriptions-list');
    descList.html(renderDescriptionsList(industryId, serviceId, adGroup.descriptions));
    adGroupElement.find('.descriptions-count').text(adGroup.descriptions.length);
}

// Show inline form to add new keyword
function showAddKeywordForm(industryId, serviceId) {
    const adGroupItem = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const keywordsSection = adGroupItem.find('.keywords-list');

    // Remove any existing form
    keywordsSection.find('.add-keyword-form').remove();

    // Insert form at top
    const formHtml = `
        <div class="add-keyword-form p-2 bg-blue-50 rounded mb-2 border border-blue-200">
            <div class="flex items-center space-x-2">
                <input type="text" class="new-keyword-input flex-1 px-2 py-1 text-sm border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Indtast s√∏geord...">
                <select class="new-keyword-match-type text-sm border rounded px-2 py-1">
                    <option value="broad">Broad</option>
                    <option value="phrase">Phrase</option>
                    <option value="exact">Exact</option>
                </select>
                <button class="save-new-keyword-btn text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">Gem</button>
                <button class="cancel-new-keyword-btn text-xs px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">Annuller</button>
            </div>
        </div>
    `;
    keywordsSection.prepend(formHtml);
    keywordsSection.find('.new-keyword-input').focus();
}

// Save a new custom keyword to the ad group
function saveNewKeyword(industryId, serviceId, keyword, matchType) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Initialize custom_keywords if not exists
    if (!adGroup.custom_keywords) {
        adGroup.custom_keywords = [];
    }

    // Add the new keyword
    adGroup.custom_keywords.push({
        keyword: keyword,
        match_type: matchType,
        is_primary: false,
        is_custom: true
    });

    // Re-render keywords list
    refreshKeywordsList(industryId, serviceId);

    console.log('Added custom keyword:', keyword, 'to', industryId, serviceId);
}

// Refresh the keywords list in the UI
function refreshKeywordsList(industryId, serviceId) {
    const adGroupItem = $(`.ad-group-item[data-industry-id="${industryId}"][data-service-id="${serviceId}"]`);
    const keywordsSection = adGroupItem.find('.keywords-list');
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    // Combine server keywords with custom keywords
    const serverKeywords = serverData.google_keywords && serverData.google_keywords[serviceId]
        ? serverData.google_keywords[serviceId]
        : [];

    const customKeywords = adGroup.custom_keywords || [];

    // Build combined list - custom keywords first, then server keywords
    const allKeywords = [...customKeywords, ...serverKeywords];

    // Render the list
    keywordsSection.html(renderKeywordsList(allKeywords, serviceId));

    // Update count
    adGroupItem.find('.keywords-count').text(allKeywords.length);
}

// Remove a custom keyword
function removeCustomKeyword(industryId, serviceId, keywordIndex) {
    const adGroup = campaignConfig.campaigns[industryId].ad_groups[serviceId];

    if (adGroup.custom_keywords && adGroup.custom_keywords[keywordIndex]) {
        adGroup.custom_keywords.splice(keywordIndex, 1);
        refreshKeywordsList(industryId, serviceId);
    }
}

// Save campaigns from UI to campaignConfig
function saveCampaignsFromUI() {
    $('.campaign-accordion').each(function() {
        const industryId = $(this).data('industry-id');
        const campaign = campaignConfig.campaigns[industryId];

        // Save budget settings
        campaign.daily_budget = parseInt($(this).find('.campaign-daily-budget').val()) || 500;
        campaign.bidding_strategy = $(this).find('.campaign-bidding-strategy').val();
        campaign.target_cpa = parseInt($(this).find('.campaign-target-cpa').val()) || null;

        // Save headlines and descriptions from inputs
        $(this).find('.ad-group-item').each(function() {
            const serviceId = $(this).data('service-id');
            const adGroup = campaign.ad_groups[serviceId];

            adGroup.headlines = [];
            $(this).find('.headline-input').each(function() {
                const val = $(this).val().trim();
                if (val) adGroup.headlines.push(val);
            });

            adGroup.descriptions = [];
            $(this).find('.description-input').each(function() {
                const val = $(this).val().trim();
                if (val) adGroup.descriptions.push(val);
            });
        });
    });

    console.log('Saved campaigns:', campaignConfig.campaigns);
}

// =====================================================
// Geo Service Selection Functions (Step 4)
// =====================================================

// Populate geo services container based on selected services
function populateGeoServicesContainer() {
    const container = $('#geo-services-container');

    if (campaignConfig.service_ids.length === 0) {
        container.html('<p class="text-gray-500 col-span-full text-center py-4">V√¶lg services i Step 1 for at se geo-kampagne muligheder</p>');
        return;
    }

    // Get service names from the selected service cards (they were loaded in step 1)
    let servicesHtml = '';
    campaignConfig.service_ids.forEach(serviceId => {
        const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
        const serviceName = serviceCard.find('h4').text() || `Service ${serviceId}`;
        const isChecked = campaignConfig.geo_config.enabled_services.includes(serviceId) ? 'checked' : '';

        servicesHtml += `
            <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors">
                <input type="checkbox" class="geo-service-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500 mr-3"
                       data-service-id="${serviceId}" ${isChecked}>
                <span class="font-medium text-gray-900">${escapeHtml(serviceName)}</span>
            </label>
        `;
    });

    container.html(servicesHtml);
}

// Setup byside URL toggle
$(document).on('change', '#create-byside-urls', function() {
    if ($(this).is(':checked')) {
        $('#byside-url-config').slideDown(200);
    } else {
        $('#byside-url-config').slideUp(200);
    }
});

// Generate byside URLs button click handler
$(document).on('click', '#generate-urls-btn', function() {
    generateBysideUrls();
});

// Copy all URLs button click handler
$(document).on('click', '#copy-urls-btn', function() {
    const urls = campaignConfig.geo_config.byside_urls.map(u => u.url).join('\n');
    navigator.clipboard.writeText(urls).then(() => {
        const btn = $(this);
        const originalText = btn.text();
        btn.text('Kopieret!').addClass('bg-green-200 text-green-800');
        setTimeout(() => {
            btn.text(originalText).removeClass('bg-green-200 text-green-800');
        }, 1500);
    });
});

// Generate byside URLs for EACH selected service - creates separate URL sets per service
function generateBysideUrls() {
    const tbody = $('#byside-urls-body');
    tbody.empty();

    // Initialize data structures for multiple services
    campaignConfig.geo_config.byside_urls = [];  // Keep for backward compatibility
    campaignConfig.geo_config.byside_urls_by_service = {};

    // Get selected regions and their cities
    const selectedRegionIds = campaignConfig.geographic_region_ids;
    if (selectedRegionIds.length === 0) {
        tbody.html('<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">V√¶lg mindst √©n region ovenfor</td></tr>');
        return;
    }

    // Get ALL selected services from checkboxes
    const selectedServices = [];
    $('.geo-service-checkbox:checked').each(function() {
        const serviceId = parseInt($(this).data('service-id'));
        const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
        const serviceName = serviceCard.find('h4').text().trim() || 'service';
        selectedServices.push({ id: serviceId, name: serviceName });
    });

    // Fallback to industry if no services selected
    if (selectedServices.length === 0) {
        const industryCard = $('.industry-card.selected').first();
        const industryName = industryCard.find('h4').text().trim() || 'branche';
        selectedServices.push({ id: 'industry', name: industryName });
    }

    // Collect all cities from selected regions
    const allCities = [];
    selectedRegionIds.forEach(regionId => {
        const regionCard = $(`.geographic-region-card[data-region-id="${regionId}"]`);
        const citiesData = regionCard.data('cities');
        if (citiesData && Array.isArray(citiesData)) {
            citiesData.forEach(city => {
                const cityName = typeof city === 'string' ? city : city.name;
                if (!allCities.includes(cityName)) {
                    allCities.push(cityName);
                }
            });
        }
    });

    if (allCities.length === 0) {
        tbody.html('<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">Ingen byer fundet i valgte regioner</td></tr>');
        return;
    }

    // Generate URLs for EACH selected service
    selectedServices.forEach(service => {
        const serviceSlug = danishSlug(service.name);
        const serviceUrls = [];

        allCities.forEach(cityName => {
            const bySlug = danishSlug(cityName);
            const url = `/${serviceSlug}-${bySlug}/`;

            const urlEntry = {
                city: cityName,
                url: url,
                keyword: `${service.name} ${cityName}`,
                serviceName: service.name,
                serviceId: service.id,
                exists: false,
                edited: false
            };

            serviceUrls.push(urlEntry);
            campaignConfig.geo_config.byside_urls.push(urlEntry);  // Also add to flat array for compatibility
        });

        campaignConfig.geo_config.byside_urls_by_service[service.id] = serviceUrls;
    });

    // Render table with service grouping
    selectedServices.forEach(service => {
        const serviceUrls = campaignConfig.geo_config.byside_urls_by_service[service.id];

        // Add service header row
        tbody.append(`
            <tr class="bg-green-50">
                <td colspan="4" class="px-4 py-2 font-semibold text-green-800">
                    <span class="inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        ${escapeHtml(service.name)} (${serviceUrls.length} URLs)
                    </span>
                </td>
            </tr>
        `);

        // Add URL rows for this service (show first 5 + summary)
        const displayUrls = serviceUrls.slice(0, 5);
        displayUrls.forEach(urlEntry => {
            tbody.append(`
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-2 text-gray-900 pl-8">${escapeHtml(urlEntry.city)}</td>
                    <td class="px-4 py-2 font-mono text-sm text-purple-600">${escapeHtml(urlEntry.url)}</td>
                    <td class="px-4 py-2 text-gray-600 text-sm">${escapeHtml(urlEntry.keyword)}</td>
                    <td class="px-4 py-2 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Klar</span>
                    </td>
                </tr>
            `);
        });

        // Show remaining count if more than 5
        if (serviceUrls.length > 5) {
            tbody.append(`
                <tr class="border-b border-gray-100 bg-gray-50">
                    <td colspan="4" class="px-4 py-2 text-center text-gray-500 text-sm pl-8">
                        + ${serviceUrls.length - 5} flere URLs for ${escapeHtml(service.name)}...
                    </td>
                </tr>
            `);
        }
    });

    // Update summary info
    const totalUrls = campaignConfig.geo_config.byside_urls.length;
    const totalCampaigns = selectedServices.length;
    $('#geo-campaign-summary').html(`
        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-sm font-medium text-blue-800">
                Der vil blive oprettet <strong>${totalCampaigns}</strong> separate GEO kampagne${totalCampaigns > 1 ? 'r' : ''}:
            </p>
            <ul class="text-sm text-blue-700 mt-2 space-y-1">
                ${selectedServices.map(s => `<li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>${escapeHtml(s.name)} - GEO Kampagne</li>`).join('')}
            </ul>
            <p class="text-xs text-blue-600 mt-2">Total: ${totalUrls} URLs fordelt p√• ${allCities.length} byer</p>
        </div>
    `);
}

// Download URLs for WordPress import
$(document).on('click', '#download-urls-btn', function() {
    const urls = campaignConfig.geo_config.byside_urls;
    if (urls.length === 0) {
        alert('Ingen URLs at downloade. Klik "Generer" f√∏rst.');
        return;
    }

    // Create CSV content
    let csv = 'by,url\n';
    urls.forEach(u => {
        csv += `"${u.city}","${u.url}"\n`;
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'byside_urls.csv';
    link.click();
});

// =====================================================
// Update navigation to trigger step initialization
// =====================================================

// Override updateWizardState to handle step-specific initialization
const originalUpdateWizardState = updateWizardState;
updateWizardState = function() {
    originalUpdateWizardState();

    // Step-specific initializations
    if (currentStep === 4) {
        // Geo targeting step - populate services
        populateGeoServicesContainer();
    } else if (currentStep === 5) {
        // Campaign builder step
        initializeCampaignsBuilder();
    }
};

// =====================================================
// Service Keyword Edit/Delete Functions (Step 5)
// =====================================================

// Delete service keyword via AJAX
$(document).on('click', '.delete-service-keyword-btn', function(e) {
    e.stopPropagation();
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const keywordItem = $(this).closest('.keyword-item');
    const keywordText = keywordItem.find('.keyword-text').text();

    if (!confirm(`Er du sikker p√• at du vil slette s√∏geordet "${keywordText}"?`)) {
        return;
    }

    $.ajax({
        url: `/ajax/delete-service-keyword/${keywordId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // Remove from UI
                keywordItem.fadeOut(200, function() {
                    $(this).remove();
                });

                // Update serverData.google_keywords for this service
                if (serverData.google_keywords[serviceId]) {
                    serverData.google_keywords[serviceId] = serverData.google_keywords[serviceId].filter(kw => kw.id !== keywordId);
                }

                // Update campaignConfig.campaigns as well
                Object.values(campaignConfig.campaigns).forEach(campaign => {
                    if (campaign.ad_groups && campaign.ad_groups[serviceId]) {
                        campaign.ad_groups[serviceId].keywords = campaign.ad_groups[serviceId].keywords.filter(kw => kw.id !== keywordId);
                    }
                });

                console.log('Keyword deleted successfully:', keywordId);
            } else {
                alert('Kunne ikke slette s√∏geordet: ' + (response.error || 'Ukendt fejl'));
            }
        },
        error: function(xhr) {
            console.error('Error deleting keyword:', xhr);
            alert('Fejl ved sletning af s√∏geord. Pr√∏v igen.');
        }
    });
});

// Edit service keyword via AJAX - show inline edit form
$(document).on('click', '.edit-service-keyword-btn', function(e) {
    e.stopPropagation();
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const keywordItem = $(this).closest('.keyword-item');
    const keywordTextSpan = keywordItem.find('.keyword-text');
    const currentText = keywordTextSpan.text();

    // Replace keyword text with input field for editing
    const inputHtml = `
        <input type="text" class="keyword-edit-input text-xs px-1 py-0.5 border border-blue-300 rounded w-24 focus:ring-1 focus:ring-blue-500"
               value="${escapeHtml(currentText)}" data-keyword-id="${keywordId}" data-service-id="${serviceId}" data-original="${escapeHtml(currentText)}">
        <button type="button" class="save-keyword-edit-btn text-green-600 hover:text-green-800 text-xs ml-1" title="Gem">‚úì</button>
        <button type="button" class="cancel-keyword-edit-btn text-gray-400 hover:text-gray-600 text-xs ml-1" title="Annuller">‚úï</button>
    `;

    keywordTextSpan.html(inputHtml);
    keywordTextSpan.find('.keyword-edit-input').focus().select();

    // Hide action buttons while editing
    keywordItem.find('.keyword-actions').addClass('hidden');
});

// Save keyword edit
$(document).on('click', '.save-keyword-edit-btn', function(e) {
    e.stopPropagation();
    const input = $(this).siblings('.keyword-edit-input');
    const keywordId = input.data('keyword-id');
    const serviceId = input.data('service-id');
    const newText = input.val().trim();
    const originalText = input.data('original');

    if (!newText) {
        alert('S√∏geord kan ikke v√¶re tomt');
        return;
    }

    if (newText === originalText) {
        // No changes, just restore
        restoreKeywordDisplay(input, originalText);
        return;
    }

    $.ajax({
        url: `/ajax/update-service-keyword/${keywordId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        data: {
            keyword_text: newText
        },
        success: function(response) {
            if (response.success) {
                // Update UI with new text
                restoreKeywordDisplay(input, newText);

                // Update serverData.google_keywords
                if (serverData.google_keywords[serviceId]) {
                    const kwIndex = serverData.google_keywords[serviceId].findIndex(kw => kw.id === keywordId);
                    if (kwIndex !== -1) {
                        serverData.google_keywords[serviceId][kwIndex].keyword_text = newText;
                    }
                }

                // Update campaignConfig
                Object.values(campaignConfig.campaigns).forEach(campaign => {
                    if (campaign.ad_groups && campaign.ad_groups[serviceId]) {
                        const kwIndex = campaign.ad_groups[serviceId].keywords.findIndex(kw => kw.id === keywordId);
                        if (kwIndex !== -1) {
                            campaign.ad_groups[serviceId].keywords[kwIndex].keyword = newText;
                        }
                    }
                });

                console.log('Keyword updated successfully:', keywordId, newText);
            } else {
                alert('Kunne ikke opdatere s√∏geordet: ' + (response.error || 'Ukendt fejl'));
                restoreKeywordDisplay(input, originalText);
            }
        },
        error: function(xhr) {
            console.error('Error updating keyword:', xhr);
            alert('Fejl ved opdatering af s√∏geord. Pr√∏v igen.');
            restoreKeywordDisplay(input, originalText);
        }
    });
});

// Cancel keyword edit
$(document).on('click', '.cancel-keyword-edit-btn', function(e) {
    e.stopPropagation();
    const input = $(this).siblings('.keyword-edit-input');
    const originalText = input.data('original');
    restoreKeywordDisplay(input, originalText);
});

// Handle Enter/Escape in keyword edit input
$(document).on('keydown', '.keyword-edit-input', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        $(this).siblings('.save-keyword-edit-btn').click();
    } else if (e.key === 'Escape') {
        e.preventDefault();
        $(this).siblings('.cancel-keyword-edit-btn').click();
    }
});

// Helper function to restore keyword display after editing
function restoreKeywordDisplay(input, text) {
    const keywordTextSpan = input.parent();
    const keywordItem = keywordTextSpan.closest('.keyword-item');

    keywordTextSpan.text(text);
    keywordItem.find('.keyword-actions').removeClass('hidden');
}

// ==========================================
// GEOGRAPHIC MAP MODAL - DAWA + Google Maps
// ==========================================

// =============================================================================
// LEAFLET POLYGON-BASED GEO MAP (replacing circle-based Google Maps approach)
// =============================================================================

var geoMap = null;  // Leaflet map instance
var geoGeoJsonLayer = null;  // Layer containing all postal code polygons
var geoPostalData = {};  // { postalCode: { geometry, navn, polygon } }
var geoSelectedPostals = {};  // { postalCode: { source: 'region'|'typed'|'clicked'|'circle', polygon } }
var geoCircleMode = false;  // Toggle for circle drawing mode
var geoCircles = [];  // Array of Leaflet circles (for optional circle mode)
var geoCircleDrawing = null;  // Current circle being drawn

// Color scheme for different selection sources
var GEO_COLORS = {
    region: { fill: '#3B82F6', stroke: '#2563EB' },    // Blue - from region selection
    typed: { fill: '#10B981', stroke: '#059669' },     // Green - manually typed
    clicked: { fill: '#8B5CF6', stroke: '#7C3AED' },   // Purple - clicked on map
    circle: { fill: '#F59E0B', stroke: '#D97706' },    // Orange - circle mode
    hover: { fill: '#6366F1', stroke: '#4F46E5' },     // Indigo - hover state
    default: { fill: '#E5E7EB', stroke: '#9CA3AF' }    // Gray - unselected
};

// Load DAWA GeoJSON data for all postal codes
function loadDAWAGeoJSON() {
    if (Object.keys(geoPostalData).length > 0) {
        return Promise.resolve(geoPostalData);
    }

    console.log('Loading DAWA GeoJSON data...');
    return $.ajax({
        url: 'https://dawa.aws.dk/postnumre?format=geojson',
        timeout: 30000,
        dataType: 'json'
    }).then(function(geojson) {
        console.log('DAWA GeoJSON loaded:', geojson.features.length, 'postal codes');

        // Build lookup by postal code
        geojson.features.forEach(function(feature) {
            var nr = feature.properties.nr;
            geoPostalData[nr] = {
                nr: nr,
                navn: feature.properties.navn,
                geometry: feature.geometry,
                polygon: null  // Will be set when added to map
            };
        });

        return geoPostalData;
    }).catch(function(error) {
        console.error('Error loading DAWA GeoJSON:', error);
        alert('Kunne ikke hente postnummer-data. Pr√∏v igen senere.');
        throw error;
    });
}

// Initialize Leaflet map with Danish postal code polygons
function initGeoModal() {
    var mapContainer = document.getElementById('geo-modal-map');
    if (!mapContainer) {
        console.error('geo-modal-map element not found');
        return Promise.reject('Map container not found');
    }

    // If map already exists, just return
    if (geoMap) {
        geoMap.invalidateSize();
        return Promise.resolve();
    }

    // Create Leaflet map centered on Denmark
    geoMap = L.map('geo-modal-map', {
        center: [55.670523, 12.583819],  // Copenhagen
        zoom: 7,
        minZoom: 5,
        maxZoom: 18
    });

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(geoMap);

    // Load and display postal code polygons
    return loadDAWAGeoJSON().then(function(postalData) {
        // Create GeoJSON features array
        var features = Object.values(postalData).map(function(postal) {
            return {
                type: 'Feature',
                properties: { nr: postal.nr, navn: postal.navn },
                geometry: postal.geometry
            };
        });

        // Add GeoJSON layer with styling
        geoGeoJsonLayer = L.geoJSON({ type: 'FeatureCollection', features: features }, {
            style: getPolygonStyle,
            onEachFeature: onEachPostalFeature
        }).addTo(geoMap);

        // Store polygon references
        geoGeoJsonLayer.eachLayer(function(layer) {
            var nr = layer.feature.properties.nr;
            if (geoPostalData[nr]) {
                geoPostalData[nr].polygon = layer;
            }
        });

        console.log('Geo map initialized with', features.length, 'postal polygons');

        // Sync any pre-selected regions
        syncRegionsToMap();
        updateGeoSelectionDisplay();
    });
}

// Get style for a postal code polygon
function getPolygonStyle(feature) {
    var nr = feature.properties.nr;
    var selected = geoSelectedPostals[nr];

    if (selected) {
        var colors = GEO_COLORS[selected.source] || GEO_COLORS.clicked;
        return {
            fillColor: colors.fill,
            fillOpacity: 0.4,
            color: colors.stroke,
            weight: 2,
            opacity: 0.8
        };
    }

    return {
        fillColor: GEO_COLORS.default.fill,
        fillOpacity: 0.1,
        color: GEO_COLORS.default.stroke,
        weight: 1,
        opacity: 0.5
    };
}

// Attach events to each postal code polygon
function onEachPostalFeature(feature, layer) {
    var nr = feature.properties.nr;
    var navn = feature.properties.navn;

    // Tooltip showing postal code info
    layer.bindTooltip(nr + ' ' + navn, { sticky: true });

    // Hover effects
    layer.on('mouseover', function(e) {
        if (!geoSelectedPostals[nr]) {
            layer.setStyle({
                fillColor: GEO_COLORS.hover.fill,
                fillOpacity: 0.3,
                weight: 2
            });
        }
    });

    layer.on('mouseout', function(e) {
        if (!geoSelectedPostals[nr]) {
            layer.setStyle(getPolygonStyle(feature));
        }
    });

    // Click to toggle selection
    layer.on('click', function(e) {
        if (geoCircleMode) return;  // Ignore clicks in circle mode

        togglePostalSelection(nr, 'clicked');
        L.DomEvent.stopPropagation(e);
    });
}

// Toggle selection of a postal code
function togglePostalSelection(postalCode, source) {
    postalCode = String(postalCode);

    if (geoSelectedPostals[postalCode]) {
        // Deselect
        delete geoSelectedPostals[postalCode];
    } else {
        // Select
        geoSelectedPostals[postalCode] = { source: source };
    }

    // Update polygon style
    if (geoPostalData[postalCode] && geoPostalData[postalCode].polygon) {
        geoPostalData[postalCode].polygon.setStyle(
            getPolygonStyle({ properties: { nr: postalCode } })
        );
    }

    updateGeoSelectionDisplay();
}

// Select a postal code (without toggle)
function selectPostal(postalCode, source) {
    postalCode = String(postalCode);

    if (!geoSelectedPostals[postalCode]) {
        geoSelectedPostals[postalCode] = { source: source };

        if (geoPostalData[postalCode] && geoPostalData[postalCode].polygon) {
            geoPostalData[postalCode].polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    }
}

// Deselect a postal code
function deselectPostal(postalCode) {
    postalCode = String(postalCode);

    if (geoSelectedPostals[postalCode]) {
        delete geoSelectedPostals[postalCode];

        if (geoPostalData[postalCode] && geoPostalData[postalCode].polygon) {
            geoPostalData[postalCode].polygon.setStyle(
                getPolygonStyle({ properties: { nr: postalCode } })
            );
        }
    }
}

// Add region's cities as selected postal codes (polygon-based)
function addRegionToGeoMap(regionId, regionName, cities) {
    if (!cities || cities.length === 0) return;

    loadDAWAGeoJSON().then(function() {
        cities.forEach(function(city) {
            // Try to match by postal code from dawa_name or direct postal lookup
            var postalCode = null;

            // If city has a dawa_name that looks like a postal code
            if (city.dawa_name && /^\d{4}$/.test(city.dawa_name)) {
                postalCode = city.dawa_name;
            } else {
                // Search for matching postal code by name
                for (var nr in geoPostalData) {
                    if (geoPostalData[nr].navn.toLowerCase() === (city.dawa_name || city.name || '').toLowerCase()) {
                        postalCode = nr;
                        break;
                    }
                }
            }

            if (postalCode && geoPostalData[postalCode]) {
                selectPostal(postalCode, 'region');
            }
        });

        updateGeoSelectionDisplay();

        // Pan to show selected area
        fitMapToSelection();
    });
}

// Remove region's postal codes from selection
function removeRegionFromGeoMap(regionId) {
    // For now, we need to track which postals came from which region
    // This is simplified - in a full implementation you'd track regionId per postal
    updateGeoSelectionDisplay();
}

// Fit map bounds to show all selected postal codes
function fitMapToSelection() {
    if (!geoMap) return;

    var selectedPostals = Object.keys(geoSelectedPostals);
    if (selectedPostals.length === 0) return;

    var bounds = L.latLngBounds();
    selectedPostals.forEach(function(nr) {
        if (geoPostalData[nr] && geoPostalData[nr].polygon) {
            bounds.extend(geoPostalData[nr].polygon.getBounds());
        }
    });

    if (bounds.isValid()) {
        geoMap.fitBounds(bounds, { padding: [20, 20] });
    }
}

// Sync selected regions to map polygons
function syncRegionsToMap() {
    $('.geographic-region-card.selected').each(function() {
        var regionId = $(this).data('region-id');
        var regionName = $(this).data('region-name');
        var cities = $(this).data('cities') || [];
        addRegionToGeoMap(regionId, regionName, cities);
    });
}

// Update the display of selected postal codes
function updateGeoSelectionDisplay() {
    var selectedList = [];

    for (var nr in geoSelectedPostals) {
        var postal = geoPostalData[nr];
        if (postal) {
            selectedList.push(nr + ' ' + postal.navn);
        } else {
            selectedList.push(nr);
        }
    }

    selectedList.sort();

    $('#geo-panel-selected-cities').val(selectedList.join('\n'));
    $('#geo-panel-city-count').text(selectedList.length);
}

// Add postal codes from input field
function addPostalCodesFromInput() {
    var input = $('#geo-postal-input').val();
    if (!input.trim()) return;

    // Parse comma-separated postal codes
    var codes = input.split(/[,\s]+/).map(function(s) { return s.trim(); }).filter(Boolean);

    codes.forEach(function(code) {
        if (/^\d{4}$/.test(code) && geoPostalData[code]) {
            selectPostal(code, 'typed');
        }
    });

    updateGeoSelectionDisplay();
    $('#geo-postal-input').val('');

    // Pan to show new selection
    fitMapToSelection();
}

// Toggle circle drawing mode
function toggleCircleMode() {
    geoCircleMode = !geoCircleMode;

    var btn = $('#toggle-circle-mode');
    if (geoCircleMode) {
        btn.addClass('bg-orange-100 border-orange-500');
        btn.html('<span class="mr-1">‚úì</span> Cirkel-mode aktiv');

        // Add click handler for circle creation
        geoMap.on('click', onCircleModeClick);
    } else {
        btn.removeClass('bg-orange-100 border-orange-500');
        btn.html('<span class="mr-1">‚≠ï</span> Cirkel-tegning');

        // Remove circle click handler
        geoMap.off('click', onCircleModeClick);
    }
}

// Handle click in circle mode
function onCircleModeClick(e) {
    if (!geoCircleMode) return;

    var circle = L.circle(e.latlng, {
        radius: 15000,  // 15km default
        color: GEO_COLORS.circle.stroke,
        fillColor: GEO_COLORS.circle.fill,
        fillOpacity: 0.3,
        weight: 2
    }).addTo(geoMap);

    // Add click to remove
    circle.on('click', function() {
        geoMap.removeLayer(circle);
        geoCircles = geoCircles.filter(function(c) { return c !== circle; });
        selectPostalsInCircles();
    });

    geoCircles.push(circle);
    selectPostalsInCircles();
}

// Select all postal codes that fall within any circle
function selectPostalsInCircles() {
    // First, deselect all circle-sourced postals
    for (var nr in geoSelectedPostals) {
        if (geoSelectedPostals[nr].source === 'circle') {
            deselectPostal(nr);
        }
    }

    // Then check each postal code center against circles
    geoCircles.forEach(function(circle) {
        var center = circle.getLatLng();
        var radius = circle.getRadius();

        for (var nr in geoPostalData) {
            var postal = geoPostalData[nr];
            if (postal.polygon) {
                var postalCenter = postal.polygon.getBounds().getCenter();
                var distance = center.distanceTo(postalCenter);

                if (distance <= radius) {
                    selectPostal(nr, 'circle');
                }
            }
        }
    });

    updateGeoSelectionDisplay();
}

// Clear all selections
function clearAllGeoSelections() {
    // Clear polygon selections
    for (var nr in geoSelectedPostals) {
        deselectPostal(nr);
    }
    geoSelectedPostals = {};

    // Clear circles
    geoCircles.forEach(function(circle) {
        geoMap.removeLayer(circle);
    });
    geoCircles = [];

    updateGeoSelectionDisplay();
}

// Panel open/close functions
function openGeoMapPanel() {
    $('#geo-map-panel-overlay').removeClass('hidden');
    setTimeout(function() {
        $('#geo-map-panel-overlay').removeClass('opacity-0');
        $('#geo-map-panel').removeClass('translate-x-full');

        // Initialize map after panel is visible
        setTimeout(function() {
            initGeoModal().then(function() {
                // Map is ready
            }).catch(function(err) {
                console.error('Error initializing geo modal:', err);
            });
        }, 100);
    }, 10);
}

function closeGeoMapPanel() {
    $('#geo-map-panel').addClass('translate-x-full');
    $('#geo-map-panel-overlay').addClass('opacity-0');
    setTimeout(function() {
        $('#geo-map-panel-overlay').addClass('hidden');
    }, 300);
}

// Event handlers for geographic map panel
$('#open-geo-map-btn').click(function() {
    openGeoMapPanel();
});

$('#close-geo-map-panel').click(function() {
    closeGeoMapPanel();
});

$('#geo-map-panel-overlay').click(function(e) {
    if (e.target === this) closeGeoMapPanel();
});

$('#geo-add-postal-btn').click(function() {
    addPostalCodesFromInput();
});

$('#geo-postal-input').keypress(function(e) {
    if (e.which === 13) {
        e.preventDefault();
        addPostalCodesFromInput();
    }
});

$('#toggle-circle-mode').click(function() {
    toggleCircleMode();
});

$('#clear-geo-map-selection').click(function() {
    clearAllGeoSelections();
});

$('#save-geo-map-selection').click(function() {
    var selectedPostals = Object.keys(geoSelectedPostals);
    var postalNames = selectedPostals.map(function(nr) {
        return geoPostalData[nr] ? geoPostalData[nr].navn : nr;
    });

    // Update the display field in step 4
    if (selectedPostals.length > 0) {
        $('#geo-map-selected-cities').val(postalNames.join(', '));
        $('#geo-map-summary').show();
        $('#geo-map-city-count').text(selectedPostals.length);
    } else {
        $('#geo-map-selected-cities').val('');
        $('#geo-map-summary').hide();
    }

    // Store in campaignConfig for later use
    if (typeof campaignConfig !== 'undefined') {
        campaignConfig.geo_map_targeting = {
            postal_codes: selectedPostals,
            postal_names: postalNames,
            circles: geoCircles.map(function(c) {
                return {
                    lat: c.getLatLng().lat,
                    lng: c.getLatLng().lng,
                    radius: c.getRadius() / 1000
                };
            })
        };
        console.log('Geo targeting saved to campaignConfig:', campaignConfig.geo_map_targeting);
    }

    closeGeoMapPanel();
});
</script>

<!-- Geographic Map Slide Panel -->
<div id="geo-map-panel-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300">
    <div id="geo-map-panel" class="fixed right-0 top-0 h-full w-[900px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
        <!-- Panel Header -->
        <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-green-50 to-blue-50">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center">
                    <span class="mr-2">üåç</span> Geografisk M√•lretning
                </h2>
                <p class="text-sm text-gray-600">V√¶lg postnumre p√• kortet eller skriv dem manuelt</p>
            </div>
            <button type="button" id="close-geo-map-panel" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Map Container (Leaflet) -->
            <div id="geo-modal-map" style="height: 450px; width: 100%;" class="border border-gray-300 rounded-lg mb-4"></div>

            <!-- Postnummer Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Tilf√∏j postnumre manuelt:
                </label>
                <div class="flex gap-2">
                    <input type="text" id="geo-postal-input"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="Indtast postnummer (f.eks. 2100, 2200, 2300)">
                    <button type="button" id="geo-add-postal-btn"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Tilf√∏j
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Skriv et eller flere postnumre adskilt med komma</p>
            </div>

            <!-- Color Legend -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-gray-900 mb-2 flex items-center">
                    <span class="mr-2">üé®</span> Farvekoder:
                </h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded mr-2" style="background-color: #3B82F6;"></span>
                        <span class="text-gray-700">Region-valgte postnumre</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded mr-2" style="background-color: #10B981;"></span>
                        <span class="text-gray-700">Manuelt indtastede</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded mr-2" style="background-color: #8B5CF6;"></span>
                        <span class="text-gray-700">Klikket p√• kort</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded mr-2" style="background-color: #F59E0B;"></span>
                        <span class="text-gray-700">Cirkel-tegning</span>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
                    <span class="mr-2">üìç</span> Instruktioner:
                </h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li><strong>Klik</strong> p√• et postnummer-omr√•de for at v√¶lge/frav√¶lge</li>
                    <li><strong>Skriv</strong> postnumre i feltet ovenfor for at tilf√∏je dem</li>
                    <li><strong>Hold Shift</strong> og klik for at v√¶lge flere omr√•der</li>
                    <li>Region-valgte postnumre vises automatisk i bl√•</li>
                </ul>
            </div>

            <!-- Selected Postal Codes Display -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Valgte postnumre (<span id="geo-panel-city-count" class="font-semibold text-green-600">0</span>):
                </label>
                <textarea id="geo-panel-selected-cities" readonly
                          class="w-full h-24 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                          placeholder="V√¶lg postnumre p√• kortet eller skriv dem manuelt..."></textarea>
            </div>
        </div>

        <!-- Panel Footer -->
        <div class="p-6 border-t border-gray-200 flex justify-between">
            <button type="button" id="clear-geo-map-selection"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Ryd alle valg
            </button>
            <div class="flex gap-3">
                <button type="button" id="toggle-circle-mode"
                        class="px-4 py-2 border border-orange-300 text-orange-700 rounded-lg hover:bg-orange-50 transition-colors">
                    <span class="mr-1">‚≠ï</span> Cirkel-tegning
                </button>
                <button type="button" id="save-geo-map-selection"
                        class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    Gem valg
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API Script -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=Function.prototype"></script>

{% endblock %}