{% extends 'base.html' %}

{% block title %}Branche Manager | Jarvis 1.0{% endblock %}

{% block content %}

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Custom CSS for 3-level hierarchy -->
<style>
.rotate-180 {
    transform: rotate(180deg);
}
.expansion-icon {
    transition: transform 0.2s ease;
}

/* Service Cards Styling */
.service-card {
    transition: all 0.2s ease;
    border: 1px solid #333333;
}

.service-card:hover {
    border-color: rgb(147, 197, 253);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.service-card.expanded {
    border-color: rgb(99, 102, 241);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(147, 197, 253, 0.05));
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
    transform: translateY(-1px);
}

/* Service icon CSS removed */
.service-card.expanded .service-icon-removed {
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.service-card.expanded h5 {
    color: rgb(99, 102, 241);
    font-weight: 600;
}

/* Active service styling with custom colors */
.service-card.active:hover {
    border-color: var(--service-color);
    box-shadow: 0 4px 12px color-mix(in srgb, var(--service-color) 25%, transparent);
}

.service-card.active.expanded {
    border-color: var(--service-color);
    background: linear-gradient(135deg, color-mix(in srgb, var(--service-color) 8%, transparent), color-mix(in srgb, var(--service-color) 3%, transparent));
    box-shadow: 0 8px 25px color-mix(in srgb, var(--service-color) 30%, transparent);
    transform: translateY(-1px);
}

.service-card.active.expanded h5 {
    color: var(--service-color);
    font-weight: 600;
}

/* Keywords table styling */
.keywords-section {
    background-color: #fafafa;
    border-top: 1px solid #e5e7eb;
}

/* Keywords content styling - ensure full width below services */
.keywords-content {
    width: 100%;
    margin-top: 1.5rem;
    margin-bottom: 2rem;
    background-color: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

/* Keyword Tabs Styling */
.keyword-tabs {
    display: flex;
    border-bottom: 2px solid #e5e7eb;
    background: white;
}

.keyword-tab {
    flex: 1;
    padding: 12px 16px;
    text-align: center;
    background: #f8fafc;
    color: #64748b;
    cursor: pointer;
    border: none;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
    font-medium;
}

.keyword-tab:hover {
    background: #e2e8f0;
    color: #475569;
}

.keyword-tab.active {
    background: white;
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.keyword-tab.ads.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.keyword-tab.seo.active {
    color: #059669;
    border-bottom-color: #059669;
}

.keyword-tab.negative.active {
    color: #dc2626;
    border-bottom-color: #dc2626;
}

.tab-content {
    display: none;
    min-height: 200px;
}

.tab-content.active {
    display: block !important;
    opacity: 1;
    visibility: visible;
    height: auto;
    min-height: 200px;
}

/* Enhanced Button Hover Effects */
.edit-btn:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Keyword Edit Mode Styles (from negative keywords manager) */
.edit-mode {
    background-color: #eff6ff !important;
    border-left: 4px solid #3b82f6 !important;
    box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
    transition: all 0.3s ease;
}

.edit-keyword-input {
    border: 2px solid #3b82f6 !important;
    border-radius: 6px;
    transition: all 0.2s ease;
    background-color: white;
}

.edit-keyword-input:focus {
    border-color: #1d4ed8 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.edit-match-type-select {
    border: 2px solid #3b82f6 !important;
    border-radius: 6px;
    transition: all 0.2s ease;
    background-color: white;
}

.edit-match-type-select:focus {
    border-color: #1d4ed8 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-12 p-12 bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
            <span class="text-4xl">üè¢</span>
        </div>
        <h1 class="text-5xl font-bold text-gray-900 mb-4">Branche Manager</h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Administrer brancher, services og keywords til Google Ads kampagner. Opret standard strukturer der kan genbruges p√• tv√¶rs af kampagner.
        </p>
    </div>

    <!-- Quick Actions with Help -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-8">
        <div class="p-6 border-b border-gray-100">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Hurtige Handlinger</h2>
                    <p class="text-sm text-gray-500 mt-1">Start med at oprette din f√∏rste branche, eller udvid eksisterende brancher nedenfor</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="create-industry-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span>Opret Ny Branche</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Industries List -->
    <div class="space-y-8" id="industries-container">
        {% for industry in industries %}
        <div class="industry-section bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8" 
             data-industry-id="{{ industry.id }}" data-is-active="{{ industry.is_active|yesno:'true,false' }}">
            
            <!-- Industry Header (Level 1) -->
            <div class="industry-header p-6 cursor-pointer" 
                 style="background: linear-gradient(135deg, {{ industry.color }}20, {{ industry.color }}10);"
                 onclick="toggleIndustryExpansion({{ industry.id }})">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white" 
                             style="background-color: {{ industry.color }};">
                            {{ industry.icon }}
                        </div>
                        <div>
                            <div class="flex items-center space-x-3 mb-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                    üè¢ Level 1: Branche
                                </span>
                                <h3 class="text-2xl font-bold text-gray-900">{{ industry.name }}</h3>
                            </div>
                            <div class="flex items-center space-x-4 mt-1">
                                <p class="text-gray-600">{{ industry.description|default:"Ingen beskrivelse" }}</p>
                                {% if industry.synonyms %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-blue-100 to-purple-100 text-blue-800 border border-blue-200">
                                    üìù {{ industry.synonyms|length }} synonymer
                                </span>
                                {% endif %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if industry.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if industry.is_active %}Aktiv{% else %}Inaktiv{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="text-right mr-4">
                            <!-- Services Count -->
                            <div class="text-center">
                                <span class="inline-flex items-center justify-center w-8 h-8 text-sm font-bold text-white rounded-full" style="background-color: #8B5CF6;">
                                    {{ industry.services_total }}
                                </span>
                                <p class="text-xs text-gray-500 mt-1">services</p>
                            </div>
                        </div>
                        <button class="edit-industry-btn text-gray-500 hover:text-blue-600 p-2 edit-btn transition-colors duration-200 rounded-lg hover:bg-blue-50" 
                                data-industry-id="{{ industry.id }}" title="Redig√©r branche" 
                                onclick="event.stopPropagation(); openEditIndustryPanel({{ industry.id }}, '{{ industry.name|escapejs }}', '{{ industry.description|default:""|escapejs }}', {{ industry.synonyms|default:"[]"|safe }}, '{{ industry.icon|default:"üè¢"|escapejs }}', '{{ industry.color|default:"#8B5CF6"|escapejs }}', {{ industry.is_active|yesno:'true,false' }}, {{ industry.requires_authorization|yesno:'true,false' }})">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-industry-btn text-gray-500 hover:text-red-600 p-2 edit-btn transition-colors duration-200 rounded-lg hover:bg-red-50" 
                                data-industry-id="{{ industry.id }}" title="Slet branche" onclick="event.stopPropagation(); deleteIndustry({{ industry.id }}, '{{ industry.name }}')">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                        <div class="expansion-icon text-gray-400 transition-transform duration-200">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Services Content (Level 2 - Collapsible) -->
            <div class="services-content" style="display: none;" data-industry-id="{{ industry.id }}">
                <div class="border-t border-gray-200">
                    
                    <!-- Navigation Level Indicator -->
                    <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    üìã Level 2: Services
                                </span>
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium">{{ industry.name }}</span>
                            </div>
                            <button class="collapse-services-btn text-gray-500 hover:text-gray-700 p-1 rounded-lg hover:bg-white transition-colors duration-200" 
                                    onclick="toggleIndustryExpansion({{ industry.id }})" 
                                    title="Luk services oversigt">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Add New Service Form -->
                    <div class="p-6 bg-gray-50 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-medium text-gray-900">‚ûï Tilf√∏j Nye Services</h4>
                            <button class="create-service-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                    data-industry-id="{{ industry.id }}" onclick="createService({{ industry.id }})">
                                Opret Service
                            </button>
                        </div>
                    </div>
                    
                    <!-- Services Grid (Level 2) -->
                    <div class="services-grid p-6" data-industry-id="{{ industry.id }}">
                        {% if industry.industry_services.all %}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            {% for service in industry.industry_services.all %}
                            <div class="service-card bg-white rounded-xl p-4 cursor-pointer{% if service.is_active %} active{% endif %}"
                                 data-service-id="{{ service.id }}" 
                                 data-active="{{ service.is_active|yesno:'true,false' }}"
                                 style="--service-color: {{ service.color|default:'#8B5CF6' }};"
                                 onclick="toggleServiceExpansion({{ service.id }}, {{ industry.id }})">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h5 class="font-medium text-gray-900">{{ service.name }}</h5>
                                                {% if service.service_type == 'industry_keywords' %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200 whitespace-nowrap">
                                                    üè¢ Branche
                                                </span>
                                                {% elif service.service_type == 'synonym_keywords' %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 border border-green-200 whitespace-nowrap">
                                                    üîÑ Synonymer
                                                </span>
                                                {% elif service.service_type == 'service' %}
                                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200 whitespace-nowrap">
                                                    üîß Service
                                                </span>
                                                {% endif %}
                                            </div>
                                            <p class="text-xs text-gray-500">{{ service.keywords_count }} keywords</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <button class="edit-service-btn text-gray-500 hover:text-blue-600 p-2 edit-btn transition-colors duration-200" 
                                                data-service-id="{{ service.id }}" title="Redig√©r service" 
                                                onclick="event.stopPropagation(); editService({{ service.id }})">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                            </svg>
                                        </button>
                                        <button class="delete-service-btn text-gray-500 hover:text-red-600 p-2 edit-btn transition-colors duration-200" 
                                                data-service-id="{{ service.id }}" title="Slet service" 
                                                onclick="event.stopPropagation(); deleteService({{ service.id }}, '{{ service.name }}', {{ industry.id }})">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                {% if service.description %}
                                <p class="text-sm text-gray-600 mb-2">{{ service.description|truncatewords:8 }}</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Keywords Section (Level 3 - Will be dynamically loaded) -->
                        <div id="keywords-section-{{ industry.id }}" class="keywords-section" style="display: none;">
                            <!-- Keywords content will be loaded here via AJAX -->
                        </div>
                        
                        {% else %}
                        <div class="text-center py-12 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl mx-6 mb-6">
                            <div class="w-16 h-16 mx-auto bg-gradient-to-r from-purple-100 to-pink-100 rounded-full flex items-center justify-center mb-4">
                                <span class="text-3xl">‚öôÔ∏è</span>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Ingen services endnu</h4>
                            <p class="text-sm text-gray-600 mb-4">Services er dine konkrete ydelser inden for denne branche</p>
                            <button class="create-service-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 text-sm"
                                    data-industry-id="{{ industry.id }}" onclick="createService({{ industry.id }})">
                                ‚ûï Opret Din F√∏rste Service
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100">
            <div class="w-24 h-24 mx-auto bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl flex items-center justify-center mb-6">
                <span class="text-5xl">üè¢</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3">Ingen brancher endnu</h3>
            <p class="text-gray-600 mb-6 max-w-md mx-auto">
                Brancher hj√¶lper dig med at organisere og genbruge kampagnestrukturer. Start med at oprette din f√∏rste branche.
            </p>
            <button id="create-industry-btn-empty" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-lg hover:shadow-lg transition-all duration-200 text-lg font-medium"
                    onclick="openCreateIndustryPanel()">
                <svg class="w-6 h-6 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Opret Din F√∏rste Branche
            </button>
            
            <div class="mt-8 text-sm text-gray-500">
                <p>üí° <strong>Tip:</strong> Popul√¶re brancher inkluderer H√•ndv√¶rk, Sundhed, Service og Teknologi</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Slide Panel for Create/Edit Industry -->
<div id="slide-panel-overlay" class="fixed bg-black bg-opacity-50 backdrop-blur-sm hidden opacity-0 transition-all duration-300 z-50" style="top: 0; left: 0; right: 0; bottom: 0;">
    <div id="slide-panel" class="fixed right-0 top-0 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" style="width: 1000px; height: 100vh; max-height: 100vh;">

        <!-- Panel Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="slide-panel-title" class="text-2xl font-bold text-white">Panel Title</h2>
                    <p id="slide-panel-subtitle" class="text-purple-100">Panel subtitle</p>
                </div>
                <button id="slide-panel-close" class="text-white hover:text-purple-200 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Panel Content -->
        <div id="slide-panel-content" class="flex-1 p-6 overflow-y-auto min-h-0">
            <!-- Content will be dynamically loaded here -->
        </div>

        <!-- Panel Footer -->
        <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex-shrink-0">
            <div class="flex justify-end space-x-3">
                <button id="slide-panel-cancel" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-all duration-200">
                    Annull√©r
                </button>
                <button id="slide-panel-save" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    Gem
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token -->
{% csrf_token %}

<!-- JavaScript for Industry Manager -->
<script>
// =================================================================
// INDUSTRY MANAGER JAVASCRIPT
// =================================================================

// Global variables  
let currentExpandedIndustry = null;
let currentExpandedService = null;

// Negative keyword lists data from Django context
const negativeKeywordLists = [
    {% for list in negative_keyword_lists %}
    {
        id: {{ list.id }},
        name: "{{ list.name|escapejs }}",
        description: "{{ list.description|escapejs }}",
        keywords_count: {{ list.negative_keywords.count|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Initialize current state based on visible elements on page load
function initializeExpandedState() {
    $('.services-content').each(function() {
        if ($(this).is(':visible')) {
            const industryId = $(this).data('industry-id');
            currentExpandedIndustry = industryId;
            console.log('Found expanded industry on load:', industryId);
        }
    });
}

// Initialize on page load
$(document).ready(function() {
    console.log('Industry Manager loaded');
    
    // Initialize expanded state
    initializeExpandedState();
    
    // Global function assignments for onclick handlers
    window.toggleIndustryExpansion = toggleIndustryExpansion;
    window.toggleServiceExpansion = toggleServiceExpansion;
    window.openCreateIndustryPanel = openCreateIndustryPanel;
    window.openEditIndustryPanel = openEditIndustryPanel;
    window.openSlidePanel = openSlidePanel;
    window.closeSlidePanel = closeSlidePanel;
    window.deleteIndustry = deleteIndustry;
    
    // Create industry button event listener
    $('#create-industry-btn').on('click', function(e) {
        e.preventDefault();
        openCreateIndustryPanel();
    });
    
    // Slide panel close handlers
    $(document).on('click', '#slide-panel-close, #slide-panel-cancel', function(e) {
        e.preventDefault();
        closeSlidePanel();
    });
    
    // Close slide panel when clicking overlay
    $(document).on('click', '#slide-panel-overlay', function(e) {
        if (e.target === this) {
            closeSlidePanel();
        }
    });
    
    console.log('Event listeners attached');
});

// Delete industry function
function deleteIndustry(industryId, industryName) {
    console.log('deleteIndustry called with:', industryId, industryName);
    
    if (confirm(`Er du sikker p√• at du vil slette branchen "${industryName}"?\n\nDette vil ogs√• slette alle tilknyttede services og keywords.`)) {
        console.log('User confirmed deletion');
        
        $.ajax({
            url: `/ajax/delete-industry/${industryId}/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    console.log('Delete successful:', response.message);
                    
                    // Show success message with details
                    let message = response.message;
                    if (response.deleted_services > 0 || response.deleted_keywords > 0) {
                        message += `\n\nSlettet: ${response.deleted_services} services, ${response.deleted_keywords} keywords`;
                    }
                    showToast(message, 'success');
                    
                    // Remove the industry from DOM immediately for better UX
                    $(`.industry-section[data-industry-id="${industryId}"]`).fadeOut(300, function() {
                        $(this).remove();
                    });
                } else {
                    console.error('Delete failed:', response.error);
                    showToast(response.error, 'error');
                }
            },
            error: function(xhr) {
                console.error('Delete error:', xhr);
                const error = xhr.responseJSON?.error || 'Fejl ved sletning af branche';
                showToast(error, 'error');
            }
        });
    } else {
        console.log('User cancelled deletion');
    }
}

// Toggle industry expansion (Level 1)
function toggleIndustryExpansion(industryId) {
    console.log('toggleIndustryExpansion called with ID:', industryId);
    
    const industrySection = $(`.industry-section[data-industry-id="${industryId}"]`);
    const servicesContent = $(`.services-content[data-industry-id="${industryId}"]`);
    const expansionIcon = industrySection.find('.expansion-icon svg');

    if (servicesContent.is(':visible')) {
        // Collapse current industry
        console.log('Collapsing industry', industryId);
        servicesContent.slideUp(300);
        expansionIcon.removeClass('rotate-180');
        currentExpandedIndustry = null;
    } else {
        // Close any other expanded industry first (without recursion)
        if (currentExpandedIndustry && currentExpandedIndustry !== industryId) {
            console.log('Closing previous industry', currentExpandedIndustry);
            const prevIndustrySection = $(`.industry-section[data-industry-id="${currentExpandedIndustry}"]`);
            const prevServicesContent = $(`.services-content[data-industry-id="${currentExpandedIndustry}"]`);
            const prevExpansionIcon = prevIndustrySection.find('.expansion-icon svg');
            
            prevServicesContent.slideUp(300);
            prevExpansionIcon.removeClass('rotate-180');
        }
        
        // Expand this industry
        console.log('Expanding industry', industryId);
        servicesContent.slideDown(300);
        expansionIcon.addClass('rotate-180');
        currentExpandedIndustry = industryId;
    }
}



// Industry and Service CRUD functions
function editIndustry(industryId) {
    console.log('Edit industry:', industryId);
    openEditIndustryModal(industryId);
}


function editService(serviceId) {
    console.log('Edit service:', serviceId);
    openEditServiceModal(serviceId);
}

// Document ready
$(document).ready(function() {
    console.log('Industry Manager loaded');
    
    // Initialize state
    initializeExpandedState();
    
    // Make functions globally available
    window.toggleIndustryExpansion = toggleIndustryExpansion;
    window.toggleServiceExpansion = toggleServiceExpansion;
    window.loadServiceKeywords = loadServiceKeywords;
    window.editIndustry = editIndustry;
    window.deleteIndustry = deleteIndustry;
    window.editService = editService;
    
    // Event handlers for industry and service CRUD
    $('#create-industry-btn').on('click', function() {
        openCreateIndustryModal();
    });
    
    $('#download-template-btn').on('click', function() {
        console.log('Download template clicked');
    });
    
    $(document).on('click', '.create-service-btn', function() {
        const industryId = $(this).data('industry-id');
        openCreateServiceModal(industryId);
    });
    
    // Keyword CRUD operations
    $(document).on('click', '.add-keyword-btn', function() {
        const serviceId = $(this).data('service-id');
        openAddKeywordModal(serviceId);
    });
    
    
});

// =================================================================
// KEYWORD CRUD FUNCTIONS
// =================================================================

// Add keyword modal
function openAddKeywordModal(serviceId) {
    const modalHtml = `
        <div id="add-keyword-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900">Tilf√∏j Nyt Keyword</h3>
                </div>
                <form id="add-keyword-form" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Keyword</label>
                        <input type="text" id="keyword_text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Match Type</label>
                        <select id="match_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="phrase">Phrase Match</option>
                            <option value="broad">Broad Match</option>
                            <option value="exact">Exact Match</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="is_primary" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="text-sm font-medium text-gray-700">Prim√¶rt keyword</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Noter (valgfrit)</label>
                        <input type="text" id="notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddKeywordModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Annull√©r
                        </button>
                        <button type="submit" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                            Tilf√∏j Keyword
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    $('body').append(modalHtml);
    
    $('#add-keyword-form').on('submit', function(e) {
        e.preventDefault();
        addKeyword(serviceId);
    });
}

function closeAddKeywordModal() {
    $('#add-keyword-modal').remove();
}

// Add keyword
function addKeyword(serviceId) {
    const formData = {
        service_id: serviceId,
        keyword_text: $('#keyword_text').val(),
        match_type: $('#match_type').val(),
        is_primary: $('#is_primary').prop('checked'),
        notes: $('#notes').val() || '',
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };
    
    $.ajax({
        url: '/ajax/add-service-keyword/',
        method: 'POST',
        data: formData,
        success: function(response) {
            closeAddKeywordModal();
            // Reload keywords for the current service
            if (currentExpandedService) {
                loadServiceKeywords(currentExpandedService, currentExpandedIndustry);
            }
            showToast('Keyword tilf√∏jet succesfuldt', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Fejl ved tilf√∏jelse af keyword';
            showToast(error, 'error');
        }
    });
}

// Edit keyword


// =================================================================
// SLIDE PANEL FUNCTIONS
// =================================================================

// Slide Panel Functions
function openSlidePanel(title, subtitle, content, saveCallback, buttonText = 'Gem') {
    $('#slide-panel-title').text(title);
    $('#slide-panel-subtitle').text(subtitle);
    $('#slide-panel-content').html(content);
    $('#slide-panel-save').off('click').on('click', saveCallback);
    $('#slide-panel-save').text(buttonText);
    
    $('#slide-panel-overlay').removeClass('hidden');
    setTimeout(() => {
        $('#slide-panel-overlay').removeClass('opacity-0');
        $('#slide-panel').removeClass('translate-x-full');
    }, 10);
}

function closeSlidePanel() {
    $('#slide-panel-overlay').addClass('opacity-0');
    $('#slide-panel').addClass('translate-x-full');
    setTimeout(() => {
        $('#slide-panel-overlay').addClass('hidden');
    }, 300);
}

// Industry creation and editing using slide panel
function openCreateIndustryPanel() {
    const title = "Opret Ny Branche";
    const subtitle = "Defin√©r en ny branche med visuel design";
    const content = generateCreateIndustryContent();
    
    openSlidePanel(title, subtitle, content, saveNewIndustry);
    
    // Initialize live preview for visual settings
    setTimeout(() => {
        setupCreateVisualPreview();
    }, 100);
}

function generateCreateIndustryContent() {
    return `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-medium text-gray-900 mb-4">üìù Grundl√¶ggende Information</h4>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Navn p√• branche *</label>
                        <input type="text" id="create-industry-name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="f.eks. Kloakmester" maxlength="100" required>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="create-industry-name-count">0</span>/100 karakterer
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse af branche</label>
                        <textarea id="create-industry-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Beskrivelse af branche og services..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Synonymer</label>
                        <input type="text" id="create-industry-synonyms" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Kloakfirma, Kloakmand, Afl√∏bsrensning">
                        <p class="text-sm text-gray-500 mt-1">Kommaseparerede alternative navne</p>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">‚öôÔ∏è Status & Indstillinger</h4>

                <div class="space-y-3">
                    <div class="flex items-center">
                        <input type="checkbox" id="create-industry-requires-auth"
                               class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <label for="create-industry-requires-auth" class="ml-3 text-sm font-medium text-gray-700">
                            Kan kr√¶ve autorisation
                        </label>
                    </div>
                    <p class="text-sm text-gray-500">
                        Angiver om branchen kan kr√¶ve autorisation (f.eks. autoriseret elektriker, VVS-installat√∏r).
                    </p>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üé® Visuel Design</h4>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ikon</label>
                        <input type="text" id="create-industry-icon" value="üè¢"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">Emoji eller symbol</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prim√¶rfarve</label>
                        <input type="color" id="create-industry-color" value="#8B5CF6"
                               class="w-full h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üëÅÔ∏è Forh√•ndsvisning</h4>
                
                <div id="create-preview-container">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div id="create-preview-header" class="p-6" style="background: linear-gradient(135deg, #8B5CF620, #8B5CF610);">
                            <div class="flex items-center space-x-4">
                                <div id="create-preview-icon" class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white" 
                                     style="background-color: #8B5CF6;">üè¢</div>
                                <div>
                                    <h3 id="create-preview-name" class="text-2xl font-bold text-gray-900">Branche navn vil vises her</h3>
                                    <p class="text-gray-600">Eksempel p√• hvordan branchen vil se ud</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function setupCreateVisualPreview() {
    // Update preview when name changes
    $('#create-industry-name').on('input', function() {
        const name = $(this).val() || 'Branche navn vil vises her';
        $('#create-preview-name').text(name);
        
        // Update character count
        const count = $(this).val().length;
        $('#create-industry-name-count').text(count);
    });
    
    // Update preview when icon changes
    $('#create-industry-icon').on('input', function() {
        const icon = $(this).val() || 'üè¢';
        $('#create-preview-icon').text(icon);
    });
    
    // Update preview when color changes
    $('#create-industry-color').on('input', function() {
        const color = $(this).val() || '#8B5CF6';
        
        // Update icon background
        $('#create-preview-icon').css('background-color', color);
        
        // Update header gradient background
        $('#create-preview-header').css('background', `linear-gradient(135deg, ${color}20, ${color}10)`);
    });
}

function saveNewIndustry() {
    const synonymsText = $('#create-industry-synonyms').val().trim();
    const synonyms = synonymsText ? synonymsText.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];

    const formData = {
        name: $('#create-industry-name').val(),
        description: $('#create-industry-description').val() || '',
        synonyms: JSON.stringify(synonyms),
        icon: $('#create-industry-icon').val() || 'üè¢',
        color: $('#create-industry-color').val() || '#8B5CF6',
        requires_authorization: $('#create-industry-requires-auth').prop('checked'),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };
    
    $.ajax({
        url: '/ajax/create-industry/',
        method: 'POST',
        data: formData,
        success: function(response) {
            closeSlidePanel();
            location.reload();
            showToast('Branche oprettet succesfuldt', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Fejl ved oprettelse af branche';
            showToast(error, 'error');
        }
    });
}

// Edit Industry Panel
function openEditIndustryPanel(industryId, currentName, currentDescription, currentSynonyms, currentIcon, currentColor, isActive, requiresAuthorization) {
    const title = "Redig√©r Branche";
    const subtitle = "Opdat√©r branche detaljer og visuel design";
    const content = generateEditIndustryContent(industryId, currentName, currentDescription, currentSynonyms, currentIcon, currentColor, isActive, requiresAuthorization);
    
    openSlidePanel(title, subtitle, content, () => updateIndustryWithDynamicSynonyms(industryId));
    
    setTimeout(() => {
        setupEditVisualPreview();
        setupSynonymsManager(currentSynonyms);
    }, 100);
}

function generateEditIndustryContent(industryId, currentName, currentDescription, currentSynonyms, currentIcon, currentColor, isActive, requiresAuthorization) {
    const synonymsString = Array.isArray(currentSynonyms) ? currentSynonyms.join(', ') : '';
    
    return `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-medium text-gray-900 mb-4">üìù Grundl√¶ggende Information</h4>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Navn p√• branche *</label>
                        <input type="text" id="edit-industry-name" value="${currentName}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               maxlength="100" required>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="edit-industry-name-count">${currentName.length}</span>/100 karakterer
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse af branche</label>
                        <textarea id="edit-industry-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">${currentDescription || ''}</textarea>
                    </div>
                    
                    <!-- Dynamic Synonyms Section -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">Synonymer</label>
                            <button type="button" id="add-synonym-btn" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg transition-colors">
                                + Tilf√∏j Synonym
                            </button>
                        </div>
                        
                        <!-- Synonyms List -->
                        <div class="space-y-2 mb-3">
                            <div id="synonyms-container" class="space-y-2">
                                <!-- Synonyms will be populated here -->
                            </div>
                            
                            <!-- Add New Synonym Form (Hidden by default) -->
                            <div id="add-synonym-form" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="new-synonym-text" placeholder="F.eks. VVS-mand, R√∏rtekniker" maxlength="50"
                                           class="flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    <button type="button" id="save-new-synonym" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                                        Gem
                                    </button>
                                    <button type="button" id="cancel-new-synonym" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                                        Annuller
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">Alternative navne for branchen som kan bruges i s√∏gninger</div>
                            </div>
                            
                            <!-- Hidden field for form submission -->
                            <input type="hidden" id="edit-industry-synonyms" value="">
                        </div>
                        
                        <div class="text-xs text-gray-500">Alternative navne som brugere kan s√∏ge efter</div>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">‚öôÔ∏è Status & Indstillinger</h4>

                <div class="space-y-4">
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="edit-industry-is-active" ${isActive ? 'checked' : ''}
                                   class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <label for="edit-industry-is-active" class="ml-3 text-sm font-medium text-gray-700">
                                Branche er aktiv og synlig i systemet
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 ml-8">
                            Inaktive brancher vises stadig i listen men vil ikke v√¶re tilg√¶ngelige i Campaign Builder.
                        </p>
                    </div>

                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="edit-industry-requires-auth" ${requiresAuthorization ? 'checked' : ''}
                                   class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <label for="edit-industry-requires-auth" class="ml-3 text-sm font-medium text-gray-700">
                                Kan kr√¶ve autorisation
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 ml-8">
                            Angiver om branchen kan kr√¶ve autorisation (f.eks. autoriseret elektriker, VVS-installat√∏r).
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üé® Visuel Design</h4>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ikon</label>
                        <input type="text" id="edit-industry-icon" value="${currentIcon || 'üè¢'}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">Emoji eller symbol</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prim√¶rfarve</label>
                        <input type="color" id="edit-industry-color" value="${currentColor || '#8B5CF6'}" 
                               class="w-full h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üëÅÔ∏è Forh√•ndsvisning</h4>
                
                <div id="edit-preview-container">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <div id="edit-preview-header" class="p-6" style="background: linear-gradient(135deg, ${currentColor || '#8B5CF6'}20, ${currentColor || '#8B5CF6'}10);">
                            <div class="flex items-center space-x-4">
                                <div id="edit-preview-icon" class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl text-white" 
                                     style="background-color: ${currentColor || '#8B5CF6'};">${currentIcon || 'üè¢'}</div>
                                <div>
                                    <h3 id="edit-preview-name" class="text-2xl font-bold text-gray-900">${currentName}</h3>
                                    <p class="text-gray-600">Eksempel p√• hvordan branchen vil se ud</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function setupEditVisualPreview() {
    // Update preview when name changes
    $('#edit-industry-name').on('input', function() {
        const name = $(this).val() || 'Branche navn vil vises her';
        $('#edit-preview-name').text(name);
        
        // Update character count
        const count = $(this).val().length;
        $('#edit-industry-name-count').text(count);
    });
    
    // Update preview when icon changes
    $('#edit-industry-icon').on('input', function() {
        const icon = $(this).val() || 'üè¢';
        $('#edit-preview-icon').text(icon);
    });
    
    // Update preview when color changes
    $('#edit-industry-color').on('input', function() {
        const color = $(this).val() || '#8B5CF6';
        
        // Update icon background
        $('#edit-preview-icon').css('background-color', color);
        
        // Update header gradient background
        $('#edit-preview-header').css('background', `linear-gradient(135deg, ${color}20, ${color}10)`);
    });
}

function updateIndustry(industryId) {
    const synonymsText = $('#edit-industry-synonyms').val().trim();
    const synonyms = synonymsText ? synonymsText.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];
    
    const formData = {
        name: $('#edit-industry-name').val(),
        description: $('#edit-industry-description').val() || '',
        synonyms: JSON.stringify(synonyms),
        icon: $('#edit-industry-icon').val() || 'üè¢',
        color: $('#edit-industry-color').val() || '#8B5CF6',
        is_active: $('#edit-industry-is-active').is(':checked'),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };
    
    $.ajax({
        url: `/ajax/edit-industry/${industryId}/`,
        method: 'POST',
        data: formData,
        success: function(response) {
            closeSlidePanel();
            location.reload();
            showToast('Branche opdateret succesfuldt', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Fejl ved opdatering af branche';
            showToast(error, 'error');
        }
    });
}

// =================================================================
// SYNONYMS MANAGEMENT (Dynamic List like USP Headlines)
// =================================================================
let industrySynonyms = [];

function setupSynonymsManager(currentSynonyms) {
    // Initialize synonyms array
    industrySynonyms = Array.isArray(currentSynonyms) ? [...currentSynonyms] : [];
    
    renderSynonyms();
    
    // Event handlers for synonym management
    $('#add-synonym-btn').off('click').on('click', function() {
        $('#add-synonym-form').removeClass('hidden');
        $('#new-synonym-text').focus();
    });
    
    $('#save-new-synonym').off('click').on('click', function() {
        const synonymText = $('#new-synonym-text').val().trim();
        if (synonymText && synonymText.length <= 50) {
            addSynonym(synonymText);
            $('#new-synonym-text').val('');
            $('#add-synonym-form').addClass('hidden');
        }
    });
    
    $('#cancel-new-synonym').off('click').on('click', function() {
        $('#new-synonym-text').val('');
        $('#add-synonym-form').addClass('hidden');
    });
    
    // Enter key to save, Escape to cancel
    $('#new-synonym-text').off('keydown').on('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#save-new-synonym').click();
        } else if (e.key === 'Escape') {
            $('#cancel-new-synonym').click();
        }
    });
}

function renderSynonyms() {
    const container = $('#synonyms-container');
    
    if (industrySynonyms.length === 0) {
        container.html(`
            <div class="text-sm text-gray-500 italic p-4 text-center border border-gray-200 border-dashed rounded-lg">
                Ingen synonymer tilf√∏jet endnu. Klik "Tilf√∏j Synonym" for at komme i gang.
            </div>
        `);
        return;
    }
    
    const synonymsHtml = industrySynonyms.map((synonym, index) => `
        <div class="synonym-item bg-gray-50 border border-gray-200 rounded-lg p-3 transition-all duration-200" data-index="${index}">
            <div class="synonym-display flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs font-semibold">${index + 1}</span>
                    <span class="text-gray-900 font-medium">${synonym}</span>
                </div>
                <div class="flex items-center space-x-1">
                    <button type="button" onclick="editSynonym(${index})" class="text-blue-600 hover:text-blue-700 p-1" title="Redig√©r synonym">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                    <button type="button" onclick="removeSynonym(${index})" class="text-red-600 hover:text-red-700 p-1" title="Fjern synonym">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="synonym-edit hidden">
                <div class="flex items-center space-x-2">
                    <input type="text" class="edit-synonym-input flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" 
                           value="${synonym}" maxlength="50">
                    <span class="edit-char-count text-xs text-gray-500">${synonym.length}/50</span>
                    <button type="button" onclick="saveSynonymEdit(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                        Gem
                    </button>
                    <button type="button" onclick="cancelSynonymEdit(${index})" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                        Annuller
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    container.html(synonymsHtml);
    updateSynonymsHiddenField();
}

function addSynonym(text) {
    if (text && !industrySynonyms.includes(text)) {
        industrySynonyms.push(text);
        renderSynonyms();
    }
}

function removeSynonym(index) {
    if (confirm('Er du sikker p√• at du vil fjerne dette synonym?')) {
        industrySynonyms.splice(index, 1);
        renderSynonyms();
    }
}

function editSynonym(index) {
    const $item = $(`.synonym-item[data-index="${index}"]`);
    $item.find('.synonym-display').addClass('hidden');
    $item.find('.synonym-edit').removeClass('hidden');
    
    const $input = $item.find('.edit-synonym-input');
    $input.focus();
    
    setTimeout(() => {
        $input.select();
    }, 10);
    
    // Live character count
    $input.off('input').on('input', function() {
        const length = $(this).val().length;
        $item.find('.edit-char-count').text(`${length}/50`);
    });
}

function cancelSynonymEdit(index) {
    const $item = $(`.synonym-item[data-index="${index}"]`);
    $item.find('.synonym-edit').addClass('hidden');
    $item.find('.synonym-display').removeClass('hidden');
    
    // Reset input value to original
    const originalValue = industrySynonyms[index];
    $item.find('.edit-synonym-input').val(originalValue);
    $item.find('.edit-char-count').text(`${originalValue.length}/50`);
}

function saveSynonymEdit(index) {
    const $item = $(`.synonym-item[data-index="${index}"]`);
    const $input = $item.find('.edit-synonym-input');
    const newText = $input.val().trim();
    
    if (newText && newText.length <= 50) {
        // Check for duplicates (excluding current item)
        const otherSynonyms = industrySynonyms.filter((s, i) => i !== index);
        if (otherSynonyms.includes(newText)) {
            alert('Dette synonym eksisterer allerede');
            return;
        }
        
        industrySynonyms[index] = newText;
        renderSynonyms();
    } else {
        alert('Synonym skal v√¶re mellem 1 og 50 karakterer');
    }
}

function updateSynonymsHiddenField() {
    $('#edit-industry-synonyms').val(JSON.stringify(industrySynonyms));
}

// Update the updateIndustry function to use the dynamic synonyms
function updateIndustryWithDynamicSynonyms(industryId) {
    const formData = {
        name: $('#edit-industry-name').val(),
        description: $('#edit-industry-description').val() || '',
        synonyms: JSON.stringify(industrySynonyms),  // Use dynamic array instead of text field
        icon: $('#edit-industry-icon').val() || 'üè¢',
        color: $('#edit-industry-color').val() || '#8B5CF6',
        is_active: $('#edit-industry-is-active').is(':checked'),
        requires_authorization: $('#edit-industry-requires-auth').is(':checked'),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };
    
    $.ajax({
        url: `/ajax/edit-industry/${industryId}/`,
        method: 'POST',
        data: formData,
        success: function(response) {
            closeSlidePanel();
            location.reload();
            showToast('Branche opdateret succesfuldt', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Fejl ved opdatering af branche';
            showToast(error, 'error');
        }
    });
}

// Create Service Modal (placeholder for future implementation)
function openCreateServiceModal(industryId) {
    console.log('Create service modal for industry:', industryId);
    showToast('Oprettelse af services kommer snart!', 'success');
}

// Edit Service Modal (placeholder for future implementation)  
function openEditServiceModal(serviceId) {
    console.log('Edit service modal for service:', serviceId);
    showToast('Redigering af services kommer snart!', 'success');
}

// Simple toast notification system
function showToast(message, type = 'success') {
    const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    const toastHtml = `
        <div id="toast" class="fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full">
            <p>${message}</p>
        </div>
    `;
    
    // Remove existing toast
    $('#toast').remove();
    
    // Add new toast
    $('body').append(toastHtml);
    
    // Animate in
    setTimeout(() => {
        $('#toast').removeClass('translate-x-full');
    }, 10);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        $('#toast').addClass('translate-x-full');
        setTimeout(() => {
            $('#toast').remove();
        }, 300);
    }, 3000);
}


// Make deleteIndustry function globally available
window.deleteIndustry = deleteIndustry;

// Service CRUD functions
function createService(industryId) {
    console.log('Create service for industry:', industryId);
    
    const title = 'Opret Ny Service';
    const subtitle = 'Tilf√∏j en ny service til denne branche';
    
    const content = getServiceFormContent();
    
    const saveCallback = function() {
        const formData = {
            industry_id: industryId,
            name: $('#service-name').val(),
            description: $('#service-description').val(),
            color: $('#service-color').val(),
            service_type: $('#service-type').val()
        };
        
        console.log('Creating service with data:', formData);
        
        $.ajax({
            url: '/ajax/create-service/',
            type: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                console.log('Create service response:', response);
                if (response.success) {
                    closeSlidePanel();
                    showToast(response.message, 'success');
                    
                    // Reload the page to show the new service
                    window.location.reload();
                } else {
                    showToast(response.error || 'Fejl ved oprettelse af service', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Create service error:', error);
                showToast('Fejl ved oprettelse af service', 'error');
            }
        });
    };
    
    openSlidePanel(title, subtitle, content, saveCallback);
    setupServiceVisualPreview();
}

function editService(serviceId) {
    console.log('Edit service:', serviceId);
    
    const title = 'Redig√©r Service';
    const subtitle = 'Opdater service information';
    
    // First load current service data from backend
    $.ajax({
        url: `/ajax/edit-service/${serviceId}/`,
        type: 'GET',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                const serviceData = response.service;
                console.log('Loaded service data:', serviceData);
                
                const content = getServiceFormContent();
                
                const saveCallback = function() {
                    const formData = {
                        name: $('#service-name').val(),
                        description: $('#service-description').val(),
                        color: $('#service-color').val(),
                        service_type: $('#service-type').val()
                    };
                    
                    console.log('Editing service with data:', formData);
                    
                    $.ajax({
                        url: `/ajax/edit-service/${serviceId}/`,
                        type: 'POST',
                        data: formData,
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(response) {
                            console.log('Edit service response:', response);
                            if (response.success) {
                                closeSlidePanel();
                                showToast(response.message, 'success');
                                
                                // Reload the page to show updated service
                                window.location.reload();
                            } else {
                                showToast(response.error || 'Fejl ved opdatering af service', 'error');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Edit service error:', error);
                            showToast('Fejl ved opdatering af service', 'error');
                        }
                    });
                };
                
                openSlidePanel(title, subtitle, content, saveCallback);
                setupServiceVisualPreview();
                
                // Pre-populate form with current service data
                setTimeout(() => {
                    $('#service-name').val(serviceData.name || '');
                    $('#service-description').val(serviceData.description || '');
                    $('#service-color').val(serviceData.color || '#8B5CF6');
                    $('#service-type').val(serviceData.service_type || 'service');
                    
                    
                    // Trigger preview updates and auto-defaults
                    $('#service-name, #service-color, #service-type').trigger('input');
                }, 100);
                
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af service data', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading service data:', error);
            showToast('Fejl ved indl√¶sning af service data', 'error');
        }
    });
}

function deleteService(serviceId, serviceName, industryId) {
    console.log('Delete service:', serviceId);
    
    if (confirm(`Er du sikker p√• at du vil slette servicen "${serviceName}"?`)) {
        $.ajax({
            url: `/ajax/delete-service/${serviceId}/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                console.log('Delete service response:', response);
                if (response.success) {
                    // Remove the service element from DOM immediately
                    const serviceElement = $(`.service-card[data-service-id="${serviceId}"]`);
                    console.log('Removing service element:', serviceElement.length);
                    serviceElement.fadeOut(300, function() {
                        $(this).remove();
                        console.log('Service element removed from DOM');
                        
                        // Show success toast
                        showToast(response.message, 'success');
                    });
                } else {
                    showToast(response.error || 'Fejl ved sletning af service', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Delete service error:', error);
                showToast('Fejl ved sletning af service', 'error');
            }
        });
    }
}

function getServiceFormContent() {
    return `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-medium text-gray-900 mb-4">üìù Grundl√¶ggende Information</h4>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                        <select id="service-type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="service">üîß Service (til annoncegrupper)</option>
                            <option value="industry_keywords">üè¢ Branche Keywords (til kampagner)</option>
                            <option value="synonym_keywords">üîÑ Synonym Keywords (til synonymer)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Services bruges til annoncegrupper, branche keywords til kampagner</p>
                    </div>
                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Navn p√• service *</label>
                        <input type="text" id="service-name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="f.eks. Toilet installation" maxlength="100" required>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="service-name-count">0</span>/100 karakterer
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse af service</label>
                        <textarea id="service-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Beskrivelse af servicen og hvad den indeb√¶rer..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üé® Visuel Design</h4>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prim√¶rfarve</label>
                    <input type="color" id="service-color" value="#8B5CF6" 
                           class="w-full h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            
            
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">üëÅÔ∏è Forh√•ndsvisning</h4>
                
                <div id="service-preview-container">
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div>
                            <h5 id="service-preview-name" class="font-medium text-gray-900">Service navn vil vises her</h5>
                            <p class="text-xs text-gray-500">0 keywords</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateNegativeKeywordListsHTML() {
    if (!negativeKeywordLists || negativeKeywordLists.length === 0) {
        return `
            <div class="text-center p-6 bg-gray-50 rounded-lg">
                <span class="text-2xl">üìã</span>
                <h4 class="text-lg font-medium text-gray-900 mb-2">Ingen negative s√∏geordslister fundet</h4>
                <p class="text-sm text-gray-600">Opret f√∏rst nogle negative s√∏geordslister for at kunne v√¶lge dem her.</p>
            </div>
        `;
    }

    let html = `
        <div class="space-y-3">
    `;

    negativeKeywordLists.forEach(list => {
        html += `
            <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                <input type="checkbox" 
                       class="negative-list-checkbox mr-3" 
                       id="negative-list-${list.id}" 
                       value="${list.id}">
                <label for="negative-list-${list.id}" class="flex-1 cursor-pointer">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-medium text-gray-900">${list.name}</h5>
                            <p class="text-sm text-gray-600">${list.description}</p>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${list.keywords_count} keywords
                        </div>
                    </div>
                </label>
            </div>
        `;
    });

    html += `
        </div>
        <div class="mt-4">
            <button type="button" 
                    class="text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200"
                    onclick="selectAllNegativeLists()">
                üìã V√¶lg alle
            </button>
            <span class="mx-2 text-gray-300">|</span>
            <button type="button" 
                    class="text-sm text-gray-600 hover:text-gray-800 transition-colors duration-200"
                    onclick="deselectAllNegativeLists()">
                ‚ùå Frav√¶lg alle
            </button>
        </div>
    `;

    return html;
}

function selectAllNegativeLists() {
    $('.negative-list-checkbox').prop('checked', true);
}

function deselectAllNegativeLists() {
    $('.negative-list-checkbox').prop('checked', false);
}

function setupServiceVisualPreview() {
    // Update defaults when service type changes
    $('#service-type').on('change', function() {
        const type = $(this).val();
        let icon, color, placeholder;
        
        switch(type) {
            case 'industry_keywords':
                icon = 'üè¢';
                color = '#3B82F6';
                placeholder = 'f.eks. VVS Branche Keywords';
                break;
            case 'synonym_keywords':
                icon = 'üîÑ';
                color = '#059669';
                placeholder = 'f.eks. VVS Synonymer';
                break;
            default: // service
                icon = '‚öôÔ∏è';
                color = '#8B5CF6';
                placeholder = 'f.eks. Toilet installation';
                break;
        }
        
        $('#service-color').val(color);
        $('#service-name').attr('placeholder', placeholder);
        
        // Update preview (color removed since no icon)
    });

    // Update preview when name changes
    $('#service-name').on('input', function() {
        const name = $(this).val() || 'Service navn vil vises her';
        $('#service-preview-name').text(name);
        
        // Update character count
        const count = $(this).val().length;
        $('#service-name-count').text(count);
    });
    
    
    // Update preview when color changes (no icon to update anymore)
    $('#service-color').on('input', function() {
        // Color preview removed since service icons are removed
    });
}

// Helper function to convert RGB to hex
function rgbToHex(rgb) {
    if (!rgb) return null;
    
    const result = rgb.match(/\d+/g);
    if (!result || result.length < 3) return null;
    
    const r = parseInt(result[0]);
    const g = parseInt(result[1]);
    const b = parseInt(result[2]);
    
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// Make service functions globally available
window.createService = createService;
window.editService = editService;
window.deleteService = deleteService;

// Keywords management functionality
let currentKeywordEditId = null;

function toggleServiceExpansion(serviceId, industryId) {
    console.log('toggleServiceExpansion called with serviceId:', serviceId, 'industryId:', industryId);
    console.log('Current expanded service:', currentExpandedService);
    
    const keywordsSection = $(`#keywords-section-${industryId}`);
    const currentServiceCard = $(`.service-card[data-service-id="${serviceId}"]`);
    
    if (currentExpandedService === serviceId) {
        // Same service clicked - close keywords and remove active styling
        console.log('Closing keywords for same service:', serviceId);
        keywordsSection.slideUp(300);
        currentServiceCard.removeClass('expanded');
        currentExpandedService = null;
    } else {
        // Remove expanded class from previously active service
        if (currentExpandedService !== null) {
            $(`.service-card[data-service-id="${currentExpandedService}"]`).removeClass('expanded');
        }
        
        // Add expanded class to new active service
        currentServiceCard.addClass('expanded');
        
        if (currentExpandedService !== null) {
            // Different service clicked while another is open - switch directly
            console.log('Switching from service', currentExpandedService, 'to service', serviceId);
            currentExpandedService = serviceId;
            loadServiceKeywords(serviceId, industryId);
        } else {
            // No service open - open this one
            console.log('Opening keywords for service:', serviceId);
            currentExpandedService = serviceId;
            loadServiceKeywords(serviceId, industryId);
        }
    }
}

function loadServiceKeywords(serviceId, industryId) {
    console.log('Loading keywords for service:', serviceId);
    
    const keywordsSection = $(`#keywords-section-${industryId}`);
    
    // Show loading state
    keywordsSection.html('<div class="p-6 text-center"><span class="text-gray-500">Indl√¶ser keywords...</span></div>');
    keywordsSection.show();
    
    $.ajax({
        url: `/ajax/get-service-keywords/${serviceId}/`,
        type: 'GET',
        success: function(response) {
            console.log('Keywords loaded:', response);
            if (response.success) {
                const keywordsHtml = generateKeywordsHtml(serviceId, response.keywords, response.service_name);
                keywordsSection.html(keywordsHtml);
                keywordsSection.slideDown(300);
                
                // Update keyword counter for this service after keywords are loaded
                setTimeout(() => updateServiceKeywordCounter(serviceId), 100);
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af keywords', 'error');
                keywordsSection.hide();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading keywords:', error);
            showToast('Fejl ved indl√¶sning af keywords', 'error');
            keywordsSection.hide();
        }
    });
}

function generateKeywordsHtml(serviceId, keywords, serviceName) {
    return `
        <div class="keywords-content border-t border-gray-200" data-service-id="${serviceId}">
            <!-- Tab Navigation -->
            <div class="keyword-tabs">
                <button class="keyword-tab ads active" onclick="switchKeywordTab(${serviceId}, 'ads')" data-tab="ads">
                    üìä Google Ads Keywords
                </button>
                <button class="keyword-tab seo" onclick="switchKeywordTab(${serviceId}, 'seo')" data-tab="seo">
                    üåê SEO Keywords
                </button>
                <button class="keyword-tab meta" onclick="switchKeywordTab(${serviceId}, 'meta')" data-tab="meta">
                    üìù Meta Eksempler
                </button>
                <button class="keyword-tab negative" onclick="switchKeywordTab(${serviceId}, 'negative')" data-tab="negative">
                    üö´ Negative Keywords
                </button>
            </div>

            <!-- Google Ads Tab Content -->
            <div id="tab-content-ads-${serviceId}" class="tab-content active">
                ${generateGoogleAdsKeywordsContent(serviceId, keywords, serviceName)}
            </div>

            <!-- SEO Tab Content -->
            <div id="tab-content-seo-${serviceId}" class="tab-content">
                ${generateSEOKeywordsContent(serviceId, serviceName)}
            </div>

            <!-- Meta Examples Tab Content -->
            <div id="tab-content-meta-${serviceId}" class="tab-content">
                ${generateMetaExamplesContent(serviceId, serviceName)}
            </div>

            <!-- Negative Keywords Tab Content -->
            <div id="tab-content-negative-${serviceId}" class="tab-content">
                ${generateNegativeKeywordsContent(serviceId, serviceName)}
            </div>
        </div>
    `;
}

function generateGoogleAdsKeywordsContent(serviceId, keywords, serviceName) {
    let keywordsTableHtml = '';
    
    if (keywords.length > 0) {
        keywordsTableHtml = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Prim√¶r</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="keywords-table-body-${serviceId}">`;
        
        keywords.forEach(keyword => {
            keywordsTableHtml += generateKeywordRowHtml(keyword);
        });
        
        keywordsTableHtml += '</tbody></table></div>';
    } else {
        keywordsTableHtml = `
            <div class="text-center py-12 text-gray-500">
                <span class="text-4xl">üìä</span>
                <p class="mt-2">Ingen Google Ads keywords endnu</p>
                <p class="text-sm">Tilf√∏j dit f√∏rste keyword nedenfor</p>
            </div>`;
    }
    
    return `
        <div class="p-6">
            <!-- Add New Google Ads Keyword Form -->
            <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-medium text-blue-900">üìä Tilf√∏j Google Ads Keywords til "${serviceName}"</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" placeholder="Google Ads keyword..." 
                           class="new-service-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           data-service-id="${serviceId}">
                    <select class="new-service-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            data-service-id="${serviceId}">
                        <option value="broad">Broad Match</option>
                        <option value="phrase">Phrase Match</option>
                        <option value="exact">Exact Match</option>
                    </select>
                    <button class="add-service-keyword-btn bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                            data-service-id="${serviceId}">
                        üìù Tilf√∏j Keyword
                    </button>
                </div>
            </div>
            
            <!-- Google Ads Keywords Table -->
            <div class="keywords-list bg-white rounded-lg border border-gray-200" data-service-id="${serviceId}">
                ${keywordsTableHtml}
            </div>
        </div>
    `;
}

function generateSEOKeywordsContent(serviceId, serviceName) {
    return `
        <div class="p-6">
            <!-- Add New SEO Keyword Form -->
            <div class="mb-6 bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-medium text-green-900">üåê Tilf√∏j SEO Keywords til "${serviceName}"</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="text" placeholder="SEO keyword..." 
                           class="new-seo-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           data-service-id="${serviceId}">
                    <select class="new-seo-keyword-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            data-service-id="${serviceId}">
                        <option value="money" selected>Money Keyword</option>
                        <option value="price">Pris Keyword</option>
                        <option value="info">Informations Keyword</option>
                        <option value="lsi">LSI Keyword</option>
                    </select>
                    <input type="number" placeholder="S√∏gevolumen" 
                           class="new-seo-keyword-volume px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           data-service-id="${serviceId}">
                    <button class="add-seo-keyword-btn bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                            data-service-id="${serviceId}"
                            onclick="addSEOKeyword(${serviceId})">
                        üåê Tilf√∏j SEO Keyword
                    </button>
                </div>
            </div>
            
            <!-- SEO Keywords Table (will be loaded via AJAX) -->
            <div id="seo-keywords-table-${serviceId}" class="bg-white rounded-lg border border-gray-200">
                <div class="text-center py-12 text-gray-500">
                    <span class="text-4xl">üåê</span>
                    <p class="mt-2">Loading SEO keywords...</p>
                </div>
            </div>
        </div>
    `;
}

function generateNegativeKeywordsContent(serviceId, serviceName) {
    return `
        <div class="p-6">
            <!-- Negative Keywords Header -->
            <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-medium text-red-900">üö´ Negative Keywords for "${serviceName}"</h4>
                    <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm"
                            onclick="showAddNegativeListModal(${serviceId}, currentExpandedIndustry)">
                        ‚ûï Opret Ny Liste
                    </button>
                </div>
                <p class="text-sm text-red-700">Tilknyttede negative s√∏geordslister som vil blive anvendt i denne service</p>
            </div>

            <!-- Connected Lists as Buttons -->
            <div id="negative-lists-buttons-${serviceId}" class="mb-6">
                <h5 class="font-medium text-gray-900 mb-3">Tilknyttede Lister</h5>
                <div class="flex flex-wrap gap-2" id="connected-lists-${serviceId}">
                    <!-- Connected lists will be loaded here as buttons -->
                </div>
                <div class="text-center py-6 text-gray-500" id="no-lists-message-${serviceId}">
                    <span class="text-3xl">üìã</span>
                    <p class="mt-2">Ingen negative s√∏geordslister tilknyttet endnu</p>
                    <p class="text-sm">Klik "‚ûï Opret Ny Liste" for at oprette en ny liste</p>
                </div>
            </div>

            <!-- Keywords Content Section (shown when a list is selected) -->
            <div id="negative-keywords-content-${serviceId}" class="hidden">
                <div class="keywords-content border border-gray-200 rounded-lg" data-service-id="${serviceId}">
                    <div class="border-b border-gray-200">
                        <!-- Add New Keyword Form -->
                        <div class="p-6 bg-gray-50 border-b border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-medium text-gray-900">‚ûï Tilf√∏j Nye Keywords</h4>
                                <button class="import-excel-btn bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2"
                                        data-service-id="${serviceId}"
                                        onclick="openImportExcelForService(${serviceId})"
                                        title="Importer keywords fra Excel fil">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                                    </svg>
                                    <span>Importer Excel</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text"
                                       placeholder="Negativt s√∏geord..."
                                       class="new-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       data-service-id="${serviceId}"
                                       onkeypress="if(event.key==='Enter') addNegativeKeywordToService(${serviceId})">
                                <select class="new-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        data-service-id="${serviceId}">
                                    <option value="broad">Broad Match</option>
                                    <option value="phrase">Phrase Match</option>
                                    <option value="exact">Exact Match</option>
                                </select>
                                <button class="add-keyword-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                        data-service-id="${serviceId}"
                                        onclick="addNegativeKeywordToService(${serviceId})">
                                    Tilf√∏j
                                </button>
                            </div>
                        </div>

                        <!-- Keywords Table -->
                        <div class="keywords-list p-6" data-service-id="${serviceId}">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                                            <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="negative-keywords-tbody-${serviceId}" class="divide-y divide-gray-200">
                                        <!-- Keywords will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="no-keywords-message-${serviceId}" class="text-center py-8 text-gray-500">
                                <span class="text-3xl">üìù</span>
                                <p class="mt-2">Ingen negative keywords endnu</p>
                                <p class="text-sm">Tilf√∏j keywords ovenfor eller importer fra Excel</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Lists for Adding -->
            <div id="available-lists-container-${serviceId}" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h5 class="font-medium text-gray-900 mb-3">Tilg√¶ngelige lister:</h5>
                <div id="available-lists-${serviceId}" class="flex flex-wrap gap-2">
                    <!-- Available lists will be loaded here -->
                </div>
            </div>
        </div>
    `;
}

function generateMetaExamplesContent(serviceId, serviceName) {
    return `
        <div class="p-6">
            <!-- Meta Examples Header -->
            <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-lg font-medium text-indigo-900">üìù Meta Tag Eksempler for "${serviceName}"</h4>
                        <p class="text-sm text-indigo-700 mt-1">AI v√¶lger tilf√¶ldigt max 10 af disse som reference ved generering</p>
                    </div>
                    <button class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 text-sm"
                            onclick="showAddMetaExampleForm(${serviceId})">
                        ‚ûï Tilf√∏j Eksempel
                    </button>
                </div>
            </div>

            <!-- Add New Meta Example Form (hidden by default) -->
            <div id="add-meta-example-form-${serviceId}" class="hidden mb-6 bg-white p-4 rounded-lg border border-gray-200">
                <h5 class="font-medium text-gray-900 mb-4">Nyt Meta Tag Eksempel</h5>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Meta Titel</label>
                        <input type="text"
                               id="new-meta-title-${serviceId}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Skriv en meta titel (50-60 tegn anbefales)..."
                               maxlength="100"
                               oninput="updateMetaCharCount(${serviceId}, 'title')">
                        <div class="flex justify-between mt-1">
                            <span class="text-xs text-gray-500">Anbefalet: 50-60 tegn</span>
                            <span id="meta-title-count-${serviceId}" class="text-xs text-gray-500">0/100</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Meta Beskrivelse</label>
                        <textarea id="new-meta-desc-${serviceId}"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                  rows="3"
                                  placeholder="Skriv en meta beskrivelse (150-160 tegn anbefales, vigtigt budskab i f√∏rste 120 tegn)..."
                                  maxlength="250"
                                  oninput="updateMetaCharCount(${serviceId}, 'desc')"></textarea>
                        <div class="flex justify-between mt-1">
                            <span class="text-xs text-gray-500">Anbefalet: 150-160 tegn (vigtigt budskab i f√∏rste 120)</span>
                            <span id="meta-desc-count-${serviceId}" class="text-xs text-gray-500">0/250</span>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-all duration-200"
                                onclick="hideAddMetaExampleForm(${serviceId})">
                            Annuller
                        </button>
                        <button class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                onclick="addMetaExample(${serviceId})">
                            Gem Eksempel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meta Examples List -->
            <div id="meta-examples-list-${serviceId}" class="space-y-4">
                <div class="text-center py-12 text-gray-500">
                    <span class="text-4xl">üìù</span>
                    <p class="mt-2">Indl√¶ser meta eksempler...</p>
                </div>
            </div>
        </div>
    `;
}

function generateKeywordRowHtml(keyword) {
    const matchTypeBadgeClass = getMatchTypeBadgeClass(keyword.match_type);
    const primaryIcon = keyword.is_primary ? '‚≠ê' : '‚òÜ';
    const primaryClass = keyword.is_primary ? 'text-yellow-500' : 'text-gray-400';
    
    return `
        <tr class="keyword-row hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keyword.id}">
            <td class="py-3 px-4">
                <span class="keyword-text font-medium text-gray-900">${keyword.keyword_text}</span>
            </td>
            <td class="py-3 px-4">
                <span class="match-type-badge inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${matchTypeBadgeClass}">
                    ${keyword.match_type_display}
                </span>
            </td>
            <td class="py-3 px-4 text-center">
                <button class="toggle-primary-btn ${primaryClass} text-lg hover:scale-110 transition-transform duration-200" 
                        data-keyword-id="${keyword.id}" data-is-primary="${keyword.is_primary}" title="Toggle prim√¶r keyword">
                    ${primaryIcon}
                </button>
            </td>
            <td class="py-3 px-4 text-right">
                <div class="flex items-center justify-end space-x-2">
                    <button class="edit-keyword-btn text-gray-500 hover:text-purple-600 p-1" 
                            data-keyword-id="${keyword.id}" title="Redig√©r keyword">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                    <button class="delete-keyword-btn text-gray-500 hover:text-red-600 p-1" 
                            data-keyword-id="${keyword.id}" title="Slet keyword">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function getMatchTypeBadgeClass(matchType) {
    switch(matchType) {
        case 'exact':
            return 'bg-purple-100 text-purple-800';
        case 'phrase':
            return 'bg-blue-100 text-blue-800';
        case 'broad':
        default:
            return 'bg-gray-100 text-gray-800';
    }
}

// Event handlers for keyword operations
$(document).on('click', '.add-service-keyword-btn', function() {
    const serviceId = $(this).data('service-id');
    addServiceKeyword(serviceId);
});



$(document).on('click', '.toggle-primary-btn', function() {
    const keywordId = $(this).data('keyword-id');
    const isPrimary = $(this).data('is-primary');
    togglePrimaryKeyword(keywordId, !isPrimary);
});

// Enter key support for adding keywords
$(document).on('keypress', '.new-service-keyword-text', function(e) {
    if (e.which === 13) { // Enter key
        const serviceId = $(this).data('service-id');
        addServiceKeyword(serviceId);
    }
});

function addServiceKeyword(serviceId) {
    const keywordText = $(`.new-service-keyword-text[data-service-id="${serviceId}"]`).val().trim();
    const matchType = $(`.new-service-keyword-match-type[data-service-id="${serviceId}"]`).val();
    
    if (!keywordText) {
        showToast('Indtast et keyword f√∏rst', 'error');
        return;
    }
    
    console.log('Adding keyword:', keywordText, 'for service:', serviceId);
    
    $.ajax({
        url: '/ajax/add-service-keyword/',
        type: 'POST',
        data: {
            service_id: serviceId,
            keyword_text: keywordText,
            match_type: matchType,
            is_primary: false
        },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Add keyword response:', response);
            if (response.success) {
                // Clear input
                $(`.new-service-keyword-text[data-service-id="${serviceId}"]`).val('');
                
                // Add keyword to table
                const keywordHtml = generateKeywordRowHtml(response.keyword);
                const tbody = $(`#keywords-table-body-${serviceId}`);
                
                if (tbody.length > 0) {
                    tbody.append(keywordHtml);
                } else {
                    // Reload keywords if table doesn't exist yet
                    loadServiceKeywords(serviceId, getCurrentIndustryId());
                }
                
                // Update keyword counter for this service
                updateServiceKeywordCounter(serviceId);
                
                showToast(response.message, 'success');
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Add keyword error:', error);
            showToast('Fejl ved tilf√∏jelse af keyword', 'error');
        }
    });
}

function enterEditMode(keywordId) {
    // Exit any existing edit mode first
    exitEditMode();
    
    currentKeywordEditId = keywordId;
    const row = $(`.keyword-row[data-keyword-id="${keywordId}"]`);
    const keywordText = row.find('.keyword-text').text();
    const matchTypeBadge = row.find('.match-type-badge');
    
    // Get current match type from class
    let currentMatchType = 'phrase';
    if (matchTypeBadge.hasClass('bg-purple-100')) currentMatchType = 'exact';
    else if (matchTypeBadge.hasClass('bg-blue-100')) currentMatchType = 'phrase';
    else currentMatchType = 'broad';
    
    // Replace text with input
    row.find('.keyword-text').html(`
        <input type="text" class="edit-keyword-input w-full px-2 py-1 border border-purple-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500" 
               value="${keywordText}" data-original="${keywordText}">
    `);
    
    // Replace match type badge with select
    const selectHtml = `
        <select class="edit-match-type-select px-2 py-1 border border-purple-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="broad" ${currentMatchType === 'broad' ? 'selected' : ''}>Broad Match</option>
            <option value="phrase" ${currentMatchType === 'phrase' ? 'selected' : ''}>Phrase Match</option>
            <option value="exact" ${currentMatchType === 'exact' ? 'selected' : ''}>Exact Match</option>
        </select>
    `;
    matchTypeBadge.replaceWith(selectHtml);
    
    // Add save/cancel buttons
    row.find('.edit-keyword-btn').replaceWith(`
        <button class="save-keyword-btn text-green-600 hover:text-green-800 p-1" title="Gem √¶ndringer">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
        </button>
    `);
    
    row.find('.delete-keyword-btn').replaceWith(`
        <button class="cancel-edit-btn text-gray-600 hover:text-gray-800 p-1" title="Annuller">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    `);
    
    // Add edit mode styling
    row.addClass('edit-mode');
    
    // Focus on input
    row.find('.edit-keyword-input').focus().select();
}

function exitEditMode(forceReload = false) {
    if (currentKeywordEditId) {
        const row = $(`.keyword-row[data-keyword-id="${currentKeywordEditId}"]`);
        row.removeClass('edit-mode');
        currentKeywordEditId = null;
        
        // Only reload if forced (e.g., on cancel) - otherwise use inline updates
        if (forceReload) {
            const serviceId = row.closest('.keywords-content').data('service-id');
            if (serviceId) {
                loadServiceKeywords(serviceId, getCurrentIndustryId());
            }
        }
    }
}

// Event handlers for edit mode
$(document).on('click', '.save-keyword-btn', function() {
    const keywordId = currentKeywordEditId;
    const row = $(`.keyword-row[data-keyword-id="${keywordId}"]`);
    const keywordText = row.find('.edit-keyword-input').val().trim();
    const matchType = row.find('.edit-match-type-select').val();
    const isPrimary = row.find('.toggle-primary-btn').data('is-primary');
    
    if (!keywordText) {
        showToast('Keyword tekst m√• ikke v√¶re tom', 'error');
        return;
    }
    
    updateServiceKeyword(keywordId, keywordText, matchType, isPrimary);
});

$(document).on('click', '.cancel-edit-btn', function() {
    exitEditMode(true);  // Force reload on cancel to restore original data
});

// Enter key to save, Escape to cancel
$(document).on('keydown', '.edit-keyword-input', function(e) {
    if (e.key === 'Enter') {
        $('.save-keyword-btn').click();
    } else if (e.key === 'Escape') {
        exitEditMode(true);  // Force reload on escape to cancel changes
    }
});

function updateServiceKeyword(keywordId, keywordText, matchType, isPrimary) {
    console.log('Updating keyword:', keywordId, keywordText, matchType);
    
    $.ajax({
        url: `/ajax/update-service-keyword/${keywordId}/`,
        type: 'POST',
        data: {
            keyword_text: keywordText,
            match_type: matchType,
            is_primary: isPrimary
        },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Update keyword response:', response);
            if (response.success) {
                showToast(response.message, 'success');
                
                // Update the row directly with new data (AJAX inline update)
                updateKeywordRowInline(keywordId, response.keyword);
                exitEditMode();
            } else {
                showToast(response.error || 'Fejl ved opdatering af keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Update keyword error:', error);
            showToast('Fejl ved opdatering af keyword', 'error');
        }
    });
}

function deleteServiceKeyword(keywordId) {
    const row = $(`.keyword-row[data-keyword-id="${keywordId}"]`);
    
    console.log('Deleting keyword:', keywordId);
    
    $.ajax({
        url: `/ajax/delete-service-keyword/${keywordId}/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Delete keyword response:', response);
            if (response.success) {
                const serviceId = row.closest('.keywords-content').data('service-id');
                row.fadeOut(300, function() {
                    $(this).remove();
                    // Update keyword counter after removal
                    updateServiceKeywordCounter(serviceId);
                });
                showToast(response.message, 'success');
            } else {
                showToast(response.error || 'Fejl ved sletning af keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Delete keyword error:', error);
            showToast('Fejl ved sletning af keyword', 'error');
        }
    });
}

function togglePrimaryKeyword(keywordId, isPrimary) {
    console.log('Toggling primary for keyword:', keywordId, isPrimary);
    
    const row = $(`.keyword-row[data-keyword-id="${keywordId}"]`);
    const keywordText = row.find('.keyword-text').text();
    const matchType = row.find('.edit-match-type-select').length > 0 ? 
                     row.find('.edit-match-type-select').val() : 
                     getCurrentMatchType(row.find('.match-type-badge'));
    
    updateServiceKeyword(keywordId, keywordText, matchType, isPrimary);
}

function getCurrentMatchType(matchTypeBadge) {
    if (matchTypeBadge.hasClass('bg-purple-100')) return 'exact';
    if (matchTypeBadge.hasClass('bg-blue-100')) return 'phrase';
    return 'broad';
}

function getCurrentIndustryId() {
    // Get the currently expanded industry ID
    const expandedIndustry = $('.industry-section').first();
    return expandedIndustry.data('industry-id');
}

function updateServiceKeywordCounter(serviceId) {
    // Count current keywords in the table for this service
    const keywordCount = $(`#keywords-table-body-${serviceId} .keyword-row`).length;
    
    // Update the counter in the service card
    const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
    const counterElement = serviceCard.find('p:contains("keywords")');
    
    if (counterElement.length > 0) {
        counterElement.text(`${keywordCount} keywords`);
        console.log(`Updated keyword counter for service ${serviceId}: ${keywordCount} keywords`);
    }
}

function updateKeywordRowInline(keywordId, keywordData) {
    // Update the keyword row directly without reloading the entire keywords section
    const row = $(`.keyword-row[data-keyword-id="${keywordId}"]`);
    if (row.length === 0) return;
    
    // Update keyword text
    row.find('.keyword-text').text(keywordData.keyword_text);
    
    // Update match type badge
    const matchTypeBadge = row.find('.match-type-badge');
    const newBadgeClass = getMatchTypeBadgeClass(keywordData.match_type);
    
    // Remove old badge classes and add new one
    matchTypeBadge.removeClass('bg-green-100 text-green-800 bg-blue-100 text-blue-800 bg-purple-100 text-purple-800');
    matchTypeBadge.addClass(newBadgeClass);
    matchTypeBadge.text(keywordData.match_type_display);
    
    // Update primary status
    const primaryBtn = row.find('.toggle-primary-btn');
    primaryBtn.data('is-primary', keywordData.is_primary);
    
    if (keywordData.is_primary) {
        primaryBtn.removeClass('text-gray-400').addClass('text-yellow-500');
        primaryBtn.text('‚≠ê');
    } else {
        primaryBtn.removeClass('text-yellow-500').addClass('text-gray-400');
        primaryBtn.text('‚òÜ');
    }
    
    // Add brief highlight effect to show the update
    row.addClass('bg-green-50 border-green-200');
    setTimeout(() => {
        row.removeClass('bg-green-50 border-green-200');
    }, 1500);
    
    console.log('Keyword row updated inline:', keywordData);
}

function addServiceKeyword(serviceId, keywordText, matchType) {
    console.log('Adding keyword to service:', serviceId, keywordText, matchType);
    
    $.ajax({
        url: '/ajax/add-service-keyword/',
        type: 'POST',
        data: {
            service_id: serviceId,
            keyword_text: keywordText,
            match_type: matchType,
            is_primary: false  // Default to not primary
        },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Add keyword response:', response);
            if (response.success) {
                showToast(response.message, 'success');
                
                // Add the new keyword row inline instead of reloading
                addKeywordRowInline(serviceId, response.keyword);
                
                // Clear the add keyword form
                $(`.new-service-keyword-text[data-service-id="${serviceId}"]`).val('');
                $(`.new-service-keyword-match-type[data-service-id="${serviceId}"]`).val('phrase');
                
                // Update keyword counter
                updateServiceKeywordCounter(serviceId);
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Add keyword error:', error);
            showToast('Fejl ved tilf√∏jelse af keyword', 'error');
        }
    });
}

function addKeywordRowInline(serviceId, keywordData) {
    // Generate new row HTML and add it to the table
    const newRowHtml = generateKeywordRowHtml(keywordData);
    const tableBody = $(`#keywords-table-body-${serviceId}`);
    
    if (tableBody.length > 0) {
        // Add to existing table
        tableBody.append(newRowHtml);
    } else {
        // No table exists yet, need to create one (first keyword)
        const keywordsContainer = $(`.keywords-content[data-service-id="${serviceId}"] .keywords-list`);
        const tableHtml = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                            <th class="text-center py-3 px-4 font-medium text-gray-700">Prim√¶r</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="keywords-table-body-${serviceId}">
                        ${newRowHtml}
                    </tbody>
                </table>
            </div>
        `;
        keywordsContainer.html(tableHtml);
    }
    
    // Add highlight effect to the new row
    const newRow = $(`.keyword-row[data-keyword-id="${keywordData.id}"]`);
    newRow.addClass('bg-blue-50 border-blue-200');
    setTimeout(() => {
        newRow.removeClass('bg-blue-50 border-blue-200');
    }, 2000);
    
    console.log('New keyword row added inline:', keywordData);
}

// Keywords event handlers
$(document).on('click', '.add-service-keyword-btn', function() {
    const serviceId = $(this).data('service-id');
    const keywordText = $(`.new-service-keyword-text[data-service-id="${serviceId}"]`).val().trim();
    const matchType = $(`.new-service-keyword-match-type[data-service-id="${serviceId}"]`).val();
    
    if (!keywordText) {
        showToast('Indtast venligst en keyword tekst', 'error');
        return;
    }
    
    addServiceKeyword(serviceId, keywordText, matchType);
});

$(document).on('click', '.delete-keyword-btn', function() {
    const keywordId = $(this).data('keyword-id');
    const row = $(this).closest('.keyword-row');
    const keywordText = row.find('.keyword-text').text();
    
    if (confirm(`Er du sikker p√•, at du vil slette keywordet "${keywordText}"?`)) {
        deleteServiceKeyword(keywordId);
    }
});

$(document).on('click', '.edit-keyword-btn', function() {
    const keywordId = $(this).data('keyword-id');
    
    // Exit any existing edit mode first
    if (currentKeywordEditId && currentKeywordEditId !== keywordId) {
        exitEditMode();
    }
    
    enterEditMode(keywordId);
});

$(document).on('click', '.toggle-primary-btn', function() {
    const keywordId = $(this).data('keyword-id');
    const isPrimary = $(this).data('is-primary');
    
    // Toggle the primary status
    togglePrimaryKeyword(keywordId, !isPrimary);
});

// Enter key on new keyword input to add keyword quickly
$(document).on('keypress', '.new-service-keyword-text', function(e) {
    if (e.which === 13) { // Enter key
        const serviceId = $(this).data('service-id');
        $(`.add-service-keyword-btn[data-service-id="${serviceId}"]`).click();
    }
});

// Tab switching functionality
function switchKeywordTab(serviceId, tabType) {
    console.log('Switching to tab:', tabType, 'for service:', serviceId);

    // Update tab buttons (only for this service's tab container)
    $(`.keywords-content[data-service-id="${serviceId}"] .keyword-tabs button`).removeClass('active');
    $(`.keywords-content[data-service-id="${serviceId}"] .keyword-tabs button[data-tab="${tabType}"]`).addClass('active');

    // Update tab content (only for this service)
    $(`#tab-content-ads-${serviceId}, #tab-content-seo-${serviceId}, #tab-content-meta-${serviceId}, #tab-content-negative-${serviceId}`).removeClass('active');
    $(`#tab-content-${tabType}-${serviceId}`).addClass('active');

    console.log(`Active tab set for service ${serviceId}:`, tabType);

    // Load content if needed
    if (tabType === 'seo') {
        loadSEOKeywords(serviceId);
    } else if (tabType === 'meta') {
        loadMetaExamples(serviceId);
    } else if (tabType === 'negative') {
        loadNegativeKeywordLists(serviceId);
    }
}

// SEO Keywords functionality
function loadSEOKeywords(serviceId) {
    console.log('Loading SEO keywords for service:', serviceId);
    
    $.ajax({
        url: `/ajax/get-service-seo-keywords/${serviceId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                generateSEOKeywordsTable(serviceId, response.keywords);
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af SEO keywords', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved indl√¶sning af SEO keywords', 'error');
        }
    });
}

function addSEOKeyword(serviceId) {
    const keywordText = $(`.new-seo-keyword-text[data-service-id="${serviceId}"]`).val().trim();
    const keywordType = $(`.new-seo-keyword-type[data-service-id="${serviceId}"]`).val();
    const searchVolume = $(`.new-seo-keyword-volume[data-service-id="${serviceId}"]`).val();
    
    if (!keywordText) {
        showToast('Indtast venligst et SEO keyword', 'error');
        return;
    }
    
    $.ajax({
        url: `/ajax/add-service-seo-keyword/${serviceId}/`,
        method: 'POST',
        data: {
            keyword_text: keywordText,
            keyword_type: keywordType,
            search_volume: searchVolume || '',
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // Clear form
                $(`.new-seo-keyword-text[data-service-id="${serviceId}"]`).val('');
                $(`.new-seo-keyword-volume[data-service-id="${serviceId}"]`).val('');
                $(`.new-seo-keyword-type[data-service-id="${serviceId}"]`).val('money');
                
                // Reload SEO keywords
                loadSEOKeywords(serviceId);
                showToast('SEO keyword tilf√∏jet succesfuldt', 'success');
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af SEO keyword', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved tilf√∏jelse af SEO keyword', 'error');
        }
    });
}

function addGoogleAdsKeyword(serviceId) {
    const keywordText = $(`.new-ads-keyword-text[data-service-id="${serviceId}"]`).val().trim();
    const matchType = $(`.new-ads-keyword-match-type[data-service-id="${serviceId}"]`).val();
    
    if (!keywordText) {
        showToast('Indtast venligst et Google Ads keyword', 'error');
        return;
    }
    
    $.ajax({
        url: '/ajax/add-service-keyword/',
        method: 'POST',
        data: {
            service_id: serviceId,
            keyword_text: keywordText,
            match_type: matchType,
            is_primary: false,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // Clear form
                $(`.new-ads-keyword-text[data-service-id="${serviceId}"]`).val('');
                $(`.new-ads-keyword-match-type[data-service-id="${serviceId}"]`).val('phrase');
                
                // Reload Google Ads keywords
                loadGoogleAdsKeywords(serviceId);
                showToast('Google Ads keyword tilf√∏jet succesfuldt', 'success');
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af Google Ads keyword', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved tilf√∏jelse af Google Ads keyword', 'error');
        }
    });
}

// =================================================================
// META TAG EXAMPLES FUNCTIONALITY (Few-Shot AI Learning)
// =================================================================

// Google SERP font settings for pixel-based measurement
// Title: Arial 20px (matching Storybase CTR tool), Description: Arial 14px
const SERP_FONTS = {
    title: { font: 'Arial', size: 20, maxPixels: 600 },
    description: { font: 'Arial', size: 14, maxPixels: 920 }
};

// Measure text width in pixels using canvas (Google measures SERP in pixels, not chars)
function measurePixelWidth(text, fontSize = 18, fontFamily = 'Arial') {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = `${fontSize}px ${fontFamily}`;
    return Math.round(ctx.measureText(text).width);
}

// Get pixel info for meta title
function getTitlePixelInfo(text) {
    const pixels = measurePixelWidth(text, SERP_FONTS.title.size, SERP_FONTS.title.font);
    const max = SERP_FONTS.title.maxPixels;
    return { pixels, max, isOver: pixels > max };
}

// Get pixel info for meta description
function getDescriptionPixelInfo(text) {
    const pixels = measurePixelWidth(text, SERP_FONTS.description.size, SERP_FONTS.description.font);
    const max = SERP_FONTS.description.maxPixels;
    return { pixels, max, isOver: pixels > max };
}

function loadMetaExamples(serviceId) {
    console.log('Loading meta examples for service:', serviceId);

    $.ajax({
        url: `/ajax/get-service-meta-examples/${serviceId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderMetaExamples(serviceId, response.examples);
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af meta eksempler', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved indl√¶sning af meta eksempler', 'error');
        }
    });
}

function renderMetaExamples(serviceId, examples) {
    const container = $(`#meta-examples-list-${serviceId}`);

    if (!examples || examples.length === 0) {
        container.html(`
            <div class="text-center py-12 text-gray-500">
                <span class="text-4xl">üìù</span>
                <p class="mt-2">Ingen meta eksempler endnu</p>
                <p class="text-sm">Tilf√∏j eksempler for at give AI bedre reference ved generering</p>
            </div>
        `);
        return;
    }

    let html = '';
    examples.forEach((example, index) => {
        const titleText = example.meta_title || '';
        const descText = example.meta_description || '';
        const titleLength = titleText.length;
        const descLength = descText.length;

        // Get pixel measurements
        const titlePixels = getTitlePixelInfo(titleText);
        const descPixels = getDescriptionPixelInfo(descText);

        // Color coding based on pixel overflow
        const titleClass = titlePixels.isOver ? 'text-red-600' :
                          (titleLength >= 50 && titleLength <= 60) ? 'text-green-600' : 'text-yellow-600';
        const descClass = descPixels.isOver ? 'text-red-600' :
                         (descLength >= 150 && descLength <= 160) ? 'text-green-600' : 'text-yellow-600';

        html += `
            <div class="meta-example-item bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-all duration-200" data-example-id="${example.id}">
                <div class="flex items-start justify-between mb-3">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-medium text-sm">
                        ${index + 1}
                    </span>
                    <div class="flex items-center space-x-2">
                        <button class="edit-meta-example-btn text-gray-500 hover:text-indigo-600 p-1 transition-colors"
                                data-example-id="${example.id}"
                                onclick="editMetaExample(${example.id}, ${serviceId})"
                                title="Redig√©r eksempel">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="delete-meta-example-btn text-gray-500 hover:text-red-600 p-1 transition-colors"
                                data-example-id="${example.id}"
                                onclick="deleteMetaExample(${example.id}, ${serviceId})"
                                title="Slet eksempel">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Meta Titel</span>
                            <span class="text-xs ${titleClass}">${titleLength} tegn | ${titlePixels.pixels}/${titlePixels.max}px</span>
                        </div>
                        <p class="text-gray-900 font-medium">${titleText || '-'}</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Meta Beskrivelse</span>
                            <span class="text-xs ${descClass}">${descLength} tegn | ${descPixels.pixels}/${descPixels.max}px</span>
                        </div>
                        <p class="text-gray-600 text-sm">${descText || '-'}</p>
                    </div>
                </div>
            </div>
        `;
    });

    container.html(html);
}

function showAddMetaExampleForm(serviceId) {
    $(`#add-meta-example-form-${serviceId}`).removeClass('hidden');
    $(`#new-meta-title-${serviceId}`).focus();
}

function hideAddMetaExampleForm(serviceId) {
    $(`#add-meta-example-form-${serviceId}`).addClass('hidden');
    $(`#new-meta-title-${serviceId}`).val('');
    $(`#new-meta-desc-${serviceId}`).val('');
    updateMetaCharCount(serviceId, 'title');
    updateMetaCharCount(serviceId, 'desc');
}

function updateMetaCharCount(serviceId, type) {
    if (type === 'title') {
        const text = $(`#new-meta-title-${serviceId}`).val();
        const charCount = text.length;
        const pixelInfo = getTitlePixelInfo(text);
        const countEl = $(`#meta-title-count-${serviceId}`);

        // Show both chars and pixels: "42 tegn | 380/600px"
        countEl.html(`${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px`);

        // Color coding based on pixel overflow
        if (pixelInfo.isOver) {
            countEl.removeClass('text-green-600 text-yellow-600').addClass('text-red-600');
        } else if (charCount >= 50 && charCount <= 60) {
            countEl.removeClass('text-red-600 text-yellow-600').addClass('text-green-600');
        } else {
            countEl.removeClass('text-green-600 text-red-600').addClass('text-yellow-600');
        }
    } else {
        const text = $(`#new-meta-desc-${serviceId}`).val();
        const charCount = text.length;
        const pixelInfo = getDescriptionPixelInfo(text);
        const countEl = $(`#meta-desc-count-${serviceId}`);

        // Show both chars and pixels: "135 tegn | 780/920px"
        countEl.html(`${charCount} tegn | ${pixelInfo.pixels}/${pixelInfo.max}px`);

        // Color coding based on pixel overflow
        if (pixelInfo.isOver) {
            countEl.removeClass('text-green-600 text-yellow-600').addClass('text-red-600');
        } else if (charCount >= 150 && charCount <= 160) {
            countEl.removeClass('text-red-600 text-yellow-600').addClass('text-green-600');
        } else {
            countEl.removeClass('text-green-600 text-red-600').addClass('text-yellow-600');
        }
    }
}

function addMetaExample(serviceId) {
    const metaTitle = $(`#new-meta-title-${serviceId}`).val().trim();
    const metaDesc = $(`#new-meta-desc-${serviceId}`).val().trim();

    if (!metaTitle || !metaDesc) {
        showToast('Udfyld b√•de meta titel og beskrivelse', 'error');
        return;
    }

    $.ajax({
        url: `/ajax/add-service-meta-example/${serviceId}/`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            meta_title: metaTitle,
            meta_description: metaDesc
        }),
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                hideAddMetaExampleForm(serviceId);
                loadMetaExamples(serviceId);
                showToast('Meta eksempel tilf√∏jet', 'success');
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af meta eksempel', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved tilf√∏jelse af meta eksempel', 'error');
        }
    });
}

function deleteMetaExample(exampleId, serviceId) {
    if (!confirm('Er du sikker p√•, at du vil slette dette meta eksempel?')) {
        return;
    }

    $.ajax({
        url: `/ajax/delete-service-meta-example/${exampleId}/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                loadMetaExamples(serviceId);
                showToast('Meta eksempel slettet', 'success');
            } else {
                showToast(response.error || 'Fejl ved sletning af meta eksempel', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved sletning af meta eksempel', 'error');
        }
    });
}

function editMetaExample(exampleId, serviceId) {
    // Find the current example data from the DOM
    const container = $(`.meta-example-item[data-example-id="${exampleId}"]`);
    const currentTitle = container.find('p.text-gray-900').text();
    const currentDesc = container.find('p.text-gray-600').text();

    // Replace the item with an edit form
    container.html(`
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Meta Titel</label>
                <input type="text"
                       id="edit-meta-title-${exampleId}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       value="${currentTitle}"
                       maxlength="100">
                <div class="text-xs text-gray-500 mt-1">Anbefalet: 50-60 tegn</div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Meta Beskrivelse</label>
                <textarea id="edit-meta-desc-${exampleId}"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          rows="3"
                          maxlength="250">${currentDesc}</textarea>
                <div class="text-xs text-gray-500 mt-1">Anbefalet: 150-160 tegn</div>
            </div>
            <div class="flex justify-end space-x-3">
                <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-all duration-200"
                        onclick="loadMetaExamples(${serviceId})">
                    Annuller
                </button>
                <button class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                        onclick="saveMetaExample(${exampleId}, ${serviceId})">
                    Gem √Ündringer
                </button>
            </div>
        </div>
    `);

    // Focus on title input
    $(`#edit-meta-title-${exampleId}`).focus();
}

function saveMetaExample(exampleId, serviceId) {
    const metaTitle = $(`#edit-meta-title-${exampleId}`).val().trim();
    const metaDesc = $(`#edit-meta-desc-${exampleId}`).val().trim();

    if (!metaTitle || !metaDesc) {
        showToast('Udfyld b√•de meta titel og beskrivelse', 'error');
        return;
    }

    $.ajax({
        url: `/ajax/update-service-meta-example/${exampleId}/`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            meta_title: metaTitle,
            meta_description: metaDesc
        }),
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                loadMetaExamples(serviceId);
                showToast('Meta eksempel opdateret', 'success');
            } else {
                showToast(response.error || 'Fejl ved opdatering af meta eksempel', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved opdatering af meta eksempel', 'error');
        }
    });
}

// Make meta example functions globally available
window.loadMetaExamples = loadMetaExamples;
window.showAddMetaExampleForm = showAddMetaExampleForm;
window.hideAddMetaExampleForm = hideAddMetaExampleForm;
window.updateMetaCharCount = updateMetaCharCount;
window.addMetaExample = addMetaExample;
window.deleteMetaExample = deleteMetaExample;
window.editMetaExample = editMetaExample;
window.saveMetaExample = saveMetaExample;

// Negative Keywords functionality
function loadNegativeKeywordLists(serviceId) {
    console.log('Loading negative keyword lists for service:', serviceId);
    
    // Load connected lists and available lists in parallel
    Promise.all([
        $.ajax({
            url: `/ajax/get-service-negative-lists/${serviceId}/`,
            method: 'GET'
        }),
        $.ajax({
            url: `/ajax/search-negative-keyword-lists/`,
            method: 'GET',
            data: {
                industry_id: window.currentServiceIndustryId || ''
            }
        })
    ]).then(([connectedResponse, availableResponse]) => {
        if (connectedResponse.success && availableResponse.success) {
            generateNegativeKeywordsTable(serviceId, connectedResponse.lists, availableResponse.lists);
        } else {
            showToast('Fejl ved indl√¶sning af negative keywords', 'error');
        }
    }).catch(function() {
        showToast('Fejl ved indl√¶sning af negative keywords', 'error');
    });
}

function searchNegativeKeywordLists(serviceId, query) {
    // Debounce search
    clearTimeout(window.negativeSearchTimeout);
    window.negativeSearchTimeout = setTimeout(() => {
        if (query.length > 2) {
            $.ajax({
                url: `/ajax/search-negative-keyword-lists/`,
                type: 'GET',
                data: { q: query },
                success: function(response) {
                    if (response.success) {
                        // Update search results display
                        console.log('Search results:', response.lists);
                    }
                }
            });
        }
    }, 300);
}

// SEO Keywords table generation
function generateSEOKeywordsTable(serviceId, keywords) {
    let html = '';
    
    if (keywords.length === 0) {
        html = `
            <div class="text-center py-12 text-green-600">
                <span class="text-4xl">üåê</span>
                <p class="mt-2 text-gray-600">Ingen SEO keywords endnu</p>
                <p class="text-sm text-gray-500">Tilf√∏j dit f√∏rste SEO keyword ovenfor</p>
            </div>
        `;
    } else {
        html = `
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="bg-green-50 px-6 py-3 border-b border-green-200">
                    <h5 class="font-semibold text-green-800 flex items-center">
                        <span class="text-lg mr-2">üìä</span>
                        SEO Keywords (${keywords.length})
                    </h5>
                </div>
                
                <div class="divide-y divide-gray-200">
        `;
        
        html += `
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="text-left py-3 px-4 font-medium text-gray-900">Keyword</th>
                        <th class="text-left py-3 px-4 font-medium text-gray-900">Type</th>
                        <th class="text-left py-3 px-4 font-medium text-gray-900">S√∏gevolumen</th>
                        <th class="text-center py-3 px-4 font-medium text-gray-900">Prim√¶r</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-900">Handlinger</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
        `;
        
        keywords.forEach(keyword => {
            const keywordTypeColors = {
                'money': 'bg-green-100 text-green-800',
                'price': 'bg-blue-100 text-blue-800', 
                'info': 'bg-purple-100 text-purple-800',
                'lsi': 'bg-orange-100 text-orange-800'
            };
            
            const typeColor = keywordTypeColors[keyword.keyword_type] || 'bg-gray-100 text-gray-800';
            const primaryIcon = keyword.is_primary ? '‚≠ê' : '‚òÜ';
            const primaryClass = keyword.is_primary ? 'text-yellow-500' : 'text-gray-400';
            
            html += `
                <tr class="hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keyword.id}">
                    <td class="py-3 px-4">
                        <span class="font-medium text-gray-900">${keyword.keyword_text}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeColor}">
                            ${keyword.keyword_type_display}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-gray-600">
                        ${keyword.search_volume ? keyword.search_volume.toLocaleString() : '-'}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="${primaryClass} text-lg">
                            ${primaryIcon}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-right">
                        <div class="flex items-center justify-end space-x-2">
                            <button onclick="editSEOKeyword(${keyword.id}, ${serviceId})" 
                                    class="text-gray-500 hover:text-green-600 p-1" title="Redig√©r keyword">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button onclick="deleteSEOKeyword(${keyword.id}, ${serviceId})" 
                                    class="text-gray-500 hover:text-red-600 p-1" title="Slet keyword">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 3V4H4V6H5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V6H20V4H15V3H9ZM7 6H17V19H7V6ZM9 8V17H11V8H9ZM13 8V17H15V8H13Z"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        html += `
                </div>
            </div>
        `;
    }
    
    $(`#seo-keywords-table-${serviceId}`).html(html);
}

function generateNegativeKeywordsTable(serviceId, connectedLists, availableLists) {
    // Update only the connected-lists and available-lists containers, not the whole content
    // This preserves the keyword input form and table structure

    let connectedHtml = '';

    if (connectedLists && connectedLists.length > 0) {
        connectedLists.forEach(list => {
            connectedHtml += `
                <button onclick="selectNegativeList(${list.list_id}, ${serviceId})"
                        data-list-id="${list.list_id}"
                        class="connected-list-btn inline-flex items-center bg-red-100 text-red-800 px-3 py-2 rounded-lg text-sm font-medium border border-red-200 hover:bg-red-200 transition-colors duration-200 cursor-pointer">
                    <span class="mr-2">üö´</span>
                    <span class="mr-2">${list.name}</span>
                    <span class="text-xs text-red-600 mr-2">(${list.keywords_count || 0})</span>
                    <span onclick="event.stopPropagation(); disconnectNegativeList(${list.connection_id}, ${serviceId})"
                          class="ml-1 text-red-600 hover:text-red-800 font-bold text-lg leading-none"
                          title="Fjern negative s√∏geordsliste">
                        √ó
                    </span>
                </button>
            `;
        });
        // Hide the no-lists message
        $(`#no-lists-message-${serviceId}`).addClass('hidden');
    } else {
        connectedHtml = '';
        // Show the no-lists message
        $(`#no-lists-message-${serviceId}`).removeClass('hidden');
    }

    $(`#connected-lists-${serviceId}`).html(connectedHtml);

    // Update available lists
    let availableHtml = '';

    if (availableLists && availableLists.length > 0) {
        // Filter out already connected lists
        const connectedIds = connectedLists ? connectedLists.map(list => list.list_id) : [];
        const unconnectedLists = availableLists.filter(list => !connectedIds.includes(list.id));

        if (unconnectedLists.length > 0) {
            unconnectedLists.forEach(list => {
                availableHtml += `
                    <button onclick="connectNegativeList(${list.id}, ${serviceId})"
                            class="inline-flex items-center bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:bg-gray-200 hover:border-red-300 hover:text-red-700 transition-all duration-200">
                        <span class="mr-2">üìã</span>
                        <span class="mr-2">${list.name}</span>
                        <span class="text-xs text-gray-600">(${list.keywords_count || 0})</span>
                    </button>
                `;
            });
            $(`#available-lists-container-${serviceId}`).removeClass('hidden');
        } else {
            $(`#available-lists-container-${serviceId}`).addClass('hidden');
        }
    } else {
        $(`#available-lists-container-${serviceId}`).addClass('hidden');
    }

    $(`#available-lists-${serviceId}`).html(availableHtml);

    // Auto-select first connected list if available
    if (connectedLists && connectedLists.length > 0) {
        selectNegativeList(connectedLists[0].list_id, serviceId);
    }
}

function connectNegativeList(listId, serviceId) {
    $.ajax({
        url: `/ajax/connect-negative-list/${serviceId}/`,
        method: 'POST',
        data: {
            list_id: listId,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                showToast(response.message, 'success');
                // Reload the negative keywords tab to show updated lists
                loadNegativeKeywordLists(serviceId);
            } else {
                showToast(response.error || 'Fejl ved tilkobling af liste', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved tilkobling af negative keyword liste', 'error');
        }
    });
}

function disconnectNegativeList(connectionId, serviceId) {
    $.ajax({
        url: `/ajax/disconnect-negative-list/${connectionId}/`,
        method: 'POST',
        data: {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                showToast(response.message, 'success');
                // Reload the negative keywords tab to show updated lists
                loadNegativeKeywordLists(serviceId);
            } else {
                showToast(response.error || 'Fejl ved frakobling af liste', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved frakobling af negative keyword liste', 'error');
        }
    });
}

function editSEOKeyword(keywordId, serviceId) {
    console.log('Editing SEO keyword:', keywordId);
    
    // Exit any existing edit mode first
    exitSEOEditMode();
    
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    const keywordText = row.find('td:first-child span').text();
    const keywordTypeBadge = row.find('td:nth-child(2) span');
    const searchVolume = row.find('td:nth-child(3)').text().replace(/[^0-9]/g, ''); // Extract only numbers
    const primaryIcon = row.find('td:nth-child(4) span');
    
    // Get current keyword type from the badge classes
    let currentKeywordType = 'money';
    if (keywordTypeBadge.hasClass('bg-green-100')) currentKeywordType = 'money';
    else if (keywordTypeBadge.hasClass('bg-blue-100')) currentKeywordType = 'price';
    else if (keywordTypeBadge.hasClass('bg-purple-100')) currentKeywordType = 'info';
    else if (keywordTypeBadge.hasClass('bg-orange-100')) currentKeywordType = 'lsi';
    
    // Get current primary status
    const isPrimary = primaryIcon.text() === '‚≠ê';
    
    // Replace keyword text with input
    row.find('td:first-child').html(`
        <input type="text" class="edit-seo-keyword-input w-full px-2 py-1 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" 
               value="${keywordText}" data-original="${keywordText}">
    `);
    
    // Replace keyword type badge with select
    const typeSelectHtml = `
        <select class="edit-seo-keyword-type-select px-2 py-1 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500 text-xs">
            <option value="money" ${currentKeywordType === 'money' ? 'selected' : ''}>Money Keyword</option>
            <option value="price" ${currentKeywordType === 'price' ? 'selected' : ''}>Pris Keyword</option>
            <option value="info" ${currentKeywordType === 'info' ? 'selected' : ''}>Informations Keyword</option>
            <option value="lsi" ${currentKeywordType === 'lsi' ? 'selected' : ''}>LSI Keyword</option>
        </select>
    `;
    row.find('td:nth-child(2)').html(typeSelectHtml);
    
    // Replace search volume with input
    row.find('td:nth-child(3)').html(`
        <input type="number" class="edit-seo-search-volume-input w-full px-2 py-1 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" 
               value="${searchVolume}" placeholder="0">
    `);
    
    // Replace primary status with toggle checkbox
    row.find('td:nth-child(4)').html(`
        <div class="text-center">
            <input type="checkbox" class="edit-seo-primary-checkbox form-checkbox h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" 
                   ${isPrimary ? 'checked' : ''}>
        </div>
    `);
    
    // Replace action buttons with save/cancel
    row.find('td:last-child').html(`
        <div class="flex items-center justify-end space-x-2">
            <button class="save-seo-keyword-btn text-green-600 hover:text-green-800 p-1" data-keyword-id="${keywordId}" data-service-id="${serviceId}" title="Gem √¶ndringer">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
            </button>
            <button class="cancel-seo-edit-btn text-gray-600 hover:text-gray-800 p-1" data-keyword-id="${keywordId}" data-service-id="${serviceId}" title="Annuller">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    `);
    
    // Add edit mode styling
    row.addClass('edit-mode bg-green-50');
    
    // Store current edit keyword ID
    window.currentSEOEditId = keywordId;
    
    // Focus on input
    row.find('.edit-seo-keyword-input').focus().select();
}

function exitSEOEditMode(forceReload = false) {
    if (window.currentSEOEditId) {
        const row = $(`tr[data-keyword-id="${window.currentSEOEditId}"]`);
        row.removeClass('edit-mode bg-green-50');
        window.currentSEOEditId = null;
        
        // Only reload if forced (e.g., on cancel)
        if (forceReload) {
            const serviceId = row.closest('[data-service-id]').data('service-id');
            if (serviceId) {
                loadSEOKeywords(serviceId);
            }
        }
    }
}

function updateSEOKeyword(keywordId, keywordText, keywordType, searchVolume, isPrimary, serviceId) {
    console.log('Updating SEO keyword:', keywordId, keywordText, keywordType, searchVolume, isPrimary);
    
    $.ajax({
        url: `/ajax/update-service-seo-keyword/${keywordId}/`,
        type: 'POST',
        data: {
            keyword_text: keywordText,
            keyword_type: keywordType,
            search_volume: searchVolume || '',
            is_primary: isPrimary
        },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Update SEO keyword response:', response);
            if (response.success) {
                showToast(response.message, 'success');
                
                // Update the row directly with new data
                updateSEOKeywordRowInline(keywordId, response.keyword);
                exitSEOEditMode();
            } else {
                showToast(response.error || 'Fejl ved opdatering af SEO keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Update SEO keyword error:', error);
            showToast('Fejl ved opdatering af SEO keyword', 'error');
        }
    });
}

function updateSEOKeywordRowInline(keywordId, keywordData) {
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    if (row.length === 0) return;
    
    // Update keyword text
    row.find('td:first-child').html(`<span class="font-medium text-gray-900">${keywordData.keyword_text}</span>`);
    
    // Update keyword type badge
    const keywordTypeColors = {
        'money': 'bg-green-100 text-green-800',
        'price': 'bg-blue-100 text-blue-800', 
        'info': 'bg-purple-100 text-purple-800',
        'lsi': 'bg-orange-100 text-orange-800'
    };
    
    const typeColor = keywordTypeColors[keywordData.keyword_type] || 'bg-gray-100 text-gray-800';
    
    row.find('td:nth-child(2)').html(`
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeColor}">
            ${keywordData.keyword_type_display}
        </span>
    `);
    
    // Update search volume
    const searchVolumeDisplay = keywordData.search_volume ? keywordData.search_volume.toLocaleString() : '-';
    row.find('td:nth-child(3)').html(`<span class="text-gray-600">${searchVolumeDisplay}</span>`);
    
    // Update primary status
    const primaryIcon = keywordData.is_primary ? '‚≠ê' : '‚òÜ';
    const primaryClass = keywordData.is_primary ? 'text-yellow-500' : 'text-gray-400';
    
    row.find('td:nth-child(4)').html(`
        <span class="${primaryClass} text-lg">
            ${primaryIcon}
        </span>
    `);
    
    // Restore action buttons
    row.find('td:last-child').html(`
        <div class="flex items-center justify-end space-x-2">
            <button onclick="editSEOKeyword(${keywordData.id}, ${keywordData.service_id || 'serviceId'})" 
                    class="text-gray-500 hover:text-green-600 p-1" title="Redig√©r keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </button>
            <button onclick="deleteSEOKeyword(${keywordData.id}, ${keywordData.service_id || 'serviceId'})" 
                    class="text-gray-500 hover:text-red-600 p-1" title="Slet keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 3V4H4V6H5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V6H20V4H15V3H9ZM7 6H17V19H7V6ZM9 8V17H11V8H9ZM13 8V17H15V8H13Z"/>
                </svg>
            </button>
        </div>
    `);
    
    // Add brief highlight effect to show the update
    row.addClass('bg-green-100 border-green-300');
    setTimeout(() => {
        row.removeClass('bg-green-100 border-green-300');
    }, 1500);
    
    console.log('SEO keyword row updated inline:', keywordData);
}

function deleteSEOKeyword(keywordId, serviceId) {
    if (confirm('Er du sikker p√• at du vil slette dette SEO keyword?')) {
        $.ajax({
            url: `/ajax/delete-service-seo-keyword/${keywordId}/`,
            method: 'POST',
            data: {
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    // Reload SEO keywords to show updated list
                    loadSEOKeywords(serviceId);
                } else {
                    showToast(response.error || 'Fejl ved sletning af SEO keyword', 'error');
                }
            },
            error: function() {
                showToast('Fejl ved sletning af SEO keyword', 'error');
            }
        });
    }
}

// Industry expansion functionality
function toggleIndustryExpansion(industryId) {
    console.log('Toggling expansion for industry:', industryId);
    
    const industrySection = $(`.industry-section[data-industry-id="${industryId}"]`);
    const servicesContent = $(`.services-content[data-industry-id="${industryId}"]`);
    const expansionIcon = industrySection.find('.expansion-icon svg');
    
    if (servicesContent.is(':visible')) {
        // Collapse
        servicesContent.slideUp(300);
        expansionIcon.removeClass('rotate-180');
    } else {
        // Expand
        servicesContent.slideDown(300);
        expansionIcon.addClass('rotate-180');
    }
}

// Service expansion functionality
function toggleServiceExpansion(serviceId, industryId) {
    console.log('Toggling expansion for service:', serviceId);
    
    const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
    const keywordsContent = $(`.keywords-content[data-service-id="${serviceId}"]`);
    
    // Close any other open service
    $(`.service-card`).not(serviceCard).removeClass('expanded');
    $(`.keywords-content`).not(keywordsContent).hide();
    
    if (serviceCard.hasClass('expanded')) {
        // Collapse
        serviceCard.removeClass('expanded');
        keywordsContent.slideUp(300);
    } else {
        // Expand
        serviceCard.addClass('expanded');
        
        // Store current service industry ID for later use
        window.currentServiceIndustryId = industryId;
        
        // Load keywords for this service
        loadServiceKeywords(serviceId);
        
        // Show keywords content (it may already exist but be hidden)
        setTimeout(() => {
            const existingKeywordsContent = $(`.keywords-content[data-service-id="${serviceId}"]`);
            if (existingKeywordsContent.length > 0) {
                existingKeywordsContent.slideDown(300);
                console.log(`Keywords content shown for service ${serviceId}`);
            }
        }, 100);
    }
}

// Load service keywords functionality
function loadServiceKeywords(serviceId) {
    console.log('Loading keywords for service:', serviceId);
    
    // Check if keywords content already exists
    let keywordsContent = $(`.keywords-content[data-service-id="${serviceId}"]`);
    
    if (keywordsContent.length === 0) {
        // Create keywords content if it doesn't exist
        const serviceCard = $(`.service-card[data-service-id="${serviceId}"]`);
        const keywordsHtml = `
            <div class="keywords-content keywords-section p-6" data-service-id="${serviceId}">
                <!-- Keyword Tabs -->
                <div class="keyword-tabs">
                    <button class="keyword-tab ads active" data-tab="ads" onclick="switchKeywordTab(${serviceId}, 'ads')">
                        üì± Google Ads Keywords
                    </button>
                    <button class="keyword-tab seo" data-tab="seo" onclick="switchKeywordTab(${serviceId}, 'seo')">
                        üåê SEO Keywords
                    </button>
                    <button class="keyword-tab meta" data-tab="meta" onclick="switchKeywordTab(${serviceId}, 'meta')">
                        üìù Meta Eksempler
                    </button>
                    <button class="keyword-tab negative" data-tab="negative" onclick="switchKeywordTab(${serviceId}, 'negative')">
                        üö´ Negative Keywords
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content active" id="tab-content-ads-${serviceId}">
                    <div class="p-6">
                        <!-- Google Ads Keywords Add Form -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h4 class="text-lg font-medium text-blue-800 mb-4 flex items-center">
                                <span class="text-xl mr-2">üì±</span>
                                Tilf√∏j Google Ads Keywords
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <input type="text" placeholder="Google Ads keyword..." 
                                       class="new-ads-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       data-service-id="${serviceId}">
                                <select class="new-ads-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        data-service-id="${serviceId}">
                                    <option value="phrase" selected>Phrase Match</option>
                                    <option value="exact">Exact Match</option>
                                    <option value="broad">Broad Match</option>
                                </select>
                                <button class="add-ads-keyword-btn bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                        data-service-id="${serviceId}"
                                        onclick="addGoogleAdsKeyword(${serviceId})">
                                    üì± Tilf√∏j Google Ads Keyword
                                </button>
                            </div>
                        </div>
                        
                        <!-- Google Ads Keywords Display -->
                        <div id="ads-keywords-content-${serviceId}">
                            <p class="text-gray-500 text-center">Google Ads keywords indl√¶ses...</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-content-seo-${serviceId}">
                    <div class="p-6">
                        <!-- SEO Keywords Add Form -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <h4 class="text-lg font-medium text-green-800 mb-4 flex items-center">
                                <span class="text-xl mr-2">üåê</span>
                                Tilf√∏j SEO Keywords
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <input type="text" placeholder="SEO keyword..." 
                                       class="new-seo-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       data-service-id="${serviceId}">
                                <select class="new-seo-keyword-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        data-service-id="${serviceId}">
                                    <option value="money" selected>Money Keyword</option>
                                    <option value="price">Pris Keyword</option>
                                    <option value="info">Informations Keyword</option>
                                    <option value="lsi">LSI Keyword</option>
                                </select>
                                <input type="number" placeholder="S√∏gevolumen" 
                                       class="new-seo-keyword-volume px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       data-service-id="${serviceId}">
                                <button class="add-seo-keyword-btn bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                        data-service-id="${serviceId}"
                                        onclick="addSEOKeyword(${serviceId})">
                                    üåê Tilf√∏j SEO Keyword
                                </button>
                            </div>
                        </div>
                        
                        <!-- SEO Keywords Display -->
                        <div id="seo-keywords-table-${serviceId}">
                            <p class="text-gray-500 text-center">SEO keywords indl√¶ses...</p>
                        </div>
                    </div>
                </div>

                <!-- Meta Examples Tab Content -->
                <div class="tab-content" id="tab-content-meta-${serviceId}">
                    <div class="p-6">
                        <!-- Meta Examples Header -->
                        <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-lg font-medium text-indigo-900">üìù Meta Tag Eksempler</h4>
                                    <p class="text-sm text-indigo-700 mt-1">AI v√¶lger tilf√¶ldigt max 10 af disse som reference ved generering</p>
                                </div>
                                <button class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 text-sm"
                                        onclick="showAddMetaExampleForm(${serviceId})">
                                    ‚ûï Tilf√∏j Eksempel
                                </button>
                            </div>
                        </div>

                        <!-- Add New Meta Example Form (hidden by default) -->
                        <div id="add-meta-example-form-${serviceId}" class="hidden mb-6 bg-white p-4 rounded-lg border border-gray-200">
                            <h5 class="font-medium text-gray-900 mb-4">Nyt Meta Tag Eksempel</h5>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Meta Titel</label>
                                    <input type="text"
                                           id="new-meta-title-${serviceId}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                           placeholder="Skriv en meta titel (50-60 tegn anbefales)..."
                                           maxlength="100"
                                           oninput="updateMetaCharCount(${serviceId}, 'title')">
                                    <div class="flex justify-between mt-1">
                                        <span class="text-xs text-gray-500">Anbefalet: 50-60 tegn</span>
                                        <span id="meta-title-count-${serviceId}" class="text-xs text-gray-500">0/100</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Meta Beskrivelse</label>
                                    <textarea id="new-meta-desc-${serviceId}"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                              rows="3"
                                              placeholder="Skriv en meta beskrivelse (150-160 tegn anbefales, vigtigt budskab i f√∏rste 120 tegn)..."
                                              maxlength="250"
                                              oninput="updateMetaCharCount(${serviceId}, 'desc')"></textarea>
                                    <div class="flex justify-between mt-1">
                                        <span class="text-xs text-gray-500">Anbefalet: 150-160 tegn (vigtigt budskab i f√∏rste 120)</span>
                                        <span id="meta-desc-count-${serviceId}" class="text-xs text-gray-500">0/250</span>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3">
                                    <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-all duration-200"
                                            onclick="hideAddMetaExampleForm(${serviceId})">
                                        Annuller
                                    </button>
                                    <button class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                            onclick="addMetaExample(${serviceId})">
                                        Gem Eksempel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Meta Examples List -->
                        <div id="meta-examples-list-${serviceId}" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <span class="text-4xl">üìù</span>
                                <p class="mt-2">Indl√¶ser meta eksempler...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-content-negative-${serviceId}">
                    <div class="p-6">
                        <!-- Negative Keywords Header -->
                        <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-medium text-red-900" id="negative-header-title-${serviceId}">üö´ Negative Keywords</h4>
                                <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm"
                                        onclick="showAddNegativeListModal(${serviceId}, currentExpandedIndustry)">
                                    ‚ûï Opret Ny Liste
                                </button>
                            </div>
                            <p class="text-sm text-red-700">Tilknyttede negative s√∏geordslister som vil blive anvendt i denne service</p>
                        </div>

                        <!-- Connected Lists as Buttons -->
                        <div id="negative-lists-buttons-${serviceId}" class="mb-6">
                            <h5 class="font-medium text-gray-900 mb-3">Tilknyttede Lister</h5>
                            <div class="flex flex-wrap gap-2" id="connected-lists-${serviceId}">
                                <!-- Connected lists will be loaded here as buttons -->
                            </div>
                            <div class="text-center py-6 text-gray-500" id="no-lists-message-${serviceId}">
                                <span class="text-3xl">üìã</span>
                                <p class="mt-2">Ingen negative s√∏geordslister tilknyttet endnu</p>
                                <p class="text-sm">Klik "‚ûï Opret Ny Liste" for at oprette en ny liste</p>
                            </div>
                        </div>

                        <!-- Keywords Content Section (shown when a list is selected) -->
                        <div id="negative-keywords-content-${serviceId}" class="hidden">
                            <div class="keywords-content border border-gray-200 rounded-lg" data-service-id="${serviceId}">
                                <div class="border-b border-gray-200">
                                    <!-- Add New Keyword Form -->
                                    <div class="p-6 bg-gray-50 border-b border-gray-200">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-medium text-gray-900">‚ûï Tilf√∏j Nye Keywords</h4>
                                            <button class="import-excel-btn bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2"
                                                    data-service-id="${serviceId}"
                                                    onclick="openImportExcelForService(${serviceId})"
                                                    title="Importer keywords fra Excel fil">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                                                </svg>
                                                <span>Importer Excel</span>
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input type="text"
                                                   placeholder="Negativt s√∏geord..."
                                                   class="new-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                   data-service-id="${serviceId}"
                                                   onkeypress="if(event.key==='Enter') addNegativeKeywordToService(${serviceId})">
                                            <select class="new-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    data-service-id="${serviceId}">
                                                <option value="broad">Broad Match</option>
                                                <option value="phrase">Phrase Match</option>
                                                <option value="exact">Exact Match</option>
                                            </select>
                                            <button class="add-keyword-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                                    data-service-id="${serviceId}"
                                                    onclick="addNegativeKeywordToService(${serviceId})">
                                                Tilf√∏j
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Keywords Table -->
                                    <div class="keywords-list p-6" data-service-id="${serviceId}">
                                        <div class="overflow-x-auto">
                                            <table class="w-full">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                                                        <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                                                        <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="negative-keywords-tbody-${serviceId}" class="divide-y divide-gray-200">
                                                    <!-- Keywords will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="no-keywords-message-${serviceId}" class="text-center py-8 text-gray-500">
                                            <span class="text-3xl">üìù</span>
                                            <p class="mt-2">Ingen negative keywords endnu</p>
                                            <p class="text-sm">Tilf√∏j keywords ovenfor eller importer fra Excel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Available Lists for Adding -->
                        <div id="available-lists-container-${serviceId}" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h5 class="font-medium text-gray-900 mb-3">Tilg√¶ngelige lister:</h5>
                            <div id="available-lists-${serviceId}" class="flex flex-wrap gap-2">
                                <!-- Available lists will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Find the services grid container and append keywords content after it
        const servicesGrid = serviceCard.closest('.services-grid');
        servicesGrid.after(keywordsHtml);
        keywordsContent = $(`.keywords-content[data-service-id="${serviceId}"]`);
    }

    // Load Google Ads keywords by default
    loadGoogleAdsKeywords(serviceId);
}

// Google Ads Keywords functionality
function loadGoogleAdsKeywords(serviceId) {
    console.log('Loading Google Ads keywords for service:', serviceId);
    
    $.ajax({
        url: `/ajax/get-service-keywords/${serviceId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                generateGoogleAdsKeywordsTable(serviceId, response.keywords);
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af Google Ads keywords', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved indl√¶sning af Google Ads keywords', 'error');
        }
    });
}

function generateGoogleAdsKeywordsTable(serviceId, keywords) {
    let html = '';
    
    if (keywords.length === 0) {
        html = `
            <div class="text-center py-12 text-blue-600">
                <span class="text-4xl">üì±</span>
                <p class="mt-2 text-gray-600">Ingen Google Ads keywords endnu</p>
                <p class="text-sm text-gray-500">Tilf√∏j dit f√∏rste keyword ovenfor</p>
            </div>
        `;
    } else {
        html = `
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="bg-blue-50 px-6 py-3 border-b border-blue-200">
                    <h5 class="font-semibold text-blue-800 flex items-center">
                        <span class="text-lg mr-2">üì±</span>
                        Google Ads Keywords (${keywords.length})
                    </h5>
                </div>
                
                <div class="divide-y divide-gray-200">
        `;
        
        html += `
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="text-left py-3 px-4 font-medium text-gray-900">S√∏geord</th>
                        <th class="text-left py-3 px-4 font-medium text-gray-900">Match Type</th>
                        <th class="text-center py-3 px-4 font-medium text-gray-900">Prim√¶r</th>
                        <th class="text-right py-3 px-4 font-medium text-gray-900">Handlinger</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
        `;
        
        keywords.forEach(keyword => {
            const matchTypeColors = {
                'exact': 'bg-purple-100 text-purple-800',
                'phrase': 'bg-blue-100 text-blue-800', 
                'broad': 'bg-green-100 text-green-800'
            };
            
            const matchColor = matchTypeColors[keyword.match_type] || 'bg-gray-100 text-gray-800';
            const primaryIcon = keyword.is_primary ? '‚≠ê' : '‚òÜ';
            const primaryClass = keyword.is_primary ? 'text-yellow-500' : 'text-gray-400';
            
            html += `
                <tr class="hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keyword.id}">
                    <td class="py-3 px-4">
                        <span class="font-medium text-gray-900">${keyword.keyword_text}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${matchColor}">
                            ${keyword.match_type_display}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="${primaryClass} text-lg">
                            ${primaryIcon}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-right">
                        <div class="flex items-center justify-end space-x-2">
                            <button onclick="editGoogleAdsKeyword(${keyword.id}, ${serviceId})" 
                                    class="text-gray-500 hover:text-blue-600 p-1" title="Redig√©r keyword">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button onclick="deleteGoogleAdsKeyword(${keyword.id}, ${serviceId})" 
                                    class="text-gray-500 hover:text-red-600 p-1" title="Slet keyword">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 3V4H4V6H5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V6H20V4H15V3H9ZM7 6H17V19H7V6ZM9 8V17H11V8H9ZM13 8V17H15V8H13Z"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        html += `
                </div>
            </div>
        `;
    }
    
    $(`#ads-keywords-content-${serviceId}`).html(html);
}

function editGoogleAdsKeyword(keywordId, serviceId) {
    console.log('Editing Google Ads keyword:', keywordId);
    
    // Exit any existing edit mode first
    exitGoogleAdsEditMode();
    
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    const keywordText = row.find('td:first-child span').text();
    const matchTypeBadge = row.find('.inline-flex');
    
    // Get current match type from the badge classes
    let currentMatchType = 'phrase';
    if (matchTypeBadge.hasClass('bg-purple-100')) currentMatchType = 'exact';
    else if (matchTypeBadge.hasClass('bg-blue-100')) currentMatchType = 'phrase';
    else if (matchTypeBadge.hasClass('bg-green-100')) currentMatchType = 'broad';
    
    // Get current primary status
    const primaryIcon = row.find('td:nth-child(3) span');
    const isPrimary = primaryIcon.text() === '‚≠ê';
    
    // Replace keyword text with input
    row.find('td:first-child').html(`
        <input type="text" class="edit-ads-keyword-input w-full px-2 py-1 border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
               value="${keywordText}" data-original="${keywordText}">
    `);
    
    // Replace match type badge with select
    const selectHtml = `
        <select class="edit-ads-match-type-select px-2 py-1 border border-blue-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs">
            <option value="broad" ${currentMatchType === 'broad' ? 'selected' : ''}>Broad Match</option>
            <option value="phrase" ${currentMatchType === 'phrase' ? 'selected' : ''}>Phrase Match</option>
            <option value="exact" ${currentMatchType === 'exact' ? 'selected' : ''}>Exact Match</option>
        </select>
    `;
    row.find('td:nth-child(2)').html(selectHtml);
    
    // Replace primary status with toggle checkbox
    row.find('td:nth-child(3)').html(`
        <input type="checkbox" class="edit-ads-primary-checkbox form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
               ${isPrimary ? 'checked' : ''}>
    `);
    
    // Replace action buttons with save/cancel
    row.find('td:last-child').html(`
        <div class="flex items-center justify-end space-x-2">
            <button class="save-ads-keyword-btn text-green-600 hover:text-green-800 p-1" data-keyword-id="${keywordId}" data-service-id="${serviceId}" title="Gem √¶ndringer">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
            </button>
            <button class="cancel-ads-edit-btn text-gray-600 hover:text-gray-800 p-1" data-keyword-id="${keywordId}" data-service-id="${serviceId}" title="Annuller">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    `);
    
    // Add edit mode styling
    row.addClass('edit-mode bg-blue-50');
    
    // Store current edit keyword ID
    window.currentGoogleAdsEditId = keywordId;
    
    // Focus on input
    row.find('.edit-ads-keyword-input').focus().select();
}

function exitGoogleAdsEditMode(forceReload = false) {
    if (window.currentGoogleAdsEditId) {
        const row = $(`tr[data-keyword-id="${window.currentGoogleAdsEditId}"]`);
        row.removeClass('edit-mode bg-blue-50');
        window.currentGoogleAdsEditId = null;
        
        // Only reload if forced (e.g., on cancel)
        if (forceReload) {
            const serviceId = row.closest('[data-service-id]').data('service-id');
            if (serviceId) {
                loadGoogleAdsKeywords(serviceId);
            }
        }
    }
}

function updateGoogleAdsKeyword(keywordId, keywordText, matchType, isPrimary, serviceId) {
    console.log('Updating Google Ads keyword:', keywordId, keywordText, matchType, isPrimary);
    
    $.ajax({
        url: `/ajax/update-service-keyword/${keywordId}/`,
        type: 'POST',
        data: {
            keyword_text: keywordText,
            match_type: matchType,
            is_primary: isPrimary
        },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            console.log('Update Google Ads keyword response:', response);
            if (response.success) {
                showToast(response.message, 'success');
                
                // Update the row directly with new data
                updateGoogleAdsKeywordRowInline(keywordId, response.keyword);
                exitGoogleAdsEditMode();
            } else {
                showToast(response.error || 'Fejl ved opdatering af Google Ads keyword', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Update Google Ads keyword error:', error);
            showToast('Fejl ved opdatering af Google Ads keyword', 'error');
        }
    });
}

function updateGoogleAdsKeywordRowInline(keywordId, keywordData) {
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    if (row.length === 0) return;
    
    // Update keyword text
    row.find('td:first-child').html(`<span class="font-medium text-gray-900">${keywordData.keyword_text}</span>`);
    
    // Update match type badge
    const matchTypeColors = {
        'exact': 'bg-purple-100 text-purple-800',
        'phrase': 'bg-blue-100 text-blue-800', 
        'broad': 'bg-green-100 text-green-800'
    };
    
    const matchColor = matchTypeColors[keywordData.match_type] || 'bg-gray-100 text-gray-800';
    
    row.find('td:nth-child(2)').html(`
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${matchColor}">
            ${keywordData.match_type_display}
        </span>
    `);
    
    // Update primary status
    const primaryIcon = keywordData.is_primary ? '‚≠ê' : '‚òÜ';
    const primaryClass = keywordData.is_primary ? 'text-yellow-500' : 'text-gray-400';
    
    row.find('td:nth-child(3)').html(`
        <span class="${primaryClass} text-lg">
            ${primaryIcon}
        </span>
    `);
    
    // Restore action buttons
    row.find('td:last-child').html(`
        <div class="flex items-center justify-end space-x-2">
            <button onclick="editGoogleAdsKeyword(${keywordData.id}, ${keywordData.service_id || 'serviceId'})" 
                    class="text-gray-500 hover:text-blue-600 p-1" title="Redig√©r keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
            </button>
            <button onclick="deleteGoogleAdsKeyword(${keywordData.id}, ${keywordData.service_id || 'serviceId'})" 
                    class="text-gray-500 hover:text-red-600 p-1" title="Slet keyword">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 3V4H4V6H5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V6H20V4H15V3H9ZM7 6H17V19H7V6ZM9 8V17H11V8H9ZM13 8V17H15V8H13Z"/>
                </svg>
            </button>
        </div>
    `);
    
    // Add brief highlight effect to show the update
    row.addClass('bg-green-50 border-green-200');
    setTimeout(() => {
        row.removeClass('bg-green-50 border-green-200');
    }, 1500);
    
    console.log('Google Ads keyword row updated inline:', keywordData);
}

function deleteGoogleAdsKeyword(keywordId, serviceId) {
    if (confirm('Er du sikker p√• at du vil slette dette Google Ads keyword?')) {
        $.ajax({
            url: `/ajax/delete-service-keyword/${keywordId}/`,
            method: 'POST',
            data: {
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    // Reload Google Ads keywords to show updated list
                    loadGoogleAdsKeywords(serviceId);
                } else {
                    showToast(response.error || 'Fejl ved sletning af Google Ads keyword', 'error');
                }
            },
            error: function() {
                showToast('Fejl ved sletning af Google Ads keyword', 'error');
            }
        });
    }
}

// Event handlers for Google Ads keyword editing
$(document).on('click', '.save-ads-keyword-btn', function() {
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    
    const keywordText = row.find('.edit-ads-keyword-input').val().trim();
    const matchType = row.find('.edit-ads-match-type-select').val();
    const isPrimary = row.find('.edit-ads-primary-checkbox').prop('checked');
    
    if (!keywordText) {
        showToast('Keyword tekst m√• ikke v√¶re tom', 'error');
        return;
    }
    
    updateGoogleAdsKeyword(keywordId, keywordText, matchType, isPrimary, serviceId);
});

$(document).on('click', '.cancel-ads-edit-btn', function() {
    exitGoogleAdsEditMode(true);  // Force reload on cancel
});

// Enter key to save, Escape to cancel for Google Ads keywords
$(document).on('keydown', '.edit-ads-keyword-input', function(e) {
    if (e.key === 'Enter') {
        $('.save-ads-keyword-btn').click();
    } else if (e.key === 'Escape') {
        exitGoogleAdsEditMode(true);  // Force reload on escape
    }
});

// Event handlers for SEO keyword editing
$(document).on('click', '.save-seo-keyword-btn', function() {
    const keywordId = $(this).data('keyword-id');
    const serviceId = $(this).data('service-id');
    const row = $(`tr[data-keyword-id="${keywordId}"]`);
    
    const keywordText = row.find('.edit-seo-keyword-input').val().trim();
    const keywordType = row.find('.edit-seo-keyword-type-select').val();
    const searchVolume = row.find('.edit-seo-search-volume-input').val();
    const isPrimary = row.find('.edit-seo-primary-checkbox').prop('checked');
    
    if (!keywordText) {
        showToast('SEO keyword tekst m√• ikke v√¶re tom', 'error');
        return;
    }
    
    updateSEOKeyword(keywordId, keywordText, keywordType, searchVolume, isPrimary, serviceId);
});

$(document).on('click', '.cancel-seo-edit-btn', function() {
    exitSEOEditMode(true);  // Force reload on cancel
});

// Enter key to save, Escape to cancel for SEO keywords
$(document).on('keydown', '.edit-seo-keyword-input', function(e) {
    if (e.key === 'Enter') {
        $('.save-seo-keyword-btn').click();
    } else if (e.key === 'Escape') {
        exitSEOEditMode(true);  // Force reload on escape
    }
});

// Enter key to add Google Ads keyword
$(document).on('keypress', '.new-ads-keyword-text', function(e) {
    if (e.which === 13) { // Enter key
        const serviceId = $(this).data('service-id');
        addGoogleAdsKeyword(serviceId);
    }
});

// Make keyword functions globally available  
window.toggleIndustryExpansion = toggleIndustryExpansion;
window.toggleServiceExpansion = toggleServiceExpansion;
window.loadServiceKeywords = loadServiceKeywords;
window.switchKeywordTab = switchKeywordTab;
window.addSEOKeyword = addSEOKeyword;
window.addGoogleAdsKeyword = addGoogleAdsKeyword;
window.loadGoogleAdsKeywords = loadGoogleAdsKeywords;
window.editGoogleAdsKeyword = editGoogleAdsKeyword;
window.deleteGoogleAdsKeyword = deleteGoogleAdsKeyword;
window.loadNegativeKeywordLists = loadNegativeKeywordLists;
window.searchNegativeKeywordLists = searchNegativeKeywordLists;
window.connectNegativeList = connectNegativeList;
window.disconnectNegativeList = disconnectNegativeList;
window.editSEOKeyword = editSEOKeyword;
window.deleteSEOKeyword = deleteSEOKeyword;

// =================================================================
// NEGATIVE KEYWORDS MANAGEMENT FUNCTIONS (BUTTON LAYOUT)
// =================================================================

function loadNegativeKeywordLists(serviceId) {
    console.log('Loading negative keyword lists for service:', serviceId);
    
    $.ajax({
        url: `/ajax/get-service-negative-lists/${serviceId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                generateNegativeKeywordsContent(serviceId, response.service_name, response.connected_lists, response.available_lists);
            } else {
                showToast(response.error || 'Fejl ved indl√¶sning af negative keywords', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved indl√¶sning af negative keywords', 'error');
        }
    });
}

function generateNegativeKeywordsContent(serviceId, serviceName, connectedLists, availableLists) {
    console.log('Generating negative keywords content for service:', serviceId);
    
    let html = `
        <div class="p-6">
            <!-- Negative Keywords Header -->
            <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-medium text-red-900">üö´ Negative Keywords for "${serviceName}"</h4>
                    <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm"
                            onclick="showAddNegativeListModal(${serviceId}, currentExpandedIndustry)">
                        ‚ûï Tilf√∏j Liste
                    </button>
                </div>
                <p class="text-sm text-red-700">Tilknyttede negative s√∏geordslister som vil blive anvendt i denne service</p>
            </div>
            
            <!-- Connected Lists as Buttons -->
            <div id="negative-lists-buttons-${serviceId}" class="mb-6">
                <h5 class="font-medium text-gray-900 mb-3">Tilknyttede Lister</h5>
                <div class="flex flex-wrap gap-2" id="connected-lists-${serviceId}">
    `;
    
    if (connectedLists && connectedLists.length > 0) {
        connectedLists.forEach(list => {
            html += `
                <button onclick="selectNegativeList(${list.list_id}, ${serviceId})"
                        data-list-id="${list.list_id}"
                        class="connected-list-btn inline-flex items-center bg-red-100 text-red-800 px-3 py-2 rounded-lg text-sm font-medium border border-red-200 hover:bg-red-200 transition-colors duration-200 cursor-pointer">
                    <span class="mr-2">üö´</span>
                    <span class="mr-2">${list.name}</span>
                    <span class="text-xs text-red-600 mr-2">(${list.keywords_count || 0})</span>
                    <span onclick="event.stopPropagation(); disconnectNegativeList(${list.list_id}, ${serviceId})"
                          class="ml-1 text-red-600 hover:text-red-800 font-bold text-lg leading-none"
                          title="Fjern negative s√∏geordsliste">
                        √ó
                    </span>
                </button>
            `;
        });
    } else {
        html += `
            <div class="text-gray-500 text-sm italic">
                Ingen negative s√∏geordslister tilknyttet endnu
            </div>
        `;
    }
    
    html += `
                </div>
            </div>
            
            <!-- Available Lists -->
            <div class="border-t border-gray-200 pt-6">
                <h5 class="font-medium text-gray-900 mb-3">Tilg√¶ngelige Lister</h5>
                <div class="flex flex-wrap gap-2" id="available-lists-${serviceId}">
    `;
    
    if (availableLists && availableLists.length > 0) {
        // Filter out already connected lists
        const connectedIds = connectedLists ? connectedLists.map(list => list.list_id) : [];
        const unconnectedLists = availableLists.filter(list => !connectedIds.includes(list.id));
        
        if (unconnectedLists.length > 0) {
            unconnectedLists.forEach(list => {
                html += `
                    <button onclick="connectNegativeList(${list.id}, ${serviceId})" 
                            class="inline-flex items-center bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium border border-gray-300 hover:bg-gray-200 hover:border-red-300 hover:text-red-700 transition-all duration-200">
                        <span class="mr-2">üìã</span>
                        <span class="mr-2">${list.name}</span>
                        <span class="text-xs text-gray-600">(${list.keywords_count || 0})</span>
                    </button>
                `;
            });
        } else {
            html += `
                <div class="text-gray-500 text-sm italic">
                    Alle tilg√¶ngelige lister er allerede tilknyttet
                </div>
            `;
        }
    } else {
        html += `
            <div class="text-gray-500 text-sm italic">
                Ingen tilg√¶ngelige negative s√∏geordslister fundet
            </div>
        `;
    }
    
    html += `
                </div>
            </div>

            <!-- Keywords Content Section (shown when a list is selected) -->
            <div id="negative-keywords-content-${serviceId}" class="hidden">
                <div class="keywords-content border border-gray-200 rounded-lg" data-service-id="${serviceId}">
                    <div class="border-b border-gray-200">
                        <!-- Add New Keyword Form -->
                        <div class="p-6 bg-gray-50 border-b border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-medium text-gray-900">‚ûï Tilf√∏j Nye Keywords</h4>
                                <button class="import-excel-btn bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center space-x-2"
                                        data-service-id="${serviceId}"
                                        onclick="openImportExcelForService(${serviceId})"
                                        title="Importer keywords fra Excel fil">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></path>
                                    </svg>
                                    <span>Importer Excel</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text"
                                       placeholder="Negativt s√∏geord..."
                                       class="new-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       data-service-id="${serviceId}"
                                       onkeypress="if(event.key==='Enter') addNegativeKeywordToService(${serviceId})">
                                <select class="new-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        data-service-id="${serviceId}">
                                    <option value="broad">Broad Match</option>
                                    <option value="phrase">Phrase Match</option>
                                    <option value="exact">Exact Match</option>
                                </select>
                                <button class="add-keyword-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                        data-service-id="${serviceId}"
                                        onclick="addNegativeKeywordToService(${serviceId})">
                                    Tilf√∏j
                                </button>
                            </div>
                        </div>

                        <!-- Keywords Table -->
                        <div class="keywords-list p-6" data-service-id="${serviceId}">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                                            <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="negative-keywords-tbody-${serviceId}" class="divide-y divide-gray-200">
                                        <!-- Keywords will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="no-keywords-message-${serviceId}" class="text-center py-8 text-gray-500">
                                <span class="text-3xl">üìù</span>
                                <p class="mt-2">Ingen negative keywords endnu</p>
                                <p class="text-sm">Tilf√∏j keywords ovenfor eller importer fra Excel</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Update the negative keywords tab content
    $(`#tab-content-negative-${serviceId}`).html(html);

    // Auto-select first connected list if available
    if (connectedLists && connectedLists.length > 0) {
        selectNegativeList(connectedLists[0].list_id, serviceId);
    }
}

function showAddNegativeListModal(serviceId, industryId) {
    console.log('Opening create negative keyword list modal for service:', serviceId, 'industry:', industryId);

    // Use passed industryId or fall back to currentExpandedIndustry
    const targetIndustryId = industryId || currentExpandedIndustry || '';
    
    const formContent = `
        <div class="space-y-6">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-red-100 to-pink-100 p-4 rounded-lg border border-red-200">
                <h4 class="text-lg font-medium text-red-900 mb-2">üìã Opret Ny Negative S√∏geordsliste</h4>
                <p class="text-sm text-red-700">Opret en ny negative keyword liste og tilknyt den automatisk til denne service</p>
            </div>
            
            <!-- Basic Information -->
            <div class="space-y-4">
                <h5 class="font-medium text-gray-900 border-b border-gray-200 pb-2">Grundl√¶ggende Oplysninger</h5>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="negative-list-name" class="block text-sm font-medium text-gray-700 mb-2">Liste Navn *</label>
                        <input type="text" id="negative-list-name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="F.eks. Service-specifikke negative ord"
                               maxlength="100">
                    </div>
                    
                    <div>
                        <label for="negative-list-category" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="negative-list-category" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="general">Generel Negativ Liste</option>
                            <option value="competitor">Konkurrent Negative</option>
                            <option value="service_specific" selected>Service Specifik</option>
                            <option value="location_based">Lokationsbaseret</option>
                            <option value="brand_protection">Brand Beskyttelse</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="negative-list-description" class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse</label>
                    <textarea id="negative-list-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                              placeholder="Beskriv form√•let med denne negative s√∏geordsliste..."
                              maxlength="500"></textarea>
                </div>
            </div>
            
            <!-- Visual Settings -->
            <div class="space-y-4">
                <h5 class="font-medium text-gray-900 border-b border-gray-200 pb-2">Visuelle Indstillinger</h5>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="negative-list-icon" class="block text-sm font-medium text-gray-700 mb-2">Ikon</label>
                        <input type="text" id="negative-list-icon" value="üö´"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="üö´" maxlength="10">
                    </div>
                    
                    <div>
                        <label for="negative-list-color" class="block text-sm font-medium text-gray-700 mb-2">Farve</label>
                        <input type="color" id="negative-list-color" value="#DC2626"
                               class="w-16 h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
            </div>
            
            <!-- Initial Keywords Section (identisk med negative_keywords_manager) -->
            <div class="space-y-4">
                <h5 class="font-medium text-gray-900 border-b border-gray-200 pb-2">‚ûï Tilf√∏j Negative Keywords</h5>
                <p class="text-sm text-gray-600">Tilf√∏j keywords til listen - √©n ad gangen med matchtype valg</p>

                <!-- Add Keyword Form -->
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text"
                               id="initial-keyword-text"
                               placeholder="Negativt s√∏geord..."
                               class="new-keyword-text px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               onkeypress="if(event.key==='Enter') addInitialKeyword()">
                        <select id="initial-keyword-match-type"
                                class="new-keyword-match-type px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="broad">Broad Match</option>
                            <option value="phrase">Phrase Match</option>
                            <option value="exact">Exact Match</option>
                        </select>
                        <button type="button"
                                class="add-keyword-btn bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200"
                                onclick="addInitialKeyword()">
                            Tilf√∏j
                        </button>
                    </div>
                </div>

                <!-- Keywords Table -->
                <div class="overflow-x-auto">
                    <table class="w-full" id="initial-keywords-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">S√∏geord</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Match Type</th>
                                <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="initial-keywords-tbody" class="divide-y divide-gray-200">
                            <!-- Keywords will be added here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-initial-keywords-message" class="text-center py-4 text-gray-500">
                    <span class="text-2xl">üìù</span>
                    <p class="mt-1 text-sm">Ingen keywords tilf√∏jet endnu</p>
                </div>

                <!-- Hidden field to store keywords as JSON -->
                <input type="hidden" id="initial-keywords-json" value="[]">
            </div>
            
            <input type="hidden" id="target-service-id" value="${serviceId}">
            <input type="hidden" id="target-industry-id" value="${targetIndustryId}">
        </div>
    `;

    openSlidePanel(
        'Opret Negative S√∏geordsliste',
        'Opret en ny liste og tilknyt den til denne service',
        formContent,
        function() { createNegativeListAndConnect(); }
    );
    
    // Focus p√• navn feltet
    setTimeout(() => {
        document.getElementById('negative-list-name')?.focus();
    }, 300);
}

function createNegativeListAndConnect() {
    const name = $('#negative-list-name').val().trim();
    const description = $('#negative-list-description').val().trim();
    const category = $('#negative-list-category').val();
    const icon = $('#negative-list-icon').val().trim() || 'üö´';
    const color = $('#negative-list-color').val() || '#DC2626';
    const initialKeywordsJson = $('#initial-keywords-json').val() || '[]';
    const initialKeywords = JSON.parse(initialKeywordsJson);
    const serviceId = $('#target-service-id').val();
    const industryId = $('#target-industry-id').val() || currentExpandedIndustry || '';

    if (!name) {
        showToast('Indtast venligst et navn til listen', 'error');
        $('#negative-list-name').focus();
        return;
    }

    // Create the negative keyword list
    $.ajax({
        url: '/ajax/create-negative-keyword-list/',
        method: 'POST',
        data: {
            name: name,
            description: description,
            category: category,
            icon: icon,
            color: color,
            industry: industryId,  // Now sending industry ID for proper sync
            initial_keywords: JSON.stringify(initialKeywords),
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                console.log('Negative list created:', response.list_id);
                
                // Automatically connect the new list to the service
                connectNegativeList(response.list_id, serviceId);
                
                closeSlidePanel();
                showToast(`Negative s√∏geordsliste "${name}" oprettet og tilknyttet succesfuldt!`, 'success');
            } else {
                showToast(response.error || 'Fejl ved oprettelse af liste', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved oprettelse af negative s√∏geordsliste', 'error');
        }
    });
}

// ==========================================
// Initial Keywords Functions for Create List Modal
// ==========================================

function addInitialKeyword() {
    const keywordText = $('#initial-keyword-text').val().trim();
    const matchType = $('#initial-keyword-match-type').val();

    if (!keywordText) {
        showToast('Indtast venligst et keyword', 'error');
        return;
    }

    // Get current keywords from JSON
    let keywords = JSON.parse($('#initial-keywords-json').val() || '[]');

    // Check for duplicates
    const exists = keywords.some(k => k.keyword_text.toLowerCase() === keywordText.toLowerCase() && k.match_type === matchType);
    if (exists) {
        showToast('Dette keyword findes allerede med samme match type', 'warning');
        return;
    }

    // Add keyword
    const keywordId = Date.now(); // Temporary ID for UI
    keywords.push({
        id: keywordId,
        keyword_text: keywordText,
        match_type: matchType
    });

    // Update JSON
    $('#initial-keywords-json').val(JSON.stringify(keywords));

    // Add to table
    addInitialKeywordToTable(keywordId, keywordText, matchType);

    // Clear input and focus
    $('#initial-keyword-text').val('').focus();

    // Hide no keywords message
    $('#no-initial-keywords-message').hide();

    showToast('Keyword tilf√∏jet', 'success');
}

function addInitialKeywordToTable(keywordId, keywordText, matchType) {
    const matchTypeBadge = getMatchTypeBadgeHtml(matchType);

    const row = `
        <tr class="keyword-row hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keywordId}">
            <td class="py-3 px-4"><span class="font-medium text-gray-900">${keywordText}</span></td>
            <td class="py-3 px-4">${matchTypeBadge}</td>
            <td class="py-3 px-4 text-right">
                <div class="flex items-center justify-end space-x-2">
                    <button class="delete-keyword-btn text-gray-500 hover:text-red-600 p-1"
                            onclick="removeInitialKeyword(${keywordId})"
                            title="Slet keyword">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `;

    $('#initial-keywords-tbody').append(row);
}

function removeInitialKeyword(keywordId) {
    // Remove from JSON
    let keywords = JSON.parse($('#initial-keywords-json').val() || '[]');
    keywords = keywords.filter(k => k.id !== keywordId);
    $('#initial-keywords-json').val(JSON.stringify(keywords));

    // Remove from table
    $(`tr[data-keyword-id="${keywordId}"]`).remove();

    // Show no keywords message if empty
    if (keywords.length === 0) {
        $('#no-initial-keywords-message').show();
    }

    showToast('Keyword fjernet', 'info');
}

function getMatchTypeBadgeHtml(matchType) {
    let badgeClass = '';
    let displayText = '';

    switch (matchType) {
        case 'exact':
            badgeClass = 'bg-purple-100 text-purple-800';
            displayText = 'Exact Match';
            break;
        case 'phrase':
            badgeClass = 'bg-blue-100 text-blue-800';
            displayText = 'Phrase Match';
            break;
        case 'broad':
        default:
            badgeClass = 'bg-gray-100 text-gray-800';
            displayText = 'Broad Match';
            break;
    }

    return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${badgeClass}" data-match-type="${matchType}">${displayText}</span>`;
}

// ==========================================
// Negative Keywords Functions for Service Tab
// ==========================================

function addNegativeKeywordToService(serviceId) {
    const keywordInput = $(`.new-keyword-text[data-service-id="${serviceId}"]`);
    const matchTypeSelect = $(`.new-keyword-match-type[data-service-id="${serviceId}"]`);

    const keywordText = keywordInput.val().trim();
    const matchType = matchTypeSelect.val();

    if (!keywordText) {
        showToast('Indtast venligst et keyword', 'error');
        return;
    }

    // Get the active list ID for this service
    const activeListId = $(`#negative-keywords-content-${serviceId}`).data('active-list-id');

    if (!activeListId) {
        showToast('V√¶lg f√∏rst en liste at tilf√∏je keywords til', 'warning');
        return;
    }

    // Send to server
    $.ajax({
        url: '/ajax/add-negative-keyword/',
        method: 'POST',
        data: {
            list_id: activeListId,
            keyword_text: keywordText,
            match_type: matchType,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // Add to table
                const row = generateNegativeKeywordRow(response.keyword);
                $(`#negative-keywords-tbody-${serviceId}`).append(row);

                // Clear input
                keywordInput.val('').focus();

                // Hide no keywords message
                $(`#no-keywords-message-${serviceId}`).hide();

                showToast('Keyword tilf√∏jet', 'success');
            } else {
                showToast(response.error || 'Fejl ved tilf√∏jelse af keyword', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved tilf√∏jelse af keyword', 'error');
        }
    });
}

function generateNegativeKeywordRow(keyword) {
    const matchTypeBadge = getMatchTypeBadgeHtml(keyword.match_type);
    // Handle both keyword_text (from loadNegativeKeywordsForList) and text (from add-negative-keyword AJAX)
    const keywordText = keyword.keyword_text || keyword.text;

    return `
        <tr class="keyword-row hover:bg-gray-50 transition-colors duration-200" data-keyword-id="${keyword.id}">
            <td class="py-3 px-4"><span class="font-medium text-gray-900">${keywordText}</span></td>
            <td class="py-3 px-4">${matchTypeBadge}</td>
            <td class="py-3 px-4 text-right">
                <div class="flex items-center justify-end space-x-2">
                    <button class="edit-keyword-btn text-gray-500 p-1 hover:text-purple-600"
                            onclick="editNegativeKeyword(${keyword.id})"
                            title="Redig√©r keyword">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path>
                        </svg>
                    </button>
                    <button class="delete-keyword-btn text-gray-500 hover:text-red-600 p-1"
                            onclick="deleteNegativeKeyword(${keyword.id})"
                            title="Slet keyword">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function editNegativeKeyword(keywordId) {
    // TODO: Implement edit functionality
    showToast('Redig√©r funktionalitet kommer snart', 'info');
}

function deleteNegativeKeyword(keywordId) {
    if (!confirm('Er du sikker p√• at du vil slette dette keyword?')) {
        return;
    }

    $.ajax({
        url: `/ajax/delete-negative-keyword/${keywordId}/`,
        method: 'POST',
        data: {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                $(`tr[data-keyword-id="${keywordId}"]`).remove();
                showToast('Keyword slettet', 'success');
            } else {
                showToast(response.error || 'Fejl ved sletning af keyword', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved sletning af keyword', 'error');
        }
    });
}

function openImportExcelForService(serviceId) {
    // TODO: Implement Excel import for service
    showToast('Excel import funktionalitet kommer snart', 'info');
}

function selectNegativeList(listId, serviceId) {
    // Store the active list ID
    $(`#negative-keywords-content-${serviceId}`).data('active-list-id', listId);

    // Show the keywords content section
    $(`#negative-keywords-content-${serviceId}`).removeClass('hidden');

    // Load keywords for this list
    loadNegativeKeywordsForList(listId, serviceId);

    // Highlight the selected list button
    $(`#connected-lists-${serviceId} .connected-list-btn`).removeClass('ring-2 ring-red-500');
    $(`#connected-lists-${serviceId} .connected-list-btn[data-list-id="${listId}"]`).addClass('ring-2 ring-red-500');
}

function loadNegativeKeywordsForList(listId, serviceId) {
    $.ajax({
        url: `/ajax/get-negative-keywords/${listId}/`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const tbody = $(`#negative-keywords-tbody-${serviceId}`);
                tbody.empty();

                if (response.keywords && response.keywords.length > 0) {
                    response.keywords.forEach(keyword => {
                        tbody.append(generateNegativeKeywordRow(keyword));
                    });
                    $(`#no-keywords-message-${serviceId}`).hide();
                } else {
                    $(`#no-keywords-message-${serviceId}`).show();
                }
            }
        },
        error: function() {
            console.error('Error loading keywords for list:', listId);
        }
    });
}

// ==========================================
// Disconnect Negative List Function
// ==========================================

function disconnectNegativeList(listId, serviceId) {
    console.log('Disconnecting negative list:', listId, 'from service:', serviceId);
    
    if (!confirm('Er du sikker p√• at du vil fjerne denne negative s√∏geordsliste fra servicen?')) {
        return;
    }
    
    $.ajax({
        url: `/ajax/disconnect-negative-list/${listId}/`,
        method: 'POST',
        data: {
            service_id: serviceId,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                showToast(response.message, 'success');
                // Reload the negative keywords tab to show updated lists
                loadNegativeKeywordLists(serviceId);
            } else {
                showToast(response.error || 'Fejl ved fjernelse af liste', 'error');
            }
        },
        error: function() {
            showToast('Fejl ved fjernelse af negative s√∏geordsliste', 'error');
        }
    });
}

// =================================================================
// INDUSTRY KEYWORDS MANAGEMENT FUNCTIONS
// =================================================================


</script>

{% endblock %}
