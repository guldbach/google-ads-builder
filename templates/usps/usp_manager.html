{% extends 'base.html' %}

{% block title %}USP Manager - Administrer Alle USPs{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto section-spacing container-padding">
    <!-- Hero Section -->
    <div class="text-center mb-12 p-12 bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
        </div>
        <h1 class="text-5xl font-bold text-gray-900 mb-4">
            USP Manager
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Administrer alle USP kategorier og templates p√• √©n intuitiv side
        </p>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-gray-100">
        <div class="flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-lg font-semibold text-gray-900">Hurtige Handlinger</h2>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="add-category-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    ‚ûï Ny Kategori
                </button>
                <button id="add-usp-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    ‚≠ê Ny USP
                </button>
                <button id="bulk-import-btn" class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    üìä Bulk Import
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Overview -->
    <div id="categories-container" class="space-y-8">
        {% for category in usp_categories %}
        <div class="category-section bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden" 
             data-category-id="{{ category.id }}">
            <!-- Category Header -->
            <div class="category-header p-6" style="background: linear-gradient(135deg, {{ category.color }}20, {{ category.color }}10);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center justify-center w-12 h-12 rounded-xl" 
                             style="background-color: {{ category.color }}; color: white;">
                            <span class="text-2xl">{{ category.icon }}</span>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">{{ category.name }}</h3>
                            <p class="text-gray-600">{{ category.description }}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-sm text-gray-500">
                                    Sort: {{ category.sort_order }} | Max: {{ category.max_selections }} | 
                                    USPs: {{ category.usptemplate_set.count }}
                                </span>
                                {% if category.is_recommended_per_campaign %}
                                <span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    Anbefalet per kampagne
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-category-btn text-gray-500 hover:text-blue-600 p-2" 
                                data-category-id="{{ category.id }}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="add-usp-to-category-btn text-green-600 hover:text-green-700 p-2" 
                                data-category-id="{{ category.id }}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- USPs List -->
            <div class="usps-list p-6">
                <div class="space-y-3">
                    {% for usp in category.usptemplate_set.all %}
                    <div class="usp-item bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-all duration-200 border border-gray-200"
                         data-usp-id="{{ usp.id }}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="inline-flex items-center justify-center w-8 h-8 text-sm font-bold text-white rounded-full"
                                          style="background-color: {{ category.color }};">
                                        {{ usp.priority_rank }}
                                    </span>
                                    <h4 class="text-lg font-semibold text-gray-900 cursor-pointer toggle-details" data-usp-id="{{ usp.id }}">
                                        {{ usp.text }}
                                        <svg class="w-4 h-4 inline-block ml-2 text-gray-400 toggle-icon transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                        </svg>
                                    </h4>
                                    <span class="text-sm text-gray-500">Score: {{ usp.effectiveness_score|floatformat:1 }}</span>
                                </div>
                                
                                <div class="usp-details hidden mt-3 space-y-2" data-usp-id="{{ usp.id }}">
                                    {% if usp.explanation %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Forklaring:</span>
                                        <p class="text-sm text-gray-600 mt-1">{{ usp.explanation }}</p>
                                    </div>
                                    {% endif %}

                                    {% if usp.use_cases %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Use Cases:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for use_case in usp.use_cases %}
                                            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                                {{ use_case }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if usp.ideal_for_industries.all %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Brancher:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for industry in usp.ideal_for_industries.all %}
                                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">
                                                üè¢ {{ industry.name }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if usp.example_headlines %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Eksempel headlines:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for headline in usp.example_headlines %}
                                            <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                {{ headline }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- New Headline Variations Section -->
                                    {% if usp.short_headlines %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">üéØ Korte Headlines (‚â§30 chars):</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for headline in usp.short_headlines %}
                                            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                                {{ headline }} <span class="text-blue-600">({{ headline|length }})</span>
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if usp.best_for_headline %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">‚≠ê Bedste Headline:</span>
                                        <div class="mt-1">
                                            <span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                                                {{ usp.best_for_headline }} <span class="text-green-600">({{ usp.best_for_headline|length }})</span>
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if usp.best_for_description %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">üìù Bedste Description:</span>
                                        <p class="text-xs text-gray-600 mt-1 bg-gray-50 p-2 rounded">{{ usp.best_for_description }}</p>
                                    </div>
                                    {% endif %}

                                    {% if usp.placeholders_used %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Placeholders:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for placeholder in usp.placeholders_used %}
                                            <span class="inline-block px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">
                                                {{ placeholder }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="edit-usp-btn text-gray-500 hover:text-blue-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Rediger USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <button class="duplicate-usp-btn text-gray-500 hover:text-green-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Duplik√©r USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                    </svg>
                                </button>
                                <button class="delete-usp-btn text-gray-500 hover:text-red-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Slet USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <p>Ingen USPs i denne kategori endnu.</p>
                        <button class="mt-2 text-blue-600 hover:text-blue-700 font-medium add-usp-to-category-btn" 
                                data-category-id="{{ category.id }}">
                            Tilf√∏j f√∏rste USP
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Ingen USP kategorier endnu</h3>
            <p class="text-gray-600 mb-6">Kom i gang ved at oprette din f√∏rste kategori</p>
            <button id="create-first-category" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200">
                ‚ûï Opret F√∏rste Kategori
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal for Category Creation/Edit -->
<div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="category-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Ny Kategori</h3>
        <form id="category-form">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Navn *</label>
                    <input type="text" id="category-name" name="name" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse *</label>
                    <textarea id="category-description" name="description" rows="3" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ikon</label>
                        <input type="text" id="category-icon" name="icon" placeholder="‚ö°" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Farve</label>
                        <input type="color" id="category-color" name="color" value="#8B5CF6"
                               class="w-full h-12 border border-gray-300 rounded-lg">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sortering</label>
                        <input type="number" id="category-sort-order" name="sort_order" value="1" min="1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max USPs per kampagne</label>
                        <input type="number" id="category-max-selections" name="max_selections" value="1" min="1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="category-recommended" name="is_recommended_per_campaign" checked
                           class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="category-recommended" class="text-sm font-medium text-gray-700">
                        Anbefal denne kategori per kampagne
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-8">
                <button type="button" id="cancel-category" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Annuller
                </button>
                <button type="submit" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg">
                    Gem Kategori
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for USP Creation/Edit -->
<div id="usp-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="usp-modal-title" class="text-2xl font-bold text-gray-900 mb-6">Ny USP</h3>
        <form id="usp-form">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">USP Tekst *</label>
                        <input type="text" id="usp-text" name="text" required maxlength="200"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                        <select id="usp-main-category" name="main_category" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            {% for category in usp_categories %}
                            <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioritet (1 = h√∏jest)</label>
                        <input type="number" id="usp-priority" name="priority_rank" value="1" min="1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Effectiveness Score</label>
                        <input type="number" id="usp-effectiveness" name="effectiveness_score" value="0.8" min="0" max="1" step="0.1"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Forklaring</label>
                        <textarea id="usp-explanation" name="explanation" rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Forklar hvorn√•r denne USP skal bruges..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Use Cases (kommasepareret)</label>
                        <input type="text" id="usp-use-cases" name="use_cases" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="let_at_udregne, telefon_vurdering">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Eksempel Headlines (kommasepareret)</label>
                        <textarea id="usp-headlines" name="example_headlines" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Ring nu - f√• pris p√• 2 min, {SERVICE} priser i telefon"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üéØ Korte Headlines (kommasepareret, ‚â§30 chars)</label>
                        <textarea id="usp-short-headlines" name="short_headlines" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Ring nu - f√• pris, Pris i telefonen"></textarea>
                        <div class="text-xs text-gray-500 mt-1">Til Google Ads headlines - maks 30 karakterer hver</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‚≠ê Bedste Headline (maks 30 chars)</label>
                        <input type="text" id="usp-best-headline" name="best_for_headline" maxlength="30"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Ring nu - f√• pris">
                        <div class="text-xs text-gray-500 mt-1">Prim√¶r anbefalet headline version</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìù Bedste Description</label>
                        <textarea id="usp-best-description" name="best_for_description" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Bedste version til descriptions - kan v√¶re l√¶ngere end headlines"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Placeholders (kommasepareret)</label>
                        <input type="text" id="usp-placeholders" name="placeholders_used" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="{SERVICE}, {BYNAVN}">
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ideel for Industrier</label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    {% for industry in industries %}
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="ideal_for_industries" value="{{ industry.id }}" 
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm text-gray-700">{{ industry.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-8">
                <button type="button" id="cancel-usp" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Annuller
                </button>
                <button type="submit" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg">
                    Gem USP
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Modal management
    function openModal(modalId) {
        $(`#${modalId}`).removeClass('hidden');
    }
    
    function closeModal(modalId) {
        $(`#${modalId}`).addClass('hidden');
        $(`#${modalId} form`)[0].reset();
    }
    
    // Category Modal Events
    $('#add-category-btn, #create-first-category').click(function() {
        $('#category-modal-title').text('Ny Kategori');
        openModal('category-modal');
    });
    
    $('#cancel-category').click(function() {
        closeModal('category-modal');
    });
    
    // USP Modal Events  
    $('#add-usp-btn').click(function() {
        $('#usp-modal-title').text('Ny USP');
        $('#usp-form')[0].reset();
        $('input[name="ideal_for_industries"]').prop('checked', false);
        $('#usp-form').removeData('edit-id'); // Clear edit mode
        openModal('usp-modal');
    });
    
    $('.add-usp-to-category-btn').click(function() {
        const categoryId = $(this).data('category-id');
        $('#usp-modal-title').text('Ny USP');
        $('#usp-form')[0].reset();
        $('#usp-main-category').val(categoryId);
        $('input[name="ideal_for_industries"]').prop('checked', false);
        $('#usp-form').removeData('edit-id'); // Clear edit mode
        openModal('usp-modal');
    });
    
    $('#cancel-usp').click(function() {
        closeModal('usp-modal');
    });
    
    // Bulk Import functionality
    $('#bulk-import-btn').click(function() {
        alert('Bulk Import funktionalitet kommer snart! Du kan i mellemtiden bruge "Ny USP" knappen til at tilf√∏je USPs √©n ad gangen.');
    });
    
    // Close modals when clicking outside
    $('.fixed').click(function(e) {
        if (e.target === this) {
            closeModal('category-modal');
            closeModal('usp-modal');
        }
    });
    
    // Category Form Submission
    $('#category-form').submit(function(e) {
        e.preventDefault();
        
        const formData = {
            name: $('#category-name').val(),
            description: $('#category-description').val(),
            icon: $('#category-icon').val() || '‚ö°',
            color: $('#category-color').val(),
            sort_order: parseInt($('#category-sort-order').val()),
            max_selections: parseInt($('#category-max-selections').val()),
            is_recommended_per_campaign: $('#category-recommended').is(':checked')
        };
        
        const editId = $(this).data('edit-id');
        const url = editId ? `/usps/ajax/edit-category/${editId}/` : '{% url "usps:create_category_ajax" %}';
        
        $.ajax({
            url: url,
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated category
                } else {
                    alert('Fejl: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved behandling af kategorien');
            }
        });
    });
    
    // USP Form Submission
    $('#usp-form').submit(function(e) {
        e.preventDefault();
        
        const selectedIndustries = [];
        $('input[name="ideal_for_industries"]:checked').each(function() {
            selectedIndustries.push(parseInt($(this).val()));
        });
        
        const formData = {
            text: $('#usp-text').val(),
            main_category: $('#usp-main-category').val(),
            priority_rank: parseInt($('#usp-priority').val()),
            effectiveness_score: parseFloat($('#usp-effectiveness').val()),
            explanation: $('#usp-explanation').val(),
            use_cases: $('#usp-use-cases').val(),
            example_headlines: $('#usp-headlines').val(),
            short_headlines: $('#usp-short-headlines').val(),
            best_for_headline: $('#usp-best-headline').val(),
            best_for_description: $('#usp-best-description').val(),
            placeholders_used: $('#usp-placeholders').val(),
            ideal_for_industries: selectedIndustries
        };
        
        const editId = $(this).data('edit-id');
        const url = editId ? `/usps/ajax/edit-usp/${editId}/` : '{% url "usps:create_usp_ajax" %}';
        
        $.ajax({
            url: url,
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated USP
                } else {
                    alert('Fejl: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved behandling af USPen');
            }
        });
    });
    
    // Use event delegation for dynamically added elements
    $(document).on('click', '.duplicate-usp-btn', function(e) {
        e.preventDefault();
        const uspId = $(this).data('usp-id');
        
        $.ajax({
            url: `/usps/ajax/duplicate-usp/${uspId}/`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show duplicated USP
                } else {
                    alert('Fejl: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved duplikering af USPen');
            }
        });
    });
    
    // Delete USP with confirmation
    $(document).on('click', '.delete-usp-btn', function(e) {
        e.preventDefault();
        const uspId = $(this).data('usp-id');
        const uspText = $(this).closest('.usp-item').find('h4').text().trim();
        
        if (confirm(`Er du sikker p√• at du vil slette USP: "${uspText}"?`)) {
            $.ajax({
                url: `/usps/ajax/delete-usp/${uspId}/`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        location.reload(); // Reload to remove deleted USP
                    } else {
                        alert('Fejl: ' + response.error);
                    }
                },
                error: function() {
                    alert('Der opstod en fejl ved sletning af USPen');
                }
            });
        }
    });
    
    // Use event delegation for edit buttons too
    $(document).on('click', '.edit-usp-btn', function() {
        const uspId = $(this).data('usp-id');
        
        // Load USP data
        $.ajax({
            url: `/usps/ajax/get-usp/${uspId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const usp = response.usp;
                    
                    // Populate form
                    $('#usp-modal-title').text('Rediger USP');
                    $('#usp-text').val(usp.text);
                    $('#usp-main-category').val(usp.main_category_id);
                    $('#usp-priority').val(usp.priority_rank);
                    $('#usp-effectiveness').val(usp.effectiveness_score);
                    $('#usp-explanation').val(usp.explanation);
                    $('#usp-use-cases').val(usp.use_cases);
                    $('#usp-headlines').val(usp.example_headlines);
                    $('#usp-short-headlines').val(usp.short_headlines);
                    $('#usp-best-headline').val(usp.best_for_headline);
                    $('#usp-best-description').val(usp.best_for_description);
                    $('#usp-placeholders').val(usp.placeholders_used);
                    
                    // Set industry checkboxes
                    $('input[name="ideal_for_industries"]').prop('checked', false);
                    usp.ideal_for_industries.forEach(function(industryId) {
                        $(`input[name="ideal_for_industries"][value="${industryId}"]`).prop('checked', true);
                    });
                    
                    // Store edit mode
                    $('#usp-form').data('edit-id', uspId);
                    
                    openModal('usp-modal');
                } else {
                    alert('Fejl ved indl√¶sning af USP: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved indl√¶sning af USP');
            }
        });
    });
    
    $(document).on('click', '.edit-category-btn', function() {
        const categoryId = $(this).data('category-id');
        
        // Load category data
        $.ajax({
            url: `/usps/ajax/get-category/${categoryId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const category = response.category;
                    
                    // Populate form
                    $('#category-modal-title').text('Rediger Kategori');
                    $('#category-name').val(category.name);
                    $('#category-description').val(category.description);
                    $('#category-icon').val(category.icon);
                    $('#category-color').val(category.color);
                    $('#category-sort-order').val(category.sort_order);
                    $('#category-max-selections').val(category.max_selections);
                    $('#category-recommended').prop('checked', category.is_recommended_per_campaign);
                    
                    // Store edit mode
                    $('#category-form').data('edit-id', categoryId);
                    
                    openModal('category-modal');
                } else {
                    alert('Fejl ved indl√¶sning af kategori: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved indl√¶sning af kategori');
            }
        });
    });
    
    $(document).on('click', '.add-usp-to-category-btn', function() {
        const categoryId = $(this).data('category-id');
        $('#usp-modal-title').text('Ny USP');
        $('#usp-form')[0].reset();
        $('#usp-main-category').val(categoryId);
        $('input[name="ideal_for_industries"]').prop('checked', false);
        $('#usp-form').removeData('edit-id'); // Clear edit mode
        openModal('usp-modal');
    });
    
    $(document).on('click', '.toggle-details', function() {
        const uspId = $(this).data('usp-id');
        const details = $(`.usp-details[data-usp-id="${uspId}"]`);
        const icon = $(this).find('.toggle-icon');
        
        if (details.hasClass('hidden')) {
            details.removeClass('hidden').slideDown(200);
            icon.addClass('rotate-180');
        } else {
            details.slideUp(200, function() {
                details.addClass('hidden');
            });
            icon.removeClass('rotate-180');
        }
    });
    
    console.log('üìã USP Manager initialized');
});
</script>
{% endblock %}