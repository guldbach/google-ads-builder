{% extends 'base.html' %}

{% block title %}USP Manager - Administrer Alle USPs{% endblock %}

{% block content %}
<style>
    .usp-headline-field {
        transition: all 0.3s ease-in-out;
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="max-w-7xl mx-auto section-spacing container-padding">
    <!-- Hero Section -->
    <div class="text-center mb-12 p-12 bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 rounded-3xl">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl mb-6 shadow-2xl">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
        </div>
        <h1 class="text-5xl font-bold text-gray-900 mb-4">
            USP Manager
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            Administrer alle USP kategorier og templates p√• √©n intuitiv side
        </p>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-gray-100">
        <div class="flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-lg font-semibold text-gray-900">Hurtige Handlinger</h2>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="add-category-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    ‚ûï Ny Kategori
                </button>
                <button id="add-usp-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                    ‚≠ê Ny USP
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Overview -->
    <div id="categories-container" class="space-y-8">
        {% for category in usp_categories %}
        <div class="category-section bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8" 
             data-category-id="{{ category.id }}">
            <!-- Category Header -->
            <div class="category-header p-6" style="background: linear-gradient(135deg, {{ category.color }}20, {{ category.color }}10);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center justify-center w-12 h-12 rounded-xl" 
                             style="background-color: {{ category.color }}; color: white;">
                            <span class="text-2xl">{{ category.icon }}</span>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">{{ category.name }}</h3>
                            <p class="text-gray-600">{{ category.description }}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-sm text-gray-500">
                                    Sort: {{ category.sort_order }} | Max: {{ category.max_selections }} | 
                                    USPs: {{ category.usptemplate_set.count }}
                                </span>
                                {% if category.is_recommended_per_campaign %}
                                <span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    Anbefalet per kampagne
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-category-btn text-gray-500 hover:text-blue-600 p-2" 
                                data-category-id="{{ category.id }}" title="Rediger kategori">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="add-usp-to-category-btn text-green-600 hover:text-green-700 p-2" 
                                data-category-id="{{ category.id }}" title="Tilf√∏j USP til kategori">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>
                        <button class="delete-category-btn text-gray-500 hover:text-red-600 p-2" 
                                data-category-id="{{ category.id }}" title="Slet kategori">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- USPs List -->
            <div class="usps-list p-6">
                <div class="space-y-3">
                    {% for usp in category.usptemplate_set.all %}
                    <div class="usp-item bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-all duration-200 border border-gray-200"
                         data-usp-id="{{ usp.id }}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="inline-flex items-center justify-center w-8 h-8 text-sm font-bold text-white rounded-full"
                                          style="background-color: {{ category.color }};">
                                        {{ usp.priority_rank }}
                                    </span>
                                    <h4 class="text-lg font-semibold text-gray-900 cursor-pointer toggle-details" data-usp-id="{{ usp.id }}">
                                        {{ usp.text }}
                                        <svg class="w-4 h-4 inline-block ml-2 text-gray-400 toggle-icon transition-transform" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                        </svg>
                                    </h4>
                                    <span class="text-sm text-gray-500">Score: {{ usp.effectiveness_score|floatformat:1 }}</span>
                                </div>
                                
                                <div class="usp-details hidden mt-3 space-y-2" data-usp-id="{{ usp.id }}">
                                    {% if usp.explanation %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Forklaring:</span>
                                        <p class="text-sm text-gray-600 mt-1">{{ usp.explanation }}</p>
                                    </div>
                                    {% endif %}


                                    {% if usp.ideal_for_industries.all %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Brancher:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for industry in usp.ideal_for_industries.all %}
                                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">
                                                üè¢ {{ industry.name }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if usp.example_headlines %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Eksempel headlines:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for headline in usp.example_headlines %}
                                            <span class="inline-block px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                {{ headline }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if usp.placeholders_used %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-700">Placeholders:</span>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for placeholder in usp.placeholders_used %}
                                            <span class="inline-block px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">
                                                {{ placeholder }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="edit-usp-btn text-gray-500 hover:text-blue-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Rediger USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <button class="duplicate-usp-btn text-gray-500 hover:text-green-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Duplik√©r USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                    </svg>
                                </button>
                                <button class="delete-usp-btn text-gray-500 hover:text-red-600 p-2" 
                                        data-usp-id="{{ usp.id }}" title="Slet USP">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <p>Ingen USPs i denne kategori endnu.</p>
                        <button class="mt-2 text-blue-600 hover:text-blue-700 font-medium add-usp-to-category-btn" 
                                data-category-id="{{ category.id }}">
                            Tilf√∏j f√∏rste USP
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Ingen USP kategorier endnu</h3>
            <p class="text-gray-600 mb-6">Kom i gang ved at oprette din f√∏rste kategori</p>
            <button id="create-first-category" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-200">
                ‚ûï Opret F√∏rste Kategori
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Slide-In Panel System -->
<div id="slide-panel-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 transition-opacity duration-300">
    <div id="slide-panel" class="fixed right-0 top-0 h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto" style="width: 1000px;">
        <!-- Panel Header -->
        <div id="slide-panel-header" class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
            <div class="flex items-center justify-between">
                <div>
                    <h3 id="slide-panel-title" class="text-xl font-semibold text-gray-900">Panel Title</h3>
                    <p id="slide-panel-subtitle" class="text-sm text-gray-600 mt-1">Panel subtitle</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="slide-panel-save" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Gem
                    </button>
                    <button id="slide-panel-close" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Panel Content -->
        <div id="slide-panel-content" class="px-6 py-4">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// CSRF Token Setup for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Configure AJAX to always send CSRF token
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

$(document).ready(function() {
    // Notification System
    function showNotification(message, type = 'success') {
        const notification = $(`
            <div class="fixed top-4 right-4 z-[60] max-w-sm w-full bg-white rounded-lg shadow-lg border-l-4 ${type === 'success' ? 'border-green-500' : 'border-red-500'} transform translate-x-full transition-transform duration-300 ease-in-out">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            ${type === 'success' ? 
                                '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' : 
                                '<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                            }
                        </div>
                        <div class="ml-3 w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                        </div>
                        <button class="ml-4 text-gray-400 hover:text-gray-600" onclick="$(this).closest('[class*=fixed]').remove()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `);
        
        $('body').append(notification);
        
        // Show notification with animation
        setTimeout(() => {
            notification.removeClass('translate-x-full');
        }, 10);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            notification.addClass('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    function showSuccessNotification(message) {
        showNotification(message, 'success');
    }
    
    function showErrorNotification(message) {
        showNotification(message, 'error');
    }

    // Slide-In Panel Management
    let currentPanelType = null;
    let currentPanelData = null;
    
    function openSlidePanel(title, subtitle, content, saveCallback) {
        $('#slide-panel-title').text(title);
        $('#slide-panel-subtitle').text(subtitle || '');
        $('#slide-panel-content').html(content);
        
        // Store save callback
        $('#slide-panel-save').off('click').on('click', saveCallback);
        
        // Show panel with animation
        $('#slide-panel-overlay').removeClass('hidden');
        setTimeout(() => {
            $('#slide-panel-overlay').removeClass('opacity-0');
            $('#slide-panel').removeClass('translate-x-full');
        }, 10);
        
        // Focus management
        setTimeout(() => {
            $('#slide-panel-content input:first').focus();
            // Trigger custom event for initialization
            $(document).trigger('slideInOpened');
        }, 300);
    }
    
    function closeSlidePanel() {
        $('#slide-panel').addClass('translate-x-full');
        $('#slide-panel-overlay').addClass('opacity-0');
        
        setTimeout(() => {
            $('#slide-panel-overlay').addClass('hidden');
            $('#slide-panel-content').html('');
            currentPanelType = null;
            currentPanelData = null;
            // Trigger custom event for cleanup
            $(document).trigger('slideInClosed');
        }, 300);
    }
    
    // Panel event handlers
    $('#slide-panel-close').click(closeSlidePanel);
    $('#slide-panel-overlay').click(function(e) {
        if (e.target === this) {
            closeSlidePanel();
        }
    });
    
    // Keyboard shortcuts
    $(document).keydown(function(e) {
        if (e.key === 'Escape' && !$('#slide-panel-overlay').hasClass('hidden')) {
            closeSlidePanel();
        }
    });
    
    // Modal management (keep existing for backwards compatibility)
    function openModal(modalId) {
        $(`#${modalId}`).removeClass('hidden');
    }
    
    function closeModal(modalId) {
        $(`#${modalId}`).addClass('hidden');
        $(`#${modalId} form`)[0].reset();
    }
    
    // Category Slide-in Events
    $('#add-category-btn, #create-first-category').click(function() {
        openCreateCategorySlidePanel();
    });
    
    
    // USP Creation Events  
    $('#add-usp-btn').click(function() {
        openCreateUSPSlidePanel();
    });
    
    
    $('.add-usp-to-category-btn').click(function() {
        const categoryId = $(this).data('category-id');
        openCreateUSPSlidePanel(categoryId);
    });
    
    
    
    
    
    
    // Use event delegation for dynamically added elements
    $(document).on('click', '.duplicate-usp-btn', function(e) {
        e.preventDefault();
        const uspId = $(this).data('usp-id');
        
        $.ajax({
            url: `/usps/ajax/duplicate-usp/${uspId}/`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showSuccessNotification('USP duplikeret succesfuldt!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Fejl: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved duplikering af USPen');
            }
        });
    });
    
    // Delete USP with confirmation
    $(document).on('click', '.delete-usp-btn', function(e) {
        e.preventDefault();
        const uspId = $(this).data('usp-id');
        const uspText = $(this).closest('.usp-item').find('h4').text().trim();
        
        if (confirm(`Er du sikker p√• at du vil slette USP: "${uspText}"?`)) {
            $.ajax({
                url: `/usps/ajax/delete-usp/${uspId}/`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showSuccessNotification('USP slettet succesfuldt!');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showErrorNotification('Fejl: ' + response.error);
                    }
                },
                error: function() {
                    showErrorNotification('Der opstod en fejl ved sletning af USPen');
                }
            });
        }
    });
    
    // USP Create Slide-In Panel (identical to edit, but empty)
    function generateUSPCreateContent(categoryId = null) {
        // Create empty USP object with exact structure expected by generateUSPEditContent
        const emptyUSP = {
            id: '',
            text: '',
            priority_rank: 1,
            effectiveness_score: 0.5,
            explanation: '',
            example_headlines: '',  // Empty string, not array
            ideal_for_industries: []
        };
        
        // Generate the exact same content as edit, just with empty values
        return generateUSPEditContent(emptyUSP);
    }
    
    // Open Create USP Slide-In Panel
    function openCreateUSPSlidePanel(categoryId = null) {
        const content = generateUSPCreateContent(categoryId);
        
        openSlidePanel(
            'Ny USP',
            categoryId ? `Tilf√∏j til kategori` : 'Opret ny USP',
            content,
            saveNewUSP
        );
        
        // Set category if provided
        if (categoryId) {
            currentPanelData = { categoryId: categoryId };
        }
        
        // Setup character counter (using same ID as edit)
        $('#edit-usp-text').on('input', function() {
            $('#edit-usp-text-count').text(this.value.length);
        });
        
        // Load and setup industries (reuse existing function)
        loadIndustriesForUSP([]);
    }
    
    // Save New USP Function
    function saveNewUSP() {
        // Collect selected industries (reuse existing logic from edit)
        const formData = {
            text: $('#edit-usp-text').val(),
            main_category: currentPanelData?.categoryId || null,
            priority_rank: parseInt($('#edit-usp-priority').val()),
            effectiveness_score: parseFloat($('#edit-usp-score').val()),
            explanation: $('#edit-usp-explanation').val(),
            example_headlines: $('#edit-usp-example-headlines').val(),
            ideal_for_industries: selectedIndustries
        };
        
        $.ajax({
            url: '{% url "usps:create_usp_ajax" %}',
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showSuccessNotification('Ny USP oprettet succesfuldt!');
                    closeSlidePanel();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Fejl: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved oprettelse af USP');
            }
        });
    }

    // USP Edit Slide-In Panel
    function generateUSPEditContent(usp) {
        return `
            <div class="space-y-6">
                <!-- USP Basic Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">USP Tekst</label>
                        <input type="text" id="edit-usp-text" value="${usp.text}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               maxlength="200">
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="edit-usp-text-count">${usp.text.length}</span>/200 karakterer
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioritet</label>
                            <input type="number" id="edit-usp-priority" value="${usp.priority_rank}" min="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Score</label>
                            <input type="number" id="edit-usp-score" value="${usp.effectiveness_score}" min="0" max="1" step="0.1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Forklaring</label>
                        <textarea id="edit-usp-explanation" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Hvorn√•r skal denne USP bruges...">${usp.explanation}</textarea>
                    </div>
                    
                </div>
                
                <!-- Eksempel Headlines Section -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-900">üí° Eksempel Headlines</h4>
                        <button type="button" id="add-headline-btn" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg transition-colors">
                            + Ny Headline
                        </button>
                    </div>
                    
                    <!-- Headlines List -->
                    <div class="space-y-3">
                        <div id="headlines-container" class="space-y-2">
                            <!-- Headlines will be populated here -->
                        </div>
                        
                        <!-- Add New Headline Form (Hidden by default) -->
                        <div id="add-headline-form" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <input type="text" id="new-headline-text" placeholder="F.eks. Ring nu - f√• pris" maxlength="30"
                                       class="flex-1 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                <button type="button" id="save-new-headline" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">
                                    Gem
                                </button>
                                <button type="button" id="cancel-new-headline" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                                    Annuller
                                </button>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">Maks 30 karakterer (Google Ads krav) - kan indeholde placeholders som {SERVICE}, {BYNAVN}</div>
                        </div>
                        
                        <!-- Hidden field for form submission -->
                        <input type="hidden" id="edit-usp-example-headlines" value="${usp.example_headlines}">
                        
                        <div class="text-xs text-gray-500">Headlines der kan bruges som inspiration til kampagner</div>
                    </div>
                </div>
                <!-- Brancher Section -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-900">üè¢ Brancher & Industrier</h4>
                        <button type="button" id="add-industry-btn" class="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-lg transition-colors">
                            + Ny Branche
                        </button>
                    </div>
                    
                    <!-- Industry Search & Selection -->
                    <div class="space-y-3">
                        <div>
                            <input type="text" id="industry-search" placeholder="S√∏g brancher..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        </div>
                        
                        <div id="industries-container" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 space-y-2">
                            <!-- Industries will be populated here -->
                        </div>
                        
                        <!-- Add New Industry Form (Hidden by default) -->
                        <div id="add-industry-form" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <input type="text" id="new-industry-name" placeholder="Navn p√• ny branche..." 
                                       class="flex-1 px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                                <button type="button" id="save-new-industry" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">
                                    Gem
                                </button>
                                <button type="button" id="cancel-new-industry" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">
                                    Annuller
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500">V√¶lg hvilke brancher denne USP passer bedst til</div>
                    </div>
                </div>
                
                <!-- Placeholder Reference -->
                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">üîó Tilg√¶ngelige Placeholders</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-3">Brug disse placeholders i dine USP tekster og headlines:</p>
                            
                            <!-- Available Placeholders -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{SERVICE}">
                                    {SERVICE}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{BYNAVN}">
                                    {BYNAVN}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{PRIS}">
                                    {PRIS}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{OMR√ÖDE}">
                                    {OMR√ÖDE}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{BED√òMMELSE}">
                                    {BED√òMMELSE}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{BED√òMMELSESPLATFORM}">
                                    {BED√òMMELSESPLATFORM}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{VIRKSOMHED}">
                                    {VIRKSOMHED}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{TELEFON}">
                                    {TELEFON}
                                </button>
                                <button type="button" class="copy-placeholder text-xs px-3 py-2 bg-gray-100 hover:bg-purple-100 text-gray-600 hover:text-purple-600 rounded-lg border transition-colors" data-placeholder="{√ÖBNINGSTID}">
                                    {√ÖBNINGSTID}
                                </button>
                            </div>
                            
                            <div class="text-xs text-gray-500 mt-3">
                                üí° Tip: Klik p√• en placeholder for at kopiere den til udklipsholder
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Edit USP Button Handler
    $(document).on('click', '.edit-usp-btn', function() {
        const uspId = $(this).data('usp-id');
        
        // Load USP data
        $.ajax({
            url: `/usps/ajax/get-usp/${uspId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const usp = response.usp;
                    currentPanelType = 'edit-usp';
                    currentPanelData = { uspId: uspId, usp: usp };
                    
                    const content = generateUSPEditContent(usp);
                    
                    openSlidePanel(
                        'Rediger USP',
                        `Prioritet ${usp.priority_rank} ‚Ä¢ ID: ${usp.id}`,
                        content,
                        saveUSPEdit
                    );
                    
                    // Setup character counters
                    $('#edit-usp-text').on('input', function() {
                        $('#edit-usp-text-count').text(this.value.length);
                    });
                    
                    
                    
                    // Load and setup industries
                    loadIndustriesForUSP(usp.ideal_for_industries);
                    
                } else {
                    alert('Fejl ved indl√¶sning af USP: ' + response.error);
                }
            },
            error: function() {
                alert('Der opstod en fejl ved indl√¶sning af USP');
            }
        });
    });
    
    // Save USP Edit Function
    function saveUSPEdit() {
        const uspId = currentPanelData.uspId;
        
        const formData = {
            text: $('#edit-usp-text').val(),
            priority_rank: parseInt($('#edit-usp-priority').val()),
            effectiveness_score: parseFloat($('#edit-usp-score').val()),
            explanation: $('#edit-usp-explanation').val(),
            example_headlines: $('#edit-usp-example-headlines').val(),
            ideal_for_industries: selectedIndustries
        };
        
        $.ajax({
            url: `/usps/ajax/edit-usp/${uspId}/`,
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showSuccessNotification('USP √¶ndringer gemt succesfuldt!');
                    closeSlidePanel();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Fejl: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved gem af USP');
            }
        });
    }
    
    // Industries Management
    let allIndustries = [];
    let selectedIndustries = [];
    
    function loadIndustriesForUSP(selectedIds = []) {
        // Fetch all industries from backend
        $.ajax({
            url: '{% url "usps:get_industries_ajax" %}',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    allIndustries = response.industries;
                    // Ensure selectedIds are integers for proper comparison
                    selectedIndustries = (selectedIds || []).map(id => parseInt(id));
                    renderIndustriesContainer();
                    setupIndustrySearch();
                    setupIndustryActions();
                } else {
                    console.error('Failed to load industries');
                }
            },
            error: function() {
                console.error('Error loading industries');
            }
        });
    }
    
    function renderIndustriesContainer(filterText = '') {
        const container = $('#industries-container');
        const filteredIndustries = allIndustries.filter(industry => 
            industry.name.toLowerCase().includes(filterText.toLowerCase())
        );
        
        let html = '';
        
        filteredIndustries.forEach(industry => {
            const isSelected = selectedIndustries.includes(industry.id);
            const bgClass = isSelected ? 'bg-purple-100 border-purple-300' : 'bg-white border-gray-200';
            const textClass = isSelected ? 'text-purple-700' : 'text-gray-700';
            
            html += `
                <div class="industry-item ${bgClass} border rounded-lg p-2 cursor-pointer hover:bg-gray-50 transition-colors"
                     data-industry-id="${industry.id}">
                    <div class="flex items-center justify-between">
                        <span class="${textClass} text-sm">${industry.name}</span>
                        ${isSelected ? '<span class="text-purple-600">‚úì</span>' : ''}
                    </div>
                </div>
            `;
        });
        
        if (html === '') {
            html = '<div class="text-sm text-gray-500 text-center py-4">Ingen brancher fundet</div>';
        }
        
        container.html(html);
    }
    
    function setupIndustrySearch() {
        $('#industry-search').off('input').on('input', function() {
            const searchText = $(this).val();
            renderIndustriesContainer(searchText);
        });
    }
    
    function setupIndustryActions() {
        // Industry selection
        $(document).off('click', '.industry-item').on('click', '.industry-item', function() {
            const industryId = parseInt($(this).data('industry-id'));
            
            if (selectedIndustries.includes(industryId)) {
                selectedIndustries = selectedIndustries.filter(id => id !== industryId);
            } else {
                selectedIndustries.push(industryId);
            }
            
            renderIndustriesContainer($('#industry-search').val());
        });
        
        // Add new industry
        $('#add-industry-btn').off('click').on('click', function() {
            $('#add-industry-form').removeClass('hidden');
            $('#new-industry-name').focus();
        });
        
        $('#cancel-new-industry').off('click').on('click', function() {
            $('#add-industry-form').addClass('hidden');
            $('#new-industry-name').val('');
        });
        
        $('#save-new-industry').off('click').on('click', function() {
            const industryName = $('#new-industry-name').val().trim();
            
            if (!industryName) {
                alert('Indtast navn p√• branche');
                return;
            }
            
            // Create new industry via AJAX
            $.ajax({
                url: '{% url "usps:create_industry_ajax" %}', // We'll need to create this endpoint
                method: 'POST',
                data: JSON.stringify({ name: industryName }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        // Add to local industries list
                        allIndustries.push(response.industry);
                        selectedIndustries.push(response.industry.id);
                        
                        // Re-render and hide form
                        renderIndustriesContainer();
                        $('#add-industry-form').addClass('hidden');
                        $('#new-industry-name').val('');
                        
                        console.log(`Created new industry: ${response.industry.name}`);
                    } else {
                        alert('Fejl ved oprettelse: ' + response.error);
                    }
                },
                error: function() {
                    alert('Der opstod en fejl ved oprettelse af branche');
                }
            });
        });
    }
    
    $(document).on('click', '.edit-category-btn', function() {
        const categoryId = $(this).data('category-id');
        openEditCategorySlidePanel(categoryId);
    });
    
    // Delete Category with confirmation
    $(document).on('click', '.delete-category-btn', function(e) {
        e.preventDefault();
        const categoryId = $(this).data('category-id');
        const categoryName = $(this).closest('.category-section').find('h3').text().trim();
        
        if (confirm(`Er du sikker p√• at du vil slette kategorien "${categoryName}"?\n\nAlle USPs i denne kategori vil ogs√• blive slettet.`)) {
            $.ajax({
                url: `/usps/ajax/delete-category/${categoryId}/`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showSuccessNotification('Kategori slettet succesfuldt!');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showErrorNotification('Fejl: ' + response.error);
                    }
                },
                error: function() {
                    showErrorNotification('Der opstod en fejl ved sletning af kategorien');
                }
            });
        }
    });
    
    $(document).on('click', '.add-usp-to-category-btn', function() {
        const categoryId = $(this).data('category-id');
        openCreateUSPSlidePanel(categoryId);
    });
    
    $(document).on('click', '.toggle-details', function() {
        const uspId = $(this).data('usp-id');
        const details = $(`.usp-details[data-usp-id="${uspId}"]`);
        const icon = $(this).find('.toggle-icon');
        
        if (details.hasClass('hidden')) {
            details.removeClass('hidden').slideDown(200);
            icon.addClass('rotate-180');
        } else {
            details.slideUp(200, function() {
                details.addClass('hidden');
            });
            icon.removeClass('rotate-180');
        }
    });
    
    // ===== CATEGORY SLIDE-IN SYSTEM =====
    
    // Generate Category Create/Edit Content
    function generateCategoryContent(category = null) {
        const isEdit = category !== null;
        const categoryData = category || {
            name: '',
            description: '',
            icon: '‚ö°',
            color: '#8B5CF6'
        };
        
        return `
            <div class="space-y-6">
                <!-- Basic Category Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Navn</label>
                        <input type="text" id="edit-category-name" value="${categoryData.name}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="F.eks. Hurtig Service" maxlength="100" required>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="edit-category-name-count">${categoryData.name.length}</span>/100 karakterer
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beskrivelse</label>
                        <textarea id="edit-category-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Beskrivelse af hvad denne kategori indeholder..." maxlength="200">${categoryData.description}</textarea>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="edit-category-description-count">${categoryData.description.length}</span>/200 karakterer
                        </div>
                    </div>
                </div>
                
                <!-- Visual Settings -->
                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">üé® Visuelle Indstillinger</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Ikon</label>
                            <input type="text" id="edit-category-icon" value="${categoryData.icon}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center text-2xl"
                                   placeholder="‚ö°" maxlength="2">
                            <div class="text-xs text-gray-500 mt-1">Emoji eller kort symbol</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Farve</label>
                            <input type="color" id="edit-category-color" value="${categoryData.color}"
                                   class="w-full h-10 border border-gray-300 rounded-lg cursor-pointer">
                            <div class="text-xs text-gray-500 mt-1">V√¶lg en farve for kategorien</div>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm font-medium text-gray-700 mb-2">Preview:</div>
                        <div class="flex items-center space-x-3" id="category-preview">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white text-lg" 
                                 style="background-color: ${categoryData.color};" id="preview-icon-container">
                                <span id="preview-icon">${categoryData.icon}</span>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900" id="preview-name">${categoryData.name || 'Kategori Navn'}</div>
                                <div class="text-gray-600 text-sm" id="preview-description">${categoryData.description || 'Kategori beskrivelse'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Open Create Category Slide-In Panel
    function openCreateCategorySlidePanel() {
        const content = generateCategoryContent();
        
        openSlidePanel(
            'Ny Kategori',
            'Opret ny USP kategori',
            content,
            saveNewCategory
        );
        
        setupCategoryFormHandlers();
    }
    
    // Open Edit Category Slide-In Panel
    function openEditCategorySlidePanel(categoryId) {
        // Fetch category data first
        $.ajax({
            url: `/usps/ajax/get-category/${categoryId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const category = response.category;
                    currentPanelData = { categoryId: categoryId, category: category };
                    
                    const content = generateCategoryContent(category);
                    
                    openSlidePanel(
                        'Rediger Kategori',
                        `${category.name}`,
                        content,
                        saveCategoryEdit
                    );
                    
                    setupCategoryFormHandlers();
                } else {
                    showErrorNotification('Fejl ved indl√¶sning af kategori: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved indl√¶sning af kategorien');
            }
        });
    }
    
    // Setup Category Form Handlers
    function setupCategoryFormHandlers() {
        // Character counters
        $('#edit-category-name').on('input', function() {
            const count = this.value.length;
            $('#edit-category-name-count').text(count);
            $('#preview-name').text(this.value || 'Kategori Navn');
        });
        
        $('#edit-category-description').on('input', function() {
            const count = this.value.length;
            $('#edit-category-description-count').text(count);
            $('#preview-description').text(this.value || 'Kategori beskrivelse');
        });
        
        // Icon preview
        $('#edit-category-icon').on('input', function() {
            $('#preview-icon').text(this.value || '‚ö°');
        });
        
        // Color preview
        $('#edit-category-color').on('input', function() {
            $('#preview-icon-container').css('background-color', this.value);
        });
    }
    
    // Save New Category
    function saveNewCategory() {
        const formData = {
            name: $('#edit-category-name').val(),
            description: $('#edit-category-description').val(),
            icon: $('#edit-category-icon').val() || '‚ö°',
            color: $('#edit-category-color').val(),
            sort_order: 1,
            max_selections: 1,
            is_recommended_per_campaign: true
        };
        
        $.ajax({
            url: '{% url "usps:create_category_ajax" %}',
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showSuccessNotification('Ny kategori oprettet succesfuldt!');
                    closeSlidePanel();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Fejl: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved oprettelse af kategorien');
            }
        });
    }
    
    // Save Category Edit
    function saveCategoryEdit() {
        const categoryId = currentPanelData.categoryId;
        
        const formData = {
            name: $('#edit-category-name').val(),
            description: $('#edit-category-description').val(),
            icon: $('#edit-category-icon').val() || '‚ö°',
            color: $('#edit-category-color').val(),
            sort_order: currentPanelData.category.sort_order,
            max_selections: currentPanelData.category.max_selections,
            is_recommended_per_campaign: currentPanelData.category.is_recommended_per_campaign
        };
        
        $.ajax({
            url: `/usps/ajax/edit-category/${categoryId}/`,
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showSuccessNotification('Kategori opdateret succesfuldt!');
                    closeSlidePanel();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showErrorNotification('Fejl: ' + response.error);
                }
            },
            error: function() {
                showErrorNotification('Der opstod en fejl ved redigering af kategorien');
            }
        });
    }
    
    // ===== PLACEHOLDER COPY SYSTEM =====
    
    // Handle placeholder copy to clipboard
    $(document).on('click', '.copy-placeholder', function() {
        const placeholder = $(this).data('placeholder');
        
        // Copy to clipboard
        navigator.clipboard.writeText(placeholder).then(() => {
            // Visual feedback
            const button = $(this);
            const originalText = button.text();
            button.text('Kopieret!');
            button.addClass('bg-green-200 text-green-800');
            
            setTimeout(() => {
                button.text(originalText);
                button.removeClass('bg-green-200 text-green-800');
            }, 1000);
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = placeholder;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Visual feedback
            const button = $(this);
            const originalText = button.text();
            button.text('Kopieret!');
            button.addClass('bg-green-200 text-green-800');
            
            setTimeout(() => {
                button.text(originalText);
                button.removeClass('bg-green-200 text-green-800');
            }, 1000);
        });
    });
    
    // ===== PLACEHOLDER TAG INPUT SYSTEM =====
    
    let placeholderTags = [];
    let editPlaceholderTags = [];
    
    // Initialize placeholder tag systems
    function initPlaceholderTagInput(containerId, tagsContainerId, inputId, hiddenInputId, commonButtonClass, tagsArray) {
        const container = $(containerId);
        const tagsContainer = $(tagsContainerId);
        const input = $(inputId);
        const hiddenInput = $(hiddenInputId);
        
        // Render tags
        function renderTags() {
            tagsContainer.empty();
            tagsArray.forEach((tag, index) => {
                const tagElement = $(`
                    <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 text-sm rounded-full border border-purple-200">
                        <span class="font-medium">${tag}</span>
                        <button type="button" class="ml-2 text-purple-600 hover:text-purple-800" data-index="${index}">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </span>
                `);
                tagsContainer.append(tagElement);
            });
            
            // Update hidden input
            hiddenInput.val(tagsArray.join(', '));
        }
        
        // Add tag
        function addTag(tag) {
            tag = tag.trim();
            if (!tag) return;
            
            // Auto-format placeholder if it doesn't start with {
            if (!tag.startsWith('{') && !tag.endsWith('}')) {
                tag = `{${tag.toUpperCase()}}`;
            } else if (!tag.startsWith('{')) {
                tag = `{${tag}}`;
            } else if (!tag.endsWith('}')) {
                tag = `${tag}}`;
            }
            
            // Check for duplicates
            if (!tagsArray.includes(tag)) {
                tagsArray.push(tag);
                renderTags();
                input.val('');
            }
        }
        
        // Remove tag
        function removeTag(index) {
            tagsArray.splice(index, 1);
            renderTags();
        }
        
        // Event handlers
        input.on('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',' || e.key === 'Tab') {
                e.preventDefault();
                addTag(input.val());
            } else if (e.key === 'Backspace' && input.val() === '' && tagsArray.length > 0) {
                removeTag(tagsArray.length - 1);
            }
        });
        
        input.on('blur', function() {
            if (input.val().trim()) {
                addTag(input.val());
            }
        });
        
        // Remove tag button handler
        tagsContainer.on('click', 'button', function(e) {
            e.preventDefault();
            const index = parseInt($(this).data('index'));
            removeTag(index);
        });
        
        // Common placeholder buttons
        $(document).on('click', commonButtonClass, function(e) {
            e.preventDefault();
            const placeholder = $(this).data('placeholder');
            addTag(placeholder);
        });
        
        // Initialize from existing value
        const existingValue = hiddenInput.val();
        if (existingValue) {
            const existingTags = existingValue.split(',').map(tag => tag.trim()).filter(tag => tag);
            tagsArray.splice(0, tagsArray.length, ...existingTags);
            renderTags();
        }
        
        // Return public methods
        return {
            addTag: addTag,
            removeTag: removeTag,
            renderTags: renderTags,
            getTags: () => tagsArray,
            setTags: (newTags) => {
                tagsArray.splice(0, tagsArray.length, ...newTags);
                renderTags();
            }
        };
    }
    
    // Initialize placeholder systems when needed
    let mainPlaceholderSystem = null;
    let editPlaceholderSystem = null;
    
    // Initialize main form placeholder system
    $(document).on('focus', '#placeholder-input', function() {
        if (!mainPlaceholderSystem) {
            mainPlaceholderSystem = initPlaceholderTagInput(
                '#placeholders-container',
                '#placeholders-tags',
                '#placeholder-input', 
                '#usp-placeholders',
                '.common-placeholder',
                placeholderTags
            );
        }
    });
    
    // Initialize edit form placeholder system when slide panel opens
    $(document).on('slideInOpened', function() {
        // Wait a bit for DOM to be ready
        setTimeout(() => {
            if ($('#edit-placeholder-input').length && !editPlaceholderSystem) {
                editPlaceholderTags = [];
                editPlaceholderSystem = initPlaceholderTagInput(
                    '#edit-placeholders-container',
                    '#edit-placeholders-tags', 
                    '#edit-placeholder-input',
                    '#edit-usp-placeholders',
                    '.edit-common-placeholder',
                    editPlaceholderTags
                );
                
                // Load existing placeholders for edit
                const existingPlaceholders = $('#edit-usp-placeholders').val();
                if (existingPlaceholders) {
                    const tags = existingPlaceholders.split(',').map(tag => tag.trim()).filter(tag => tag);
                    editPlaceholderSystem.setTags(tags);
                }
            }
        }, 100);
    });
    
    // Reset systems when panels close
    $(document).on('slideInClosed', function() {
        editPlaceholderSystem = null;
        editPlaceholderTags = [];
    });
    
    // ===== USP HEADLINE AUTO-REVEAL SYSTEM =====
    
    let visibleUSPHeadlines = 1; // Start with headline 1 visible
    
    function setupUSPHeadlineAutoReveal() {
        console.log('üéØ Setting up auto-reveal for USP headlines');
        
        // Setup input event listeners for all USP headlines 1-10
        for (let i = 1; i <= 10; i++) {
            const input = document.getElementById(`usp_headline_${i}`);
            if (input) {
                input.addEventListener('input', function() {
                    revealNextUSPHeadline(i);
                    updateUSPHeadlineProgress();
                    updateUSPCharacterCount(`usp_headline_${i}`, `usp_headline_${i}_count`, 30);
                    updateUSPHeadlinesHiddenField();
                });
            }
        }
        updateUSPHeadlineProgress();
    }
    
    function revealNextUSPHeadline(currentIndex) {
        // If user is typing in current visible headline and there are more to reveal
        const input = document.getElementById(`usp_headline_${currentIndex}`);
        if (input && input.value.length > 0 && currentIndex >= visibleUSPHeadlines && visibleUSPHeadlines < 10) {
            const nextIndex = visibleUSPHeadlines + 1;
            const nextContainer = document.getElementById(`usp_headline_${nextIndex}_container`);
            
            if (nextContainer) {
                console.log(`üéØ Auto-revealing USP headline ${nextIndex}`);
                nextContainer.style.display = 'block';
                nextContainer.classList.add('animate-fade-in');
                visibleUSPHeadlines = nextIndex;
                
                // Setup character count for the newly revealed field
                const nextInput = document.getElementById(`usp_headline_${nextIndex}`);
                if (nextInput) {
                    updateUSPCharacterCount(`usp_headline_${nextIndex}`, `usp_headline_${nextIndex}_count`, 30);
                }
            }
        }
    }
    
    function updateUSPHeadlineProgress() {
        const progressElement = document.getElementById('usp-headlines-progress');
        if (progressElement) {
            // Count filled headlines
            let filledCount = 0;
            for (let i = 1; i <= visibleUSPHeadlines; i++) {
                const input = document.getElementById(`usp_headline_${i}`);
                if (input && input.value.trim().length > 0) {
                    filledCount++;
                }
            }
            progressElement.textContent = `${filledCount} af ${visibleUSPHeadlines} udfyldt (max 10)`;
        }
    }
    
    function updateUSPCharacterCount(inputId, countId, maxLength) {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(countId);
        
        if (input && counter) {
            const length = input.value.length;
            counter.textContent = `${length}/${maxLength}`;
            
            // Color coding
            if (length > maxLength) {
                counter.parentElement.classList.add('text-red-500');
                counter.parentElement.classList.remove('text-yellow-500', 'text-green-500');
            } else if (length > maxLength * 0.8) {
                counter.parentElement.classList.add('text-yellow-500');
                counter.parentElement.classList.remove('text-red-500', 'text-green-500');
            } else {
                counter.parentElement.classList.remove('text-red-500', 'text-yellow-500');
            }
        }
    }
    
    function updateUSPHeadlinesHiddenField() {
        // Collect all non-empty headline values
        const headlines = [];
        for (let i = 1; i <= 10; i++) {
            const input = document.getElementById(`usp_headline_${i}`);
            if (input && input.value.trim()) {
                headlines.push(input.value.trim());
            }
        }
        
        // Update hidden field for form submission
        const hiddenField = document.getElementById('edit-usp-short-headlines');
        if (hiddenField) {
            hiddenField.value = headlines.join(', ');
        }
    }
    
    function loadUSPHeadlinesFromString(headlinesString) {
        if (!headlinesString) return;
        
        // Reset system
        visibleUSPHeadlines = 1;
        for (let i = 2; i <= 10; i++) {
            const container = document.getElementById(`usp_headline_${i}_container`);
            if (container) {
                container.style.display = 'none';
                container.classList.remove('animate-fade-in');
            }
        }
        
        // Parse headlines and populate fields
        const headlines = headlinesString.split(',').map(h => h.trim()).filter(h => h);
        headlines.forEach((headline, index) => {
            const fieldIndex = index + 1;
            if (fieldIndex <= 10) {
                const input = document.getElementById(`usp_headline_${fieldIndex}`);
                if (input) {
                    input.value = headline;
                    updateUSPCharacterCount(`usp_headline_${fieldIndex}`, `usp_headline_${fieldIndex}_count`, 30);
                    
                    // Show container if needed
                    if (fieldIndex > 1) {
                        const container = document.getElementById(`usp_headline_${fieldIndex}_container`);
                        if (container) {
                            container.style.display = 'block';
                            visibleUSPHeadlines = Math.max(visibleUSPHeadlines, fieldIndex);
                        }
                    }
                }
            }
        });
        
        updateUSPHeadlineProgress();
    }
    
    // ===== HEADLINE MANAGEMENT SYSTEM =====
    
    let uspHeadlines = [];
    
    function setupHeadlineManagement() {
        
        // Initialize headlines array
        uspHeadlines = [];
        
        // Load existing headlines
        const existingHeadlines = $('#edit-usp-example-headlines').val();
        if (existingHeadlines) {
            const headlines = existingHeadlines.split(',').map(h => h.trim()).filter(h => h);
            uspHeadlines = headlines;
        }
        
        renderHeadlines();
        
        // Event handlers
        $('#add-headline-btn').off('click').on('click', function() {
            $('#add-headline-form').removeClass('hidden');
            $('#new-headline-text').focus();
        });
        
        $('#save-new-headline').off('click').on('click', function() {
            const headlineText = $('#new-headline-text').val().trim();
            if (headlineText && headlineText.length <= 30) {
                addHeadline(headlineText);
                $('#new-headline-text').val('');
                $('#add-headline-form').addClass('hidden');
            }
        });
        
        $('#cancel-new-headline').off('click').on('click', function() {
            $('#new-headline-text').val('');
            $('#add-headline-form').addClass('hidden');
        });
        
        // Enter key to save
        $('#new-headline-text').off('keydown').on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $('#save-new-headline').click();
            } else if (e.key === 'Escape') {
                $('#cancel-new-headline').click();
            }
        });
    }
    
    function addHeadline(text) {
        if (text && !uspHeadlines.includes(text)) {
            uspHeadlines.push(text);
            renderHeadlines();
            updateHeadlinesHiddenField();
        }
    }
    
    function removeHeadline(index) {
        if (index >= 0 && index < uspHeadlines.length) {
            uspHeadlines.splice(index, 1);
            renderHeadlines();
            updateHeadlinesHiddenField();
        }
    }
    
    function renderHeadlines() {
        const container = $('#headlines-container');
        container.empty();
        
        if (uspHeadlines.length === 0) {
            container.html('<div class="text-sm text-gray-500 italic p-3 border border-gray-200 rounded-lg">Ingen headlines endnu. Klik "+ Ny Headline" for at tilf√∏je.</div>');
            return;
        }
        
        uspHeadlines.forEach((headline, index) => {
            const headlineElement = $(`
                <div class="headline-item p-3 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors" data-index="${index}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="headline-display">
                                <span class="text-sm font-medium text-gray-900 headline-text">${headline}</span>
                                <div class="text-xs text-gray-500 mt-1">${headline.length}/30 karakterer</div>
                            </div>
                            <div class="headline-edit hidden">
                                <input type="text" class="edit-headline-input w-full px-2 py-1 border border-gray-300 rounded text-sm" value="${headline}" maxlength="30">
                                <div class="text-xs text-gray-500 mt-1">
                                    <span class="edit-char-count">${headline.length}</span>/30 karakterer
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 ml-3">
                            <div class="headline-display">
                                <button type="button" class="edit-headline-btn text-blue-600 hover:text-blue-800 p-1" data-index="${index}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </button>
                                <button type="button" class="remove-headline-btn text-red-600 hover:text-red-800 p-1" data-index="${index}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="headline-edit hidden">
                                <button type="button" class="save-headline-edit-btn text-green-600 hover:text-green-800 p-1" data-index="${index}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                <button type="button" class="cancel-headline-edit-btn text-gray-600 hover:text-gray-800 p-1" data-index="${index}">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            container.append(headlineElement);
        });
        
        // Add event handlers for buttons
        $('.remove-headline-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const index = parseInt($(this).data('index'));
            removeHeadline(index);
        });
        
        $('.edit-headline-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const index = parseInt($(this).data('index'));
            enterEditMode(index);
        });
        
        $('.save-headline-edit-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const index = parseInt($(this).data('index'));
            saveHeadlineEdit(index);
        });
        
        $('.cancel-headline-edit-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const index = parseInt($(this).data('index'));
            cancelEditMode(index);
        });
        
        // Character count for edit inputs
        $('.edit-headline-input').off('input').on('input', function() {
            const $input = $(this);
            const $container = $input.closest('.headline-item');
            const $charCount = $container.find('.edit-char-count');
            $charCount.text($input.val().length);
        });
        
        // Enter key to save, Escape to cancel
        $('.edit-headline-input').off('keydown').on('keydown', function(e) {
            const index = parseInt($(this).closest('.headline-item').data('index'));
            if (e.key === 'Enter') {
                e.preventDefault();
                saveHeadlineEdit(index);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEditMode(index);
            }
        });
    }
    
    function updateHeadlinesHiddenField() {
        $('#edit-usp-example-headlines').val(uspHeadlines.join(', '));
    }
    
    function enterEditMode(index) {
        const $item = $(`.headline-item[data-index="${index}"]`);
        $item.find('.headline-display').addClass('hidden');
        $item.find('.headline-edit').removeClass('hidden');
        
        // Focus on the input field
        const $input = $item.find('.edit-headline-input');
        $input.focus();
        
        // Select all text for easy editing
        setTimeout(() => {
            $input.select();
        }, 10);
    }
    
    function cancelEditMode(index) {
        const $item = $(`.headline-item[data-index="${index}"]`);
        $item.find('.headline-edit').addClass('hidden');
        $item.find('.headline-display').removeClass('hidden');
        
        // Reset input value to original
        const originalValue = uspHeadlines[index];
        $item.find('.edit-headline-input').val(originalValue);
        $item.find('.edit-char-count').text(originalValue.length);
    }
    
    function saveHeadlineEdit(index) {
        const $item = $(`.headline-item[data-index="${index}"]`);
        const $input = $item.find('.edit-headline-input');
        const newText = $input.val().trim();
        
        if (newText && newText.length <= 30) {
            // Check for duplicates (excluding current item)
            const otherHeadlines = uspHeadlines.filter((h, i) => i !== index);
            if (otherHeadlines.includes(newText)) {
                alert('Denne headline eksisterer allerede');
                return;
            }
            
            // Update the headline
            uspHeadlines[index] = newText;
            renderHeadlines();
            updateHeadlinesHiddenField();
        } else {
            alert('Headline skal v√¶re mellem 1 og 30 karakterer (Google Ads krav)');
        }
    }
    
    // Initialize headline system when slide panel opens
    $(document).on('slideInOpened', function() {
        setTimeout(() => {
            if ($('#headlines-container').length) {
                setupHeadlineManagement();
            }
        }, 150);
    });
    
    console.log('üìã USP Manager initialized');
});
</script>
{% endblock %}